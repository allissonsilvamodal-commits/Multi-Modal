<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Portal do Motorista</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #0f172a 0%, #1e293b 45%, #0b1120 100%);
      --card-gradient: linear-gradient(160deg, rgba(148, 163, 184, 0.12), rgba(148, 163, 184, 0.04));
      --glass: rgba(15, 23, 42, 0.6);
      --glass-border: rgba(148, 163, 184, 0.25);
      --primary: #60a5fa;
      --primary-dark: #1d4ed8;
      --secondary: #38bdf8;
      --success: #22c55e;
      --warning: #facc15;
      --danger: #ef4444;
      --text-primary: #f8fafc;
      --text-secondary: rgba(226, 232, 240, 0.8);
      --muted: rgba(148, 163, 184, 0.7);
      --radius-large: 26px;
      --radius-medium: 18px;
      --transition: all 0.25s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-gradient);
      color: var(--text-primary);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      padding: 24px;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 15% 20%, rgba(96, 165, 250, 0.18), transparent 55%),
                  radial-gradient(circle at 85% 15%, rgba(56, 189, 248, 0.16), transparent 50%),
                  radial-gradient(circle at 35% 80%, rgba(16, 185, 129, 0.12), transparent 50%);
      z-index: -2;
    }

    body::after {
      content: "";
      position: fixed;
      inset: 0;
      background: url('https://www.transparenttextures.com/patterns/black-twill.png');
      opacity: 0.12;
      z-index: -1;
    }

    .portal-wrapper {
      max-width: 1280px;
      margin: 0 auto;
      width: 100%;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    .portal-header {
      display: flex;
      flex-wrap: wrap;
      gap: 24px;
      align-items: stretch;
    }

    .hero-card {
      flex: 1 1 380px;
      background: var(--card-gradient);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-large);
      padding: 28px;
      display: flex;
      gap: 24px;
      align-items: center;
      backdrop-filter: blur(24px);
      position: relative;
      overflow: hidden;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.45);
    }

    .hero-card::before {
      content: "";
      position: absolute;
      inset: -60% 65% 35% -30%;
      background: radial-gradient(circle, rgba(96, 165, 250, 0.25) 0%, transparent 70%);
      transform: rotate(15deg);
      pointer-events: none;
    }

    .driver-avatar {
      width: 96px;
      height: 96px;
      border-radius: 28px;
      background: linear-gradient(145deg, rgba(96, 165, 250, 0.8), rgba(14, 116, 144, 0.65));
      display: grid;
      place-items: center;
      font-size: 2.4rem;
      font-weight: 600;
      color: var(--text-primary);
      border: 2px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 18px 48px rgba(96, 165, 250, 0.35);
      flex-shrink: 0;
    }

    .hero-content {
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 1;
    }

    .hero-content h1 {
      font-size: 1.8rem;
      font-weight: 600;
      color: var(--text-primary);
      text-shadow: 0 12px 32px rgba(14, 116, 144, 0.4);
    }

    .hero-content p {
      color: var(--text-secondary);
      font-size: 0.95rem;
    }

    .badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 8px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.55);
      border: 1px solid rgba(148, 163, 184, 0.35);
      font-size: 0.8rem;
      font-weight: 500;
      color: var(--text-secondary);
      letter-spacing: 0.02em;
    }

    .status-badge.success {
      border-color: rgba(34, 197, 94, 0.45);
      background: rgba(34, 197, 94, 0.18);
      color: #bbf7d0;
    }

    .status-badge.warning {
      border-color: rgba(250, 204, 21, 0.45);
      background: rgba(250, 204, 21, 0.14);
      color: #fef9c3;
    }

    .header-actions {
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex: 0 0 260px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      border-radius: var(--radius-medium);
      font-weight: 500;
      padding: 14px 18px;
      font-size: 0.95rem;
      cursor: pointer;
      border: 1px solid transparent;
      transition: var(--transition);
      color: var(--text-primary);
      background: rgba(15, 23, 42, 0.55);
      backdrop-filter: blur(18px);
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 16px 32px rgba(15, 23, 42, 0.35);
    }

    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #38bdf8);
      box-shadow: 0 20px 40px rgba(37, 99, 235, 0.35);
    }

    .btn-outline {
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.35);
      color: var(--text-secondary);
    }

    .btn-outline:hover {
      color: var(--text-primary);
      border-color: rgba(148, 163, 184, 0.55);
    }

    .btn-warning {
      background: linear-gradient(135deg, #f97316, #facc15);
      color: #1f2937;
      font-weight: 600;
      box-shadow: 0 18px 36px rgba(249, 115, 22, 0.35);
    }

    .btn-disabled {
      opacity: 0.55;
      cursor: not-allowed;
      pointer-events: none;
    }

    .portal-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
    }

    @media (min-width: 1024px) {
      .portal-grid {
        grid-template-columns: 1.1fr 0.9fr;
      }
    }

    .card {
      background: var(--card-gradient);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-large);
      padding: 24px 26px;
      backdrop-filter: blur(22px);
      box-shadow: 0 18px 48px rgba(15, 23, 42, 0.42);
      position: relative;
      overflow: hidden;
    }

    .card h2 {
      font-size: 1.3rem;
      margin-bottom: 18px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text-primary);
    }

    .card h2 .icon {
      width: 38px;
      height: 38px;
      border-radius: 12px;
      background: rgba(96, 165, 250, 0.18);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: var(--primary);
      font-size: 1.1rem;
    }

    .inline-actions {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .chip {
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 0.78rem;
      letter-spacing: 0.04em;
      background: rgba(15, 23, 42, 0.55);
      border: 1px solid rgba(148, 163, 184, 0.35);
      color: var(--muted);
      text-transform: uppercase;
    }

    .chip.success { color: #bbf7d0; border-color: rgba(34, 197, 94, 0.4); background: rgba(34, 197, 94, 0.12); }
    .chip.warning { color: #fde68a; border-color: rgba(250, 204, 21, 0.4); background: rgba(250, 204, 21, 0.12); }
    .chip.danger { color: #fecaca; border-color: rgba(239, 68, 68, 0.4); background: rgba(239, 68, 68, 0.12); }

    .opportunities-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 16px;
    }

    @media (min-width: 1400px) {
      .opportunities-grid {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 14px;
      }
    }

    @media (max-width: 768px) {
      .opportunities-grid {
        grid-template-columns: 1fr;
        gap: 14px;
      }
    }

    .opportunity-card {
      border-radius: 20px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      background: linear-gradient(160deg, rgba(15, 23, 42, 0.75), rgba(15, 23, 42, 0.55));
      padding: 16px 18px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      transition: var(--transition);
      position: relative;
      overflow: hidden;
      backdrop-filter: blur(12px);
      cursor: pointer;
      user-select: none;
    }

    .opportunity-card [data-action="assumir"] {
      cursor: pointer;
    }

    .opportunity-card.expanded {
      padding: 20px 22px;
      gap: 16px;
    }

    .opportunity-card::before {
      content: "";
      position: absolute;
      inset: -50% 50% 30% -30%;
      background: radial-gradient(circle, rgba(96, 165, 250, 0.15), transparent 70%);
      opacity: 0;
      transition: var(--transition);
    }

    .opportunity-card::after {
      content: "";
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, transparent, rgba(96, 165, 250, 0.3), transparent);
      opacity: 0;
      transition: var(--transition);
    }

    .opportunity-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 32px 64px rgba(15, 23, 42, 0.6), 0 0 0 1px rgba(96, 165, 250, 0.2);
      border-color: rgba(96, 165, 250, 0.4);
    }

    .opportunity-card:hover::before {
      opacity: 1;
    }

    .opportunity-card:hover::after {
      opacity: 1;
    }

    .opportunity-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 12px;
      position: relative;
      z-index: 1;
    }

    .opportunity-header-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .opportunity-header h3 {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
      line-height: 1.3;
      letter-spacing: -0.02em;
    }

    .opportunity-card.expanded .opportunity-header h3 {
      font-size: 1.2rem;
    }

    .opportunity-card-compact {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
      width: 100%;
    }

    .opportunity-card-compact-left {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
      min-width: 0;
    }

    .opportunity-card-compact-right {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      gap: 8px;
      flex-shrink: 0;
      text-align: right;
    }

    .opportunity-route-compact {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: var(--text-secondary);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .opportunity-route-compact span {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      max-width: 45%;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .opportunity-route-compact .route-arrow {
      color: var(--muted);
      font-size: 0.7rem;
      flex-shrink: 0;
    }

    .opportunity-value-compact {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--primary);
      line-height: 1;
    }

    .opportunity-badges-compact {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      margin-top: 4px;
    }

    .badge-mini {
      display: inline-block;
      padding: 0.2rem 0.5rem;
      border-radius: 8px;
      font-size: 0.7rem;
      font-weight: 500;
      line-height: 1.2;
    }

    .badge-mini.veiculo {
      background: rgba(96, 165, 250, 0.15);
      color: var(--primary);
      border: 1px solid rgba(96, 165, 250, 0.25);
    }

    .badge-mini.carroceria {
      background: rgba(139, 92, 246, 0.15);
      color: #a855f7;
      border: 1px solid rgba(139, 92, 246, 0.25);
    }

    .opportunity-expand-btn {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 4px 8px;
      border-radius: 8px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 0.75rem;
      margin-left: auto;
    }

    .opportunity-expand-btn:hover {
      background: rgba(96, 165, 250, 0.1);
      color: var(--primary);
    }

    .opportunity-card-details {
      display: none;
      animation: slideDown 0.3s ease;
    }

    .opportunity-card.expanded .opportunity-card-details {
      display: block;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* ========== FILTROS ========== */
    .filtros-painel {
      margin-top: 20px;
      background: var(--card-gradient);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-medium);
      padding: 0;
      backdrop-filter: blur(22px);
      box-shadow: 0 12px 32px rgba(15, 23, 42, 0.3);
      overflow: hidden;
      animation: slideDown 0.3s ease;
    }

    .filtros-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px 24px;
      border-bottom: 1px solid var(--glass-border);
      background: rgba(96, 165, 250, 0.08);
    }

    .filtros-header h3 {
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .filtros-header h3 i {
      color: var(--primary);
    }

    .btn-icon {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      padding: 8px;
      border-radius: 8px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .btn-icon:hover {
      background: rgba(239, 68, 68, 0.15);
      color: var(--danger);
    }

    .filtros-content {
      padding: 24px;
    }

    .filtros-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .filtro-item {
      display: flex;
      flex-direction: column;
    }

    .filtro-item.filtro-full {
      grid-column: 1 / -1;
    }

    .filtro-item label {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      color: var(--text-secondary);
    }

    .filtro-item label i {
      color: var(--primary);
      margin-right: 6px;
    }

    .filtro-item input,
    .filtro-item select {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid var(--glass-border);
      border-radius: 10px;
      padding: 12px 16px;
      color: var(--text-primary);
      font-size: 0.95rem;
      transition: var(--transition);
      font-family: inherit;
    }

    .filtro-item input:focus,
    .filtro-item select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.15);
    }

    .filtro-item input::placeholder {
      color: var(--muted);
    }

    .filtro-checkboxes {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 8px;
      padding: 12px;
      background: rgba(15, 23, 42, 0.4);
      border: 1px solid var(--glass-border);
      border-radius: 10px;
      max-height: 200px;
      overflow-y: auto;
    }

    .filtro-checkbox-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      font-size: 0.85rem;
    }

    .filtro-checkbox-item:hover {
      background: rgba(96, 165, 250, 0.15);
      border-color: var(--primary);
    }

    .filtro-checkbox-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      accent-color: var(--primary);
    }

    .filtro-checkbox-item input[type="checkbox"]:checked + span {
      color: var(--primary);
      font-weight: 500;
    }

    .filtros-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      padding-top: 20px;
      border-top: 1px solid var(--glass-border);
    }

    .filtros-actions .btn {
      padding: 12px 24px;
      font-size: 0.95rem;
      font-weight: 500;
      border-radius: 10px;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .filtros-actions .btn-outline {
      background: transparent;
      border: 1px solid var(--glass-border);
      color: var(--text-secondary);
    }

    .filtros-actions .btn-outline:hover {
      background: rgba(148, 163, 184, 0.1);
      border-color: var(--primary);
      color: var(--primary);
    }

    @media (max-width: 768px) {
      .filtros-grid {
        grid-template-columns: 1fr;
      }

      .filtros-actions {
        flex-direction: column;
      }

      .filtros-actions .btn {
        width: 100%;
        justify-content: center;
      }
    }

    .opportunity-header .cliente-subtitle {
      font-size: 0.88rem;
      color: var(--text-secondary);
      font-weight: 400;
      margin-top: 2px;
    }

    .opportunity-route {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px 16px;
      background: rgba(15, 23, 42, 0.65);
      border-radius: 16px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      position: relative;
      z-index: 1;
    }

    .opportunity-route span {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      font-weight: 500;
      font-size: 0.9rem;
      color: var(--text-primary);
      flex: 1;
    }

    .opportunity-route span i {
      color: var(--primary);
      font-size: 1rem;
    }

    .opportunity-route .route-arrow {
      color: var(--muted);
      font-size: 0.9rem;
      flex-shrink: 0;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 14px;
      position: relative;
      z-index: 1;
    }

    .info-item {
      display: flex;
      flex-direction: column;
      gap: 6px;
      padding: 12px;
      background: rgba(15, 23, 42, 0.5);
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.15);
      transition: var(--transition);
    }

    .info-item:hover {
      background: rgba(15, 23, 42, 0.7);
      border-color: rgba(96, 165, 250, 0.3);
    }

    .info-item.highlight {
      background: linear-gradient(135deg, rgba(96, 165, 250, 0.15), rgba(56, 189, 248, 0.1));
      border-color: rgba(96, 165, 250, 0.3);
    }

    .info-item-label {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.75rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      font-weight: 600;
    }

    .info-item-label i {
      font-size: 0.7rem;
      color: var(--primary);
    }

    .info-item-value {
      font-size: 1.05rem;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.2;
    }

    .info-item-value.highlight-value {
      color: var(--primary);
      font-size: 1.15rem;
    }

    .opportunity-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .small-btn {
      padding: 10px 14px;
      border-radius: 12px;
      font-size: 0.82rem;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.55);
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
    }

    .small-btn:hover {
      color: var(--text-primary);
      border-color: rgba(96, 165, 250, 0.45);
      box-shadow: 0 12px 24px rgba(15, 23, 42, 0.38);
    }

    .small-btn.primary {
      border: none;
      background: linear-gradient(135deg, #2563eb, #38bdf8);
      color: #f8fafc;
      font-weight: 600;
      box-shadow: 0 16px 32px rgba(37, 99, 235, 0.35);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s ease;
    }

    .small-btn.primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 20px 40px rgba(37, 99, 235, 0.45);
      background: linear-gradient(135deg, #1d4ed8, #0ea5e9);
    }

    .small-btn.primary:active {
      transform: translateY(0);
    }

    .empty-state {
      border-radius: 20px;
      border: 1px dashed rgba(148, 163, 184, 0.35);
      padding: 40px 24px;
      text-align: center;
      color: var(--muted);
      display: flex;
      flex-direction: column;
      gap: 12px;
      align-items: center;
      justify-content: center;
    }

    .empty-state i {
      font-size: 2.2rem;
      color: rgba(148, 163, 184, 0.45);
    }

    .toast-container {
      position: fixed;
      top: 24px;
      right: 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 1200;
    }

    .toast {
      min-width: 260px;
      border-radius: 14px;
      padding: 14px 18px;
      background: rgba(15, 23, 42, 0.82);
      border: 1px solid rgba(148, 163, 184, 0.3);
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 12px;
      box-shadow: 0 18px 36px rgba(15, 23, 42, 0.4);
      animation: toast-in 0.35s ease;
    }

    .toast.success { border-color: rgba(34, 197, 94, 0.45); color: #bbf7d0; }
    .toast.error { border-color: rgba(239, 68, 68, 0.45); color: #fecaca; }

    @keyframes toast-in {
      from { transform: translateX(40px); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    .loader {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      color: var(--muted);
      font-size: 0.86rem;
    }

    .loader::before {
      content: "";
      width: 14px;
      height: 14px;
      border-radius: 50%;
      border: 2px solid rgba(96, 165, 250, 0.35);
      border-top-color: rgba(96, 165, 250, 0.9);
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(8, 15, 30, 0.82);
      backdrop-filter: blur(12px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 24px;
      z-index: 1100;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-card {
      width: min(640px, 100%);
      max-height: 90vh;
      background: rgba(15, 23, 42, 0.88);
      border-radius: var(--radius-large);
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: 0 32px 88px rgba(15, 23, 42, 0.55);
      padding: 30px;
      position: relative;
      display: flex;
      flex-direction: column;
      gap: 18px;
      overflow: hidden;
    }

    .modal-card h3,
    .modal-card > p {
      flex-shrink: 0;
    }

    .modal-card form {
      overflow-y: auto;
      flex: 1;
      min-height: 0;
      padding-right: 8px;
      margin-right: -8px;
    }

    .modal-card form::-webkit-scrollbar {
      width: 6px;
    }

    .modal-card form::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.3);
      border-radius: 10px;
    }

    .modal-card form::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.4);
      border-radius: 10px;
    }

    .modal-card form::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.6);
    }

    .modal-card > .modal-footer {
      flex-shrink: 0;
      margin-top: 0;
      padding-top: 16px;
      border-top: 1px solid rgba(148, 163, 184, 0.15);
    }

    .modal-card.docs-modal {
      width: min(720px, 95%);
      max-height: 90vh;
      padding: 28px;
      gap: 16px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .modal-card.docs-modal .docs-modal-header {
      flex-shrink: 0;
      margin-bottom: 4px;
    }
    
    .modal-card.docs-modal form {
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;
      flex: 1;
      min-height: 0;
      padding-right: 8px;
      margin-right: -8px;
    }
    
    .modal-card.docs-modal form::-webkit-scrollbar {
      width: 6px;
    }
    
    .modal-card.docs-modal form::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.3);
      border-radius: 10px;
    }
    
    .modal-card.docs-modal form::-webkit-scrollbar-thumb {
      background: rgba(148, 163, 184, 0.4);
      border-radius: 10px;
    }
    
    .modal-card.docs-modal form::-webkit-scrollbar-thumb:hover {
      background: rgba(148, 163, 184, 0.6);
    }
    
    .modal-card.docs-modal > .modal-footer {
      margin-top: 0;
      padding-top: 16px;
      border-top: 1px solid rgba(148, 163, 184, 0.15);
      flex-shrink: 0;
    }

    .modal-card h3 {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 8px;
      flex-shrink: 0;
    }

    .modal-card p {
      font-size: 0.92rem;
      color: var(--text-secondary);
    }

    .docs-instructions {
      font-size: 0.88rem;
      color: var(--text-secondary);
      line-height: 1.5;
      margin-bottom: 4px;
    }

    .docs-summary {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(148, 163, 184, 0.25);
      border-radius: 14px;
      padding: 14px 16px;
      font-size: 0.87rem;
      color: var(--muted);
      line-height: 1.5;
      flex-shrink: 0;
      max-height: 120px;
      overflow-y: auto;
    }

    .docs-section {
      border: 1px solid rgba(148, 163, 184, 0.22);
      border-radius: 16px;
      background: rgba(15, 23, 42, 0.55);
      padding: 16px 18px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex-shrink: 0;
    }

    .docs-section h4 {
      font-size: 1.05rem;
      font-weight: 600;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .docs-section p {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin: 0;
    }

    .docs-section small {
      font-size: 0.8rem;
      color: var(--muted);
    }

    .file-input-modern {
      width: 100%;
      padding: 14px;
      border-radius: 14px;
      border: 1px dashed rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.4);
      color: var(--text-secondary);
      cursor: pointer;
      transition: var(--transition);
    }

    .file-input-modern:hover {
      border-color: rgba(96, 165, 250, 0.45);
      background: rgba(96, 165, 250, 0.12);
      color: var(--text-primary);
    }

    .refs-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
    }

    .refs-grid input {
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.3);
      background: rgba(15, 23, 42, 0.45);
      color: var(--text-primary);
      padding: 12px 14px;
      font-size: 0.95rem;
      transition: var(--transition);
    }

    .refs-grid input:focus {
      outline: none;
      border-color: rgba(96, 165, 250, 0.65);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.22);
    }

    .docs-note {
      background: rgba(250, 204, 21, 0.1);
      border: 1px solid rgba(250, 204, 21, 0.35);
      border-radius: 14px;
      padding: 14px 16px;
      color: #fef9c3;
      font-size: 0.85rem;
      line-height: 1.4;
    }

    .modal-close {
      position: absolute;
      top: 18px;
      right: 18px;
      border: none;
      background: rgba(15, 23, 42, 0.6);
      border-radius: 12px;
      color: var(--text-secondary);
      width: 40px;
      height: 40px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .modal-close:hover {
      background: rgba(96, 165, 250, 0.22);
      color: var(--text-primary);
    }

    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px 20px;
    }

    .form-grid label {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 0.82rem;
      color: var(--text-secondary);
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    .form-grid input,
    .form-grid select {
      background: rgba(15, 23, 42, 0.55);
      border-radius: 14px;
      border: 1px solid rgba(148, 163, 184, 0.28);
      color: var(--text-primary);
      padding: 12px 14px;
      font-size: 0.95rem;
      transition: var(--transition);
    }

    .form-grid input:focus,
    .form-grid select:focus {
      outline: none;
      border-color: rgba(96, 165, 250, 0.6);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
    }

    .form-grid label.full-width {
      grid-column: 1 / -1;
    }

    .vehicle-classes-portal {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 8px;
    }

    .vehicle-class-portal {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 14px;
      background: rgba(15, 23, 42, 0.55);
      border: 2px solid rgba(148, 163, 184, 0.28);
      border-radius: 14px;
      cursor: pointer;
      transition: var(--transition);
    }

    .vehicle-class-portal:hover {
      border-color: rgba(96, 165, 250, 0.5);
      background: rgba(15, 23, 42, 0.7);
      transform: translateY(-2px);
    }

    .vehicle-class-portal.active {
      border-color: rgba(96, 165, 250, 0.8);
      background: rgba(96, 165, 250, 0.15);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.2);
    }

    .vehicle-class-portal i {
      font-size: 1.5rem;
      color: var(--primary);
      flex-shrink: 0;
    }

    .vehicle-class-portal.active i {
      color: var(--secondary);
    }

    .vehicle-class-portal strong {
      display: block;
      font-size: 0.9rem;
      color: var(--text-primary);
      margin-bottom: 2px;
    }

    .vehicle-class-portal small {
      display: block;
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    @media (max-width: 640px) {
      .vehicle-classes-portal {
        grid-template-columns: 1fr;
      }
    }

    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .helper-text {
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: -6px;
    }

    .danger-alert {
      border-radius: 18px;
      border: 1px solid rgba(239, 68, 68, 0.45);
      background: rgba(239, 68, 68, 0.15);
      padding: 14px 16px;
      color: #fee2e2;
      font-size: 0.85rem;
      display: none;
    }

    .danger-alert.active {
      display: block;
    }

    .table-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .notifications-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
      margin-top: 20px;
    }

    .notification-item {
      display: flex;
      gap: 16px;
      padding: 20px;
      background: rgba(251, 191, 36, 0.1);
      border: 1px solid rgba(251, 191, 36, 0.3);
      border-radius: var(--radius-medium);
      align-items: flex-start;
      transition: var(--transition);
    }

    .notification-item:hover {
      background: rgba(251, 191, 36, 0.15);
      border-color: rgba(251, 191, 36, 0.5);
    }

    .notification-icon {
      flex-shrink: 0;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: rgba(251, 191, 36, 0.2);
      border-radius: 50%;
      color: var(--warning);
    }

    .notification-content {
      flex: 1;
    }

    .notification-content h4 {
      margin: 0 0 8px 0;
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .notification-motive {
      margin: 0 0 8px 0;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .notification-coleta {
      margin: 8px 0;
      padding: 8px 12px;
      background: rgba(96, 165, 250, 0.1);
      border-radius: 8px;
      font-size: 14px;
      color: var(--primary);
    }

    .notification-meta {
      margin: 8px 0 0 0;
      font-size: 12px;
      color: var(--muted);
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .notification-actions {
      flex-shrink: 0;
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 14px;
    }

    .trip-card {
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 18px 20px;
      background: rgba(15, 23, 42, 0.55);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .trip-card h3 {
      font-size: 1rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
    }

    .trip-card .status-badge {
      font-size: 0.72rem;
      padding: 5px 12px;
    }

    .trip-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 12px 18px;
      font-size: 0.82rem;
      color: var(--muted);
    }

    .trip-meta span {
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .quick-actions {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-top: 12px;
    }

    .quick-card {
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.2);
      padding: 18px;
      background: rgba(15, 23, 42, 0.55);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .quick-card strong {
      font-size: 0.92rem;
    }

    .quick-card p {
      font-size: 0.82rem;
      color: var(--muted);
    }

    .refresh-btn {
      border: none;
      background: rgba(15, 23, 42, 0.6);
      color: var(--text-secondary);
      border-radius: 50%;
      width: 42px;
      height: 42px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: var(--transition);
    }

    .refresh-btn:hover {
      background: rgba(96, 165, 250, 0.2);
      color: var(--text-primary);
    }

    .inline-actions .spacer {
      flex: 1 1 auto;
    }

    @media (max-width: 768px) {
      body { padding: 18px; }
      .hero-card { padding: 22px; flex-direction: column; align-items: flex-start; }
      .driver-avatar { width: 80px; height: 80px; }
      .portal-grid { grid-template-columns: 1fr; }
      .header-actions { flex: 1 1 100%; flex-direction: row; flex-wrap: wrap; }
      .header-actions .btn { flex: 1 1 calc(50% - 8px); }
      .modal-card { 
        padding: 22px; 
        border-radius: 20px;
        max-height: 95vh;
      }
      .modal-card.docs-modal { 
        padding: 20px; 
        max-height: 95vh;
        width: min(95%, 680px);
      }
      .refs-grid { grid-template-columns: 1fr; }
    }
    /* Chat de Completar Cadastro */
    .chat-cadastro-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.85);
      backdrop-filter: blur(8px);
      z-index: 10000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
      animation: fadeIn 0.3s ease;
    }

    .chat-cadastro-wrapper {
      width: 100%;
      max-width: 540px;
      max-height: 90vh;
      display: flex;
    }

    .chat-cadastro-card {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: 24px;
      box-shadow: 0 24px 45px rgba(2, 6, 23, 0.45);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      backdrop-filter: blur(18px);
      width: 100%;
      max-height: 100%;
    }

    .chat-cadastro-header {
      padding: 1.5rem;
      border-bottom: 1px solid var(--glass-border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(15, 23, 42, 0.8);
    }

    .chat-cadastro-header-content {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .chat-cadastro-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 1.5rem;
    }

    .chat-cadastro-header h5 {
      margin: 0;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--text-primary);
    }

    .chat-cadastro-header small {
      display: block;
      color: var(--text-secondary);
      font-size: 0.85rem;
      margin-top: 0.25rem;
    }

    .chat-cadastro-close {
      background: transparent;
      border: none;
      color: var(--text-secondary);
      font-size: 1.25rem;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 8px;
      transition: var(--transition);
    }

    .chat-cadastro-close:hover {
      background: rgba(148, 163, 184, 0.1);
      color: var(--text-primary);
    }

    .chat-cadastro-body {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      max-height: calc(90vh - 200px);
    }

    .chat-cadastro-body::-webkit-scrollbar {
      width: 6px;
    }

    .chat-cadastro-body::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-cadastro-body::-webkit-scrollbar-thumb {
      background: var(--glass-border);
      border-radius: 3px;
    }

    .chat-cadastro-message {
      display: flex;
      gap: 0.75rem;
      animation: slideIn 0.3s ease;
    }

    .chat-cadastro-message.user {
      flex-direction: row-reverse;
    }

    .chat-cadastro-message .message-icon {
      width: 36px;
      height: 36px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
    }

    .chat-cadastro-message.bot .message-icon {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
    }

    .chat-cadastro-message.user .message-icon {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      color: var(--primary);
    }

    .chat-cadastro-message .message-bubble {
      max-width: 75%;
      padding: 0.875rem 1.125rem;
      border-radius: 16px;
      line-height: 1.5;
      font-size: 0.95rem;
    }

    .chat-cadastro-message.bot .message-bubble {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      color: var(--text-primary);
      border-bottom-left-radius: 4px;
    }

    .chat-cadastro-message.user .message-bubble {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
      border-bottom-right-radius: 4px;
    }

    .chat-cadastro-message.error .message-bubble {
      background: rgba(239, 68, 68, 0.15);
      border-color: var(--danger);
      color: var(--danger);
    }

    .chat-cadastro-options {
      padding: 0 1.5rem 1rem;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }

    .chat-cadastro-option-btn {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      color: var(--text-primary);
      padding: 0.625rem 1.125rem;
      border-radius: 12px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: var(--transition);
      font-family: inherit;
    }

    .chat-cadastro-option-btn:hover {
      background: rgba(96, 165, 250, 0.15);
      border-color: var(--primary);
      transform: translateY(-2px);
    }

    .chat-cadastro-input {
      padding: 1.5rem;
      border-top: 1px solid var(--glass-border);
      display: flex;
      gap: 0.75rem;
      background: rgba(15, 23, 42, 0.8);
    }

    .chat-cadastro-input input {
      flex: 1;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: 12px;
      padding: 0.875rem 1.125rem;
      color: var(--text-primary);
      font-size: 0.95rem;
      font-family: inherit;
      transition: var(--transition);
    }

    .chat-cadastro-input input:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1);
    }

    .chat-cadastro-input input::placeholder {
      color: var(--muted);
    }

    .chat-cadastro-input button {
      background: linear-gradient(135deg, var(--primary), var(--secondary));
      border: none;
      color: white;
      padding: 0.875rem 1.5rem;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 500;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .chat-cadastro-input button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(96, 165, 250, 0.3);
    }

    .chat-cadastro-input button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .chat-cadastro-file-upload {
      padding: 1rem 1.5rem;
      border-top: 1px solid var(--glass-border);
      background: rgba(15, 23, 42, 0.6);
    }

    .chat-cadastro-file-label {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
      border: 2px dashed var(--glass-border);
      border-radius: 12px;
      cursor: pointer;
      transition: var(--transition);
      background: var(--glass);
      color: var(--text-secondary);
      gap: 0.5rem;
    }

    .chat-cadastro-file-label:hover {
      border-color: var(--primary);
      background: rgba(96, 165, 250, 0.1);
      color: var(--text-primary);
    }

    .chat-cadastro-file-label i {
      font-size: 2rem;
    }

    .chat-cadastro-file-list {
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .chat-cadastro-file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0.75rem;
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: 8px;
      font-size: 0.85rem;
    }

    .chat-cadastro-file-item-name {
      flex: 1;
      color: var(--text-primary);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .chat-cadastro-file-item-remove {
      background: transparent;
      border: none;
      color: var(--danger);
      cursor: pointer;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      transition: var(--transition);
    }

    .chat-cadastro-file-item-remove:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    .chat-cadastro-input button#chatCadastroFileBtn {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      color: var(--text-primary);
      padding: 0.875rem 1rem;
      border-radius: 12px;
      cursor: pointer;
      transition: var(--transition);
    }

    .chat-cadastro-input button#chatCadastroFileBtn:hover {
      background: rgba(96, 165, 250, 0.15);
      border-color: var(--primary);
    }

    @media (max-width: 640px) {
      .chat-cadastro-wrapper {
        max-width: 100%;
        max-height: 100vh;
      }

      .chat-cadastro-card {
        border-radius: 0;
        max-height: 100vh;
      }

      .chat-cadastro-body {
        max-height: calc(100vh - 180px);
      }
    }
  </style>
</head>
<body>
  <div class="portal-wrapper">
    <header class="portal-header">
      <section class="hero-card">
        <div class="driver-avatar" id="driverAvatar">MM</div>
        <div class="hero-content">
          <h1>Bem-vindo, <span id="driverName">Motorista</span></h1>
          <p id="driverMessage">Carregando seus dados...</p>
          <div class="badge-row">
            <span class="status-badge" id="badgeCadastro">Cadastro em validação</span>
            <span class="status-badge" id="badgeEmail"><i class="fas fa-at"></i><span id="badgeEmailText">—</span></span>
          </div>
        </div>
      </section>
      <div class="header-actions">
        <button class="btn btn-primary" id="btnIrOportunidades"><i class="fas fa-route"></i> Ver oportunidades</button>
        <a class="btn btn-warning" id="btnEmergencia" href="portal-emergencia.html">
          <i class="fas fa-triangle-exclamation"></i> Emergência
        </a>
        <button class="btn btn-outline" id="btnInstalarApp" style="display:none;" title="Instalar aplicativo no celular">
          <i class="fas fa-mobile-alt"></i> Instalar App
        </button>
        <button class="btn btn-outline" id="btnCompletarCadastro"><i class="fas fa-id-card"></i> Completar cadastro</button>
        <button class="btn" id="btnSairPortal"><i class="fas fa-sign-out-alt"></i> Sair</button>
      </div>
    </header>

    <main class="portal-grid">
      <section class="card" id="notificacoesCard" style="display:none;">
        <div class="inline-actions">
          <h2><span class="icon"><i class="fas fa-bell"></i></span> Notificações</h2>
          <span class="chip warning" id="contadorNotificacoes">0</span>
          <span class="spacer"></span>
          <button class="refresh-btn" id="btnAtualizarNotificacoes" title="Atualizar notificações"><i class="fas fa-rotate"></i></button>
        </div>
        <div id="notificacoesLista" class="notifications-list"></div>
        <div id="notificacoesEmpty" class="empty-state" style="display:none;">
          <i class="fas fa-check-circle"></i>
          <strong>Nenhuma notificação</strong>
          <p>Tudo em dia! Você não tem notificações pendentes.</p>
        </div>
      </section>

      <section class="card" id="minhasViagensCard">
        <div class="inline-actions">
          <h2><span class="icon"><i class="fas fa-truck"></i></span> Minhas viagens</h2>
          <span class="chip" id="viagensResumo">Carregando...</span>
          <span class="spacer"></span>
          <button class="refresh-btn" id="btnAtualizarViagens" title="Atualizar minhas viagens"><i class="fas fa-rotate"></i></button>
        </div>
        <div id="minhasViagensLista" class="table-list"></div>
        <div id="minhasViagensEmpty" class="empty-state" style="display:none;">
          <i class="fas fa-clipboard-list"></i>
          <strong>Nenhuma viagem vinculada ainda</strong>
          <p>Quando você assumir uma oportunidade, ela aparecerá aqui para acompanhamento.</p>
        </div>
      </section>

      <section class="card" id="painelResumo">
        <div class="inline-actions">
          <h2><span class="icon"><i class="fas fa-gauge-high"></i></span> Seu painel</h2>
          <span class="chip success" id="chipStatusMotorista" style="display:none;"><i class="fas fa-check-circle"></i> Cadastro aprovado</span>
          <span class="chip warning" id="chipCadastroPendente" style="display:none;"><i class="fas fa-hourglass-half"></i> Cadastro pendente</span>
        </div>
        <div class="quick-actions">
          <div class="quick-card">
            <strong><i class="fas fa-phone me-2"></i> Telefone principal</strong>
            <p id="infoTelefone">—</p>
          </div>
          <div class="quick-card">
            <strong><i class="fas fa-truck-moving me-2"></i> Veículo</strong>
            <p id="infoVeiculo">Atualize seu cadastro para informar veículo e placas.</p>
          </div>
          <div class="quick-card">
            <strong><i class="fas fa-circle-info me-2"></i> Situação</strong>
            <p id="infoSituacao">Estamos validando seus dados.</p>
          </div>
        </div>
        <div class="danger-alert" id="alertCadastro">
          <strong><i class="fas fa-exclamation-triangle me-2"></i> Cadastro necessário</strong>
          <p>Para assumir viagens e ter acesso completo ao portal, conclua seu cadastro. Clique em "Completar cadastro" ou selecione uma oportunidade.</p>
        </div>
      </section>
    </main>

    <section class="card" id="oportunidadesCard">
      <div class="inline-actions">
        <h2><span class="icon"><i class="fas fa-compass"></i></span> Oportunidades de viagem</h2>
        <span class="chip" id="contadorOportunidades">0 oportunidades</span>
        <span class="spacer"></span>
        <button class="btn btn-outline" id="btnToggleFiltros" title="Mostrar/ocultar filtros">
          <i class="fas fa-filter"></i> Filtros
        </button>
        <button class="refresh-btn" id="btnAtualizarOportunidades" title="Atualizar oportunidades"><i class="fas fa-arrows-rotate"></i></button>
      </div>
      
      <!-- Painel de Filtros -->
      <div id="painelFiltros" class="filtros-painel" style="display:none;">
        <div class="filtros-header">
          <h3><i class="fas fa-filter"></i> Filtros de busca</h3>
          <button class="btn-icon" id="btnFecharFiltros" title="Fechar filtros">
            <i class="fas fa-times"></i>
          </button>
        </div>
        <div class="filtros-content">
          <div class="filtros-grid">
            <!-- Busca por texto -->
            <div class="filtro-item filtro-full">
              <label>
                <i class="fas fa-search"></i> Buscar
                <input type="text" id="filtroBusca" placeholder="Cliente, origem, destino, filial, nº da coleta..." />
              </label>
            </div>

            <!-- Filial -->
            <div class="filtro-item">
              <label>
                <i class="fas fa-building"></i> Filial
                <select id="filtroFilial">
                  <option value="">Todas as filiais</option>
                  <option value="JBO">JBO</option>
                  <option value="CABO">CABO</option>
                  <option value="SP">SP</option>
                  <option value="BA">BA</option>
                  <option value="SE">SE</option>
                  <option value="AL">AL</option>
                  <option value="PE">PE</option>
                  <option value="PB">PB</option>
                  <option value="CE">CE</option>
                </select>
              </label>
            </div>

            <!-- Prioridade -->
            <div class="filtro-item">
              <label>
                <i class="fas fa-star"></i> Prioridade
                <select id="filtroPrioridade">
                  <option value="">Todas</option>
                  <option value="alta">Alta</option>
                  <option value="normal">Normal</option>
                  <option value="baixa">Baixa</option>
                </select>
              </label>
            </div>

            <!-- Valor mínimo -->
            <div class="filtro-item">
              <label>
                <i class="fas fa-dollar-sign"></i> Valor mínimo (R$)
                <input type="number" id="filtroValorMin" placeholder="0.00" min="0" step="0.01" />
              </label>
            </div>

            <!-- Valor máximo -->
            <div class="filtro-item">
              <label>
                <i class="fas fa-dollar-sign"></i> Valor máximo (R$)
                <input type="number" id="filtroValorMax" placeholder="999999.99" min="0" step="0.01" />
              </label>
            </div>

            <!-- KM mínimo -->
            <div class="filtro-item">
              <label>
                <i class="fas fa-route"></i> Distância mínima (km)
                <input type="number" id="filtroKmMin" placeholder="0" min="0" step="1" />
              </label>
            </div>

            <!-- KM máximo -->
            <div class="filtro-item">
              <label>
                <i class="fas fa-route"></i> Distância máxima (km)
                <input type="number" id="filtroKmMax" placeholder="99999" min="0" step="1" />
              </label>
            </div>

            <!-- Tipo de Veículo -->
            <div class="filtro-item filtro-full">
              <label>
                <i class="fas fa-truck"></i> Tipo de Veículo
                <div class="filtro-checkboxes" id="filtroTiposVeiculo">
                  <!-- Será preenchido dinamicamente -->
                </div>
              </label>
            </div>

            <!-- Tipo de Carroceria -->
            <div class="filtro-item filtro-full">
              <label>
                <i class="fas fa-box"></i> Tipo de Carroceria
                <div class="filtro-checkboxes" id="filtroTiposCarroceria">
                  <!-- Será preenchido dinamicamente -->
                </div>
              </label>
            </div>
          </div>
          <div class="filtros-actions">
            <button class="btn btn-outline" id="btnLimparFiltros">
              <i class="fas fa-eraser"></i> Limpar filtros
            </button>
            <button class="btn" id="btnAplicarFiltros">
              <i class="fas fa-check"></i> Aplicar filtros
            </button>
          </div>
        </div>
      </div>

      <div id="oportunidadesLoader" class="loader" style="display:none;">Buscando oportunidades disponíveis...</div>
      <div id="oportunidadesLista" class="opportunities-grid"></div>
      <div id="oportunidadesEmpty" class="empty-state" style="display:none;">
        <i class="fas fa-handshake-angle"></i>
        <strong>Sem oportunidades disponíveis</strong>
        <p>Assim que novas coletas forem lançadas sem motorista vinculado, elas aparecerão aqui automaticamente.</p>
      </div>
    </section>
  </div>

  <!-- Chat de Completar Cadastro -->
  <div class="chat-cadastro-overlay" id="chatCadastroOverlay" style="display: none;">
    <div class="chat-cadastro-wrapper">
      <div class="chat-cadastro-card">
        <div class="chat-cadastro-header">
          <div class="chat-cadastro-header-content">
            <div class="chat-cadastro-icon">
              <i class="fas fa-robot"></i>
            </div>
            <div>
              <h5>Assistente de Cadastro</h5>
              <small>Vamos completar seu cadastro para você assumir viagens</small>
            </div>
          </div>
          <button class="chat-cadastro-close" id="btnFecharChatCadastro" aria-label="Fechar">
            <i class="fas fa-xmark"></i>
          </button>
        </div>
        <main class="chat-cadastro-body" id="chatCadastroMessages"></main>
        <div class="chat-cadastro-options" id="chatCadastroOptions"></div>
        <div class="chat-cadastro-file-upload" id="chatCadastroFileUpload" style="display: none;">
          <label class="chat-cadastro-file-label">
            <i class="fas fa-cloud-upload-alt"></i>
            <span>Clique para selecionar arquivos ou arraste aqui</span>
            <input type="file" id="chatCadastroFileInput" multiple accept=".pdf,image/*" style="display: none;" />
          </label>
          <div class="chat-cadastro-file-list" id="chatCadastroFileList"></div>
        </div>
        <form class="chat-cadastro-input" id="chatCadastroForm" autocomplete="off">
          <input type="text" id="chatCadastroInput" placeholder="Digite sua resposta..." maxlength="200" autocomplete="off" />
          <button type="button" id="chatCadastroFileBtn" style="display: none;" title="Anexar arquivo">
            <i class="fas fa-paperclip"></i>
          </button>
          <button type="submit" id="chatCadastroSendBtn">
            <i class="fas fa-paper-plane"></i>
            Enviar
          </button>
        </form>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="cadastroModal">
    <div class="modal-card">
      <button class="modal-close" id="btnFecharModal" aria-label="Fechar"><i class="fas fa-xmark"></i></button>
      <h3><i class="fas fa-id-card-clip me-2"></i> Completar cadastro</h3>
      <p>Informe seus dados para que possamos validar seu perfil e liberar o aceite de viagens.</p>

      <form id="formCadastroMotorista" autocomplete="off">
        <div class="form-grid">
          <label>Nome completo *
            <input type="text" id="campoNome" placeholder="Ex: João da Silva" required>
          </label>
          <label>CNH
            <input type="text" id="campoCnh" placeholder="Número da CNH">
          </label>
          <label>Categoria CNH
            <select id="campoCategoriaCnh">
              <option value="">Selecione</option>
              <option value="A">A - Motos</option>
              <option value="B">B - Carros</option>
              <option value="C">C - Caminhões</option>
              <option value="D">D - Ônibus</option>
              <option value="E">E - Carreta</option>
            </select>
          </label>
          <label>Telefone principal *
            <input type="text" id="campoTelefone1" placeholder="(00) 00000-0000" required>
          </label>
          <label>Telefone secundário
            <input type="text" id="campoTelefone2" placeholder="(00) 00000-0000">
          </label>
          <label>Estado (DDD) *
            <select id="campoEstado" required>
              <option value="">Selecione o estado</option>
              <option value="SP">São Paulo</option>
              <option value="RJ">Rio de Janeiro</option>
              <option value="MG">Minas Gerais</option>
              <option value="ES">Espírito Santo</option>
              <option value="PR">Paraná</option>
              <option value="SC">Santa Catarina</option>
              <option value="RS">Rio Grande do Sul</option>
              <option value="MS">Mato Grosso do Sul</option>
              <option value="MT">Mato Grosso</option>
              <option value="GO">Goiás</option>
              <option value="DF">Distrito Federal</option>
              <option value="BA">Bahia</option>
              <option value="SE">Sergipe</option>
              <option value="AL">Alagoas</option>
              <option value="PE">Pernambuco</option>
              <option value="PB">Paraíba</option>
              <option value="RN">Rio Grande do Norte</option>
              <option value="CE">Ceará</option>
              <option value="PI">Piauí</option>
              <option value="MA">Maranhão</option>
              <option value="PA">Pará</option>
              <option value="AP">Amapá</option>
              <option value="AM">Amazonas</option>
              <option value="RR">Roraima</option>
              <option value="AC">Acre</option>
              <option value="RO">Rondônia</option>
              <option value="TO">Tocantins</option>
            </select>
          </label>
          <label class="full-width">Classe do veículo *
            <div class="vehicle-classes-portal" id="vehicleClassesPortal">
              <div class="vehicle-class-portal" data-class="leve">
                <i class="fas fa-truck-pickup"></i>
                <div>
                  <strong>Leves</strong>
                  <small>Fiorino, 3/4, Toco, VLC</small>
                </div>
              </div>
              <div class="vehicle-class-portal" data-class="medio">
                <i class="fas fa-truck"></i>
                <div>
                  <strong>Médios</strong>
                  <small>Bitruck, Truck</small>
                </div>
              </div>
              <div class="vehicle-class-portal" data-class="pesado">
                <i class="fas fa-truck-moving"></i>
                <div>
                  <strong>Pesados</strong>
                  <small>Bitrem, Carreta, Rodotrem</small>
                </div>
              </div>
            </div>
          </label>
          <label>Tipo de veículo *
            <select id="campoTipoVeiculo" required disabled>
              <option value="">Selecione a classe do veículo primeiro</option>
            </select>
          </label>
          <label>Tipo de carroceria *
            <select id="campoTipoCarroceria" required disabled>
              <option value="">Selecione a classe do veículo primeiro</option>
            </select>
          </label>
          <label>Placa cavalo
            <input type="text" id="campoPlacaCavalo" placeholder="AAA0A00">
          </label>
          <label>Placa carreta 1
            <input type="text" id="campoPlacaCarreta1" placeholder="AAA0A00">
          </label>
          <label>Placa carreta 2
            <input type="text" id="campoPlacaCarreta2" placeholder="AAA0A00">
          </label>
          <label>Placa carreta 3
            <input type="text" id="campoPlacaCarreta3" placeholder="AAA0A00">
          </label>
        </div>

        <p class="helper-text"><i class="fas fa-lock me-2"></i> Seus dados são utilizados apenas para operações logísticas e contato rápido.</p>
      </form>

      <div class="modal-footer">
        <button type="button" class="btn btn-outline" id="btnCancelarCadastro">Cancelar</button>
        <button type="submit" form="formCadastroMotorista" class="btn btn-primary" id="btnSalvarCadastro"><span class="btn-text"><i class="fas fa-save me-2"></i>Salvar cadastro</span></button>
      </div>
    </div>
  </div>

  <!-- Modal de Termo de Rastreamento -->
  <div class="modal-overlay" id="rastreamentoTermoModal">
    <div class="modal-card">
      <button class="modal-close" id="btnFecharRastreamentoTermo" aria-label="Fechar"><i class="fas fa-xmark"></i></button>
      <h3><i class="fas fa-map-location-dot me-2"></i> Termo de Rastreamento e Monitoramento</h3>
      <div class="termo-content" style="max-height: 60vh; overflow-y: auto; padding: 1rem 0; margin: 1rem 0; border-top: 1px solid var(--glass-border); border-bottom: 1px solid var(--glass-border);">
        <p style="margin-bottom: 1rem; color: var(--text-secondary); line-height: 1.6;">
          <strong style="color: var(--text-primary);">Ao assumir esta viagem, você concorda com o rastreamento e monitoramento em tempo real da sua localização durante toda a execução da coleta.</strong>
        </p>
        <div style="background: rgba(96, 165, 250, 0.1); border-left: 3px solid var(--primary); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
          <h4 style="color: var(--primary); margin-bottom: 0.5rem; font-size: 1rem;"><i class="fas fa-info-circle me-2"></i>O que será monitorado:</h4>
          <ul style="list-style: none; padding: 0; margin: 0; color: var(--text-secondary); line-height: 1.8;">
            <li><i class="fas fa-check-circle me-2" style="color: var(--success);"></i>Localização GPS em tempo real</li>
            <li><i class="fas fa-check-circle me-2" style="color: var(--success);"></i>Velocidade e direção do veículo</li>
            <li><i class="fas fa-check-circle me-2" style="color: var(--success);"></i>Status da viagem (em movimento, parado, etc.)</li>
            <li><i class="fas fa-check-circle me-2" style="color: var(--success);"></i>Alertas automáticos em caso de desvios ou paradas prolongadas</li>
          </ul>
        </div>
        <div style="background: rgba(34, 197, 94, 0.1); border-left: 3px solid var(--success); padding: 1rem; border-radius: 8px; margin: 1rem 0;">
          <h4 style="color: var(--success); margin-bottom: 0.5rem; font-size: 1rem;"><i class="fas fa-shield-alt me-2"></i>Seus direitos:</h4>
          <ul style="list-style: none; padding: 0; margin: 0; color: var(--text-secondary); line-height: 1.8;">
            <li><i class="fas fa-lock me-2" style="color: var(--success);"></i>Dados protegidos e utilizados apenas para fins operacionais</li>
            <li><i class="fas fa-clock me-2" style="color: var(--success);"></i>Rastreamento ativo apenas durante a execução da coleta</li>
            <li><i class="fas fa-user-shield me-2" style="color: var(--success);"></i>Privacidade garantida conforme LGPD</li>
          </ul>
        </div>
        <p style="margin-top: 1rem; font-size: 0.85rem; color: var(--muted); text-align: center;">
          Versão do termo: 1.0 | Última atualização: <span id="termoDataAtualizacao"></span>
        </p>
      </div>
      <div class="modal-footer">
        <label style="display: flex; align-items: center; gap: 0.75rem; cursor: pointer; padding: 0.75rem; background: rgba(96, 165, 250, 0.05); border-radius: 8px; margin-bottom: 1rem;">
          <input type="checkbox" id="aceitarTermoRastreamento" required style="width: 18px; height: 18px; cursor: pointer;">
          <span style="color: var(--text-primary); font-size: 0.9rem;">
            <strong>Li e aceito o termo de rastreamento e monitoramento</strong>
          </span>
        </label>
        <button type="button" class="btn btn-secondary" id="btnRecusarTermo">Recusar</button>
        <button type="button" class="btn btn-primary" id="btnAceitarTermo">Aceitar e Continuar</button>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="documentosModal">
    <div class="modal-card docs-modal">
      <button class="modal-close" id="btnFecharDocumentos" aria-label="Fechar"><i class="fas fa-xmark"></i></button>
      <div class="docs-modal-header">
        <h3><i class="fas fa-file-upload me-2"></i> Envio de documentos</h3>
        <p class="docs-instructions">Antes de avançarmos com a viagem, precisamos validar toda a documentação. Envie arquivos em PDF ou foto nítida. Todos os campos são obrigatórios.</p>
        <div class="docs-summary" id="docsResumo">Selecione uma oportunidade para visualizar o resumo aqui.</div>
      </div>
      <form id="formDocumentos" autocomplete="off">
        <div class="docs-section">
          <h4><i class="fas fa-user-shield"></i> 1. Dados do Proprietário</h4>
          <p>Envie CNH (ou RG + CPF), comprovante de residência, telefone e dados bancários (banco, agência, conta, chave PIX) e ANTT.</p>
          <small>Formatos aceitos: PDF ou imagem (máx. 10 MB por arquivo).</small>
          <input type="file" id="docsProprietario" class="file-input-modern" accept=".pdf,image/*" multiple required>
        </div>

        <div class="docs-section">
          <h4><i class="fas fa-truck-front"></i> 2. Documentos do Veículo</h4>
          <p>Envie os CRLVs atualizados (2024 ou 2025) do cavalo e de todas as carretas/implementos.</p>
          <input type="file" id="docsVeiculo" class="file-input-modern" accept=".pdf,image/*" multiple required>
        </div>

        <div class="docs-section">
          <h4><i class="fas fa-id-card"></i> 3. Dados do Motorista</h4>
          <p>CNH atualizada, comprovante de residência e telefone para contato.</p>
          <input type="file" id="docsMotorista" class="file-input-modern" accept=".pdf,image/*" multiple required>
        </div>

        <div class="docs-section">
          <h4><i class="fas fa-address-book"></i> 4. Referências</h4>
          <p>Informe no mínimo duas referências pessoais e duas referências comerciais.</p>
          <div class="refs-grid">
            <input type="text" id="refPessoal1" placeholder="Referência pessoal 1" required>
            <input type="text" id="refPessoal2" placeholder="Referência pessoal 2" required>
            <input type="text" id="refComercial1" placeholder="Referência comercial 1" required>
            <input type="text" id="refComercial2" placeholder="Referência comercial 2" required>
          </div>
          <div class="docs-note">
            <strong>Atenção:</strong> descreva cada referência com nome completo e telefone/contato. Sem essas informações a liberação pode ser rejeitada.
          </div>
        </div>
      </form>
      
      <div class="modal-footer">
        <button type="button" class="btn btn-outline" id="btnCancelarDocumentos">Cancelar</button>
        <button type="submit" form="formDocumentos" class="btn btn-primary" id="btnEnviarDocumentos"><span class="btn-text"><i class="fas fa-paper-plane me-2"></i>Enviar e assumir viagem</span></button>
      </div>
    </div>
  </div>

  <div class="toast-container" id="toastContainer"></div>

  <link rel="manifest" href="/manifest.json">
  <meta name="theme-color" content="#60a5fa">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Portal Motorista">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const DOCUMENT_CATEGORY_LABELS = {
      proprietario: 'Documentos - Proprietário',
      veiculo: 'Documentos - Veículo',
      motorista: 'Documentos - Motorista',
      outro: 'Documentos'
    };
    const REQUIRED_DOC_CATEGORIES = ['proprietario', 'veiculo', 'motorista'];

    const state = {
      supabase: null,
      session: null,
      user: null,
      motorista: null,
      oportunidades: [],
      oportunidadesOriginal: [], // Backup para filtros
      viagens: [],
      carregandoOportunidades: false,
      carregandoViagens: false,
      documentosStatus: null,
      selectedOpportunity: null,
      solicitacaoIdParaAtender: null
    };

    const elements = {
      driverAvatar: document.getElementById('driverAvatar'),
      driverName: document.getElementById('driverName'),
      driverMessage: document.getElementById('driverMessage'),
      badgeCadastro: document.getElementById('badgeCadastro'),
      badgeEmail: document.getElementById('badgeEmail'),
      badgeEmailText: document.getElementById('badgeEmailText'),
      chipStatusMotorista: document.getElementById('chipStatusMotorista'),
      chipCadastroPendente: document.getElementById('chipCadastroPendente'),
      infoTelefone: document.getElementById('infoTelefone'),
      infoVeiculo: document.getElementById('infoVeiculo'),
      infoSituacao: document.getElementById('infoSituacao'),
      alertCadastro: document.getElementById('alertCadastro'),
      viagensResumo: document.getElementById('viagensResumo'),
      minhasViagensLista: document.getElementById('minhasViagensLista'),
      minhasViagensEmpty: document.getElementById('minhasViagensEmpty'),
      oportunidadesLista: document.getElementById('oportunidadesLista'),
      oportunidadesEmpty: document.getElementById('oportunidadesEmpty'),
      oportunidadesLoader: document.getElementById('oportunidadesLoader'),
      contadorOportunidades: document.getElementById('contadorOportunidades'),
      btnToggleFiltros: document.getElementById('btnToggleFiltros'),
      btnFecharFiltros: document.getElementById('btnFecharFiltros'),
      painelFiltros: document.getElementById('painelFiltros'),
      filtroBusca: document.getElementById('filtroBusca'),
      filtroFilial: document.getElementById('filtroFilial'),
      filtroPrioridade: document.getElementById('filtroPrioridade'),
      filtroValorMin: document.getElementById('filtroValorMin'),
      filtroValorMax: document.getElementById('filtroValorMax'),
      filtroKmMin: document.getElementById('filtroKmMin'),
      filtroKmMax: document.getElementById('filtroKmMax'),
      filtroTiposVeiculo: document.getElementById('filtroTiposVeiculo'),
      filtroTiposCarroceria: document.getElementById('filtroTiposCarroceria'),
      btnLimparFiltros: document.getElementById('btnLimparFiltros'),
      btnAplicarFiltros: document.getElementById('btnAplicarFiltros'),
      contadorOportunidades: document.getElementById('contadorOportunidades'),
      btnInstalarApp: document.getElementById('btnInstalarApp'),
      btnIrOportunidades: document.getElementById('btnIrOportunidades'),
      btnSairPortal: document.getElementById('btnSairPortal'),
      btnCompletarCadastro: document.getElementById('btnCompletarCadastro'),
      btnAtualizarOportunidades: document.getElementById('btnAtualizarOportunidades'),
      btnAtualizarViagens: document.getElementById('btnAtualizarViagens'),
      btnAtualizarNotificacoes: document.getElementById('btnAtualizarNotificacoes'),
      notificacoesCard: document.getElementById('notificacoesCard'),
      notificacoesLista: document.getElementById('notificacoesLista'),
      notificacoesEmpty: document.getElementById('notificacoesEmpty'),
      contadorNotificacoes: document.getElementById('contadorNotificacoes'),
      modal: document.getElementById('cadastroModal'),
      btnFecharModal: document.getElementById('btnFecharModal'),
      btnCancelarCadastro: document.getElementById('btnCancelarCadastro'),
      formCadastro: document.getElementById('formCadastroMotorista'),
      campoNome: document.getElementById('campoNome'),
      campoCnh: document.getElementById('campoCnh'),
      campoCategoriaCnh: document.getElementById('campoCategoriaCnh'),
      campoTelefone1: document.getElementById('campoTelefone1'),
      campoTelefone2: document.getElementById('campoTelefone2'),
      campoEstado: document.getElementById('campoEstado'),
      campoTipoVeiculo: document.getElementById('campoTipoVeiculo'),
      campoTipoCarroceria: document.getElementById('campoTipoCarroceria'),
      campoPlacaCavalo: document.getElementById('campoPlacaCavalo'),
      campoPlacaCarreta1: document.getElementById('campoPlacaCarreta1'),
      campoPlacaCarreta2: document.getElementById('campoPlacaCarreta2'),
      campoPlacaCarreta3: document.getElementById('campoPlacaCarreta3'),
      btnSalvarCadastro: document.getElementById('btnSalvarCadastro'),
      documentosModal: document.getElementById('documentosModal'),
      formDocumentos: document.getElementById('formDocumentos'),
      btnFecharDocumentos: document.getElementById('btnFecharDocumentos'),
      btnCancelarDocumentos: document.getElementById('btnCancelarDocumentos'),
      rastreamentoTermoModal: document.getElementById('rastreamentoTermoModal'),
      btnFecharRastreamentoTermo: document.getElementById('btnFecharRastreamentoTermo'),
      btnAceitarTermo: document.getElementById('btnAceitarTermo'),
      btnRecusarTermo: document.getElementById('btnRecusarTermo'),
      aceitarTermoRastreamento: document.getElementById('aceitarTermoRastreamento'),
      btnEnviarDocumentos: document.getElementById('btnEnviarDocumentos'),
      docsResumo: document.getElementById('docsResumo'),
      docsProprietario: document.getElementById('docsProprietario'),
      docsVeiculo: document.getElementById('docsVeiculo'),
      docsMotorista: document.getElementById('docsMotorista'),
      refPessoal1: document.getElementById('refPessoal1'),
      refPessoal2: document.getElementById('refPessoal2'),
      refComercial1: document.getElementById('refComercial1'),
      refComercial2: document.getElementById('refComercial2'),
      toastContainer: document.getElementById('toastContainer')
    };

    const referenciaInputsPessoais = [elements.refPessoal1, elements.refPessoal2].filter(Boolean);
    const referenciaInputsComerciais = [elements.refComercial1, elements.refComercial2].filter(Boolean);

    // Função para obter nome amigável da carroceria
    // tiposCarroceriaMap é declarado mais abaixo no código
    function getCarroceriaDisplayName(key) {
      if (!key) return '';
      const keyLower = key.toLowerCase().trim();
      // Verificar se tiposCarroceriaMap existe (será declarado mais abaixo)
      if (typeof tiposCarroceriaMap !== 'undefined' && tiposCarroceriaMap) {
        return tiposCarroceriaMap[keyLower] || tiposCarroceriaMap[key] || key;
      }
      return key;
    }

    // Função para formatar tipos de veículo (normalizar para exibição)
    function formatTipoVeiculo(tipo) {
      if (!tipo) return '';
      // Mapeamento de tipos de veículo comuns
      const tiposMap = {
        '3/4': '3/4',
        'fiorino': 'Fiorino',
        'toco': 'Toco',
        'vlc': 'VLC',
        'bitruck': 'Bitruck',
        'truck': 'Truck',
        'bitrem': 'Bitrem',
        'carreta': 'Carreta',
        'carreta_ls': 'Carreta LS',
        'carreta ls': 'Carreta LS',
        'rodotrem': 'Rodotrem',
        'vanderleia': 'Vanderleia'
      };
      
      const tipoLower = tipo.toLowerCase().trim();
      // Verificar se existe no mapeamento
      if (tiposMap[tipoLower]) {
        return tiposMap[tipoLower];
      }
      
      // Se não encontrar, normalizar: converter snake_case para título
      return tipo
        .split('_')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
    }

    function formatCurrency(value) {
      if (value === null || value === undefined || value === '') return '—';
      const number = Number(value);
      if (Number.isNaN(number)) return '—';
      return number.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
    }

    function formatDistance(km) {
      if (km === null || km === undefined || km === '') return '—';
      const number = Number(km);
      if (Number.isNaN(number)) return '—';
      return number.toLocaleString('pt-BR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' km';
    }

    function formatDate(value) {
      if (!value) return '—';
      const date = new Date(value);
      if (Number.isNaN(date.getTime())) return '—';
      return date.toLocaleDateString('pt-BR', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function escapeHtml(value) {
      if (value === null || value === undefined) return '';
      return value.toString()
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function normalizePhone(value) {
      if (!value) return '';
      const digits = value.toString().replace(/\D/g, '');
      if (digits.length > 11) {
        return digits.slice(-11);
      }
      if (digits.startsWith('55') && digits.length > 11) {
        return digits.slice(-11);
      }
      return digits;
    }

    function formatPhone(value) {
      const digits = normalizePhone(value).slice(0, 11);
      if (!digits) return '—';
      if (digits.length <= 10) {
        return digits.replace(/(\d{0,2})(\d{0,4})(\d{0,4})/, (match, ddd, parte1, parte2) => {
          const p1 = parte1 ? ` ${parte1}` : '';
          const p2 = parte2 ? `-${parte2}` : '';
          return ddd ? `(${ddd})${p1}${p2}` : parte1 + parte2;
        }).trim();
      }
      return digits.replace(/(\d{0,2})(\d{0,5})(\d{0,4})/, (match, ddd, parte1, parte2) => {
        const p1 = parte1 ? ` ${parte1}` : '';
        const p2 = parte2 ? `-${parte2}` : '';
        return ddd ? `(${ddd})${p1}${p2}` : parte1 + parte2;
      }).trim();
    }

    function normalizePlate(value) {
      if (!value) return '';
      return value.toString().toUpperCase().replace(/[^A-Z0-9]/g, '').slice(0, 8);
    }

    function setSelectValue(select, value) {
      if (!select) return;
      const normalized = (value || '').toString().trim();
      if (!normalized) {
        select.value = '';
        return;
      }
      const exists = Array.from(select.options).some(option => option.value === normalized);
      if (!exists) {
        const option = document.createElement('option');
        option.value = normalized;
        option.textContent = normalized;
        select.appendChild(option);
      }
      select.value = normalized;
    }

    // Configurações de tipos de veículos e carrocerias (mesmas de cadastro.html)
    const tiposVeiculo = {
      leve: ['3/4', 'Fiorino', 'Toco', 'VLC'],
      medio: ['Bitruck', 'Truck'],
      pesado: ['Bitrem', 'Carreta', 'Carreta LS', 'Rodotrem', 'Vanderleia']
    };

    const bodyworkByClass = {
      leve: ['bau', 'bau_frigorifico', 'bau_refrigerado', 'cacamba', 'prancha'],
      medio: ['bau', 'bau_frigorifico', 'sider', 'graneleiro', 'plataforma', 'basculante'],
      pesado: ['bau', 'sider', 'graneleiro', 'grade_baixa', 'bitrem', 'carreta', 'carreta_ls', 'rodotrem', 'vanderleia', 'apenas_cavalo', 'cegonheiro', 'gaiola', 'tanque', 'porta_container_20', 'porta_container_40', 'basculante']
    };

    const tiposCarroceriaMap = {
      bau: 'Baú',
      bau_frigorifico: 'Baú Frigorífico',
      bau_refrigerado: 'Baú Refrigerado',
      sider: 'Sider',
      cacamba: 'Caçamba',
      caamba: 'Caçamba',
      graneleiro: 'Graneleiro',
      plataforma: 'Plataforma',
      prancha: 'Prancha',
      bitrem: 'Bitrem',
      carreta: 'Carreta',
      carreta_ls: 'Carreta LS',
      rodotrem: 'Rodotrem',
      vanderleia: 'Vanderleia',
      apenas_cavalo: 'Apenas Cavalo',
      cegonheiro: 'Cegonheiro',
      gaiola: 'Gaiola',
      tanque: 'Tanque',
      grade_baixa: 'Grade Baixa',
      basculante: 'Basculante',
      porta_container_20: 'Porta Container 20',
      porta_container_40: 'Porta Container 40'
    };

    let classeVeiculoSelecionada = null;

    function selecionarClasseVeiculoPortal(classe) {
      classeVeiculoSelecionada = classe;
      document.querySelectorAll('.vehicle-class-portal').forEach(el => el.classList.remove('active'));
      document.querySelector(`.vehicle-class-portal[data-class="${classe}"]`)?.classList.add('active');
      
      atualizarTiposVeiculoPortal(classe);
      atualizarTiposCarroceriaPortal(classe);
      
      if (elements.campoTipoVeiculo) elements.campoTipoVeiculo.disabled = false;
      if (elements.campoTipoCarroceria) elements.campoTipoCarroceria.disabled = false;
    }

    function atualizarTiposVeiculoPortal(classe) {
      if (!elements.campoTipoVeiculo) return;
      elements.campoTipoVeiculo.innerHTML = '<option value="">Selecione o tipo</option>';
      
      if (classe && tiposVeiculo[classe]) {
        tiposVeiculo[classe].forEach(tipo => {
          const option = document.createElement('option');
          option.value = tipo.toLowerCase().replace(/ /g, '_');
          option.textContent = tipo;
          elements.campoTipoVeiculo.appendChild(option);
        });
      }
    }

    function atualizarTiposCarroceriaPortal(classe) {
      if (!elements.campoTipoCarroceria) return;
      elements.campoTipoCarroceria.innerHTML = '<option value="">Selecione o tipo</option>';
      
      if (classe && bodyworkByClass[classe]) {
        bodyworkByClass[classe].forEach(tipo => {
          if (tiposCarroceriaMap[tipo]) {
            const option = document.createElement('option');
            option.value = tipo;
            option.textContent = tiposCarroceriaMap[tipo];
            elements.campoTipoCarroceria.appendChild(option);
          }
        });
      }
    }

    function toggleButtonLoading(button, isLoading, loadingLabel) {
      if (!button) return;
      if (isLoading) {
        button.disabled = true;
        button.dataset.originalText = button.dataset.originalText || button.innerHTML;
        button.innerHTML = '<span class="loader"></span> ' + (loadingLabel || 'Processando...');
      } else {
        button.disabled = false;
        if (button.dataset.originalText) {
          button.innerHTML = button.dataset.originalText;
        }
      }
    }

    function showToast(message, type = 'success') {
      if (!elements.toastContainer) return;
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `<i class="fas ${type === 'success' ? 'fa-circle-check' : 'fa-circle-exclamation'}"></i><span>${escapeHtml(message)}</span>`;
      elements.toastContainer.appendChild(toast);
      setTimeout(() => {
        toast.style.opacity = '0';
        toast.style.transform = 'translateX(40px)';
        setTimeout(() => toast.remove(), 220);
      }, 3200);
    }

    function toggleModal(open) {
      if (!elements.modal) return;
      if (open) {
        elements.modal.classList.add('active');
      } else {
        elements.modal.classList.remove('active');
      }
    }

    async function carregarConfigSupabase() {
      const response = await fetch('/api/supabase-config');
      if (!response.ok) {
        throw new Error('Configuração Supabase indisponível');
      }
      const config = await response.json();
      if (!window.supabase) {
        throw new Error('Biblioteca Supabase não carregada');
      }
      state.supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseAnonKey, {
        auth: {
          persistSession: true,
          detectSessionInUrl: true
        }
      });
    }

    async function carregarSessao() {
      const { data } = await state.supabase.auth.getSession();
      if (!data?.session) {
        window.location.href = 'login-motorista.html';
        return false;
      }
      state.session = data.session;
      return true;
    }

    function atualizarCabecalho() {
      const motorista = state.motorista;
      const user = state.user;

      const nome = motorista?.nome || user?.nome || user?.email || 'Motorista';
      elements.driverName.textContent = nome;
      elements.driverMessage.textContent = motorista
        ? 'Você está pronto para acompanhar suas viagens e assumir novas oportunidades.'
        : 'Complete seu cadastro para poder assumir viagens. Você ainda pode visualizar oportunidades.';

      const email = user?.email || '—';
      elements.badgeEmailText.textContent = email;
      elements.driverAvatar.textContent = nome.split(' ').slice(0, 2).map(part => part[0] || '').join('').toUpperCase() || 'MM';

      if (motorista) {
        elements.badgeCadastro.textContent = motorista.status === 'ativo' ? 'Cadastro aprovado' : `Status: ${motorista.status}`;
        elements.badgeCadastro.classList.remove('warning');
        elements.badgeCadastro.classList.add('success');
        elements.badgeCadastro.innerHTML = `<i class="fas fa-shield-check"></i> ${escapeHtml(elements.badgeCadastro.textContent)}`;
        elements.chipStatusMotorista.style.display = 'inline-flex';
        elements.chipCadastroPendente.style.display = 'none';
        elements.alertCadastro.classList.remove('active');
      } else {
        elements.badgeCadastro.textContent = 'Cadastro pendente';
        elements.badgeCadastro.classList.remove('success');
        elements.badgeCadastro.classList.add('warning');
        elements.badgeCadastro.innerHTML = '<i class="fas fa-hourglass-half"></i> Cadastro pendente';
        elements.chipStatusMotorista.style.display = 'none';
        elements.chipCadastroPendente.style.display = 'inline-flex';
        elements.alertCadastro.classList.add('active');
      }

      elements.infoTelefone.textContent = motorista?.telefone1 ? formatPhone(motorista.telefone1) : 'Informe seu telefone principal para contato rápido.';
      const placas = motorista?.placas || {};
      const placaList = [placas.cavalo, placas.carreta1, placas.carreta2, placas.carreta3].filter(Boolean);
      if (placaList.length || motorista?.classeVeiculo || motorista?.tipoVeiculo) {
        const placaTexto = placaList.length ? placaList.join(' • ') : 'Atualize suas placas para agilizar o despacho.';
        elements.infoVeiculo.innerHTML = `${motorista?.classeVeiculo ? escapeHtml(motorista.classeVeiculo) + ' · ' : ''}${motorista?.tipoVeiculo ? escapeHtml(motorista.tipoVeiculo) + ' · ' : ''}${escapeHtml(placaTexto)}`;
      } else {
        elements.infoVeiculo.textContent = 'Informe classe, tipo e placas do veículo para facilitar o matching com cargas.';
      }

      elements.infoSituacao.textContent = motorista
        ? 'Cadastro validado. Você pode assumir novas viagens.'
        : 'Complete o cadastro para liberar o aceite de viagens.';

      elements.btnCompletarCadastro.style.display = motorista ? 'none' : 'inline-flex';

      if (motorista) {
        atualizarStatusDocumentosUI();
      }
    }

    async function carregarPerfil() {
      const response = await fetch('/api/motoristas/auth/me', {
        headers: {
          Authorization: `Bearer ${state.session.access_token}`
        }
      });

      if (response.status === 401) {
        await state.supabase.auth.signOut();
        window.location.href = 'login-motorista.html';
        return;
      }

      const result = await response.json();
      if (!response.ok) {
        throw new Error(result.error || 'Falha ao carregar perfil');
      }

      state.user = result.user;
      state.motorista = result.motorista;
      atualizarCabecalho();
    await carregarStatusDocumentos(true);
    }

    async function carregarOportunidades() {
      state.carregandoOportunidades = true;
      elements.oportunidadesLoader.style.display = 'inline-flex';
      elements.oportunidadesEmpty.style.display = 'none';
      elements.oportunidadesLista.innerHTML = '';

      try {
        const response = await fetch('/api/motoristas/oportunidades', {
          headers: {
            Authorization: `Bearer ${state.session.access_token}`
          }
        });

        if (response.status === 401) {
          await state.supabase.auth.signOut();
          window.location.href = 'login-motorista.html';
          return;
        }

        const result = await response.json();
        if (!response.ok) {
          throw new Error(result.error || 'Não foi possível carregar oportunidades');
        }

        state.oportunidades = result.oportunidades || [];
        state.oportunidadesOriginal = [...state.oportunidades]; // Backup para filtros
        aplicarFiltros();
      } catch (error) {
        console.error('Erro ao carregar oportunidades:', error);
        showToast(error.message || 'Erro ao carregar oportunidades', 'error');
        elements.oportunidadesEmpty.style.display = 'flex';
      } finally {
        state.carregandoOportunidades = false;
        elements.oportunidadesLoader.style.display = 'none';
      }
    }

    function renderOportunidades() {
      const oportunidades = state.oportunidades;
      elements.contadorOportunidades.textContent = `${oportunidades.length} oportunidade${oportunidades.length === 1 ? '' : 's'}`;

      if (!oportunidades.length) {
        elements.oportunidadesLista.innerHTML = '';
        elements.oportunidadesEmpty.style.display = 'flex';
        return;
      }

      elements.oportunidadesEmpty.style.display = 'none';
      const html = oportunidades.map(op => {
        // Criar identificador amigável: Filial #Número ou Cliente
        const identificador = (op.filial && op.numeroColeta) 
          ? `${escapeHtml(op.filial)} #${escapeHtml(op.numeroColeta)}`
          : escapeHtml(op.cliente || 'Cliente confidencial');
        
        // Determinar cor da prioridade
        const prioridadeClass = op.prioridade === 'urgente' ? 'danger' : op.prioridade === 'alta' ? 'warning' : 'success';
        const prioridadeLabel = op.prioridade === 'urgente' ? 'Urgente' : op.prioridade === 'alta' ? 'Alta' : 'Normal';
        
        // Preparar badges de tipos de veículo e carroceria (compactos)
        const badgesVeiculo = (op.tiposVeiculo && op.tiposVeiculo.length > 0) 
          ? op.tiposVeiculo.slice(0, 3).map(tipo => {
              const displayName = formatTipoVeiculo(tipo);
              return `<span class="badge-mini veiculo" title="${escapeHtml(displayName)}">${escapeHtml(displayName.length > 8 ? displayName.substring(0, 8) + '...' : displayName)}</span>`;
            }).join('')
          : '';
        
        const badgesCarroceria = (op.tiposCarroceria && op.tiposCarroceria.length > 0)
          ? op.tiposCarroceria.slice(0, 3).map(carroceria => {
              const displayName = getCarroceriaDisplayName(carroceria);
              return `<span class="badge-mini carroceria" title="${escapeHtml(displayName)}">${escapeHtml(displayName.length > 8 ? displayName.substring(0, 8) + '...' : displayName)}</span>`;
            }).join('')
          : '';
        
        const totalBadges = (op.tiposVeiculo?.length || 0) + (op.tiposCarroceria?.length || 0);
        const maisBadges = totalBadges > 6 ? `<span class="badge-mini" style="background: rgba(148, 163, 184, 0.2); color: var(--text-secondary); border: 1px solid rgba(148, 163, 184, 0.3);">+${totalBadges - 6}</span>` : '';
        
        return `
          <article class="opportunity-card" data-coleta-id="${escapeHtml(op.id)}" data-expanded="false">
            <!-- Versão Compacta (sempre visível) -->
            <div class="opportunity-card-compact">
              <div class="opportunity-card-compact-left">
                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                  <h3 style="font-size: 1rem; font-weight: 700; color: var(--text-primary); margin: 0; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${identificador}</h3>
                  <span class="chip ${prioridadeClass}" style="flex-shrink: 0; font-size: 0.7rem; padding: 0.25rem 0.6rem;">
                    <i class="fas ${op.prioridade === 'urgente' ? 'fa-exclamation-triangle' : op.prioridade === 'alta' ? 'fa-arrow-up' : 'fa-check-circle'}" style="font-size: 0.65rem;"></i>
                    ${escapeHtml(prioridadeLabel)}
                  </span>
            </div>
                <div class="opportunity-route-compact">
                  <span title="${escapeHtml(op.origem || 'Não informada')}">
                    <i class="fas fa-map-marker-alt" style="font-size: 0.7rem; color: var(--primary);"></i>
                    ${escapeHtml((op.origem || 'Não informada').length > 20 ? (op.origem || 'Não informada').substring(0, 20) + '...' : (op.origem || 'Não informada'))}
                  </span>
                  <i class="fas fa-arrow-right route-arrow"></i>
                  <span title="${escapeHtml(op.destino || 'Não informado')}">
                    <i class="fas fa-flag-checkered" style="font-size: 0.7rem; color: var(--primary);"></i>
                    ${escapeHtml((op.destino || 'Não informado').length > 20 ? (op.destino || 'Não informado').substring(0, 20) + '...' : (op.destino || 'Não informado'))}
                  </span>
            </div>
                ${(badgesVeiculo || badgesCarroceria) ? `
                  <div class="opportunity-badges-compact">
                    ${badgesVeiculo}
                    ${badgesCarroceria}
                    ${maisBadges}
              </div>
                ` : ''}
              </div>
              <div class="opportunity-card-compact-right">
                <div class="opportunity-value-compact">${formatCurrency(op.valor)}</div>
                <button class="small-btn primary" data-action="assumir" data-coleta-id="${escapeHtml(op.id)}" type="button" style="padding: 8px 14px; font-size: 0.8rem; white-space: nowrap;">
                  <i class="fas fa-hand-holding"></i>
                  <span>Assumir</span>
                </button>
              </div>
            </div>
            
            <!-- Botão para expandir/colapsar -->
            <button class="opportunity-expand-btn" data-expand-target="${escapeHtml(op.id)}" type="button">
              <i class="fas fa-chevron-down" data-expand-icon="${escapeHtml(op.id)}"></i>
              <span data-expand-text="${escapeHtml(op.id)}">Ver detalhes</span>
            </button>
            
            <!-- Detalhes Expandidos (oculto por padrão) -->
            <div class="opportunity-card-details">
              ${op.cliente && (op.filial && op.numeroColeta) ? `<p class="cliente-subtitle" style="margin-top: 8px; margin-bottom: 0;">${escapeHtml(op.cliente)}</p>` : ''}
              
              <div class="info-grid" style="margin-top: 12px;">
                <div class="info-item">
                  <div class="info-item-label">
                    <i class="fas fa-road"></i>
                    <span>Distância</span>
                  </div>
                  <div class="info-item-value">${formatDistance(op.km)}</div>
                </div>
                <div class="info-item">
                  <div class="info-item-label">
                    <i class="fas fa-calendar-alt"></i>
                    <span>Data</span>
                  </div>
                  <div class="info-item-value">${formatDate(op.dataRecebimento)}</div>
                </div>
                <div class="info-item">
                  <div class="info-item-label">
                    <i class="fas fa-circle"></i>
                    <span>Status</span>
                  </div>
                  <div class="info-item-value">${escapeHtml((op.status || 'pendente').charAt(0).toUpperCase() + (op.status || 'pendente').slice(1))}</div>
                </div>
              </div>
              
              ${(op.tiposVeiculo && op.tiposVeiculo.length > 0) || (op.tiposCarroceria && op.tiposCarroceria.length > 0) ? `
                <div style="padding: 14px 16px; background: rgba(96, 165, 250, 0.1); border: 1px solid rgba(96, 165, 250, 0.25); border-radius: 14px; margin-top: 12px;">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 10px;">
                    <i class="fas fa-truck" style="color: var(--primary); font-size: 0.9rem;"></i>
                    <strong style="font-size: 0.8rem; color: var(--primary); text-transform: uppercase; letter-spacing: 0.05em;">Requisitos de Veículo</strong>
                  </div>
                  ${op.tiposVeiculo && op.tiposVeiculo.length > 0 ? `
                    <div style="margin-bottom: ${op.tiposCarroceria && op.tiposCarroceria.length > 0 ? '10px' : '0'};">
                      <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 6px; font-weight: 600;">Tipos de Veículo:</div>
                      <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                        ${op.tiposVeiculo.map(tipo => {
                          const displayName = formatTipoVeiculo(tipo);
                          return `<span style="display: inline-block; background: linear-gradient(135deg, rgba(96, 165, 250, 0.2), rgba(56, 189, 248, 0.15)); color: var(--primary); padding: 0.35rem 0.7rem; border-radius: 10px; font-size: 0.8rem; font-weight: 500; border: 1px solid rgba(96, 165, 250, 0.3);">${escapeHtml(displayName)}</span>`;
                        }).join('')}
                      </div>
                    </div>
                  ` : ''}
                  ${op.tiposCarroceria && op.tiposCarroceria.length > 0 ? `
              <div>
                      <div style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 6px; font-weight: 600;">Tipos de Carroceria:</div>
                      <div style="display: flex; flex-wrap: wrap; gap: 6px;">
                        ${op.tiposCarroceria.map(carroceria => {
                          const displayName = getCarroceriaDisplayName(carroceria);
                          return `<span style="display: inline-block; background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(168, 85, 247, 0.15)); color: #a855f7; padding: 0.35rem 0.7rem; border-radius: 10px; font-size: 0.8rem; font-weight: 500; border: 1px solid rgba(139, 92, 246, 0.3);">${escapeHtml(displayName)}</span>`;
                        }).join('')}
              </div>
            </div>
                  ` : ''}
                </div>
              ` : op.veiculo ? `
                <div style="padding: 14px 16px; background: rgba(15, 23, 42, 0.5); border: 1px solid rgba(148, 163, 184, 0.15); border-radius: 14px; margin-top: 12px;">
                  <div class="info-item-label" style="margin-bottom: 6px;">
                    <i class="fas fa-truck"></i>
                    <span>Veículo</span>
                  </div>
                  <div class="info-item-value" style="font-size: 0.95rem;">${escapeHtml(op.veiculo)}</div>
                </div>
              ` : ''}
              
              ${op.observacoes ? `
                <div style="padding: 14px 16px; background: rgba(250, 204, 21, 0.1); border: 1px solid rgba(250, 204, 21, 0.25); border-radius: 14px; margin-top: 12px;">
                  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                    <i class="fas fa-info-circle" style="color: var(--warning); font-size: 0.85rem;"></i>
                    <strong style="font-size: 0.8rem; color: var(--warning); text-transform: uppercase; letter-spacing: 0.05em;">Observações</strong>
                  </div>
                  <p style="font-size: 0.88rem; color: var(--text-secondary); margin: 0; line-height: 1.5;">${escapeHtml(op.observacoes)}</p>
                </div>
              ` : ''}
            </div>
          </article>
        `;
      }).join('');
      elements.oportunidadesLista.innerHTML = html;
      
      // Inicializar estado dos cards (todos colapsados por padrão)
      setTimeout(() => {
        document.querySelectorAll('.opportunity-card').forEach(card => {
          card.dataset.expanded = 'false';
        });
      }, 100);
    }

    // ========== SISTEMA DE FILTROS ==========
    function inicializarFiltros() {
      // Preencher checkboxes de tipos de veículo
      if (elements.filtroTiposVeiculo) {
        const todosTipos = [
          ...tiposVeiculo.leve,
          ...tiposVeiculo.medio,
          ...tiposVeiculo.pesado
        ];
        const tiposUnicos = [...new Set(todosTipos)];
        tiposUnicos.forEach(tipo => {
          const checkboxItem = document.createElement('div');
          checkboxItem.className = 'filtro-checkbox-item';
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = `filtro-veiculo-${tipo.toLowerCase().replace(/ /g, '_')}`;
          checkbox.value = tipo.toLowerCase().replace(/ /g, '_');
          const label = document.createElement('span');
          label.textContent = tipo;
          checkboxItem.appendChild(checkbox);
          checkboxItem.appendChild(label);
          elements.filtroTiposVeiculo.appendChild(checkboxItem);
        });
      }

      // Preencher checkboxes de tipos de carroceria
      if (elements.filtroTiposCarroceria) {
        const todasCarrocerias = Object.keys(tiposCarroceriaMap);
        todasCarrocerias.forEach(carroceria => {
          const checkboxItem = document.createElement('div');
          checkboxItem.className = 'filtro-checkbox-item';
          const checkbox = document.createElement('input');
          checkbox.type = 'checkbox';
          checkbox.id = `filtro-carroceria-${carroceria}`;
          checkbox.value = carroceria;
          const label = document.createElement('span');
          label.textContent = tiposCarroceriaMap[carroceria];
          checkboxItem.appendChild(checkbox);
          checkboxItem.appendChild(label);
          elements.filtroTiposCarroceria.appendChild(checkboxItem);
        });
      }

      // Event listeners
      if (elements.btnToggleFiltros) {
        elements.btnToggleFiltros.addEventListener('click', () => {
          const isVisible = elements.painelFiltros.style.display !== 'none';
          elements.painelFiltros.style.display = isVisible ? 'none' : 'block';
        });
      }

      if (elements.btnFecharFiltros) {
        elements.btnFecharFiltros.addEventListener('click', () => {
          elements.painelFiltros.style.display = 'none';
        });
      }

      if (elements.btnAplicarFiltros) {
        elements.btnAplicarFiltros.addEventListener('click', aplicarFiltros);
      }

      if (elements.btnLimparFiltros) {
        elements.btnLimparFiltros.addEventListener('click', limparFiltros);
      }

      // Aplicar filtros ao digitar na busca (debounce)
      if (elements.filtroBusca) {
        let buscaTimeout;
        elements.filtroBusca.addEventListener('input', () => {
          clearTimeout(buscaTimeout);
          buscaTimeout = setTimeout(aplicarFiltros, 300);
        });
      }

      // Aplicar filtros ao mudar outros campos
      const filtrosInputs = [
        elements.filtroFilial,
        elements.filtroPrioridade,
        elements.filtroValorMin,
        elements.filtroValorMax,
        elements.filtroKmMin,
        elements.filtroKmMax
      ];
      filtrosInputs.forEach(input => {
        if (input) {
          input.addEventListener('change', aplicarFiltros);
          input.addEventListener('input', () => {
            clearTimeout(buscaTimeout);
            buscaTimeout = setTimeout(aplicarFiltros, 500);
          });
        }
      });

      // Aplicar filtros ao marcar/desmarcar checkboxes
      if (elements.filtroTiposVeiculo) {
        elements.filtroTiposVeiculo.addEventListener('change', aplicarFiltros);
      }
      if (elements.filtroTiposCarroceria) {
        elements.filtroTiposCarroceria.addEventListener('change', aplicarFiltros);
      }
    }

    function aplicarFiltros() {
      if (!state.oportunidadesOriginal || state.oportunidadesOriginal.length === 0) {
        state.oportunidades = [];
        renderOportunidades();
        return;
      }

      let filtradas = [...state.oportunidadesOriginal];

      // Filtro de busca (texto)
      const busca = (elements.filtroBusca?.value || '').toLowerCase().trim();
      if (busca) {
        filtradas = filtradas.filter(op => {
          const textoBusca = [
            op.cliente || '',
            op.origem || '',
            op.destino || '',
            op.filial || '',
            op.numeroColeta || '',
            op.observacoes || ''
          ].join(' ').toLowerCase();
          return textoBusca.includes(busca);
        });
      }

      // Filtro de filial
      const filial = elements.filtroFilial?.value;
      if (filial) {
        filtradas = filtradas.filter(op => op.filial === filial);
      }

      // Filtro de prioridade
      const prioridade = elements.filtroPrioridade?.value;
      if (prioridade) {
        filtradas = filtradas.filter(op => op.prioridade === prioridade);
      }

      // Filtro de valor
      const valorMin = parseFloat(elements.filtroValorMin?.value || 0);
      const valorMax = parseFloat(elements.filtroValorMax?.value || Infinity);
      if (valorMin > 0 || valorMax < Infinity) {
        filtradas = filtradas.filter(op => {
          const valor = parseFloat(op.valor) || 0;
          return valor >= valorMin && valor <= valorMax;
        });
      }

      // Filtro de KM
      const kmMin = parseFloat(elements.filtroKmMin?.value || 0);
      const kmMax = parseFloat(elements.filtroKmMax?.value || Infinity);
      if (kmMin > 0 || kmMax < Infinity) {
        filtradas = filtradas.filter(op => {
          const km = parseFloat(op.km) || 0;
          return km >= kmMin && km <= kmMax;
        });
      }

      // Filtro de tipos de veículo
      const tiposVeiculoSelecionados = Array.from(
        elements.filtroTiposVeiculo?.querySelectorAll('input[type="checkbox"]:checked') || []
      ).map(cb => cb.value);
      if (tiposVeiculoSelecionados.length > 0) {
        filtradas = filtradas.filter(op => {
          if (!op.tiposVeiculo || op.tiposVeiculo.length === 0) return false;
          return tiposVeiculoSelecionados.some(tipoSelecionado => {
            return op.tiposVeiculo.some(tipoOp => {
              const tipoOpNormalizado = tipoOp.toLowerCase().replace(/ /g, '_');
              return tipoOpNormalizado === tipoSelecionado;
            });
          });
        });
      }

      // Filtro de tipos de carroceria
      const tiposCarroceriaSelecionados = Array.from(
        elements.filtroTiposCarroceria?.querySelectorAll('input[type="checkbox"]:checked') || []
      ).map(cb => cb.value);
      if (tiposCarroceriaSelecionados.length > 0) {
        filtradas = filtradas.filter(op => {
          if (!op.tiposCarroceria || op.tiposCarroceria.length === 0) return false;
          return tiposCarroceriaSelecionados.some(carroceriaSelecionada => {
            return op.tiposCarroceria.some(carroceriaOp => {
              const carroceriaOpNormalizada = carroceriaOp.toLowerCase();
              return carroceriaOpNormalizada === carroceriaSelecionada.toLowerCase();
            });
          });
        });
      }

      state.oportunidades = filtradas;
      renderOportunidades();
    }

    function limparFiltros() {
      if (elements.filtroBusca) elements.filtroBusca.value = '';
      if (elements.filtroFilial) elements.filtroFilial.value = '';
      if (elements.filtroPrioridade) elements.filtroPrioridade.value = '';
      if (elements.filtroValorMin) elements.filtroValorMin.value = '';
      if (elements.filtroValorMax) elements.filtroValorMax.value = '';
      if (elements.filtroKmMin) elements.filtroKmMin.value = '';
      if (elements.filtroKmMax) elements.filtroKmMax.value = '';
      
      // Desmarcar todos os checkboxes
      if (elements.filtroTiposVeiculo) {
        elements.filtroTiposVeiculo.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.checked = false;
        });
      }
      if (elements.filtroTiposCarroceria) {
        elements.filtroTiposCarroceria.querySelectorAll('input[type="checkbox"]').forEach(cb => {
          cb.checked = false;
        });
      }

      aplicarFiltros();
    }

    async function carregarViagens() {
      state.carregandoViagens = true;
      elements.minhasViagensEmpty.style.display = 'none';
      elements.minhasViagensLista.innerHTML = '<div class="loader">Carregando suas viagens...</div>';

      try {
        const response = await fetch('/api/motoristas/viagens', {
          headers: {
            Authorization: `Bearer ${state.session.access_token}`
          }
        });

        if (response.status === 401) {
          await state.supabase.auth.signOut();
          window.location.href = 'login-motorista.html';
          return;
        }

        const result = await response.json();
        if (!response.ok) {
          throw new Error(result.error || 'Não foi possível carregar suas viagens');
        }

        if (result.motorista) {
          state.motorista = result.motorista;
          atualizarCabecalho();
        }

        state.viagens = result.viagens || [];
        renderViagens();
      } catch (error) {
        console.error('Erro ao carregar viagens:', error);
        showToast(error.message || 'Erro ao carregar suas viagens', 'error');
        elements.minhasViagensEmpty.style.display = 'flex';
      } finally {
        state.carregandoViagens = false;
      }
    }

    function renderViagens() {
      const viagens = state.viagens;
      const total = viagens.length;
      if (!total) {
        elements.minhasViagensLista.innerHTML = '';
        elements.minhasViagensEmpty.style.display = 'flex';
        elements.viagensResumo.textContent = 'Nenhuma viagem ainda';
        return;
      }

      elements.minhasViagensEmpty.style.display = 'none';
      elements.viagensResumo.textContent = `${total} viagem${total === 1 ? '' : 's'} em andamento`;

      const html = viagens.map(viagem => {
        // Criar identificador amigável: Filial #Número ou Cliente
        const identificador = (viagem.filial && viagem.numeroColeta) 
          ? `${escapeHtml(viagem.filial)} #${escapeHtml(viagem.numeroColeta)}`
          : escapeHtml(viagem.cliente || 'Cliente confidencial');
        
        return `
          <article class="trip-card">
            <h3>
              <span>${identificador}</span>
              <span class="status-badge success"><i class="fas fa-circle"></i> ${escapeHtml(viagem.status || 'em andamento')}</span>
            </h3>
            ${viagem.cliente && (viagem.filial && viagem.numeroColeta) ? `<p style="font-size:0.85rem;color:var(--text-secondary);margin-top:-8px;margin-bottom:8px;">${escapeHtml(viagem.cliente)}</p>` : ''}
            <div class="trip-meta">
              <span><i class="fas fa-location-dot"></i> ${escapeHtml(viagem.origem || 'Origem não informada')}</span>
              <span><i class="fas fa-flag-checkered"></i> ${escapeHtml(viagem.destino || 'Destino não informado')}</span>
              <span><i class="fas fa-calendar"></i> ${formatDate(viagem.dataRecebimento)}</span>
              <span><i class="fas fa-road"></i> ${formatDistance(viagem.km)}</span>
              <span><i class="fas fa-coins"></i> ${formatCurrency(viagem.valor)}</span>
              <span><i class="fas fa-diagram-project"></i> Etapa: ${escapeHtml((viagem.etapaAtual || '—').toUpperCase())}</span>
            </div>
          </article>
        `;
      }).join('');

      elements.minhasViagensLista.innerHTML = html;
    }

    async function carregarNotificacoes() {
      if (!state.session || !state.session.access_token) {
        return;
      }

      try {
        const response = await fetch('/api/motoristas/notificacoes', {
          headers: {
            Authorization: `Bearer ${state.session.access_token}`
          }
        });

        if (!response.ok) {
          throw new Error('Erro ao carregar notificações');
        }

        const result = await response.json();
        const notificacoes = result.notificacoes || [];

        if (notificacoes.length > 0) {
          elements.notificacoesCard.style.display = 'block';
          elements.notificacoesEmpty.style.display = 'none';
          elements.contadorNotificacoes.textContent = notificacoes.length;

          const html = notificacoes.map(notif => {
            const dataFormatada = notif.solicitadoEm ? new Date(notif.solicitadoEm).toLocaleString('pt-BR') : 'Agora';
            return `
              <div class="notification-item">
                <div class="notification-icon">
                  <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="notification-content">
                  <h4>Atualização solicitada: ${escapeHtml(notif.categoriaLabel)}</h4>
                  <p class="notification-motive">${escapeHtml(notif.motivo)}</p>
                  ${notif.coleta ? `
                    <p class="notification-coleta">
                      <i class="fas fa-truck"></i> 
                      ${escapeHtml(notif.coleta.cliente)}: ${escapeHtml(notif.coleta.origem)} → ${escapeHtml(notif.coleta.destino)}
                    </p>
                  ` : ''}
                  <p class="notification-meta">
                    <i class="fas fa-clock"></i> ${dataFormatada} · 
                    <i class="fas fa-user"></i> ${escapeHtml(notif.solicitadoPor)}
                  </p>
                </div>
                <div class="notification-actions">
                  <button class="btn btn-primary btn-sm" onclick="window.abrirModalAtualizacaoDocumento('${notif.coletaId}', '${notif.categoria}', '${notif.id}')">
                    <i class="fas fa-upload"></i> Atualizar
                  </button>
                </div>
              </div>
            `;
          }).join('');

          elements.notificacoesLista.innerHTML = html;
        } else {
          elements.notificacoesCard.style.display = 'none';
        }
      } catch (error) {
        console.error('Erro ao carregar notificações:', error);
        elements.notificacoesCard.style.display = 'none';
      }
    }

    window.abrirModalAtualizacaoDocumento = async function(coletaId, categoria, solicitacaoId) {
      if (!coletaId || !categoria) return;

      state.selectedOpportunity = { id: coletaId };
      const status = await carregarStatusDocumentos(true);
      
      // Preencher apenas a categoria solicitada
      const categoriaMap = {
        'proprietario': elements.docsProprietario,
        'veiculo': elements.docsVeiculo,
        'motorista': elements.docsMotorista
      };

      const inputCategoria = categoriaMap[categoria.toLowerCase()];
      if (inputCategoria) {
        inputCategoria.required = true;
        // Desmarcar outras categorias
        Object.values(categoriaMap).forEach(input => {
          if (input && input !== inputCategoria) {
            input.required = false;
          }
        });
      }

      // Armazenar ID da solicitação para marcar como atendida depois
      state.solicitacaoIdParaAtender = solicitacaoId;

      toggleDocumentosModal(true);
    }

    function atualizarStatusDocumentosUI() {
      if (!state.motorista) {
        return;
      }

      if (!state.documentosStatus || !state.documentosStatus.categorias) {
        return;
      }

      const pendentes = REQUIRED_DOC_CATEGORIES.filter(cat => !(state.documentosStatus.categorias[cat]?.possui));
      const labels = pendentes.map(cat => DOCUMENT_CATEGORY_LABELS[cat] || 'Documentos');

      if (labels.length) {
        if (elements.infoSituacao) {
          elements.infoSituacao.textContent = `Documentação pendente: ${labels.join(', ')}.`;
        }
        if (elements.alertCadastro) {
          elements.alertCadastro.classList.add('active');
          elements.alertCadastro.innerHTML = `<strong><i class="fas fa-exclamation-triangle me-2"></i>Documentos pendentes</strong><p>Envie: ${labels.join(', ')}.</p>`;
        }
      } else {
        if (elements.infoSituacao) {
          elements.infoSituacao.textContent = 'Documentação enviada. Aguardando validação da central.';
        }
        if (elements.alertCadastro) {
          elements.alertCadastro.classList.remove('active');
        }
      }
    }

    async function carregarStatusDocumentos(force = false) {
      if (!state.session || !state.session.access_token) {
        return null;
      }

      if (!force && state.documentosStatus) {
        return state.documentosStatus;
      }

      try {
        const response = await fetch('/api/motoristas/documentos/status', {
          headers: {
            Authorization: `Bearer ${state.session.access_token}`
          }
        });

        if (response.status === 401) {
          await state.supabase.auth.signOut();
          window.location.href = 'login-motorista.html';
          return null;
        }

        const result = await response.json();
        if (!response.ok) {
          throw new Error(result.error || 'Não foi possível consultar seus documentos.');
        }

        state.documentosStatus = result;
        atualizarStatusDocumentosUI();
        return state.documentosStatus;
      } catch (error) {
        console.error('Erro ao consultar documentos:', error);
        showToast(error.message || 'Erro ao consultar documentos.', 'error');
        return null;
      }
    }

    function toggleDocumentosModal(open) {
      if (!elements.documentosModal) return;
      if (open) {
        elements.documentosModal.classList.add('active');
      } else {
        elements.documentosModal.classList.remove('active');
      }
    }

    function resetDocumentosForm() {
      if (elements.formDocumentos) {
        elements.formDocumentos.reset();
      }
      if (elements.docsProprietario) elements.docsProprietario.value = '';
      if (elements.docsVeiculo) elements.docsVeiculo.value = '';
      if (elements.docsMotorista) elements.docsMotorista.value = '';
      referenciaInputsPessoais.forEach(input => { if (input) input.value = ''; });
      referenciaInputsComerciais.forEach(input => { if (input) input.value = ''; });
      if (elements.docsResumo) {
        elements.docsResumo.textContent = 'Selecione uma oportunidade para visualizar o resumo aqui.';
      }
    }

    function fecharDocumentosModal() {
      toggleDocumentosModal(false);
      state.selectedOpportunity = null;
      resetDocumentosForm();
    }

    // Variável para armazenar a coleta pendente após completar cadastro
    let coletaPendenteAposCadastro = null;

    // Função para verificar se o cadastro está completo
    function isCadastroCompleto() {
      const motorista = state.motorista;
      if (!motorista) {
        console.log('❌ isCadastroCompleto: Sem motorista');
        return false;
      }
      
      // Verificar se tem nome válido
      const nome = motorista.nome || '';
      const isNomeValido = nome.length >= 3 && !nome.includes('@') && !/^\d+$/.test(nome);
      
      // Verificar se tem telefone válido
      const telefone = motorista.telefone1 || motorista.telefone || '';
      const telefoneLimpo = telefone.replace(/\D/g, '');
      const telefoneValido = telefoneLimpo.length >= 12 || (telefoneLimpo.length >= 10 && !telefoneLimpo.startsWith('55'));
      
      // Verificar campos obrigatórios
      // Normalizar estado - pode vir como string, null, undefined ou objeto vazio
      let estadoValue = motorista.estado;
      
      // Se estado vier como objeto, tentar extrair o valor
      if (estadoValue && typeof estadoValue === 'object' && estadoValue !== null) {
        // Tentar extrair valor de objeto
        estadoValue = estadoValue.value || estadoValue.estado || String(estadoValue);
        console.warn('⚠️ Estado veio como objeto, tentando extrair:', {
          estadoOriginal: motorista.estado,
          estadoExtraido: estadoValue
        });
      }
      
      // Normalizar para string
      const estadoNormalizado = (estadoValue && (typeof estadoValue === 'string' || typeof estadoValue === 'number')) 
        ? String(estadoValue).trim().toUpperCase() 
        : null;
      
      const temEstado = !!estadoNormalizado && estadoNormalizado.length === 2 && estadoNormalizado !== 'NULL' && estadoNormalizado !== 'UNDEFINED';
      const temClasseVeiculo = !!(motorista.classeVeiculo || motorista.classe_veiculo);
      const temTipoVeiculo = !!(motorista.tipoVeiculo || motorista.tipo_veiculo);
      const temTipoCarroceria = !!(motorista.tipoCarroceria || motorista.tipo_carroceria);
      
      const resultado = isNomeValido && telefoneValido && temEstado && temClasseVeiculo && temTipoVeiculo && temTipoCarroceria;
      
      console.log('🔍 isCadastroCompleto:', {
        isNomeValido,
        telefoneValido,
        temEstado,
        estado: motorista.estado,
        estadoNormalizado: estadoNormalizado,
        estadoType: typeof motorista.estado,
        temClasseVeiculo,
        temTipoVeiculo,
        temTipoCarroceria,
        resultado
      });
      
      return resultado;
    }

    async function prepararAssumirOportunidade(coletaId) {
      if (!coletaId) return;

      // Recarregar dados do motorista do servidor antes de verificar
      try {
        const viagensResponse = await fetch('/api/motoristas/viagens', {
          headers: {
            Authorization: `Bearer ${state.session.access_token}`
          }
        });
        if (viagensResponse.ok) {
          const viagensResult = await viagensResponse.json();
          if (viagensResult.motorista) {
            state.motorista = viagensResult.motorista;
            atualizarCabecalho();
            console.log('✅ Dados do motorista recarregados antes de verificar cadastro:', {
              ...state.motorista,
              estado: state.motorista.estado,
              temEstado: !!state.motorista.estado,
              estadoType: typeof state.motorista.estado
            });
          }
        }
      } catch (reloadError) {
        console.warn('⚠️ Erro ao recarregar dados do motorista:', reloadError);
      }

      // Verificar se o status do motorista está ativo
      const motoristaStatus = (state.motorista?.status || '').toLowerCase();
      if (motoristaStatus !== 'ativo') {
        console.log('❌ Tentativa de assumir coleta com cadastro pendente:', {
          status: state.motorista?.status,
          motorista: state.motorista
        });
        showToast('Seu cadastro está pendente. Complete seu cadastro e aguarde a aprovação antes de assumir coletas.', 'error');
        return;
      }

      // Verificar se o cadastro está completo
      const cadastroCompleto = isCadastroCompleto();
      console.log('🔍 Verificando cadastro:', {
        temMotorista: !!state.motorista,
        status: motoristaStatus,
        cadastroCompleto,
        motorista: state.motorista
      });

      if (!cadastroCompleto) {
        console.log('📝 Cadastro incompleto, abrindo chat...');
        coletaPendenteAposCadastro = coletaId;
        chatCadastroState.coletaId = coletaId;
        iniciarChatCadastro();
        return;
      }
      
      // Se cadastro completo, verificar documentos
      const oportunidade = state.oportunidades.find(op => op.id === coletaId) || null;
      state.selectedOpportunity = oportunidade;
      
      // Aguardar um pouco para garantir sincronização
      await new Promise(resolve => setTimeout(resolve, 300));
      
      const status = await carregarStatusDocumentos(true);
      const pendentes = REQUIRED_DOC_CATEGORIES.filter(cat => !(status?.categorias?.[cat]?.possui));

      if (!pendentes.length) {
        try {
          showToast('Documentação já enviada. Reservando viagem...', 'success');
          await confirmarAssumirColeta(coletaId);
          await Promise.all([carregarOportunidades(), carregarViagens()]);
        } catch (error) {
          console.error('Erro ao assumir viagem:', error);
          showToast(error.message || 'Não foi possível assumir esta viagem agora.', 'error');
        }
        return;
      }

      // Abrir chat para solicitar documentos
      chatCadastroState.coletaId = coletaId;
      chatCadastroState.documentosPendentes = pendentes;
      iniciarChatDocumentos();
    }

    async function enviarDocumentos(event) {
      event.preventDefault();

      if (!state.selectedOpportunity || !state.selectedOpportunity.id) {
        showToast('Selecione uma oportunidade válida.', 'error');
        return;
      }

      const coletaId = state.selectedOpportunity.id;

      const arquivosProprietario = elements.docsProprietario ? Array.from(elements.docsProprietario.files || []) : [];
      const arquivosVeiculo = elements.docsVeiculo ? Array.from(elements.docsVeiculo.files || []) : [];
      const arquivosMotorista = elements.docsMotorista ? Array.from(elements.docsMotorista.files || []) : [];

      if (elements.docsProprietario?.required && !arquivosProprietario.length) {
        showToast('Envie os documentos do proprietário.', 'error');
        return;
      }

      if (elements.docsVeiculo?.required && !arquivosVeiculo.length) {
        showToast('Envie os documentos do veículo.', 'error');
        return;
      }

      if (elements.docsMotorista?.required && !arquivosMotorista.length) {
        showToast('Envie os documentos do motorista.', 'error');
        return;
      }

      const referenciasPessoais = referenciaInputsPessoais.map(input => (input?.value || '').trim()).filter(Boolean);
      const referenciasComerciais = referenciaInputsComerciais.map(input => (input?.value || '').trim()).filter(Boolean);

      if (referenciasPessoais.length < 2) {
        showToast('Informe ao menos duas referências pessoais.', 'error');
        return;
      }

      if (referenciasComerciais.length < 2) {
        showToast('Informe ao menos duas referências comerciais.', 'error');
        return;
      }

      const formData = new FormData();
      
      // Adicionar arquivos com suas categorias na ordem correta
      arquivosProprietario.forEach(file => {
        formData.append('arquivos', file);
        formData.append('categorias[]', 'proprietario');
      });
      
      arquivosVeiculo.forEach(file => {
        formData.append('arquivos', file);
        formData.append('categorias[]', 'veiculo');
      });
      
      arquivosMotorista.forEach(file => {
        formData.append('arquivos', file);
        formData.append('categorias[]', 'motorista');
      });

      formData.append('referencias_pessoais', JSON.stringify(referenciasPessoais));
      formData.append('referencias_comerciais', JSON.stringify(referenciasComerciais));

      try {
        toggleButtonLoading(elements.btnEnviarDocumentos, true, 'Enviando...');

        const response = await fetch(`/api/motoristas/coletas/${encodeURIComponent(coletaId)}/documentos`, {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${state.session.access_token}`
          },
          body: formData
        });

        const result = await response.json();
        if (!response.ok) {
          throw new Error(result.error || 'Não foi possível enviar os documentos agora.');
        }

        await confirmarAssumirColeta(coletaId);

        // Marcar solicitação como atendida se houver
        if (state.solicitacaoIdParaAtender) {
          try {
            await fetch(`/api/motoristas/solicitacoes/${state.solicitacaoIdParaAtender}/atender`, {
              method: 'POST',
              headers: {
                Authorization: `Bearer ${state.session.access_token}`
              }
            });
            state.solicitacaoIdParaAtender = null;
          } catch (error) {
            console.warn('Não foi possível marcar solicitação como atendida:', error);
          }
        }

        showToast('Documentos enviados! A equipe recebeu a viagem para etapa GR.', 'success');
        fecharDocumentosModal();
        await Promise.all([carregarOportunidades(), carregarViagens(), carregarStatusDocumentos(true), carregarNotificacoes()]);
      } catch (error) {
        console.error('Erro ao enviar documentos:', error);
        showToast(error.message || 'Erro ao enviar documentos. Tente novamente.', 'error');
      } finally {
        toggleButtonLoading(elements.btnEnviarDocumentos, false);
      }
    }

    // Variável para armazenar a coleta pendente de confirmação após aceitar termo
    let coletaPendenteConfirmacao = null;

    async function confirmarAssumirColeta(coletaId) {
      // Verificar se já existe termo aceito para esta coleta
      try {
        const termoResponse = await fetch(`/api/rastreamento/verificar-termo?coletaId=${encodeURIComponent(coletaId)}`, {
          headers: {
            Authorization: `Bearer ${state.session.access_token}`
          }
        });
        
        const termoData = await termoResponse.json();
        
        // Se não houver termo aceito, mostrar modal
        if (!termoData.termoAceito) {
          coletaPendenteConfirmacao = coletaId;
          mostrarModalTermoRastreamento();
          return null; // Retorna null para indicar que está aguardando aceite
        }
      } catch (error) {
        console.warn('Erro ao verificar termo:', error);
        // Continuar com o fluxo normal se houver erro
      }

      // Se termo já aceito ou erro na verificação, prosseguir normalmente
      return await executarAssumirColeta(coletaId);
    }

    async function executarAssumirColeta(coletaId) {
      if (!coletaId) {
        throw new Error('ID da coleta não fornecido.');
      }

      if (!state.session?.access_token) {
        throw new Error('Sessão não autenticada. Faça login novamente.');
      }

      console.log('📤 Tentando assumir coleta:', coletaId);

      try {
      const response = await fetch(`/api/motoristas/oportunidades/${encodeURIComponent(coletaId)}/assumir`, {
        method: 'POST',
        headers: {
          Authorization: `Bearer ${state.session.access_token}`,
          'Content-Type': 'application/json'
        }
      });

      const result = await response.json();
        
        console.log('📥 Resposta da API:', {
          status: response.status,
          ok: response.ok,
          error: result.error,
          success: result.success
        });

        if (response.status === 401) {
          // Sessão expirada
          await state.supabase.auth.signOut();
          window.location.href = 'login-motorista.html';
          return;
        }

      if (response.status === 409) {
          // Conflito: coleta já assumida ou motorista já tem viagem ativa
          const errorMsg = result.error || 'Essa coleta já foi assumida por outro motorista.';
          console.error('❌ Conflito ao assumir coleta:', errorMsg);
          throw new Error(errorMsg);
        }

        if (response.status === 404) {
          throw new Error('Coleta não encontrada. Ela pode ter sido removida.');
      }

      if (!response.ok) {
          const errorMsg = result.error || `Erro ao assumir coleta (status ${response.status}).`;
          console.error('❌ Erro ao assumir coleta:', {
            status: response.status,
            error: errorMsg,
            result: result
          });
          throw new Error(errorMsg);
        }

        if (!result.success) {
        throw new Error(result.error || 'Não foi possível assumir esta coleta.');
      }

        console.log('✅ Coleta assumida com sucesso:', result);

      state.motorista = result.motorista || state.motorista;
      await carregarStatusDocumentos(true);
      atualizarCabecalho();
      
      // Iniciar rastreamento após assumir coleta
      if (coletaId) {
        console.log('🚀 Coleta assumida, iniciando rastreamento GPS...', coletaId);
        // Aguardar um pouco para garantir que tudo está pronto
        setTimeout(() => {
          iniciarRastreamento(coletaId);
        }, 1000);
      } else {
        console.warn('⚠️ Coleta assumida mas sem coletaId para rastreamento');
      }
      
      return result;
      } catch (error) {
        console.error('❌ Erro completo ao executar assumir coleta:', {
          coletaId,
          error: error.message,
          stack: error.stack
        });
        throw error;
      }
    }

    function mostrarModalTermoRastreamento() {
      if (elements.rastreamentoTermoModal) {
        elements.rastreamentoTermoModal.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Atualizar data do termo
        const dataAtual = new Date().toLocaleDateString('pt-BR');
        const termoDataEl = document.getElementById('termoDataAtualizacao');
        if (termoDataEl) termoDataEl.textContent = dataAtual;
        
        // Resetar checkbox
        if (elements.aceitarTermoRastreamento) {
          elements.aceitarTermoRastreamento.checked = false;
        }
      }
    }

    function fecharModalTermoRastreamento() {
      if (elements.rastreamentoTermoModal) {
        elements.rastreamentoTermoModal.classList.remove('active');
        document.body.style.overflow = '';
        coletaPendenteConfirmacao = null;
      }
    }

    async function aceitarTermoERastreamento() {
      if (!elements.aceitarTermoRastreamento?.checked) {
        showToast('Você precisa aceitar o termo para continuar.', 'error');
        return;
      }

      if (!coletaPendenteConfirmacao) {
        showToast('Erro: Coleta não identificada.', 'error');
        fecharModalTermoRastreamento();
        return;
      }

      const coletaId = coletaPendenteConfirmacao;

      try {
        console.log('📝 Aceitando termo de rastreamento para coleta:', coletaId);
        
        // Registrar aceite do termo
        const termoResponse = await fetch('/api/rastreamento/aceitar-termo', {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${state.session.access_token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            coletaId: coletaId,
            termoVersao: '1.0',
            ipAddress: await obterIP(),
            userAgent: navigator.userAgent
          })
        });

        if (!termoResponse.ok) {
          const errorData = await termoResponse.json().catch(() => ({}));
          throw new Error(errorData.error || 'Não foi possível registrar o aceite do termo.');
        }

        const termoResult = await termoResponse.json();
        console.log('✅ Termo aceito com sucesso:', termoResult);

        fecharModalTermoRastreamento();
        
        // Aguardar um pouco para garantir que o modal fechou e o termo foi registrado
        await new Promise(resolve => setTimeout(resolve, 500));
        
        // Agora assumir a coleta (isso também iniciará o rastreamento)
        console.log('🚀 Assumindo coleta após aceitar termo...', coletaId);
        
        try {
          const resultado = await executarAssumirColeta(coletaId);
          console.log('✅ Coleta assumida com sucesso após termo:', resultado);
        showToast('Termo aceito! Rastreamento ativado. Viagem assumida com sucesso!', 'success');
        
          // Recarregar dados
        await Promise.all([carregarOportunidades(), carregarViagens()]);
          
          // Limpar variável pendente
          coletaPendenteConfirmacao = null;
        } catch (assumirError) {
          console.error('❌ Erro ao assumir coleta após aceitar termo:', {
            coletaId,
            error: assumirError.message,
            stack: assumirError.stack
          });
          
          // Mensagem de erro mais específica
          let errorMessage = assumirError.message || 'Erro ao assumir a viagem.';
          if (assumirError.message.includes('já foi assumida')) {
            errorMessage = 'Esta coleta já foi assumida por outro motorista.';
          } else if (assumirError.message.includes('viagem ativa')) {
            errorMessage = assumirError.message;
          } else if (assumirError.message.includes('não encontrada')) {
            errorMessage = 'Coleta não encontrada. Ela pode ter sido removida.';
          }
          
          showToast(`Termo aceito, mas ${errorMessage}`, 'error');
          
          // Recarregar oportunidades para atualizar a lista
          await carregarOportunidades();
        }
      } catch (error) {
        console.error('❌ Erro ao aceitar termo:', error);
        showToast(error.message || 'Erro ao processar aceite do termo.', 'error');
      }
    }

    async function obterIP() {
      try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
      } catch {
        return 'desconhecido';
      }
    }

    // Event listeners para modal de termo
    if (elements.btnFecharRastreamentoTermo) {
      elements.btnFecharRastreamentoTermo.addEventListener('click', fecharModalTermoRastreamento);
    }
    
    if (elements.btnRecusarTermo) {
      elements.btnRecusarTermo.addEventListener('click', () => {
        showToast('É necessário aceitar o termo para assumir viagens.', 'warning');
        fecharModalTermoRastreamento();
        coletaPendenteConfirmacao = null;
      });
    }
    
    if (elements.btnAceitarTermo) {
      elements.btnAceitarTermo.addEventListener('click', aceitarTermoERastreamento);
    }

    // ====== SISTEMA PWA (Progressive Web App) ======
    let deferredPrompt = null;
    let isAppInstalled = false;
    let serviceWorkerRegistration = null;

    async function inicializarPWA() {
      // Verificar se o app já está instalado
      if (window.matchMedia('(display-mode: standalone)').matches || 
          window.navigator.standalone === true ||
          document.referrer.includes('android-app://')) {
        isAppInstalled = true;
        console.log('✅ App já está instalado');
        if (elements.btnInstalarApp) {
          elements.btnInstalarApp.style.display = 'none';
        }
      }

      // Registrar service worker
      if ('serviceWorker' in navigator) {
        try {
          const registration = await navigator.serviceWorker.register('/service-worker.js');
          serviceWorkerRegistration = registration;
          console.log('✅ Service Worker registrado:', registration.scope);

          // Escutar mensagens do service worker
          navigator.serviceWorker.addEventListener('message', (event) => {
            console.log('📨 Mensagem do Service Worker:', event.data);
            if (event.data.type === 'POSITION_SENT') {
              console.log('✅ Posição enviada em background:', event.data);
            }
            
            // Responder a solicitações de posição do service worker
            if (event.data.type === 'REQUEST_POSITION') {
              if (rastreamentoAtivo && coletaRastreamentoAtiva && state.session?.access_token) {
                navigator.geolocation.getCurrentPosition(
                  (position) => {
                    const dadosPosicao = {
                      coletaId: coletaRastreamentoAtiva,
                      latitude: position.coords.latitude,
                      longitude: position.coords.longitude,
                      precisao: position.coords.accuracy,
                      altitude: position.coords.altitude || null,
                      velocidade: position.coords.speed ? (position.coords.speed * 3.6) : null,
                      direcao: position.coords.heading || null,
                      endereco: null,
                      bateriaNivel: null,
                      conectadoWifi: navigator.onLine,
                      conectadoRedeCelular: navigator.onLine,
                      origem: 'service_worker'
                    };
                    
                    // Enviar posição de volta para o service worker
                    if (serviceWorkerRegistration && serviceWorkerRegistration.active) {
                      serviceWorkerRegistration.active.postMessage({
                        type: 'POSITION_RESPONSE',
                        coletaId: coletaRastreamentoAtiva,
                        position: dadosPosicao,
                        sessionToken: state.session.access_token
                      });
                    }
                  },
                  (error) => {
                    console.error('❌ Erro ao obter posição para service worker:', error);
                  },
                  {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                  }
                );
              }
            }
          });
        } catch (error) {
          console.error('❌ Erro ao registrar Service Worker:', error);
        }
      }

      // Detectar evento de instalação
      window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        if (elements.btnInstalarApp) {
          elements.btnInstalarApp.style.display = 'inline-flex';
        }
        console.log('📱 Prompt de instalação disponível');
      });

      // Detectar quando o app é instalado
      window.addEventListener('appinstalled', () => {
        isAppInstalled = true;
        deferredPrompt = null;
        if (elements.btnInstalarApp) {
          elements.btnInstalarApp.style.display = 'none';
        }
        showToast('App instalado com sucesso! Agora você pode usar o app mesmo offline.', 'success');
        console.log('✅ App instalado');
      });

      // Event listener para botão de instalar
      if (elements.btnInstalarApp) {
        elements.btnInstalarApp.addEventListener('click', async () => {
          if (!deferredPrompt) {
            showToast('O app já está instalado ou não pode ser instalado neste dispositivo.', 'info');
            return;
          }

          // Mostrar prompt de instalação
          deferredPrompt.prompt();
          const { outcome } = await deferredPrompt.userChoice;
          
          if (outcome === 'accepted') {
            console.log('✅ Usuário aceitou instalar o app');
            showToast('Instalando app...', 'success');
          } else {
            console.log('❌ Usuário recusou instalar o app');
            showToast('Instalação cancelada. Você pode instalar depois pelo menu do navegador.', 'info');
          }
          
          deferredPrompt = null;
          if (elements.btnInstalarApp) {
            elements.btnInstalarApp.style.display = 'none';
          }
        });
      }
    }

    // Função para iniciar rastreamento em background via service worker
    async function iniciarRastreamentoBackground(coletaId) {
      if (!serviceWorkerRegistration || !serviceWorkerRegistration.active) {
        console.warn('⚠️ Service Worker não está ativo, usando rastreamento normal');
        return false;
      }

      if (!state.session?.access_token) {
        console.error('❌ Sessão não encontrada para rastreamento em background');
        return false;
      }

      try {
        // Enviar mensagem para o service worker iniciar rastreamento
        serviceWorkerRegistration.active.postMessage({
          type: 'START_TRACKING',
          coletaId: coletaId,
          sessionToken: state.session.access_token
        });
        console.log('✅ Rastreamento em background iniciado via Service Worker');
        return true;
      } catch (error) {
        console.error('❌ Erro ao iniciar rastreamento em background:', error);
        return false;
      }
    }

    // Função para parar rastreamento em background
    async function pararRastreamentoBackground() {
      if (!serviceWorkerRegistration || !serviceWorkerRegistration.active) {
        return;
      }

      try {
        serviceWorkerRegistration.active.postMessage({
          type: 'STOP_TRACKING'
        });
        console.log('🛑 Rastreamento em background parado');
      } catch (error) {
        console.error('❌ Erro ao parar rastreamento em background:', error);
      }
    }

    // ====== SISTEMA DE RASTREAMENTO GPS ======
    let rastreamentoAtivo = false;
    let intervaloRastreamento = null;
    let coletaRastreamentoAtiva = null;
    let watchId = null;

    async function iniciarRastreamento(coletaId) {
      if (!coletaId) {
        console.error('❌ iniciarRastreamento chamado sem coletaId');
        return;
      }

      if (rastreamentoAtivo && coletaRastreamentoAtiva === coletaId) {
        console.log('📍 Rastreamento já está ativo para esta coleta:', coletaId);
        return;
      }

      console.log('🚀 Iniciando rastreamento GPS para coleta:', coletaId);
      coletaRastreamentoAtiva = coletaId;
      rastreamentoAtivo = true;

      // Se o app está instalado, tentar usar rastreamento em background
      if (isAppInstalled && serviceWorkerRegistration) {
        const backgroundStarted = await iniciarRastreamentoBackground(coletaId);
        if (backgroundStarted) {
          console.log('✅ Rastreamento em background ativado');
          showToast('Rastreamento em background ativado! O app continuará monitorando mesmo fechado.', 'success');
          // Continuar com rastreamento normal também para garantir
        }
      }

      // Solicitar permissão de geolocalização
      if (!navigator.geolocation) {
        console.error('❌ Navegador não suporta geolocalização');
        showToast('Seu navegador não suporta geolocalização.', 'error');
        rastreamentoAtivo = false;
        return;
      }

      const options = {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 0
      };

      // Capturar posição inicial
      console.log('📍 Solicitando posição inicial...');
      navigator.geolocation.getCurrentPosition(
        (position) => {
          console.log('✅ Posição inicial obtida:', {
            lat: position.coords.latitude,
            lng: position.coords.longitude,
            accuracy: position.coords.accuracy
          });
          enviarPosicao(position, coletaId);
        },
        (error) => {
          console.error('❌ Erro ao obter localização inicial:', error);
          showToast('Erro ao acessar sua localização. Verifique as permissões do navegador.', 'error');
          rastreamentoAtivo = false;
        },
        options
      );

      // Monitorar mudanças de posição
      console.log('📍 Iniciando watchPosition...');
      watchId = navigator.geolocation.watchPosition(
        (position) => {
          console.log('📍 Nova posição detectada:', {
            lat: position.coords.latitude,
            lng: position.coords.longitude
          });
          enviarPosicao(position, coletaId);
        },
        (error) => {
          console.error('❌ Erro no watchPosition:', error);
          // Não desativar rastreamento por erro no watchPosition, continuar tentando
        },
        options
      );

      // Enviar posição periodicamente (a cada 30 segundos)
      console.log('📍 Configurando envio periódico a cada 30 segundos...');
      intervaloRastreamento = setInterval(() => {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            console.log('📍 Enviando posição periódica...');
            enviarPosicao(position, coletaId);
          },
          (error) => {
            console.error('❌ Erro ao obter posição periódica:', error);
          },
          options
        );
      }, 30000); // 30 segundos

      console.log('✅ Rastreamento GPS iniciado com sucesso para coleta:', coletaId);
      console.log('📊 Status do rastreamento:', {
        rastreamentoAtivo: rastreamentoAtivo,
        coletaRastreamentoAtiva: coletaRastreamentoAtiva,
        watchId: watchId,
        intervaloRastreamento: intervaloRastreamento !== null
      });
      showToast('Rastreamento GPS ativado! Sua localização está sendo monitorada.', 'success');
      
      // Verificar se a primeira posição foi enviada após 5 segundos
      setTimeout(() => {
        if (rastreamentoAtivo && coletaRastreamentoAtiva === coletaId) {
          console.log('✅ Rastreamento ainda ativo após 5 segundos');
        } else {
          console.warn('⚠️ Rastreamento não está mais ativo após 5 segundos');
        }
      }, 5000);
    }

    async function enviarPosicao(position, coletaId) {
      if (!state.session?.access_token) {
        console.error('❌ Sessão não encontrada para enviar posição');
        return;
      }

      if (!coletaId) {
        console.warn('⚠️ Enviar posição chamado sem coletaId, usando coleta ativa:', coletaRastreamentoAtiva);
        coletaId = coletaRastreamentoAtiva;
      }

      if (!coletaId) {
        console.error('❌ Não é possível enviar posição: coletaId não disponível');
        return;
      }

      const { latitude, longitude, accuracy, altitude, speed, heading } = position.coords;
      
      console.log('📤 Enviando posição GPS:', {
        coletaId: coletaId,
        latitude: latitude,
        longitude: longitude,
        accuracy: accuracy
      });

      // Obter endereço reverso (opcional, pode ser feito no servidor)
      let endereco = null;
      try {
        const response = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}&zoom=18&addressdetails=1`);
        const data = await response.json();
        if (data.address) {
          endereco = `${data.address.road || ''} ${data.address.house_number || ''}, ${data.address.city || data.address.town || ''}, ${data.address.state || ''}`.trim();
        }
      } catch (error) {
        console.warn('Erro ao obter endereço:', error);
      }

      const dadosPosicao = {
        coletaId: coletaId,
        latitude: latitude,
        longitude: longitude,
        precisao: accuracy,
        altitude: altitude || null,
        velocidade: speed ? (speed * 3.6) : null, // Converter m/s para km/h
        direcao: heading || null,
        endereco: endereco,
        bateriaNivel: null, // Não disponível via web API
        conectadoWifi: navigator.onLine,
        conectadoRedeCelular: navigator.onLine
      };

      try {
        const response = await fetch('/api/rastreamento/enviar-posicao', {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${state.session.access_token}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(dadosPosicao)
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({ error: 'Erro desconhecido' }));
          console.error('❌ Erro ao enviar posição:', {
            status: response.status,
            error: errorData.error || 'Erro desconhecido'
          });
          throw new Error(errorData.error || 'Erro ao enviar posição');
        }

        const result = await response.json();
        console.log('✅ Posição GPS enviada com sucesso:', {
          coletaId: coletaId,
          posicaoId: result.posicao?.id,
          timestamp: new Date().toISOString(),
          lat: latitude,
          lng: longitude
        });
        
        // Atualizar indicador visual de que posição foi enviada
        const statusRastreamento = document.getElementById('statusRastreamento');
        if (statusRastreamento) {
          statusRastreamento.textContent = `📍 Última posição: ${new Date().toLocaleTimeString('pt-BR')}`;
          statusRastreamento.style.color = '#4caf50';
        }
      } catch (error) {
        console.error('❌ Erro ao enviar posição GPS:', error);
        // Não mostrar toast para não incomodar o usuário, apenas logar
      }
    }

    function pararRastreamento() {
      if (watchId !== null) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
      }

      if (intervaloRastreamento !== null) {
        clearInterval(intervaloRastreamento);
        intervaloRastreamento = null;
      }

      // Parar rastreamento em background também
      if (isAppInstalled && serviceWorkerRegistration) {
        pararRastreamentoBackground();
      }

      rastreamentoAtivo = false;
      coletaRastreamentoAtiva = null;
      showToast('Rastreamento GPS desativado.', 'info');
    }

    // Parar rastreamento quando a página for fechada ou quando a coleta for finalizada
    window.addEventListener('beforeunload', () => {
      if (rastreamentoAtivo) {
        pararRastreamento();
      }
    });

    function abrirModalCadastro() {
      preencherFormularioCadastro();
      toggleModal(true);
    }

    function preencherFormularioCadastro() {
      const user = state.user || {};
      const motorista = state.motorista || {};
      
      // Limpar seleção de classe
      classeVeiculoSelecionada = null;
      document.querySelectorAll('.vehicle-class-portal').forEach(el => el.classList.remove('active'));
      
      if (elements.campoNome) elements.campoNome.value = (motorista.nome || user.nome || user.email || '').trim();
      if (elements.campoCnh) elements.campoCnh.value = motorista.cnh || '';
      if (elements.campoCategoriaCnh) elements.campoCategoriaCnh.value = motorista.categoria_cnh || '';
      if (elements.campoTelefone1) elements.campoTelefone1.value = formatPhone(motorista.telefone1 || '');
      if (elements.campoTelefone2) elements.campoTelefone2.value = formatPhone(motorista.telefone2 || '');
      if (elements.campoEstado) elements.campoEstado.value = motorista.estado || '';
      
      // Selecionar classe de veículo e atualizar opções
      const classe = (motorista.classeVeiculo || motorista.classe_veiculo || '').toLowerCase();
      if (classe && (classe === 'leve' || classe === 'medio' || classe === 'pesado')) {
        selecionarClasseVeiculoPortal(classe);
        if (elements.campoTipoVeiculo) setSelectValue(elements.campoTipoVeiculo, motorista.tipoVeiculo || motorista.tipo_veiculo);
        if (elements.campoTipoCarroceria) setSelectValue(elements.campoTipoCarroceria, motorista.tipoCarroceria || motorista.tipo_carroceria);
      } else {
        if (elements.campoTipoVeiculo) {
          elements.campoTipoVeiculo.innerHTML = '<option value="">Selecione a classe do veículo primeiro</option>';
          elements.campoTipoVeiculo.disabled = true;
        }
        if (elements.campoTipoCarroceria) {
          elements.campoTipoCarroceria.innerHTML = '<option value="">Selecione a classe do veículo primeiro</option>';
          elements.campoTipoCarroceria.disabled = true;
        }
      }
      
      if (elements.campoPlacaCavalo) elements.campoPlacaCavalo.value = motorista.placas?.cavalo || '';
      if (elements.campoPlacaCarreta1) elements.campoPlacaCarreta1.value = motorista.placas?.carreta1 || '';
      if (elements.campoPlacaCarreta2) elements.campoPlacaCarreta2.value = motorista.placas?.carreta2 || '';
      if (elements.campoPlacaCarreta3) elements.campoPlacaCarreta3.value = motorista.placas?.carreta3 || '';
    }

    async function salvarCadastro(event) {
      event.preventDefault();

      const nome = elements.campoNome.value.trim();
      const telefone1 = normalizePhone(elements.campoTelefone1.value);
      const telefone2 = normalizePhone(elements.campoTelefone2.value);

      if (!nome || nome.length < 3) {
        showToast('Informe seu nome completo.', 'error');
        elements.campoNome.focus();
        return;
      }

      if (!telefone1 || telefone1.length < 10) {
        showToast('Informe um telefone válido com DDD.', 'error');
        elements.campoTelefone1.focus();
        return;
      }

      if (!classeVeiculoSelecionada) {
        showToast('Selecione a classe do veículo.', 'error');
        return;
      }

      const tipoVeiculo = elements.campoTipoVeiculo?.value.trim();
      const tipoCarroceria = elements.campoTipoCarroceria?.value.trim();
      const estado = elements.campoEstado?.value.trim();

      if (!tipoVeiculo || !tipoCarroceria) {
        showToast('Selecione o tipo de veículo e a carroceria.', 'error');
        return;
      }

      if (!estado) {
        showToast('Selecione o estado.', 'error');
        elements.campoEstado?.focus();
        return;
      }

      // Normalizar estado para maiúsculo e garantir 2 caracteres
      const estadoNormalizado = estado ? estado.trim().toUpperCase().substring(0, 2) : null;

      const payload = {
        nome,
        cnh: elements.campoCnh?.value.trim() || null,
        categoriaCnh: elements.campoCategoriaCnh?.value || null,
        telefone: telefone1,
        telefoneSecundario: telefone2,
        estado: estadoNormalizado,
        classeVeiculo: classeVeiculoSelecionada,
        tipoVeiculo: tipoVeiculo,
        tipoCarroceria: tipoCarroceria,
        placaCavalo: normalizePlate(elements.campoPlacaCavalo?.value || ''),
        placaCarreta1: normalizePlate(elements.campoPlacaCarreta1?.value || ''),
        placaCarreta2: normalizePlate(elements.campoPlacaCarreta2?.value || ''),
        placaCarreta3: normalizePlate(elements.campoPlacaCarreta3?.value || '')
      };
      
      console.log('📤 Enviando payload de cadastro:', { ...payload, telefone: '***', telefoneSecundario: '***' });

      try {
        elements.btnSalvarCadastro.disabled = true;
        elements.btnSalvarCadastro.innerHTML = '<span class="loader">Salvando...</span>';

        const response = await fetch('/api/motoristas/auth/profile', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${state.session.access_token}`
          },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        if (response.status === 409) {
          showToast(result.error || 'Este telefone já está vinculado a outra conta.', 'error');
          return;
        }

        if (!response.ok) {
          throw new Error(result.error || 'Não foi possível salvar seu cadastro');
        }

        state.motorista = result.motorista;
        atualizarCabecalho();
        toggleModal(false);
        showToast('Cadastro atualizado com sucesso! Você já pode assumir oportunidades.', 'success');
        await carregarViagens();
        await carregarOportunidades();
      } catch (error) {
        console.error('Erro ao salvar cadastro:', error);
        showToast(error.message || 'Erro ao salvar seus dados', 'error');
      } finally {
        elements.btnSalvarCadastro.disabled = false;
        elements.btnSalvarCadastro.innerHTML = '<span class="btn-text"><i class="fas fa-save me-2"></i>Salvar cadastro</span>';
      }
    }

    function registrarEventos() {
      elements.btnSairPortal.addEventListener('click', async () => {
        await state.supabase.auth.signOut();
        window.location.href = 'login-motorista.html';
      });

      elements.btnCompletarCadastro.addEventListener('click', () => abrirModalCadastro());
      elements.btnIrOportunidades.addEventListener('click', () => {
        document.getElementById('oportunidadesCard').scrollIntoView({ behavior: 'smooth' });
      });

      elements.btnAtualizarOportunidades.addEventListener('click', () => carregarOportunidades());
      elements.btnAtualizarViagens.addEventListener('click', () => carregarViagens());
      if (elements.btnAtualizarNotificacoes) {
        elements.btnAtualizarNotificacoes.addEventListener('click', () => carregarNotificacoes());
      }

      // Inicializar seleção de classes de veículo
      document.querySelectorAll('.vehicle-class-portal').forEach(item => {
        item.addEventListener('click', function() {
          selecionarClasseVeiculoPortal(this.dataset.class);
        });
      });

      [elements.campoTelefone1, elements.campoTelefone2].forEach(input => {
        if (!input) return;
        input.addEventListener('input', (e) => {
          const digits = normalizePhone(e.target.value).slice(0, 11);
          if (!digits) {
            e.target.value = '';
            return;
          }
          if (digits.length <= 10) {
            e.target.value = digits.replace(/(\d{0,2})(\d{0,4})(\d{0,4})/, (match, ddd, parte1, parte2) => {
              const p1 = parte1 ? ` ${parte1}` : '';
              const p2 = parte2 ? `-${parte2}` : '';
              return ddd ? `(${ddd})${p1}${p2}` : parte1 + parte2;
            }).trim();
          } else {
            e.target.value = digits.replace(/(\d{0,2})(\d{0,5})(\d{0,4})/, (match, ddd, parte1, parte2) => {
              const p1 = parte1 ? ` ${parte1}` : '';
              const p2 = parte2 ? `-${parte2}` : '';
              return ddd ? `(${ddd})${p1}${p2}` : parte1 + parte2;
            }).trim();
          }
        });
      });

      [elements.campoPlacaCavalo, elements.campoPlacaCarreta1, elements.campoPlacaCarreta2, elements.campoPlacaCarreta3].forEach(input => {
        if (!input) return;
        input.addEventListener('input', () => {
          input.value = normalizePlate(input.value);
        });
      });

      elements.btnFecharModal.addEventListener('click', () => toggleModal(false));
      elements.btnCancelarCadastro.addEventListener('click', () => toggleModal(false));
      elements.modal.addEventListener('click', (event) => {
        if (event.target === elements.modal) {
          toggleModal(false);
        }
      });

      if (elements.formCadastro) {
        elements.formCadastro.addEventListener('submit', salvarCadastro);
      }

      if (elements.btnFecharDocumentos) {
        elements.btnFecharDocumentos.addEventListener('click', fecharDocumentosModal);
      }

      if (elements.btnCancelarDocumentos) {
        elements.btnCancelarDocumentos.addEventListener('click', fecharDocumentosModal);
      }

      if (elements.formDocumentos) {
        elements.formDocumentos.addEventListener('submit', enviarDocumentos);
      }

      if (elements.documentosModal) {
        elements.documentosModal.addEventListener('click', (event) => {
          if (event.target === elements.documentosModal) {
            fecharDocumentosModal();
          }
        });
      }

      if (elements.oportunidadesLista) {
        // Event listener para botão de assumir (prioridade)
        elements.oportunidadesLista.addEventListener('click', async (event) => {
          // Verificar se é o botão de assumir ou qualquer elemento dentro dele
          const assumirBtn = event.target.closest('[data-action="assumir"]');
          if (assumirBtn) {
            event.preventDefault();
            event.stopPropagation();
            const coletaId = assumirBtn.dataset.coletaId;
            if (coletaId) {
              await prepararAssumirOportunidade(coletaId);
            }
            return;
          }
        });

        // Event listener separado para expandir/colapsar cards
        elements.oportunidadesLista.addEventListener('click', (event) => {
          // Não processar se foi clique no botão assumir
          if (event.target.closest('[data-action="assumir"]')) {
            return;
          }

          // Verificar se clicou no card
          const card = event.target.closest('.opportunity-card');
          
          if (card) {
            event.preventDefault();
            event.stopPropagation();
            const coletaId = card.dataset.coletaId;
            const isExpanded = card.dataset.expanded === 'true';
            
            // Encontrar elementos dentro do card
            const icon = card.querySelector(`[data-expand-icon="${coletaId}"]`);
            const text = card.querySelector(`[data-expand-text="${coletaId}"]`);

            if (isExpanded) {
              // Colapsar
              card.dataset.expanded = 'false';
              card.classList.remove('expanded');
              if (icon) {
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
              }
              if (text) text.textContent = 'Ver detalhes';
            } else {
              // Expandir
              card.dataset.expanded = 'true';
              card.classList.add('expanded');
              if (icon) {
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
              }
              if (text) text.textContent = 'Ocultar detalhes';
            }
          }
        });
      }
    }

    async function initPortal() {
      try {
        await carregarConfigSupabase();

        const sessaoValida = await carregarSessao();
        if (!sessaoValida) return;

        state.supabase.auth.onAuthStateChange(async (event, session) => {
          if (session) {
            state.session = session;
            await carregarPerfil();
            await carregarViagens();
            await carregarOportunidades();
            await carregarNotificacoes();
          } else {
            window.location.href = 'login-motorista.html';
          }
        });

        registrarEventos();
        inicializarFiltros();
        inicializarPWA();
        await carregarPerfil();
        await Promise.all([
          carregarViagens(),
          carregarOportunidades(),
          carregarStatusDocumentos(true)
        ]);
      } catch (error) {
        console.error('Erro ao inicializar portal:', error);
        showToast(error.message || 'Não foi possível carregar o portal', 'error');
        setTimeout(() => window.location.href = 'login-motorista.html', 3500);
      }
    }

    // ========== Sistema de Chat para Completar Cadastro ==========
    let chatCadastroState = {
      step: 'nome',
      data: {},
      isWaiting: false,
      documentos: {
        arquivos: {
          proprietario: [],
          veiculo: [],
          motorista: []
        },
        referenciasPessoais: [],
        referenciasComerciais: []
      },
      documentosPendentes: [],
      coletaId: null,
      referenciaParcial: null // Para armazenar primeira referência quando usuário informa apenas uma
    };

    let chatCadastroElements = {};

    function inicializarElementosChatCadastro() {
      chatCadastroElements = {
        overlay: document.getElementById('chatCadastroOverlay'),
        messages: document.getElementById('chatCadastroMessages'),
        options: document.getElementById('chatCadastroOptions'),
        form: document.getElementById('chatCadastroForm'),
        input: document.getElementById('chatCadastroInput'),
        sendBtn: document.getElementById('chatCadastroSendBtn'),
        closeBtn: document.getElementById('btnFecharChatCadastro'),
        fileUpload: document.getElementById('chatCadastroFileUpload'),
        fileInput: document.getElementById('chatCadastroFileInput'),
        fileList: document.getElementById('chatCadastroFileList'),
        fileBtn: document.getElementById('chatCadastroFileBtn')
      };
    }

    function iniciarChatCadastro() {
      console.log('🚀 Iniciando chat de cadastro...');
      
      // Garantir que os elementos estejam inicializados
      if (!chatCadastroElements.overlay) {
        console.log('⚠️ Elementos não inicializados, inicializando...');
        inicializarElementosChatCadastro();
      }
      
      if (!chatCadastroElements.overlay) {
        console.error('❌ Erro: chatCadastroElements.overlay não encontrado!');
        showToast('Erro ao abrir chat de cadastro. Recarregue a página.', 'error');
        return;
      }
      
      console.log('✅ Elementos do chat encontrados:', {
        overlay: !!chatCadastroElements.overlay,
        messages: !!chatCadastroElements.messages,
        form: !!chatCadastroElements.form
      });
      
      // Verificar quais dados já existem
      const user = state.user || {};
      const motorista = state.motorista || {};
      
      // Função auxiliar para verificar se um nome é válido (não é email, tem pelo menos 3 caracteres, tem espaços ou é um nome real)
      function isNomeValido(nome) {
        if (!nome || typeof nome !== 'string') return false;
        const nomeLimpo = nome.trim();
        // Deve ter pelo menos 3 caracteres, não ser só números, e não conter @ (não é email)
        return nomeLimpo.length >= 3 && 
               !/^\d+$/.test(nomeLimpo) && 
               !nomeLimpo.includes('@') &&
               nomeLimpo.split(' ').length >= 1; // Pelo menos uma palavra
      }
      
      // Preencher dados existentes (só usar nome se for válido)
      const nomeExistente = motorista.nome || user.nome || '';
      
      // Normalizar telefone (remover caracteres não numéricos)
      // Se o usuário já tem motorista, o telefone já foi coletado no login/cadastro
      const telefoneBruto = motorista.telefone1 || motorista.telefone || '';
      const telefoneNormalizado = telefoneBruto ? telefoneBruto.replace(/\D/g, '') : '';
      
      // Se o usuário já tem um motorista, significa que fez login/cadastro e o telefone já foi coletado
      // Não precisamos solicitar telefone novamente se já existe
      const telefoneJaColetado = !!motorista && telefoneNormalizado.length >= 10;
      
      chatCadastroState.data = {
        nome: isNomeValido(nomeExistente) ? nomeExistente.trim() : '',
        telefone: telefoneNormalizado, // Armazenar apenas dígitos
        estado: motorista.estado || '',
        classeVeiculo: motorista.classeVeiculo || motorista.classe_veiculo || '',
        tipoVeiculo: motorista.tipoVeiculo || motorista.tipo_veiculo || '',
        tipoCarroceria: motorista.tipoCarroceria || motorista.tipo_carroceria || ''
      };
      
      // Determinar qual é o próximo passo necessário
      let proximoPasso = null;
      let mensagemInicial = 'Olá! Vou te ajudar a completar seu cadastro para que você possa assumir viagens.';
      const dadosFaltantes = [];
      
      if (!chatCadastroState.data.nome || !isNomeValido(chatCadastroState.data.nome)) {
        dadosFaltantes.push('nome completo');
        if (!proximoPasso) proximoPasso = 'nome';
      }
      
      // Validar telefone (pode ter 55 no início, então precisa de pelo menos 12 dígitos com código ou 10 sem)
      // MAS: se o usuário já tem motorista, o telefone já foi coletado no login, não solicitar novamente
      const telefoneLimpo = (chatCadastroState.data.telefone || '').replace(/\D/g, '');
      const telefoneValido = telefoneLimpo.length >= 12 || (telefoneLimpo.length >= 10 && !telefoneLimpo.startsWith('55'));
      
      // Só solicitar telefone se não foi coletado no login (ou seja, se não tem motorista ou telefone inválido)
      if (!telefoneJaColetado && (!chatCadastroState.data.telefone || !telefoneValido)) {
        dadosFaltantes.push('telefone');
        if (!proximoPasso) proximoPasso = 'telefone';
      }
      
      if (!chatCadastroState.data.estado) {
        dadosFaltantes.push('estado (UF)');
        if (!proximoPasso) proximoPasso = 'estado';
      }
      
      if (!chatCadastroState.data.classeVeiculo) {
        dadosFaltantes.push('classe do veículo');
        if (!proximoPasso) proximoPasso = 'classe';
      }
      
      if (!chatCadastroState.data.tipoVeiculo) {
        dadosFaltantes.push('tipo de veículo');
        if (!proximoPasso) proximoPasso = 'tipoVeiculo';
      }
      
      if (!chatCadastroState.data.tipoCarroceria) {
        dadosFaltantes.push('tipo de carroceria');
        if (!proximoPasso) proximoPasso = 'tipoCarroceria';
      }
      
      // Se não há dados faltantes, algo está errado
      if (!proximoPasso) {
        mensagemInicial = 'Seu cadastro parece estar completo. Vou verificar...';
        proximoPasso = 'finalizar';
      } else {
        // Adicionar informações sobre dados já coletados
        const dadosColetados = [];
        if (chatCadastroState.data.nome && isNomeValido(chatCadastroState.data.nome)) {
          dadosColetados.push('nome');
        }
        if (telefoneJaColetado || telefoneValido) {
          dadosColetados.push('telefone');
        }
        
        if (dadosColetados.length > 0) {
          mensagemInicial += ` Já tenho seu ${dadosColetados.join(' e ')}.`;
        }
        
        if (dadosFaltantes.length > 1) {
          mensagemInicial += ` Preciso de algumas informações: ${dadosFaltantes.join(', ')}. Vamos começar?`;
        } else {
          mensagemInicial += ` Preciso apenas de ${dadosFaltantes[0]}.`;
        }
      }
      
      chatCadastroState.step = proximoPasso;
      chatCadastroState.isWaiting = false;
      
      if (chatCadastroElements.overlay) {
        chatCadastroElements.overlay.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // Prevenir scroll do body
        
        if (chatCadastroElements.messages) {
          chatCadastroElements.messages.innerHTML = '';
        }
        if (chatCadastroElements.options) {
          chatCadastroElements.options.innerHTML = '';
        }
        if (chatCadastroElements.fileUpload) {
          chatCadastroElements.fileUpload.style.display = 'none';
        }
        if (chatCadastroElements.fileList) {
          chatCadastroElements.fileList.innerHTML = '';
        }
        if (chatCadastroElements.fileBtn) {
          chatCadastroElements.fileBtn.style.display = 'none';
        }
        if (chatCadastroElements.input) {
          chatCadastroElements.input.value = '';
          chatCadastroElements.input.disabled = false;
          setTimeout(() => {
            if (chatCadastroElements.input) {
              chatCadastroElements.input.focus();
            }
          }, 100);
        }
      } else {
        console.error('❌ chatCadastroElements.overlay é null!');
      }

      adicionarMensagemChat(mensagemInicial, 'bot');
      
      // Iniciar com o primeiro passo necessário
      setTimeout(() => {
        iniciarProximoPassoChat(proximoPasso);
      }, 800);
    }
    
    function iniciarProximoPassoChat(passo) {
      switch (passo) {
        case 'nome':
          adicionarMensagemChat('Qual é o seu nome completo?', 'bot');
          break;
        case 'telefone':
          adicionarMensagemChat('Preciso do seu telefone principal. Informe no formato DDD + 9 + número (ex: 81999998888). O código do país (55) será adicionado automaticamente.', 'bot');
          break;
        case 'estado':
          adicionarMensagemChat('Em qual estado (UF) você está baseado? Digite a sigla (ex: PE, SP, RJ).', 'bot');
          break;
        case 'classe':
          adicionarMensagemChat('Qual é a classe do seu veículo?', 'bot');
          definirOpcoesChat([
            { label: 'Leve', value: 'leve' },
            { label: 'Médio', value: 'medio' },
            { label: 'Pesado', value: 'pesado' }
          ]);
          break;
        case 'tipoVeiculo':
          carregarTiposVeiculo(chatCadastroState.data.classeVeiculo).then(tipos => {
            adicionarMensagemChat('Qual é o tipo do seu veículo?', 'bot');
            if (tipos.length > 0) {
              definirOpcoesChat(tipos.map(tipo => ({ label: tipo, value: tipo })));
            } else {
              adicionarMensagemChat('Digite o tipo do seu veículo (ex: Caminhão, Carreta, Van).', 'bot');
            }
            setChatWaiting(false);
          });
          return;
        case 'tipoCarroceria':
          carregarTiposCarroceria(chatCadastroState.data.classeVeiculo).then(tipos => {
            adicionarMensagemChat('Qual é o tipo de carroceria?', 'bot');
            if (tipos.length > 0) {
              definirOpcoesChat(tipos.map(carroceria => ({ label: carroceria, value: carroceria })));
            } else {
              adicionarMensagemChat('Digite o tipo de carroceria (ex: Baú, Sider, Graneleiro).', 'bot');
            }
            setChatWaiting(false);
          });
          return;
        case 'finalizar':
          setTimeout(async () => {
            adicionarMensagemChat('Verificando seus dados...', 'bot');
            await salvarCadastroViaChat();
          }, 500);
          return;
      }
      setChatWaiting(false);
    }

    function fecharChatCadastro() {
      if (chatCadastroElements.overlay) {
        chatCadastroElements.overlay.style.display = 'none';
      }
      document.body.style.overflow = ''; // Restaurar scroll do body
      chatCadastroState = { 
        step: 'nome', 
        data: {}, 
        isWaiting: false,
        documentos: {
          arquivos: { proprietario: [], veiculo: [], motorista: [] },
          referenciasPessoais: [],
          referenciasComerciais: []
        },
        documentosPendentes: [],
        coletaId: null,
        referenciaParcial: null
      };
      coletaPendenteAposCadastro = null;
    }

    function adicionarMensagemChat(content, sender = 'bot', error = false) {
      if (!chatCadastroElements.messages) return;

      const messageEl = document.createElement('div');
      messageEl.className = `chat-cadastro-message ${sender}${error ? ' error' : ''}`;
      
      const icon = document.createElement('div');
      icon.className = 'message-icon';
      icon.innerHTML = sender === 'bot' ? '<i class="fas fa-robot"></i>' : '<i class="fas fa-user"></i>';
      
      const bubble = document.createElement('div');
      bubble.className = 'message-bubble';
      bubble.innerHTML = content.replace(/\n/g, '<br>').replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
      
      messageEl.appendChild(icon);
      messageEl.appendChild(bubble);
      chatCadastroElements.messages.appendChild(messageEl);
      
      chatCadastroElements.messages.scrollTop = chatCadastroElements.messages.scrollHeight;
    }

    function definirOpcoesChat(options = []) {
      if (!chatCadastroElements.options) return;
      chatCadastroElements.options.innerHTML = '';
      
      if (!options.length) return;

      options.forEach(option => {
        const button = document.createElement('button');
        button.type = 'button';
        button.className = 'chat-cadastro-option-btn';
        button.textContent = option.label || option.value;
        button.dataset.value = option.value || option.label;
        button.addEventListener('click', () => {
          processarRespostaChat(button.dataset.value);
        });
        chatCadastroElements.options.appendChild(button);
      });
    }

    function setChatWaiting(waiting) {
      chatCadastroState.isWaiting = waiting;
      if (chatCadastroElements.input) {
        chatCadastroElements.input.disabled = waiting;
      }
      if (chatCadastroElements.sendBtn) {
        chatCadastroElements.sendBtn.disabled = waiting;
      }
    }

    async function processarRespostaChat(input) {
      if (chatCadastroState.isWaiting) return;

      const inputRaw = (input || '').trim();
      if (!inputRaw) return;

      adicionarMensagemChat(inputRaw, 'user');
      chatCadastroElements.input.value = '';
      definirOpcoesChat([]);
      setChatWaiting(true);

      try {
        await processarPassoChat(inputRaw);
      } catch (error) {
        console.error('Erro no chat de cadastro:', error);
        adicionarMensagemChat('Desculpe, ocorreu um erro. Tente novamente.', 'bot', true);
        setChatWaiting(false);
      }
    }

    function avancarParaProximoPasso() {
      // Função auxiliar para verificar se um nome é válido
      function isNomeValido(nome) {
        if (!nome || typeof nome !== 'string') return false;
        const nomeLimpo = nome.trim();
        return nomeLimpo.length >= 3 && 
               !/^\d+$/.test(nomeLimpo) && 
               !nomeLimpo.includes('@') &&
               nomeLimpo.split(' ').length >= 1;
      }
      
      // Determinar qual é o próximo passo necessário
      let proximoPasso = null;
      
      if (!chatCadastroState.data.nome || !isNomeValido(chatCadastroState.data.nome)) {
        proximoPasso = 'nome';
      } else {
        // Validar telefone (pode ter 55 no início, então precisa de pelo menos 12 dígitos com código ou 10 sem)
        // Se o usuário já tem motorista, o telefone já foi coletado no login, não solicitar novamente
        const telefoneLimpo = (chatCadastroState.data.telefone || '').replace(/\D/g, '');
        const telefoneValido = telefoneLimpo.length >= 12 || (telefoneLimpo.length >= 10 && !telefoneLimpo.startsWith('55'));
        const telefoneJaColetado = !!state.motorista && telefoneLimpo.length >= 10;
        
        if (!telefoneJaColetado && (!chatCadastroState.data.telefone || !telefoneValido)) {
          proximoPasso = 'telefone';
        } else if (!chatCadastroState.data.estado) {
          proximoPasso = 'estado';
        } else if (!chatCadastroState.data.classeVeiculo) {
          proximoPasso = 'classe';
        } else if (!chatCadastroState.data.tipoVeiculo) {
          proximoPasso = 'tipoVeiculo';
        } else if (!chatCadastroState.data.tipoCarroceria) {
          proximoPasso = 'tipoCarroceria';
        } else {
          proximoPasso = 'finalizar';
        }
      }
      
      chatCadastroState.step = proximoPasso;
      
      setTimeout(() => {
        iniciarProximoPassoChat(proximoPasso);
      }, 500);
    }

    async function processarPassoChat(inputRaw) {
      const step = chatCadastroState.step;
      const normalizedInput = inputRaw.toLowerCase().trim();

      switch (step) {
        case 'nome':
          if (inputRaw.length < 3) {
            adicionarMensagemChat('Por favor, informe seu nome completo (mínimo 3 caracteres).', 'bot', true);
            setChatWaiting(false);
            return;
          }
          chatCadastroState.data.nome = inputRaw.trim();
          avancarParaProximoPasso();
          break;

        case 'telefone':
          const digits = inputRaw.replace(/\D/g, '');
          let phoneWithCountryCode = digits;
          
          if (digits.startsWith('55') && digits.length === 13) {
            phoneWithCountryCode = digits.slice(2);
          }
          
          const isValidPhone = /^\d{2}9\d{8}$/.test(phoneWithCountryCode) || 
                              (phoneWithCountryCode.length === 10 && /^\d{2}\d{8}$/.test(phoneWithCountryCode));
          
          if (!isValidPhone) {
            adicionarMensagemChat('Telefone inválido. Informe no formato DDD + 9 + número (ex: 81999998888).', 'bot', true);
            setChatWaiting(false);
            return;
          }

          const fullPhone = digits.startsWith('55') ? digits : '55' + phoneWithCountryCode;
          chatCadastroState.data.telefone = fullPhone;
          avancarParaProximoPasso();
          break;

        case 'estado':
          const estado = inputRaw.trim().toUpperCase();
          const estadosValidos = ['AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA', 'MT', 'MS', 'MG', 'PA', 'PB', 'PR', 'PE', 'PI', 'RJ', 'RN', 'RS', 'RO', 'RR', 'SC', 'SP', 'SE', 'TO'];
          
          if (!estadosValidos.includes(estado)) {
            adicionarMensagemChat('Estado inválido. Digite a sigla do estado com 2 letras (ex: PE, SP, RJ).', 'bot', true);
            setChatWaiting(false);
            return;
          }
          
          chatCadastroState.data.estado = estado;
          avancarParaProximoPasso();
          break;

        case 'classe':
          const classe = normalizedInput;
          const classesValidas = ['leve', 'medio', 'pesado'];
          
          if (!classesValidas.includes(classe)) {
            adicionarMensagemChat('Por favor, selecione uma das opções acima.', 'bot', true);
            setChatWaiting(false);
            return;
          }
          
          chatCadastroState.data.classeVeiculo = classe;
          avancarParaProximoPasso();
          break;

        case 'tipoVeiculo':
          if (inputRaw.length < 2) {
            adicionarMensagemChat('Por favor, informe o tipo do veículo.', 'bot', true);
            setChatWaiting(false);
            return;
          }
          
          chatCadastroState.data.tipoVeiculo = inputRaw.trim();
          avancarParaProximoPasso();
          break;

        case 'tipoCarroceria':
          if (inputRaw.length < 2) {
            adicionarMensagemChat('Por favor, informe o tipo de carroceria.', 'bot', true);
            setChatWaiting(false);
            return;
          }
          
          chatCadastroState.data.tipoCarroceria = inputRaw.trim();
          avancarParaProximoPasso();
          break;

        case 'referencias_pessoais':
          // Se já tem uma referência parcial, adicionar esta como segunda
          if (chatCadastroState.referenciaParcial) {
            chatCadastroState.documentos.referenciasPessoais = [
              chatCadastroState.referenciaParcial,
              inputRaw.trim()
            ];
            chatCadastroState.referenciaParcial = null;
            chatCadastroState.step = 'referencias_comerciais';
            setTimeout(() => {
              adicionarMensagemChat('Agora preciso de **2 referências comerciais**.\n\nDigite dois nomes separados por vírgula ou "e".\n\nExemplo: João, Maria\nOu: João e Maria', 'bot');
              setChatWaiting(false);
            }, 500);
            return;
          }
          
          // Lógica simples: dividir por vírgula, "e" ou espaço
          let refsPessoais = [];
          
          // Tentar dividir por vírgula primeiro
          if (inputRaw.includes(',')) {
            refsPessoais = inputRaw.split(',').map(r => r.trim()).filter(Boolean);
          }
          // Se não tem vírgula, tentar dividir por "e"
          else if (/\s+e\s+/i.test(inputRaw)) {
            refsPessoais = inputRaw.split(/\s+e\s+/i).map(r => r.trim()).filter(Boolean);
          }
          // Se não tem separador, verificar se tem 2 ou mais palavras
          else {
            const palavras = inputRaw.trim().split(/\s+/).filter(p => p.length >= 2);
            if (palavras.length >= 2) {
              // Se tem 2 palavras, cada uma é uma referência
              if (palavras.length === 2) {
                refsPessoais = palavras;
              } else {
                // Se tem mais de 2 palavras, dividir ao meio
                const meio = Math.ceil(palavras.length / 2);
                refsPessoais = [
                  palavras.slice(0, meio).join(' '),
                  palavras.slice(meio).join(' ')
                ];
              }
            }
          }
          
          // Se ainda não tem 2 referências, armazenar como primeira e pedir a segunda
          if (refsPessoais.length < 2) {
            const primeiraRef = refsPessoais.length === 1 ? refsPessoais[0] : inputRaw.trim();
            chatCadastroState.referenciaParcial = primeiraRef;
            adicionarMensagemChat(`✅ Primeira referência: ${primeiraRef}\n\nAgora digite a segunda referência pessoal.`, 'bot');
            setChatWaiting(false);
            return;
          }
          
          chatCadastroState.documentos.referenciasPessoais = refsPessoais;
          chatCadastroState.step = 'referencias_comerciais';
          setTimeout(() => {
            adicionarMensagemChat('Agora preciso de **2 referências comerciais**.\n\nDigite dois nomes separados por vírgula ou "e".\n\nExemplo: João, Maria\nOu: João e Maria', 'bot');
            setChatWaiting(false);
          }, 500);
          break;

        case 'referencias_comerciais':
          // Se já tem uma referência parcial, adicionar esta como segunda
          if (chatCadastroState.referenciaParcial) {
            chatCadastroState.documentos.referenciasComerciais = [
              chatCadastroState.referenciaParcial,
              inputRaw.trim()
            ];
            chatCadastroState.referenciaParcial = null;
            chatCadastroState.step = 'enviar_documentos';
            setTimeout(async () => {
              adicionarMensagemChat('Perfeito! Vou enviar todos os documentos agora...', 'bot');
              await enviarDocumentosViaChat();
            }, 500);
            return;
          }
          
          // Lógica simples: dividir por vírgula, "e" ou espaço
          let refsComerciais = [];
          
          // Tentar dividir por vírgula primeiro
          if (inputRaw.includes(',')) {
            refsComerciais = inputRaw.split(',').map(r => r.trim()).filter(Boolean);
          }
          // Se não tem vírgula, tentar dividir por "e"
          else if (/\s+e\s+/i.test(inputRaw)) {
            refsComerciais = inputRaw.split(/\s+e\s+/i).map(r => r.trim()).filter(Boolean);
          }
          // Se não tem separador, verificar se tem 2 ou mais palavras
          else {
            const palavras = inputRaw.trim().split(/\s+/).filter(p => p.length >= 2);
            if (palavras.length >= 2) {
              // Se tem 2 palavras, cada uma é uma referência
              if (palavras.length === 2) {
                refsComerciais = palavras;
              } else {
                // Se tem mais de 2 palavras, dividir ao meio
                const meio = Math.ceil(palavras.length / 2);
                refsComerciais = [
                  palavras.slice(0, meio).join(' '),
                  palavras.slice(meio).join(' ')
                ];
              }
            }
          }
          
          // Se ainda não tem 2 referências, armazenar como primeira e pedir a segunda
          if (refsComerciais.length < 2) {
            const primeiraRef = refsComerciais.length === 1 ? refsComerciais[0] : inputRaw.trim();
            chatCadastroState.referenciaParcial = primeiraRef;
            adicionarMensagemChat(`✅ Primeira referência: ${primeiraRef}\n\nAgora digite a segunda referência comercial.`, 'bot');
            setChatWaiting(false);
            return;
          }
          
          chatCadastroState.documentos.referenciasComerciais = refsComerciais;
          chatCadastroState.step = 'enviar_documentos';
          setTimeout(async () => {
            adicionarMensagemChat('Perfeito! Vou enviar todos os documentos agora...', 'bot');
            await enviarDocumentosViaChat();
          }, 500);
          break;

        default:
          // Verificar se é um passo de documento
          if (step.startsWith('documento_')) {
            const categoria = step.replace('documento_', '');
            const arquivos = chatCadastroState.documentos.arquivos[categoria] || [];
            
            // Verificar ações especiais
            if (normalizedInput === 'continuar_documentos' || normalizedInput === 'continuar') {
              if (arquivos.length === 0) {
                adicionarMensagemChat('Por favor, envie pelo menos um arquivo antes de continuar. Clique no botão de anexo (📎).', 'bot', true);
                setChatWaiting(false);
                return;
              }
              
              // Remover categoria dos pendentes e avançar
              const index = chatCadastroState.documentosPendentes.indexOf(categoria);
              if (index > -1) {
                chatCadastroState.documentosPendentes.splice(index, 1);
              }
              
              // Ocultar upload
              if (chatCadastroElements.fileUpload) {
                chatCadastroElements.fileUpload.style.display = 'none';
              }
              
              adicionarMensagemChat(`✅ Documentos de ${DOCUMENT_CATEGORY_LABELS[categoria]} recebidos!`, 'bot');
              solicitarProximoDocumento();
            } else if (normalizedInput === 'adicionar_mais' || normalizedInput === 'adicionar') {
              // Permitir adicionar mais arquivos
              if (chatCadastroElements.fileInput) {
                chatCadastroElements.fileInput.click();
              }
              setChatWaiting(false);
            } else if (arquivos.length === 0) {
              // Se não tem arquivos e não é uma ação especial, pedir para enviar
              adicionarMensagemChat('Por favor, envie pelo menos um arquivo antes de continuar. Clique no botão de anexo (📎).', 'bot', true);
              setChatWaiting(false);
            } else {
              // Se tem arquivos mas não é ação especial, perguntar se quer continuar
              definirOpcoesChat([
                { label: 'Adicionar mais arquivos', value: 'adicionar_mais' },
                { label: 'Continuar', value: 'continuar_documentos' }
              ]);
              setChatWaiting(false);
            }
          } else {
            setChatWaiting(false);
          }
          break;
      }
    }

    async function carregarTiposVeiculo(classe) {
      // Tipos comuns por classe
      const tipos = {
        leve: ['Van', 'Furgão', 'Pick-up', 'Utilitário'],
        medio: ['Caminhão Médio', 'Toco', 'Truck'],
        pesado: ['Caminhão Pesado', 'Carreta', 'Bitrem', 'Rodotrem', 'Cavalo Mecânico']
      };
      return tipos[classe] || [];
    }

    async function carregarTiposCarroceria(classe) {
      // Tipos de carroceria comuns
      const carrocerias = {
        leve: ['Baú', 'Frigorífica', 'Sider', 'Aberta'],
        medio: ['Baú', 'Sider', 'Graneleiro', 'Frigorífica'],
        pesado: ['Baú', 'Sider', 'Graneleiro', 'Frigorífica', 'Tanque', 'Plataforma']
      };
      return carrocerias[classe] || [];
    }

    async function salvarCadastroViaChat() {
      try {
        // Normalizar estado para maiúsculo e garantir 2 caracteres
        const estadoNormalizado = chatCadastroState.data.estado 
          ? chatCadastroState.data.estado.trim().toUpperCase().substring(0, 2) 
          : null;
        
        const payload = {
          nome: chatCadastroState.data.nome,
          telefone: chatCadastroState.data.telefone,
          estado: estadoNormalizado,
          classeVeiculo: chatCadastroState.data.classeVeiculo,
          tipoVeiculo: chatCadastroState.data.tipoVeiculo,
          tipoCarroceria: chatCadastroState.data.tipoCarroceria,
          placaCavalo: null,
          placaCarreta1: null,
          placaCarreta2: null,
          placaCarreta3: null
        };
        
        console.log('📤 Enviando payload de cadastro via chat:', { ...payload, telefone: '***' });

        const response = await fetch('/api/motoristas/auth/profile', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${state.session.access_token}`
          },
          body: JSON.stringify(payload)
        });

        const result = await response.json();
        
        if (response.status === 409) {
          adicionarMensagemChat('Este telefone já está vinculado a outra conta. Entre em contato com o suporte.', 'bot', true);
          setChatWaiting(false);
          return;
        }

        if (!response.ok) {
          throw new Error(result.error || 'Não foi possível salvar seu cadastro');
        }

        // Atualizar state.motorista com os dados salvos
        state.motorista = result.motorista;
        atualizarCabecalho();
        
        // Recarregar dados do motorista do servidor para garantir sincronização
        try {
          const viagensResponse = await fetch('/api/motoristas/viagens', {
            headers: {
              Authorization: `Bearer ${state.session.access_token}`
            }
          });
          if (viagensResponse.ok) {
            const viagensResult = await viagensResponse.json();
            if (viagensResult.motorista) {
              state.motorista = viagensResult.motorista;
              atualizarCabecalho();
              console.log('✅ Dados do motorista recarregados após salvamento:', {
                ...state.motorista,
                estado: state.motorista.estado,
                estadoType: typeof state.motorista.estado,
                estadoValue: state.motorista.estado,
                temEstado: !!state.motorista.estado
              });
            }
          }
        } catch (reloadError) {
          console.warn('⚠️ Erro ao recarregar dados do motorista:', reloadError);
        }
        
        adicionarMensagemChat('✅ Cadastro básico concluído com sucesso!', 'bot');
        
        // Verificar se há documentos pendentes
        if (chatCadastroState.coletaId) {
          await verificarESolicitarDocumentos();
        } else {
          // Se havia uma coleta pendente, tentar assumir agora
          setTimeout(() => {
            fecharChatCadastro();
            if (coletaPendenteAposCadastro) {
              const coletaId = coletaPendenteAposCadastro;
              coletaPendenteAposCadastro = null;
              setTimeout(() => {
                prepararAssumirOportunidade(coletaId);
              }, 500);
            }
          }, 1500);
        }

      } catch (error) {
        console.error('Erro ao salvar cadastro:', error);
        adicionarMensagemChat('Erro ao salvar seus dados: ' + (error.message || 'Erro desconhecido'), 'bot', true);
        setChatWaiting(false);
      }
    }

    // ========== Funções para Chat de Documentos ==========
    async function verificarESolicitarDocumentos() {
      if (!chatCadastroState.coletaId) {
        // Se não tem coletaId, tentar usar a coleta pendente
        if (coletaPendenteAposCadastro) {
          chatCadastroState.coletaId = coletaPendenteAposCadastro;
        } else {
          return;
        }
      }
      
      // Aguardar um pouco para garantir que o servidor processou o salvamento
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Forçar recarregamento do status dos documentos
      const status = await carregarStatusDocumentos(true);
      console.log('🔍 Verificando documentos pendentes:', {
        status,
        categorias: status?.categorias,
        pendentes: REQUIRED_DOC_CATEGORIES.filter(cat => !(status?.categorias?.[cat]?.possui))
      });
      
      const pendentes = REQUIRED_DOC_CATEGORIES.filter(cat => !(status?.categorias?.[cat]?.possui));
      
      if (pendentes.length > 0) {
        chatCadastroState.documentosPendentes = pendentes;
        setTimeout(() => {
          iniciarChatDocumentos();
        }, 1000);
      } else {
        // Todos os documentos já foram enviados, finalizar
        adicionarMensagemChat('✅ Todos os documentos já foram enviados! Finalizando...', 'bot');
        setTimeout(() => {
          fecharChatCadastro();
          const coletaId = chatCadastroState.coletaId || coletaPendenteAposCadastro;
          if (coletaId) {
            prepararAssumirOportunidade(coletaId);
          }
        }, 2000);
      }
    }

    function iniciarChatDocumentos() {
      // Garantir que os elementos estejam inicializados
      if (!chatCadastroElements.overlay) {
        inicializarElementosChatCadastro();
      }
      
      // Abrir o chat se não estiver aberto
      if (chatCadastroElements.overlay) {
        chatCadastroElements.overlay.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }
      
      chatCadastroState.step = 'documentos';
      chatCadastroState.documentos = {
        arquivos: { proprietario: [], veiculo: [], motorista: [] },
        referenciasPessoais: [],
        referenciasComerciais: []
      };
      
      const oportunidade = state.oportunidades.find(op => op.id === chatCadastroState.coletaId) || null;
      const labelsPendentes = chatCadastroState.documentosPendentes.map(cat => DOCUMENT_CATEGORY_LABELS[cat] || 'Documentos');
      
      let mensagem = 'Agora preciso que você envie alguns documentos para validar sua viagem.\n\n';
      if (oportunidade) {
        mensagem += `**Viagem:**\n`;
        mensagem += `• Cliente: ${oportunidade.cliente || '—'}\n`;
        mensagem += `• Origem: ${oportunidade.origem || '—'}\n`;
        mensagem += `• Destino: ${oportunidade.destino || '—'}\n\n`;
      }
      mensagem += `**Documentos necessários:**\n${labelsPendentes.map(l => `• ${l}`).join('\n')}\n\n`;
      mensagem += 'Vou solicitar cada categoria de documentos. Clique no botão de anexo (📎) para enviar os arquivos.';
      
      adicionarMensagemChat(mensagem, 'bot');
      
      // Mostrar botão de anexo
      if (chatCadastroElements.fileBtn) {
        chatCadastroElements.fileBtn.style.display = 'flex';
      }
      
      // Iniciar solicitação do primeiro documento
      setTimeout(() => {
        solicitarProximoDocumento();
      }, 1000);
    }

    function solicitarProximoDocumento() {
      const pendentes = chatCadastroState.documentosPendentes;
      if (pendentes.length === 0) {
        // Todos os documentos foram coletados, solicitar referências
        // Ocultar upload
        if (chatCadastroElements.fileUpload) {
          chatCadastroElements.fileUpload.style.display = 'none';
        }
        if (chatCadastroElements.fileBtn) {
          chatCadastroElements.fileBtn.style.display = 'none';
        }
        solicitarReferencias();
        return;
      }
      
      const proximaCategoria = pendentes[0];
      const label = DOCUMENT_CATEGORY_LABELS[proximaCategoria] || 'Documentos';
      
      chatCadastroState.step = `documento_${proximaCategoria}`;
      
      // Limpar lista de arquivos anterior
      if (chatCadastroElements.fileList) {
        chatCadastroElements.fileList.innerHTML = '';
      }
      
      setTimeout(() => {
        adicionarMensagemChat(`Por favor, envie os **${label}**. Clique no botão de anexo (📎) para selecionar os arquivos.`, 'bot');
        if (chatCadastroElements.fileUpload) {
          chatCadastroElements.fileUpload.style.display = 'block';
        }
        if (chatCadastroElements.fileBtn) {
          chatCadastroElements.fileBtn.style.display = 'flex';
        }
        setChatWaiting(false);
      }, 500);
    }

    function solicitarReferencias() {
      chatCadastroState.step = 'referencias_pessoais';
      chatCadastroState.referenciaParcial = null; // Resetar referência parcial
      
      setTimeout(() => {
        adicionarMensagemChat('Preciso de **2 referências pessoais**.\n\nDigite dois nomes separados por vírgula ou "e".\n\nExemplo: João, Maria\nOu: João e Maria', 'bot');
        setChatWaiting(false);
      }, 500);
    }

    function atualizarListaArquivos() {
      if (!chatCadastroElements.fileList) return;
      
      chatCadastroElements.fileList.innerHTML = '';
      const categoriaAtual = chatCadastroState.step.replace('documento_', '');
      
      if (['proprietario', 'veiculo', 'motorista'].includes(categoriaAtual)) {
        const arquivos = chatCadastroState.documentos.arquivos[categoriaAtual] || [];
        arquivos.forEach((file, index) => {
          const item = document.createElement('div');
          item.className = 'chat-cadastro-file-item';
          item.innerHTML = `
            <span class="chat-cadastro-file-item-name">${escapeHtml(file.name)}</span>
            <button type="button" class="chat-cadastro-file-item-remove" onclick="removerArquivoChat('${categoriaAtual}', ${index})">
              <i class="fas fa-times"></i>
            </button>
          `;
          chatCadastroElements.fileList.appendChild(item);
        });
      }
    }

    function removerArquivoChat(categoria, index) {
      if (chatCadastroState.documentos.arquivos[categoria]) {
        chatCadastroState.documentos.arquivos[categoria].splice(index, 1);
        atualizarListaArquivos();
      }
    }

    // Event listeners do chat
    function registrarEventosChatCadastro() {
      inicializarElementosChatCadastro();
      
      if (chatCadastroElements.form) {
        chatCadastroElements.form.addEventListener('submit', (e) => {
          e.preventDefault();
          if (!chatCadastroState.isWaiting) {
            processarRespostaChat(chatCadastroElements.input.value);
          }
        });
      }

      if (chatCadastroElements.fileInput) {
        chatCadastroElements.fileInput.addEventListener('change', (e) => {
          const files = Array.from(e.target.files || []);
          const categoriaAtual = chatCadastroState.step.replace('documento_', '');
          
          if (['proprietario', 'veiculo', 'motorista'].includes(categoriaAtual)) {
            if (!chatCadastroState.documentos.arquivos[categoriaAtual]) {
              chatCadastroState.documentos.arquivos[categoriaAtual] = [];
            }
            chatCadastroState.documentos.arquivos[categoriaAtual].push(...files);
            atualizarListaArquivos();
            
            const label = DOCUMENT_CATEGORY_LABELS[categoriaAtual] || 'Documentos';
            const totalArquivos = chatCadastroState.documentos.arquivos[categoriaAtual].length;
            adicionarMensagemChat(`✅ ${files.length} arquivo(s) adicionado(s) para ${label}. Total: ${totalArquivos} arquivo(s).`, 'bot');
            
            // Mostrar opção para continuar
            definirOpcoesChat([
              { label: 'Adicionar mais arquivos', value: 'adicionar_mais' },
              { label: 'Continuar', value: 'continuar_documentos' }
            ]);
            
            // Limpar input
            e.target.value = '';
          }
        });
      }

      if (chatCadastroElements.fileBtn) {
        chatCadastroElements.fileBtn.addEventListener('click', () => {
          if (chatCadastroElements.fileInput) {
            chatCadastroElements.fileInput.click();
          }
        });
      }

      if (chatCadastroElements.closeBtn) {
        chatCadastroElements.closeBtn.addEventListener('click', fecharChatCadastro);
      }

      if (chatCadastroElements.overlay) {
        chatCadastroElements.overlay.addEventListener('click', (e) => {
          if (e.target === chatCadastroElements.overlay) {
            fecharChatCadastro();
          }
        });
      }
    }
    
    async function enviarDocumentosViaChat() {
      try {
        setChatWaiting(true);
        const coletaId = chatCadastroState.coletaId;
        
        if (!coletaId) {
          throw new Error('Coleta não identificada');
        }

        const formData = new FormData();
        
        // Adicionar arquivos
        ['proprietario', 'veiculo', 'motorista'].forEach(categoria => {
          const arquivos = chatCadastroState.documentos.arquivos[categoria] || [];
          arquivos.forEach(file => {
            formData.append('arquivos', file);
            formData.append('categorias[]', categoria);
          });
        });

        // Adicionar referências
        formData.append('referencias_pessoais', JSON.stringify(chatCadastroState.documentos.referenciasPessoais));
        formData.append('referencias_comerciais', JSON.stringify(chatCadastroState.documentos.referenciasComerciais));

        const response = await fetch(`/api/motoristas/coletas/${encodeURIComponent(coletaId)}/documentos`, {
          method: 'POST',
          headers: {
            Authorization: `Bearer ${state.session.access_token}`
          },
          body: formData
        });

        const result = await response.json();
        if (!response.ok) {
          throw new Error(result.error || 'Não foi possível enviar os documentos agora.');
        }

        adicionarMensagemChat('✅ Documentos enviados com sucesso! A equipe recebeu sua viagem para validação.', 'bot');
        
        // Recarregar status dos documentos para garantir sincronização
        try {
          await carregarStatusDocumentos(true);
          console.log('✅ Status dos documentos recarregado após envio');
        } catch (reloadError) {
          console.warn('⚠️ Erro ao recarregar status dos documentos:', reloadError);
        }
        
        setTimeout(() => {
          fecharChatCadastro();
          // Tentar assumir a coleta
          if (coletaId) {
            prepararAssumirOportunidade(coletaId);
          }
        }, 2000);

      } catch (error) {
        console.error('Erro ao enviar documentos:', error);
        adicionarMensagemChat('Erro ao enviar documentos: ' + (error.message || 'Erro desconhecido'), 'bot', true);
        setChatWaiting(false);
      }
    }

    // Tornar função global para onclick
    window.removerArquivoChat = removerArquivoChat;

    document.addEventListener('DOMContentLoaded', () => {
      inicializarElementosChatCadastro();
      registrarEventosChatCadastro();
      initPortal();
    });
    </script>
<!-- Chat IA -->
<link rel="stylesheet" href="css/chat-ia.css">
<script src="js/chat-ia.js"></script>
</body>
</html>

