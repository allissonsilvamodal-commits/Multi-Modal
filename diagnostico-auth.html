<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagnóstico de Autenticação - Multimodal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }
        .diagnostic-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .test-result {
            padding: 1rem;
            border-radius: 10px;
            margin: 0.5rem 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .success { background: rgba(40, 167, 69, 0.2); color: #28a745; }
        .error { background: rgba(220, 53, 69, 0.2); color: #dc3545; }
        .warning { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
        .info { background: rgba(13, 202, 240, 0.2); color: #0dcaf0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="diagnostic-card p-4">
                    <h1 class="text-center text-white mb-4">
                        <i class="fas fa-stethoscope me-2"></i>Diagnóstico de Autenticação
                    </h1>
                    
                    <div id="diagnosticResults"></div>
                    
                    <div class="text-center mt-4">
                        <button class="btn btn-primary btn-lg" onclick="executarDiagnostico()">
                            <i class="fas fa-play me-2"></i>Executar Diagnóstico
                        </button>
                        <button class="btn btn-success btn-lg ms-2" onclick="corrigirProblemas()">
                            <i class="fas fa-wrench me-2"></i>Corrigir Problemas
                        </button>
                        <button class="btn btn-warning btn-lg ms-2" onclick="limparRateLimit()">
                            <i class="fas fa-broom me-2"></i>Limpar Rate Limit
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let supabase = null;
        
        async function executarDiagnostico() {
            const resultsDiv = document.getElementById('diagnosticResults');
            resultsDiv.innerHTML = '<div class="text-center text-white"><i class="fas fa-spinner fa-spin"></i> Executando diagnóstico...</div>';
            
            const testes = [
                { nome: 'Verificar localStorage', funcao: testarLocalStorage },
                { nome: 'Verificar Supabase Config', funcao: testarSupabaseConfig },
                { nome: 'Inicializar Supabase', funcao: testarInicializacaoSupabase },
                { nome: 'Verificar Autenticação Supabase', funcao: testarAuthSupabase },
                { nome: 'Verificar Endpoints', funcao: testarEndpoints },
                { nome: 'Testar Portal', funcao: testarPortal },
                { nome: 'Testar Painel', funcao: testarPainel },
                { nome: 'Testar Coletas', funcao: testarColetas }
            ];
            
            let resultados = [];
            
            for (const teste of testes) {
                try {
                    const resultado = await teste.funcao();
                    resultados.push({ ...teste, resultado, sucesso: true });
                } catch (error) {
                    resultados.push({ ...teste, resultado: error.message, sucesso: false });
                }
            }
            
            mostrarResultados(resultados);
        }
        
        function mostrarResultados(resultados) {
            const resultsDiv = document.getElementById('diagnosticResults');
            let html = '<h3 class="text-white"><i class="fas fa-clipboard-list me-2"></i>Resultados do Diagnóstico</h3>';
            
            resultados.forEach(teste => {
                const classe = teste.sucesso ? 'success' : 'error';
                const icone = teste.sucesso ? 'check-circle' : 'exclamation-circle';
                
                html += `
                    <div class="test-result ${classe}">
                        <i class="fas fa-${icone} me-2"></i>
                        <strong>${teste.nome}:</strong> ${teste.resultado}
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        function testarLocalStorage() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            const lastActivity = localStorage.getItem('lastActivity');
            
            if (loggedInUser && lastActivity) {
                const userData = JSON.parse(loggedInUser);
                const timeDiff = Date.now() - parseInt(lastActivity);
                const hoursDiff = timeDiff / (1000 * 60 * 60);
                
                if (hoursDiff < 12) {
                    return `✅ Usuário logado: ${userData.username || userData.email} (${hoursDiff.toFixed(1)}h atrás)`;
                } else {
                    return `⚠️ Sessão expirada há ${hoursDiff.toFixed(1)} horas`;
                }
            } else {
                return '❌ Nenhum usuário logado no localStorage';
            }
        }
        
        async function testarSupabaseConfig() {
            try {
                const response = await fetch('/api/supabase-config');
                const config = await response.json();
                
                if (config.supabaseUrl && config.supabaseAnonKey) {
                    return `✅ Supabase configurado: ${config.supabaseUrl}`;
                } else {
                    return '❌ Configuração do Supabase incompleta';
                }
            } catch (error) {
                return `❌ Erro ao acessar configuração: ${error.message}`;
            }
        }
        
        async function testarInicializacaoSupabase() {
            try {
                const response = await fetch('/api/supabase-config');
                const config = await response.json();
                
                if (!config.supabaseUrl || !config.supabaseAnonKey) {
                    throw new Error('Configuração incompleta');
                }
                
                supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseAnonKey);
                
                if (supabase) {
                    return '✅ Supabase inicializado com sucesso';
                } else {
                    return '❌ Falha na inicialização do Supabase';
                }
            } catch (error) {
                return `❌ Erro na inicialização: ${error.message}`;
            }
        }
        
        async function testarAuthSupabase() {
            try {
                if (!supabase) {
                    throw new Error('Supabase não inicializado');
                }
                
                const { data: { session }, error } = await supabase.auth.getSession();
                
                if (error) {
                    return `⚠️ Erro na sessão: ${error.message}`;
                }
                
                if (session && session.user) {
                    return `✅ Sessão ativa: ${session.user.email}`;
                } else {
                    return '⚠️ Nenhuma sessão ativa no Supabase';
                }
            } catch (error) {
                return `❌ Erro na autenticação: ${error.message}`;
            }
        }
        
        async function testarEndpoints() {
            try {
                const response = await fetch('/api/check-auth');
                const data = await response.json();
                
                if (data.authenticated) {
                    return `✅ Endpoint funcionando: ${data.user}`;
                } else {
                    return '⚠️ Endpoint OK, mas usuário não autenticado';
                }
            } catch (error) {
                return `❌ Erro no endpoint: ${error.message}`;
            }
        }
        
        function testarPortal() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (loggedInUser) {
                return '✅ Portal acessível - usuário logado';
            } else {
                return '⚠️ Portal requer login';
            }
        }
        
        function testarPainel() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (loggedInUser) {
                return '✅ Painel acessível - usuário logado';
            } else {
                return '⚠️ Painel requer login';
            }
        }
        
        function testarColetas() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (loggedInUser) {
                return '✅ Coletas acessível - usuário logado';
            } else {
                return '⚠️ Coletas requer login';
            }
        }
        
        function corrigirProblemas() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            
            if (!loggedInUser) {
                alert('⚠️ Faça login primeiro para corrigir os problemas');
                window.location.href = 'login.html';
                return;
            }
            
            // Limpar cache e recarregar
            localStorage.removeItem('lastActivity');
            localStorage.setItem('lastActivity', Date.now().toString());
            
            alert('✅ Problemas corrigidos! Recarregando página...');
            window.location.reload();
        }
        
        async function limparRateLimit() {
            try {
                const response = await fetch('/api/clear-rate-limit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('✅ Rate limiting limpo com sucesso!\n\nAgora você pode tentar acessar o sistema novamente.');
                } else {
                    alert('❌ Erro ao limpar rate limiting: ' + data.error);
                }
            } catch (error) {
                alert('❌ Erro ao limpar rate limiting: ' + error.message);
            }
        }
        
        // Executar diagnóstico automaticamente
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(executarDiagnostico, 1000);
        });
    </script>
</body>
</html>
