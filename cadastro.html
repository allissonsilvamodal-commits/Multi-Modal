<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cadastro de Motoristas - Sistema de Disparo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- ADICIONAR CDN DO SUPABASE -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/permissions.js"></script>
  <style>
    :root {
      --primary: #667eea;
      --primary-dark: #5a6fd8;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
      --dark: #1f2937;
      --light: #f8fafc;
    }
    
    body { 
      padding: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
    }
    
    .app-container {
      background: white;
      min-height: 100vh;
      border-radius: 0;
      box-shadow: 0 0 50px rgba(0,0,0,0.1);
    }
    
    /* Header Moderno */
    .app-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 1.25rem 0;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      backdrop-filter: blur(10px);
    }
    
    .user-badge {
      background: rgba(255,255,255,0.2);
      padding: 8px 16px;
      border-radius: 25px;
      font-size: 0.9rem;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    /* Cards Modernos */
    .modern-card {
      background: white;
      border: none;
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.03);
    }
    
    .modern-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.12);
    }
    
    .modern-card .card-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border: none;
      padding: 1.5rem 2rem;
      font-weight: 700;
      font-size: 1.1rem;
    }
    
    /* Status Cards */
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .status-card {
      background: white;
      padding: 2rem;
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
      text-align: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(0,0,0,0.03);
      position: relative;
      overflow: hidden;
    }
    
    .status-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--success));
    }
    
    .status-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }
    
    .status-icon {
      width: 70px;
      height: 70px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.5rem;
      font-size: 2rem;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    
    .status-icon.primary {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      color: var(--primary);
    }
    
    .status-icon.success {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      color: var(--success);
    }
    
    .status-icon.warning {
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
      color: var(--warning);
    }
    
    .status-icon.danger {
      background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
      color: var(--danger);
    }
    
    .status-number {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, var(--primary), var(--success));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .status-label {
      color: #64748b;
      font-size: 1rem;
      font-weight: 600;
    }
    
    /* Classes de Ve√≠culo */
    .vehicle-classes {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .vehicle-class {
      background: var(--light);
      border: 2px solid #e2e8f0;
      border-radius: 16px;
      padding: 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .vehicle-class::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      transition: left 0.5s;
    }
    
    .vehicle-class:hover::before {
      left: 100%;
    }
    
    .vehicle-class:hover {
      transform: translateY(-5px);
      border-color: var(--primary);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.15);
    }
    
    .vehicle-class.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border-color: var(--primary);
      transform: scale(1.05);
    }
    
    .vehicle-class.active .class-icon {
      color: white;
    }
    
    .class-icon {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      color: var(--primary);
      transition: all 0.3s ease;
    }
    
    .class-name {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }
    
    .class-description {
      font-size: 0.85rem;
      opacity: 0.8;
    }
    
    /* Formul√°rio Moderno */
    .form-section {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.03);
    }
    
    .section-title {
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.2rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid #f1f5f9;
    }
    
    .section-title i {
      color: var(--primary);
      font-size: 1.3rem;
    }
    
    .form-control-modern, .form-select-modern {
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 1rem 1.25rem;
      font-size: 1rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: white;
    }
    
    .form-control-modern:focus, .form-select-modern:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      transform: translateY(-2px);
    }
    
    .form-label-modern {
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 0.75rem;
      font-size: 0.95rem;
    }
    
    /* Bot√µes Modernos */
    .btn-modern {
      border: none;
      border-radius: 14px;
      padding: 1rem 2rem;
      font-weight: 700;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      font-size: 1rem;
    }
    
    .btn-modern::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.6s;
    }
    
    .btn-modern:hover::before {
      left: 100%;
    }
    
    .btn-modern:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    
    .btn-modern-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
    }
    
    .btn-modern-success {
      background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
      color: white;
    }
    
    .btn-modern-danger {
      background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
      color: white;
    }
    
    .btn-modern-warning {
      background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
      color: white;
    }
    
    .btn-modern-info {
      background: linear-gradient(135deg, var(--info) 0%, #2563eb 100%);
      color: white;
    }
    
    /* Tabela Moderna */
    .table-modern {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.03);
    }
    
    .table-modern thead th {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-bottom: 2px solid #e2e8f0;
      font-weight: 700;
      padding: 1.25rem 1.5rem;
      color: var(--dark);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .table-modern tbody td {
      padding: 1.25rem 1.5rem;
      vertical-align: middle;
      border-bottom: 1px solid #f1f5f9;
      transition: background-color 0.2s ease;
    }
    
    .table-modern tbody tr:hover td {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }
    
    .table-modern tbody tr:last-child td {
      border-bottom: none;
    }
    
    /* Badges Modernos */
    .badge-modern {
      padding: 0.5rem 1rem;
      border-radius: 10px;
      font-size: 0.8rem;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .badge-vehicle {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      color: var(--info);
      border: 1px solid #bfdbfe;
    }
    
    .badge-bodywork {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      color: var(--success);
      border: 1px solid #bbf7d0;
    }
    
    .badge-state {
      background: linear-gradient(135deg, #fafafa 0%, #f4f4f5 100%);
      color: #64748b;
      border: 1px solid #e4e4e7;
    }
    
    .badge-status {
      padding: 0.4rem 0.8rem;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .badge-ativo {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      color: var(--success);
      border: 1px solid #bbf7d0;
    }
    
    .badge-inativo {
      background: linear-gradient(135deg, #fafafa 0%, #f4f4f5 100%);
      color: #64748b;
      border: 1px solid #e4e4e7;
    }
    
    .badge-bloqueado {
      background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
      color: var(--danger);
      border: 1px solid #fca5a5;
    }
    
    /* A√ß√µes */
    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }
    
    .btn-action {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }
    
    .btn-edit {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      color: var(--info);
      border: 1px solid #bfdbfe;
    }
    
    .btn-edit:hover {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      transform: translateY(-2px);
    }
    
    .btn-delete {
      background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
      color: var(--danger);
      border: 1px solid #fca5a5;
    }
    
    .btn-delete:hover {
      background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
      transform: translateY(-2px);
    }
    
    /* Upload Moderno */
    .upload-area {
      border: 2px dashed #cbd5e1;
      border-radius: 16px;
      padding: 3rem 2rem;
      text-align: center;
      transition: all 0.3s ease;
      background: #f8fafc;
      cursor: pointer;
    }
    
    .upload-area:hover {
      border-color: var(--primary);
      background: rgba(102, 126, 234, 0.05);
    }
    
    .upload-area.dragover {
      border-color: var(--success);
      background: rgba(16, 185, 129, 0.05);
    }
    
    .upload-icon {
      font-size: 3rem;
      color: #cbd5e1;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
    }
    
    .upload-area:hover .upload-icon {
      color: var(--primary);
    }
    
    /* Anima√ß√µes */
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    /* Alertas Flutuantes */
    .alert-floating {
      position: fixed !important;
      top: 100px;
      right: 20px;
      z-index: 9999;
      min-width: 300px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      border-radius: 12px;
      border: none;
    }
    
    /* Sistema de Tabs Customizado */
    .tab-content {
      position: relative;
    }
    
    .tab-pane {
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
    }
    
    .tab-pane.active {
      display: block;
      opacity: 1;
    }
    
    /* Navega√ß√£o Moderna */
    .modern-tabs {
      background: white;
      border-radius: 16px;
      padding: 1rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.03);
    }
    
    .nav-modern {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .nav-modern .nav-link {
      background: var(--light);
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 1rem 1.5rem;
      color: #64748b;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
    }
    
    .nav-modern .nav-link:hover {
      border-color: var(--primary);
      background: rgba(102, 126, 234, 0.05);
      transform: translateY(-2px);
    }
    
    .nav-modern .nav-link.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border-color: var(--primary);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
    }
    
    /* Responsivo */
    @media (max-width: 768px) {
      .app-header {
        padding: 1rem 0;
      }
      
      .vehicle-classes {
        grid-template-columns: 1fr;
      }
      
      .status-grid {
        grid-template-columns: 1fr;
      }
      
      .action-buttons {
        flex-direction: column;
        gap: 0.25rem;
      }
      
      .btn-action {
        width: 100%;
      }
      
      .alert-floating {
        left: 20px;
        right: 20px;
        min-width: auto;
      }
      
      .nav-modern {
        flex-direction: column;
      }
      
      .nav-modern .nav-link {
        justify-content: center;
        text-align: center;
      }
    }
  </style>
</head>
<body>

<div class="app-container">
  <!-- Header Moderno -->
  <header class="app-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col">
          <div class="d-flex align-items-center gap-3">
            <div class="bg-white rounded-3 p-2 shadow-lg">
              <i class="fas fa-database text-primary fs-4"></i>
            </div>
            <div>
              <h1 class="h3 mb-0 fw-bold">Cadastro de Motoristas</h1>
              <div class="user-badge">
                <i class="fas fa-user me-1"></i>
                <span id="currentUser">Carregando...</span>
                <span class="badge bg-light text-dark ms-2">ADMIN</span>
              </div>
            </div>
          </div>
        </div>
        <div class="col-auto">
          <div class="d-flex gap-2">
            <a href="portal.html" class="btn btn-outline-light btn-sm" id="btnVoltarPortal">
              <i class="fas fa-home me-1"></i> Voltar ao Portal
            </a>
            <button id="btnLogout" class="btn btn-outline-light btn-sm">
              <i class="fas fa-sign-out-alt me-1"></i> Sair
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Conte√∫do Principal -->
  <main class="container py-4">
    
    <!-- Status R√°pido -->
    <div class="status-grid">
      <div class="status-card">
        <div class="status-icon primary">
          <i class="fas fa-users"></i>
        </div>
        <div class="status-number" id="totalContatos">0</div>
        <div class="status-label">Total Cadastrados</div>
      </div>
      <div class="status-card">
        <div class="status-icon success">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="status-number" id="contatosAtivos">0</div>
        <div class="status-label">Ativos</div>
      </div>
      <div class="status-card">
        <div class="status-icon warning">
          <i class="fas fa-user-slash"></i>
        </div>
        <div class="status-number" id="contatosInativos">0</div>
        <div class="status-label">Inativos</div>
      </div>
      <div class="status-card">
        <div class="status-icon danger">
          <i class="fas fa-ban"></i>
        </div>
        <div class="status-number" id="contatosBloqueados">0</div>
        <div class="status-label">Bloqueados</div>
      </div>
    </div>

    <!-- Cards de Carrocerias -->
    <div class="mt-4 mb-4">
      <h5 class="mb-3 fw-bold text-dark">
        <i class="fas fa-truck me-2"></i>Quantidade por Carroceria
      </h5>
      <div class="status-grid" id="carroceriasGrid">
        <!-- Cards ser√£o gerados dinamicamente via JavaScript -->
      </div>
    </div>

    <!-- Navega√ß√£o Moderna -->
    <div class="modern-tabs">
      <nav class="nav-modern">
        <a class="nav-link active" data-tab="cadastro">
          <i class="fas fa-user-plus"></i>
          Cadastro Individual
        </a>
        <a class="nav-link" data-tab="importacao">
          <i class="fas fa-file-import"></i>
          Importa√ß√£o em Lote
        </a>
        <a class="nav-link" data-tab="gestao">
          <i class="fas fa-users"></i>
          Gest√£o de Contatos
        </a>
        <a class="nav-link" data-tab="backup">
          <i class="fas fa-shield-alt"></i>
          Backup & Reset
        </a>
      </nav>
    </div>

    <!-- Conte√∫do das Abas -->
    <div class="tab-content">
      
      <!-- Aba: Cadastro Individual -->
      <div class="tab-pane active" id="cadastro">
        <div class="modern-card">
          <div class="card-header">
            <i class="fas fa-user-plus me-2"></i>Cadastrar Novo Motorista
          </div>
          <div class="card-body">
            <form id="formCadastro">
              
              <!-- Informa√ß√µes Pessoais -->
              <div class="form-section">
                <div class="section-title">
                  <i class="fas fa-id-card"></i>
                  Informa√ß√µes Pessoais
                </div>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label-modern">Nome Completo *</label>
                    <input type="text" id="nome" class="form-control form-control-modern" required placeholder="Digite o nome completo">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label-modern">CNH</label>
                    <input type="text" id="cnh" class="form-control form-control-modern" placeholder="N√∫mero da CNH">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label-modern">Categoria CNH</label>
                    <select id="categoria_cnh" class="form-select form-select-modern">
                      <option value="">Selecione</option>
                      <option value="A">A - Motos</option>
                      <option value="B">B - Carros</option>
                      <option value="C">C - Caminh√µes</option>
                      <option value="D">D - √înibus</option>
                      <option value="E">E - Carreta</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Contatos -->
              <div class="form-section">
                <div class="section-title">
                  <i class="fas fa-phone"></i>
                  Contatos
                </div>
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label-modern">Telefone 1 *</label>
                    <input type="text" id="telefone1" class="form-control form-control-modern" required placeholder="5511999999999">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label-modern">Telefone 2</label>
                    <input type="text" id="telefone2" class="form-control form-control-modern" placeholder="5511888888888">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label-modern">Estado (DDD)</label>
                    <select id="estado" class="form-select form-select-modern">
                      <option value="">Selecione o estado</option>
                      <option value="SP">S√£o Paulo</option>
                      <option value="RJ">Rio de Janeiro</option>
                      <option value="MG">Minas Gerais</option>
                      <option value="ES">Esp√≠rito Santo</option>
                      <option value="PR">Paran√°</option>
                      <option value="SC">Santa Catarina</option>
                      <option value="RS">Rio Grande do Sul</option>
                      <option value="MS">Mato Grosso do Sul</option>
                      <option value="MT">Mato Grosso</option>
                      <option value="GO">Goi√°s</option>
                      <option value="DF">Distrito Federal</option>
                      <option value="BA">Bahia</option>
                      <option value="SE">Sergipe</option>
                      <option value="AL">Alagoas</option>
                      <option value="PE">Pernambuco</option>
                      <option value="PB">Para√≠ba</option>
                      <option value="RN">Rio Grande do Norte</option>
                      <option value="CE">Cear√°</option>
                      <option value="PI">Piau√≠</option>
                      <option value="MA">Maranh√£o</option>
                      <option value="PA">Par√°</option>
                      <option value="AP">Amap√°</option>
                      <option value="AM">Amazonas</option>
                      <option value="RR">Roraima</option>
                      <option value="AC">Acre</option>
                      <option value="RO">Rond√¥nia</option>
                      <option value="TO">Tocantins</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Ve√≠culo - Sistema Inteligente -->
              <div class="form-section">
                <div class="section-title">
                  <i class="fas fa-truck"></i>
                  Ve√≠culo
                </div>
                
                <!-- Classes de Ve√≠culo -->
                <div class="vehicle-classes" id="vehicleClassesCadastro">
                  <div class="vehicle-class" data-class="leve">
                    <div class="class-icon">
                      <i class="fas fa-truck-pickup"></i>
                    </div>
                    <div class="class-name">Leves</div>
                    <div class="class-description">Fiorino, 3/4, Toco, VLC</div>
                  </div>
                  <div class="vehicle-class" data-class="medio">
                    <div class="class-icon">
                      <i class="fas fa-truck"></i>
                    </div>
                    <div class="class-name">M√©dios</div>
                    <div class="class-description">Bitruck, Truck</div>
                  </div>
                  <div class="vehicle-class" data-class="pesado">
                    <div class="class-icon">
                      <i class="fas fa-truck-moving"></i>
                    </div>
                    <div class="class-name">Pesados</div>
                    <div class="class-description">Bitrem, Carreta, Rodotrem</div>
                  </div>
                </div>

                <!-- Tipos de Ve√≠culo e Carroceria (Din√¢micos) -->
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label-modern">Tipo de Ve√≠culo *</label>
                    <select id="tipo_veiculo" class="form-select form-select-modern" required disabled>
                      <option value="">Selecione a classe do ve√≠culo primeiro</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label-modern">Tipo de Carroceria *</label>
                    <select id="tipo_carroceria" class="form-select form-select-modern" required disabled>
                      <option value="">Selecione a classe do ve√≠culo primeiro</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Placas -->
              <div class="form-section">
                <div class="section-title">
                  <i class="fas fa-id-card-alt"></i>
                  Placas
                </div>
                <div class="row g-3">
                  <div class="col-md-3">
                    <label class="form-label-modern">Placa do Cavalo</label>
                    <input type="text" id="placa_cavalo" class="form-control form-control-modern" placeholder="ABC1D23">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label-modern">Placa da Carreta 1</label>
                    <input type="text" id="placa_carreta1" class="form-control form-control-modern" placeholder="XYZ4W56">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label-modern">Placa da Carreta 2</label>
                    <input type="text" id="placa_carreta2" class="form-control form-control-modern" placeholder="QRS7T89">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label-modern">Placa da Carreta 3</label>
                    <input type="text" id="placa_carreta3" class="form-control form-control-modern" placeholder="LMN8P10">
                  </div>
                </div>
              </div>

              <!-- Configura√ß√£o do Sistema -->
              <div class="form-section">
                <div class="section-title">
                  <i class="fas fa-cog"></i>
                  Configura√ß√£o do Sistema
                </div>
                <div class="row g-3">
                  <div class="col-md-12">
                    <label class="form-label-modern">Status</label>
                    <select id="status" class="form-select form-select-modern">
                      <option value="ativo">Ativo</option>
                      <option value="inativo">Inativo</option>
                      <option value="bloqueado">Bloqueado</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- A√ß√µes do Formul√°rio -->
              <div class="d-flex gap-3 justify-content-end mt-4">
                <button type="button" class="btn btn-modern btn-modern-warning" id="btnLimpar">
                  <i class="fas fa-broom me-2"></i>Limpar
                </button>
                <button type="submit" class="btn btn-modern btn-modern-success">
                  <i class="fas fa-save me-2"></i>Cadastrar Motorista
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Aba: Importa√ß√£o em Lote -->
      <div class="tab-pane" id="importacao">
        <div class="row">
          <div class="col-md-6">
            <div class="modern-card h-100">
              <div class="card-header">
                <i class="fas fa-file-import me-2"></i>Importar do CSV
              </div>
              <div class="card-body">
                <div class="upload-area" id="uploadArea">
                  <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                  </div>
                  <h5 class="fw-bold mb-2">Arraste ou clique para upload</h5>
                  <p class="text-muted mb-3">Suporte para arquivos CSV</p>
                  <input type="file" id="csvFile" class="d-none" accept=".csv">
                  <button class="btn btn-modern btn-modern-primary" id="btnSelecionarArquivo">
                    <i class="fas fa-folder-open me-2"></i>Selecionar Arquivo
                  </button>
                </div>
                
                <div class="mt-4">
                  <label class="form-label-modern">Op√ß√µes de Importa√ß√£o</label>
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="sobrescrever" checked>
                    <label class="form-check-label" for="sobrescrever">
                      Sobrescrever contatos duplicados
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="manter_inativos">
                    <label class="form-check-label" for="manter_inativos">
                      Manter contatos inativos existentes
                    </label>
                  </div>
                </div>
                
                <button class="btn btn-modern btn-modern-success w-100 mt-4" id="btnImportarCSV">
                  <i class="fas fa-upload me-2"></i>Importar CSV
                </button>
                
                <div class="mt-3 text-center">
                  <a href="#" class="btn btn-link text-decoration-none" id="btnTemplateCSV">
                    <i class="fas fa-download me-1"></i>Baixar Template CSV
                  </a>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="modern-card h-100">
              <div class="card-header">
                <i class="fas fa-sync me-2"></i>Importa√ß√£o Autom√°tica
              </div>
              <div class="card-body">
                <p class="card-text">Importa√ß√£o autom√°tica do arquivo <code>contatos.csv</code> do servidor.</p>
                
                <div class="mb-4">
                  <label class="form-label-modern">Arquivo Atual</label>
                  <div class="input-group">
                    <input type="text" class="form-control form-control-modern" value="contatos.csv" readonly>
                    <button class="btn btn-modern btn-modern-info" type="button" id="btnVerificarCSV">
                      <i class="fas fa-search"></i>
                    </button>
                  </div>
                </div>
                
                <button class="btn btn-modern btn-modern-info w-100 mb-3" id="btnImportarAuto">
                  <i class="fas fa-sync me-2"></i>Importar do Arquivo Padr√£o
                </button>
                
                <div id="statusImportacao" class="mt-3"></div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="modern-card mt-4">
          <div class="card-header">
            <i class="fas fa-history me-2"></i>Hist√≥rico de Importa√ß√£o
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-modern">
                <thead>
                  <tr>
                    <th>Data/Hora</th>
                    <th>Arquivo</th>
                    <th>Registros</th>
                    <th>Inseridos</th>
                    <th>Atualizados</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="historicoImportacao">
                  <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                      <i class="fas fa-history fa-2x mb-3 d-block"></i>
                      Nenhum hist√≥rico de importa√ß√£o
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Aba: Gest√£o de Contatos -->
      <div class="tab-pane" id="gestao">
        <div class="modern-card">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="fas fa-users me-2"></i>Gest√£o de Motoristas Cadastrados</span>
            <div class="d-flex gap-2">
              <button class="btn btn-modern btn-modern-success btn-sm" id="btnExportar">
                <i class="fas fa-download me-1"></i>Exportar
              </button>
              <button class="btn btn-modern btn-modern-primary btn-sm" id="btnAtualizar">
                <i class="fas fa-sync me-1"></i>Atualizar
              </button>
            </div>
          </div>
          <div class="card-body">
            
            <!-- Filtros R√°pidos Modernos -->
            <div class="row g-3 mb-4">
              <div class="col-md-3">
                <label class="form-label-modern">Classe do Ve√≠culo</label>
                <select id="filtroClasse" class="form-select form-select-modern">
                  <option value="">Todas as classes</option>
                  <option value="leve">Leve</option>
                  <option value="medio">M√©dio</option>
                  <option value="pesado">Pesado</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label-modern">Estado</label>
                <select id="filtroEstado" class="form-select form-select-modern">
                  <option value="">Todos os estados</option>
                  <!-- Estados ser√£o carregados via JavaScript -->
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label-modern">Status</label>
                <select id="filtroStatus" class="form-select form-select-modern">
                  <option value="">Todos os status</option>
                  <option value="ativo">Ativo</option>
                  <option value="inativo">Inativo</option>
                  <option value="bloqueado">Bloqueado</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label-modern">Buscar</label>
                <div class="input-group">
                  <input type="text" id="filtroBusca" class="form-control form-control-modern" placeholder="Nome, telefone...">
                  <button class="btn btn-modern btn-modern-primary" type="button" id="btnBuscar">
                    <i class="fas fa-search"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Cards de Estat√≠sticas R√°pidas -->
            <div class="row g-3 mb-4" id="cardsEstatisticas">
              <!-- Ser√° preenchido via JavaScript -->
            </div>

            <!-- Tabela de Contatos Moderna -->
            <div class="table-responsive">
              <table class="table table-modern table-hover">
                <thead>
                  <tr>
                    <th width="200">Motorista</th>
                    <th width="120">Contato</th>
                    <th width="100">Ve√≠culo</th>
                    <th width="120">Localiza√ß√£o</th>
                    <th width="80">Status</th>
                    <th width="100" class="text-center">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="tabelaContatos">
                  <tr>
                    <td colspan="6" class="text-center text-muted py-5">
                      <i class="fas fa-users fa-3x mb-3 d-block"></i>
                      <h5 class="fw-bold">Nenhum motorista cadastrado</h5>
                      <p class="text-muted">Comece cadastrando um novo motorista</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Pagina√ß√£o e Info -->
            <div class="d-flex justify-content-between align-items-center mt-4">
              <div class="text-muted small" id="infoPaginacao">
                Mostrando 0 de 0 registros
              </div>
              <nav aria-label="Navega√ß√£o de p√°ginas">
                <ul class="pagination pagination-sm" id="paginacao">
                  <!-- Pagina√ß√£o ser√° gerada via JavaScript -->
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>

      <!-- Aba: Backup & Reset -->
      <div class="tab-pane" id="backup">
        <div class="row">
              </div>
      </div>
    </div>
  </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ========== CONFIGURA√á√ïES GLOBAIS ==========
const SERVER_URL = window.location.origin;
let todosContatos = [];
let contatosFiltrados = [];
let currentPage = 1;
const pageSize = 20;

// Mapeamentos inteligentes
const tiposVeiculo = {
  leve: ['3/4', 'Fiorino', 'Toco', 'VLC'],
  medio: ['Bitruck', 'Truck'],
  pesado: ['Bitrem', 'Carreta', 'Carreta LS', 'Rodotrem', 'Vanderleia']
};

const bodyworkByClass = {
  leve: ['bau', 'bau_frigorifico', 'bau_refrigerado', 'cacamba', 'prancha'],
  medio: ['bau', 'bau_frigorifico', 'sider', 'graneleiro', 'plataforma', 'basculante'],
  pesado: ['bau', 'sider', 'graneleiro', 'grade_baixa', 'bitrem', 'carreta', 'carreta_ls', 'rodotrem', 'vanderleia', 'apenas_cavalo', 'cegonheiro', 'gaiola', 'tanque', 'porta_container_20', 'porta_container_40', 'basculante']
};

const tiposCarroceriaMap = {
  bau: 'Ba√∫',
  bau_frigorifico: 'Ba√∫ Frigor√≠fico',
  bau_refrigerado: 'Ba√∫ Refrigerado',
  sider: 'Sider',
  cacamba: 'Ca√ßamba',
  graneleiro: 'Graneleiro',
  plataforma: 'Plataforma',
  prancha: 'Prancha',
  bitrem: 'Bitrem',
  carreta: 'Carreta',
  carreta_ls: 'Carreta LS',
  rodotrem: 'Rodotrem',
  vanderleia: 'Vanderleia',
  apenas_cavalo: 'Apenas Cavalo',
  cegonheiro: 'Cegonheiro',
  gaiola: 'Gaiola',
  tanque: 'Tanque',
  grade_baixa: 'GRADE BAIXA',
  basculante: 'BASCULANTE',
  porta_container_20: 'PORTA CONTAINER 20',
  porta_container_40: 'PORTA CONTAINER 40'
};

const estados = [
  'AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA', 
  'MT', 'MS', 'MG', 'PA', 'PB', 'PR', 'PE', 'PI', 'RJ', 'RN', 
  'RS', 'RO', 'RR', 'SC', 'SP', 'SE', 'TO'
];

// ========== SUPABASE CONFIGURATION ==========
let SUPABASE_URL = '';
let SUPABASE_ANON_KEY = '';
let supabase = null;

// ========== INICIALIZA√á√ÉO SEGURA DO SUPABASE ==========
async function inicializarSupabase() {
    try {
        const response = await fetch('/api/supabase-config');
        if (!response.ok) throw new Error('Erro ao obter configura√ß√µes do Supabase');
        
        const config = await response.json();
        SUPABASE_URL = config.supabaseUrl;
        SUPABASE_ANON_KEY = config.supabaseAnonKey;
        
        supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        console.log('‚úÖ Supabase inicializado com sucesso');
        return true;
    } catch (error) {
        console.error('‚ùå Erro ao inicializar Supabase:', error);
        return false;
    }
}

// ========== SISTEMA DE TABS CUSTOMIZADO ==========
class TabSystem {
  constructor() {
    this.tabs = document.querySelectorAll('.nav-modern .nav-link');
    this.panes = document.querySelectorAll('.tab-pane');
    this.init();
  }

  init() {
    this.tabs.forEach(tab => {
      tab.addEventListener('click', (e) => {
        e.preventDefault();
        this.showTab(tab.dataset.tab);
      });
    });
  }

  showTab(tabId) {
    this.tabs.forEach(tab => tab.classList.remove('active'));
    this.panes.forEach(pane => pane.classList.remove('active'));

    const activeTab = document.querySelector(`.nav-link[data-tab="${tabId}"]`);
    if (activeTab) activeTab.classList.add('active');

    const activePane = document.getElementById(tabId);
    if (activePane) activePane.classList.add('active');
  }
}

// ========== INICIALIZA√á√ÉO SEGURA ==========
async function inicializarAplicacao() {
  try {
    // üîê Verificar permiss√£o de acesso
    const temPermissao = await verificarEAplicarPermissao('cadastro');
    if (!temPermissao) {
      console.log('‚ùå Sem permiss√£o para acessar cadastro');
      return; // A fun√ß√£o verificarEAplicarPermissao j√° redireciona
    }
    
    const supabaseInicializado = await inicializarSupabase();
    if (!supabaseInicializado) {
      console.error('‚ùå Falha ao inicializar Supabase');
      return;
    }
    
    await carregarInformacoesUsuario();
    new TabSystem();
    inicializarFormulario();
    adicionarCSSPersonalizado();
    inicializarEventListeners();
    await carregarContatos();
    carregarFiltros();
    await carregarEstatisticasSistema();
    
    console.log('‚úÖ Sistema de Cadastro de Motoristas inicializado com sucesso!');
  } catch (error) {
    console.error('‚ùå Erro na inicializa√ß√£o:', error);
    mostrarErro('Erro ao inicializar o sistema: ' + error.message);
  }
}

// ========== FUN√á√ïES DE USU√ÅRIO ==========
async function carregarInformacoesUsuario() {
  try {
    const userData = localStorage.getItem('loggedInUser');
    if (!userData) {
      window.location.href = 'login.html';
      return;
    }

    const user = JSON.parse(userData);
    document.getElementById('currentUser').textContent = user.nome || user.email || 'Usu√°rio';
    // Controle de acesso j√° √© feito por verificarEAplicarPermissao('cadastro') na inicializa√ß√£o
  } catch (error) {
    console.error('Erro de autentica√ß√£o:', error);
    window.location.href = 'login.html';
  }
}

// ========== SISTEMA DE CADASTRO INTELIGENTE ==========
function inicializarFormulario() {
  const classes = document.querySelectorAll('.vehicle-class');
  classes.forEach(classe => {
    classe.addEventListener('click', function() {
      selecionarClasseCadastro(this.dataset.class);
    });
  });
}

function selecionarClasseCadastro(classe) {
  document.querySelectorAll('.vehicle-class').forEach(el => el.classList.remove('active'));
  document.querySelector(`.vehicle-class[data-class="${classe}"]`).classList.add('active');
  
  atualizarTiposVeiculo(classe);
  atualizarTiposCarroceria(classe);
  
  document.getElementById('tipo_veiculo').disabled = false;
  document.getElementById('tipo_carroceria').disabled = false;
}

function atualizarTiposVeiculo(classe) {
  const select = document.getElementById('tipo_veiculo');
  select.innerHTML = '<option value="">Selecione o tipo</option>';
  
  if (classe && tiposVeiculo[classe]) {
    tiposVeiculo[classe].forEach(tipo => {
      const option = document.createElement('option');
      option.value = tipo.toLowerCase().replace(/ /g, '_');
      option.textContent = tipo;
      select.appendChild(option);
    });
  }
}

function atualizarTiposCarroceria(classe) {
  const select = document.getElementById('tipo_carroceria');
  select.innerHTML = '<option value="">Selecione o tipo</option>';
  
  if (classe && bodyworkByClass[classe]) {
    bodyworkByClass[classe].forEach(tipo => {
      if (tiposCarroceriaMap[tipo]) {
        const option = document.createElement('option');
        option.value = tipo;
        option.textContent = tiposCarroceriaMap[tipo];
        select.appendChild(option);
      }
    });
  }
}

function inicializarEventListeners() {
  const formCadastro = document.getElementById('formCadastro');
  if (formCadastro) {
    formCadastro.addEventListener('submit', async function(e) {
      e.preventDefault();
      if (this.dataset.editing) {
        await atualizarMotorista();
      } else {
        await cadastrarMotorista();
      }
    });
  }

  const btnLogout = document.getElementById('btnLogout');
  if (btnLogout) btnLogout.addEventListener('click', fazerLogout);

  const btnLimpar = document.getElementById('btnLimpar');
  if (btnLimpar) {
    btnLimpar.addEventListener('click', function() {
      limparFormulario();
      delete document.getElementById('formCadastro').dataset.editing;
    });
  }

  // Adicionar listeners para filtros
  const filtros = ['filtroClasse', 'filtroEstado', 'filtroStatus', 'filtroBusca'];
  filtros.forEach(filtroId => {
    const elemento = document.getElementById(filtroId);
      if (elemento) {
        elemento.addEventListener('change', aplicarFiltros);
      elemento.addEventListener('input', aplicarFiltros);
      }
    });

  // Bot√£o buscar
    const btnBuscar = document.getElementById('btnBuscar');
    if (btnBuscar) {
      btnBuscar.addEventListener('click', aplicarFiltros);
  }
}

// ========== CADASTRO DE MOTORISTAS (SUPABASE) ==========
async function cadastrarMotorista() {
  const classeSelecionada = document.querySelector('.vehicle-class.active');
  
  if (!classeSelecionada) {
    mostrarErro('Selecione a classe do ve√≠culo');
    return;
  }
  
  const dados = {
    nome: document.getElementById('nome').value.trim(),
    cnh: document.getElementById('cnh').value.trim() || null,
    categoria_cnh: document.getElementById('categoria_cnh').value || null,
    telefone1: document.getElementById('telefone1').value.trim(),
    telefone2: document.getElementById('telefone2').value.trim() || null,
    estado: document.getElementById('estado').value || null,
    tipo_veiculo: document.getElementById('tipo_veiculo').value,
    tipo_carroceria: document.getElementById('tipo_carroceria').value,
    placa_cavalo: document.getElementById('placa_cavalo').value.trim() || null,
    placa_carreta1: document.getElementById('placa_carreta1').value.trim() || null,
    placa_carreta2: document.getElementById('placa_carreta2').value.trim() || null,
    placa_carreta3: document.getElementById('placa_carreta3').value.trim() || null,
    status: document.getElementById('status').value || 'ativo'
  };

  if (!dados.nome || !dados.telefone1 || !dados.tipo_veiculo || !dados.tipo_carroceria) {
    mostrarErro('Preencha todos os campos obrigat√≥rios (*)');
    return;
  }

  const motoristaData = {
    ...dados,
    classe_veiculo: classeSelecionada.dataset.class,
    data_cadastro: new Date().toISOString(),
    data_atualizacao: new Date().toISOString(),
    usuario_id: await getCurrentUserId(),
    created_by: await getCurrentUserId(),
    created_by_departamento: await getCurrentUserDepartment()
  };

  try {
    const { data, error } = await supabase.from('motoristas').insert([motoristaData]).select();

    if (error) throw error;

    mostrarSucesso('‚úÖ Motorista cadastrado com sucesso! ID: ' + data[0].id);
    limparFormulario();
    await carregarContatos();
    
  } catch (error) {
    console.error('‚ùå Erro completo:', error);
    mostrarErro('‚ùå Erro ao cadastrar motorista: ' + error.message);
  }
}

function limparFormulario() {
  document.getElementById('formCadastro').reset();
  document.querySelectorAll('.vehicle-class').forEach(el => el.classList.remove('active'));
  document.getElementById('tipo_veiculo').innerHTML = '<option value="">Selecione a classe do ve√≠culo primeiro</option>';
  document.getElementById('tipo_veiculo').disabled = true;
  document.getElementById('tipo_carroceria').innerHTML = '<option value="">Selecione a classe do ve√≠culo primeiro</option>';
  document.getElementById('tipo_carroceria').disabled = true;
}

async function carregarContatos() {
  try {
    // Mostrar indicador de carregamento
    const contatosList = document.getElementById('contatosList');
    if (contatosList) {
      contatosList.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div><p class="mt-3">Carregando motoristas...</p></div>';
    }
    
    let todosMotoristas = [];
    
    if (supabase) {
      console.log('üîç Carregando TODOS os motoristas do banco de dados...');
      
      // Carregar TODOS os motoristas em lotes de 1000
      let from = 0;
      const limit = 1000; // Carregar em lotes de 1000
      let hasMore = true;
      
      while (hasMore) {
        const { data: motoristas, error } = await supabase
          .from('motoristas')
          .select('*')
          .order('data_cadastro', { ascending: false })
          .range(from, from + limit - 1);

        if (error) throw error;
        
        if (motoristas && motoristas.length > 0) {
          todosMotoristas = todosMotoristas.concat(motoristas);
          from += limit;
          
          // Atualizar progresso se houver elemento
          if (contatosList) {
            contatosList.innerHTML = `<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Carregando motoristas... ${todosMotoristas.length.toLocaleString('pt-BR')} encontrados</p></div>`;
          }
          
          console.log(`üìä ${todosMotoristas.length.toLocaleString('pt-BR')} motoristas carregados...`);
          
          // Se retornou menos que o limite, n√£o h√° mais dados
          if (motoristas.length < limit) {
            hasMore = false;
          }
        } else {
          hasMore = false;
        }
      }
      
      console.log(`‚úÖ Total de ${todosMotoristas.length.toLocaleString('pt-BR')} motoristas carregados do banco`);
    } else {
      console.warn('‚ö†Ô∏è Supabase n√£o dispon√≠vel');
      todosMotoristas = [];
    }

    todosContatos = todosMotoristas;
    contatosFiltrados = [...todosContatos];
    
    atualizarEstatisticas();
    aplicarFiltros();
    
  } catch (error) {
    console.error('Erro ao carregar contatos:', error);
    mostrarErro('Erro ao carregar contatos: ' + error.message);
  }
}

function atualizarEstatisticas() {
  const total = todosContatos.length;
  const ativos = todosContatos.filter(c => c.status === 'ativo').length;
  const inativos = todosContatos.filter(c => c.status === 'inativo').length;
  const bloqueados = todosContatos.filter(c => c.status === 'bloqueado').length;
  
  document.getElementById('totalContatos').textContent = total.toLocaleString('pt-BR');
  document.getElementById('contatosAtivos').textContent = ativos.toLocaleString('pt-BR');
  document.getElementById('contatosInativos').textContent = inativos.toLocaleString('pt-BR');
  document.getElementById('contatosBloqueados').textContent = bloqueados.toLocaleString('pt-BR');
  
  // Atualizar cards de carrocerias
  atualizarCardsCarrocerias();
}

function atualizarCardsCarrocerias() {
  const carroceriasGrid = document.getElementById('carroceriasGrid');
  if (!carroceriasGrid) return;
  
  // Contar motoristas por carroceria
  const contagemPorCarroceria = {};
  
  todosContatos.forEach(contato => {
    const carroceria = contato.tipo_carroceria;
    if (carroceria) {
      if (!contagemPorCarroceria[carroceria]) {
        contagemPorCarroceria[carroceria] = 0;
      }
      contagemPorCarroceria[carroceria]++;
    }
  });
  
  // Ordenar por quantidade (maior para menor)
  const carroceriasOrdenadas = Object.entries(contagemPorCarroceria)
    .sort((a, b) => b[1] - a[1]);
  
  // Limpar grid
  carroceriasGrid.innerHTML = '';
  
  // Cores para os cards
  const cores = ['primary', 'success', 'info', 'warning', 'danger'];
  let corIndex = 0;
  
  // Criar cards para cada carroceria
  carroceriasOrdenadas.forEach(([carroceria, quantidade]) => {
    const nomeAmigavel = tiposCarroceriaMap[carroceria] || carroceria;
    const cor = cores[corIndex % cores.length];
    
    const card = document.createElement('div');
    card.className = 'status-card';
    card.innerHTML = `
      <div class="status-icon ${cor}">
        <i class="fas fa-truck"></i>
      </div>
      <div class="status-number">${quantidade.toLocaleString('pt-BR')}</div>
      <div class="status-label">${nomeAmigavel}</div>
    `;
    
    carroceriasGrid.appendChild(card);
    corIndex++;
  });
  
  // Se n√£o houver carrocerias, mostrar mensagem
  if (carroceriasOrdenadas.length === 0) {
    carroceriasGrid.innerHTML = '<div class="col-12 text-center text-muted py-3">Nenhuma carroceria encontrada</div>';
  }
  
  console.log(`‚úÖ Cards de carrocerias atualizados: ${carroceriasOrdenadas.length} tipos`);
}

function carregarFiltros() {
  const selectEstado = document.getElementById('filtroEstado');
  
  if (selectEstado) {
    selectEstado.innerHTML = '<option value="">Todos os estados</option>';
    estados.forEach(estado => {
      const option = document.createElement('option');
      option.value = estado;
      option.textContent = estado;
      selectEstado.appendChild(option);
    });
  }
}

function aplicarFiltros() {
  const filtroClasse = document.getElementById('filtroClasse')?.value || '';
  const filtroEstado = document.getElementById('filtroEstado')?.value || '';
  const filtroStatus = document.getElementById('filtroStatus')?.value || '';
  const filtroBusca = document.getElementById('filtroBusca')?.value.toLowerCase() || '';
  
  contatosFiltrados = todosContatos.filter(contato => {
    const matchBusca = !filtroBusca || 
      contato.nome.toLowerCase().includes(filtroBusca) ||
      contato.telefone1.includes(filtroBusca);
    
    return (!filtroClasse || contato.classe_veiculo === filtroClasse) &&
           (!filtroEstado || contato.estado === filtroEstado) &&
           (!filtroStatus || contato.status === filtroStatus) &&
           matchBusca;
  });
  
  currentPage = 1;
  atualizarTabelaContatos();
  atualizarPaginacao();
}

function atualizarTabelaContatos() {
  const tbody = document.getElementById('tabelaContatos');
  const startIndex = (currentPage - 1) * pageSize;
  const endIndex = startIndex + pageSize;
  const contatosPagina = contatosFiltrados.slice(startIndex, endIndex);
  
  document.getElementById('infoPaginacao').textContent = 
    `Mostrando ${Math.min(contatosPagina.length, pageSize)} de ${contatosFiltrados.length} registros`;
  
  if (contatosPagina.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="6" class="text-center text-muted py-5">
          <i class="fas fa-search fa-3x mb-3 d-block"></i>
          <h5 class="fw-bold">Nenhum motorista encontrado</h5>
        </td>
      </tr>
    `;
    return;
  }
  
  let html = '';
  contatosPagina.forEach(contato => {
    html += `
      <tr>
        <td>${contato.nome}</td>
        <td>${contato.telefone1}</td>
        <td>${contato.classe_veiculo}</td>
        <td>${contato.estado || '-'}</td>
        <td><span class="badge bg-${contato.status === 'ativo' ? 'success' : 'secondary'}">${contato.status}</span></td>
        <td>
            <button class="btn btn-sm btn-outline-primary" onclick="editarMotorista('${contato.id}')" title="Editar">
              <i class="fas fa-edit"></i>
            </button>
        </td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
}

function atualizarPaginacao() {
  const totalPages = Math.ceil(contatosFiltrados.length / pageSize);
  const paginacao = document.getElementById('paginacao');
  
  if (totalPages <= 1) {
    paginacao.innerHTML = '';
    return;
  }
  
  let html = '';
  
  html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="mudarPagina(${currentPage - 1}); return false;">‚Äπ</a>
  </li>`;
  
  for (let i = 1; i <= totalPages; i++) {
    if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
      html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
          <a class="page-link" href="#" onclick="mudarPagina(${i}); return false;">${i}</a>
      </li>`;
    }
  }
  
  html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="mudarPagina(${currentPage + 1}); return false;">‚Ä∫</a>
  </li>`;
  
  paginacao.innerHTML = html;
}

function mudarPagina(pagina) {
  currentPage = pagina;
  atualizarTabelaContatos();
}

async function editarMotorista(id) {
    try {
    let motorista = null;

    if (supabase) {
      const { data, error } = await supabase
            .from('motoristas')
            .select('*')
            .eq('id', id)
            .single();
      if (error && error.code !== 'PGRST116') throw error;
      motorista = data || null;
    }

    if (!motorista) {
      motorista = todosContatos.find(c => c.id === id) || null;
    }

        if (!motorista) {
            mostrarErro('Motorista n√£o encontrado');
            return;
        }

    // Garantir que estamos na aba de cadastro
    const abaCadastro = document.querySelector('.nav-modern .nav-link[data-tab="cadastro"]');
    if (abaCadastro) abaCadastro.click();

    // Preencher campos b√°sicos
        document.getElementById('nome').value = motorista.nome || '';
        document.getElementById('cnh').value = motorista.cnh || '';
        document.getElementById('categoria_cnh').value = motorista.categoria_cnh || '';
        document.getElementById('telefone1').value = motorista.telefone1 || '';
        document.getElementById('telefone2').value = motorista.telefone2 || '';
        document.getElementById('estado').value = motorista.estado || '';
        document.getElementById('placa_cavalo').value = motorista.placa_cavalo || '';
        document.getElementById('placa_carreta1').value = motorista.placa_carreta1 || '';
        document.getElementById('placa_carreta2').value = motorista.placa_carreta2 || '';
    const inputCarreta3 = document.getElementById('placa_carreta3');
    if (inputCarreta3) inputCarreta3.value = motorista.placa_carreta3 || '';
        document.getElementById('status').value = motorista.status || 'ativo';

    // Selecionar classe e ajustar op√ß√µes dependentes
    const classe = (motorista.classe_veiculo || '').toLowerCase();
    if (classe) {
      selecionarClasseCadastro(classe);
    } else {
      // limpa sele√ß√£o se n√£o houver classe
      document.querySelectorAll('.vehicle-class').forEach(el => el.classList.remove('active'));
    }

    // Ajustar selects dependentes (ap√≥s atualiza√ß√£o das op√ß√µes)
        setTimeout(() => {
      const selectTipoVeiculo = document.getElementById('tipo_veiculo');
      const selectTipoCarroceria = document.getElementById('tipo_carroceria');
      const tipoVeiculo = (motorista.tipo_veiculo || '').toLowerCase();
      const tipoCarroceria = (motorista.tipo_carroceria || '').toLowerCase();
      if (selectTipoVeiculo) {
        selectTipoVeiculo.value = tipoVeiculo;
      }
      if (selectTipoCarroceria) {
        selectTipoCarroceria.value = tipoCarroceria;
      }
    }, 100);

    // Marcar formul√°rio em modo edi√ß√£o
    const form = document.getElementById('formCadastro');
    form.dataset.editing = id;
        
    mostrarSucesso('Modo edi√ß√£o habilitado. Atualize as informa√ß√µes e salve.');
    window.scrollTo({ top: form.offsetTop - 80, behavior: 'smooth' });
    } catch (error) {
    console.error('‚ùå Erro ao editar motorista:', error);
    mostrarErro('Erro ao carregar dados para edi√ß√£o: ' + error.message);
    }
}

async function atualizarMotorista() {
  const id = document.getElementById('formCadastro').dataset.editing;
  if (!id) return;

  const classeSelecionada = document.querySelector('.vehicle-class.active');
  if (!classeSelecionada) {
    mostrarErro('Selecione a classe do ve√≠culo');
    return;
  }

  const formData = new FormData(document.getElementById('formCadastro'));
  const dados = Object.fromEntries(formData);

  const updateData = {
    nome: dados.nome,
    cnh: dados.cnh || null,
    categoria_cnh: dados.categoria_cnh || null,
    telefone1: dados.telefone1,
    telefone2: dados.telefone2 || null,
    estado: dados.estado || null,
    classe_veiculo: classeSelecionada.dataset.class,
    tipo_veiculo: dados.tipo_veiculo,
    tipo_carroceria: dados.tipo_carroceria,
    placa_cavalo: dados.placa_cavalo || null,
    placa_carreta1: dados.placa_carreta1 || null,
    placa_carreta2: dados.placa_carreta2 || null,
    placa_carreta3: dados.placa_carreta3 || null,
    status: dados.status || 'ativo',
    data_atualizacao: new Date().toISOString()
  };

  try {
    const { error } = await supabase.from('motoristas').update(updateData).eq('id', id);
    if (error) throw error;

    mostrarSucesso('‚úÖ Motorista atualizado com sucesso!');
    limparFormulario();
    delete document.getElementById('formCadastro').dataset.editing;
    await carregarContatos();
    
  } catch (error) {
    console.error('Erro ao atualizar:', error);
    mostrarErro('‚ùå Erro: ' + error.message);
  }
}

async function excluirMotorista(id) {
  if (!confirm('Tem certeza que deseja excluir este motorista?')) return;

  try {
    const { error } = await supabase.from('motoristas').delete().eq('id', id);
    if (error) throw error;

    mostrarSucesso('‚úÖ Motorista exclu√≠do com sucesso!');
    await carregarContatos();
    
  } catch (error) {
    console.error('Erro ao excluir:', error);
    mostrarErro('‚ùå Erro: ' + error.message);
  }
}

async function getCurrentUserId() {
  const userData = localStorage.getItem('loggedInUser');
  if (userData) {
    const user = JSON.parse(userData);
    return user.id || 'default_user';
  }
  return 'default_user';
}

async function getCurrentUserDepartment() {
  try {
    const userData = localStorage.getItem('loggedInUser');
    if (userData) {
      const user = JSON.parse(userData);
      if (user.departamento) return user.departamento;
    }
  } catch {}
  return null;
}

function mostrarSucesso(mensagem) {
  mostrarMensagem(mensagem, 'success');
}

function mostrarErro(mensagem) {
  mostrarMensagem(mensagem, 'danger');
}

function mostrarMensagem(mensagem, tipo) {
  const mensagensAnteriores = document.querySelectorAll('.alert-floating');
  mensagensAnteriores.forEach(msg => msg.remove());
  
  const alert = document.createElement('div');
  alert.className = `alert alert-${tipo} alert-floating alert-dismissible fade show`;
  alert.innerHTML = `${mensagem}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
  
  document.body.appendChild(alert);
  
  if (tipo !== 'danger') {
    setTimeout(() => {
      if (alert.parentNode) alert.remove();
    }, 5000);
  }
}

async function fazerLogout() {
  if (confirm('Deseja realmente sair do sistema?')) {
    try {
      localStorage.removeItem('loggedInUser');
    } catch (error) {
      console.error('Erro no logout:', error);
    } finally {
      window.location.href = 'login.html';
    }
  }
}

function adicionarCSSPersonalizado() {
  if (document.getElementById('css-personalizado')) return;
  
  const style = document.createElement('style');
  style.id = 'css-personalizado';
  style.textContent = `
    .stat-card-small {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: all 0.3s ease;
    }
    .stat-card-small:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
    }
    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }
    .stat-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1f2937;
      line-height: 1;
    }
    .stat-label {
      font-size: 0.875rem;
      color: #64748b;
      margin-top: 0.25rem;
    }
  `;
  document.head.appendChild(style);
}

async function carregarEstatisticasSistema() { /* removido */ }

// ========== INICIALIZA√á√ÉO FINAL ==========
document.addEventListener('DOMContentLoaded', inicializarAplicacao);
</script>
</body>
</html>