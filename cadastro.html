<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Cadastro de Motoristas - Sistema de Disparo</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- ADICIONAR CDN DO SUPABASE -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/permissions.js"></script>
  <style>
    :root {
      --primary: #667eea;
      --primary-dark: #5a6fd8;
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --info: #3b82f6;
      --dark: #1f2937;
      --light: #f8fafc;
    }
    
    body { 
      padding: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
    }
    
    .app-container {
      background: white;
      min-height: 100vh;
      border-radius: 0;
      box-shadow: 0 0 50px rgba(0,0,0,0.1);
    }
    
    /* Header Moderno */
    .app-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      padding: 1.25rem 0;
      position: sticky;
      top: 0;
      z-index: 1000;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      backdrop-filter: blur(10px);
    }
    
    .user-badge {
      background: rgba(255,255,255,0.2);
      padding: 8px 16px;
      border-radius: 25px;
      font-size: 0.9rem;
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    /* Cards Modernos */
    .modern-card {
      background: white;
      border: none;
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
      border: 1px solid rgba(0,0,0,0.03);
    }
    
    .modern-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.12);
    }
    
    .modern-card .card-header {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border: none;
      padding: 1.5rem 2rem;
      font-weight: 700;
      font-size: 1.1rem;
    }
    
    /* Status Cards */
    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
    .status-card {
      background: white;
      padding: 2rem;
      border-radius: 20px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
      text-align: center;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: 1px solid rgba(0,0,0,0.03);
      position: relative;
      overflow: hidden;
    }
    
    .status-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary), var(--success));
    }
    
    .status-card:hover {
      transform: translateY(-8px);
      box-shadow: 0 20px 40px rgba(0,0,0,0.15);
    }
    
    .status-icon {
      width: 70px;
      height: 70px;
      border-radius: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 1.5rem;
      font-size: 2rem;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
    }
    
    .status-icon.primary {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      color: var(--primary);
    }
    
    .status-icon.success {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      color: var(--success);
    }
    
    .status-icon.warning {
      background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%);
      color: var(--warning);
    }
    
    .status-icon.danger {
      background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
      color: var(--danger);
    }
    
    .status-number {
      font-size: 2.5rem;
      font-weight: 800;
      margin-bottom: 0.5rem;
      background: linear-gradient(135deg, var(--primary), var(--success));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .status-label {
      color: #64748b;
      font-size: 1rem;
      font-weight: 600;
    }
    
    /* Classes de Ve√≠culo */
    .vehicle-classes {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .vehicle-class {
      background: var(--light);
      border: 2px solid #e2e8f0;
      border-radius: 16px;
      padding: 1.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
    }
    
    .vehicle-class::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
      transition: left 0.5s;
    }
    
    .vehicle-class:hover::before {
      left: 100%;
    }
    
    .vehicle-class:hover {
      transform: translateY(-5px);
      border-color: var(--primary);
      box-shadow: 0 10px 25px rgba(102, 126, 234, 0.15);
    }
    
    .vehicle-class.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border-color: var(--primary);
      transform: scale(1.05);
    }
    
    .vehicle-class.active .class-icon {
      color: white;
    }
    
    .class-icon {
      font-size: 2.5rem;
      margin-bottom: 1rem;
      color: var(--primary);
      transition: all 0.3s ease;
    }
    
    .class-name {
      font-weight: 700;
      font-size: 1.1rem;
      margin-bottom: 0.5rem;
    }
    
    .class-description {
      font-size: 0.85rem;
      opacity: 0.8;
    }
    
    /* Formul√°rio Moderno */
    .form-section {
      background: white;
      border-radius: 20px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.03);
    }
    
    .section-title {
      font-weight: 700;
      color: var(--dark);
      margin-bottom: 1.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      font-size: 1.2rem;
      padding-bottom: 0.75rem;
      border-bottom: 2px solid #f1f5f9;
    }
    
    .section-title i {
      color: var(--primary);
      font-size: 1.3rem;
    }
    
    .form-control-modern, .form-select-modern {
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 1rem 1.25rem;
      font-size: 1rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: white;
    }
    
    .form-control-modern:focus, .form-select-modern:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
      transform: translateY(-2px);
    }
    
    .form-label-modern {
      font-weight: 600;
      color: var(--dark);
      margin-bottom: 0.75rem;
      font-size: 0.95rem;
    }
    
    /* Bot√µes Modernos */
    .btn-modern {
      border: none;
      border-radius: 14px;
      padding: 1rem 2rem;
      font-weight: 700;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      font-size: 1rem;
    }
    
    .btn-modern::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.6s;
    }
    
    .btn-modern:hover::before {
      left: 100%;
    }
    
    .btn-modern:hover {
      transform: translateY(-3px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }
    
    .btn-modern-primary {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
    }
    
    .btn-modern-success {
      background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
      color: white;
    }
    
    .btn-modern-danger {
      background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
      color: white;
    }
    
    .btn-modern-warning {
      background: linear-gradient(135deg, var(--warning) 0%, #d97706 100%);
      color: white;
    }
    
    .btn-modern-info {
      background: linear-gradient(135deg, var(--info) 0%, #2563eb 100%);
      color: white;
    }
    
    /* Tabela Moderna */
    .table-modern {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.03);
    }
    
    .table-modern thead th {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-bottom: 2px solid #e2e8f0;
      font-weight: 700;
      padding: 1.25rem 1.5rem;
      color: var(--dark);
      font-size: 0.9rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .table-modern tbody td {
      padding: 1.25rem 1.5rem;
      vertical-align: middle;
      border-bottom: 1px solid #f1f5f9;
      transition: background-color 0.2s ease;
    }
    
    .table-modern tbody tr:hover td {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }
    
    .table-modern tbody tr:last-child td {
      border-bottom: none;
    }
    
    /* Badges Modernos */
    .badge-modern {
      padding: 0.5rem 1rem;
      border-radius: 10px;
      font-size: 0.8rem;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .badge-vehicle {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      color: var(--info);
      border: 1px solid #bfdbfe;
    }
    
    .badge-bodywork {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      color: var(--success);
      border: 1px solid #bbf7d0;
    }
    
    .badge-state {
      background: linear-gradient(135deg, #fafafa 0%, #f4f4f5 100%);
      color: #64748b;
      border: 1px solid #e4e4e7;
    }
    
    .badge-status {
      padding: 0.4rem 0.8rem;
      border-radius: 8px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .badge-ativo {
      background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
      color: var(--success);
      border: 1px solid #bbf7d0;
    }
    
    .badge-inativo {
      background: linear-gradient(135deg, #fafafa 0%, #f4f4f5 100%);
      color: #64748b;
      border: 1px solid #e4e4e7;
    }
    
    .badge-bloqueado {
      background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
      color: var(--danger);
      border: 1px solid #fca5a5;
    }
    
    /* A√ß√µes */
    .action-buttons {
      display: flex;
      gap: 0.5rem;
    }
    
    .btn-action {
      width: 36px;
      height: 36px;
      border: none;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }
    
    .btn-edit {
      background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
      color: var(--info);
      border: 1px solid #bfdbfe;
    }
    
    .btn-edit:hover {
      background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
      transform: translateY(-2px);
    }
    
    .btn-delete {
      background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
      color: var(--danger);
      border: 1px solid #fca5a5;
    }
    
    .btn-delete:hover {
      background: linear-gradient(135deg, #fecaca 0%, #fca5a5 100%);
      transform: translateY(-2px);
    }
    
    /* Upload Moderno */
    .upload-area {
      border: 2px dashed #cbd5e1;
      border-radius: 16px;
      padding: 3rem 2rem;
      text-align: center;
      transition: all 0.3s ease;
      background: #f8fafc;
      cursor: pointer;
    }
    
    .upload-area:hover {
      border-color: var(--primary);
      background: rgba(102, 126, 234, 0.05);
    }
    
    .upload-area.dragover {
      border-color: var(--success);
      background: rgba(16, 185, 129, 0.05);
    }
    
    .upload-icon {
      font-size: 3rem;
      color: #cbd5e1;
      margin-bottom: 1rem;
      transition: all 0.3s ease;
    }
    
    .upload-area:hover .upload-icon {
      color: var(--primary);
    }
    
    /* Anima√ß√µes */
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.7; }
      100% { opacity: 1; }
    }
    
    .pulse {
      animation: pulse 2s infinite;
    }
    
    /* Alertas Flutuantes */
    .alert-floating {
      position: fixed !important;
      top: 100px;
      right: 20px;
      z-index: 9999;
      min-width: 300px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      border-radius: 12px;
      border: none;
    }

    .treinamento-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.9);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      padding: 2rem;
    }

    .treinamento-overlay.ativo {
      display: flex;
    }

    .treinamento-overlay-card {
      max-width: 520px;
      width: 100%;
      background: rgba(15, 23, 42, 0.95);
      border-radius: 20px;
      border: 1px solid rgba(96, 165, 250, 0.35);
      padding: 2.5rem 2rem;
      text-align: center;
      box-shadow: 0 24px 60px rgba(15, 23, 42, 0.6);
      color: #e2e8f0;
    }

    .treinamento-overlay-card h2 {
      font-size: 1.6rem;
      font-weight: 700;
      color: #f8fafc;
      margin-bottom: 1rem;
    }

    .treinamento-overlay-card p {
      color: rgba(226, 232, 240, 0.78);
      margin-bottom: 1.75rem;
      line-height: 1.6;
    }

    .treinamento-overlay-actions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      justify-content: center;
    }

    .treinamento-overlay .btn {
      border-radius: 14px;
      font-weight: 600;
      padding: 0.75rem 1.5rem;
    }

    .treinamento-overlay .btn-training {
      background: linear-gradient(135deg, #38bdf8, #0ea5e9);
      border: none;
      color: #0b1120;
      box-shadow: 0 16px 32px rgba(56, 189, 248, 0.35);
    }

    .treinamento-overlay .btn-refresh {
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: transparent;
      color: #e2e8f0;
    }

    .treinamento-overlay .badge {
      background: rgba(59, 130, 246, 0.2);
      color: #bfdbfe;
      border-radius: 999px;
      padding: 0.35rem 0.75rem;
      font-size: 0.75rem;
      font-weight: 600;
    }

    body.treinamento-bloqueado {
      overflow: hidden;
    }
    
    /* Sistema de Tabs Customizado */
    .tab-content {
      position: relative;
    }
    
    .tab-pane {
      display: none;
      opacity: 0;
      transition: opacity 0.3s ease;
      margin-top: 0;
      padding-top: 0;
    }
    
    .tab-pane.active {
      display: block;
      opacity: 1;
    }
    
    #gestao {
      margin-top: 0 !important;
      padding-top: 0 !important;
    }
    
    #gestao .modern-card:first-child {
      margin-top: 0 !important;
    }
    
    /* Navega√ß√£o Moderna */
    .modern-tabs {
      background: white;
      border-radius: 16px;
      padding: 1rem;
      margin-bottom: 2rem;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      border: 1px solid rgba(0,0,0,0.03);
    }
    
    .nav-modern {
      display: flex;
      gap: 0.5rem;
      flex-wrap: wrap;
    }
    
    .nav-modern .nav-link {
      background: var(--light);
      border: 2px solid #e2e8f0;
      border-radius: 12px;
      padding: 1rem 1.5rem;
      color: #64748b;
      font-weight: 600;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.75rem;
      cursor: pointer;
    }
    
    .nav-modern .nav-link:hover {
      border-color: var(--primary);
      background: rgba(102, 126, 234, 0.05);
      transform: translateY(-2px);
    }
    
    .nav-modern .nav-link.active {
      background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
      color: white;
      border-color: var(--primary);
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
    }
    
    /* Responsivo */
    @media (max-width: 768px) {
      .app-header {
        padding: 1rem 0;
      }
      
      .vehicle-classes {
        grid-template-columns: 1fr;
      }
      
      .status-grid {
        grid-template-columns: 1fr;
      }
      
      .action-buttons {
        flex-direction: column;
        gap: 0.25rem;
      }
      
      .btn-action {
        width: 100%;
      }
      
      .alert-floating {
        left: 20px;
        right: 20px;
        min-width: auto;
      }
      
      .nav-modern {
        flex-direction: column;
      }
      
      .nav-modern .nav-link {
        justify-content: center;
        text-align: center;
      }
    }
  </style>
</head>
<body>

<div class="app-container">
  <!-- Header Moderno -->
  <header class="app-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col">
          <div class="d-flex align-items-center gap-3">
            <div class="bg-white rounded-3 p-2 shadow-lg">
              <i class="fas fa-database text-primary fs-4"></i>
            </div>
            <div>
              <h1 class="h3 mb-0 fw-bold">Cadastro de Motoristas</h1>
              <div class="user-badge">
                <i class="fas fa-user me-1"></i>
                <span id="currentUser">Carregando...</span>
                <span class="badge bg-light text-dark ms-2">ADMIN</span>
              </div>
            </div>
          </div>
        </div>
        <div class="col-auto">
          <div class="d-flex gap-2">
            <a href="portal.html" class="btn btn-outline-light btn-sm" id="btnVoltarPortal">
              <i class="fas fa-home me-1"></i> Voltar ao Portal
            </a>
            <button id="btnLogout" class="btn btn-outline-light btn-sm">
              <i class="fas fa-sign-out-alt me-1"></i> Sair
            </button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Conte√∫do Principal -->
  <main class="container py-4">
    
    <!-- Status R√°pido -->
    <div class="status-grid">
      <div class="status-card">
        <div class="status-icon primary">
          <i class="fas fa-users"></i>
        </div>
        <div class="status-number" id="totalContatos">0</div>
        <div class="status-label">Total Cadastrados</div>
      </div>
      <div class="status-card">
        <div class="status-icon success">
          <i class="fas fa-check-circle"></i>
        </div>
        <div class="status-number" id="contatosAtivos">0</div>
        <div class="status-label">Ativos</div>
      </div>
      <div class="status-card">
        <div class="status-icon warning">
          <i class="fas fa-user-slash"></i>
        </div>
        <div class="status-number" id="contatosInativos">0</div>
        <div class="status-label">Inativos</div>
      </div>
      <div class="status-card">
        <div class="status-icon danger">
          <i class="fas fa-ban"></i>
        </div>
        <div class="status-number" id="contatosBloqueados">0</div>
        <div class="status-label">Bloqueados</div>
      </div>
    </div>

    <!-- Cards de Carrocerias -->
    <div class="mt-4 mb-4">
      <h5 class="mb-3 fw-bold text-dark">
        <i class="fas fa-truck me-2"></i>Quantidade por Carroceria
      </h5>
      <div class="status-grid" id="carroceriasGrid">
        <!-- Cards ser√£o gerados dinamicamente via JavaScript -->
      </div>
    </div>

    <!-- Navega√ß√£o Moderna -->
    <div class="modern-tabs">
      <nav class="nav-modern">
        <a class="nav-link active" data-tab="cadastro">
          <i class="fas fa-user-plus"></i>
          Cadastro Individual
        </a>
        <a class="nav-link" data-tab="importacao">
          <i class="fas fa-file-import"></i>
          Importa√ß√£o em Lote
        </a>
        <a class="nav-link" data-tab="gestao">
          <i class="fas fa-users"></i>
          Gest√£o de Contatos
        </a>
      </nav>
    </div>

    <!-- Conte√∫do das Abas -->
    <div class="tab-content">
      
      <!-- Aba: Cadastro Individual -->
      <div class="tab-pane active" id="cadastro">
        <div class="modern-card">
          <div class="card-header">
            <i class="fas fa-user-plus me-2"></i>Cadastrar Novo Motorista
          </div>
          <div class="card-body">
            <form id="formCadastro">
              
              <!-- Informa√ß√µes Pessoais -->
              <div class="form-section">
                <div class="section-title">
                  <i class="fas fa-id-card"></i>
                  Informa√ß√µes Pessoais
                </div>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label-modern">Nome Completo *</label>
                    <input type="text" id="nome" class="form-control form-control-modern" required placeholder="Digite o nome completo" maxlength="100">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label-modern">CNH</label>
                    <input type="text" id="cnh" class="form-control form-control-modern" placeholder="N√∫mero da CNH" maxlength="11" pattern="[0-9]{11}" title="CNH deve conter exatamente 11 d√≠gitos num√©ricos">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label-modern">Categoria CNH</label>
                    <select id="categoria_cnh" class="form-select form-select-modern">
                      <option value="">Selecione</option>
                      <option value="A">A - Motos</option>
                      <option value="B">B - Carros</option>
                      <option value="C">C - Caminh√µes</option>
                      <option value="D">D - √înibus</option>
                      <option value="E">E - Carreta</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Contatos -->
              <div class="form-section">
                <div class="section-title">
                  <i class="fas fa-phone"></i>
                  Contatos
                </div>
                <div class="row g-3">
                  <div class="col-md-4">
                    <label class="form-label-modern">Telefone 1 *</label>
                    <input type="text" id="telefone1" class="form-control form-control-modern" required placeholder="5511999999999" maxlength="13" pattern="[0-9]{11,13}" title="Telefone deve ter 11 ou 13 d√≠gitos (formato: 55+DDD+9+N√∫mero)">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label-modern">Telefone 2</label>
                    <input type="text" id="telefone2" class="form-control form-control-modern" placeholder="5511888888888" maxlength="13" pattern="[0-9]{11,13}" title="Telefone deve ter 11 ou 13 d√≠gitos (formato: 55+DDD+9+N√∫mero)">
                  </div>
                  <div class="col-md-4">
                    <label class="form-label-modern">Estado (DDD)</label>
                    <select id="estado" class="form-select form-select-modern">
                      <option value="">Selecione o estado</option>
                      <option value="SP">S√£o Paulo</option>
                      <option value="RJ">Rio de Janeiro</option>
                      <option value="MG">Minas Gerais</option>
                      <option value="ES">Esp√≠rito Santo</option>
                      <option value="PR">Paran√°</option>
                      <option value="SC">Santa Catarina</option>
                      <option value="RS">Rio Grande do Sul</option>
                      <option value="MS">Mato Grosso do Sul</option>
                      <option value="MT">Mato Grosso</option>
                      <option value="GO">Goi√°s</option>
                      <option value="DF">Distrito Federal</option>
                      <option value="BA">Bahia</option>
                      <option value="SE">Sergipe</option>
                      <option value="AL">Alagoas</option>
                      <option value="PE">Pernambuco</option>
                      <option value="PB">Para√≠ba</option>
                      <option value="RN">Rio Grande do Norte</option>
                      <option value="CE">Cear√°</option>
                      <option value="PI">Piau√≠</option>
                      <option value="MA">Maranh√£o</option>
                      <option value="PA">Par√°</option>
                      <option value="AP">Amap√°</option>
                      <option value="AM">Amazonas</option>
                      <option value="RR">Roraima</option>
                      <option value="AC">Acre</option>
                      <option value="RO">Rond√¥nia</option>
                      <option value="TO">Tocantins</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Ve√≠culo - Sistema Inteligente -->
              <div class="form-section">
                <div class="section-title">
                  <i class="fas fa-truck"></i>
                  Ve√≠culo
                </div>
                
                <!-- Classes de Ve√≠culo -->
                <div class="vehicle-classes" id="vehicleClassesCadastro">
                  <div class="vehicle-class" data-class="leve">
                    <div class="class-icon">
                      <i class="fas fa-truck-pickup"></i>
                    </div>
                    <div class="class-name">Leves</div>
                    <div class="class-description">Fiorino, 3/4, Toco, VLC</div>
                  </div>
                  <div class="vehicle-class" data-class="medio">
                    <div class="class-icon">
                      <i class="fas fa-truck"></i>
                    </div>
                    <div class="class-name">M√©dios</div>
                    <div class="class-description">Bitruck, Truck</div>
                  </div>
                  <div class="vehicle-class" data-class="pesado">
                    <div class="class-icon">
                      <i class="fas fa-truck-moving"></i>
                    </div>
                    <div class="class-name">Pesados</div>
                    <div class="class-description">Bitrem, Carreta, Rodotrem</div>
                  </div>
                </div>

                <!-- Tipos de Ve√≠culo e Carroceria (Din√¢micos) -->
                <div class="row g-3">
                  <div class="col-md-6">
                    <label class="form-label-modern">Tipo de Ve√≠culo *</label>
                    <select id="tipo_veiculo" class="form-select form-select-modern" required disabled>
                      <option value="">Selecione a classe do ve√≠culo primeiro</option>
                    </select>
                  </div>
                  <div class="col-md-6">
                    <label class="form-label-modern">Tipo de Carroceria *</label>
                    <select id="tipo_carroceria" class="form-select form-select-modern" required disabled>
                      <option value="">Selecione a classe do ve√≠culo primeiro</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- Placas -->
              <div class="form-section">
                <div class="section-title">
                  <i class="fas fa-id-card-alt"></i>
                  Placas
                </div>
                <div class="row g-3">
                  <div class="col-md-3">
                    <label class="form-label-modern">Placa do Cavalo</label>
                    <input type="text" id="placa_cavalo" class="form-control form-control-modern" placeholder="ABC1D23" maxlength="7" title="Placa no formato brasileiro (ex: ABC1D23 ou ABC1234)" style="text-transform: uppercase;">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label-modern">Placa da Carreta 1</label>
                    <input type="text" id="placa_carreta1" class="form-control form-control-modern" placeholder="XYZ4W56" maxlength="7" title="Placa no formato brasileiro (ex: ABC1D23 ou ABC1234)" style="text-transform: uppercase;">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label-modern">Placa da Carreta 2</label>
                    <input type="text" id="placa_carreta2" class="form-control form-control-modern" placeholder="QRS7T89" maxlength="7" title="Placa no formato brasileiro (ex: ABC1D23 ou ABC1234)" style="text-transform: uppercase;">
                  </div>
                  <div class="col-md-3">
                    <label class="form-label-modern">Placa da Carreta 3</label>
                    <input type="text" id="placa_carreta3" class="form-control form-control-modern" placeholder="LMN8P10" maxlength="7" title="Placa no formato brasileiro (ex: ABC1D23 ou ABC1234)" style="text-transform: uppercase;">
                  </div>
                </div>
              </div>

              <!-- Configura√ß√£o do Sistema -->
              <div class="form-section">
                <div class="section-title">
                  <i class="fas fa-cog"></i>
                  Configura√ß√£o do Sistema
                </div>
                <div class="row g-3">
                  <div class="col-md-12">
                    <label class="form-label-modern">Status</label>
                    <select id="status" class="form-select form-select-modern">
                      <option value="ativo">Ativo</option>
                      <option value="inativo">Inativo</option>
                      <option value="bloqueado">Bloqueado</option>
                    </select>
                  </div>
                </div>
              </div>

              <!-- A√ß√µes do Formul√°rio -->
              <div class="d-flex gap-3 justify-content-end mt-4">
                <button type="button" class="btn btn-modern btn-modern-warning" id="btnLimpar">
                  <i class="fas fa-broom me-2"></i>Limpar
                </button>
                <button type="submit" class="btn btn-modern btn-modern-success">
                  <i class="fas fa-save me-2"></i>Cadastrar Motorista
                </button>
              </div>
            </form>
          </div>
        </div>
      </div>

      <!-- Aba: Importa√ß√£o em Lote -->
      <div class="tab-pane" id="importacao">
        <div class="row">
          <div class="col-md-6">
            <div class="modern-card h-100">
              <div class="card-header">
                <i class="fas fa-file-import me-2"></i>Importar do CSV
              </div>
              <div class="card-body">
                <div class="upload-area" id="uploadArea">
                  <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                  </div>
                  <h5 class="fw-bold mb-2">Arraste ou clique para upload</h5>
                  <p class="text-muted mb-3">Suporte para arquivos CSV</p>
                  <input type="file" id="csvFile" class="d-none" accept=".csv">
                  <button class="btn btn-modern btn-modern-primary" id="btnSelecionarArquivo">
                    <i class="fas fa-folder-open me-2"></i>Selecionar Arquivo
                  </button>
                </div>
                
                <div class="mt-4">
                  <label class="form-label-modern">Op√ß√µes de Importa√ß√£o</label>
                  <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="sobrescrever" checked>
                    <label class="form-check-label" for="sobrescrever">
                      Sobrescrever contatos duplicados
                    </label>
                  </div>
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="manter_inativos">
                    <label class="form-check-label" for="manter_inativos">
                      Manter contatos inativos existentes
                    </label>
                  </div>
                </div>
                
                <button class="btn btn-modern btn-modern-success w-100 mt-4" id="btnImportarCSV">
                  <i class="fas fa-upload me-2"></i>Importar CSV
                </button>
                
                <div class="mt-3 text-center">
                  <a href="#" class="btn btn-link text-decoration-none" id="btnTemplateCSV">
                    <i class="fas fa-download me-1"></i>Baixar Template CSV
                  </a>
                </div>
              </div>
            </div>
          </div>
          
          <div class="col-md-6">
            <div class="modern-card h-100">
              <div class="card-header">
                <i class="fas fa-sync me-2"></i>Importa√ß√£o Autom√°tica
              </div>
              <div class="card-body">
                <p class="card-text">Importa√ß√£o autom√°tica do arquivo <code>contatos.csv</code> do servidor.</p>
                
                <div class="mb-4">
                  <label class="form-label-modern">Arquivo Atual</label>
                  <div class="input-group">
                    <input type="text" class="form-control form-control-modern" value="contatos.csv" readonly>
                    <button class="btn btn-modern btn-modern-info" type="button" id="btnVerificarCSV">
                      <i class="fas fa-search"></i>
                    </button>
                  </div>
                </div>
                
                <button class="btn btn-modern btn-modern-info w-100 mb-3" id="btnImportarAuto">
                  <i class="fas fa-sync me-2"></i>Importar do Arquivo Padr√£o
                </button>
                
                <div id="statusImportacao" class="mt-3"></div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="modern-card mt-4">
          <div class="card-header">
            <i class="fas fa-history me-2"></i>Hist√≥rico de Importa√ß√£o
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-modern">
                <thead>
                  <tr>
                    <th>Data/Hora</th>
                    <th>Arquivo</th>
                    <th>Registros</th>
                    <th>Inseridos</th>
                    <th>Atualizados</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="historicoImportacao">
                  <tr>
                    <td colspan="6" class="text-center text-muted py-4">
                      <i class="fas fa-history fa-2x mb-3 d-block"></i>
                      Nenhum hist√≥rico de importa√ß√£o
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- Aba: Gest√£o de Contatos -->
      <div class="tab-pane" id="gestao" style="margin-top: 0; padding-top: 0;">
        <div class="modern-card" style="margin-top: 0;">
          <div class="card-header d-flex justify-content-between align-items-center">
            <span><i class="fas fa-users me-2"></i>Gest√£o de Motoristas Cadastrados</span>
            <div class="d-flex gap-2">
              <button class="btn btn-modern btn-modern-primary btn-sm" id="btnAtualizar">
                <i class="fas fa-sync me-1"></i>Atualizar
              </button>
            </div>
          </div>
          <div class="card-body" style="padding-top: 1.5rem;">
            
            <!-- Filtros R√°pidos Modernos -->
            <div class="row g-3 mb-4">
              <div class="col-md-3">
                <label class="form-label-modern">Classe do Ve√≠culo</label>
                <select id="filtroClasse" class="form-select form-select-modern">
                  <option value="">Todas as classes</option>
                  <option value="leve">Leve</option>
                  <option value="medio">M√©dio</option>
                  <option value="pesado">Pesado</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label-modern">Estado</label>
                <select id="filtroEstado" class="form-select form-select-modern">
                  <option value="">Todos os estados</option>
                  <!-- Estados ser√£o carregados via JavaScript -->
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label-modern">Status</label>
                <select id="filtroStatus" class="form-select form-select-modern">
                  <option value="">Todos os status</option>
                  <option value="ativo">Ativo</option>
                  <option value="inativo">Inativo</option>
                  <option value="bloqueado">Bloqueado</option>
                </select>
              </div>
              <div class="col-md-3">
                <label class="form-label-modern">Buscar</label>
                <div class="input-group">
                  <input type="text" id="filtroBusca" class="form-control form-control-modern" placeholder="Nome, telefone...">
                  <button class="btn btn-modern btn-modern-primary" type="button" id="btnBuscar">
                    <i class="fas fa-search"></i>
                  </button>
                </div>
              </div>
            </div>

            <!-- Cards de Estat√≠sticas R√°pidas -->
            <div class="row g-3 mb-4" id="cardsEstatisticas">
              <!-- Ser√° preenchido via JavaScript -->
            </div>

            <!-- Tabela de Contatos Moderna -->
            <div class="table-responsive">
              <table class="table table-modern table-hover">
                <thead>
                  <tr>
                    <th width="200">Motorista</th>
                    <th width="120">Contato</th>
                    <th width="100">Ve√≠culo</th>
                    <th width="120">Localiza√ß√£o</th>
                    <th width="80">Status</th>
                    <th width="100" class="text-center">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="tabelaContatos">
                  <tr>
                    <td colspan="6" class="text-center text-muted py-5">
                      <i class="fas fa-users fa-3x mb-3 d-block"></i>
                      <h5 class="fw-bold">Nenhum motorista cadastrado</h5>
                      <p class="text-muted">Comece cadastrando um novo motorista</p>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>

            <!-- Pagina√ß√£o e Info -->
            <div class="d-flex justify-content-between align-items-center mt-4">
              <div class="text-muted small" id="infoPaginacao">
                Mostrando 0 de 0 registros
              </div>
              <nav aria-label="Navega√ß√£o de p√°ginas">
                <ul class="pagination pagination-sm" id="paginacao">
                  <!-- Pagina√ß√£o ser√° gerada via JavaScript -->
                </ul>
              </nav>
            </div>
          </div>
        </div>
      </div>

    </div>
  </main>
</div>

<div id="treinamentoCadastroOverlay" class="treinamento-overlay">
  <div class="treinamento-overlay-card">
    <div class="mb-3">
      <span class="badge"><i class="fas fa-graduation-cap me-2"></i>Treinamento obrigat√≥rio</span>
    </div>
    <h2>Conclua o treinamento de cadastro</h2>
    <p>
      Por seguran√ßa, somente usu√°rios com o treinamento <strong>"Cadastro de Motoristas"</strong> conclu√≠do podem inserir ou editar registros.
      Complete o treinamento e valide para liberar o acesso.
    </p>
    <div class="treinamento-overlay-actions">
      <a href="treinamento-cadastro-motoristas.html" target="_blank" class="btn btn-training">
        <i class="fas fa-play-circle me-2"></i> Fazer treinamento agora
      </a>
      <button type="button" class="btn btn-refresh" id="btnReverificarTreinamentoCadastro">
        <i class="fas fa-rotate-right me-2"></i> J√° conclu√≠ / Revalidar
      </button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
// ========== CONFIGURA√á√ïES GLOBAIS ==========
const SERVER_URL = window.location.origin;
let todosContatos = [];
let contatosFiltrados = [];
let currentPage = 1;
const pageSize = 20;
const TREINAMENTO_CADASTRO_SLUG = 'cadastro_motoristas';
let treinamentoCadastroConcluido = false;

// Mapeamentos inteligentes
const tiposVeiculo = {
  leve: ['3/4', 'Fiorino', 'Toco', 'VLC'],
  medio: ['Bitruck', 'Truck'],
  pesado: ['Bitrem', 'Carreta', 'Carreta LS', 'Rodotrem', 'Vanderleia']
};

const bodyworkByClass = {
  leve: ['bau', 'bau_frigorifico', 'bau_refrigerado', 'cacamba', 'prancha'],
  medio: ['bau', 'bau_frigorifico', 'sider', 'graneleiro', 'plataforma', 'basculante', 'cacamba'],
  pesado: ['bau', 'sider', 'graneleiro', 'grade_baixa', 'bitrem', 'carreta', 'carreta_ls', 'rodotrem', 'vanderleia', 'apenas_cavalo', 'cegonheiro', 'gaiola', 'tanque', 'porta_container_20', 'porta_container_40', 'basculante', 'cacamba']
};

const tiposCarroceriaMap = {
  bau: 'Ba√∫',
  bau_frigorifico: 'Ba√∫ Frigor√≠fico',
  bau_refrigerado: 'Ba√∫ Refrigerado',
  sider: 'Sider',
  cacamba: 'Ca√ßamba',
  caamba: 'Ca√ßamba', // Varia√ß√£o quando o √ß foi removido incorretamente
  graneleiro: 'Graneleiro',
  plataforma: 'Plataforma',
  prancha: 'Prancha',
  bitrem: 'Bitrem',
  carreta: 'Carreta',
  carreta_ls: 'Carreta LS',
  rodotrem: 'Rodotrem',
  vanderleia: 'Vanderleia',
  apenas_cavalo: 'Apenas Cavalo',
  cegonheiro: 'Cegonheiro',
  gaiola: 'Gaiola',
  tanque: 'Tanque',
  grade_baixa: 'GRADE BAIXA',
  basculante: 'BASCULANTE',
  porta_container_20: 'PORTA CONTAINER 20',
  porta_container_40: 'PORTA CONTAINER 40'
};

const estados = [
  'AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA', 
  'MT', 'MS', 'MG', 'PA', 'PB', 'PR', 'PE', 'PI', 'RJ', 'RN', 
  'RS', 'RO', 'RR', 'SC', 'SP', 'SE', 'TO'
];

function obterUsuarioAtual() {
  try {
    const usuarioLocal = localStorage.getItem('loggedInUser');
    if (usuarioLocal) {
      const parsed = JSON.parse(usuarioLocal);
      return {
        email: parsed.email || parsed.username || parsed.user || null,
        id: parsed.id || parsed.user_id || parsed.userId || null,
        nome: parsed.nome || parsed.name || null
      };
    }
  } catch (error) {
    console.warn('‚ö†Ô∏è N√£o foi poss√≠vel ler loggedInUser do localStorage:', error);
  }
  return null;
}

function bloquearCadastroTreinamento() {
  treinamentoCadastroConcluido = false;
  document.getElementById('treinamentoCadastroOverlay')?.classList.add('ativo');
  document.body.classList.add('treinamento-bloqueado');
}

function liberarCadastroTreinamento() {
  treinamentoCadastroConcluido = true;
  document.getElementById('treinamentoCadastroOverlay')?.classList.remove('ativo');
  document.body.classList.remove('treinamento-bloqueado');
}

function exigirTreinamentoCadastro() {
  if (!treinamentoCadastroConcluido) {
    mostrarErro('Finalize o treinamento "Cadastro de Motoristas" antes de continuar.');
    return false;
  }
  return true;
}

async function verificarTreinamentoCadastro(silencioso = false) {
  try {
    const usuarioAtual = obterUsuarioAtual();
    const headers = {};
    if (usuarioAtual?.email) {
      headers['X-User-Email'] = usuarioAtual.email;
    }
    if (usuarioAtual?.id) {
      headers['X-User-Id'] = usuarioAtual.id;
    }

    const response = await fetch(`/api/treinamentos/status?slug=${encodeURIComponent(TREINAMENTO_CADASTRO_SLUG)}`, {
      method: 'GET',
      credentials: 'include',
      headers
    });

    if (!response.ok) {
      console.warn('‚ö†Ô∏è Falha ao verificar treinamento de cadastro:', response.status);
      bloquearCadastroTreinamento();
      if (!silencioso) {
        if (response.status === 401) {
          mostrarAviso('Fa√ßa login novamente para validar o treinamento de cadastro.');
        } else {
          mostrarAviso('N√£o foi poss√≠vel validar o treinamento de cadastro. Tente novamente ap√≥s concluir o curso.');
        }
      }
      return;
    }

    const data = await response.json();
    if (data?.concluido) {
      liberarCadastroTreinamento();
      if (!silencioso) {
        mostrarSucesso('Treinamento de cadastro validado! Voc√™ pode utilizar o m√≥dulo de cadastro.');
      }
    } else {
      bloquearCadastroTreinamento();
      if (!silencioso) {
        mostrarAviso('Finalize o treinamento "Cadastro de Motoristas" antes de utilizar o m√≥dulo.');
      }
    }
  } catch (error) {
    console.error('‚ùå Erro ao verificar treinamento de cadastro:', error);
    bloquearCadastroTreinamento();
    if (!silencioso) {
      mostrarAviso('Erro ao verificar o treinamento. Tente novamente em instantes.');
    }
  }
}

// ========== SUPABASE CONFIGURATION ==========
let SUPABASE_URL = '';
let SUPABASE_ANON_KEY = '';
let supabaseClient = null; // Renomeado para evitar conflito com poss√≠vel vari√°vel global do Supabase

// ========== INICIALIZA√á√ÉO SEGURA DO SUPABASE ==========
async function inicializarSupabase() {
    try {
        const response = await fetch('/api/supabase-config');
        if (!response.ok) throw new Error('Erro ao obter configura√ß√µes do Supabase');
        
        const config = await response.json();
        SUPABASE_URL = config.supabaseUrl;
        SUPABASE_ANON_KEY = config.supabaseAnonKey;
        
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        window.supabase = supabaseClient; // Manter compatibilidade com c√≥digo que usa window.supabase
        
        console.log('‚úÖ Supabase inicializado com sucesso');
        
        // Inicializar chat IA ap√≥s Supabase estar pronto
        if (window.inicializarChatIA) {
            window.inicializarChatIA();
        }
        
        return true;
    } catch (error) {
        console.error('‚ùå Erro ao inicializar Supabase:', error);
        return false;
    }
}

// ========== SISTEMA DE TABS CUSTOMIZADO ==========
class TabSystem {
  constructor() {
    this.tabs = document.querySelectorAll('.nav-modern .nav-link');
    this.panes = document.querySelectorAll('.tab-pane');
    this.init();
  }

  init() {
    this.tabs.forEach(tab => {
      tab.addEventListener('click', (e) => {
        e.preventDefault();
        this.showTab(tab.dataset.tab);
      });
    });
  }

  showTab(tabId) {
    // Bloquear acesso √† aba de importa√ß√£o para usu√°rios n√£o-admin
    if (tabId === 'importacao' && !userIsAdmin) {
      mostrarErro('Acesso negado. Apenas administradores podem acessar a importa√ß√£o em lote.');
      return;
    }
    
    this.tabs.forEach(tab => tab.classList.remove('active'));
    this.panes.forEach(pane => pane.classList.remove('active'));

    const activeTab = document.querySelector(`.nav-link[data-tab="${tabId}"]`);
    if (activeTab) activeTab.classList.add('active');

    const activePane = document.getElementById(tabId);
    if (activePane) {
      activePane.classList.add('active');
      
      // Scroll para o topo da aba quando for a aba de gest√£o
      if (tabId === 'gestao') {
        setTimeout(() => {
          activePane.scrollIntoView({ behavior: 'smooth', block: 'start' });
          // Tamb√©m garantir scroll para o topo da p√°gina
          window.scrollTo({ top: 0, behavior: 'smooth' });
        }, 100);
      }
    }
  }
}

// ========== INICIALIZA√á√ÉO SEGURA ==========
async function inicializarAplicacao() {
  try {
    bloquearCadastroTreinamento();
    // üîê Verificar permiss√£o de acesso
    const temPermissao = await verificarEAplicarPermissao('cadastro');
    if (!temPermissao) {
      console.log('‚ùå Sem permiss√£o para acessar cadastro');
      return; // A fun√ß√£o verificarEAplicarPermissao j√° redireciona
    }
    
    const supabaseInicializado = await inicializarSupabase();
    if (!supabaseInicializado) {
      console.error('‚ùå Falha ao inicializar Supabase');
      return;
    }
    
    await carregarInformacoesUsuario();
    new TabSystem();
    inicializarFormulario();
    adicionarCSSPersonalizado();
    inicializarEventListeners();
    await carregarContatos();
    carregarFiltros();
    await carregarEstatisticasSistema();
    await verificarTreinamentoCadastro(true);
    
    console.log('‚úÖ Sistema de Cadastro de Motoristas inicializado com sucesso!');
  } catch (error) {
    console.error('‚ùå Erro na inicializa√ß√£o:', error);
    mostrarErro('Erro ao inicializar o sistema: ' + error.message);
  }
}

// ========== FUN√á√ïES DE USU√ÅRIO ==========
let userIsAdmin = false;

async function carregarInformacoesUsuario() {
  try {
    const userData = localStorage.getItem('loggedInUser');
    if (!userData) {
      window.location.href = 'login.html';
      return;
    }

    const user = JSON.parse(userData);
    document.getElementById('currentUser').textContent = user.nome || user.email || 'Usu√°rio';
    
    // Verificar se o usu√°rio √© admin
    userIsAdmin = await verificarSeUsuarioAdmin(user);
    
    // Ocultar e desabilitar completamente a aba de importa√ß√£o se n√£o for admin
    if (!userIsAdmin) {
      const abaImportacao = document.querySelector('a[data-tab="importacao"]');
      const conteudoImportacao = document.getElementById('importacao');
      
      if (abaImportacao) {
        abaImportacao.style.display = 'none';
        abaImportacao.remove(); // Remover completamente do DOM
      }
      
      if (conteudoImportacao) {
        conteudoImportacao.style.display = 'none';
        conteudoImportacao.remove(); // Remover completamente do DOM
      }
      
      // Desabilitar todos os elementos relacionados √† importa√ß√£o
      const btnSelecionarArquivo = document.getElementById('btnSelecionarArquivo');
      const btnImportarCSV = document.getElementById('btnImportarCSV');
      const btnTemplateCSV = document.getElementById('btnTemplateCSV');
      const uploadArea = document.getElementById('uploadArea');
      
      if (btnSelecionarArquivo) {
        btnSelecionarArquivo.disabled = true;
        btnSelecionarArquivo.style.display = 'none';
      }
      
      if (btnImportarCSV) {
        btnImportarCSV.disabled = true;
        btnImportarCSV.style.display = 'none';
      }
      
      if (btnTemplateCSV) {
        btnTemplateCSV.style.display = 'none';
      }
      
      if (uploadArea) {
        uploadArea.style.pointerEvents = 'none';
        uploadArea.style.opacity = '0.5';
      }
    }
    
    // Controle de acesso j√° √© feito por verificarEAplicarPermissao('cadastro') na inicializa√ß√£o
  } catch (error) {
    console.error('Erro de autentica√ß√£o:', error);
    window.location.href = 'login.html';
  }
}

async function verificarSeUsuarioAdmin(user) {
  try {
    // Primeiro, tentar usar a fun√ß√£o do permissions.js se dispon√≠vel
    if (typeof window.isUserAdmin === 'function') {
      const adminCheck = window.isUserAdmin();
      if (adminCheck) {
        console.log('‚úÖ Usu√°rio √© admin (verificado via permissions.js)');
        return true;
      }
    }
    
    // Verificar role no localStorage
    if (user.role === 'admin' || user.isAdmin === true) {
      console.log('‚úÖ Usu√°rio √© admin (verificado via localStorage)');
      return true;
    }
    
    // Verificar no Supabase se dispon√≠vel
    if (window.supabase && user.id) {
      try {
        const { data: profile, error } = await window.supabase
          .from('user_profiles')
          .select('role')
          .eq('id', user.id)
          .single();
        
        if (!error && profile && profile.role === 'admin') {
          console.log('‚úÖ Usu√°rio √© admin (verificado via Supabase)');
          return true;
        }
      } catch (e) {
        console.warn('Erro ao verificar role no Supabase:', e);
      }
    }
    
    console.log('‚ùå Usu√°rio N√ÉO √© admin');
    return false;
  } catch (error) {
    console.error('Erro ao verificar se usu√°rio √© admin:', error);
    return false;
  }
}

// ========== SISTEMA DE CADASTRO INTELIGENTE ==========
function inicializarFormulario() {
  const classes = document.querySelectorAll('.vehicle-class');
  classes.forEach(classe => {
    classe.addEventListener('click', function() {
      selecionarClasseCadastro(this.dataset.class);
    });
  });
}

function selecionarClasseCadastro(classe) {
  document.querySelectorAll('.vehicle-class').forEach(el => el.classList.remove('active'));
  document.querySelector(`.vehicle-class[data-class="${classe}"]`).classList.add('active');
  
  atualizarTiposVeiculo(classe);
  atualizarTiposCarroceria(classe);
  
  document.getElementById('tipo_veiculo').disabled = false;
  document.getElementById('tipo_carroceria').disabled = false;
}

function atualizarTiposVeiculo(classe) {
  const select = document.getElementById('tipo_veiculo');
  select.innerHTML = '<option value="">Selecione o tipo</option>';
  
  if (classe && tiposVeiculo[classe]) {
    tiposVeiculo[classe].forEach(tipo => {
      const option = document.createElement('option');
      option.value = tipo.toLowerCase().replace(/ /g, '_');
      option.textContent = tipo;
      select.appendChild(option);
    });
  }
}

function atualizarTiposCarroceria(classe) {
  const select = document.getElementById('tipo_carroceria');
  select.innerHTML = '<option value="">Selecione o tipo</option>';
  
  if (classe && bodyworkByClass[classe]) {
    bodyworkByClass[classe].forEach(tipo => {
      if (tiposCarroceriaMap[tipo]) {
        const option = document.createElement('option');
        option.value = tipo;
        option.textContent = tiposCarroceriaMap[tipo];
        select.appendChild(option);
      }
    });
  }
}

function inicializarEventListeners() {
  const formCadastro = document.getElementById('formCadastro');
  if (formCadastro) {
    formCadastro.addEventListener('submit', async function(e) {
      e.preventDefault();
      if (this.dataset.editing) {
        await atualizarMotorista();
      } else {
        await cadastrarMotorista();
      }
    });
  }

  const btnLogout = document.getElementById('btnLogout');
  if (btnLogout) btnLogout.addEventListener('click', fazerLogout);

  const btnLimpar = document.getElementById('btnLimpar');
  if (btnLimpar) {
    btnLimpar.addEventListener('click', function() {
      limparFormulario();
      delete document.getElementById('formCadastro').dataset.editing;
    });
  }

  // Adicionar listeners para filtros
  const filtros = ['filtroClasse', 'filtroEstado', 'filtroStatus', 'filtroBusca'];
  filtros.forEach(filtroId => {
    const elemento = document.getElementById(filtroId);
      if (elemento) {
        elemento.addEventListener('change', aplicarFiltros);
      elemento.addEventListener('input', aplicarFiltros);
      }
    });

  // Bot√£o buscar
    const btnBuscar = document.getElementById('btnBuscar');
    if (btnBuscar) {
      btnBuscar.addEventListener('click', aplicarFiltros);
  }
  
  // Event listeners para importa√ß√£o CSV
  const btnSelecionarArquivo = document.getElementById('btnSelecionarArquivo');
  const csvFile = document.getElementById('csvFile');
  const btnImportarCSV = document.getElementById('btnImportarCSV');
  const btnTemplateCSV = document.getElementById('btnTemplateCSV');
  const uploadArea = document.getElementById('uploadArea');
  
  if (btnSelecionarArquivo && csvFile) {
    btnSelecionarArquivo.addEventListener('click', (event) => {
      // Verificar se √© admin antes de permitir selecionar arquivo
      if (!userIsAdmin) {
        event.preventDefault();
        mostrarErro('Acesso negado. Apenas administradores podem acessar a importa√ß√£o em lote.');
        return;
      }
      
      if (!exigirTreinamentoCadastro()) {
        event.preventDefault();
        return;
      }
      csvFile.click();
    });
    
    csvFile.addEventListener('change', (e) => {
      // Verificar se √© admin antes de permitir selecionar arquivo
      if (!userIsAdmin) {
        e.target.value = '';
        mostrarErro('Acesso negado. Apenas administradores podem acessar a importa√ß√£o em lote.');
        return;
      }
      
      if (!exigirTreinamentoCadastro()) {
        e.target.value = '';
        return;
      }
      const file = e.target.files[0];
      if (file) {
        const fileName = file.name;
        uploadArea.innerHTML = `
          <div class="upload-icon text-success">
            <i class="fas fa-check-circle"></i>
          </div>
          <h5 class="fw-bold mb-2">${fileName}</h5>
          <p class="text-muted mb-3">Arquivo selecionado com sucesso</p>
          <button class="btn btn-modern btn-modern-secondary btn-sm" onclick="document.getElementById('csvFile').value=''; location.reload();">
            <i class="fas fa-times me-2"></i>Remover
          </button>
        `;
      }
    });
  }
  
  if (uploadArea && csvFile) {
    // Drag and drop
    uploadArea.addEventListener('dragover', (e) => {
      e.preventDefault();
      // Verificar se √© admin antes de permitir drag over
      if (!userIsAdmin) {
        return;
      }
      if (!treinamentoCadastroConcluido) return;
      uploadArea.style.borderColor = '#667eea';
      uploadArea.style.backgroundColor = '#f0f4ff';
    });
    
    uploadArea.addEventListener('dragleave', () => {
      if (!userIsAdmin) return;
      if (!treinamentoCadastroConcluido) return;
      uploadArea.style.borderColor = '';
      uploadArea.style.backgroundColor = '';
    });
    
    uploadArea.addEventListener('drop', (e) => {
      e.preventDefault();
      
      // Verificar se √© admin antes de permitir drop
      if (!userIsAdmin) {
        mostrarErro('Acesso negado. Apenas administradores podem acessar a importa√ß√£o em lote.');
        return;
      }
      
      if (!exigirTreinamentoCadastro()) {
        return;
      }
      uploadArea.style.borderColor = '';
      uploadArea.style.backgroundColor = '';
      
      const file = e.dataTransfer.files[0];
      if (file && file.name.endsWith('.csv')) {
        csvFile.files = e.dataTransfer.files;
        const fileName = file.name;
        uploadArea.innerHTML = `
          <div class="upload-icon text-success">
            <i class="fas fa-check-circle"></i>
          </div>
          <h5 class="fw-bold mb-2">${fileName}</h5>
          <p class="text-muted mb-3">Arquivo selecionado com sucesso</p>
          <button class="btn btn-modern btn-modern-secondary btn-sm" onclick="document.getElementById('csvFile').value=''; location.reload();">
            <i class="fas fa-times me-2"></i>Remover
          </button>
        `;
      } else {
        mostrarErro('Por favor, selecione um arquivo CSV v√°lido');
      }
    });
  }
  
  if (btnImportarCSV) {
    btnImportarCSV.addEventListener('click', async () => {
      // Verificar se √© admin
      if (!userIsAdmin) {
        mostrarErro('Acesso negado. Apenas administradores podem importar cadastros em lote.');
        return;
      }
      
      if (!exigirTreinamentoCadastro()) {
        return;
      }
      const file = csvFile?.files[0];
      if (!file) {
        mostrarErro('Por favor, selecione um arquivo CSV primeiro');
        return;
      }
      
      await importarCSV(file);
    });
  }
  
  if (btnTemplateCSV) {
    btnTemplateCSV.addEventListener('click', (e) => {
      e.preventDefault();
      
      // Verificar se √© admin antes de permitir baixar template
      if (!userIsAdmin) {
        mostrarErro('Acesso negado. Apenas administradores podem acessar a importa√ß√£o em lote.');
        return;
      }
      
      baixarTemplateCSV();
    });
  }

  // ========== FORMATA√á√ÉO E VALIDA√á√ÉO EM TEMPO REAL ==========
  // CNH: apenas n√∫meros
  const inputCNH = document.getElementById('cnh');
  if (inputCNH) {
    inputCNH.addEventListener('input', function(e) {
      this.value = this.value.replace(/\D/g, '');
    });
  }

  // Telefones: apenas n√∫meros
  const inputTelefone1 = document.getElementById('telefone1');
  const inputTelefone2 = document.getElementById('telefone2');
  if (inputTelefone1) {
    inputTelefone1.addEventListener('input', function(e) {
      this.value = this.value.replace(/\D/g, '');
    });
  }
  if (inputTelefone2) {
    inputTelefone2.addEventListener('input', function(e) {
      this.value = this.value.replace(/\D/g, '');
    });
  }

  // Placas: converter para mai√∫sculas e remover caracteres inv√°lidos
  const placas = ['placa_cavalo', 'placa_carreta1', 'placa_carreta2', 'placa_carreta3'];
  placas.forEach(placaId => {
    const inputPlaca = document.getElementById(placaId);
    if (inputPlaca) {
      inputPlaca.addEventListener('input', function(e) {
        // Converter para mai√∫sculas e remover espa√ßos
        let valor = this.value.toUpperCase().replace(/\s/g, '');
        // Remover caracteres inv√°lidos (apenas letras e n√∫meros)
        valor = valor.replace(/[^A-Z0-9]/g, '');
        this.value = valor;
      });
    }
  });

  const btnReverificarTreinamentoCadastro = document.getElementById('btnReverificarTreinamentoCadastro');
  if (btnReverificarTreinamentoCadastro) {
    btnReverificarTreinamentoCadastro.addEventListener('click', async () => {
      btnReverificarTreinamentoCadastro.disabled = true;
      const textoOriginal = btnReverificarTreinamentoCadastro.innerHTML;
      btnReverificarTreinamentoCadastro.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Verificando...';
      await verificarTreinamentoCadastro();
      btnReverificarTreinamentoCadastro.disabled = false;
      btnReverificarTreinamentoCadastro.innerHTML = textoOriginal;
    });
  }

  // Event listeners para exporta√ß√£o
}

// ========== CADASTRO DE MOTORISTAS (SUPABASE) ==========
async function cadastrarMotorista() {
  if (!exigirTreinamentoCadastro()) return;
  const classeSelecionada = document.querySelector('.vehicle-class.active');
  
  if (!classeSelecionada) {
    mostrarErro('Selecione a classe do ve√≠culo');
    return;
  }
  
  const dados = {
    nome: document.getElementById('nome').value.trim(),
    cnh: document.getElementById('cnh').value.trim() || null,
    categoria_cnh: document.getElementById('categoria_cnh').value || null,
    telefone1: document.getElementById('telefone1').value.trim(),
    telefone2: document.getElementById('telefone2').value.trim() || null,
    estado: document.getElementById('estado').value || null,
    tipo_veiculo: document.getElementById('tipo_veiculo').value,
    tipo_carroceria: document.getElementById('tipo_carroceria').value,
    placa_cavalo: document.getElementById('placa_cavalo').value.trim() || null,
    placa_carreta1: document.getElementById('placa_carreta1').value.trim() || null,
    placa_carreta2: document.getElementById('placa_carreta2').value.trim() || null,
    placa_carreta3: document.getElementById('placa_carreta3').value.trim() || null,
    status: document.getElementById('status').value || 'ativo'
  };

  if (!dados.nome || !dados.telefone1 || !dados.tipo_veiculo || !dados.tipo_carroceria) {
    mostrarErro('Preencha todos os campos obrigat√≥rios (*)');
    return;
  }

  const validarTelefone = (valor, campo) => {
    if (!valor) return null;
    const apenasNumeros = valor.replace(/\D/g, '');

    if (apenasNumeros.length === 13 && apenasNumeros.startsWith('55')) {
      return apenasNumeros;
    }

    if (apenasNumeros.length === 11) {
      return '55' + apenasNumeros;
    }

    mostrarErro(`O ${campo} deve estar no formato 55+DDD+9+N√∫mero (ex: 5581999999999). Informe apenas n√∫meros.`);
    throw new Error('Telefone inv√°lido');
  };

  const validarCNH = (valor) => {
    if (!valor) return null; // CNH √© opcional
    const apenasNumeros = valor.replace(/\D/g, '');
    if (apenasNumeros.length !== 11) {
      mostrarErro('CNH deve conter exatamente 11 d√≠gitos num√©ricos');
      throw new Error('CNH inv√°lida');
    }
    return apenasNumeros;
  };

  const validarPlaca = (valor, campo) => {
    if (!valor) return null; // Placas s√£o opcionais
    const placaLimpa = valor.toUpperCase().replace(/\s/g, '').replace(/[^A-Z0-9]/g, '');
    
    // Formato antigo: ABC1234 (3 letras + 4 n√∫meros)
    const formatoAntigo = /^[A-Z]{3}[0-9]{4}$/;
    // Formato novo: ABC1D23 (3 letras + 1 n√∫mero + 1 letra + 2 n√∫meros)
    const formatoNovo = /^[A-Z]{3}[0-9][A-Z0-9][0-9]{2}$/;
    
    if (placaLimpa.length === 7 && (formatoAntigo.test(placaLimpa) || formatoNovo.test(placaLimpa))) {
      return placaLimpa;
    }
    
    mostrarErro(`A ${campo} deve estar no formato brasileiro (ex: ABC1234 ou ABC1D23)`);
    throw new Error('Placa inv√°lida');
  };

  let telefone1Normalizado;
  let telefone2Normalizado = null;
  let cnhNormalizada = null;
  let placaCavaloNormalizada = null;
  let placaCarreta1Normalizada = null;
  let placaCarreta2Normalizada = null;
  let placaCarreta3Normalizada = null;

  try {
    telefone1Normalizado = validarTelefone(dados.telefone1, 'Telefone 1');
    if (!telefone1Normalizado) {
      mostrarErro('Telefone 1 √© obrigat√≥rio e deve estar no formato correto');
      return;
    }

    if (dados.telefone2) {
      telefone2Normalizado = validarTelefone(dados.telefone2, 'Telefone 2');
    }

    if (dados.cnh) {
      cnhNormalizada = validarCNH(dados.cnh);
    }

    if (dados.placa_cavalo) {
      placaCavaloNormalizada = validarPlaca(dados.placa_cavalo, 'Placa do Cavalo');
    }

    if (dados.placa_carreta1) {
      placaCarreta1Normalizada = validarPlaca(dados.placa_carreta1, 'Placa da Carreta 1');
    }

    if (dados.placa_carreta2) {
      placaCarreta2Normalizada = validarPlaca(dados.placa_carreta2, 'Placa da Carreta 2');
    }

    if (dados.placa_carreta3) {
      placaCarreta3Normalizada = validarPlaca(dados.placa_carreta3, 'Placa da Carreta 3');
    }
  } catch (erroValidacao) {
    console.warn('Valida√ß√£o interrompida:', erroValidacao.message);
    return;
  }

  // Verificar se o telefone j√° existe no banco de dados
  try {
    const { data: telefoneExistente, error: erroBusca } = await supabase
      .from('motoristas')
      .select('id, nome, telefone1, telefone2')
      .or(`telefone1.eq.${telefone1Normalizado},telefone2.eq.${telefone1Normalizado}`);

    if (erroBusca) throw erroBusca;

    if (telefoneExistente && telefoneExistente.length > 0) {
      const motoristaExistente = telefoneExistente[0];
      mostrarErro(`‚ùå O n√∫mero de telefone ${telefone1Normalizado} j√° est√° cadastrado para o motorista: ${motoristaExistente.nome || 'N/A'}`);
      return;
    }

    // Verificar telefone2 se foi informado
    if (telefone2Normalizado) {
      const { data: telefone2Existente, error: erroBusca2 } = await supabase
        .from('motoristas')
        .select('id, nome, telefone1, telefone2')
        .or(`telefone1.eq.${telefone2Normalizado},telefone2.eq.${telefone2Normalizado}`);

      if (erroBusca2) throw erroBusca2;

      if (telefone2Existente && telefone2Existente.length > 0) {
        const motoristaExistente = telefone2Existente[0];
        mostrarErro(`‚ùå O n√∫mero de telefone ${telefone2Normalizado} j√° est√° cadastrado para o motorista: ${motoristaExistente.nome || 'N/A'}`);
        return;
      }
    }
  } catch (erroVerificacao) {
    console.error('Erro ao verificar telefone existente:', erroVerificacao);
    mostrarErro('‚ùå Erro ao verificar se o telefone j√° existe no banco de dados');
    return;
  }

  const motoristaData = {
    ...dados,
    classe_veiculo: classeSelecionada.dataset.class,
    data_cadastro: new Date().toISOString(),
    data_atualizacao: new Date().toISOString(),
    usuario_id: await getCurrentUserId(),
    created_by: await getCurrentUserId(),
    created_by_departamento: await getCurrentUserDepartment(),
    telefone1: telefone1Normalizado,
    telefone2: telefone2Normalizado,
    cnh: cnhNormalizada,
    placa_cavalo: placaCavaloNormalizada,
    placa_carreta1: placaCarreta1Normalizada,
    placa_carreta2: placaCarreta2Normalizada,
    placa_carreta3: placaCarreta3Normalizada
  };

  try {
    const { data, error } = await supabaseClient.from('motoristas').insert([motoristaData]).select();

    if (error) throw error;

    mostrarSucesso('‚úÖ Motorista cadastrado com sucesso! ID: ' + data[0].id);
    limparFormulario();
    await carregarContatos();
    
  } catch (error) {
    console.error('‚ùå Erro completo:', error);
    mostrarErro('‚ùå Erro ao cadastrar motorista: ' + error.message);
  }
}

function limparFormulario() {
  document.getElementById('formCadastro').reset();
  document.querySelectorAll('.vehicle-class').forEach(el => el.classList.remove('active'));
  document.getElementById('tipo_veiculo').innerHTML = '<option value="">Selecione a classe do ve√≠culo primeiro</option>';
  document.getElementById('tipo_veiculo').disabled = true;
  document.getElementById('tipo_carroceria').innerHTML = '<option value="">Selecione a classe do ve√≠culo primeiro</option>';
  document.getElementById('tipo_carroceria').disabled = true;
}

async function carregarContatos() {
  try {
    // Mostrar indicador de carregamento
    const contatosList = document.getElementById('contatosList');
    if (contatosList) {
      contatosList.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div><p class="mt-3">Carregando motoristas...</p></div>';
    }
    
    let todosMotoristas = [];
    
    if (supabase) {
      console.log('üîç Carregando TODOS os motoristas do banco de dados...');
      
      // Carregar TODOS os motoristas em lotes de 1000
      let from = 0;
      const limit = 1000; // Carregar em lotes de 1000
      let hasMore = true;
      
      while (hasMore) {
        const { data: motoristas, error } = await supabase
          .from('motoristas')
          .select('*')
          .order('data_cadastro', { ascending: false })
          .range(from, from + limit - 1);

        if (error) throw error;
        
        if (motoristas && motoristas.length > 0) {
          todosMotoristas = todosMotoristas.concat(motoristas);
          from += limit;
          
          // Atualizar progresso se houver elemento
          if (contatosList) {
            contatosList.innerHTML = `<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Carregando motoristas... ${todosMotoristas.length.toLocaleString('pt-BR')} encontrados</p></div>`;
          }
          
          console.log(`üìä ${todosMotoristas.length.toLocaleString('pt-BR')} motoristas carregados...`);
          
          // Se retornou menos que o limite, n√£o h√° mais dados
          if (motoristas.length < limit) {
            hasMore = false;
          }
        } else {
          hasMore = false;
        }
      }
      
      console.log(`‚úÖ Total de ${todosMotoristas.length.toLocaleString('pt-BR')} motoristas carregados do banco`);
    } else {
      console.warn('‚ö†Ô∏è Supabase n√£o dispon√≠vel');
      todosMotoristas = [];
    }

    todosContatos = todosMotoristas;
    contatosFiltrados = [...todosContatos];
    
    atualizarEstatisticas();
    aplicarFiltros();
    
  } catch (error) {
    console.error('Erro ao carregar contatos:', error);
    mostrarErro('Erro ao carregar contatos: ' + error.message);
  }
}

function atualizarEstatisticas() {
  const total = todosContatos.length;
  const ativos = todosContatos.filter(c => c.status === 'ativo').length;
  const inativos = todosContatos.filter(c => c.status === 'inativo').length;
  const bloqueados = todosContatos.filter(c => c.status === 'bloqueado').length;
  
  document.getElementById('totalContatos').textContent = total.toLocaleString('pt-BR');
  document.getElementById('contatosAtivos').textContent = ativos.toLocaleString('pt-BR');
  document.getElementById('contatosInativos').textContent = inativos.toLocaleString('pt-BR');
  document.getElementById('contatosBloqueados').textContent = bloqueados.toLocaleString('pt-BR');
  
  // Atualizar cards de carrocerias
  atualizarCardsCarrocerias();
}

// Fun√ß√£o para normalizar texto (remove acentos, converte para min√∫sculas)
function normalizarTexto(texto) {
  if (!texto) return '';
  return texto.toString()
    .toLowerCase()
    .normalize('NFD')
    .replace(/[\u0300-\u036f]/g, '')
    .replace(/√ß/g, 'c')
    .replace(/[^a-z0-9]/g, '')
    .trim();
}

// Fun√ß√£o para encontrar a chave correta no mapeamento baseada no valor normalizado
function encontrarChaveCarroceria(valor) {
  if (!valor) return null;
  
  // Normalizar o valor recebido
  const valorNormalizado = normalizarTexto(valor);
  
  // Tentar encontrar correspond√™ncia exata primeiro (chave exata)
  if (tiposCarroceriaMap[valor]) {
    return valor;
  }
  
  // Corre√ß√£o especial para "caamba" que deve mapear para "cacamba"
  if (valorNormalizado === 'caamba') {
    return 'cacamba';
  }
  
  // Tentar encontrar correspond√™ncia por normaliza√ß√£o bidirecional
  for (const [chave, nomeAmigavel] of Object.entries(tiposCarroceriaMap)) {
    const chaveNormalizada = normalizarTexto(chave);
    const nomeNormalizado = normalizarTexto(nomeAmigavel);
    
    // Verificar correspond√™ncia bidirecional (mais robusto)
    if (valorNormalizado === chaveNormalizada || 
        valorNormalizado === nomeNormalizado ||
        (chaveNormalizada.includes(valorNormalizado) && valorNormalizado.length >= 3) ||
        (valorNormalizado.includes(chaveNormalizada) && chaveNormalizada.length >= 3)) {
      return chave;
    }
  }
  
  // Se n√£o encontrar correspond√™ncia, tentar match parcial mais flex√≠vel
  for (const [chave, nomeAmigavel] of Object.entries(tiposCarroceriaMap)) {
    const chaveNormalizada = normalizarTexto(chave);
    const nomeNormalizado = normalizarTexto(nomeAmigavel);
    
    // Match parcial mais flex√≠vel (pelo menos 3 caracteres correspondentes)
    if (valorNormalizado.length >= 3 && chaveNormalizada.length >= 3) {
      if (valorNormalizado.substring(0, 3) === chaveNormalizada.substring(0, 3) ||
          nomeNormalizado.substring(0, Math.min(3, nomeNormalizado.length)) === valorNormalizado.substring(0, Math.min(3, valorNormalizado.length))) {
        return chave;
      }
      // Match especial para "caamba" que deve mapear para "cacamba"
      if (valorNormalizado === 'caamba' && chaveNormalizada.startsWith('cac')) {
        return 'cacamba';
      }
    }
  }
  
  // Se ainda n√£o encontrar, retornar null para usar o valor original
  return null;
}

function atualizarCardsCarrocerias() {
  const carroceriasGrid = document.getElementById('carroceriasGrid');
  if (!carroceriasGrid) return;
  
  // Contar motoristas por carroceria (usando chave normalizada)
  const contagemPorCarroceria = {};
  const chaveOriginalMap = {}; // Mapear chave normalizada para a chave original do mapeamento
  
  todosContatos.forEach(contato => {
    const carroceria = contato.tipo_carroceria;
    if (carroceria) {
      // Encontrar a chave correta no mapeamento
      const chaveMapeada = encontrarChaveCarroceria(carroceria);
      
      // Se encontrou correspond√™ncia no mapeamento, usar essa chave
      // Sen√£o, normalizar o valor original para agrupar varia√ß√µes
      const chaveFinal = chaveMapeada || normalizarTexto(carroceria);
      
      if (!contagemPorCarroceria[chaveFinal]) {
        contagemPorCarroceria[chaveFinal] = 0;
        // Armazenar a chave original do mapeamento se encontrada
        chaveOriginalMap[chaveFinal] = chaveMapeada || null;
      }
      contagemPorCarroceria[chaveFinal]++;
    }
  });
  
  // Converter para array e ordenar por quantidade (maior para menor)
  const carroceriasOrdenadas = Object.entries(contagemPorCarroceria)
    .map(([chave, quantidade]) => {
      // Usar a chave original do mapeamento se dispon√≠vel, sen√£o usar a chave normalizada
      const chaveOriginal = chaveOriginalMap[chave] || chave;
      const nomeAmigavel = tiposCarroceriaMap[chaveOriginal] || chaveOriginal;
      return { chave: chaveOriginal, nomeAmigavel, quantidade };
    })
    .sort((a, b) => b.quantidade - a.quantidade);
  
  // Agrupar por nome amig√°vel para evitar duplica√ß√µes visuais
  const carroceriasAgrupadas = {};
  carroceriasOrdenadas.forEach(item => {
    const nomeNormalizado = normalizarTexto(item.nomeAmigavel);
    if (!carroceriasAgrupadas[nomeNormalizado]) {
      carroceriasAgrupadas[nomeNormalizado] = {
        nomeAmigavel: item.nomeAmigavel,
        quantidade: 0
      };
    }
    carroceriasAgrupadas[nomeNormalizado].quantidade += item.quantidade;
  });
  
  // Converter de volta para array ordenado
  const carroceriasFinais = Object.values(carroceriasAgrupadas)
    .sort((a, b) => b.quantidade - a.quantidade);
  
  // Limpar grid
  carroceriasGrid.innerHTML = '';
  
  // Cores para os cards
  const cores = ['primary', 'success', 'info', 'warning', 'danger'];
  let corIndex = 0;
  
  // Criar cards para cada carroceria
  carroceriasFinais.forEach(({ nomeAmigavel, quantidade }) => {
    const cor = cores[corIndex % cores.length];
    
    const card = document.createElement('div');
    card.className = 'status-card';
    card.innerHTML = `
      <div class="status-icon ${cor}">
        <i class="fas fa-truck"></i>
      </div>
      <div class="status-number">${quantidade.toLocaleString('pt-BR')}</div>
      <div class="status-label">${nomeAmigavel}</div>
    `;
    
    carroceriasGrid.appendChild(card);
    corIndex++;
  });
  
  // Se n√£o houver carrocerias, mostrar mensagem
  if (carroceriasFinais.length === 0) {
    carroceriasGrid.innerHTML = '<div class="col-12 text-center text-muted py-3">Nenhuma carroceria encontrada</div>';
  }
  
  console.log(`‚úÖ Cards de carrocerias atualizados: ${carroceriasFinais.length} tipos (sem duplica√ß√µes)`);
}

function carregarFiltros() {
  const selectEstado = document.getElementById('filtroEstado');
  
  if (selectEstado) {
    selectEstado.innerHTML = '<option value="">Todos os estados</option>';
    estados.forEach(estado => {
      const option = document.createElement('option');
      option.value = estado;
      option.textContent = estado;
      selectEstado.appendChild(option);
    });
  }
}

function aplicarFiltros() {
  const filtroClasse = document.getElementById('filtroClasse')?.value || '';
  const filtroEstado = document.getElementById('filtroEstado')?.value || '';
  const filtroStatus = document.getElementById('filtroStatus')?.value || '';
  const filtroBusca = document.getElementById('filtroBusca')?.value.toLowerCase() || '';
  
  contatosFiltrados = todosContatos.filter(contato => {
    const matchBusca = !filtroBusca || 
      contato.nome.toLowerCase().includes(filtroBusca) ||
      contato.telefone1.includes(filtroBusca);
    
    return (!filtroClasse || contato.classe_veiculo === filtroClasse) &&
           (!filtroEstado || contato.estado === filtroEstado) &&
           (!filtroStatus || contato.status === filtroStatus) &&
           matchBusca;
  });
  
  currentPage = 1;
  atualizarTabelaContatos();
  atualizarPaginacao();
}

function atualizarTabelaContatos() {
  const tbody = document.getElementById('tabelaContatos');
  const startIndex = (currentPage - 1) * pageSize;
  const endIndex = startIndex + pageSize;
  const contatosPagina = contatosFiltrados.slice(startIndex, endIndex);
  
  document.getElementById('infoPaginacao').textContent = 
    `Mostrando ${Math.min(contatosPagina.length, pageSize)} de ${contatosFiltrados.length} registros`;
  
  if (contatosPagina.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="6" class="text-center text-muted py-5">
          <i class="fas fa-search fa-3x mb-3 d-block"></i>
          <h5 class="fw-bold">Nenhum motorista encontrado</h5>
        </td>
      </tr>
    `;
    return;
  }
  
  let html = '';
  contatosPagina.forEach(contato => {
    html += `
      <tr>
        <td>${contato.nome}</td>
        <td>${contato.telefone1}</td>
        <td>${contato.classe_veiculo}</td>
        <td>${contato.estado || '-'}</td>
        <td><span class="badge bg-${contato.status === 'ativo' ? 'success' : 'secondary'}">${contato.status}</span></td>
        <td>
            <button class="btn btn-sm btn-outline-primary" onclick="editarMotorista('${contato.id}')" title="Editar">
              <i class="fas fa-edit"></i>
            </button>
        </td>
      </tr>
    `;
  });
  
  tbody.innerHTML = html;
}

function atualizarPaginacao() {
  const totalPages = Math.ceil(contatosFiltrados.length / pageSize);
  const paginacao = document.getElementById('paginacao');
  
  if (totalPages <= 1) {
    paginacao.innerHTML = '';
    return;
  }
  
  let html = '';
  
  html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="mudarPagina(${currentPage - 1}); return false;">‚Äπ</a>
  </li>`;
  
  for (let i = 1; i <= totalPages; i++) {
    if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
      html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
          <a class="page-link" href="#" onclick="mudarPagina(${i}); return false;">${i}</a>
      </li>`;
    }
  }
  
  html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
      <a class="page-link" href="#" onclick="mudarPagina(${currentPage + 1}); return false;">‚Ä∫</a>
  </li>`;
  
  paginacao.innerHTML = html;
}

function mudarPagina(pagina) {
  currentPage = pagina;
  atualizarTabelaContatos();
}

// ========== EXPORTA√á√ÉO DE DADOS ==========
function exportarDados(formato) {
  // Usar contatosFiltrados para exportar apenas os dados filtrados
  const dadosParaExportar = contatosFiltrados.length > 0 ? contatosFiltrados : todosContatos;
  
  if (!dadosParaExportar || dadosParaExportar.length === 0) {
    mostrarErro('N√£o h√° dados para exportar. Carregue os motoristas primeiro.');
    return;
  }

  const dataAtual = new Date().toISOString().split('T')[0];
  const nomeArquivo = `motoristas_cadastrados_${dataAtual}`;

  if (formato === 'csv') {
    exportarParaCSV(dadosParaExportar, nomeArquivo);
  } else if (formato === 'excel') {
    exportarParaExcel(dadosParaExportar, nomeArquivo);
  }
}

function exportarParaCSV(dados, nomeArquivo) {
  // Cabe√ßalhos CSV
  const headers = [
    'ID',
    'Nome',
    'CNH',
    'Categoria CNH',
    'Telefone 1',
    'Telefone 2',
    'Estado',
    'Classe de Ve√≠culo',
    'Tipo de Ve√≠culo',
    'Tipo de Carroceria',
    'Placa Cavalo',
    'Placa Carreta 1',
    'Placa Carreta 2',
    'Placa Carreta 3',
    'Status',
    'Data de Cadastro',
    'Data de Atualiza√ß√£o',
    'Usu√°rio que Cadastrou',
    'Departamento'
  ];

  // Converter dados para CSV
  const linhas = [headers.join(';')];

  dados.forEach(motorista => {
    const dataCadastro = motorista.data_cadastro ? new Date(motorista.data_cadastro).toLocaleString('pt-BR') : '';
    const dataAtualizacao = motorista.data_atualizacao ? new Date(motorista.data_atualizacao).toLocaleString('pt-BR') : '';

    const linha = [
      escaparCSV(motorista.id || ''),
      escaparCSV(motorista.nome || ''),
      escaparCSV(motorista.cnh || ''),
      escaparCSV(motorista.categoria_cnh || ''),
      escaparCSV(motorista.telefone1 || ''),
      escaparCSV(motorista.telefone2 || ''),
      escaparCSV(motorista.estado || ''),
      escaparCSV(motorista.classe_veiculo || ''),
      escaparCSV(motorista.tipo_veiculo || ''),
      escaparCSV(motorista.tipo_carroceria || ''),
      escaparCSV(motorista.placa_cavalo || ''),
      escaparCSV(motorista.placa_carreta1 || ''),
      escaparCSV(motorista.placa_carreta2 || ''),
      escaparCSV(motorista.placa_carreta3 || ''),
      escaparCSV(motorista.status || ''),
      escaparCSV(dataCadastro),
      escaparCSV(dataAtualizacao),
      escaparCSV(motorista.created_by || ''),
      escaparCSV(motorista.created_by_departamento || '')
    ];

    linhas.push(linha.join(';'));
  });

  // Criar arquivo e fazer download
  const csvContent = linhas.join('\n');
  const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' }); // BOM para Excel reconhecer UTF-8
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);

  link.setAttribute('href', url);
  link.setAttribute('download', `${nomeArquivo}.csv`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  mostrarSucesso(`‚úÖ Arquivo CSV exportado com sucesso!\n\nTotal de registros: ${dados.length}`);
}

function exportarParaExcel(dados, nomeArquivo) {
  // Cabe√ßalhos
  const headers = [
    'ID',
    'Nome',
    'CNH',
    'Categoria CNH',
    'Telefone 1',
    'Telefone 2',
    'Estado',
    'Classe de Ve√≠culo',
    'Tipo de Ve√≠culo',
    'Tipo de Carroceria',
    'Placa Cavalo',
    'Placa Carreta 1',
    'Placa Carreta 2',
    'Placa Carreta 3',
    'Status',
    'Data de Cadastro',
    'Data de Atualiza√ß√£o',
    'Usu√°rio que Cadastrou',
    'Departamento'
  ];

  // Criar conte√∫do HTML para Excel (formato que Excel entende)
  let htmlContent = `
    <html>
      <head>
        <meta charset="UTF-8">
        <style>
          table { border-collapse: collapse; width: 100%; }
          th { background-color: #667eea; color: white; font-weight: bold; padding: 8px; text-align: left; border: 1px solid #ddd; }
          td { padding: 8px; border: 1px solid #ddd; }
          tr:nth-child(even) { background-color: #f2f2f2; }
        </style>
      </head>
      <body>
        <table>
          <thead>
            <tr>
              ${headers.map(h => `<th>${h}</th>`).join('')}
            </tr>
          </thead>
          <tbody>
  `;

  dados.forEach(motorista => {
    const escaparHTML = (texto) => {
      if (texto === null || texto === undefined) return '';
      return String(texto)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    };

    const dataCadastro = motorista.data_cadastro ? new Date(motorista.data_cadastro).toLocaleString('pt-BR') : '';
    const dataAtualizacao = motorista.data_atualizacao ? new Date(motorista.data_atualizacao).toLocaleString('pt-BR') : '';

    htmlContent += '<tr>';
    htmlContent += `<td>${escaparHTML(motorista.id || '')}</td>`;
    htmlContent += `<td>${escaparHTML(motorista.nome || '')}</td>`;
    htmlContent += `<td>${escaparHTML(motorista.cnh || '')}</td>`;
    htmlContent += `<td>${escaparHTML(motorista.categoria_cnh || '')}</td>`;
    htmlContent += `<td>${escaparHTML(motorista.telefone1 || '')}</td>`;
    htmlContent += `<td>${escaparHTML(motorista.telefone2 || '')}</td>`;
    htmlContent += `<td>${escaparHTML(motorista.estado || '')}</td>`;
    htmlContent += `<td>${escaparHTML(motorista.classe_veiculo || '')}</td>`;
    htmlContent += `<td>${escaparHTML(motorista.tipo_veiculo || '')}</td>`;
    htmlContent += `<td>${escaparHTML(motorista.tipo_carroceria || '')}</td>`;
    htmlContent += `<td>${escaparHTML(motorista.placa_cavalo || '')}</td>`;
    htmlContent += `<td>${escaparHTML(motorista.placa_carreta1 || '')}</td>`;
    htmlContent += `<td>${escaparHTML(motorista.placa_carreta2 || '')}</td>`;
    htmlContent += `<td>${escaparHTML(motorista.placa_carreta3 || '')}</td>`;
    htmlContent += `<td>${escaparHTML(motorista.status || '')}</td>`;
    htmlContent += `<td>${escaparHTML(dataCadastro)}</td>`;
    htmlContent += `<td>${escaparHTML(dataAtualizacao)}</td>`;
    htmlContent += `<td>${escaparHTML(motorista.created_by || '')}</td>`;
    htmlContent += `<td>${escaparHTML(motorista.created_by_departamento || '')}</td>`;
    htmlContent += '</tr>';
  });

  htmlContent += `
          </tbody>
        </table>
      </body>
    </html>
  `;

  // Criar arquivo e fazer download
  const blob = new Blob(['\ufeff' + htmlContent], { type: 'application/vnd.ms-excel;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);

  link.setAttribute('href', url);
  link.setAttribute('download', `${nomeArquivo}.xls`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);

  mostrarSucesso(`‚úÖ Arquivo Excel exportado com sucesso!\n\nTotal de registros: ${dados.length}`);
}

function escaparCSV(texto) {
  if (texto === null || texto === undefined) return '';
  const textoStr = String(texto);
  // Se cont√©m ponto e v√≠rgula, aspas ou quebra de linha, precisa ser envolvido em aspas
  if (textoStr.includes(';') || textoStr.includes('"') || textoStr.includes('\n') || textoStr.includes('\r')) {
    return '"' + textoStr.replace(/"/g, '""') + '"';
  }
  return textoStr;
}

async function editarMotorista(id) {
    if (!exigirTreinamentoCadastro()) return;
    try {
    let motorista = null;

    if (supabase) {
      const { data, error } = await supabase
            .from('motoristas')
            .select('*')
            .eq('id', id)
            .single();
      if (error && error.code !== 'PGRST116') throw error;
      motorista = data || null;
    }

    if (!motorista) {
      motorista = todosContatos.find(c => c.id === id) || null;
    }

        if (!motorista) {
            mostrarErro('Motorista n√£o encontrado');
            return;
        }

    // Garantir que estamos na aba de cadastro
    const abaCadastro = document.querySelector('.nav-modern .nav-link[data-tab="cadastro"]');
    if (abaCadastro) abaCadastro.click();

    // Preencher campos b√°sicos
        document.getElementById('nome').value = motorista.nome || '';
        document.getElementById('cnh').value = motorista.cnh || '';
        document.getElementById('categoria_cnh').value = motorista.categoria_cnh || '';
        document.getElementById('telefone1').value = motorista.telefone1 || '';
        document.getElementById('telefone2').value = motorista.telefone2 || '';
        document.getElementById('estado').value = motorista.estado || '';
        document.getElementById('placa_cavalo').value = motorista.placa_cavalo || '';
        document.getElementById('placa_carreta1').value = motorista.placa_carreta1 || '';
        document.getElementById('placa_carreta2').value = motorista.placa_carreta2 || '';
    const inputCarreta3 = document.getElementById('placa_carreta3');
    if (inputCarreta3) inputCarreta3.value = motorista.placa_carreta3 || '';
        document.getElementById('status').value = motorista.status || 'ativo';

    // Selecionar classe e ajustar op√ß√µes dependentes
    const classe = (motorista.classe_veiculo || '').toLowerCase();
    if (classe) {
      selecionarClasseCadastro(classe);
    } else {
      // limpa sele√ß√£o se n√£o houver classe
      document.querySelectorAll('.vehicle-class').forEach(el => el.classList.remove('active'));
    }

    // Ajustar selects dependentes (ap√≥s atualiza√ß√£o das op√ß√µes)
        setTimeout(() => {
      const selectTipoVeiculo = document.getElementById('tipo_veiculo');
      const selectTipoCarroceria = document.getElementById('tipo_carroceria');
      const tipoVeiculo = (motorista.tipo_veiculo || '').toLowerCase();
      const tipoCarroceria = (motorista.tipo_carroceria || '').toLowerCase();
      if (selectTipoVeiculo) {
        selectTipoVeiculo.value = tipoVeiculo;
      }
      if (selectTipoCarroceria) {
        selectTipoCarroceria.value = tipoCarroceria;
      }
    }, 100);

    // Marcar formul√°rio em modo edi√ß√£o
    const form = document.getElementById('formCadastro');
    form.dataset.editing = id;
        
    mostrarSucesso('Modo edi√ß√£o habilitado. Atualize as informa√ß√µes e salve.');
    window.scrollTo({ top: form.offsetTop - 80, behavior: 'smooth' });
    } catch (error) {
    console.error('‚ùå Erro ao editar motorista:', error);
    mostrarErro('Erro ao carregar dados para edi√ß√£o: ' + error.message);
    }
}

async function atualizarMotorista() {
  if (!exigirTreinamentoCadastro()) return;
  const id = document.getElementById('formCadastro').dataset.editing;
  if (!id) return;

  const classeSelecionada = document.querySelector('.vehicle-class.active');
  if (!classeSelecionada) {
    mostrarErro('Selecione a classe do ve√≠culo');
    return;
  }

  const dados = {
    nome: document.getElementById('nome').value.trim(),
    cnh: document.getElementById('cnh').value.trim() || null,
    categoria_cnh: document.getElementById('categoria_cnh').value || null,
    telefone1: document.getElementById('telefone1').value.trim(),
    telefone2: document.getElementById('telefone2').value.trim() || null,
    estado: document.getElementById('estado').value || null,
    tipo_veiculo: document.getElementById('tipo_veiculo').value,
    tipo_carroceria: document.getElementById('tipo_carroceria').value,
    placa_cavalo: document.getElementById('placa_cavalo').value.trim() || null,
    placa_carreta1: document.getElementById('placa_carreta1').value.trim() || null,
    placa_carreta2: document.getElementById('placa_carreta2').value.trim() || null,
    placa_carreta3: document.getElementById('placa_carreta3').value.trim() || null,
    status: document.getElementById('status').value || 'ativo'
  };

  if (!dados.nome || !dados.telefone1 || !dados.tipo_veiculo || !dados.tipo_carroceria) {
    mostrarErro('Preencha todos os campos obrigat√≥rios (*)');
    return;
  }

  const validarTelefone = (valor, campo) => {
    if (!valor) return null;
    const apenasNumeros = valor.replace(/\D/g, '');

    if (apenasNumeros.length === 13 && apenasNumeros.startsWith('55')) {
      return apenasNumeros;
    }

    if (apenasNumeros.length === 11) {
      return '55' + apenasNumeros;
    }

    mostrarErro(`O ${campo} deve estar no formato 55+DDD+9+N√∫mero (ex: 5581999999999). Informe apenas n√∫meros.`);
    throw new Error('Telefone inv√°lido');
  };

  const validarCNH = (valor) => {
    if (!valor) return null;
    const apenasNumeros = valor.replace(/\D/g, '');
    if (apenasNumeros.length !== 11) {
      mostrarErro('CNH deve conter exatamente 11 d√≠gitos num√©ricos');
      throw new Error('CNH inv√°lida');
    }
    return apenasNumeros;
  };

  const validarPlaca = (valor, campo) => {
    if (!valor) return null;
    const placaLimpa = valor.toUpperCase().replace(/\s/g, '').replace(/[^A-Z0-9]/g, '');
    
    const formatoAntigo = /^[A-Z]{3}[0-9]{4}$/;
    const formatoNovo = /^[A-Z]{3}[0-9][A-Z0-9][0-9]{2}$/;
    
    if (placaLimpa.length === 7 && (formatoAntigo.test(placaLimpa) || formatoNovo.test(placaLimpa))) {
      return placaLimpa;
    }
    
    mostrarErro(`A ${campo} deve estar no formato brasileiro (ex: ABC1234 ou ABC1D23)`);
    throw new Error('Placa inv√°lida');
  };

  let telefone1Normalizado;
  let telefone2Normalizado = null;
  let cnhNormalizada = null;
  let placaCavaloNormalizada = null;
  let placaCarreta1Normalizada = null;
  let placaCarreta2Normalizada = null;
  let placaCarreta3Normalizada = null;

  try {
    telefone1Normalizado = validarTelefone(dados.telefone1, 'Telefone 1');
    if (!telefone1Normalizado) {
      mostrarErro('Telefone 1 √© obrigat√≥rio e deve estar no formato correto');
      return;
    }

    if (dados.telefone2) {
      telefone2Normalizado = validarTelefone(dados.telefone2, 'Telefone 2');
    }

    if (dados.cnh) {
      cnhNormalizada = validarCNH(dados.cnh);
    }

    if (dados.placa_cavalo) {
      placaCavaloNormalizada = validarPlaca(dados.placa_cavalo, 'Placa do Cavalo');
    }

    if (dados.placa_carreta1) {
      placaCarreta1Normalizada = validarPlaca(dados.placa_carreta1, 'Placa da Carreta 1');
    }

    if (dados.placa_carreta2) {
      placaCarreta2Normalizada = validarPlaca(dados.placa_carreta2, 'Placa da Carreta 2');
    }

    if (dados.placa_carreta3) {
      placaCarreta3Normalizada = validarPlaca(dados.placa_carreta3, 'Placa da Carreta 3');
    }
  } catch (erroValidacao) {
    console.warn('Valida√ß√£o interrompida:', erroValidacao.message);
    return;
  }

  // Verificar se o telefone j√° existe no banco de dados (excluindo o pr√≥prio registro)
  try {
    const { data: telefoneExistente, error: erroBusca } = await supabase
      .from('motoristas')
      .select('id, nome, telefone1, telefone2')
      .or(`telefone1.eq.${telefone1Normalizado},telefone2.eq.${telefone1Normalizado}`)
      .neq('id', id);

    if (erroBusca) throw erroBusca;

    if (telefoneExistente && telefoneExistente.length > 0) {
      const motoristaExistente = telefoneExistente[0];
      mostrarErro(`‚ùå O n√∫mero de telefone ${telefone1Normalizado} j√° est√° cadastrado para o motorista: ${motoristaExistente.nome || 'N/A'}`);
      return;
    }

    // Verificar telefone2 se foi informado
    if (telefone2Normalizado) {
      const { data: telefone2Existente, error: erroBusca2 } = await supabase
        .from('motoristas')
        .select('id, nome, telefone1, telefone2')
        .or(`telefone1.eq.${telefone2Normalizado},telefone2.eq.${telefone2Normalizado}`)
        .neq('id', id);

      if (erroBusca2) throw erroBusca2;

      if (telefone2Existente && telefone2Existente.length > 0) {
        const motoristaExistente = telefone2Existente[0];
        mostrarErro(`‚ùå O n√∫mero de telefone ${telefone2Normalizado} j√° est√° cadastrado para o motorista: ${motoristaExistente.nome || 'N/A'}`);
        return;
      }
    }
  } catch (erroVerificacao) {
    console.error('Erro ao verificar telefone existente:', erroVerificacao);
    mostrarErro('‚ùå Erro ao verificar se o telefone j√° existe no banco de dados');
    return;
  }

  const updateData = {
    nome: dados.nome,
    cnh: cnhNormalizada,
    categoria_cnh: dados.categoria_cnh,
    telefone1: telefone1Normalizado,
    telefone2: telefone2Normalizado,
    estado: dados.estado,
    classe_veiculo: classeSelecionada.dataset.class,
    tipo_veiculo: dados.tipo_veiculo,
    tipo_carroceria: dados.tipo_carroceria,
    placa_cavalo: placaCavaloNormalizada,
    placa_carreta1: placaCarreta1Normalizada,
    placa_carreta2: placaCarreta2Normalizada,
    placa_carreta3: placaCarreta3Normalizada,
    status: dados.status,
    data_atualizacao: new Date().toISOString()
  };

  try {
    const { error } = await supabase.from('motoristas').update(updateData).eq('id', id);
    if (error) throw error;

    mostrarSucesso('‚úÖ Motorista atualizado com sucesso!');
    limparFormulario();
    delete document.getElementById('formCadastro').dataset.editing;
    await carregarContatos();
    
  } catch (error) {
    console.error('Erro ao atualizar:', error);
    mostrarErro('‚ùå Erro: ' + error.message);
  }
}

async function excluirMotorista(id) {
  if (!exigirTreinamentoCadastro()) return;
  if (!confirm('Tem certeza que deseja excluir este motorista?')) return;

  try {
    const { error } = await supabase.from('motoristas').delete().eq('id', id);
    if (error) throw error;

    mostrarSucesso('‚úÖ Motorista exclu√≠do com sucesso!');
    await carregarContatos();
    
  } catch (error) {
    console.error('Erro ao excluir:', error);
    mostrarErro('‚ùå Erro: ' + error.message);
  }
}

async function getCurrentUserId() {
  const userData = localStorage.getItem('loggedInUser');
  if (userData) {
    const user = JSON.parse(userData);
    return user.id || 'default_user';
  }
  return 'default_user';
}

async function getCurrentUserDepartment() {
  try {
    const userData = localStorage.getItem('loggedInUser');
    if (userData) {
      const user = JSON.parse(userData);
      if (user.departamento) return user.departamento;
    }
  } catch {}
  return null;
}

function mostrarSucesso(mensagem) {
  mostrarMensagem(mensagem, 'success');
}

function mostrarErro(mensagem) {
  mostrarMensagem(mensagem, 'danger');
}

function mostrarAviso(mensagem) {
  mostrarMensagem(mensagem, 'warning');
}

function mostrarMensagem(mensagem, tipo) {
  const mensagensAnteriores = document.querySelectorAll('.alert-floating');
  mensagensAnteriores.forEach(msg => msg.remove());
  
  const alert = document.createElement('div');
  alert.className = `alert alert-${tipo} alert-floating alert-dismissible fade show`;
  alert.innerHTML = `${mensagem}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
  
  document.body.appendChild(alert);
  
  if (tipo !== 'danger') {
    setTimeout(() => {
      if (alert.parentNode) alert.remove();
    }, 5000);
  }
}

async function fazerLogout() {
  if (confirm('Deseja realmente sair do sistema?')) {
    try {
      localStorage.removeItem('loggedInUser');
    } catch (error) {
      console.error('Erro no logout:', error);
    } finally {
      window.location.href = 'login.html';
    }
  }
}

function adicionarCSSPersonalizado() {
  if (document.getElementById('css-personalizado')) return;
  
  const style = document.createElement('style');
  style.id = 'css-personalizado';
  style.textContent = `
    .stat-card-small {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: all 0.3s ease;
    }
    .stat-card-small:hover {
      border-color: #667eea;
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
    }
    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.25rem;
    }
    .stat-number {
      font-size: 1.5rem;
      font-weight: 700;
      color: #1f2937;
      line-height: 1;
    }
    .stat-label {
      font-size: 0.875rem;
      color: #64748b;
      margin-top: 0.25rem;
    }
  `;
  document.head.appendChild(style);
}

async function carregarEstatisticasSistema() { /* removido */ }

// ========== IMPORTA√á√ÉO CSV ==========
async function importarCSV(file) {
  // Verificar se √© admin antes de importar
  if (!userIsAdmin) {
    mostrarErro('Acesso negado. Apenas administradores podem importar cadastros em lote.');
    return;
  }
  
  if (!exigirTreinamentoCadastro()) return;
  const btnImportar = document.getElementById('btnImportarCSV');
  const sobrescrever = document.getElementById('sobrescrever')?.checked || false;
  const manterInativos = document.getElementById('manter_inativos')?.checked || false;
  
  if (!file) {
    mostrarErro('Nenhum arquivo selecionado');
    return;
  }
  
  try {
    btnImportar.disabled = true;
    btnImportar.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Importando...';
    
    // Obter token de autentica√ß√£o do Supabase
    let authToken = null;
    if (supabase) {
      try {
        const { data: session, error: sessionError } = await supabase.auth.getSession();
        if (sessionError) {
          console.warn('‚ö†Ô∏è Erro ao obter sess√£o:', sessionError);
        } else if (session?.session?.access_token) {
          authToken = session.session.access_token;
          console.log('‚úÖ Token de autentica√ß√£o obtido');
        } else {
          console.warn('‚ö†Ô∏è Sess√£o n√£o encontrada ou sem token');
          throw new Error('Sess√£o n√£o encontrada. Fa√ßa login novamente.');
        }
      } catch (e) {
        console.warn('‚ö†Ô∏è N√£o foi poss√≠vel obter sess√£o:', e);
        throw new Error('Sess√£o n√£o encontrada. Fa√ßa login novamente.');
      }
    } else {
      throw new Error('Supabase n√£o inicializado. Recarregue a p√°gina.');
    }
    
    const formData = new FormData();
    formData.append('csv', file);
    formData.append('sobrescrever', sobrescrever);
    formData.append('manter_inativos', manterInativos);
    
    const headers = {};
    if (authToken) {
      headers['Authorization'] = `Bearer ${authToken}`;
    }
    
    const response = await fetch('/api/motoristas/importar-csv', {
      method: 'POST',
      headers: headers,
      body: formData,
      credentials: 'include'
    });
    
    const result = await response.json();
    
    if (!response.ok) {
      throw new Error(result.error || 'Erro ao importar CSV');
    }
    
    mostrarSucesso(`‚úÖ Importa√ß√£o conclu√≠da! ${result.inseridos || 0} inseridos, ${result.atualizados || 0} atualizados, ${result.erros || 0} erros`);
    
    // Mostrar detalhes dos erros se houver
    if (result.erros > 0 && result.detalhesErros && result.detalhesErros.length > 0) {
      console.error('‚ùå Erros na importa√ß√£o:', result.detalhesErros);
      const errosTexto = result.detalhesErros.map(e => `Linha ${e.linha}: ${e.erro}`).join('\n');
      alert(`Aten√ß√£o: ${result.erros} erro(s) encontrado(s):\n\n${errosTexto}\n\nVerifique o console para mais detalhes.`);
    }
    
    // Limpar arquivo
    const csvFileInput = document.getElementById('csvFile');
    if (csvFileInput) csvFileInput.value = '';
    
    // Restaurar √°rea de upload
    const uploadArea = document.getElementById('uploadArea');
    if (uploadArea) {
      uploadArea.innerHTML = `
        <div class="upload-icon">
          <i class="fas fa-cloud-upload-alt"></i>
        </div>
        <h5 class="fw-bold mb-2">Arraste ou clique para upload</h5>
        <p class="text-muted mb-3">Suporte para arquivos CSV</p>
        <input type="file" id="csvFile" class="d-none" accept=".csv">
        <button class="btn btn-modern btn-modern-primary" id="btnSelecionarArquivo">
          <i class="fas fa-folder-open me-2"></i>Selecionar Arquivo
        </button>
      `;
      
      // Reatribuir event listeners
      const novoBtnSelecionar = document.getElementById('btnSelecionarArquivo');
      const novoCsvFile = document.getElementById('csvFile');
      if (novoBtnSelecionar && novoCsvFile) {
        novoBtnSelecionar.addEventListener('click', () => novoCsvFile.click());
        novoCsvFile.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            const fileName = file.name;
            uploadArea.innerHTML = `
              <div class="upload-icon text-success">
                <i class="fas fa-check-circle"></i>
              </div>
              <h5 class="fw-bold mb-2">${fileName}</h5>
              <p class="text-muted mb-3">Arquivo selecionado com sucesso</p>
              <button class="btn btn-modern btn-modern-secondary btn-sm" onclick="document.getElementById('csvFile').value=''; location.reload();">
                <i class="fas fa-times me-2"></i>Remover
              </button>
            `;
          }
        });
      }
    }
    
    // Recarregar contatos
    await carregarContatos();
    
  } catch (error) {
    console.error('Erro ao importar CSV:', error);
    mostrarErro('‚ùå Erro ao importar CSV: ' + error.message);
  } finally {
    btnImportar.disabled = false;
    btnImportar.innerHTML = '<i class="fas fa-upload me-2"></i>Importar CSV';
  }
}

function baixarTemplateCSV() {
  const headers = [
    'nome',
    'telefone1',
    'telefone2',
    'cnh',
    'categoria_cnh',
    'estado',
    'classe_veiculo',
    'tipo_veiculo',
    'tipo_carroceria',
    'placa_cavalo',
    'placa_carreta1',
    'placa_carreta2',
    'placa_carreta3',
    'status'
  ];
  
  const exemplo = [
    'Jo√£o Silva',
    '11987654321',
    '11912345678',
    '12345678901',
    'C',
    'SP',
    'pesado',
    'caminhao',
    'bau',
    'ABC1234',
    '',
    '',
    '',
    'ativo'
  ];
  
  const csvContent = [
    headers.join(','),
    exemplo.join(','),
    'Maria Santos,11987654322,,98765432101,D,MG,medio,van,sider,DEF5678,,,,'.split(',').join(',')
  ].join('\n');
  
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  
  link.setAttribute('href', url);
  link.setAttribute('download', 'template_motoristas.csv');
  link.style.visibility = 'hidden';
  
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// ========== INICIALIZA√á√ÉO FINAL ==========
document.addEventListener('DOMContentLoaded', inicializarAplicacao);
</script>
<!-- Chat IA -->
<link rel="stylesheet" href="css/chat-ia.css">
<script src="js/chat-ia.js"></script>
</body>
</html>