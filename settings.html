<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configurações do Sistema - Intranet Multimodal</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --danger-gradient: linear-gradient(135deg, #dc3545 0%, #ff4b2b 100%);
            --warning-gradient: linear-gradient(135deg, #ffc107 0%, #ffeb3b 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.16);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        /* Background Animation */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 50%, rgba(118, 75, 162, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg width="60" height="60" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h60v60H0z" fill="none"/><path d="M30 0v60M0 30h60" stroke="rgba(255,255,255,0.03)" stroke-width="1"/></svg>');
            pointer-events: none;
            z-index: 0;
        }
        
        /* Content Container */
        .content-wrapper {
            position: relative;
            z-index: 1;
        }
        
        /* Navbar */
        .navbar {
            background: rgba(255, 255, 255, 0.98) !important;
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 2px solid rgba(102, 126, 234, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 1rem 0;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }
        
        .nav-link {
            color: #495057 !important;
            font-weight: 600;
            transition: var(--transition);
            font-size: 0.95rem;
        }
        
        .nav-link:hover {
            color: #667eea !important;
            transform: translateY(-2px);
        }
        
        .navbar-nav .nav-link {
            color: #495057 !important;
        }
        
        .navbar-nav .nav-link:hover {
            color: #667eea !important;
        }
        
        .navbar-nav .dropdown-toggle {
            color: #495057 !important;
            font-weight: 600;
        }
        
        .navbar-nav .dropdown-toggle:hover {
            color: #667eea !important;
        }
        
        .dropdown-menu {
            background: white;
            border: none;
            box-shadow: var(--shadow-lg);
            border-radius: 12px;
            padding: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .dropdown-item {
            color: #495057;
            font-weight: 500;
            transition: var(--transition);
            border-radius: 8px;
            padding: 0.5rem 1rem;
        }
        
        .dropdown-item:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            color: #667eea;
            transform: translateX(4px);
        }
        
        /* Main Container */
        .main-container {
            padding: 2rem 0;
            min-height: calc(100vh - 80px);
        }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.98) !important;
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: none;
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.12);
            transition: var(--transition);
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 16px 48px rgba(102, 126, 234, 0.2);
        }
        
        .card-header {
            background: var(--primary-gradient) !important;
            color: white;
            padding: 1.5rem 2rem;
            border: none;
            font-weight: 700;
            font-size: 1.1rem;
            letter-spacing: -0.3px;
            position: relative;
            overflow: hidden;
        }
        
        .card-header::after {
            content: '';
            position: absolute;
            top: 0;
            right: -50px;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: pulse 4s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .card-body {
            padding: 2rem;
        }
        
        /* Buttons */
        .btn {
            border-radius: 12px;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            transition: var(--transition);
            border: none;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-primary:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.5);
        }
        
        .btn-success {
            background: var(--success-gradient);
            color: white;
            box-shadow: 0 4px 20px rgba(17, 153, 142, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(17, 153, 142, 0.5);
        }
        
        .btn-danger {
            background: var(--danger-gradient);
            color: white;
            box-shadow: 0 4px 20px rgba(220, 53, 69, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(220, 53, 69, 0.5);
        }
        
        .btn-warning {
            background: var(--warning-gradient);
            color: #212529;
            box-shadow: 0 4px 20px rgba(255, 193, 7, 0.4);
            font-weight: 700;
        }
        
        .btn-warning:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(255, 193, 7, 0.5);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #00d4ff 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(23, 162, 184, 0.4);
        }
        
        .btn-info:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(23, 162, 184, 0.5);
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* Form Controls */
        .form-control, .form-select {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            transition: var(--transition);
            font-family: 'Inter', sans-serif;
        }

        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
            outline: none;
        }
        
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        
        /* Tables */
        .table {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }
        
        .table thead {
            background: var(--primary-gradient);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .table thead::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
            pointer-events: none;
        }
        
        .table thead th {
            border: none;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1px;
            padding: 1.5rem 1rem;
            position: relative;
            z-index: 1;
        }
        
        .table tbody tr {
            transition: var(--transition);
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        }
        
        .table tbody tr:last-child {
            border-bottom: none;
        }
        
        .table tbody tr:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
            transform: translateX(8px);
            box-shadow: -4px 0 16px rgba(102, 126, 234, 0.1);
        }

        /* Badges */
        .badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: var(--transition);
        }
        
        .badge:hover {
            transform: scale(1.05);
        }
        
        .badge.bg-success {
            background: var(--success-gradient) !important;
            color: white;
        }
        
        .badge.bg-warning {
            background: var(--warning-gradient) !important;
            color: #212529;
        }
        
        .badge.bg-danger {
            background: var(--danger-gradient) !important;
            color: white;
        }
        
        .badge.bg-primary {
            background: var(--primary-gradient) !important;
            color: white;
        }
        
        .badge.bg-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%) !important;
            color: white;
        }
        
        /* Tabs */
        .nav-tabs {
            border: none;
            margin-bottom: 2rem;
            background: transparent;
        }
        
        .nav-tabs .nav-link {
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            color: white !important;
            font-weight: 600;
            transition: var(--transition);
            margin-right: 0.5rem;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        .nav-tabs .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            transition: var(--transition);
        }
        
        .nav-tabs .nav-link:hover::before {
            left: 100%;
        }
        
        .nav-tabs .nav-link:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .nav-tabs .nav-link.active {
            background: rgba(255, 255, 255, 0.25);
            border-color: white;
            color: white !important;
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.3);
        }
        
        .nav-tabs .nav-link i {
            margin-right: 0.5rem;
        }
        
        /* Modals */
        .modal-content {
            border: none;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .modal-header {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 1.5rem 2rem;
        }
        
        .modal-header .modal-title {
            font-weight: 700;
            font-size: 1.25rem;
        }
        
        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            border: none;
            padding: 1.5rem 2rem;
            background: #f8f9fa;
        }

        /* Alerts */
        .alert {
            border: none;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            font-weight: 500;
        }
        
        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: slideIn 0.5s ease-out;
        }
        
        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                padding: 1rem 0;
            }
            
            .card-body {
                padding: 1.5rem;
            }
            
            .nav-tabs .nav-link {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }
        }
        
        /* Status Indicators */
        .status-active {
            color: #11998e;
        }
        
        .status-inactive {
            color: #6c757d;
        }
        
        .status-admin {
            background: var(--danger-gradient);
            color: white;
        }
        
        .status-user {
            background: var(--primary-gradient);
            color: white;
        }
    </style>
</head>
<body>
    <div class="content-wrapper">
    <!-- Navbar -->
        <nav class="navbar navbar-expand-lg">
        <div class="container">
                <a class="navbar-brand" href="portal.html">
                <i class="fas fa-cog me-2"></i>
                    Configurações do Sistema
            </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarContent">
            <div class="navbar-nav ms-auto">
                        <a class="nav-link" href="portal.html">
                            <i class="fas fa-home me-2"></i>Portal
                        </a>
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user me-2"></i>
                        <span id="currentUser">Carregando...</span>
                    </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="portal.html"><i class="fas fa-home me-2"></i>Portal</a></li>
                                <li><a class="dropdown-item" href="coletas.html"><i class="fas fa-tasks me-2"></i>Coletas</a></li>
                        <li><a class="dropdown-item" href="relatorios.html"><i class="fas fa-chart-bar me-2"></i>Relatórios</a></li>
                        <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Sair</a></li>
                    </ul>
                        </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <div class="container">
                <!-- Tabs -->
                <ul class="nav nav-tabs" id="configTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabUsuarios" type="button">
                        <i class="fas fa-users me-2"></i>Usuários
                        </button>
                </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabPermissoes" type="button">
                        <i class="fas fa-shield-alt me-2"></i>Permissões
                        </button>
                </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabEvolutionAPI" type="button">
                            <i class="fas fa-key me-2"></i>Evolution API
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabEtiquetas" type="button">
                            <i class="fas fa-tags me-2"></i>Etiquetas
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabSistema" type="button">
                            <i class="fas fa-cogs me-2"></i>Configurações
                        </button>
                </li>
            </ul>

                <div class="tab-content mt-4">
                <!-- Tab Usuários -->
                    <div class="tab-pane fade show active" id="tabUsuarios" role="tabpanel">
                        <div class="card fade-in">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-users me-2"></i>
                                Gerenciamento de Usuários
                            </h5>
                        </div>
                        <div class="card-body">
                                <div class="mb-4">
                                    <button class="btn btn-primary" onclick="abrirModalNovoUsuario()">
                                    <i class="fas fa-plus me-2"></i>Adicionar Usuário
                                </button>
                            </div>
                            <div class="table-responsive">
                                    <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th>Email</th>
                                                <th>Role</th>
                                            <th>Status</th>
                                            <th>Criado em</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listaUsuarios">
                                            <tr>
                                                <td colspan="6" class="text-center py-5">
                                                    <div class="spinner mx-auto"></div>
                                                    <p class="text-muted mt-3">Carregando usuários...</p>
                                                </td>
                                            </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Permissões -->
                    <div class="tab-pane fade" id="tabPermissoes" role="tabpanel">
                        <div class="card fade-in">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-shield-alt me-2"></i>
                                    Gerenciamento de Permissões
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">Selecionar Usuário</label>
                                        <select id="selectUsuarioPermissoes" class="form-select" onchange="carregarPermissoesUsuario()">
                                        <option value="">Selecione um usuário...</option>
                                    </select>
                                </div>
                                    <div class="col-md-8 mt-4 mt-md-0">
                                        <label class="form-label">Permissões do Portal</label>
                                        <div id="containerPermissoesPortal" class="mt-3">
                                            <div class="alert alert-info">
                                                Selecione um usuário para gerenciar suas permissões
                                    </div>
                                </div>
                                        
                                        <label class="form-label mt-4">Permissões de Coletas</label>
                                        <div id="containerPermissoesColetas" class="mt-3">
                                            <div class="alert alert-info">
                                                Selecione um usuário para gerenciar suas permissões
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Evolution API -->
                    <div class="tab-pane fade" id="tabEvolutionAPI" role="tabpanel">
                        <div class="card fade-in">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-key me-2"></i>
                                    Credenciais da Evolution API
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Importante:</strong> Cada usuário deve ter suas próprias credenciais da Evolution API para evitar que todas as mensagens saiam do mesmo número. Gerencie suas credenciais aqui.
                                </div>
                                
                                <div class="mb-4">
                                    <button class="btn btn-primary" onclick="abrirModalNovaCredencial()">
                                        <i class="fas fa-plus me-2"></i>Adicionar Credencial
                                    </button>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Usuário</th>
                                                <th>Instância</th>
                                                <th>URL</th>
                                                <th>Status</th>
                                                <th>Última Validação</th>
                                                <th>Ações</th>
                                            </tr>
                                        </thead>
                                        <tbody id="listaCredenciaisAPI">
                                            <tr>
                                                <td colspan="6" class="text-center py-5">
                                                    <div class="spinner mx-auto"></div>
                                                    <p class="text-muted mt-3">Carregando credenciais...</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Etiquetas -->
                    <div class="tab-pane fade" id="tabEtiquetas" role="tabpanel">
                        <div class="card fade-in">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-tags me-2"></i>
                                    Gerenciamento de Etiquetas
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Crie etiquetas personalizadas para categorizar e organizar as coletas. 
                                    Todos os usuários poderão usar as etiquetas criadas.
                                </div>
                                
                                <div class="mb-4">
                                    <button class="btn btn-primary" onclick="abrirModalNovaEtiqueta()">
                                        <i class="fas fa-plus me-2"></i>Criar Nova Etiqueta
                                    </button>
                                </div>

                                <div id="containerEtiquetas">
                                    <div class="d-flex justify-content-center py-5">
                                        <div class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Carregando...</span>
                                            </div>
                                            <p class="text-muted mt-3">Carregando etiquetas...</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                <!-- Tab Sistema -->
                    <div class="tab-pane fade" id="tabSistema" role="tabpanel">
                        <div class="card fade-in">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-cogs me-2"></i>
                                    Configurações do Sistema
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="formConfiguracoes">
                                <div class="row">
                                        <div class="col-md-6 mb-3">
                                        <label class="form-label">Nome da Empresa</label>
                                        <input type="text" id="nomeEmpresa" class="form-control">
                                    </div>
                                        <div class="col-md-6 mb-3">
                                        <label class="form-label">Email de Contato</label>
                                        <input type="email" id="emailContato" class="form-control">
                                    </div>
                                </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                        <label class="form-label">Tempo Limite Padrão (dias)</label>
                                        <input type="number" id="tempoLimitePadrao" class="form-control" min="1" max="365">
                                    </div>
                                        <div class="col-md-6 mb-3">
                                        <label class="form-label">Notificações por Email</label>
                                        <select id="notificacoesEmail" class="form-select">
                                            <option value="true">Ativadas</option>
                                            <option value="false">Desativadas</option>
                                        </select>
                                    </div>
                                </div>
                                    <div class="mt-4">
                                        <button type="button" class="btn btn-primary" onclick="salvarConfiguracoesSistema()">
                                        <i class="fas fa-save me-2"></i>Salvar Configurações
                                    </button>
                                </div>
                            </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Novo Usuário -->
    <div class="modal fade" id="modalNovoUsuario" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus me-2"></i>Novo Usuário
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formNovoUsuario">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nome Completo *</label>
                                <input type="text" id="nomeUsuarioInput" class="form-control" required>
                        </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email *</label>
                                <input type="email" id="emailUsuarioInput" class="form-control" required>
                        </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Senha *</label>
                                <input type="password" id="senhaUsuarioInput" class="form-control" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tipo de Usuário *</label>
                                <select id="tipoUsuarioInput" class="form-select" required>
                                    <option value="">Selecione...</option>
                                    <option value="user">Usuário</option>
                                    <option value="admin">Administrador</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Departamento</label>
                                <input type="text" id="departamentoUsuarioInput" class="form-control" placeholder="Ex: TI, Comercial, Operações">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Cargo</label>
                                <input type="text" id="cargoUsuarioInput" class="form-control" placeholder="Ex: Desenvolvedor, Analista">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarNovoUsuario()">
                        <i class="fas fa-save me-2"></i>Salvar Usuário
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nova Etiqueta -->
    <div class="modal fade" id="modalNovaEtiqueta" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-tag me-2"></i>Nova Etiqueta
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formNovaEtiqueta">
                        <div class="mb-3">
                            <label class="form-label">Nome da Etiqueta *</label>
                            <input type="text" id="nomeEtiquetaInput" class="form-control" required 
                                   placeholder="Ex: Adiantamento de Frete">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cor da Etiqueta *</label>
                            <div class="d-flex align-items-center gap-3">
                                <input type="color" id="corEtiquetaInput" class="form-control form-control-color" 
                                       value="#667eea" style="width: 80px; height: 50px;">
                                <input type="text" id="corEtiquetaHex" class="form-control" value="#667eea" 
                                       pattern="^#[0-9A-Fa-f]{6}$" placeholder="#667eea">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descrição</label>
                            <textarea id="descricaoEtiquetaInput" class="form-control" rows="3" 
                                      placeholder="Descreva para que serve esta etiqueta..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="salvarNovaEtiqueta()">
                        <i class="fas fa-save me-2"></i>Salvar Etiqueta
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nova Credencial -->
    <div class="modal fade" id="modalNovaCredencial" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-key me-2"></i>Nova Credencial Evolution API
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formNovaCredencial">
                        <div class="mb-3">
                            <label class="form-label">Usuário *</label>
                            <select id="usuarioCredencialSelect" class="form-select" required>
                                <option value="">Selecione um usuário...</option>
                            </select>
                            <small class="form-text text-muted">
                                <i class="fas fa-shield-alt me-1"></i>
                                Cada usuário deve ter suas próprias credenciais para evitar que todos compartilhem o mesmo número
                            </small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nome da Instância *</label>
                            <input type="text" id="nomeInstancia" class="form-control" required placeholder="Ex: producao, homologacao">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">URL da API *</label>
                            <input type="url" id="urlAPI" class="form-control" required placeholder="http://127.0.0.1:8080">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">API Key *</label>
                            <input type="text" id="apiKey" class="form-control" required placeholder="Sua chave de API">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Máximo de Conexões</label>
                            <input type="number" id="maxConexoes" class="form-control" value="10" min="1" max="100">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarNovaCredencial()">
                        <i class="fas fa-save me-2"></i>Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/permissions.js"></script>
    <script>
        // ========== CONFIGURAÇÃO ==========
        let supabase = null;
        let currentUser = null;
        let usuariosData = [];
        let credenciaisAPI = [];
        let configuracoesSistema = {};

        // ========== INICIALIZAÇÃO ==========
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Iniciando Configurações...');
            
            // 🔐 Verificar se é admin ANTES de qualquer coisa
            const loggedInUserData = localStorage.getItem('loggedInUser');
            if (!loggedInUserData) {
                window.location.href = 'login.html';
                return;
            }
            
            const userData = JSON.parse(loggedInUserData);
            console.log('👤 Verificando acesso do Settings:', userData.email);
            console.log('👑 isAdmin:', userData.isAdmin, 'role:', userData.role);
            
            // Settings SOMENTE para admins
            if (userData.isAdmin !== true && userData.role !== 'admin') {
                console.log('❌ Acesso negado ao Settings: usuário não é admin');
                alert('Acesso Negado\n\nO Settings só é acessível por administradores.');
                window.location.href = 'portal.html';
                return;
            }
            
            console.log('✅ Usuário é admin, permitindo acesso ao Settings');
            
            await inicializarSupabase();
            await verificarAutenticacao();
            await carregarUsuarios();
            await carregarCredenciaisAPI();
            await carregarConfiguracoes();
            console.log('✅ Configurações carregadas com sucesso!');
        });

        // ========== SUPABASE ==========
        async function inicializarSupabase() {
            try {
                const response = await fetch('/api/supabase-config');
                if (!response.ok) throw new Error('Erro ao buscar configurações');
                
                const config = await response.json();
                supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseAnonKey);
                window.supabase = supabase;
                
                console.log('✅ Supabase inicializado');
                return true;
            } catch (error) {
                console.error('❌ Erro ao inicializar Supabase:', error);
                mostrarErro('Erro ao conectar com o banco de dados');
                return false;
            }
        }

        // ========== AUTENTICAÇÃO ==========
        async function verificarAutenticacao() {
            try {
                console.log('🔐 Verificando autenticação...');
                
                const loggedInUserData = localStorage.getItem('loggedInUser');
                if (!loggedInUserData) {
                    console.log('❌ Não há dados no localStorage');
                    window.location.href = 'login.html';
                        return;
                }

                const userData = JSON.parse(loggedInUserData);
                const now = Date.now();
                const sessionAge = now - userData.loginTimestamp;
                const SESSION_TIMEOUT = 12 * 60 * 60 * 1000;

                if (sessionAge >= SESSION_TIMEOUT) {
                    console.log('⚠️ Sessão expirada');
                    localStorage.removeItem('loggedInUser');
                    window.location.href = 'login.html';
                    return;
                }

                // ✅ Buscar role no Supabase
                let isAdmin = userData.isAdmin || userData.role === 'admin';
                try {
                    if (window.supabase) {
                        const { data: profile, error } = await window.supabase
                            .from('user_profiles')
                            .select('role, nome')
                            .eq('id', userData.id)
                    .single();

                        console.log('📋 Profile retornado:', profile);
                        if (!error && profile) {
                            isAdmin = profile.role === 'admin';
                            console.log('✅ isAdmin definido como:', isAdmin, 'role:', profile.role);
                            if (profile.nome) {
                                userData.username = profile.nome;
                            }
                        } else {
                            console.error('❌ Erro ao buscar profile:', error);
                        }
                    }
                } catch (error) {
                    console.error('❌ Erro ao buscar perfil:', error);
                }

                currentUser = {
                    id: userData.id,
                    email: userData.email,
                    username: userData.username,
                    nome: userData.username,
                    isAdmin: isAdmin,
                    role: userData.role || 'user'
                };

                const currentUserElement = document.getElementById('currentUser');
                if (currentUserElement) {
                    currentUserElement.textContent = currentUser.nome;
                }

                console.log('✅ Usuário autenticado:', currentUser.username);
                console.log('👑 É admin:', currentUser.isAdmin);
                
                // ✅ Permitir acesso - o controle será nas funcionalidades específicas
                return currentUser;
            } catch (error) {
                console.error('❌ Erro na verificação:', error);
                window.location.href = 'login.html';
            }
        }

        async function logout() {
            try {
                if (window.supabase) {
                    await window.supabase.auth.signOut();
                }
                localStorage.removeItem('loggedInUser');
                localStorage.removeItem('lastActivity');
                localStorage.removeItem('permissoesData');
                window.location.href = 'login.html';
            } catch (error) {
                console.error('❌ Erro no logout:', error);
                localStorage.removeItem('loggedInUser');
                localStorage.removeItem('lastActivity');
                localStorage.removeItem('permissoesData');
                window.location.href = 'login.html';
            }
        }

        // ========== USUÁRIOS ==========
        async function carregarUsuarios() {
            try {
                if (!window.supabase) {
                    console.error('❌ Supabase não inicializado');
                    return;
                }

                const { data, error } = await window.supabase
                    .from('user_profiles')
                    .select('*')
                    .order('nome');

                if (error) throw error;

                usuariosData = data || [];
                renderizarUsuarios();
                atualizarSelectUsuarios();
                console.log('✅ Usuários carregados:', usuariosData.length);
            } catch (error) {
                console.error('❌ Erro ao carregar usuários:', error);
                usuariosData = [];
                document.getElementById('listaUsuarios').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <p class="text-danger">❌ Erro ao carregar usuários: ${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }

        function renderizarUsuarios() {
            const tbody = document.getElementById('listaUsuarios');
            tbody.innerHTML = '';

            if (usuariosData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Nenhum usuário cadastrado</p>
                        </td>
                    </tr>
                `;
                return;
            }

            usuariosData.forEach(usuario => {
                const row = document.createElement('tr');
                const roleBadge = usuario.role === 'admin' 
                    ? '<span class="badge status-admin">Admin</span>'
                    : '<span class="badge status-user">Usuário</span>';
                
                const statusBadge = usuario.active !== false
                    ? '<span class="badge bg-success">Ativo</span>'
                    : '<span class="badge bg-secondary">Inativo</span>';

                row.innerHTML = `
                    <td><strong>${usuario.nome || 'Sem nome'}</strong></td>
                    <td>${usuario.email || '-'}</td>
                    <td>${roleBadge}</td>
                    <td>${statusBadge}</td>
                    <td>${usuario.created_at ? new Date(usuario.created_at).toLocaleDateString('pt-BR') : '-'}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-warning btn-sm" onclick="editarUsuario('${usuario.id}')" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-${usuario.active !== false ? 'danger' : 'success'} btn-sm" onclick="toggleUsuario('${usuario.id}')" title="${usuario.active !== false ? 'Desativar' : 'Ativar'}">
                                <i class="fas fa-${usuario.active !== false ? 'pause' : 'play'}"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function atualizarSelectUsuarios() {
            const select = document.getElementById('selectUsuarioPermissoes');
            if (!select) return;

            select.innerHTML = '<option value="">Selecione um usuário...</option>';
            usuariosData.forEach(usuario => {
                const option = document.createElement('option');
                option.value = usuario.id;
                option.textContent = usuario.nome || usuario.email || 'Usuário sem nome';
                select.appendChild(option);
            });
        }

        function abrirModalNovoUsuario() {
            document.getElementById('formNovoUsuario').reset();
            document.getElementById('tipoUsuarioInput').value = 'user';
            new bootstrap.Modal(document.getElementById('modalNovoUsuario')).show();
        }

        async function salvarNovoUsuario() {
            try {
                const nome = document.getElementById('nomeUsuarioInput').value;
                const email = document.getElementById('emailUsuarioInput').value;
                const senha = document.getElementById('senhaUsuarioInput').value;
                const tipo = document.getElementById('tipoUsuarioInput').value;
                const departamento = document.getElementById('departamentoUsuarioInput').value;
                const cargo = document.getElementById('cargoUsuarioInput').value;

                if (!nome || !email || !senha || !tipo) {
                    mostrarErro('Preencha todos os campos obrigatórios');
                    return;
                }

                // Criar usuário no Supabase Auth
                const { data: authData, error: authError } = await window.supabase.auth.signUp({
                    email: email,
                    password: senha,
                    options: {
                        data: {
                            nome: nome,
                            role: tipo,
                            departamento: departamento,
                            cargo: cargo
                        }
                    }
                });

                if (authError) throw authError;

                // O trigger handle_new_user cria automaticamente o perfil
                // Aguardar um pouco para garantir que o trigger executou
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Atualizar perfil criado pelo trigger com dados adicionais
                try {
                    const updateData = {
                        nome: nome,
                        email: email,
                        role: tipo
                    };
                    
                    if (departamento) updateData.departamento = departamento;
                    if (cargo) updateData.cargo = cargo;
                    
                    const { error: updateError } = await window.supabase
                        .from('user_profiles')
                        .update(updateData)
                        .eq('id', authData.user.id);

                    if (updateError) {
                        console.warn('⚠️ Erro ao atualizar perfil:', updateError);
                    }
                } catch (error) {
                    console.warn('⚠️ Erro ao atualizar perfil:', error);
                }

                bootstrap.Modal.getInstance(document.getElementById('modalNovoUsuario')).hide();
                mostrarSucesso('Usuário criado com sucesso!');
                await carregarUsuarios();
            } catch (error) {
                console.error('❌ Erro ao criar usuário:', error);
                mostrarErro('Erro ao criar usuário: ' + error.message);
            }
        }

        async function editarUsuario(usuarioId) {
            mostrarInfo('Funcionalidade de edição em desenvolvimento');
        }

        async function toggleUsuario(usuarioId) {
            try {
                const usuario = usuariosData.find(u => u.id === usuarioId);
                if (!usuario) return;

                const novoStatus = usuario.active !== false ? false : true;

                const { error } = await window.supabase
                    .from('user_profiles')
                    .update({ active: novoStatus })
                    .eq('id', usuarioId);

                if (error) throw error;

                mostrarSucesso(`Usuário ${novoStatus ? 'ativado' : 'desativado'} com sucesso!`);
                await carregarUsuarios();
            } catch (error) {
                console.error('❌ Erro ao alterar status:', error);
                mostrarErro('Erro ao alterar status do usuário');
            }
        }

        // ========== PERMISSÕES ==========
        async function carregarPermissoesUsuario() {
            const usuarioId = document.getElementById('selectUsuarioPermissoes').value;
            if (!usuarioId) {
                document.getElementById('containerPermissoesPortal').innerHTML = '<div class="alert alert-info">Selecione um usuário para gerenciar suas permissões</div>';
                document.getElementById('containerPermissoesColetas').innerHTML = '<div class="alert alert-info">Selecione um usuário para gerenciar suas permissões</div>';
                return;
            }

            try {
                // Carregar permissões do portal
                const { data: permissoesPortal, error: errorPortal } = await window.supabase
                    .from('permissoes_portal')
                    .select('tipo, permissao_id')
                    .eq('usuario_id', usuarioId);

                if (!errorPortal) {
                    renderizarPermissoesPortal(permissoesPortal || []);
                }

                // Carregar permissões de coletas
                const { data: permissoesColetas, error: errorColetas } = await window.supabase
                    .from('permissoes_coletas')
                    .select('etapa_id')
                    .eq('usuario_id', usuarioId);

                if (!errorColetas) {
                    renderizarPermissoesColetas(permissoesColetas || []);
                }
            } catch (error) {
                console.error('❌ Erro ao carregar permissões:', error);
                mostrarErro('Erro ao carregar permissões');
            }
        }

        function renderizarPermissoesPortal(permissoes) {
            const container = document.getElementById('containerPermissoesPortal');
            container.innerHTML = `
                <div class="row mb-2">
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalOperacoes" 
                                ${permissoes.some(p => p.permissao_id === 'operacoes') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('operacoes', this.checked)">
                            <label class="form-check-label" for="permPortalOperacoes">Sistema de Disparo</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalColetas" 
                                ${permissoes.some(p => p.permissao_id === 'coletas') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('coletas', this.checked)">
                            <label class="form-check-label" for="permPortalColetas">Sistema de Coletas</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalCadastro" 
                                ${permissoes.some(p => p.permissao_id === 'cadastro') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('cadastro', this.checked)">
                            <label class="form-check-label" for="permPortalCadastro">Cadastro</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalRelatorios" 
                                ${permissoes.some(p => p.permissao_id === 'relatorios') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('relatorios', this.checked)">
                            <label class="form-check-label" for="permPortalRelatorios">Relatórios</label>
                        </div>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalMonitoramento" 
                                ${permissoes.some(p => p.permissao_id === 'monitoramento') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('monitoramento', this.checked)">
                            <label class="form-check-label" for="permPortalMonitoramento">Monitoramento</label>
                        </div>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalComercial" 
                                ${permissoes.some(p => p.permissao_id === 'comercial') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('comercial', this.checked)">
                            <label class="form-check-label" for="permPortalComercial">Comercial</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalCRM" 
                                ${permissoes.some(p => p.permissao_id === 'crm') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('crm', this.checked)">
                            <label class="form-check-label" for="permPortalCRM">CRM</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalVendas" 
                                ${permissoes.some(p => p.permissao_id === 'vendas') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('vendas', this.checked)">
                            <label class="form-check-label" for="permPortalVendas">Vendas</label>
                        </div>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-12">
                        <h6 class="text-muted mb-2"><i class="fas fa-dollar-sign"></i> Financeiro</h6>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalContasPagar" 
                                ${permissoes.some(p => p.permissao_id === 'contas-pagar') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('contas-pagar', this.checked)">
                            <label class="form-check-label" for="permPortalContasPagar">Contas a Pagar</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalContasReceber" 
                                ${permissoes.some(p => p.permissao_id === 'contas-receber') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('contas-receber', this.checked)">
                            <label class="form-check-label" for="permPortalContasReceber">Contas a Receber</label>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12">
                        <h6 class="text-muted mb-2"><i class="fas fa-users"></i> Recursos Humanos</h6>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalFolha" 
                                ${permissoes.some(p => p.permissao_id === 'folha') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('folha', this.checked)">
                            <label class="form-check-label" for="permPortalFolha">Folha de Pagamento</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalRecrutamento" 
                                ${permissoes.some(p => p.permissao_id === 'recrutamento') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('recrutamento', this.checked)">
                            <label class="form-check-label" for="permPortalRecrutamento">Recrutamento</label>
                        </div>
                    </div>
                </div>
                `;
        }

        function renderizarPermissoesColetas(permissoes) {
            const etapasColetas = ['comercial', 'price', 'cs', 'contratacao', 'gr', 'documentacao', 'controladoria', 'contas_pagar', 'contas_receber', 'monitoramento'];
            const etapaNomes = {
                'comercial': 'Comercial',
                'price': 'Price',
                'cs': 'CS',
                'contratacao': 'Contratação',
                'gr': 'GR',
                'documentacao': 'Documentação',
                'controladoria': 'Controladoria',
                'contas_pagar': 'Contas a Pagar',
                'contas_receber': 'Contas a Receber',
                'monitoramento': 'Monitoramento'
            };

            const container = document.getElementById('containerPermissoesColetas');
            const rows = [];
            
            etapasColetas.forEach((etapa, index) => {
                if (index % 3 === 0) {
                    if (index > 0) {
                        rows.push('</div>');
                    }
                    rows.push('<div class="row mb-2">');
                }
                rows.push(`
                    <div class="col-md-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permColeta${etapa}" 
                                ${permissoes.some(p => p.etapa_id === etapa) ? 'checked' : ''}
                                onchange="salvarPermissaoColeta('${etapa}', this.checked)">
                            <label class="form-check-label" for="permColeta${etapa}">${etapaNomes[etapa] || etapa}</label>
                        </div>
                    </div>
                `);
            });
            rows.push('</div>');
            
            container.innerHTML = rows.join('');
        }

        async function salvarPermissaoPortal(permissaoId, permitido) {
            const usuarioId = document.getElementById('selectUsuarioPermissoes').value;
            if (!usuarioId) {
                mostrarErro('Selecione um usuário primeiro');
                return;
            }

            console.log(`💾 Salvando permissão do portal:`);
            console.log(`👤 Usuário ID: ${usuarioId}`);
            console.log(`🔑 Permissão: ${permissaoId}`);
            console.log(`✅ Permitido: ${permitido}`);
            console.log(`🔧 Cliente Supabase disponível:`, !!supabase);

            try {
                if (permitido) {
                    // Verificar se a permissão já existe antes de inserir
                    const { data: existing, error: checkError } = await supabase
                        .from('permissoes_portal')
                        .select('id')
                        .eq('usuario_id', usuarioId)
                        .eq('permissao_id', permissaoId)
                        .maybeSingle();
                    
                    if (checkError && checkError.code !== 'PGRST116') {
                        throw checkError;
                    }
                    
                    // Se não existe, inserir
                    if (!existing) {
                        console.log(`📝 Inserindo nova permissão ${permissaoId}...`);
                        const { data, error } = await supabase
                            .from('permissoes_portal')
                            .insert([{
                                usuario_id: usuarioId,
                                tipo: 'permissao',
                                permissao_id: permissaoId
                            }]);
                        if (error) {
                            console.error('❌ Erro ao inserir:', error);
                            throw error;
                        }
                        console.log('✅ Permissão inserida com sucesso:', data);
                    } else {
                        console.log(`⚠️ Permissão já existe: ${permissaoId}`);
                    }
                } else {
                    console.log(`🗑️ Removendo permissão ${permissaoId}...`);
                    const { error } = await supabase
                        .from('permissoes_portal')
                        .delete()
                        .eq('usuario_id', usuarioId)
                        .eq('permissao_id', permissaoId);
                    if (error) {
                        console.error('❌ Erro ao deletar:', error);
                        throw error;
                    }
                    console.log('✅ Permissão removida com sucesso');
                }
                console.log(`✅ Permissão ${permitido ? 'adicionada' : 'removida'}: ${permissaoId}`);
                mostrarSucesso(`Permissão ${permitido ? 'habilitada' : 'desabilitada'} com sucesso!`);
            } catch (error) {
                console.error('❌ Erro ao salvar permissão:', error);
                mostrarErro(`Erro ao salvar permissão: ${error.message}`);
            }
        }

        async function salvarPermissaoColeta(etapaId, permitido) {
            const usuarioId = document.getElementById('selectUsuarioPermissoes').value;
            if (!usuarioId) {
                mostrarErro('Selecione um usuário primeiro');
                return;
            }

            console.log(`💾 Salvando permissão de coleta:`);
            console.log(`👤 Usuário ID: ${usuarioId}`);
            console.log(`🔑 Etapa: ${etapaId}`);
            console.log(`✅ Permitido: ${permitido}`);

            try {
                if (permitido) {
                    // Verificar se a permissão já existe antes de inserir
                    const { data: existing, error: checkError } = await supabase
                        .from('permissoes_coletas')
                        .select('id')
                        .eq('usuario_id', usuarioId)
                        .eq('etapa_id', etapaId)
                        .maybeSingle();
                    
                    if (checkError && checkError.code !== 'PGRST116') {
                        throw checkError;
                    }
                    
                    // Se não existe, inserir
                    if (!existing) {
                        console.log(`📝 Inserindo nova permissão de coleta ${etapaId}...`);
                        const { data, error } = await supabase
                            .from('permissoes_coletas')
                            .insert([{
                                usuario_id: usuarioId,
                                etapa_id: etapaId
                            }]);
                        if (error) {
                            console.error('❌ Erro ao inserir:', error);
                            throw error;
                        }
                        console.log('✅ Permissão inserida com sucesso:', data);
                    } else {
                        console.log(`⚠️ Permissão de coleta já existe: ${etapaId}`);
                    }
                } else {
                    console.log(`🗑️ Removendo permissão de coleta ${etapaId}...`);
                    const { error } = await supabase
                        .from('permissoes_coletas')
                        .delete()
                        .eq('usuario_id', usuarioId)
                        .eq('etapa_id', etapaId);
                    if (error) {
                        console.error('❌ Erro ao deletar:', error);
                        throw error;
                    }
                    console.log('✅ Permissão removida com sucesso');
                }
                console.log(`✅ Permissão de coleta ${permitido ? 'adicionada' : 'removida'}: ${etapaId}`);
                mostrarSucesso(`Permissão de coleta ${permitido ? 'habilitada' : 'desabilitada'} com sucesso!`);
            } catch (error) {
                console.error('❌ Erro ao salvar permissão de coleta:', error);
                mostrarErro(`Erro ao salvar permissão de coleta: ${error.message}`);
            }
        }

        // ========== EVOLUTION API ==========
        async function carregarCredenciaisAPI() {
            if (!currentUser || !currentUser.id) return;

            try {
                let query = window.supabase
                    .from('user_evolution_apis')
                    .select(`
                        *,
                        user_profiles:user_id (
                            id,
                            nome,
                            email
                        )
                    `);
                
                // Se não é admin, mostrar apenas as próprias credenciais
                if (!currentUser.isAdmin) {
                    query = query.eq('user_id', currentUser.id);
                }
                
                const { data, error } = await query
                    .order('created_at', { ascending: false });

                    if (error) throw error;

                credenciaisAPI = data || [];
                
                // Corrigir referência de user_profiles se necessário
                for (let i = 0; i < credenciaisAPI.length; i++) {
                    const credencial = credenciaisAPI[i];
                    if (credencial.user_profiles && Array.isArray(credencial.user_profiles) && credencial.user_profiles.length > 0) {
                        credencial.user_profile = credencial.user_profiles[0];
                    }
                }
                
                renderizarCredenciaisAPI();
                console.log('✅ Credenciais carregadas:', credenciaisAPI.length);
            } catch (error) {
                console.error('❌ Erro ao carregar credenciais:', error);
                credenciaisAPI = [];
                document.getElementById('listaCredenciaisAPI').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <p class="text-danger">❌ Erro ao carregar credenciais: ${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }

        function renderizarCredenciaisAPI() {
            const tbody = document.getElementById('listaCredenciaisAPI');
            tbody.innerHTML = '';

            if (credenciaisAPI.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <i class="fas fa-key fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Nenhuma credencial cadastrada</p>
                            <p class="text-muted small">Clique em "Adicionar Credencial" para começar</p>
                        </td>
                    </tr>
                `;
                return;
            }

            credenciaisAPI.forEach(credencial => {
                const row = document.createElement('tr');
                
                // Buscar nome do usuário
                let nomeUsuario = 'Usuário não encontrado';
                let isOwner = false;
                
                if (credencial.user_profile) {
                    nomeUsuario = credencial.user_profile.nome || credencial.user_profile.email || 'Sem nome';
                } else if (credencial.user_profiles && Array.isArray(credencial.user_profiles) && credencial.user_profiles.length > 0) {
                    nomeUsuario = credencial.user_profiles[0].nome || credencial.user_profiles[0].email || 'Sem nome';
                } else {
                    // Tentar buscar na lista de usuários carregada
                    const usuarioData = usuariosData.find(u => u.id === credencial.user_id);
                    if (usuarioData) {
                        nomeUsuario = usuarioData.nome || usuarioData.email || 'Sem nome';
                    }
                }
                
                // Verificar se é o dono da credencial
                if (credencial.user_id === currentUser.id) {
                    isOwner = true;
                    nomeUsuario += ' <span class="badge bg-primary">Você</span>';
                }
                
                row.innerHTML = `
                    <td>${nomeUsuario}</td>
                    <td><strong>${credencial.instance_name}</strong></td>
                    <td><code>${credencial.api_url}</code></td>
                    <td>${credencial.is_valid ? '<span class="badge bg-success">Válida</span>' : '<span class="badge bg-warning">Não validada</span>'}</td>
                    <td>${credencial.last_validated ? new Date(credencial.last_validated).toLocaleDateString('pt-BR') : '-'}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-info btn-sm" onclick="validarCredencial('${credencial.id}')" title="Validar">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="excluirCredencial('${credencial.id}')" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function abrirModalNovaCredencial() {
            document.getElementById('formNovaCredencial').reset();
            document.getElementById('maxConexoes').value = '10';
            
            // Preencher select de usuários
            const select = document.getElementById('usuarioCredencialSelect');
            select.innerHTML = '<option value="">Selecione um usuário...</option>';
            
            // Se não é admin, mostrar apenas o próprio usuário e desabilitar o select
            if (!currentUser.isAdmin) {
                select.innerHTML += `<option value="${currentUser.id}" selected>${currentUser.nome || currentUser.username} (Você)</option>`;
                select.disabled = true;
            } else {
                // Se é admin, listar todos os usuários
                select.disabled = false;
                usuariosData.forEach(usuario => {
                    select.innerHTML += `<option value="${usuario.id}">${usuario.nome || usuario.email} ${usuario.role === 'admin' ? '(Admin)' : ''}</option>`;
                });
            }
            
            new bootstrap.Modal(document.getElementById('modalNovaCredencial')).show();
        }

        async function salvarNovaCredencial() {
            if (!currentUser || !currentUser.id) {
                mostrarErro('Usuário não autenticado');
                return;
            }

            try {
                const usuarioId = document.getElementById('usuarioCredencialSelect').value;
                const nomeInstancia = document.getElementById('nomeInstancia').value;
                const urlAPI = document.getElementById('urlAPI').value;
                const apiKey = document.getElementById('apiKey').value;
                const maxConexoes = parseInt(document.getElementById('maxConexoes').value) || 10;

                console.log('💾 Salvando credencial:');
                console.log('👤 Usuário atual:', currentUser);
                console.log('🆔 ID do usuário selecionado:', usuarioId);
                console.log('🏷️ Instância:', nomeInstancia);

                if (!usuarioId || !nomeInstancia || !urlAPI || !apiKey) {
                    mostrarErro('Preencha todos os campos obrigatórios');
                    return;
                }

                // Verificar se é admin ou se está tentando adicionar para si mesmo
                if (!currentUser.isAdmin && usuarioId !== currentUser.id) {
                    mostrarErro('Você só pode adicionar credenciais para você mesmo');
                    return;
                }

                const novaCredencial = {
                    user_id: usuarioId,
                    instance_name: nomeInstancia,
                    api_url: urlAPI,
                    api_key: apiKey,
                    max_connections: maxConexoes,
                    active: true
                };

                console.log('📝 Dados a serem salvos:', {
                    user_id: novaCredencial.user_id,
                    instance_name: novaCredencial.instance_name,
                    api_url: novaCredencial.api_url,
                    api_key: novaCredencial.api_key ? '***' + novaCredencial.api_key.slice(-4) : 'N/A'
                });

                const { data, error } = await window.supabase
                    .from('user_evolution_apis')
                    .insert([novaCredencial])
                    .select();

                if (error) {
                    console.error('❌ Erro ao salvar:', error);
                    throw error;
                }

                console.log('✅ Credencial salva com sucesso:', data);

                bootstrap.Modal.getInstance(document.getElementById('modalNovaCredencial')).hide();
                mostrarSucesso('Credencial salva com sucesso!');
                await carregarCredenciaisAPI();
            } catch (error) {
                console.error('❌ Erro ao salvar credencial:', error);
                mostrarErro('Erro ao salvar credencial: ' + error.message);
            }
        }

        async function validarCredencial(credencialId) {
            try {
                const { error } = await window.supabase
                    .from('user_evolution_apis')
                    .update({ 
                        is_valid: true,
                        last_validated: new Date().toISOString()
                    })
                    .eq('id', credencialId);

                if (error) throw error;

                mostrarSucesso('Credencial validada com sucesso!');
                await carregarCredenciaisAPI();
            } catch (error) {
                console.error('❌ Erro ao validar credencial:', error);
                mostrarErro('Erro ao validar credencial');
            }
        }

        async function excluirCredencial(credencialId) {
            if (!confirm('Tem certeza que deseja excluir esta credencial?')) return;

            try {
                const { error } = await window.supabase
                    .from('user_evolution_apis')
                    .delete()
                    .eq('id', credencialId);

                if (error) throw error;

                mostrarSucesso('Credencial excluída com sucesso!');
                await carregarCredenciaisAPI();
            } catch (error) {
                console.error('❌ Erro ao excluir credencial:', error);
                mostrarErro('Erro ao excluir credencial');
            }
        }

        // ========== CONFIGURAÇÕES ==========
        async function carregarConfiguracoes() {
            try {
                const { data, error } = await window.supabase
                    .from('configuracoes_sistema')
                    .select('*');

                if (error) throw error;

                configuracoesSistema = {};
                data.forEach(config => {
                    configuracoesSistema[config.chave] = config.valor;
                });

                document.getElementById('nomeEmpresa').value = configuracoesSistema.nome_empresa || '';
                document.getElementById('emailContato').value = configuracoesSistema.email_contato || '';
                document.getElementById('tempoLimitePadrao').value = configuracoesSistema.tempo_limite_padrao || 30;
                document.getElementById('notificacoesEmail').value = configuracoesSistema.notificacoes_email || 'true';

                console.log('✅ Configurações carregadas');
            } catch (error) {
                console.error('❌ Erro ao carregar configurações:', error);
            }
        }

        async function salvarConfiguracoesSistema() {
            try {
                const configuracoes = {
                    nome_empresa: document.getElementById('nomeEmpresa').value,
                    email_contato: document.getElementById('emailContato').value,
                    tempo_limite_padrao: parseInt(document.getElementById('tempoLimitePadrao').value),
                    notificacoes_email: document.getElementById('notificacoesEmail').value
                };

                for (const [chave, valor] of Object.entries(configuracoes)) {
                    const { error } = await window.supabase
                        .from('configuracoes_sistema')
                        .upsert({
                            chave: chave,
                            valor: valor,
                            updated_at: new Date().toISOString()
                        });

                    if (error) throw error;
                }

                mostrarSucesso('Configurações salvas com sucesso!');
            } catch (error) {
                console.error('❌ Erro ao salvar configurações:', error);
                mostrarErro('Erro ao salvar configurações: ' + error.message);
            }
        }

        // ========== UTILITÁRIOS ==========
        function mostrarSucesso(mensagem) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);';
            alert.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>${mensagem}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) alert.parentNode.removeChild(alert);
            }, 5000);
        }

        function mostrarErro(mensagem) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);';
            alert.innerHTML = `
                <i class="fas fa-exclamation-circle me-2"></i>${mensagem}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) alert.parentNode.removeChild(alert);
            }, 5000);
        }

        function mostrarInfo(mensagem) {
            mostrarSucesso(mensagem);
        }

        // ========== GERENCIAMENTO DE ETIQUETAS ==========
        async function carregarEtiquetas() {
            try {
                const { data, error } = await window.supabase
                    .from('etiquetas_coletas')
                    .select('*')
                    .order('nome', { ascending: true });

                if (error) throw error;

                const container = document.getElementById('containerEtiquetas');
                if (!container) return;

                if (!data || data.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Nenhuma etiqueta criada ainda. Clique em "Criar Nova Etiqueta" para começar.
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div class="row g-3">
                        ${data.map(etiqueta => `
                            <div class="col-md-4">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex align-items-start justify-content-between mb-2">
                                            <div>
                                                <span class="badge" style="background: ${etiqueta.cor}; color: white; padding: 0.5rem 1rem;">
                                                    <i class="fas fa-tag me-1"></i>${etiqueta.nome}
                                                </span>
                                            </div>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-secondary" onclick="editarEtiqueta('${etiqueta.id}')" title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" onclick="excluirEtiqueta('${etiqueta.id}', '${etiqueta.nome}')" title="Excluir">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        ${etiqueta.descricao ? `<p class="text-muted small mb-0">${etiqueta.descricao}</p>` : ''}
                                        <small class="text-muted">
                                            ${etiqueta.ativo ? '<span class="text-success"><i class="fas fa-check-circle"></i> Ativa</span>' : '<span class="text-danger"><i class="fas fa-times-circle"></i> Inativa</span>'}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('❌ Erro ao carregar etiquetas:', error);
                document.getElementById('containerEtiquetas').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Erro ao carregar etiquetas: ${error.message}
                    </div>
                `;
            }
        }

        function abrirModalNovaEtiqueta() {
            document.getElementById('formNovaEtiqueta').reset();
            document.getElementById('corEtiquetaInput').value = '#667eea';
            document.getElementById('corEtiquetaHex').value = '#667eea';
            
            // Sincronizar inputs de cor
            document.getElementById('corEtiquetaInput').addEventListener('input', function() {
                document.getElementById('corEtiquetaHex').value = this.value;
            });
            document.getElementById('corEtiquetaHex').addEventListener('input', function() {
                if (this.value.match(/^#[0-9A-Fa-f]{6}$/)) {
                    document.getElementById('corEtiquetaInput').value = this.value;
                }
            });
            
            new bootstrap.Modal(document.getElementById('modalNovaEtiqueta')).show();
        }

        async function salvarNovaEtiqueta() {
            try {
                const nome = document.getElementById('nomeEtiquetaInput').value.trim();
                const cor = document.getElementById('corEtiquetaInput').value;
                const descricao = document.getElementById('descricaoEtiquetaInput').value.trim();

                if (!nome) {
                    mostrarErro('Nome da etiqueta é obrigatório');
                    return;
                }

                const { data, error } = await window.supabase
                    .from('etiquetas_coletas')
                    .insert([{
                        nome: nome,
                        cor: cor,
                        descricao: descricao || null,
                        ativo: true,
                        criado_por: currentUser.id
                    }])
                    .select()
                    .single();

                if (error) throw error;

                mostrarSucesso('Etiqueta criada com sucesso!');
                bootstrap.Modal.getInstance(document.getElementById('modalNovaEtiqueta')).hide();
                await carregarEtiquetas();
            } catch (error) {
                console.error('❌ Erro ao salvar etiqueta:', error);
                mostrarErro('Erro ao salvar etiqueta: ' + error.message);
            }
        }

        async function excluirEtiqueta(id, nome) {
            if (!confirm(`Deseja realmente excluir a etiqueta "${nome}"?`)) return;

            try {
                const { error } = await window.supabase
                    .from('etiquetas_coletas')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                mostrarSucesso('Etiqueta excluída com sucesso!');
                await carregarEtiquetas();
            } catch (error) {
                console.error('❌ Erro ao excluir etiqueta:', error);
                mostrarErro('Erro ao excluir etiqueta: ' + error.message);
            }
        }

        function editarEtiqueta(id) {
            // Implementar edição se necessário
            mostrarInfo('Funcionalidade de edição em desenvolvimento');
        }

        // Carregar etiquetas quando a tab for aberta
        document.getElementById('tabEtiquetas')?.addEventListener('shown.bs.tab', function() {
            carregarEtiquetas();
        });
    </script>
</body>
</html>

