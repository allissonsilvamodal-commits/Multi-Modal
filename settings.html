<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Configura√ß√µes do Sistema - Intranet Multimodal</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            --danger-gradient: linear-gradient(135deg, #dc3545 0%, #ff4b2b 100%);
            --warning-gradient: linear-gradient(135deg, #ffc107 0%, #ffeb3b 100%);
            --glass-bg: rgba(255, 255, 255, 0.95);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.16);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        /* Background Animation */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 50%, rgba(118, 75, 162, 0.1) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }
        
        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml,<svg width="60" height="60" xmlns="http://www.w3.org/2000/svg"><path d="M0 0h60v60H0z" fill="none"/><path d="M30 0v60M0 30h60" stroke="rgba(255,255,255,0.03)" stroke-width="1"/></svg>');
            pointer-events: none;
            z-index: 0;
        }
        
        /* Content Container */
        .content-wrapper {
            position: relative;
            z-index: 1;
        }
        
        /* Navbar */
        .navbar {
            background: rgba(255, 255, 255, 0.98) !important;
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 2px solid rgba(102, 126, 234, 0.1);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            padding: 1rem 0;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            background: var(--primary-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.5px;
        }
        
        .nav-link {
            color: #495057 !important;
            font-weight: 600;
            transition: var(--transition);
            font-size: 0.95rem;
        }
        
        .nav-link:hover {
            color: #667eea !important;
            transform: translateY(-2px);
        }
        
        .navbar-nav .nav-link {
            color: #495057 !important;
        }
        
        .navbar-nav .nav-link:hover {
            color: #667eea !important;
        }
        
        .navbar-nav .dropdown-toggle {
            color: #495057 !important;
            font-weight: 600;
        }
        
        .navbar-nav .dropdown-toggle:hover {
            color: #667eea !important;
        }
        
        .dropdown-menu {
            background: white;
            border: none;
            box-shadow: var(--shadow-lg);
            border-radius: 12px;
            padding: 0.5rem;
            margin-top: 0.5rem;
        }
        
        .dropdown-item {
            color: #495057;
            font-weight: 500;
            transition: var(--transition);
            border-radius: 8px;
            padding: 0.5rem 1rem;
        }
        
        .dropdown-item:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1), rgba(118, 75, 162, 0.1));
            color: #667eea;
            transform: translateX(4px);
        }
        
        /* Main Container */
        .main-container {
            padding: 2rem 0;
            min-height: calc(100vh - 80px);
        }

        /* Cards */
        .card {
            background: rgba(255, 255, 255, 0.98) !important;
            backdrop-filter: blur(20px) saturate(180%);
            -webkit-backdrop-filter: blur(20px) saturate(180%);
            border: none;
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(102, 126, 234, 0.12);
            transition: var(--transition);
            overflow: hidden;
        }
        
        .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 16px 48px rgba(102, 126, 234, 0.2);
        }
        
        .card-header {
            background: var(--primary-gradient) !important;
            color: white;
            padding: 1.5rem 2rem;
            border: none;
            font-weight: 700;
            font-size: 1.1rem;
            letter-spacing: -0.3px;
            position: relative;
            overflow: hidden;
        }
        
        .card-header::after {
            content: '';
            position: absolute;
            top: 0;
            right: -50px;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: pulse 4s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .card-body {
            padding: 2rem;
        }
        
        /* Buttons */
        .btn {
            border-radius: 12px;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
            transition: var(--transition);
            border: none;
            font-family: 'Inter', sans-serif;
        }

        .btn-primary {
            background: var(--primary-gradient);
            color: white;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .btn-primary::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .btn-primary:hover::before {
            width: 300px;
            height: 300px;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.5);
        }
        
        .btn-success {
            background: var(--success-gradient);
            color: white;
            box-shadow: 0 4px 20px rgba(17, 153, 142, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(17, 153, 142, 0.5);
        }
        
        .btn-danger {
            background: var(--danger-gradient);
            color: white;
            box-shadow: 0 4px 20px rgba(220, 53, 69, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .btn-danger:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(220, 53, 69, 0.5);
        }
        
        .btn-warning {
            background: var(--warning-gradient);
            color: #212529;
            box-shadow: 0 4px 20px rgba(255, 193, 7, 0.4);
            font-weight: 700;
        }
        
        .btn-warning:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(255, 193, 7, 0.5);
        }
        
        .btn-info {
            background: linear-gradient(135deg, #17a2b8 0%, #00d4ff 100%);
            color: white;
            box-shadow: 0 4px 20px rgba(23, 162, 184, 0.4);
        }
        
        .btn-info:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(23, 162, 184, 0.5);
        }
        
        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        /* Form Controls */
        .form-control, .form-select {
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            transition: var(--transition);
            font-family: 'Inter', sans-serif;
        }

        .form-control:focus, .form-select:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.15);
            outline: none;
        }
        
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        
        /* Estilos para lista de usu√°rios emerg√™ncia */
        #listaUsuariosEmergencia {
            position: relative;
        }
        
        .usuario-emergencia-item {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .usuario-emergencia-item:hover {
            background: #f8f9fa;
            border-color: #667eea;
        }
        
        .usuario-emergencia-item.selected {
            background: #e7f3ff;
            border-color: #667eea;
        }
        
        .usuario-emergencia-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f8f9fa;
        }
        
        .usuario-emergencia-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            margin-right: 12px;
            margin-top: 2px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .usuario-emergencia-item.disabled input[type="checkbox"] {
            cursor: not-allowed;
        }
        
        .usuario-emergencia-info {
            flex: 1;
        }
        
        /* Tables */
        .table {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
        }
        
        .table thead {
            background: var(--primary-gradient);
            color: white;
            position: relative;
            overflow: hidden;
        }
        
        .table thead::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, transparent 100%);
            pointer-events: none;
        }
        
        .table thead th {
            border: none;
            font-weight: 700;
            text-transform: uppercase;
            font-size: 0.75rem;
            letter-spacing: 1px;
            padding: 1.5rem 1rem;
            position: relative;
            z-index: 1;
        }
        
        .table tbody tr {
            transition: var(--transition);
            border-bottom: 1px solid rgba(102, 126, 234, 0.1);
        }
        
        .table tbody tr:last-child {
            border-bottom: none;
        }
        
        .table tbody tr:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05), rgba(118, 75, 162, 0.05));
            transform: translateX(8px);
            box-shadow: -4px 0 16px rgba(102, 126, 234, 0.1);
        }

        /* Badges */
        .badge {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-weight: 700;
            font-size: 0.75rem;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: var(--transition);
        }
        
        .badge:hover {
            transform: scale(1.05);
        }
        
        .badge.bg-success {
            background: var(--success-gradient) !important;
            color: white;
        }
        
        .badge.bg-warning {
            background: var(--warning-gradient) !important;
            color: #212529;
        }
        
        .badge.bg-danger {
            background: var(--danger-gradient) !important;
            color: white;
        }
        
        .badge.bg-primary {
            background: var(--primary-gradient) !important;
            color: white;
        }
        
        .badge.bg-secondary {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%) !important;
            color: white;
        }
        
        /* Tabs */
        .nav-tabs {
            border: none;
            margin-bottom: 2rem;
            background: transparent;
        }
        
        .nav-tabs .nav-link {
            border: 2px solid transparent;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            color: white !important;
            font-weight: 600;
            transition: var(--transition);
            margin-right: 0.5rem;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            position: relative;
            overflow: hidden;
        }
        
        .nav-tabs .nav-link::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.1);
            transition: var(--transition);
        }
        
        .nav-tabs .nav-link:hover::before {
            left: 100%;
        }
        
        .nav-tabs .nav-link:hover {
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }
        
        .nav-tabs .nav-link.active {
            background: rgba(255, 255, 255, 0.25);
            border-color: white;
            color: white !important;
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.3);
        }
        
        .nav-tabs .nav-link i {
            margin-right: 0.5rem;
        }
        
        /* Modals */
        .modal-content {
            border: none;
            border-radius: 20px;
            box-shadow: var(--shadow-lg);
            overflow: hidden;
        }

        .modal-header {
            background: var(--primary-gradient);
            color: white;
            border: none;
            padding: 1.5rem 2rem;
        }
        
        .modal-header .modal-title {
            font-weight: 700;
            font-size: 1.25rem;
        }
        
        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            border: none;
            padding: 1.5rem 2rem;
            background: #f8f9fa;
        }

        /* Alerts */
        .alert {
            border: none;
            border-radius: 12px;
            padding: 1rem 1.5rem;
            font-weight: 500;
        }
        
        /* Animations */
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .fade-in {
            animation: slideIn 0.5s ease-out;
        }
        
        /* Loading Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: #667eea;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .main-container {
                padding: 1rem 0;
            }
            
            .card-body {
                padding: 1.5rem;
            }
            
            .nav-tabs .nav-link {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }
        }
        
        /* Status Indicators */
        .status-active {
            color: #11998e;
        }
        
        .status-inactive {
            color: #6c757d;
        }
        
        .status-admin {
            background: var(--danger-gradient);
            color: white;
        }
        
        .status-user {
            background: var(--primary-gradient);
            color: white;
        }
    </style>
</head>
<body>
    <div class="content-wrapper">
    <!-- Navbar -->
        <nav class="navbar navbar-expand-lg">
        <div class="container">
                <a class="navbar-brand" href="portal.html">
                <i class="fas fa-cog me-2"></i>
                    Configura√ß√µes do Sistema
            </a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarContent">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="navbarContent">
            <div class="navbar-nav ms-auto">
                        <a class="nav-link" href="portal.html">
                            <i class="fas fa-home me-2"></i>Portal
                        </a>
                <div class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                        <i class="fas fa-user me-2"></i>
                        <span id="currentUser">Carregando...</span>
                    </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="portal.html"><i class="fas fa-home me-2"></i>Portal</a></li>
                                <li><a class="dropdown-item" href="coletas.html"><i class="fas fa-tasks me-2"></i>Coletas</a></li>
                        <li><a class="dropdown-item" href="relatorios.html"><i class="fas fa-chart-bar me-2"></i>Relat√≥rios</a></li>
                        <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Sair</a></li>
                    </ul>
                        </div>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Container -->
    <div class="main-container">
        <div class="container">
                <!-- Tabs -->
                <ul class="nav nav-tabs" id="configTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tabUsuarios" type="button">
                        <i class="fas fa-users me-2"></i>Usu√°rios
                        </button>
                </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabPermissoes" type="button">
                        <i class="fas fa-shield-alt me-2"></i>Permiss√µes
                        </button>
                </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabEvolutionAPI" type="button">
                            <i class="fas fa-key me-2"></i>Evolution API
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabEtiquetas" type="button">
                            <i class="fas fa-tags me-2"></i>Etiquetas
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tabSistema" type="button">
                            <i class="fas fa-cogs me-2"></i>Configura√ß√µes
                        </button>
                </li>
            </ul>

                <div class="tab-content mt-4">
                <!-- Tab Usu√°rios -->
                    <div class="tab-pane fade show active" id="tabUsuarios" role="tabpanel">
                        <div class="card fade-in">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-users me-2"></i>
                                Gerenciamento de Usu√°rios
                            </h5>
                        </div>
                        <div class="card-body">
                                <div class="mb-4">
                                    <button class="btn btn-primary" onclick="abrirModalNovoUsuario()">
                                    <i class="fas fa-plus me-2"></i>Adicionar Usu√°rio
                                </button>
                            </div>
                            <div class="table-responsive">
                                    <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Nome</th>
                                            <th>Email</th>
                                                <th>Role</th>
                                            <th>Status</th>
                                            <th>Criado em</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                    <tbody id="listaUsuarios">
                                            <tr>
                                                <td colspan="6" class="text-center py-5">
                                                    <div class="spinner mx-auto"></div>
                                                    <p class="text-muted mt-3">Carregando usu√°rios...</p>
                                                </td>
                                            </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Permiss√µes -->
                    <div class="tab-pane fade" id="tabPermissoes" role="tabpanel">
                        <div class="card fade-in">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-shield-alt me-2"></i>
                                    Gerenciamento de Permiss√µes
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">Selecionar Usu√°rio</label>
                                        <select id="selectUsuarioPermissoes" class="form-select" onchange="carregarPermissoesUsuario()">
                                        <option value="">Selecione um usu√°rio...</option>
                                    </select>
                                </div>
                                    <div class="col-md-8 mt-4 mt-md-0">
                                        <label class="form-label">Permiss√µes do Portal</label>
                                        <div id="containerPermissoesPortal" class="mt-3">
                                            <div class="alert alert-info">
                                                Selecione um usu√°rio para gerenciar suas permiss√µes
                                    </div>
                                </div>
                                        
                                        <label class="form-label mt-4">Permiss√µes de Coletas</label>
                                        <div id="containerPermissoesColetas" class="mt-3">
                                            <div class="alert alert-info">
                                                Selecione um usu√°rio para gerenciar suas permiss√µes
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Tab Evolution API -->
                    <div class="tab-pane fade" id="tabEvolutionAPI" role="tabpanel">
                        <div class="card fade-in">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-key me-2"></i>
                                    Credenciais da Evolution API
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Importante:</strong> Cada usu√°rio deve ter suas pr√≥prias credenciais da Evolution API para evitar que todas as mensagens saiam do mesmo n√∫mero. Gerencie suas credenciais aqui.
                                </div>
                                
                                <div class="mb-4">
                                    <button class="btn btn-primary" onclick="abrirModalNovaCredencial()">
                                        <i class="fas fa-plus me-2"></i>Adicionar Credencial
                                    </button>
                                </div>
                                
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>Usu√°rio</th>
                                                <th>Inst√¢ncia</th>
                                                <th>URL</th>
                                                <th>Status</th>
                                                <th>√öltima Valida√ß√£o</th>
                                                <th>A√ß√µes</th>
                                            </tr>
                                        </thead>
                                        <tbody id="listaCredenciaisAPI">
                                            <tr>
                                                <td colspan="6" class="text-center py-5">
                                                    <div class="spinner mx-auto"></div>
                                                    <p class="text-muted mt-3">Carregando credenciais...</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Etiquetas -->
                    <div class="tab-pane fade" id="tabEtiquetas" role="tabpanel">
                        <div class="card fade-in">
                            <div class="card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-tags me-2"></i>
                                    Gerenciamento de Etiquetas
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info">
                                    <i class="fas fa-info-circle me-2"></i>
                                    Crie etiquetas personalizadas para categorizar e organizar as coletas. 
                                    Todos os usu√°rios poder√£o usar as etiquetas criadas.
                                </div>
                                
                                <div class="mb-4">
                                    <button class="btn btn-primary" onclick="abrirModalNovaEtiqueta()">
                                        <i class="fas fa-plus me-2"></i>Criar Nova Etiqueta
                                    </button>
                                </div>

                                <div id="containerEtiquetas">
                                    <div class="d-flex justify-content-center py-5">
                                        <div class="text-center">
                                            <div class="spinner-border text-primary" role="status">
                                                <span class="visually-hidden">Carregando...</span>
                                            </div>
                                            <p class="text-muted mt-3">Carregando etiquetas...</p>
                                        </div>
                                    </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tab Sistema -->
                    <div class="tab-pane fade" id="tabSistema" role="tabpanel">
                        <div class="card fade-in">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-cogs me-2"></i>
                                    Configura√ß√µes do Sistema
                            </h5>
                        </div>
                        <div class="card-body">
                            <form id="formConfiguracoes">
                                <div class="row">
                                        <div class="col-md-6 mb-3">
                                        <label class="form-label">Nome da Empresa</label>
                                        <input type="text" id="nomeEmpresa" class="form-control">
                                    </div>
                                        <div class="col-md-6 mb-3">
                                        <label class="form-label">Email de Contato</label>
                                        <input type="email" id="emailContato" class="form-control">
                                    </div>
                                </div>
                                    <div class="row">
                                        <div class="col-md-6 mb-3">
                                        <label class="form-label">Tempo Limite Padr√£o (dias)</label>
                                        <input type="number" id="tempoLimitePadrao" class="form-control" min="1" max="365">
                                    </div>
                                        <div class="col-md-6 mb-3">
                                        <label class="form-label">Notifica√ß√µes por Email</label>
                                        <select id="notificacoesEmail" class="form-select">
                                            <option value="true">Ativadas</option>
                                            <option value="false">Desativadas</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <hr class="my-4">
                                
                                <div class="mb-4">
                                    <h6 class="mb-3">
                                        <i class="fas fa-bell text-danger me-2"></i>
                                        Notifica√ß√µes de Emerg√™ncia
                                    </h6>
                                    <div class="alert alert-warning">
                                        <i class="fas fa-exclamation-triangle me-2"></i>
                                        <strong>Aten√ß√£o:</strong> Selecione os usu√°rios que devem receber alertas de emerg√™ncia via WhatsApp quando um motorista acionar o bot√£o de emerg√™ncia.
                                        <br><small class="text-muted">Os usu√°rios devem ter telefone cadastrado no perfil para receber as notifica√ß√µes.</small>
                                    </div>
                                    <label class="form-label">Usu√°rios para receber notifica√ß√µes de emerg√™ncia</label>
                                    <div id="listaUsuariosEmergencia" class="border rounded p-3" style="max-height: 400px; overflow-y: auto; background-color: #f8f9fa;">
                                        <div class="text-center py-3">
                                            <div class="spinner-border spinner-border-sm text-primary" role="status">
                                                <span class="visually-hidden">Carregando...</span>
                                            </div>
                                            <p class="text-muted mt-2 mb-0">Carregando usu√°rios...</p>
                                        </div>
                                    </div>
                                </div>
                                
                                    <div class="mt-4">
                                        <button type="button" class="btn btn-primary" onclick="salvarConfiguracoesSistema()">
                                        <i class="fas fa-save me-2"></i>Salvar Configura√ß√µes
                                    </button>
                                </div>
                            </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Novo Usu√°rio -->
    <div class="modal fade" id="modalNovoUsuario" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-user-plus me-2"></i>Novo Usu√°rio
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formNovoUsuario">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nome Completo *</label>
                                <input type="text" id="nomeUsuarioInput" class="form-control" required>
                        </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Email *</label>
                                <input type="email" id="emailUsuarioInput" class="form-control" required>
                        </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Senha *</label>
                                <div class="input-group">
                                    <input type="password" id="senhaUsuarioInput" class="form-control" required 
                                           minlength="6" placeholder="M√≠nimo 6 caracteres"
                                           autocomplete="new-password">
                                    <button class="btn btn-outline-secondary" type="button" id="toggleSenhaUsuario" 
                                            onclick="togglePasswordVisibility('senhaUsuarioInput', 'toggleSenhaUsuario')">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                </div>
                                <small class="text-muted">A senha deve ter no m√≠nimo 6 caracteres</small>
                                <div id="senhaStrengthIndicator" class="mt-2" style="display: none;">
                                    <div class="progress" style="height: 4px;">
                                        <div class="progress-bar" id="senhaStrengthBar" role="progressbar" style="width: 0%"></div>
                                    </div>
                                    <small id="senhaStrengthText" class="text-muted"></small>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Tipo de Usu√°rio *</label>
                                <select id="tipoUsuarioInput" class="form-select" required>
                                    <option value="">Selecione...</option>
                                    <option value="user">Usu√°rio</option>
                                    <option value="admin">Administrador</option>
                                </select>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Departamento</label>
                                <input type="text" id="departamentoUsuarioInput" class="form-control" placeholder="Ex: TI, Comercial, Opera√ß√µes">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Cargo</label>
                                <input type="text" id="cargoUsuarioInput" class="form-control" placeholder="Ex: Desenvolvedor, Analista">
                            </div>
                        </div>
                        
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarNovoUsuario()">
                        <i class="fas fa-save me-2"></i>Salvar Usu√°rio
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nova Etiqueta -->
    <div class="modal fade" id="modalNovaEtiqueta" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-tag me-2"></i>Nova Etiqueta
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formNovaEtiqueta" onsubmit="event.preventDefault(); salvarNovaEtiqueta(); return false;">
                        <div class="mb-3">
                            <label class="form-label">Nome da Etiqueta *</label>
                            <input type="text" id="nomeEtiquetaInput" class="form-control" required 
                                   placeholder="Ex: Adiantamento de Frete" autocomplete="off">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Cor da Etiqueta *</label>
                            <div class="d-flex align-items-center gap-3">
                                <input type="color" id="corEtiquetaInput" class="form-control form-control-color" 
                                       value="#667eea" style="width: 80px; height: 50px; cursor: pointer;">
                                <input type="text" id="corEtiquetaHex" class="form-control" value="#667eea" 
                                       pattern="^#[0-9A-Fa-f]{6}$" placeholder="#667eea" 
                                       maxlength="7" autocomplete="off">
                            </div>
                            <small class="text-muted">Use o seletor de cor ou digite o c√≥digo hexadecimal (ex: #667eea)</small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descri√ß√£o</label>
                            <textarea id="descricaoEtiquetaInput" class="form-control" rows="3" 
                                      placeholder="Descreva para que serve esta etiqueta..." autocomplete="off"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Cancelar
                    </button>
                    <button type="button" class="btn btn-primary" onclick="salvarNovaEtiqueta()">
                        <i class="fas fa-save me-2"></i>Salvar Etiqueta
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Nova Credencial -->
    <div class="modal fade" id="modalNovaCredencial" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-key me-2"></i>Nova Credencial Evolution API
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formNovaCredencial">
                        <div class="mb-3">
                            <label class="form-label">Usu√°rio *</label>
                            <select id="usuarioCredencialSelect" class="form-select" required>
                                <option value="">Selecione um usu√°rio...</option>
                            </select>
                            <small class="form-text text-muted">
                                <i class="fas fa-shield-alt me-1"></i>
                                Cada usu√°rio deve ter suas pr√≥prias credenciais para evitar que todos compartilhem o mesmo n√∫mero
                            </small>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Nome da Inst√¢ncia *</label>
                            <input type="text" id="nomeInstancia" class="form-control" required placeholder="Ex: producao, homologacao">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">URL da API *</label>
                            <input type="url" id="urlAPI" class="form-control" required placeholder="http://127.0.0.1:8080">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">API Key *</label>
                            <input type="text" id="apiKey" class="form-control" required placeholder="Sua chave de API">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">M√°ximo de Conex√µes</label>
                            <input type="number" id="maxConexoes" class="form-control" value="10" min="1" max="100">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarNovaCredencial()">
                        <i class="fas fa-save me-2"></i>Salvar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/permissions.js"></script>
    <script>
        // ========== CONFIGURA√á√ÉO ==========
        let supabase = null;
        let currentUser = null;
        let usuariosData = [];
        let credenciaisAPI = [];
        let configuracoesSistema = {};

        // ========== INICIALIZA√á√ÉO ==========
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Iniciando Configura√ß√µes...');
            
            // üîê Verificar se √© admin ANTES de qualquer coisa
            const loggedInUserData = localStorage.getItem('loggedInUser');
            if (!loggedInUserData) {
                window.location.href = 'login.html';
                return;
            }
            
            const userData = JSON.parse(loggedInUserData);
            console.log('üë§ Verificando acesso do Settings:', userData.email);
            console.log('üëë isAdmin:', userData.isAdmin, 'role:', userData.role);
            
            // Settings SOMENTE para admins
            if (userData.isAdmin !== true && userData.role !== 'admin') {
                console.log('‚ùå Acesso negado ao Settings: usu√°rio n√£o √© admin');
                alert('Acesso Negado\n\nO Settings s√≥ √© acess√≠vel por administradores.');
                window.location.href = 'portal.html';
                return;
            }
            
            console.log('‚úÖ Usu√°rio √© admin, permitindo acesso ao Settings');
            
            await inicializarSupabase();
            await verificarAutenticacao();
            await carregarUsuarios();
            await carregarCredenciaisAPI();
            await carregarConfiguracoes();
            console.log('‚úÖ Configura√ß√µes carregadas com sucesso!');
        });

        // ========== SUPABASE ==========
        async function inicializarSupabase() {
            try {
                const response = await fetch('/api/supabase-config');
                if (!response.ok) throw new Error('Erro ao buscar configura√ß√µes');
                
                const config = await response.json();
                supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseAnonKey);
                window.supabase = supabase;
                
                console.log('‚úÖ Supabase inicializado');
                
                // Inicializar chat IA ap√≥s Supabase estar pronto
                if (window.inicializarChatIA) {
                    window.inicializarChatIA();
                }
                
                return true;
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Supabase:', error);
                mostrarErro('Erro ao conectar com o banco de dados');
                return false;
            }
        }

        // ========== AUTENTICA√á√ÉO ==========
        async function verificarAutenticacao() {
            try {
                console.log('üîê Verificando autentica√ß√£o...');
                
                const loggedInUserData = localStorage.getItem('loggedInUser');
                if (!loggedInUserData) {
                    console.log('‚ùå N√£o h√° dados no localStorage');
                    window.location.href = 'login.html';
                        return;
                }

                const userData = JSON.parse(loggedInUserData);
                const now = Date.now();
                const sessionAge = now - userData.loginTimestamp;
                const SESSION_TIMEOUT = 12 * 60 * 60 * 1000;

                if (sessionAge >= SESSION_TIMEOUT) {
                    console.log('‚ö†Ô∏è Sess√£o expirada');
                    localStorage.removeItem('loggedInUser');
                    window.location.href = 'login.html';
                    return;
                }

                // ‚úÖ Buscar role no Supabase
                let isAdmin = userData.isAdmin || userData.role === 'admin';
                try {
                    if (window.supabase) {
                        const { data: profile, error } = await window.supabase
                            .from('user_profiles')
                            .select('role, nome')
                            .eq('id', userData.id)
                    .single();

                        console.log('üìã Profile retornado:', profile);
                        if (!error && profile) {
                            isAdmin = profile.role === 'admin';
                            console.log('‚úÖ isAdmin definido como:', isAdmin, 'role:', profile.role);
                            if (profile.nome) {
                                userData.username = profile.nome;
                            }
                        } else {
                            console.error('‚ùå Erro ao buscar profile:', error);
                        }
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao buscar perfil:', error);
                }

                currentUser = {
                    id: userData.id,
                    email: userData.email,
                    username: userData.username,
                    nome: userData.username,
                    isAdmin: isAdmin,
                    role: userData.role || 'user'
                };

                const currentUserElement = document.getElementById('currentUser');
                if (currentUserElement) {
                    currentUserElement.textContent = currentUser.nome;
                }

                console.log('‚úÖ Usu√°rio autenticado:', currentUser.username);
                console.log('üëë √â admin:', currentUser.isAdmin);
                
                // ‚úÖ Permitir acesso - o controle ser√° nas funcionalidades espec√≠ficas
                return currentUser;
            } catch (error) {
                console.error('‚ùå Erro na verifica√ß√£o:', error);
                window.location.href = 'login.html';
            }
        }

        async function logout() {
            try {
                if (window.supabase) {
                    await window.supabase.auth.signOut();
                }
                localStorage.removeItem('loggedInUser');
                localStorage.removeItem('lastActivity');
                localStorage.removeItem('permissoesData');
                window.location.href = 'login.html';
            } catch (error) {
                console.error('‚ùå Erro no logout:', error);
                localStorage.removeItem('loggedInUser');
                localStorage.removeItem('lastActivity');
                localStorage.removeItem('permissoesData');
                window.location.href = 'login.html';
            }
        }

        // ========== USU√ÅRIOS ==========
        async function carregarUsuarios() {
            try {
                if (!window.supabase) {
                    console.error('‚ùå Supabase n√£o inicializado');
                    return;
                }

                const { data, error } = await window.supabase
                    .from('user_profiles')
                    .select('*')
                    .order('nome');

                if (error) throw error;

                usuariosData = data || [];
                renderizarUsuarios();
                atualizarSelectUsuarios();
                console.log('‚úÖ Usu√°rios carregados:', usuariosData.length);
            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rios:', error);
                usuariosData = [];
                document.getElementById('listaUsuarios').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <p class="text-danger">‚ùå Erro ao carregar usu√°rios: ${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }

        function renderizarUsuarios() {
            const tbody = document.getElementById('listaUsuarios');
            tbody.innerHTML = '';

            if (usuariosData.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <i class="fas fa-users fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Nenhum usu√°rio cadastrado</p>
                        </td>
                    </tr>
                `;
                return;
            }

            usuariosData.forEach(usuario => {
                const row = document.createElement('tr');
                const roleBadge = usuario.role === 'admin' 
                    ? '<span class="badge status-admin">Admin</span>'
                    : '<span class="badge status-user">Usu√°rio</span>';
                
                const statusBadge = usuario.active !== false
                    ? '<span class="badge bg-success">Ativo</span>'
                    : '<span class="badge bg-secondary">Inativo</span>';

                row.innerHTML = `
                    <td><strong>${usuario.nome || 'Sem nome'}</strong></td>
                    <td>${usuario.email || '-'}</td>
                    <td>${roleBadge}</td>
                    <td>${statusBadge}</td>
                    <td>${usuario.created_at ? new Date(usuario.created_at).toLocaleDateString('pt-BR') : '-'}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-warning btn-sm" onclick="editarUsuario('${usuario.id}')" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-${usuario.active !== false ? 'danger' : 'success'} btn-sm" onclick="toggleUsuario('${usuario.id}')" title="${usuario.active !== false ? 'Desativar' : 'Ativar'}">
                                <i class="fas fa-${usuario.active !== false ? 'pause' : 'play'}"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function atualizarSelectUsuarios() {
            const select = document.getElementById('selectUsuarioPermissoes');
            if (!select) return;

            select.innerHTML = '<option value="">Selecione um usu√°rio...</option>';
            usuariosData.forEach(usuario => {
                const option = document.createElement('option');
                option.value = usuario.id;
                option.textContent = usuario.nome || usuario.email || 'Usu√°rio sem nome';
                select.appendChild(option);
            });
        }

        function abrirModalNovoUsuario() {
            document.getElementById('formNovoUsuario').reset();
            document.getElementById('tipoUsuarioInput').value = 'user';
            document.getElementById('senhaStrengthIndicator').style.display = 'none';
            document.getElementById('toggleSenhaUsuario').innerHTML = '<i class="fas fa-eye"></i>';
            new bootstrap.Modal(document.getElementById('modalNovoUsuario')).show();
        }
        
        function togglePasswordVisibility(inputId, buttonId) {
            const input = document.getElementById(inputId);
            const button = document.getElementById(buttonId);
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }
        
        // Validar for√ßa da senha em tempo real
        document.addEventListener('DOMContentLoaded', function() {
            const senhaInput = document.getElementById('senhaUsuarioInput');
            if (senhaInput) {
                senhaInput.addEventListener('input', function() {
                    const senha = this.value;
                    const indicator = document.getElementById('senhaStrengthIndicator');
                    const bar = document.getElementById('senhaStrengthBar');
                    const text = document.getElementById('senhaStrengthText');
                    
                    if (senha.length === 0) {
                        indicator.style.display = 'none';
                        return;
                    }
                    
                    indicator.style.display = 'block';
                    
                    // Calcular for√ßa da senha
                    let strength = 0;
                    let strengthText = '';
                    let strengthColor = '';
                    
                    if (senha.length >= 6) strength += 25;
                    if (senha.length >= 8) strength += 15;
                    if (senha.length >= 12) strength += 10;
                    if (/[a-z]/.test(senha)) strength += 15;
                    if (/[A-Z]/.test(senha)) strength += 15;
                    if (/[0-9]/.test(senha)) strength += 10;
                    if (/[^a-zA-Z0-9]/.test(senha)) strength += 10;
                    
                    if (strength < 30) {
                        strengthText = 'Senha fraca';
                        strengthColor = 'bg-danger';
                    } else if (strength < 60) {
                        strengthText = 'Senha m√©dia';
                        strengthColor = 'bg-warning';
                    } else if (strength < 80) {
                        strengthText = 'Senha boa';
                        strengthColor = 'bg-info';
                    } else {
                        strengthText = 'Senha forte';
                        strengthColor = 'bg-success';
                    }
                    
                    bar.style.width = Math.min(strength, 100) + '%';
                    bar.className = 'progress-bar ' + strengthColor;
                    text.textContent = strengthText;
                });
            }
        });

        async function salvarNovoUsuario() {
            try {
                const nome = document.getElementById('nomeUsuarioInput').value;
                const email = document.getElementById('emailUsuarioInput').value;
                const senha = document.getElementById('senhaUsuarioInput').value;
                const tipo = document.getElementById('tipoUsuarioInput').value;
                const departamento = document.getElementById('departamentoUsuarioInput').value;
                const cargo = document.getElementById('cargoUsuarioInput').value;

                if (!nome || !email || !senha || !tipo) {
                    mostrarErro('Preencha todos os campos obrigat√≥rios');
                    return;
                }
                
                // Validar tamanho m√≠nimo da senha
                if (senha.length < 6) {
                    mostrarErro('A senha deve ter no m√≠nimo 6 caracteres');
                    document.getElementById('senhaUsuarioInput').focus();
                    return;
                }

                // Criar usu√°rio no Supabase Auth
                const { data: authData, error: authError } = await window.supabase.auth.signUp({
                    email: email,
                    password: senha,
                    options: {
                        data: {
                            nome: nome,
                            role: tipo,
                            departamento: departamento,
                            cargo: cargo
                        }
                    }
                });

                if (authError) throw authError;

                // O trigger handle_new_user cria automaticamente o perfil
                // Aguardar um pouco para garantir que o trigger executou
                await new Promise(resolve => setTimeout(resolve, 1000));

                // Atualizar perfil criado pelo trigger com dados adicionais
                try {
                    const updateData = {
                        nome: nome,
                        email: email,
                        role: tipo
                    };
                    
                    if (departamento) updateData.departamento = departamento;
                    if (cargo) updateData.cargo = cargo;
                    
                    const { error: updateError } = await window.supabase
                        .from('user_profiles')
                        .update(updateData)
                        .eq('id', authData.user.id);

                    if (updateError) {
                        console.warn('‚ö†Ô∏è Erro ao atualizar perfil:', updateError);
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao atualizar perfil:', error);
                }

                bootstrap.Modal.getInstance(document.getElementById('modalNovoUsuario')).hide();
                mostrarSucesso('Usu√°rio criado com sucesso!');
                await carregarUsuarios();
            } catch (error) {
                console.error('‚ùå Erro ao criar usu√°rio:', error);
                mostrarErro('Erro ao criar usu√°rio: ' + error.message);
            }
        }

        async function editarUsuario(usuarioId) {
            mostrarInfo('Funcionalidade de edi√ß√£o em desenvolvimento');
        }

        async function toggleUsuario(usuarioId) {
            try {
                const usuario = usuariosData.find(u => u.id === usuarioId);
                if (!usuario) return;

                const novoStatus = usuario.active !== false ? false : true;

                const { error } = await window.supabase
                    .from('user_profiles')
                    .update({ active: novoStatus })
                    .eq('id', usuarioId);

                if (error) throw error;

                mostrarSucesso(`Usu√°rio ${novoStatus ? 'ativado' : 'desativado'} com sucesso!`);
                await carregarUsuarios();
            } catch (error) {
                console.error('‚ùå Erro ao alterar status:', error);
                mostrarErro('Erro ao alterar status do usu√°rio');
            }
        }

        // ========== PERMISS√ïES ==========
        async function carregarPermissoesUsuario() {
            const usuarioId = document.getElementById('selectUsuarioPermissoes').value;
            if (!usuarioId) {
                document.getElementById('containerPermissoesPortal').innerHTML = '<div class="alert alert-info">Selecione um usu√°rio para gerenciar suas permiss√µes</div>';
                document.getElementById('containerPermissoesColetas').innerHTML = '<div class="alert alert-info">Selecione um usu√°rio para gerenciar suas permiss√µes</div>';
                return;
            }

            try {
                // Carregar permiss√µes do portal
                const { data: permissoesPortal, error: errorPortal } = await window.supabase
                    .from('permissoes_portal')
                    .select('tipo, permissao_id')
                    .eq('usuario_id', usuarioId);

                if (!errorPortal) {
                    renderizarPermissoesPortal(permissoesPortal || []);
                }

                // Carregar permiss√µes de coletas
                const { data: permissoesColetas, error: errorColetas } = await window.supabase
                    .from('permissoes_coletas')
                    .select('etapa_id')
                    .eq('usuario_id', usuarioId);

                if (!errorColetas) {
                    renderizarPermissoesColetas(permissoesColetas || []);
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar permiss√µes:', error);
                mostrarErro('Erro ao carregar permiss√µes');
            }
        }

        function renderizarPermissoesPortal(permissoes) {
            const container = document.getElementById('containerPermissoesPortal');
            container.innerHTML = `
                <div class="alert alert-info mb-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Como usar:</strong> Selecione um usu√°rio acima e depois habilite/desabilite as permiss√µes desejadas. As altera√ß√µes s√£o salvas automaticamente.
                </div>
                <div class="row mb-2">
                    <div class="col-12">
                        <h6 class="text-muted mb-2"><i class="fas fa-rocket"></i> Opera√ß√µes</h6>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalPainel" 
                                ${permissoes.some(p => p.permissao_id === 'painel') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('painel', this.checked)">
                            <label class="form-check-label" for="permPortalPainel">Painel de Disparos</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalColetas" 
                                ${permissoes.some(p => p.permissao_id === 'coletas') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('coletas', this.checked)">
                            <label class="form-check-label" for="permPortalColetas">Sistema de Coletas</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalHistoricoColetas" 
                                ${permissoes.some(p => p.permissao_id === 'historico-coletas') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('historico-coletas', this.checked)">
                            <label class="form-check-label" for="permPortalHistoricoColetas">Hist√≥rico de Coletas</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalMonitoramento" 
                                ${permissoes.some(p => p.permissao_id === 'monitoramento') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('monitoramento', this.checked)">
                            <label class="form-check-label" for="permPortalMonitoramento">Monitoramento</label>
                        </div>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-12">
                        <h6 class="text-muted mb-2"><i class="fas fa-users"></i> Gest√£o</h6>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalCadastro" 
                                ${permissoes.some(p => p.permissao_id === 'cadastro') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('cadastro', this.checked)">
                            <label class="form-check-label" for="permPortalCadastro">Cadastro de Motoristas</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalRelatorios" 
                                ${permissoes.some(p => p.permissao_id === 'relatorios') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('relatorios', this.checked)">
                            <label class="form-check-label" for="permPortalRelatorios">Relat√≥rios e BI</label>
                        </div>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-12">
                        <h6 class="text-muted mb-2"><i class="fas fa-handshake"></i> Comercial</h6>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalComercial" 
                                ${permissoes.some(p => p.permissao_id === 'comercial') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('comercial', this.checked)">
                            <label class="form-check-label" for="permPortalComercial">Comercial</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalCRM" 
                                ${permissoes.some(p => p.permissao_id === 'crm') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('crm', this.checked)">
                            <label class="form-check-label" for="permPortalCRM">CRM</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalVendas" 
                                ${permissoes.some(p => p.permissao_id === 'vendas') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('vendas', this.checked)">
                            <label class="form-check-label" for="permPortalVendas">Vendas</label>
                        </div>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-12">
                        <h6 class="text-muted mb-2"><i class="fas fa-dollar-sign"></i> Financeiro</h6>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalContasPagar" 
                                ${permissoes.some(p => p.permissao_id === 'contas-pagar') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('contas-pagar', this.checked)">
                            <label class="form-check-label" for="permPortalContasPagar">Contas a Pagar</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalContasReceber" 
                                ${permissoes.some(p => p.permissao_id === 'contas-receber') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('contas-receber', this.checked)">
                            <label class="form-check-label" for="permPortalContasReceber">Contas a Receber</label>
                        </div>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-12">
                        <h6 class="text-muted mb-2"><i class="fas fa-users"></i> Recursos Humanos</h6>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalFolha" 
                                ${permissoes.some(p => p.permissao_id === 'folha') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('folha', this.checked)">
                            <label class="form-check-label" for="permPortalFolha">Folha de Pagamento</label>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalRecrutamento" 
                                ${permissoes.some(p => p.permissao_id === 'recrutamento') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('recrutamento', this.checked)">
                            <label class="form-check-label" for="permPortalRecrutamento">Recrutamento</label>
                        </div>
                    </div>
                </div>
                <div class="row mb-2">
                    <div class="col-12">
                        <h6 class="text-muted mb-2"><i class="fas fa-award"></i> Qualidade</h6>
                    </div>
                    <div class="col-md-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permPortalQualidade" 
                                ${permissoes.some(p => p.permissao_id === 'qualidade') ? 'checked' : ''}
                                onchange="salvarPermissaoPortal('qualidade', this.checked)">
                            <label class="form-check-label" for="permPortalQualidade">Treinamentos e Documentos</label>
                        </div>
                    </div>
                </div>
                `;
        }

        function renderizarPermissoesColetas(permissoes) {
            const etapasColetas = ['comercial', 'price', 'cs', 'contratacao', 'gr', 'documentacao', 'controladoria', 'contas_pagar', 'contas_receber', 'monitoramento'];
            const etapaNomes = {
                'comercial': 'Comercial',
                'price': 'Price',
                'cs': 'CS',
                'contratacao': 'Contrata√ß√£o',
                'gr': 'GR',
                'documentacao': 'Documenta√ß√£o',
                'controladoria': 'Controladoria',
                'contas_pagar': 'Contas a Pagar',
                'contas_receber': 'Contas a Receber',
                'monitoramento': 'Monitoramento'
            };

            const container = document.getElementById('containerPermissoesColetas');
            const rows = [];
            
            etapasColetas.forEach((etapa, index) => {
                if (index % 3 === 0) {
                    if (index > 0) {
                        rows.push('</div>');
                    }
                    rows.push('<div class="row mb-2">');
                }
                rows.push(`
                    <div class="col-md-4">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="permColeta${etapa}" 
                                ${permissoes.some(p => p.etapa_id === etapa) ? 'checked' : ''}
                                onchange="salvarPermissaoColeta('${etapa}', this.checked)">
                            <label class="form-check-label" for="permColeta${etapa}">${etapaNomes[etapa] || etapa}</label>
                        </div>
                    </div>
                `);
            });
            rows.push('</div>');
            
            container.innerHTML = rows.join('');
        }

        async function salvarPermissaoPortal(permissaoId, permitido) {
            const usuarioId = document.getElementById('selectUsuarioPermissoes').value;
            if (!usuarioId) {
                mostrarErro('Selecione um usu√°rio primeiro');
                return;
            }

            console.log(`üíæ Salvando permiss√£o do portal:`);
            console.log(`üë§ Usu√°rio ID: ${usuarioId}`);
            console.log(`üîë Permiss√£o: ${permissaoId}`);
            console.log(`‚úÖ Permitido: ${permitido}`);
            console.log(`üîß Cliente Supabase dispon√≠vel:`, !!supabase);

            try {
                if (permitido) {
                    // Verificar se a permiss√£o j√° existe antes de inserir
                    const { data: existing, error: checkError } = await supabase
                        .from('permissoes_portal')
                        .select('id')
                        .eq('usuario_id', usuarioId)
                        .eq('permissao_id', permissaoId)
                        .maybeSingle();
                    
                    if (checkError && checkError.code !== 'PGRST116') {
                        throw checkError;
                    }
                    
                    // Se n√£o existe, inserir
                    if (!existing) {
                        console.log(`üìù Inserindo nova permiss√£o ${permissaoId}...`);
                        const { data, error } = await supabase
                            .from('permissoes_portal')
                            .insert([{
                                usuario_id: usuarioId,
                                tipo: 'permissao',
                                permissao_id: permissaoId
                            }]);
                        if (error) {
                            console.error('‚ùå Erro ao inserir:', error);
                            throw error;
                        }
                        console.log('‚úÖ Permiss√£o inserida com sucesso:', data);
                    } else {
                        console.log(`‚ö†Ô∏è Permiss√£o j√° existe: ${permissaoId}`);
                    }
                } else {
                    console.log(`üóëÔ∏è Removendo permiss√£o ${permissaoId}...`);
                    const { error } = await supabase
                        .from('permissoes_portal')
                        .delete()
                        .eq('usuario_id', usuarioId)
                        .eq('permissao_id', permissaoId);
                    if (error) {
                        console.error('‚ùå Erro ao deletar:', error);
                        throw error;
                    }
                    console.log('‚úÖ Permiss√£o removida com sucesso');
                }
                console.log(`‚úÖ Permiss√£o ${permitido ? 'adicionada' : 'removida'}: ${permissaoId}`);
                mostrarSucesso(`Permiss√£o ${permitido ? 'habilitada' : 'desabilitada'} com sucesso!`);
            } catch (error) {
                console.error('‚ùå Erro ao salvar permiss√£o:', error);
                mostrarErro(`Erro ao salvar permiss√£o: ${error.message}`);
            }
        }

        async function salvarPermissaoColeta(etapaId, permitido) {
            const usuarioId = document.getElementById('selectUsuarioPermissoes').value;
            if (!usuarioId) {
                mostrarErro('Selecione um usu√°rio primeiro');
                return;
            }

            console.log(`üíæ Salvando permiss√£o de coleta:`);
            console.log(`üë§ Usu√°rio ID: ${usuarioId}`);
            console.log(`üîë Etapa: ${etapaId}`);
            console.log(`‚úÖ Permitido: ${permitido}`);

            try {
                if (permitido) {
                    // Verificar se a permiss√£o j√° existe antes de inserir
                    const { data: existing, error: checkError } = await supabase
                        .from('permissoes_coletas')
                        .select('id')
                        .eq('usuario_id', usuarioId)
                        .eq('etapa_id', etapaId)
                        .maybeSingle();
                    
                    if (checkError && checkError.code !== 'PGRST116') {
                        throw checkError;
                    }
                    
                    // Se n√£o existe, inserir
                    if (!existing) {
                        console.log(`üìù Inserindo nova permiss√£o de coleta ${etapaId}...`);
                        const { data, error } = await supabase
                            .from('permissoes_coletas')
                            .insert([{
                                usuario_id: usuarioId,
                                etapa_id: etapaId
                            }]);
                        if (error) {
                            console.error('‚ùå Erro ao inserir:', error);
                            throw error;
                        }
                        console.log('‚úÖ Permiss√£o inserida com sucesso:', data);
                    } else {
                        console.log(`‚ö†Ô∏è Permiss√£o de coleta j√° existe: ${etapaId}`);
                    }
                } else {
                    console.log(`üóëÔ∏è Removendo permiss√£o de coleta ${etapaId}...`);
                    const { error } = await supabase
                        .from('permissoes_coletas')
                        .delete()
                        .eq('usuario_id', usuarioId)
                        .eq('etapa_id', etapaId);
                    if (error) {
                        console.error('‚ùå Erro ao deletar:', error);
                        throw error;
                    }
                    console.log('‚úÖ Permiss√£o removida com sucesso');
                }
                console.log(`‚úÖ Permiss√£o de coleta ${permitido ? 'adicionada' : 'removida'}: ${etapaId}`);
                mostrarSucesso(`Permiss√£o de coleta ${permitido ? 'habilitada' : 'desabilitada'} com sucesso!`);
            } catch (error) {
                console.error('‚ùå Erro ao salvar permiss√£o de coleta:', error);
                mostrarErro(`Erro ao salvar permiss√£o de coleta: ${error.message}`);
            }
        }

        // ========== EVOLUTION API ==========
        async function carregarCredenciaisAPI() {
            if (!currentUser || !currentUser.id) return;

            try {
                let query = window.supabase
                    .from('user_evolution_apis')
                    .select(`
                        *,
                        user_profiles:user_id (
                            id,
                            nome,
                            email
                        )
                    `);
                
                // Se n√£o √© admin, mostrar apenas as pr√≥prias credenciais
                if (!currentUser.isAdmin) {
                    query = query.eq('user_id', currentUser.id);
                }
                
                const { data, error } = await query
                    .order('created_at', { ascending: false });

                    if (error) throw error;

                credenciaisAPI = data || [];
                
                // Corrigir refer√™ncia de user_profiles se necess√°rio
                for (let i = 0; i < credenciaisAPI.length; i++) {
                    const credencial = credenciaisAPI[i];
                    if (credencial.user_profiles && Array.isArray(credencial.user_profiles) && credencial.user_profiles.length > 0) {
                        credencial.user_profile = credencial.user_profiles[0];
                    }
                }
                
                renderizarCredenciaisAPI();
                console.log('‚úÖ Credenciais carregadas:', credenciaisAPI.length);
            } catch (error) {
                console.error('‚ùå Erro ao carregar credenciais:', error);
                credenciaisAPI = [];
                document.getElementById('listaCredenciaisAPI').innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <p class="text-danger">‚ùå Erro ao carregar credenciais: ${error.message}</p>
                        </td>
                    </tr>
                `;
            }
        }

        function renderizarCredenciaisAPI() {
            const tbody = document.getElementById('listaCredenciaisAPI');
            tbody.innerHTML = '';

            if (credenciaisAPI.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="text-center py-5">
                            <i class="fas fa-key fa-3x text-muted mb-3"></i>
                            <p class="text-muted">Nenhuma credencial cadastrada</p>
                            <p class="text-muted small">Clique em "Adicionar Credencial" para come√ßar</p>
                        </td>
                    </tr>
                `;
                return;
            }

            credenciaisAPI.forEach(credencial => {
                const row = document.createElement('tr');
                
                // Buscar nome do usu√°rio
                let nomeUsuario = 'Usu√°rio n√£o encontrado';
                let isOwner = false;
                
                if (credencial.user_profile) {
                    nomeUsuario = credencial.user_profile.nome || credencial.user_profile.email || 'Sem nome';
                } else if (credencial.user_profiles && Array.isArray(credencial.user_profiles) && credencial.user_profiles.length > 0) {
                    nomeUsuario = credencial.user_profiles[0].nome || credencial.user_profiles[0].email || 'Sem nome';
                } else {
                    // Tentar buscar na lista de usu√°rios carregada
                    const usuarioData = usuariosData.find(u => u.id === credencial.user_id);
                    if (usuarioData) {
                        nomeUsuario = usuarioData.nome || usuarioData.email || 'Sem nome';
                    }
                }
                
                // Verificar se √© o dono da credencial
                if (credencial.user_id === currentUser.id) {
                    isOwner = true;
                    nomeUsuario += ' <span class="badge bg-primary">Voc√™</span>';
                }
                
                row.innerHTML = `
                    <td>${nomeUsuario}</td>
                    <td><strong>${credencial.instance_name}</strong></td>
                    <td><code>${credencial.api_url}</code></td>
                    <td>${credencial.is_valid ? '<span class="badge bg-success">V√°lida</span>' : '<span class="badge bg-warning">N√£o validada</span>'}</td>
                    <td>${credencial.last_validated ? new Date(credencial.last_validated).toLocaleDateString('pt-BR') : '-'}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-info btn-sm" onclick="validarCredencial('${credencial.id}')" title="Validar">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="excluirCredencial('${credencial.id}')" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        async function abrirModalNovaCredencial() {
            document.getElementById('formNovaCredencial').reset();
            document.getElementById('maxConexoes').value = '10';
            
            // Preencher select de usu√°rios
            const select = document.getElementById('usuarioCredencialSelect');
            select.innerHTML = '<option value="">Selecione um usu√°rio...</option>';
            
            // Se n√£o √© admin, mostrar apenas o pr√≥prio usu√°rio e desabilitar o select
            if (!currentUser.isAdmin) {
                select.innerHTML += `<option value="${currentUser.id}" selected>${currentUser.nome || currentUser.username} (Voc√™)</option>`;
                select.disabled = true;
            } else {
                // Se √© admin, listar todos os usu√°rios
                select.disabled = false;
                usuariosData.forEach(usuario => {
                    select.innerHTML += `<option value="${usuario.id}">${usuario.nome || usuario.email} ${usuario.role === 'admin' ? '(Admin)' : ''}</option>`;
                });
            }
            
            new bootstrap.Modal(document.getElementById('modalNovaCredencial')).show();
        }

        async function salvarNovaCredencial() {
            if (!currentUser || !currentUser.id) {
                mostrarErro('Usu√°rio n√£o autenticado');
                return;
            }

            try {
                const usuarioId = document.getElementById('usuarioCredencialSelect').value;
                const nomeInstancia = document.getElementById('nomeInstancia').value;
                const urlAPI = document.getElementById('urlAPI').value;
                const apiKey = document.getElementById('apiKey').value;
                const maxConexoes = parseInt(document.getElementById('maxConexoes').value) || 10;

                console.log('üíæ Salvando credencial:');
                console.log('üë§ Usu√°rio atual:', currentUser);
                console.log('üÜî ID do usu√°rio selecionado:', usuarioId);
                console.log('üè∑Ô∏è Inst√¢ncia:', nomeInstancia);

                if (!usuarioId || !nomeInstancia || !urlAPI || !apiKey) {
                    mostrarErro('Preencha todos os campos obrigat√≥rios');
                    return;
                }

                // Verificar se √© admin ou se est√° tentando adicionar para si mesmo
                if (!currentUser.isAdmin && usuarioId !== currentUser.id) {
                    mostrarErro('Voc√™ s√≥ pode adicionar credenciais para voc√™ mesmo');
                    return;
                }

                const novaCredencial = {
                    user_id: usuarioId,
                    instance_name: nomeInstancia,
                    api_url: urlAPI,
                    api_key: apiKey,
                    max_connections: maxConexoes,
                    active: true
                };

                console.log('üìù Dados a serem salvos:', {
                    user_id: novaCredencial.user_id,
                    instance_name: novaCredencial.instance_name,
                    api_url: novaCredencial.api_url,
                    api_key: novaCredencial.api_key ? '***' + novaCredencial.api_key.slice(-4) : 'N/A'
                });

                const { data, error } = await window.supabase
                    .from('user_evolution_apis')
                    .insert([novaCredencial])
                    .select();

                if (error) {
                    console.error('‚ùå Erro ao salvar:', error);
                    throw error;
                }

                console.log('‚úÖ Credencial salva com sucesso:', data);

                bootstrap.Modal.getInstance(document.getElementById('modalNovaCredencial')).hide();
                mostrarSucesso('Credencial salva com sucesso!');
                await carregarCredenciaisAPI();
            } catch (error) {
                console.error('‚ùå Erro ao salvar credencial:', error);
                mostrarErro('Erro ao salvar credencial: ' + error.message);
            }
        }

        async function validarCredencial(credencialId) {
            try {
                const { error } = await window.supabase
                    .from('user_evolution_apis')
                    .update({ 
                        is_valid: true,
                        last_validated: new Date().toISOString()
                    })
                    .eq('id', credencialId);

                if (error) throw error;

                mostrarSucesso('Credencial validada com sucesso!');
                await carregarCredenciaisAPI();
            } catch (error) {
                console.error('‚ùå Erro ao validar credencial:', error);
                mostrarErro('Erro ao validar credencial');
            }
        }

        async function excluirCredencial(credencialId) {
            if (!confirm('Tem certeza que deseja excluir esta credencial?')) return;

            try {
                const { error } = await window.supabase
                    .from('user_evolution_apis')
                    .delete()
                    .eq('id', credencialId);

                if (error) throw error;

                mostrarSucesso('Credencial exclu√≠da com sucesso!');
                await carregarCredenciaisAPI();
            } catch (error) {
                console.error('‚ùå Erro ao excluir credencial:', error);
                mostrarErro('Erro ao excluir credencial');
            }
        }

        // ========== CONFIGURA√á√ïES ==========
        async function carregarConfiguracoes() {
            try {
                const { data, error } = await window.supabase
                    .from('configuracoes_sistema')
                    .select('*');

                if (error) throw error;

                configuracoesSistema = {};
                data.forEach(config => {
                    configuracoesSistema[config.chave] = config.valor;
                });

                document.getElementById('nomeEmpresa').value = configuracoesSistema.nome_empresa || '';
                document.getElementById('emailContato').value = configuracoesSistema.email_contato || '';
                document.getElementById('tempoLimitePadrao').value = configuracoesSistema.tempo_limite_padrao || 30;
                document.getElementById('notificacoesEmail').value = configuracoesSistema.notificacoes_email || 'true';

                // Carregar configura√ß√£o de emerg√™ncia
                let emergenciaConfig = configuracoesSistema.emergencia_notificacoes || {};
                
                // Se o valor veio como string JSON, fazer parse
                if (typeof emergenciaConfig === 'string') {
                    try {
                        emergenciaConfig = JSON.parse(emergenciaConfig);
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Erro ao fazer parse da configura√ß√£o de emerg√™ncia:', e);
                        emergenciaConfig = {};
                    }
                }
                
                const usuariosEmergencia = emergenciaConfig.usuarios || [];
                console.log('üë• Usu√°rios carregados da configura√ß√£o:', usuariosEmergencia);
                
                // Carregar lista de usu√°rios para emerg√™ncia
                await carregarUsuariosEmergencia(usuariosEmergencia);

                console.log('‚úÖ Configura√ß√µes carregadas');
            } catch (error) {
                console.error('‚ùå Erro ao carregar configura√ß√µes:', error);
            }
        }

        async function salvarConfiguracoesSistema() {
            try {
                const configuracoes = {
                    nome_empresa: document.getElementById('nomeEmpresa').value,
                    email_contato: document.getElementById('emailContato').value,
                    tempo_limite_padrao: parseInt(document.getElementById('tempoLimitePadrao').value),
                    notificacoes_email: document.getElementById('notificacoesEmail').value
                };

                for (const [chave, valor] of Object.entries(configuracoes)) {
                    const { error } = await window.supabase
                        .from('configuracoes_sistema')
                        .upsert({
                            chave: chave,
                            valor: valor,
                            updated_at: new Date().toISOString()
                        }, {
                            onConflict: 'chave'
                        });

                    if (error) throw error;
                }

                // Salvar configura√ß√£o de emerg√™ncia
                const usuariosSelecionados = Array.from(document.querySelectorAll('#listaUsuariosEmergencia input[type="checkbox"]:checked'))
                    .map(cb => cb.value)
                    .filter(id => id); // Filtrar valores vazios
                
                console.log('üë• Usu√°rios selecionados para emerg√™ncia:', usuariosSelecionados);
                
                const valorConfig = { usuarios: usuariosSelecionados };
                
                const { error: emergenciaError } = await window.supabase
                    .from('configuracoes_sistema')
                    .upsert({
                        chave: 'emergencia_notificacoes',
                        valor: valorConfig,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'chave'
                    });

                if (emergenciaError) {
                    console.error('‚ùå Erro ao salvar configura√ß√£o de emerg√™ncia:', emergenciaError);
                    throw emergenciaError;
                }
                
                console.log('‚úÖ Configura√ß√£o de emerg√™ncia salva com sucesso:', valorConfig);

                mostrarSucesso('Configura√ß√µes salvas com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro ao salvar configura√ß√µes:', error);
                mostrarErro('Erro ao salvar configura√ß√µes: ' + error.message);
            }
        }

        async function carregarUsuariosEmergencia(usuariosSelecionados = []) {
            try {
                const container = document.getElementById('listaUsuariosEmergencia');
                if (!container) {
                    console.error('‚ùå Container listaUsuariosEmergencia n√£o encontrado!');
                    return;
                }
                
                // Normalizar IDs selecionados
                const idsSelecionados = usuariosSelecionados.map(id => String(id));
                console.log('üîç Usu√°rios j√° selecionados:', idsSelecionados);
                
                // Buscar usu√°rios
                const { data: usuarios, error } = await window.supabase
                    .from('user_profiles')
                    .select('id, nome, email, telefone, role, active')
                    .eq('active', true)
                    .order('nome');

                if (error) throw error;

                if (!usuarios || usuarios.length === 0) {
                    container.innerHTML = '<p class="text-muted text-center py-3">Nenhum usu√°rio encontrado.</p>';
                    return;
                }
                
                console.log('üë§ Total de usu√°rios:', usuarios.length);

                // LIMPAR E RECRIAR TUDO com estrutura simples e funcional
                container.innerHTML = '';
                
                // Criar div wrapper
                const wrapper = document.createElement('div');
                
                usuarios.forEach(usuario => {
                    const usuarioId = String(usuario.id);
                    const estaSelecionado = idsSelecionados.includes(usuarioId);
                    const temTelefone = !!usuario.telefone;
                    const checkboxId = `emergencia_${usuario.id.replace(/[^a-zA-Z0-9]/g, '_')}`;
                    
                    // Criar label que envolve tudo (permite clicar em qualquer lugar)
                    const label = document.createElement('label');
                    label.className = `usuario-emergencia-item ${estaSelecionado ? 'selected' : ''} ${!temTelefone ? 'disabled' : ''}`;
                    label.style.cursor = temTelefone ? 'pointer' : 'not-allowed';
                    
                    // Criar checkbox
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = checkboxId;
                    checkbox.name = 'emergencia_usuario';
                    checkbox.value = usuario.id;
                    checkbox.checked = estaSelecionado;
                    checkbox.disabled = !temTelefone;
                    
                    // Info do usu√°rio
                    const infoDiv = document.createElement('div');
                    infoDiv.className = 'usuario-emergencia-info';
                    
                    const nomeDiv = document.createElement('div');
                    nomeDiv.style.cssText = 'display: flex; align-items: center; gap: 8px; margin-bottom: 4px;';
                    
                    const nomeStrong = document.createElement('strong');
                    nomeStrong.textContent = usuario.nome || 'Sem nome';
                    nomeDiv.appendChild(nomeStrong);
                    
                    const roleBadge = document.createElement('span');
                    roleBadge.className = 'badge bg-secondary';
                    roleBadge.textContent = usuario.role || 'user';
                    nomeDiv.appendChild(roleBadge);
                    
                    if (!temTelefone) {
                        const telBadge = document.createElement('span');
                        telBadge.className = 'badge bg-warning text-dark';
                        telBadge.textContent = 'Sem telefone';
                        nomeDiv.appendChild(telBadge);
                    }
                    
                    const emailSmall = document.createElement('small');
                    emailSmall.className = 'text-muted d-block';
                    emailSmall.textContent = `${usuario.email || 'Sem email'}${usuario.telefone ? ` ‚Ä¢ ${usuario.telefone}` : ''}`;
                    
                    infoDiv.appendChild(nomeDiv);
                    infoDiv.appendChild(emailSmall);
                    
                    // Montar estrutura
                    label.appendChild(checkbox);
                    label.appendChild(infoDiv);
                    wrapper.appendChild(label);
                    
                    // Event listener no checkbox para atualizar classe visual
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            label.classList.add('selected');
                        } else {
                            label.classList.remove('selected');
                        }
                        console.log('‚úÖ Checkbox alterado:', this.value, 'Marcado:', this.checked);
                    });
                });
                
                container.appendChild(wrapper);
                
                console.log(`‚úÖ ${usuarios.length} usu√°rios carregados com checkboxes funcionais`);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar usu√°rios para emerg√™ncia:', error);
                const container = document.getElementById('listaUsuariosEmergencia');
                if (container) {
                    container.innerHTML = '<div class="alert alert-danger">Erro ao carregar usu√°rios: ' + error.message + '</div>';
                }
            }
        }

        // ========== UTILIT√ÅRIOS ==========
        function mostrarSucesso(mensagem) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);';
            alert.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>${mensagem}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) alert.parentNode.removeChild(alert);
            }, 5000);
        }

        function mostrarErro(mensagem) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-danger alert-dismissible fade show position-fixed';
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 20px rgba(0,0,0,0.2);';
            alert.innerHTML = `
                <i class="fas fa-exclamation-circle me-2"></i>${mensagem}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);
            
            setTimeout(() => {
                if (alert.parentNode) alert.parentNode.removeChild(alert);
            }, 5000);
        }

        function mostrarInfo(mensagem) {
            mostrarSucesso(mensagem);
        }

        // ========== GERENCIAMENTO DE ETIQUETAS ==========
        async function carregarEtiquetas() {
            try {
                const { data, error } = await window.supabase
                    .from('etiquetas_coletas')
                    .select('*')
                    .order('nome', { ascending: true });

                if (error) throw error;

                const container = document.getElementById('containerEtiquetas');
                if (!container) return;

                if (!data || data.length === 0) {
                    container.innerHTML = `
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            Nenhuma etiqueta criada ainda. Clique em "Criar Nova Etiqueta" para come√ßar.
                        </div>
                    `;
                    return;
                }

                container.innerHTML = `
                    <div class="row g-3">
                        ${data.map(etiqueta => `
                            <div class="col-md-4">
                                <div class="card border-0 shadow-sm">
                                    <div class="card-body">
                                        <div class="d-flex align-items-start justify-content-between mb-2">
                                            <div>
                                                <span class="badge" style="background: ${etiqueta.cor}; color: white; padding: 0.5rem 1rem;">
                                                    <i class="fas fa-tag me-1"></i>${etiqueta.nome}
                                                </span>
                                            </div>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-secondary" onclick="editarEtiqueta('${etiqueta.id}')" title="Editar">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" onclick="excluirEtiqueta('${etiqueta.id}', '${etiqueta.nome}')" title="Excluir">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        </div>
                                        ${etiqueta.descricao ? `<p class="text-muted small mb-0">${etiqueta.descricao}</p>` : ''}
                                        <small class="text-muted">
                                            ${etiqueta.ativo ? '<span class="text-success"><i class="fas fa-check-circle"></i> Ativa</span>' : '<span class="text-danger"><i class="fas fa-times-circle"></i> Inativa</span>'}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('‚ùå Erro ao carregar etiquetas:', error);
                document.getElementById('containerEtiquetas').innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        Erro ao carregar etiquetas: ${error.message}
                    </div>
                `;
            }
        }

        function abrirModalNovaEtiqueta() {
            document.getElementById('formNovaEtiqueta').reset();
            document.getElementById('corEtiquetaInput').value = '#667eea';
            document.getElementById('corEtiquetaHex').value = '#667eea';
            
            // Sincronizar campos de cor
            document.getElementById('corEtiquetaInput').addEventListener('input', function() {
                document.getElementById('corEtiquetaHex').value = this.value;
                document.getElementById('corEtiquetaHex').setCustomValidity('');
            });
            
            document.getElementById('corEtiquetaHex').addEventListener('input', function() {
                const hexValue = this.value.trim();
                if (hexValue.match(/^#[0-9A-Fa-f]{6}$/i)) {
                    document.getElementById('corEtiquetaInput').value = hexValue;
                    this.setCustomValidity('');
                } else if (hexValue.length > 0) {
                    this.setCustomValidity('Digite um c√≥digo hexadecimal v√°lido (ex: #667eea)');
                } else {
                    this.setCustomValidity('');
                }
            });
            
            // Permitir submiss√£o com Enter no formul√°rio
            document.getElementById('formNovaEtiqueta').addEventListener('submit', function(e) {
                e.preventDefault();
                salvarNovaEtiqueta();
            });
            
            new bootstrap.Modal(document.getElementById('modalNovaEtiqueta')).show();
        }

        async function salvarNovaEtiqueta() {
            try {
                const nome = document.getElementById('nomeEtiquetaInput').value.trim();
                let cor = document.getElementById('corEtiquetaInput').value;
                const corHex = document.getElementById('corEtiquetaHex').value.trim();
                const descricao = document.getElementById('descricaoEtiquetaInput').value.trim();

                // Valida√ß√µes
                if (!nome) {
                    mostrarErro('Nome da etiqueta √© obrigat√≥rio');
                    document.getElementById('nomeEtiquetaInput').focus();
                    return;
                }

                // Validar cor hexadecimal
                if (corHex && corHex.match(/^#[0-9A-Fa-f]{6}$/i)) {
                    cor = corHex.toUpperCase();
                } else if (!corHex || !corHex.match(/^#[0-9A-Fa-f]{6}$/i)) {
                    mostrarErro('Cor inv√°lida. Use o formato hexadecimal (ex: #667eea)');
                    document.getElementById('corEtiquetaHex').focus();
                    return;
                }

                // Garantir que a cor est√° no formato correto
                if (!cor.match(/^#[0-9A-Fa-f]{6}$/i)) {
                    mostrarErro('Cor inv√°lida. Use o formato hexadecimal (ex: #667eea)');
                    return;
                }

                // Normalizar cor para mai√∫sculas
                cor = cor.toUpperCase();

                const { data, error } = await window.supabase
                    .from('etiquetas_coletas')
                    .insert([{
                        nome: nome,
                        cor: cor,
                        descricao: descricao || null,
                        ativo: true,
                        criado_por: currentUser.id
                    }])
                    .select()
                    .single();

                if (error) throw error;

                mostrarSucesso('Etiqueta criada com sucesso!');
                
                // Limpar formul√°rio
                document.getElementById('formNovaEtiqueta').reset();
                document.getElementById('corEtiquetaInput').value = '#667eea';
                document.getElementById('corEtiquetaHex').value = '#667eea';
                
                // Fechar modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('modalNovaEtiqueta'));
                if (modal) {
                    modal.hide();
                }
                
                // Recarregar lista de etiquetas
                await carregarEtiquetas();
            } catch (error) {
                console.error('‚ùå Erro ao salvar etiqueta:', error);
                
                let mensagemErro = 'Erro ao salvar etiqueta';
                if (error.message) {
                    if (error.message.includes('unique') || error.message.includes('duplicate')) {
                        mensagemErro = 'J√° existe uma etiqueta com este nome. Escolha outro nome.';
                    } else {
                        mensagemErro = 'Erro ao salvar etiqueta: ' + error.message;
                    }
                }
                
                mostrarErro(mensagemErro);
            }
        }

        async function excluirEtiqueta(id, nome) {
            if (!confirm(`Deseja realmente excluir a etiqueta "${nome}"?`)) return;

            try {
                const { error } = await window.supabase
                    .from('etiquetas_coletas')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                mostrarSucesso('Etiqueta exclu√≠da com sucesso!');
                await carregarEtiquetas();
            } catch (error) {
                console.error('‚ùå Erro ao excluir etiqueta:', error);
                mostrarErro('Erro ao excluir etiqueta: ' + error.message);
            }
        }

        function editarEtiqueta(id) {
            // Implementar edi√ß√£o se necess√°rio
            mostrarInfo('Funcionalidade de edi√ß√£o em desenvolvimento');
        }

        // Carregar etiquetas quando a aba Etiquetas for exibida
        const btnTabEtiquetas = document.querySelector('button[data-bs-target="#tabEtiquetas"]');
        if (btnTabEtiquetas) {
            btnTabEtiquetas.addEventListener('shown.bs.tab', function () {
                carregarEtiquetas();
            });
        }
    </script>
<!-- Chat IA -->
<link rel="stylesheet" href="css/chat-ia.css">
<script src="js/chat-ia.js"></script>
</body>
</html>

