<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avaliação 360º - Multimodal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #f093fb;
            --success: #11998e;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --dark: #0f0f23;
            --light: #f8f9fa;
            --white: #ffffff;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.95);
            --text-muted: rgba(255, 255, 255, 0.85);
            --border-radius: 20px;
            --box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: var(--text-primary);
            padding-top: 80px;
            overflow-x: hidden;
            position: relative;
        }

        /* Efeitos de luz de fundo */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 30%, rgba(102, 126, 234, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 70%, rgba(118, 75, 162, 0.15) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .navbar {
            background: rgba(15, 15, 35, 0.95);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.4), 0 0 20px rgba(102, 126, 234, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 1rem 0;
        }

        .navbar .btn-outline-light {
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: var(--transition);
        }

        .navbar .btn-outline-light:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3));
            border-color: rgba(255, 255, 255, 0.4);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(102, 126, 234, 0.5);
            transition: var(--transition);
        }

        .navbar-brand:hover {
            transform: scale(1.05);
        }

        .card-modern {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.06) 100%);
            backdrop-filter: blur(30px) saturate(180%);
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 24px;
            padding: 2.5rem;
            margin-bottom: 2rem;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.4),
                0 0 0 1px rgba(255, 255, 255, 0.05) inset,
                0 0 40px rgba(102, 126, 234, 0.1);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .card-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
        }

        .card-modern:hover {
            transform: translateY(-8px) scale(1.01);
            box-shadow: 
                0 16px 48px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.1) inset,
                0 0 60px rgba(102, 126, 234, 0.3);
            border-color: rgba(255, 255, 255, 0.25);
        }

        .card-modern:hover::before {
            opacity: 1;
        }

        .btn-primary-modern {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            padding: 0.875rem 2rem;
            font-weight: 600;
            font-size: 0.95rem;
            color: white;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
            box-shadow: 
                0 4px 15px rgba(102, 126, 234, 0.4),
                0 0 20px rgba(102, 126, 234, 0.2) inset;
        }

        .btn-primary-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .btn-primary-modern:hover {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 
                0 8px 25px rgba(102, 126, 234, 0.6),
                0 0 30px rgba(102, 126, 234, 0.3) inset;
        }

        .btn-primary-modern:hover::before {
            left: 100%;
        }

        .btn-primary-modern:active {
            transform: translateY(-1px) scale(1.02);
        }

        .status-badge {
            padding: 0.5rem 1.25rem;
            border-radius: 25px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: var(--transition);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .status-badge::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
            box-shadow: 0 0 10px currentColor;
        }

        .status-rascunho { 
            background: linear-gradient(135deg, rgba(108, 117, 125, 0.3), rgba(108, 117, 125, 0.2)); 
            color: #adb5bd; 
            border: 1px solid rgba(173, 181, 189, 0.3);
        }
        .status-aberto { 
            background: linear-gradient(135deg, rgba(23, 162, 184, 0.3), rgba(23, 162, 184, 0.2)); 
            color: #17a2b8; 
            border: 1px solid rgba(23, 162, 184, 0.4);
            box-shadow: 0 0 15px rgba(23, 162, 184, 0.3);
        }
        .status-fechado { 
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.3), rgba(220, 53, 69, 0.2)); 
            color: #dc3545; 
            border: 1px solid rgba(220, 53, 69, 0.4);
        }
        .status-finalizado { 
            background: linear-gradient(135deg, rgba(17, 153, 142, 0.3), rgba(17, 153, 142, 0.2)); 
            color: #11998e; 
            border: 1px solid rgba(17, 153, 142, 0.4);
            box-shadow: 0 0 15px rgba(17, 153, 142, 0.3);
        }
        
        .status-pendente {
            background: linear-gradient(135deg, rgba(255, 193, 7, 0.3), rgba(255, 193, 7, 0.2));
            color: #ffd700;
            border: 1px solid rgba(255, 193, 7, 0.4);
            text-shadow: 0 0 10px rgba(255, 193, 7, 0.5);
            font-weight: 600;
        }
        
        .status-em-andamento {
            background: linear-gradient(135deg, rgba(23, 162, 184, 0.3), rgba(23, 162, 184, 0.2));
            color: #4dd0e1;
            border: 1px solid rgba(23, 162, 184, 0.4);
            text-shadow: 0 0 10px rgba(23, 162, 184, 0.5);
            font-weight: 600;
        }
        
        .status-concluida {
            background: linear-gradient(135deg, rgba(17, 153, 142, 0.3), rgba(17, 153, 142, 0.2));
            color: #26d0ce;
            border: 1px solid rgba(17, 153, 142, 0.4);
            box-shadow: 0 0 15px rgba(17, 153, 142, 0.3);
            text-shadow: 0 0 10px rgba(17, 153, 142, 0.5);
            font-weight: 600;
        }
        
        .status-cancelada {
            background: linear-gradient(135deg, rgba(220, 53, 69, 0.3), rgba(220, 53, 69, 0.2));
            color: #ff6b6b;
            border: 1px solid rgba(220, 53, 69, 0.4);
            text-shadow: 0 0 10px rgba(220, 53, 69, 0.5);
            font-weight: 600;
        }

        .progress-ring {
            transform: rotate(-90deg);
        }

        .progress-ring-circle {
            transition: stroke-dashoffset 0.35s;
            transform: rotate(-90deg);
            transform-origin: 50% 50%;
        }

        .table-modern {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border-radius: 18px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .table-modern thead {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .table-modern thead th {
            color: var(--text-primary);
            font-weight: 600;
            padding: 1.25rem 1rem;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
            border: none;
        }

        .table-modern tbody tr {
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            transition: var(--transition);
            background: transparent;
        }

        .table-modern tbody tr:hover {
            background: linear-gradient(90deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
            transform: translateX(5px);
            box-shadow: -5px 0 15px rgba(102, 126, 234, 0.2);
        }

        .table-modern tbody td {
            padding: 1.25rem 1rem;
            color: var(--text-secondary);
            vertical-align: middle;
        }

        .modal-content {
            background: linear-gradient(135deg, rgba(15, 15, 35, 0.98) 0%, rgba(26, 26, 46, 0.98) 100%);
            backdrop-filter: blur(30px) saturate(180%);
            border: 2px solid rgba(255, 255, 255, 0.15);
            color: var(--text-primary);
            border-radius: 24px;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.5),
                0 0 0 1px rgba(255, 255, 255, 0.05) inset,
                0 0 40px rgba(102, 126, 234, 0.2);
        }
        
        /* Garantir que modais aninhados apareçam acima */
        .modal.show {
            z-index: 1050;
        }
        
        #modalVerCiclo.show {
            z-index: 1050 !important;
        }
        
        #modalVerCiclo.show .modal-dialog {
            z-index: 1051 !important;
        }
        
        #modalVerCiclo.show .modal-content {
            pointer-events: auto !important;
        }
        
        #modalCompetencias.show {
            z-index: 1060 !important;
        }
        
        #modalCompetencias.show .modal-dialog {
            z-index: 1061 !important;
        }
        
        #modalCompetencia.show {
            z-index: 1070 !important;
        }
        
        #modalCompetencia.show .modal-dialog {
            z-index: 1071 !important;
        }
        
        #modalAvaliadores.show {
            z-index: 1060 !important;
            pointer-events: none !important;
        }
        
        #modalAvaliadores.show .modal-dialog {
            z-index: 1061 !important;
            pointer-events: auto !important;
        }
        
        #modalAvaliadores.show .modal-content {
            pointer-events: auto !important;
            position: relative;
            z-index: 1062;
        }
        
        #modalAvaliadores.show .modal-content * {
            pointer-events: auto !important;
        }
        
        /* Garantir que os cards de seleção de tipo sejam clicáveis */
        #modalCiclo .card-modern {
            pointer-events: auto !important;
            cursor: pointer !important;
            position: relative;
            z-index: 1000 !important;
        }
        
        #modalCiclo .card-modern:hover {
            transform: translateY(-5px);
            border-color: var(--primary) !important;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3) !important;
        }
        
        /* NÃO bloquear pointer-events nos elementos filhos - isso estava impedindo os cliques! */
        #modalCiclo .card-modern[data-tipo] {
            pointer-events: auto !important;
        }
        
        /* Estilos para cards de seleção de tipo de avaliador */
        #etapaTipoAvaliacao .card-modern {
            pointer-events: auto !important;
            cursor: pointer !important;
            transition: all 0.3s ease;
            border: 2px solid rgba(255, 255, 255, 0.2);
        }
        
        #etapaTipoAvaliacao .card-modern:hover {
            border-color: rgba(102, 126, 234, 0.5);
            box-shadow: 0 0 15px rgba(102, 126, 234, 0.3);
            transform: translateY(-5px);
        }
        
        #modalCiclo .card-modern[data-tipo] * {
            pointer-events: none !important;
        }
        
        #modalCiclo.show {
            pointer-events: none !important;
        }
        
        #modalCiclo.show .modal-dialog {
            pointer-events: auto !important;
            position: relative;
            z-index: 1051 !important;
        }
        
        #modalCiclo.show .modal-content {
            pointer-events: auto !important;
            position: relative;
            z-index: 1052 !important;
        }
        
        #modalCiclo.show .modal-content * {
            pointer-events: auto !important;
        }
        
        /* Garantir especificamente que os cards de tipo sejam clicáveis */
        #selecaoTipoAvaliacao {
            pointer-events: auto !important;
            position: relative;
            z-index: 1000 !important;
        }
        
        #selecaoTipoAvaliacao .card-modern {
            pointer-events: auto !important;
            cursor: pointer !important;
            position: relative;
            z-index: 1001 !important;
        }
        
        #selecaoTipoAvaliacao .card-modern[data-tipo] {
            pointer-events: auto !important;
        }
        
        /* Garantir que botões e inputs sejam clicáveis */
        #modalAvaliadores button,
        #modalAvaliadores input,
        #modalAvaliadores select,
        #modalAvaliadores textarea,
        #modalAvaliadores a,
        #modalAvaliadores .btn {
            pointer-events: auto !important;
            cursor: pointer !important;
            position: relative;
            z-index: 1063;
        }
        
        /* Garantir que elementos dentro do modal sejam clicáveis */
        .modal.show .modal-content,
        .modal.show .modal-content * {
            pointer-events: auto !important;
        }
        
        /* Garantir que o modal Ver Ciclo seja totalmente interativo */
        #modalVerCiclo {
            pointer-events: auto !important;
        }
        
        #modalVerCiclo.show {
            pointer-events: auto !important;
        }
        
        #modalVerCiclo .modal-dialog {
            pointer-events: auto !important;
        }
        
        #modalVerCiclo .modal-content {
            pointer-events: auto !important;
            position: relative;
            z-index: 1052;
        }
        
        #modalVerCiclo .modal-content * {
            pointer-events: auto !important;
        }
        
        /* Garantir que botões e inputs sejam clicáveis */
        #modalVerCiclo button,
        #modalVerCiclo input,
        #modalVerCiclo select,
        #modalVerCiclo textarea,
        #modalVerCiclo a,
        #modalVerCiclo .btn {
            pointer-events: auto !important;
            cursor: pointer !important;
            position: relative;
            z-index: 1053;
        }
        
        /* Técnica para garantir que o modal seja clicável mesmo com backdrop */
        .modal.show {
            pointer-events: none !important;
        }
        
        .modal.show .modal-dialog {
            pointer-events: auto !important;
            position: relative;
            z-index: 1051;
        }
        
        .modal.show .modal-content {
            pointer-events: auto !important;
            position: relative;
            z-index: 1052;
        }
        
        /* Garantir que todos os elementos dentro sejam clicáveis */
        .modal.show .modal-content * {
            pointer-events: auto !important;
        }
        
        /* Garantir que o modal de ciclo seja totalmente interativo */
        #modalCiclo {
            pointer-events: auto !important;
        }
        
        #modalCiclo .modal-dialog {
            pointer-events: auto !important;
        }
        
        #modalCiclo .modal-content {
            pointer-events: auto !important;
        }
        
        #modalCiclo .modal-body {
            pointer-events: auto !important;
        }
        
        #modalCiclo #selecaoTipoAvaliacao {
            pointer-events: auto !important;
        }
        
        #modalCiclo #selecaoTipoAvaliacao .row {
            pointer-events: auto !important;
        }
        
        #modalCiclo #selecaoTipoAvaliacao .col-md-4 {
            pointer-events: auto !important;
        }
        
        #modalCiclo [data-tipo] {
            pointer-events: auto !important;
            cursor: pointer !important;
        }
        
        /* Backdrop deve permitir cliques no modal */
        .modal-backdrop {
            pointer-events: none !important;
            z-index: 1040 !important;
        }
        
        /* Garantir que os cards estejam acima de tudo */
        #selecaoTipoAvaliacao .card-modern {
            position: relative !important;
            z-index: 10000 !important;
            pointer-events: auto !important;
        }
        
        #selecaoTipoAvaliacao .card-modern * {
            pointer-events: none !important;
        }

        .modal-header {
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
            padding: 1.5rem 2rem;
        }

        .modal-title {
            font-weight: 700;
            font-size: 1.5rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-footer {
            border-top: 2px solid rgba(255, 255, 255, 0.1);
            padding: 1.5rem 2rem;
        }

        .form-control, .form-select {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.08) 100%);
            border: 2px solid rgba(255, 255, 255, 0.15);
            color: var(--text-primary) !important;
            border-radius: 12px;
            padding: 0.75rem 1.25rem;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }
        
        /* Garantir que as opções do select sejam visíveis */
        .form-select option {
            background: rgba(15, 15, 35, 0.98) !important;
            color: #ffffff !important;
            padding: 0.5rem;
        }
        
        .form-select option:hover {
            background: rgba(102, 126, 234, 0.3) !important;
        }
        
        .form-select option:checked {
            background: rgba(102, 126, 234, 0.5) !important;
            color: #ffffff !important;
        }

        .form-control:focus, .form-select:focus {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.18) 0%, rgba(255, 255, 255, 0.12) 100%);
            border-color: #667eea;
            color: var(--text-primary) !important;
            box-shadow: 
                0 0 0 0.25rem rgba(102, 126, 234, 0.3),
                0 0 20px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }
        
        /* Garantir visibilidade específica no modal de avaliadores */
        #modalAvaliadores .form-select {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.1) 100%) !important;
            color: #ffffff !important;
            border: 2px solid rgba(255, 255, 255, 0.2) !important;
        }
        
        #modalAvaliadores .form-select option {
            background: rgba(15, 15, 35, 1) !important;
            color: #ffffff !important;
        }
        
        #modalAvaliadores .form-label {
            color: rgba(255, 255, 255, 0.95) !important;
            font-weight: 600;
        }
        
        /* Estilos para lista de avaliadores com checkboxes */
        #listaAvaliadores {
            scrollbar-width: thin;
            scrollbar-color: rgba(102, 126, 234, 0.5) rgba(255, 255, 255, 0.1);
        }
        
        #listaAvaliadores::-webkit-scrollbar {
            width: 8px;
        }
        
        #listaAvaliadores::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }
        
        #listaAvaliadores::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.5);
            border-radius: 4px;
        }
        
        #listaAvaliadores::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.7);
        }
        
        .avaliador-item {
            padding: 0.75rem;
            border-radius: 8px;
            transition: all 0.3s ease;
            border: 1px solid transparent;
        }
        
        .avaliador-item:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
            border-color: rgba(102, 126, 234, 0.3);
            transform: translateX(5px);
        }
        
        .avaliador-item input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: #667eea;
            margin-right: 0.75rem;
            margin-top: 0.25rem;
        }
        
        .avaliador-item input[type="checkbox"]:checked {
            background-color: #667eea;
            border-color: #667eea;
        }
        
        .avaliador-item label {
            cursor: pointer;
            user-select: none;
            flex: 1;
        }
        
        .avaliador-item input[type="checkbox"]:checked + label {
            color: rgba(255, 255, 255, 1) !important;
        }
        
        .avaliador-item input[type="checkbox"]:checked ~ label strong {
            color: #667eea;
        }
        
        #buscarAvaliador::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .form-control::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .form-label {
            color: var(--text-secondary);
            font-weight: 500;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        
        /* Sobrescrever cores do Bootstrap para melhor visibilidade */
        .text-muted {
            color: var(--text-muted) !important;
        }
        
        .text-white {
            color: var(--text-primary) !important;
        }
        
        .text-dark {
            color: var(--text-primary) !important;
        }
        
        .text-light {
            color: var(--text-secondary) !important;
        }
        
        /* Melhorar visibilidade de textos em cards e modais */
        .card-modern p,
        .card-modern span,
        .card-modern small,
        .modal-body p,
        .modal-body span,
        .modal-body small {
            color: var(--text-secondary);
        }
        
        .card-modern strong,
        .card-modern b {
            color: var(--text-primary);
        }

        .rating-stars {
            display: flex;
            gap: 0.5rem;
            font-size: 2rem;
            cursor: pointer;
        }

        .rating-stars .star {
            color: rgba(255, 255, 255, 0.6);
            transition: all 0.2s ease;
        }

        .rating-stars .star:hover,
        .rating-stars .star.active {
            color: #ffc107;
            transform: scale(1.2);
        }

        .competencia-item {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.04) 100%);
            border: 2px solid rgba(255, 255, 255, 0.12);
            border-radius: 18px;
            padding: 1.75rem;
            margin-bottom: 1.25rem;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .competencia-item:hover {
            transform: translateX(5px);
            border-color: rgba(102, 126, 234, 0.4);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
        }

        .empty-state {
            text-align: center;
            padding: 5rem 2rem;
            color: rgba(255, 255, 255, 0.9);
        }

        .empty-state i {
            font-size: 5rem;
            margin-bottom: 1.5rem;
            opacity: 0.5;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stats-card {
            text-align: center;
            padding: 2rem 1.5rem;
            position: relative;
        }

        .stats-card .number {
            font-size: 3.5rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            line-height: 1;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 30px rgba(102, 126, 234, 0.3);
            animation: numberPulse 2s ease-in-out infinite;
        }

        @keyframes numberPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .stats-card .label {
            font-size: 1rem;
            color: rgba(255, 255, 255, 0.95);
            margin-top: 0.75rem;
            font-weight: 500;
            letter-spacing: 0.5px;
        }

        .stats-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, transparent, #667eea, transparent);
            border-radius: 2px;
        }

        .notification-toast {
            position: fixed;
            top: 100px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            background: rgba(15, 15, 35, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 1rem;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            animation: slideInRight 0.3s ease;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .notification-toast.success {
            border-left: 4px solid var(--success);
        }

        .notification-toast.error {
            border-left: 4px solid var(--danger);
        }

        .notification-toast.warning {
            border-left: 4px solid var(--warning);
        }

        .notification-toast.info {
            border-left: 4px solid var(--info);
        }

        .filter-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.4);
            border-radius: 15px;
            font-size: 0.85rem;
            margin: 0.25rem;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-bar-custom {
            height: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-bar-custom .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .badge-pill {
            padding: 0.35rem 0.65rem;
            border-radius: 50px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .chart-container {
            position: relative;
            margin-bottom: 1rem;
            padding: 1rem;
        }
        
        .chart-container canvas {
            max-height: 100% !important;
        }

        /* Tabs melhoradas */
        .nav-tabs {
            border-bottom: 2px solid rgba(255, 255, 255, 0.15);
            margin-bottom: 2rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.05) 0%, rgba(255, 255, 255, 0.02) 100%);
            border-radius: 15px 15px 0 0;
            padding: 0.5rem 0.5rem 0 0.5rem;
            backdrop-filter: blur(10px);
        }

        .nav-tabs .nav-link {
            color: rgba(255, 255, 255, 0.9);
            border: none;
            border-bottom: 3px solid transparent;
            padding: 1rem 1.75rem;
            transition: var(--transition);
            border-radius: 12px 12px 0 0;
            margin-right: 0.25rem;
            font-weight: 500;
            position: relative;
        }

        .nav-tabs .nav-link::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--accent));
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        .nav-tabs .nav-link:hover {
            color: #ffffff;
            background: rgba(102, 126, 234, 0.1);
        }

        .nav-tabs .nav-link:hover::before {
            width: 80%;
        }

        .nav-tabs .nav-link.active {
            color: #ffffff;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2), rgba(118, 75, 162, 0.2));
            border-bottom-color: transparent;
            font-weight: 600;
        }

        .nav-tabs .nav-link.active::before {
            width: 100%;
        }

        /* Botões secundários */
        .btn-secondary, .btn-outline-light {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1), rgba(255, 255, 255, 0.05));
            border: 2px solid rgba(255, 255, 255, 0.2);
            color: var(--text-primary);
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .btn-secondary:hover, .btn-outline-light:hover {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            border-color: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        /* Títulos */
        h2, h3, h4, h5 {
            color: var(--text-primary);
            font-weight: 700;
        }

        h2 {
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* Badges e notificações */
        .badge {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.8rem;
        }

        .badge.bg-danger {
            background: linear-gradient(135deg, #dc3545, #c0392b) !important;
            box-shadow: 0 0 15px rgba(220, 53, 69, 0.4);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        /* Scrollbar customizada */
        ::-webkit-scrollbar {
            width: 10px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--accent), var(--primary));
        }

        /* Animações de entrada */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card-modern, .stats-card {
            animation: fadeInUp 0.6s ease-out;
        }

        /* Cards de filtro melhorados */
        .card-modern .row {
            margin: 0;
        }

        .card-modern .row > * {
            padding-left: 0.75rem;
            padding-right: 0.75rem;
        }

        /* Lista de ciclos melhorada */
        #ciclosList .card-modern {
            cursor: pointer;
        }

        #ciclosList .card-modern:hover {
            transform: translateY(-8px) scale(1.02);
        }

        /* Rating stars melhorado */
        .rating-stars .star {
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .rating-stars .star.active {
            filter: drop-shadow(0 0 10px rgba(255, 193, 7, 0.6));
        }

        /* Progress bar melhorado */
        .progress-bar-custom .progress-fill {
            box-shadow: 0 0 10px rgba(102, 126, 234, 0.5);
        }

        /* Container principal */
        .container-fluid {
            position: relative;
            z-index: 1;
        }

        /* Efeito de brilho nos cards */
        .card-modern::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
        }

        .card-modern:hover::after {
            opacity: 1;
        }

        /* Responsividade melhorada */
        @media (max-width: 768px) {
            .card-modern {
                padding: 1.5rem;
            }

            .stats-card .number {
                font-size: 2.5rem;
            }

            .nav-tabs .nav-link {
                padding: 0.75rem 1rem;
                font-size: 0.9rem;
            }

            .navbar-brand {
                font-size: 1.2rem;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top">
        <div class="container-fluid px-4">
            <a class="navbar-brand d-flex align-items-center" href="portal.html">
                <i class="fas fa-arrow-left me-2" style="font-size: 1.2rem;"></i>
                <span style="background: linear-gradient(135deg, #667eea, #f093fb); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; font-weight: 700;">Avaliação 360º</span>
            </a>
            <div class="ms-auto d-flex align-items-center gap-3">
                <div class="position-relative">
                    <button class="btn btn-outline-light btn-sm position-relative" onclick="abrirModalNotificacoes()" style="border-radius: 12px; padding: 0.5rem 1rem; backdrop-filter: blur(10px);">
                        <i class="fas fa-bell me-1"></i> Notificações
                        <span class="badge bg-danger position-absolute top-0 start-100 translate-middle" id="badgeNotificacoes" style="display: none; font-size: 0.7rem; padding: 0.25rem 0.4rem; animation: pulse 2s infinite;">0</span>
                    </button>
                </div>
                <span class="text-white fw-medium" id="currentUser"></span>
                <button class="btn btn-outline-light btn-sm" onclick="window.location.href='portal.html'" style="border-radius: 12px; padding: 0.5rem 1rem; backdrop-filter: blur(10px);">
                    <i class="fas fa-home me-1"></i> Portal
                </button>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4">
        <!-- Tabs -->
        <ul class="nav nav-tabs mb-4" id="mainTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button">
                    <i class="fas fa-chart-line me-2"></i> Dashboard
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ciclos-tab" data-bs-toggle="tab" data-bs-target="#ciclos" type="button">
                    <i class="fas fa-calendar-alt me-2"></i> Ciclos de Avaliação
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="minhas-avaliacoes-tab" data-bs-toggle="tab" data-bs-target="#minhas-avaliacoes" type="button">
                    <i class="fas fa-clipboard-list me-2"></i> Minhas Avaliações
                </button>
            </li>
            <li class="nav-item" role="presentation" id="avaliar-tab-item" style="display: none;">
                <button class="nav-link" id="avaliar-tab" data-bs-toggle="tab" data-bs-target="#avaliar" type="button">
                    <i class="fas fa-edit me-2"></i> Responder Avaliação
                </button>
            </li>
            <li class="nav-item" role="presentation" id="resultados-tab-item" style="display: none;">
                <button class="nav-link" id="resultados-tab" data-bs-toggle="tab" data-bs-target="#resultados" type="button">
                    <i class="fas fa-chart-line me-2"></i> Resultados
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="comparacao-tab" data-bs-toggle="tab" data-bs-target="#comparacao" type="button">
                    <i class="fas fa-balance-scale me-2"></i> Comparação
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="relatorios-tab" data-bs-toggle="tab" data-bs-target="#relatorios" type="button">
                    <i class="fas fa-file-alt me-2"></i> Relatórios
                </button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabsContent">
            <!-- Tab: Dashboard -->
            <div class="tab-pane fade show active" id="dashboard" role="tabpanel">
                <h2 class="mb-4"><i class="fas fa-chart-line me-2"></i> Dashboard</h2>
                
                <!-- Estatísticas Gerais -->
                <div class="row mb-4">
                    <div class="col-md-3 mb-3">
                        <div class="card-modern">
                            <div class="stats-card">
                                <div class="number" id="statTotalCiclos">0</div>
                                <div class="label">Total de Ciclos</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card-modern">
                            <div class="stats-card">
                                <div class="number" id="statCiclosAtivos">0</div>
                                <div class="label">Ciclos Ativos</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card-modern">
                            <div class="stats-card">
                                <div class="number" id="statAvaliacoesPendentes">0</div>
                                <div class="label">Avaliações Pendentes</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-3">
                        <div class="card-modern">
                            <div class="stats-card">
                                <div class="number" id="statTaxaConclusao">0%</div>
                                <div class="label">Taxa de Conclusão</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Gráficos -->
                <div class="row mb-4">
                    <div class="col-md-6 mb-3">
                        <div class="card-modern">
                            <h5 class="mb-3"><i class="fas fa-chart-pie me-2"></i> Status dos Ciclos</h5>
                            <div class="chart-container" style="height: 300px; position: relative;">
                                <canvas id="chartStatusCiclos"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 mb-3">
                        <div class="card-modern">
                            <h5 class="mb-3"><i class="fas fa-chart-pie me-2"></i> Status das Avaliações</h5>
                            <div class="chart-container" style="height: 300px; position: relative;">
                                <canvas id="chartStatusAvaliacoes"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row mb-4">
                    <div class="col-md-12">
                        <div class="card-modern">
                            <h5 class="mb-3"><i class="fas fa-chart-line me-2"></i> Evolução de Conclusões</h5>
                            <div class="chart-container" style="height: 350px; position: relative;">
                                <canvas id="chartEvolucao"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Últimas Atividades -->
                <div class="card-modern">
                    <h5 class="mb-3">Últimas Atividades</h5>
                    <div id="ultimasAtividades">
                        <!-- Atividades serão carregadas aqui -->
                    </div>
                </div>
            </div>

            <!-- Tab: Ciclos de Avaliação -->
            <div class="tab-pane fade" id="ciclos" role="tabpanel">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-calendar-alt me-2"></i> Ciclos de Avaliação</h2>
                    <button class="btn btn-primary-modern" onclick="abrirModalNovoCiclo()" id="btnNovoCiclo" style="display: none;">
                        <i class="fas fa-plus me-2"></i> Novo Ciclo
                    </button>
                </div>

                <!-- Filtros -->
                <div class="card-modern mb-4">
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label class="form-label"><i class="fas fa-search me-2"></i> Buscar</label>
                            <input type="text" class="form-control" id="filtroBusca" placeholder="Buscar por nome..." onkeyup="aplicarFiltros()">
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label"><i class="fas fa-filter me-2"></i> Status</label>
                            <select class="form-select" id="filtroStatus" onchange="aplicarFiltros()">
                                <option value="">Todos</option>
                                <option value="rascunho">Rascunho</option>
                                <option value="aberto">Aberto</option>
                                <option value="fechado">Fechado</option>
                                <option value="finalizado">Finalizado</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label"><i class="fas fa-calendar me-2"></i> Período</label>
                            <select class="form-select" id="filtroPeriodo" onchange="aplicarFiltros()">
                                <option value="">Todos</option>
                                <option value="ativo">Em andamento</option>
                                <option value="futuro">Futuros</option>
                                <option value="passado">Finalizados</option>
                            </select>
                        </div>
                        <div class="col-md-2 mb-3 d-flex align-items-end">
                            <button class="btn btn-outline-light w-100" onclick="limparFiltros()">
                                <i class="fas fa-times me-2"></i> Limpar
                            </button>
                        </div>
                    </div>
                </div>

                <div id="ciclosList" class="row">
                    <!-- Ciclos serão carregados aqui -->
                </div>
            </div>

            <!-- Tab: Minhas Avaliações -->
            <div class="tab-pane fade" id="minhas-avaliacoes" role="tabpanel">
                <h2 class="mb-4"><i class="fas fa-clipboard-list me-2"></i> Minhas Avaliações</h2>
                <div id="minhasAvaliacoesList">
                    <!-- Avaliações serão carregadas aqui -->
                </div>
            </div>

            <!-- Tab: Responder Avaliação -->
            <div class="tab-pane fade" id="avaliar" role="tabpanel">
                <div id="avaliarContent">
                    <!-- Conteúdo será carregado dinamicamente -->
                </div>
            </div>

            <!-- Tab: Resultados -->
            <div class="tab-pane fade" id="resultados" role="tabpanel">
                <div id="resultadosContent">
                    <!-- Resultados serão carregados aqui -->
                </div>
            </div>

            <!-- Tab: Comparação -->
            <div class="tab-pane fade" id="comparacao" role="tabpanel">
                <h2 class="mb-4"><i class="fas fa-balance-scale me-2"></i> Comparação entre Ciclos</h2>
                
                <div class="card-modern mb-4">
                    <h5 class="mb-3">Selecionar Ciclos para Comparar</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ciclo 1</label>
                            <select class="form-select" id="cicloComparacao1">
                                <option value="">Selecione um ciclo...</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Ciclo 2</label>
                            <select class="form-select" id="cicloComparacao2">
                                <option value="">Selecione um ciclo...</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Avaliado</label>
                        <select class="form-select" id="avaliadoComparacao">
                            <option value="">Selecione um avaliado...</option>
                        </select>
                    </div>
                    <button class="btn btn-primary-modern" onclick="compararCiclos()">
                        <i class="fas fa-search me-2"></i> Comparar
                    </button>
                </div>

                <div id="comparacaoContent">
                    <!-- Resultados da comparação serão exibidos aqui -->
                </div>
            </div>

            <!-- Tab: Relatórios -->
            <div class="tab-pane fade" id="relatorios" role="tabpanel">
                <h2 class="mb-4"><i class="fas fa-file-alt me-2"></i> Relatórios</h2>
                
                <div class="row mb-4">
                    <div class="col-md-4 mb-3">
                        <div class="card-modern">
                            <h5 class="mb-3"><i class="fas fa-user me-2"></i> Relatório Individual</h5>
                            <p class="text-muted mb-3">Gere relatório detalhado de um avaliado</p>
                            <div class="mb-3">
                                <label class="form-label">Ciclo</label>
                                <select class="form-select" id="relatorioCiclo">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Avaliado</label>
                                <select class="form-select" id="relatorioAvaliado">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <button class="btn btn-primary-modern w-100" onclick="gerarRelatorioIndividual()">
                                <i class="fas fa-download me-2"></i> Gerar Relatório
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card-modern">
                            <h5 class="mb-3"><i class="fas fa-users me-2"></i> Relatório por Departamento</h5>
                            <p class="text-muted mb-3">Análise consolidada por departamento</p>
                            <div class="mb-3">
                                <label class="form-label">Ciclo</label>
                                <select class="form-select" id="relatorioDeptCiclo">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Departamento</label>
                                <select class="form-select" id="relatorioDepartamento">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <button class="btn btn-primary-modern w-100" onclick="gerarRelatorioDepartamento()">
                                <i class="fas fa-download me-2"></i> Gerar Relatório
                            </button>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card-modern">
                            <h5 class="mb-3"><i class="fas fa-chart-bar me-2"></i> Relatório Geral</h5>
                            <p class="text-muted mb-3">Visão geral de todos os ciclos</p>
                            <div class="mb-3">
                                <label class="form-label">Ciclo</label>
                                <select class="form-select" id="relatorioGeralCiclo">
                                    <option value="">Selecione...</option>
                                </select>
                            </div>
                            <button class="btn btn-primary-modern w-100" onclick="gerarRelatorioGeral()">
                                <i class="fas fa-download me-2"></i> Gerar Relatório
                            </button>
                        </div>
                    </div>
                </div>

                <div id="relatoriosContent">
                    <!-- Relatórios gerados serão exibidos aqui -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Novo/Editar Ciclo -->
    <div class="modal fade" id="modalCiclo" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalCicloTitle">Novo Ciclo de Avaliação</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formCiclo">
                        <input type="hidden" id="cicloId">
                        <input type="hidden" id="cicloTipoAvaliacao" value="">
                        
                        <!-- Seleção de Tipo de Avaliação (apenas para novos ciclos) -->
                        <div id="selecaoTipoAvaliacao" class="mb-4" style="display: block;">
                            <label class="form-label mb-3" style="color: rgba(255, 255, 255, 0.95); font-weight: 600;">
                                <i class="fas fa-question-circle me-2"></i>Tipo de Avaliação
                            </label>
                            <div class="row g-3">
                            <div class="col-md-4">
                                <div class="card-modern p-3" style="cursor: pointer !important; transition: var(--transition); pointer-events: auto !important; position: relative; z-index: 10000 !important;" id="cardTipoOrganizacao" data-tipo="organizacao" onclick="event.stopPropagation(); event.preventDefault(); console.log('🔵 CLIQUE INLINE em Organização'); if(typeof selecionarTipoAvaliacao === 'function') { selecionarTipoAvaliacao('organizacao'); } else { console.error('Função selecionarTipoAvaliacao não encontrada'); } return false;" onmousedown="event.stopPropagation(); event.preventDefault(); console.log('🔵 MOUSEDOWN INLINE em Organização'); if(typeof selecionarTipoAvaliacao === 'function') { selecionarTipoAvaliacao('organizacao'); } return false;">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3" style="font-size: 2rem; color: var(--primary); pointer-events: none;">
                                            <i class="fas fa-building"></i>
                                        </div>
                                        <div class="flex-grow-1" style="pointer-events: none;">
                                            <strong style="color: rgba(255, 255, 255, 0.95);">Avaliar Organização</strong>
                                            <p class="mb-0 text-muted" style="font-size: 0.85rem;">Todos os funcionários avaliam a empresa</p>
                                        </div>
                                        <i class="fas fa-check-circle" style="display: none; color: var(--success); font-size: 1.5rem; pointer-events: none;" id="checkOrganizacao"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card-modern p-3" style="cursor: pointer !important; transition: var(--transition); pointer-events: auto !important; position: relative; z-index: 10000 !important;" id="cardTipoLideranca" data-tipo="lideranca" onclick="event.stopPropagation(); event.preventDefault(); console.log('🔵 CLIQUE INLINE em Liderança'); if(typeof selecionarTipoAvaliacao === 'function') { selecionarTipoAvaliacao('lideranca'); } else { console.error('Função selecionarTipoAvaliacao não encontrada'); } return false;" onmousedown="event.stopPropagation(); event.preventDefault(); console.log('🔵 MOUSEDOWN INLINE em Liderança'); if(typeof selecionarTipoAvaliacao === 'function') { selecionarTipoAvaliacao('lideranca'); } return false;">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3" style="font-size: 2rem; color: var(--primary); pointer-events: none;">
                                            <i class="fas fa-user-tie"></i>
                                        </div>
                                        <div class="flex-grow-1" style="pointer-events: none;">
                                            <strong style="color: rgba(255, 255, 255, 0.95);">Avaliar Liderança</strong>
                                            <p class="mb-0 text-muted" style="font-size: 0.85rem;">Colaboradores avaliam coordenação, gerência e diretoria</p>
                                        </div>
                                        <i class="fas fa-check-circle" style="display: none; color: var(--success); font-size: 1.5rem; pointer-events: none;" id="checkLideranca"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card-modern p-3" style="cursor: pointer !important; transition: var(--transition); pointer-events: auto !important; position: relative; z-index: 10000 !important;" id="cardTipoColaborador" data-tipo="colaborador" onclick="event.stopPropagation(); event.preventDefault(); console.log('🔵 CLIQUE INLINE em Colaborador'); if(typeof selecionarTipoAvaliacao === 'function') { selecionarTipoAvaliacao('colaborador'); } else { console.error('Função selecionarTipoAvaliacao não encontrada'); } return false;" onmousedown="event.stopPropagation(); event.preventDefault(); console.log('🔵 MOUSEDOWN INLINE em Colaborador'); if(typeof selecionarTipoAvaliacao === 'function') { selecionarTipoAvaliacao('colaborador'); } return false;">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3" style="font-size: 2rem; color: var(--primary); pointer-events: none;">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div class="flex-grow-1" style="pointer-events: none;">
                                            <strong style="color: rgba(255, 255, 255, 0.95);">Avaliar Colaborador</strong>
                                            <p class="mb-0 text-muted" style="font-size: 0.85rem;">Avaliar competências individuais de cada colaborador</p>
                                        </div>
                                        <i class="fas fa-check-circle" style="display: none; color: var(--success); font-size: 1.5rem; pointer-events: none;" id="checkColaborador"></i>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card-modern p-3" style="cursor: pointer !important; transition: var(--transition); pointer-events: auto !important; position: relative; z-index: 10000 !important;" id="cardTipoEquipe" data-tipo="equipe" onclick="event.stopPropagation(); event.preventDefault(); console.log('🔵 CLIQUE INLINE em Equipe'); if(typeof selecionarTipoAvaliacao === 'function') { selecionarTipoAvaliacao('equipe'); } else { console.error('Função selecionarTipoAvaliacao não encontrada'); } return false;" onmousedown="event.stopPropagation(); event.preventDefault(); console.log('🔵 MOUSEDOWN INLINE em Equipe'); if(typeof selecionarTipoAvaliacao === 'function') { selecionarTipoAvaliacao('equipe'); } return false;">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3" style="font-size: 2rem; color: var(--primary); pointer-events: none;">
                                            <i class="fas fa-users"></i>
                                        </div>
                                        <div class="flex-grow-1" style="pointer-events: none;">
                                            <strong style="color: rgba(255, 255, 255, 0.95);">Avaliar Equipe</strong>
                                            <p class="mb-0 text-muted" style="font-size: 0.85rem;">Líder avalia seu time como um todo</p>
                                        </div>
                                        <i class="fas fa-check-circle" style="display: none; color: var(--success); font-size: 1.5rem; pointer-events: none;" id="checkEquipe"></i>
                                    </div>
                                </div>
                            </div>
                            </div>
                        </div>
                        
                        <div id="formularioCiclo" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Nome do Ciclo</label>
                            <input type="text" class="form-control" id="cicloNome" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descrição</label>
                            <textarea class="form-control" id="cicloDescricao" rows="3"></textarea>
                        </div>
                        
                        <!-- Campo para cargo/hierarquia (apenas para avaliação de liderança) -->
                        <div id="campoCargoAvaliado" class="mb-3" style="display: none;">
                            <label class="form-label">
                                <i class="fas fa-briefcase me-2"></i>Cargo/Hierarquia Sendo Avaliado
                            </label>
                            <select class="form-select" id="cicloCargoAvaliado" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.1) 100%); color: #ffffff; border: 2px solid rgba(255, 255, 255, 0.2);">
                                <option value="">Selecione o cargo...</option>
                                <option value="coordenacao" style="background: rgba(15, 15, 35, 1); color: #ffffff;">Coordenação</option>
                                <option value="gerencia" style="background: rgba(15, 15, 35, 1); color: #ffffff;">Gerência</option>
                                <option value="direcao" style="background: rgba(15, 15, 35, 1); color: #ffffff;">Direção</option>
                            </select>
                            <small class="form-text text-muted" style="color: rgba(255, 255, 255, 0.7);">
                                Selecione qual nível hierárquico será avaliado nesta avaliação de liderança
                            </small>
                        </div>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Data Início</label>
                                <input type="date" class="form-control" id="cicloDataInicio" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Data Fim</label>
                                <input type="date" class="form-control" id="cicloDataFim" required>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">Data Limite Respostas</label>
                                <input type="date" class="form-control" id="cicloDataLimite" required>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Status</label>
                            <select class="form-select" id="cicloStatus">
                                <option value="rascunho">Rascunho</option>
                                <option value="aberto">Aberto</option>
                                <option value="fechado">Fechado</option>
                                <option value="finalizado">Finalizado</option>
                            </select>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="cicloAnonimo" checked>
                                    <label class="form-check-label" for="cicloAnonimo">Avaliações Anônimas</label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="cicloAutoAvaliacao" checked>
                                    <label class="form-check-label" for="cicloAutoAvaliacao">Permitir Auto-avaliação</label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="cicloAvaliacaoGestor" checked>
                                    <label class="form-check-label" for="cicloAvaliacaoGestor">Permitir Avaliação do Gestor</label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="cicloAvaliacaoPares" checked>
                                    <label class="form-check-label" for="cicloAvaliacaoPares">Permitir Avaliação de Pares</label>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="cicloAvaliacaoSubordinados" checked>
                                    <label class="form-check-label" for="cicloAvaliacaoSubordinados">Permitir Avaliação de Subordinados</label>
                                </div>
                            </div>
                        </div>
                        </div> <!-- Fechar div formularioCiclo -->
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary-modern" id="btnSalvarCiclo" onclick="salvarCiclo()" style="display: none;">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Gerenciar Competências -->
    <div class="modal fade" id="modalCompetencias" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Gerenciar Competências</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-4">
                        <h6 class="mb-3" style="color: rgba(255, 255, 255, 0.95); font-weight: 600;">
                            <i class="fas fa-layer-group me-2"></i>Templates de Competências
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="card-modern p-3" style="cursor: pointer; transition: var(--transition);" onclick="aplicarTemplateCompetencias('organizacao')" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3" style="font-size: 2rem; color: var(--primary);">
                                            <i class="fas fa-building"></i>
                                        </div>
                                        <div>
                                            <strong style="color: rgba(255, 255, 255, 0.95);">Avaliar Organização</strong>
                                            <p class="mb-0 text-muted" style="font-size: 0.85rem;">Avaliar a empresa como um todo</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card-modern p-3" style="cursor: pointer; transition: var(--transition);" onclick="aplicarTemplateCompetencias('lideranca')" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3" style="font-size: 2rem; color: var(--primary);">
                                            <i class="fas fa-user-tie"></i>
                                        </div>
                                        <div>
                                            <strong style="color: rgba(255, 255, 255, 0.95);">Avaliar Liderança</strong>
                                            <p class="mb-0 text-muted" style="font-size: 0.85rem;">Avaliar gestores (coordenação, gerência, diretoria)</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card-modern p-3" style="cursor: pointer; transition: var(--transition);" onclick="aplicarTemplateCompetencias('colaborador')" onmouseover="this.style.transform='translateY(-5px)'" onmouseout="this.style.transform='translateY(0)'">
                                    <div class="d-flex align-items-center">
                                        <div class="me-3" style="font-size: 2rem; color: var(--primary);">
                                            <i class="fas fa-user"></i>
                                        </div>
                                        <div>
                                            <strong style="color: rgba(255, 255, 255, 0.95);">Avaliar Colaborador</strong>
                                            <p class="mb-0 text-muted" style="font-size: 0.85rem;">Avaliar competências individuais de colaboradores</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4" style="border-color: rgba(255, 255, 255, 0.1);">
                    
                    <div class="mb-3">
                        <button class="btn btn-primary-modern" onclick="adicionarCompetencia()">
                            <i class="fas fa-plus me-2"></i> Adicionar Competência Personalizada
                        </button>
                    </div>
                    <div id="competenciasList">
                        <!-- Competências serão carregadas aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Adicionar/Editar Competência -->
    <div class="modal fade" id="modalCompetencia" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Nova Competência</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formCompetencia">
                        <input type="hidden" id="competenciaId">
                        <div class="mb-3">
                            <label class="form-label">Categoria</label>
                            <input type="text" class="form-control" id="competenciaCategoria" placeholder="Ex: Liderança, Comunicação" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Competência</label>
                            <input type="text" class="form-control" id="competenciaNome" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Descrição</label>
                            <textarea class="form-control" id="competenciaDescricao" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Tipo de Avaliação</label>
                            <select class="form-select" id="competenciaTipo" onchange="toggleCompetenciaTipo()">
                                <option value="numerica">Numérica (1-5)</option>
                                <option value="texto">Texto Livre</option>
                                <option value="escala_likert">Escala Likert</option>
                            </select>
                        </div>
                        <div class="row" id="escalaConfig" style="display: none;">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Escala Mínima</label>
                                <input type="number" class="form-control" id="competenciaEscalaMin" value="1" min="1">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Escala Máxima</label>
                                <input type="number" class="form-control" id="competenciaEscalaMax" value="5" min="2">
                            </div>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Peso (para cálculo da média)</label>
                            <input type="number" class="form-control" id="competenciaPeso" value="1.00" step="0.01" min="0.01">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ordem</label>
                            <input type="number" class="form-control" id="competenciaOrdem" value="0">
                        </div>
                        <div class="form-check form-switch mb-3">
                            <input class="form-check-input" type="checkbox" id="competenciaObrigatoria" checked>
                            <label class="form-check-label" for="competenciaObrigatoria">Obrigatória</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary-modern" onclick="salvarCompetencia()">Salvar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Selecionar Avaliadores -->
    <div class="modal fade" id="modalAvaliadores" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Selecionar Avaliadores</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Etapa 1: Seleção do tipo de avaliação (apenas para avaliação Individual) -->
                    <div id="etapaTipoAvaliacao" style="display: none;">
                        <h6 class="mb-4" style="color: rgba(255, 255, 255, 0.95); font-weight: 600;">
                            <i class="fas fa-question-circle me-2"></i>Escolha o tipo de avaliação
                        </h6>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <div class="card-modern" style="cursor: pointer; transition: all 0.3s ease;" onclick="selecionarTipoAvaliador('auto')" data-tipo="auto">
                                    <div class="text-center p-4">
                                        <i class="fas fa-user fa-3x mb-3" style="color: #667eea;"></i>
                                        <h6 style="color: rgba(255, 255, 255, 0.95); font-weight: 600;">Auto-avaliação</h6>
                                        <p class="text-muted mb-0" style="font-size: 0.9rem;">O próprio colaborador se avalia</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card-modern" style="cursor: pointer; transition: all 0.3s ease;" onclick="selecionarTipoAvaliador('par')" data-tipo="par">
                                    <div class="text-center p-4">
                                        <i class="fas fa-users fa-3x mb-3" style="color: #667eea;"></i>
                                        <h6 style="color: rgba(255, 255, 255, 0.95); font-weight: 600;">Par (Colega)</h6>
                                        <p class="text-muted mb-0" style="font-size: 0.9rem;">Colegas do mesmo departamento</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card-modern" style="cursor: pointer; transition: all 0.3s ease;" onclick="selecionarTipoAvaliador('gestor')" data-tipo="gestor">
                                    <div class="text-center p-4">
                                        <i class="fas fa-user-tie fa-3x mb-3" style="color: #667eea;"></i>
                                        <h6 style="color: rgba(255, 255, 255, 0.95); font-weight: 600;">Gestor</h6>
                                        <p class="text-muted mb-0" style="font-size: 0.9rem;">Supervisor ou gerente direto</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card-modern" style="cursor: pointer; transition: all 0.3s ease;" onclick="selecionarTipoAvaliador('subordinado')" data-tipo="subordinado">
                                    <div class="text-center p-4">
                                        <i class="fas fa-user-friends fa-3x mb-3" style="color: #667eea;"></i>
                                        <h6 style="color: rgba(255, 255, 255, 0.95); font-weight: 600;">Subordinado</h6>
                                        <p class="text-muted mb-0" style="font-size: 0.9rem;">Colaboradores subordinados</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Etapa 2: Seleção de avaliado e avaliadores -->
                    <div id="etapaSelecaoAvaliadores" style="display: none;">
                        <div class="mb-3">
                            <label class="form-label">Selecionar Avaliado</label>
                            <select class="form-select" id="avaliadoSelect">
                                <option value="">Selecione um avaliado...</option>
                            </select>
                        </div>
                        <div id="avaliadoresContent">
                            <!-- Conteúdo será carregado dinamicamente -->
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                    <button type="button" class="btn btn-primary-modern" onclick="salvarAvaliadores()">Salvar Avaliadores</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Notificações -->
    <div class="modal fade" id="modalNotificacoes" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-bell me-2"></i> Notificações
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <span class="text-muted">Total: <strong id="totalNotificacoes">0</strong></span>
                        <button class="btn btn-sm btn-outline-primary" onclick="marcarTodasComoLidas()">
                            <i class="fas fa-check-double me-1"></i> Marcar todas como lidas
                        </button>
                    </div>
                    <div id="notificacoesList" style="max-height: 500px; overflow-y: auto;">
                        <!-- Notificações serão carregadas aqui -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ========== CONFIGURAÇÃO SUPABASE ==========
        // NOTA DE SEGURANÇA: A chave abaixo é a ANON_KEY (chave pública/anônima) do Supabase.
        // Esta chave é SEGURA para estar no frontend, pois:
        // 1. É limitada pelas políticas RLS (Row Level Security) do banco
        // 2. Não permite acesso a dados sem autenticação adequada
        // 3. É a chave pública designada para uso no cliente
        // NUNCA exponha a SERVICE_ROLE_KEY ou outras chaves sensíveis aqui!
        const SUPABASE_URL = 'https://ssicipijonlducmcjgty.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNzaWNpcGlqb25sZHVjbWNqZ3R5Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjQ2MjA0NDUsImV4cCI6MjA0MDE5NjQ0NX0.KOa5ZTwKCiDIDIvsnC_pb_4oHlNGCgByzHi0_xBT-Gc';
        
        let supabaseClient;
        let currentUserId;
        let currentUserProfile;
        let cicloAtualId;
        let avaliacaoAtualId;
        let avaliadorAtualId;

        // ========== NOTIFICAÇÕES ==========
        async function loadNotificacoes() {
            if (!currentUserId) {
                console.error('❌ currentUserId não definido');
                return [];
            }
            
            console.log('🔔 Carregando notificações para usuário:', currentUserId);
            
            const { data: notificacoes, error } = await supabaseClient
                .from('avaliacao_360_notificacoes')
                .select('*')
                .eq('usuario_id', currentUserId)
                .order('created_at', { ascending: false })
                .limit(50);
            
            if (error) {
                console.error('❌ Erro ao carregar notificações:', error);
                return [];
            }
            
            console.log('🔔 Notificações encontradas:', notificacoes?.length || 0);
            console.log('🔔 Notificações não lidas:', notificacoes?.filter(n => !n.lida).length || 0);
            
            const naoLidas = notificacoes?.filter(n => !n.lida).length || 0;
            const badge = document.getElementById('badgeNotificacoes');
            if (badge) {
                if (naoLidas > 0) {
                    badge.textContent = naoLidas > 99 ? '99+' : naoLidas;
                    badge.style.display = 'block';
                } else {
                    badge.style.display = 'none';
                }
            }
            
            return notificacoes || [];
        }

        async function abrirModalNotificacoes() {
            const notificacoes = await loadNotificacoes();
            const container = document.getElementById('notificacoesList');
            const totalEl = document.getElementById('totalNotificacoes');
            
            if (totalEl) {
                totalEl.textContent = notificacoes.length;
            }
            
            if (!notificacoes || notificacoes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-bell-slash"></i>
                        <h5>Nenhuma notificação</h5>
                        <p class="text-muted">Você está em dia!</p>
                    </div>
                `;
            } else {
                container.innerHTML = notificacoes.map(n => `
                    <div class="d-flex align-items-start p-3 border rounded mb-2 ${n.lida ? 'opacity-50' : ''}" style="cursor: pointer;" onclick="marcarComoLida('${n.id}', '${n.avaliador_id || ''}')">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-1">
                                <i class="fas fa-${n.tipo === 'nova_avaliacao' ? 'user-check' : n.tipo === 'ciclo_aberto' ? 'calendar-check' : 'info-circle'} me-2 text-primary"></i>
                                <strong>${n.titulo}</strong>
                                ${!n.lida ? '<span class="badge bg-danger ms-2">Nova</span>' : ''}
                            </div>
                            <p class="text-muted mb-1">${n.mensagem}</p>
                            <small class="text-muted">${formatDateTime(n.created_at)}</small>
                        </div>
                        ${n.avaliador_id ? `
                            <button class="btn btn-sm btn-primary-modern ms-2" onclick="event.stopPropagation(); responderAvaliacao('${n.avaliacao_id || ''}', '${n.avaliador_id}')">
                                Responder
                            </button>
                        ` : ''}
                    </div>
                `).join('');
            }
            
            const modalNotificacoes = document.getElementById('modalNotificacoes');
            const modal = new bootstrap.Modal(modalNotificacoes);
            
            // Corrigir aria-hidden quando o modal for mostrado
            modalNotificacoes.addEventListener('shown.bs.modal', function() {
                // Remover aria-hidden para corrigir aviso de acessibilidade
                modalNotificacoes.removeAttribute('aria-hidden');
                modalNotificacoes.setAttribute('aria-modal', 'true');
            }, { once: false });
            
            // Restaurar aria-hidden quando o modal for escondido
            modalNotificacoes.addEventListener('hidden.bs.modal', function() {
                modalNotificacoes.setAttribute('aria-hidden', 'true');
                modalNotificacoes.removeAttribute('aria-modal');
            }, { once: false });
            
            modal.show();
        }

        async function marcarComoLida(notificacaoId, avaliadorId) {
            const { error } = await supabaseClient
                .from('avaliacao_360_notificacoes')
                .update({ 
                    lida: true,
                    lida_em: new Date().toISOString()
                })
                .eq('id', notificacaoId);
            
            if (!error) {
                await loadNotificacoes();
                if (avaliadorId) {
                    // Buscar avaliação_id
                    const { data: avaliador } = await supabaseClient
                        .from('avaliacao_360_avaliadores')
                        .select('avaliacao_id')
                        .eq('id', avaliadorId)
                        .single();
                    
                    if (avaliador) {
                        bootstrap.Modal.getInstance(document.getElementById('modalNotificacoes')).hide();
                        responderAvaliacao(avaliador.avaliacao_id, avaliadorId);
                    }
                }
            }
        }

        async function marcarTodasComoLidas() {
            const { error } = await supabaseClient
                .from('avaliacao_360_notificacoes')
                .update({ 
                    lida: true,
                    lida_em: new Date().toISOString()
                })
                .eq('usuario_id', currentUserId)
                .eq('lida', false);
            
            if (!error) {
                await loadNotificacoes();
                await abrirModalNotificacoes();
                showNotification('Todas as notificações foram marcadas como lidas', 'success');
            }
        }

        // ========== INICIALIZAÇÃO ==========
        async function init() {
            try {
                // Verificar se window.supabase está disponível
                if (!window.supabase) {
                    console.error('❌ window.supabase não está disponível. Aguardando carregamento...');
                    // Aguardar um pouco e tentar novamente
                    await new Promise(resolve => setTimeout(resolve, 500));
                    if (!window.supabase) {
                        console.error('❌ window.supabase ainda não está disponível após aguardar');
                        showNotification('Erro ao carregar Supabase. Recarregue a página.', 'error');
                        return;
                    }
                }
                
                console.log('✅ Inicializando cliente Supabase...');
                
                // Tentar buscar configuração da API primeiro, se falhar usar valores hardcoded
                let supabaseUrl = SUPABASE_URL;
                let supabaseAnonKey = SUPABASE_ANON_KEY;
                
                try {
                    const configResponse = await fetch('/api/supabase-config');
                    if (configResponse.ok) {
                        const config = await configResponse.json();
                        if (config.supabaseUrl && config.supabaseAnonKey) {
                            supabaseUrl = config.supabaseUrl;
                            supabaseAnonKey = config.supabaseAnonKey;
                            console.log('✅ Configuração do Supabase obtida da API');
                        }
                    }
                } catch (apiError) {
                    console.warn('⚠️ Não foi possível obter configuração da API, usando valores padrão:', apiError);
                }
                
                supabaseClient = window.supabase.createClient(supabaseUrl, supabaseAnonKey);
                
                // Verificar se o cliente foi criado corretamente
                if (!supabaseClient) {
                    console.error('❌ Erro ao criar cliente Supabase');
                    showNotification('Erro ao inicializar conexão com o banco de dados.', 'error');
                    return;
                }
                
                console.log('✅ Cliente Supabase criado com sucesso');
                
                const { data: { session }, error: sessionError } = await supabaseClient.auth.getSession();
                
                if (sessionError) {
                    console.error('❌ Erro ao obter sessão:', sessionError);
                    showNotification('Erro de autenticação. Faça login novamente.', 'error');
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    return;
                }
                
                if (!session) {
                    console.warn('⚠️ Nenhuma sessão encontrada. Redirecionando para login...');
                    window.location.href = 'login.html';
                    return;
                }
                
                console.log('✅ Sessão encontrada:', session.user.id);
                currentUserId = session.user.id;
                console.log('✅ currentUserId definido:', currentUserId);
                await loadUserProfile();
            
            // Aguardar um pouco para garantir que o perfil foi carregado
            await new Promise(resolve => setTimeout(resolve, 100));
            
            // Carregar notificações imediatamente após definir currentUserId
            console.log('🔔 Carregando notificações após login...');
            await loadNotificacoes();
            
            await loadCiclos();
            await loadMinhasAvaliacoes();
            await loadDashboard();
            await loadCiclosParaComparacao();
            await loadDadosRelatorios();
            // loadNotificacoes já foi chamado acima, removendo duplicação
            
            // Verificar permissões - RH ou Admin podem criar ciclos
            atualizarVisibilidadeBotaoNovoCiclo();
            
            // Atualizar notificações a cada 30 segundos
            setInterval(async () => {
                await loadNotificacoes();
            }, 30000);
            } catch (error) {
                console.error('❌ Erro na inicialização:', error);
                showNotification('Erro ao inicializar sistema. Recarregue a página.', 'error');
            }
        }

        async function loadUserProfile() {
            try {
                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .select('*')
                    .eq('id', currentUserId)
                    .single();
                
                if (error) {
                    console.error('❌ Erro ao carregar perfil do usuário:', error);
                    return;
                }
                
                if (data) {
                    currentUserProfile = data;
                    document.getElementById('currentUser').textContent = data.nome || data.email;
                    console.log('✅ Perfil do usuário carregado:', {
                        id: data.id,
                        nome: data.nome,
                        email: data.email,
                        role: data.role,
                        departamento: data.departamento
                    });
                    
                    // Atualizar visibilidade do botão após carregar o perfil
                    atualizarVisibilidadeBotaoNovoCiclo();
                } else {
                    console.warn('⚠️ Perfil do usuário não encontrado');
                }
            } catch (error) {
                console.error('❌ Erro inesperado ao carregar perfil:', error);
            }
        }

        // Função auxiliar para verificar se o usuário pode gerenciar ciclos
        function podeGerenciarCiclos() {
            const roleLower = currentUserProfile?.role?.toLowerCase() || '';
            const isRH = currentUserProfile?.departamento === 'RH' || currentUserProfile?.departamento === 'rh';
            const isAdmin = roleLower === 'admin';
            return isRH || isAdmin;
        }

        function atualizarVisibilidadeBotaoNovoCiclo() {
            // Verificar permissões - RH ou Admin podem criar ciclos
            const podeCriarCiclo = podeGerenciarCiclos();
            
            console.log('🔐 Verificação de permissões:', {
                perfil: currentUserProfile,
                podeCriarCiclo: podeCriarCiclo,
                role: currentUserProfile?.role,
                roleLower: currentUserProfile?.role?.toLowerCase(),
                departamento: currentUserProfile?.departamento
            });
            
            const btnNovoCiclo = document.getElementById('btnNovoCiclo');
            if (btnNovoCiclo) {
                if (podeCriarCiclo) {
                    btnNovoCiclo.style.display = 'block';
                    btnNovoCiclo.style.visibility = 'visible';
                    console.log('✅ Botão "Novo Ciclo" está VISÍVEL');
                } else {
                    btnNovoCiclo.style.display = 'none';
                    console.log('❌ Botão "Novo Ciclo" está OCULTO');
                }
            } else {
                console.error('❌ Botão "Novo Ciclo" não encontrado no DOM');
            }
        }

        // ========== CICLOS DE AVALIAÇÃO ==========
        let todosCiclos = [];
        
        // Função auxiliar para buscar dados de avaliados
        async function buscarDadosAvaliados(avaliadoIds) {
            if (!avaliadoIds || avaliadoIds.length === 0) return new Map();
            
            const { data: avaliadosData } = await supabaseClient
                .from('user_profiles')
                .select('id, nome, email, departamento, cargo')
                .in('id', avaliadoIds);
            
            if (!avaliadosData) return new Map();
            
            return new Map(avaliadosData.map(a => [a.id, a]));
        }
        
        // Função auxiliar para enriquecer avaliações com dados dos avaliados
        async function enriquecerAvaliacoesComAvaliados(avaliacoes) {
            if (!avaliacoes || avaliacoes.length === 0) return avaliacoes;
            
            const avaliadoIds = [...new Set(avaliacoes.map(a => a.avaliado_id).filter(Boolean))];
            const avaliadosMap = await buscarDadosAvaliados(avaliadoIds);
            
            return avaliacoes.map(avaliacao => ({
                ...avaliacao,
                avaliado: avaliadosMap.get(avaliacao.avaliado_id) || {
                    nome: 'Usuário não encontrado',
                    email: '',
                    departamento: null,
                    cargo: null
                }
            }));
        }

        async function loadCiclos() {
            try {
                console.log('🔄 Carregando ciclos do banco de dados...');
                const { data, error } = await supabaseClient
                    .from('avaliacao_360_ciclos')
                    .select('*')
                    .order('criado_em', { ascending: false });
                
                if (error) {
                    console.error('❌ Erro ao carregar ciclos:', error);
                    showNotification('Erro ao carregar ciclos: ' + error.message, 'error');
                    return;
                }
                
                console.log(`✅ ${data?.length || 0} ciclo(s) carregado(s) do banco`);
                todosCiclos = data || [];
                aplicarFiltros();
            } catch (error) {
                console.error('❌ Erro inesperado ao carregar ciclos:', error);
            }
        }

        function aplicarFiltros() {
            const busca = document.getElementById('filtroBusca')?.value.toLowerCase() || '';
            const status = document.getElementById('filtroStatus')?.value || '';
            const periodo = document.getElementById('filtroPeriodo')?.value || '';
            
            let ciclosFiltrados = [...todosCiclos];
            
            // Filtro de busca
            if (busca) {
                ciclosFiltrados = ciclosFiltrados.filter(c => 
                    c.nome.toLowerCase().includes(busca) ||
                    (c.descricao && c.descricao.toLowerCase().includes(busca))
                );
            }
            
            // Filtro de status
            if (status) {
                ciclosFiltrados = ciclosFiltrados.filter(c => c.status === status);
            }
            
            // Filtro de período
            if (periodo) {
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                
                ciclosFiltrados = ciclosFiltrados.filter(c => {
                    const dataInicio = new Date(c.data_inicio);
                    const dataFim = new Date(c.data_fim);
                    dataInicio.setHours(0, 0, 0, 0);
                    dataFim.setHours(0, 0, 0, 0);
                    
                    if (periodo === 'ativo') {
                        return dataInicio <= hoje && dataFim >= hoje;
                    } else if (periodo === 'futuro') {
                        return dataInicio > hoje;
                    } else if (periodo === 'passado') {
                        return dataFim < hoje;
                    }
                    return true;
                });
            }
            
            renderizarCiclos(ciclosFiltrados);
        }

        function limparFiltros() {
            document.getElementById('filtroBusca').value = '';
            document.getElementById('filtroStatus').value = '';
            document.getElementById('filtroPeriodo').value = '';
            aplicarFiltros();
        }

        function renderizarCiclos(ciclos) {
            const container = document.getElementById('ciclosList');
            if (!ciclos || ciclos.length === 0) {
                container.innerHTML = `
                    <div class="col-12">
                        <div class="empty-state">
                            <i class="fas fa-calendar-times"></i>
                            <h4>Nenhum ciclo encontrado</h4>
                            <p>Tente ajustar os filtros ou crie um novo ciclo</p>
                        </div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = ciclos.map(ciclo => {
                // Determinar tipo de avaliação e informações adicionais
                let tipoInfo = '';
                if (ciclo.tipo_avaliacao === 'lideranca' && ciclo.cargo_avaliado) {
                    const cargoLabel = ciclo.cargo_avaliado === 'coordenacao' ? 'Coordenação' : 
                                      ciclo.cargo_avaliado === 'gerencia' ? 'Gerência' : 
                                      ciclo.cargo_avaliado === 'direcao' ? 'Direção' : ciclo.cargo_avaliado;
                    tipoInfo = `<div class="mb-2">
                        <span class="badge bg-info" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3)) !important; border: 1px solid rgba(102, 126, 234, 0.5);">
                            <i class="fas fa-briefcase me-1"></i>Cargo: ${cargoLabel}
                        </span>
                    </div>`;
                } else if (ciclo.tipo_avaliacao === 'equipe') {
                    tipoInfo = `<div class="mb-2">
                        <span class="badge bg-info" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3)) !important; border: 1px solid rgba(102, 126, 234, 0.5);">
                            <i class="fas fa-users me-1"></i>Avaliação de Equipe
                        </span>
                    </div>`;
                } else if (ciclo.tipo_avaliacao === 'colaborador') {
                    tipoInfo = `<div class="mb-2">
                        <span class="badge bg-info" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3)) !important; border: 1px solid rgba(102, 126, 234, 0.5);">
                            <i class="fas fa-user me-1"></i>Avaliação Individual
                        </span>
                    </div>`;
                } else if (ciclo.tipo_avaliacao === 'organizacao') {
                    tipoInfo = `<div class="mb-2">
                        <span class="badge bg-info" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.3), rgba(118, 75, 162, 0.3)) !important; border: 1px solid rgba(102, 126, 234, 0.5);">
                            <i class="fas fa-building me-1"></i>Avaliação Organizacional
                        </span>
                    </div>`;
                }
                
                // Escapar valores para evitar problemas de sintaxe
                const cicloNome = String(ciclo.nome || '').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                const cicloStatus = String(ciclo.status || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                const cicloDescricao = ciclo.descricao ? String(ciclo.descricao || '').replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';
                const cicloId = String(ciclo.id || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
                let dataInicio = '';
                let dataFim = '';
                let dataLimite = '';
                
                try {
                    if (typeof formatDate === 'function') {
                        dataInicio = formatDate(ciclo.data_inicio) || '';
                        dataFim = formatDate(ciclo.data_fim) || '';
                        dataLimite = formatDate(ciclo.data_limite_respostas) || '';
                    } else {
                        dataInicio = String(ciclo.data_inicio || '');
                        dataFim = String(ciclo.data_fim || '');
                        dataLimite = String(ciclo.data_limite_respostas || '');
                    }
                } catch (e) {
                    console.error('Erro ao formatar datas:', e);
                    dataInicio = String(ciclo.data_inicio || '');
                    dataFim = String(ciclo.data_fim || '');
                    dataLimite = String(ciclo.data_limite_respostas || '');
                }
                
                return `
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card-modern">
                        <div class="d-flex justify-content-between align-items-start mb-3">
                            <h5>${cicloNome}</h5>
                            <span class="status-badge status-${cicloStatus}">${cicloStatus}</span>
                        </div>
                        ${tipoInfo}
                        ${cicloDescricao ? `<p class="text-muted mb-3">${cicloDescricao}</p>` : ''}
                        <div class="mb-3">
                            <small class="text-muted d-block">Período: ${dataInicio} - ${dataFim}</small>
                            <small class="text-muted d-block">Limite: ${dataLimite}</small>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-primary-modern flex-fill" onclick="verCiclo('${cicloId}')">
                                <i class="fas fa-cog me-1"></i> Gerenciar Ciclo
                            </button>
                            ${(currentUserProfile?.departamento === 'RH' || currentUserProfile?.role === 'admin') ? `
                                <button class="btn btn-sm btn-outline-primary" onclick="editarCiclo('${cicloId}')">
                                    <i class="fas fa-edit me-1"></i> Editar
                                </button>
                                <button class="btn btn-sm btn-outline-danger btn-excluir-ciclo" data-ciclo-id="${cicloId}" data-ciclo-nome="${cicloNome}">
                                    <i class="fas fa-trash me-1"></i> Excluir
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
            }).join('');
            
            // Adicionar event listeners para os botões de excluir
            setTimeout(() => {
                const botoesExcluir = container.querySelectorAll('.btn-excluir-ciclo');
                console.log(`🔍 Encontrados ${botoesExcluir.length} botões de excluir`);
                
                botoesExcluir.forEach((btn, index) => {
                    // Remover listeners anteriores se existirem
                    const novoBtn = btn.cloneNode(true);
                    btn.parentNode.replaceChild(novoBtn, btn);
                    
                    novoBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('🗑️ Botão de excluir clicado:', {
                            cicloId: this.dataset.cicloId,
                            cicloNome: this.dataset.cicloNome
                        });
                        
                        const cicloId = this.dataset.cicloId;
                        const cicloNome = this.dataset.cicloNome || 'este ciclo';
                        
                        if (!cicloId) {
                            console.error('❌ ID do ciclo não encontrado');
                            showNotification('Erro: ID do ciclo não encontrado', 'error');
                            return;
                        }
                        
                        confirmarExcluirCiclo(cicloId, cicloNome);
                    });
                    
                    console.log(`✅ Event listener adicionado ao botão ${index + 1}`);
                });
            }, 100);
        }

        function abrirModalNovoCiclo() {
            try {
                // Verificar permissões novamente
                if (!podeGerenciarCiclos()) {
                    console.log('❌ Usuário sem permissão para criar ciclos:', currentUserProfile);
                    showNotification('Você não tem permissão para criar ciclos de avaliação. Apenas usuários do RH ou administradores podem criar ciclos.', 'error');
                    return;
                }
                
                console.log('✅ Usuário autorizado a criar ciclos');
                
                console.log('📝 Abrindo modal para novo ciclo...');
                document.getElementById('modalCicloTitle').textContent = 'Novo Ciclo de Avaliação';
                document.getElementById('formCiclo').reset();
                document.getElementById('cicloId').value = '';
                document.getElementById('cicloTipoAvaliacao').value = '';
                
                // Função para configurar o modal
                const configurarModal = () => {
                    const selecao = document.getElementById('selecaoTipoAvaliacao');
                    const formulario = document.getElementById('formularioCiclo');
                    const btnSalvar = document.getElementById('btnSalvarCiclo');
                    
                    console.log('🔍 Configurando modal:', {
                        selecao: !!selecao,
                        formulario: !!formulario,
                        btnSalvar: !!btnSalvar
                    });
                    
                    if (selecao) {
                        selecao.style.display = 'block';
                        selecao.style.visibility = 'visible';
                        selecao.style.opacity = '1';
                    }
                    
                    if (formulario) {
                        formulario.style.display = 'none';
                    }
                    
                    if (btnSalvar) {
                        btnSalvar.style.display = 'none';
                    }
                    
                    // Limpar seleções visuais
                    const cardOrg = document.getElementById('cardTipoOrganizacao');
                    const cardLid = document.getElementById('cardTipoLideranca');
                    const cardColab = document.getElementById('cardTipoColaborador');
                    const checkOrg = document.getElementById('checkOrganizacao');
                    const checkLid = document.getElementById('checkLideranca');
                    const checkColab = document.getElementById('checkColaborador');
                    
                    if (cardOrg) {
                        cardOrg.style.border = '2px solid rgba(255, 255, 255, 0.15)';
                        cardOrg.style.pointerEvents = 'auto';
                        cardOrg.style.cursor = 'pointer';
                    }
                    if (cardLid) {
                        cardLid.style.border = '2px solid rgba(255, 255, 255, 0.15)';
                        cardLid.style.pointerEvents = 'auto';
                        cardLid.style.cursor = 'pointer';
                    }
                    if (cardColab) {
                        cardColab.style.border = '2px solid rgba(255, 255, 255, 0.15)';
                        cardColab.style.pointerEvents = 'auto';
                        cardColab.style.cursor = 'pointer';
                    }
                    if (checkOrg) checkOrg.style.display = 'none';
                    if (checkLid) checkLid.style.display = 'none';
                    if (checkColab) checkColab.style.display = 'none';
                };
                
                // Configurar imediatamente
                configurarModal();
                
                // Definir valores padrão
                const statusSelect = document.getElementById('cicloStatus');
                if (statusSelect) statusSelect.value = 'rascunho';
                
                const anonimoCheck = document.getElementById('cicloAnonimo');
                if (anonimoCheck) anonimoCheck.checked = true;
                
                const autoCheck = document.getElementById('cicloAutoAvaliacao');
                if (autoCheck) autoCheck.checked = true;
                
                const gestorCheck = document.getElementById('cicloAvaliacaoGestor');
                if (gestorCheck) gestorCheck.checked = true;
                
                const paresCheck = document.getElementById('cicloAvaliacaoPares');
                if (paresCheck) paresCheck.checked = true;
                
                const subCheck = document.getElementById('cicloAvaliacaoSubordinados');
                if (subCheck) subCheck.checked = true;
                
                // Definir data mínima como hoje
                const hoje = new Date().toISOString().split('T')[0];
                const dataInicio = document.getElementById('cicloDataInicio');
                if (dataInicio) dataInicio.min = hoje;
                
                const dataFim = document.getElementById('cicloDataFim');
                if (dataFim) dataFim.min = hoje;
                
                const dataLimite = document.getElementById('cicloDataLimite');
                if (dataLimite) dataLimite.min = hoje;
                
                // Mostrar modal
                const modalElement = document.getElementById('modalCiclo');
                if (modalElement) {
                    // Garantir que o modal não tenha bloqueios
                    modalElement.style.pointerEvents = 'auto';
                    
                    const modal = new bootstrap.Modal(modalElement, {
                        backdrop: true,
                        keyboard: true,
                        focus: true
                    });
                    
                    // Garantir que o modal-dialog seja clicável
                    const modalDialog = modalElement.querySelector('.modal-dialog');
                    if (modalDialog) {
                        modalDialog.style.pointerEvents = 'auto';
                        modalDialog.style.zIndex = '1051';
                    }
                    
                    // Garantir que o modal-content seja clicável
                    const modalContentEl = modalElement.querySelector('.modal-content');
                    if (modalContentEl) {
                        modalContentEl.style.pointerEvents = 'auto';
                        modalContentEl.style.zIndex = '1052';
                    }
                    
                    modal.show();
                    
                    // Ajustar backdrop após mostrar
                    modalElement.addEventListener('shown.bs.modal', function() {
                        // Garantir que o backdrop não bloqueie o conteúdo do modal
                        const backdrops = document.querySelectorAll('.modal-backdrop');
                        backdrops.forEach((backdrop) => {
                            backdrop.style.pointerEvents = 'none';
                            backdrop.style.zIndex = '1040';
                        });
                        
                        // Garantir que os cards estejam acima
                        const cards = document.querySelectorAll('#selecaoTipoAvaliacao .card-modern');
                        cards.forEach((card) => {
                            card.style.zIndex = '10000';
                            card.style.pointerEvents = 'auto';
                            card.style.position = 'relative';
                        });
                    }, { once: true });
                    
                    // Garantir que a seleção de tipo seja visível após o modal abrir
                    modalElement.addEventListener('shown.bs.modal', function() {
                        console.log('✅ Modal aberto, configurando elementos...');
                        configurarModal();
                        
                        // Forçar visibilidade novamente após um pequeno delay
                        setTimeout(() => {
                            configurarModal();
                            
                            // Buscar os cards novamente após o modal estar totalmente renderizado
                            const cardOrg = document.getElementById('cardTipoOrganizacao');
                            const cardLid = document.getElementById('cardTipoLideranca');
                            const cardColab = document.getElementById('cardTipoColaborador');
                            
                            // Garantir que os cards sejam totalmente clicáveis
                            const cards = [cardOrg, cardLid, cardColab];
                            const tipos = ['organizacao', 'lideranca', 'colaborador'];
                            
                            cards.forEach((card, index) => {
                                if (card) {
                                    const tipo = tipos[index];
                                    
                                    // Forçar estilos inline
                                    card.style.pointerEvents = 'auto';
                                    card.style.cursor = 'pointer';
                                    card.style.position = 'relative';
                                    card.style.zIndex = '9999';
                                    card.style.userSelect = 'none';
                                    card.style.touchAction = 'manipulation';
                                    
                                    // Remover listeners antigos clonando o card
                                    const novoCard = card.cloneNode(true);
                                    card.parentNode.replaceChild(novoCard, card);
                                    
                                    // Adicionar event listener no novo card
                                    novoCard.addEventListener('click', function(e) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        e.stopImmediatePropagation();
                                        console.log(`🔵 CLIQUE DETECTADO no card: ${tipo}`);
                                        selecionarTipoAvaliacao(tipo);
                                        return false;
                                    }, true); // Usar capture phase
                                    
                                    // Também adicionar mousedown como fallback
                                    novoCard.addEventListener('mousedown', function(e) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        e.stopImmediatePropagation();
                                        console.log(`🔵 MOUSEDOWN DETECTADO no card: ${tipo}`);
                                        selecionarTipoAvaliacao(tipo);
                                        return false;
                                    }, true);
                                    
                                    // Touch events para mobile
                                    novoCard.addEventListener('touchend', function(e) {
                                        e.preventDefault();
                                        e.stopPropagation();
                                        e.stopImmediatePropagation();
                                        console.log(`🔵 TOUCH DETECTADO no card: ${tipo}`);
                                        selecionarTipoAvaliacao(tipo);
                                        return false;
                                    }, true);
                                    
                                    console.log(`✅ Event listeners adicionados ao card: ${tipo}`);
                                }
                            });
                            
                            // Event delegation no modal-content como backup
                            const modalContent = modalElement.querySelector('.modal-content');
                            if (modalContent) {
                                modalContent.addEventListener('click', function(e) {
                                    const card = e.target.closest('[data-tipo]');
                                    if (card && card.hasAttribute('data-tipo')) {
                                        const tipo = card.getAttribute('data-tipo');
                                        console.log('🔵 Event delegation capturou clique:', tipo);
                                        e.preventDefault();
                                        e.stopPropagation();
                                        selecionarTipoAvaliacao(tipo);
                                    }
                                }, true);
                            }
                            
                            console.log('✅ Todos os event listeners configurados');
                        }, 300);
                    }, { once: true });
                }
            } catch (error) {
                console.error('❌ Erro ao abrir modal de novo ciclo:', error);
                showNotification('Erro ao abrir formulário de novo ciclo', 'error');
            }
        }
        
        // Tornar função global para acesso via onclick inline
        window.selecionarTipoAvaliacao = function selecionarTipoAvaliacao(tipo) {
            try {
                console.log('📋 Selecionando tipo de avaliação:', tipo);
                
                const tipoInput = document.getElementById('cicloTipoAvaliacao');
                if (!tipoInput) {
                    console.error('❌ Campo cicloTipoAvaliacao não encontrado');
                    showNotification('Erro: Campo de tipo não encontrado. Recarregue a página.', 'error');
                    return;
                }
                
                tipoInput.value = tipo;
                
                // Atualizar UI visual
                const cardOrg = document.getElementById('cardTipoOrganizacao');
                const cardLid = document.getElementById('cardTipoLideranca');
                const cardColab = document.getElementById('cardTipoColaborador');
                const cardEquipe = document.getElementById('cardTipoEquipe');
                const checkOrg = document.getElementById('checkOrganizacao');
                const checkLid = document.getElementById('checkLideranca');
                const checkColab = document.getElementById('checkColaborador');
                const checkEquipe = document.getElementById('checkEquipe');
                const campoCargoAvaliado = document.getElementById('campoCargoAvaliado');
                
                if (!cardOrg || !cardLid || !cardColab || !cardEquipe) {
                    console.error('❌ Cards de tipo não encontrados');
                    showNotification('Erro: Cards de seleção não encontrados. Recarregue a página.', 'error');
                    return;
                }
                
                // Resetar todos os cards
                cardOrg.style.border = '2px solid rgba(255, 255, 255, 0.15)';
                cardLid.style.border = '2px solid rgba(255, 255, 255, 0.15)';
                cardColab.style.border = '2px solid rgba(255, 255, 255, 0.15)';
                cardEquipe.style.border = '2px solid rgba(255, 255, 255, 0.15)';
                if (checkOrg) checkOrg.style.display = 'none';
                if (checkLid) checkLid.style.display = 'none';
                if (checkColab) checkColab.style.display = 'none';
                if (checkEquipe) checkEquipe.style.display = 'none';
                
                // Ocultar campo de cargo por padrão
                if (campoCargoAvaliado) campoCargoAvaliado.style.display = 'none';
                
                const cicloNome = document.getElementById('cicloNome');
                const cicloDescricao = document.getElementById('cicloDescricao');
                
                if (tipo === 'organizacao') {
                    cardOrg.style.border = '3px solid var(--primary)';
                    cardOrg.style.boxShadow = '0 0 20px rgba(102, 126, 234, 0.3)';
                    if (checkOrg) checkOrg.style.display = 'block';
                    if (cicloNome) cicloNome.value = 'Avaliação Organizacional';
                    if (cicloDescricao) cicloDescricao.value = 'Avaliação 360º da organização como um todo. Todos os funcionários podem avaliar.';
                } else if (tipo === 'lideranca') {
                    cardLid.style.border = '3px solid var(--primary)';
                    cardLid.style.boxShadow = '0 0 20px rgba(102, 126, 234, 0.3)';
                    if (checkLid) checkLid.style.display = 'block';
                    if (cicloNome) cicloNome.value = 'Avaliação de Liderança';
                    if (cicloDescricao) cicloDescricao.value = 'Avaliação 360º de liderança (coordenação, gerência, diretoria). Colaboradores avaliam seus líderes hierárquicos.';
                    // Mostrar campo de cargo para avaliação de liderança
                    if (campoCargoAvaliado) campoCargoAvaliado.style.display = 'block';
                } else if (tipo === 'colaborador') {
                    cardColab.style.border = '3px solid var(--primary)';
                    cardColab.style.boxShadow = '0 0 20px rgba(102, 126, 234, 0.3)';
                    if (checkColab) checkColab.style.display = 'block';
                    if (cicloNome) cicloNome.value = 'Avaliação Individual de Colaboradores';
                    if (cicloDescricao) cicloDescricao.value = 'Avaliação 360º individual de colaboradores. Cada colaborador será avaliado por gestor, pares e auto-avaliação.';
                } else if (tipo === 'equipe') {
                    cardEquipe.style.border = '3px solid var(--primary)';
                    cardEquipe.style.boxShadow = '0 0 20px rgba(102, 126, 234, 0.3)';
                    if (checkEquipe) checkEquipe.style.display = 'block';
                    if (cicloNome) cicloNome.value = 'Avaliação de Equipe';
                    if (cicloDescricao) cicloDescricao.value = 'Avaliação 360º de equipe. O líder avalia seu time como um todo, focando em competências coletivas e dinâmica de grupo.';
                }
                
                // Mostrar formulário
                const selecao = document.getElementById('selecaoTipoAvaliacao');
                const formulario = document.getElementById('formularioCiclo');
                const btnSalvar = document.getElementById('btnSalvarCiclo');
                
                if (selecao) {
                    selecao.style.display = 'none';
                } else {
                    console.warn('⚠️ Elemento selecaoTipoAvaliacao não encontrado');
                }
                
                if (formulario) {
                    formulario.style.display = 'block';
                } else {
                    console.warn('⚠️ Elemento formularioCiclo não encontrado');
                }
                
                if (btnSalvar) {
                    btnSalvar.style.display = 'block';
                } else {
                    console.warn('⚠️ Botão btnSalvarCiclo não encontrado');
                }
                
                console.log('✅ Tipo de avaliação selecionado:', tipo);
                
            } catch (error) {
                tratarErro(error, 'Erro ao selecionar tipo de avaliação');
            }
        };
        
        function confirmarExcluirCiclo(cicloId, cicloNome) {
            try {
                console.log('🔔 Confirmando exclusão:', { cicloId, cicloNome });
                
                if (!cicloId) {
                    console.error('❌ ID do ciclo não fornecido');
                    showNotification('Erro: ID do ciclo não fornecido', 'error');
                    return;
                }
                
                cicloNome = cicloNome || 'este ciclo';
                
                if (!confirm(`Tem certeza que deseja excluir o ciclo "${cicloNome}"?\n\nEsta ação não pode ser desfeita e irá excluir todas as avaliações relacionadas.`)) {
                    console.log('❌ Exclusão cancelada pelo usuário');
                    return;
                }
                
                console.log('✅ Usuário confirmou exclusão, iniciando processo...');
                excluirCiclo(cicloId);
            } catch (error) {
                console.error('❌ Erro ao confirmar exclusão:', error);
                showNotification('Erro ao confirmar exclusão: ' + error.message, 'error');
                if (confirm('Tem certeza que deseja excluir este ciclo?\n\nEsta ação não pode ser desfeita.')) {
                    excluirCiclo(cicloId);
                }
            }
        }
        
        async function excluirCiclo(cicloId) {
            try {
                console.log('🗑️ Iniciando exclusão do ciclo:', cicloId);
                
                // Verificar se há avaliações relacionadas
                const { data: todasAvaliacoes, error: errTodas } = await supabaseClient
                    .from('avaliacao_360_avaliacoes')
                    .select('id')
                    .eq('ciclo_id', cicloId);
                
                if (errTodas) {
                    console.error('Erro ao verificar avaliações:', errTodas);
                    showNotification('Erro ao verificar avaliações relacionadas', 'error');
                    return;
                }
                
                if (todasAvaliacoes && todasAvaliacoes.length > 0) {
                    if (!confirm(`Este ciclo possui ${todasAvaliacoes.length} avaliação(ões) relacionada(s). Deseja realmente excluir tudo?`)) {
                        return;
                    }
                    
                    // Excluir em cascata (avaliadores, respostas, competências, avaliações)
                    const avaliacaoIds = todasAvaliacoes.map(a => a.id);
                    
                    // Buscar todos os avaliadores para excluir respostas
                    const { data: avaliadores } = await supabaseClient
                        .from('avaliacao_360_avaliadores')
                        .select('id')
                        .in('avaliacao_id', avaliacaoIds);
                    
                    if (avaliadores && avaliadores.length > 0) {
                        const avaliadorIds = avaliadores.map(a => a.id);
                        
                        // Excluir respostas
                        const { error: errRespostas } = await supabaseClient
                            .from('avaliacao_360_respostas')
                            .delete()
                            .in('avaliador_id', avaliadorIds);
                        
                        if (errRespostas) {
                            console.warn('Aviso ao excluir respostas:', errRespostas);
                        }
                        
                        // Excluir avaliadores
                        const { error: errAvaliadores } = await supabaseClient
                            .from('avaliacao_360_avaliadores')
                            .delete()
                            .in('avaliacao_id', avaliacaoIds);
                        
                        if (errAvaliadores) {
                            console.warn('Aviso ao excluir avaliadores:', errAvaliadores);
                        }
                    }
                    
                    // Excluir avaliações
                    const { error: errAvaliacoes } = await supabaseClient
                        .from('avaliacao_360_avaliacoes')
                        .delete()
                        .eq('ciclo_id', cicloId);
                    
                    if (errAvaliacoes) {
                        console.warn('Aviso ao excluir avaliações:', errAvaliacoes);
                    }
                }
                
                // Nota: Competências, avaliações e notificações serão excluídas automaticamente
                // pelo CASCADE quando o ciclo for excluído. Apenas precisamos excluir
                // respostas e avaliadores manualmente.
                
                // Primeiro, verificar se o usuário tem permissão para excluir este ciclo
                const { data: cicloInfo, error: errInfo } = await supabaseClient
                    .from('avaliacao_360_ciclos')
                    .select('id, criado_por, nome')
                    .eq('id', cicloId)
                    .single();
                
                if (errInfo || !cicloInfo) {
                    console.error('❌ Erro ao buscar informações do ciclo:', errInfo);
                    showNotification('Erro: Não foi possível encontrar o ciclo para exclusão.', 'error');
                    return;
                }
                
                // Verificar permissão
                const podeExcluir = cicloInfo.criado_por === currentUserId || 
                                  currentUserProfile?.departamento === 'RH' || 
                                  currentUserProfile?.role === 'admin';
                
                if (!podeExcluir) {
                    showNotification('Você não tem permissão para excluir este ciclo. Apenas o criador ou usuários RH/Admin podem excluir.', 'error');
                    return;
                }
                
                // Excluir ciclo (CASCADE vai excluir automaticamente: avaliações, competências, notificações)
                console.log('🗑️ Excluindo ciclo do banco de dados...', cicloId);
                
                const { data: deletedData, error } = await supabaseClient
                    .from('avaliacao_360_ciclos')
                    .delete()
                    .eq('id', cicloId)
                    .select();
                
                if (error) {
                    console.error('❌ Erro ao excluir ciclo:', error);
                    console.error('Código do erro:', error.code);
                    console.error('Mensagem:', error.message);
                    console.error('Detalhes completos:', JSON.stringify(error, null, 2));
                    
                    let mensagemErro = 'Erro ao excluir ciclo: ' + (error.message || 'Erro desconhecido');
                    
                    // Mensagens mais específicas para erros comuns
                    if (error.code === '42501' || error.message?.includes('permission') || error.message?.includes('policy')) {
                        mensagemErro = 'Erro de permissão: Você não tem permissão para excluir este ciclo. Apenas o criador do ciclo ou usuários RH/Admin podem excluir.';
                    } else if (error.code === '23503' || error.message?.includes('foreign key')) {
                        mensagemErro = 'Erro: Existem registros relacionados que impedem a exclusão. Tente novamente.';
                    }
                    
                    showNotification(mensagemErro, 'error');
                    return;
                }
                
                if (!deletedData || deletedData.length === 0) {
                    console.warn('⚠️ Nenhum registro foi excluído (possível problema de permissão RLS)');
                    showNotification('Erro: O ciclo não pôde ser excluído. Verifique as permissões ou se você é o criador do ciclo.', 'error');
                    return;
                }
                
                console.log('✅ Ciclo excluído com sucesso do banco:', deletedData);
                
                // Verificar se realmente foi excluído (aguardar um pouco)
                await new Promise(resolve => setTimeout(resolve, 500));
                
                const { data: verificaCiclo, error: errVerifica } = await supabaseClient
                    .from('avaliacao_360_ciclos')
                    .select('id')
                    .eq('id', cicloId)
                    .maybeSingle();
                
                if (!errVerifica && verificaCiclo) {
                    console.error('❌ ERRO CRÍTICO: Ciclo ainda existe no banco após exclusão!');
                    console.error('Ciclo encontrado:', verificaCiclo);
                    showNotification('Erro: O ciclo não foi excluído do banco de dados. Verifique as permissões ou entre em contato com o suporte.', 'error');
                    return;
                }
                
                console.log('✅ Confirmação: Ciclo não existe mais no banco');
                showNotification('Ciclo excluído com sucesso!', 'success');
                
                // Limpar a lista primeiro
                const container = document.getElementById('ciclosList');
                if (container) {
                    container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Carregando...</span></div></div>';
                }
                
                // Aguardar um pouco e recarregar
                await new Promise(resolve => setTimeout(resolve, 300));
                await loadCiclos();
                console.log('🔄 Lista de ciclos recarregada após exclusão');
                
                // Fechar modal se estiver aberto
                const modalCiclo = bootstrap.Modal.getInstance(document.getElementById('modalCiclo'));
                if (modalCiclo) {
                    modalCiclo.hide();
                }
                
            } catch (error) {
                console.error('Erro inesperado ao excluir ciclo:', error);
                showNotification('Erro ao excluir ciclo: ' + error.message, 'error');
            }
        }

        async function editarCiclo(cicloId) {
            const { data, error } = await supabaseClient
                .from('avaliacao_360_ciclos')
                .select('*')
                .eq('id', cicloId)
                .single();
            
            if (error || !data) {
                showNotification('Erro ao carregar ciclo', 'error');
                return;
            }
            
            document.getElementById('modalCicloTitle').textContent = 'Editar Ciclo de Avaliação';
            document.getElementById('cicloId').value = cicloId;
            document.getElementById('cicloNome').value = data.nome;
            document.getElementById('cicloDescricao').value = data.descricao || '';
            document.getElementById('cicloDataInicio').value = data.data_inicio;
            document.getElementById('cicloDataFim').value = data.data_fim;
            document.getElementById('cicloDataLimite').value = data.data_limite_respostas;
            document.getElementById('cicloStatus').value = data.status;
            document.getElementById('cicloAnonimo').checked = data.anonimo;
            document.getElementById('cicloAutoAvaliacao').checked = data.permitir_auto_avaliacao;
            document.getElementById('cicloAvaliacaoGestor').checked = data.permitir_avaliacao_gestor;
            document.getElementById('cicloAvaliacaoPares').checked = data.permitir_avaliacao_pares;
            document.getElementById('cicloAvaliacaoSubordinados').checked = data.permitir_avaliacao_subordinados;
            
            // Ocultar seleção de tipo e mostrar formulário diretamente
            document.getElementById('selecaoTipoAvaliacao').style.display = 'none';
            document.getElementById('formularioCiclo').style.display = 'block';
            document.getElementById('btnSalvarCiclo').style.display = 'block';
            
            new bootstrap.Modal(document.getElementById('modalCiclo')).show();
        }

        async function salvarCiclo() {
            try {
                console.log('💾 Iniciando salvamento do ciclo...');
                
                if (!validarFormularioCiclo()) {
                    console.log('❌ Validação falhou');
                    return;
                }
                
                if (!currentUserId) {
                    showNotification('Erro: Usuário não autenticado. Faça login novamente.', 'error');
                    return;
                }
                
                const cicloId = document.getElementById('cicloId').value;
                const tipoAvaliacao = document.getElementById('cicloTipoAvaliacao').value;
                const cargoAvaliado = document.getElementById('cicloCargoAvaliado')?.value || null;
                
                const dados = {
                    nome: document.getElementById('cicloNome').value.trim(),
                    descricao: document.getElementById('cicloDescricao').value.trim() || null,
                    data_inicio: document.getElementById('cicloDataInicio').value,
                    data_fim: document.getElementById('cicloDataFim').value,
                    data_limite_respostas: document.getElementById('cicloDataLimite').value,
                    status: document.getElementById('cicloStatus').value,
                    anonimo: document.getElementById('cicloAnonimo').checked,
                    permitir_auto_avaliacao: document.getElementById('cicloAutoAvaliacao').checked,
                    permitir_avaliacao_gestor: document.getElementById('cicloAvaliacaoGestor').checked,
                    permitir_avaliacao_pares: document.getElementById('cicloAvaliacaoPares').checked,
                    permitir_avaliacao_subordinados: document.getElementById('cicloAvaliacaoSubordinados').checked
                };
                
                // Adicionar tipo_avaliacao e cargo_avaliado se for avaliação de liderança
                if (tipoAvaliacao) {
                    dados.tipo_avaliacao = tipoAvaliacao;
                }
                
                if (tipoAvaliacao === 'lideranca') {
                    if (!cargoAvaliado) {
                        showNotification('Por favor, selecione o cargo/hierarquia sendo avaliado na avaliação de liderança.', 'warning');
                        return;
                    }
                    dados.cargo_avaliado = cargoAvaliado;
                } else {
                    dados.cargo_avaliado = null;
                }
                
                console.log('📋 Dados do ciclo:', dados);
                console.log('👤 Usuário atual:', currentUserId);
                
                let result;
                let novoCicloId = cicloId;
                
                if (cicloId) {
                    console.log('🔄 Atualizando ciclo existente:', cicloId);
                    result = await supabaseClient
                        .from('avaliacao_360_ciclos')
                        .update(dados)
                        .eq('id', cicloId)
                        .select();
                } else {
                    console.log('✨ Criando novo ciclo...');
                    dados.criado_por = currentUserId;
                    result = await supabaseClient
                        .from('avaliacao_360_ciclos')
                        .insert([dados])
                        .select();
                    
                    if (result.data && result.data.length > 0) {
                        novoCicloId = result.data[0].id;
                        console.log('✅ Ciclo criado com ID:', novoCicloId);
                    }
                }
                
                if (result.error) {
                    console.error('❌ Erro ao salvar ciclo:', result.error);
                    showNotification('Erro ao salvar ciclo: ' + result.error.message, 'error');
                    return;
                }
                
                if (!result.data || result.data.length === 0) {
                    console.error('❌ Nenhum dado retornado do banco');
                    showNotification('Erro: Nenhum dado foi retornado após salvar o ciclo.', 'error');
                    return;
                }
                
                console.log('✅ Ciclo salvo com sucesso!');
                
                // Se for um novo ciclo, aplicar template de competências automaticamente
                if (!cicloId && novoCicloId) {
                    const tipoAvaliacao = document.getElementById('cicloTipoAvaliacao').value;
                    if (tipoAvaliacao && TEMPLATES_COMPETENCIAS[tipoAvaliacao]) {
                        console.log(`📋 Aplicando template de competências: ${tipoAvaliacao}`);
                        const competencias = TEMPLATES_COMPETENCIAS[tipoAvaliacao];
                        const competenciasParaInserir = competencias.map(c => ({
                            ...c,
                            ciclo_id: novoCicloId,
                            obrigatoria: true
                        }));
                        
                        const { error: errComp } = await supabaseClient
                            .from('avaliacao_360_competencias')
                            .insert(competenciasParaInserir);
                        
                        if (errComp) {
                            console.error('❌ Erro ao aplicar template de competências:', errComp);
                            showNotification('Ciclo criado, mas houve erro ao aplicar template de competências', 'warning');
                        } else {
                            console.log(`✅ Template aplicado: ${competencias.length} competências adicionadas`);
                            
                            // Se for avaliação organizacional, criar avaliação para todos os funcionários
                            if (tipoAvaliacao === 'organizacao') {
                                console.log('🏢 Criando avaliações organizacionais para todos os funcionários...');
                                await criarAvaliacoesOrganizacionais(novoCicloId);
                            }
                        }
                    }
                }
                
                bootstrap.Modal.getInstance(document.getElementById('modalCiclo')).hide();
                await loadCiclos();
                showNotification('Ciclo salvo com sucesso!', 'success');
                await registrarHistorico('ciclo_salvo', `Ciclo ${dados.nome} ${cicloId ? 'atualizado' : 'criado'}`, null);
                
                // Se o ciclo foi aberto, notificar todos os avaliadores
                if (dados.status === 'aberto' && novoCicloId) {
                    console.log('🔔 Notificando avaliadores sobre ciclo aberto...');
                    await notificarCicloAberto(novoCicloId);
                }
            } catch (error) {
                console.error('❌ Erro inesperado ao salvar ciclo:', error);
                showNotification('Erro inesperado: ' + error.message, 'error');
            }
        }

        async function criarAvaliacoesOrganizacionais(cicloId) {
            try {
                console.log('🏢 Criando avaliações organizacionais para todos os funcionários...');
                
                // Buscar todos os usuários ativos (exceto motoristas)
                const { data: usuarios, error: usuariosError } = await supabaseClient
                    .from('user_profiles')
                    .select('id')
                    .eq('active', true)
                    .neq('role', 'motorista')
                    .neq('role', 'admin'); // Opcional: excluir admins também
                
                if (usuariosError) {
                    console.error('❌ Erro ao buscar usuários:', usuariosError);
                    return;
                }
                
                if (!usuarios || usuarios.length === 0) {
                    console.log('ℹ️ Nenhum usuário encontrado para criar avaliação organizacional');
                    return;
                }
                
                // Criar uma avaliação única para "organização"
                // Usaremos um ID especial ou criaremos uma avaliação por usuário
                // Para avaliação organizacional, cada funcionário pode avaliar
                // Para avaliação organizacional, criar uma avaliação única para a organização
                // Usaremos um ID especial (00000000-0000-0000-0000-000000000000) para representar a organização
                const organizacaoId = '00000000-0000-0000-0000-000000000000';
                
                // Criar uma avaliação para a organização
                const { data: avaliacaoOrg, error: insertError } = await supabaseClient
                    .from('avaliacao_360_avaliacoes')
                    .insert([{
                        ciclo_id: cicloId,
                        avaliado_id: organizacaoId, // ID especial para organização
                        status: 'pendente'
                    }])
                    .select()
                    .single();
                
                if (insertError) {
                    console.error('❌ Erro ao criar avaliação organizacional:', insertError);
                    showNotification('Erro ao criar avaliação organizacional', 'warning');
                    return;
                }
                
                console.log(`✅ Avaliação organizacional criada`);
                
                // Adicionar todos os funcionários como avaliadores da organização
                const avaliadoresParaInserir = usuarios.map(usuario => ({
                    avaliacao_id: avaliacaoOrg.id,
                    avaliador_id: usuario.id,
                    tipo_avaliador: 'auto',
                    status: 'pendente'
                }));
                
                const { error: errAvaliadores } = await supabaseClient
                    .from('avaliacao_360_avaliadores')
                    .insert(avaliadoresParaInserir);
                
                if (errAvaliadores) {
                    console.error('❌ Erro ao adicionar avaliadores:', errAvaliadores);
                } else {
                    console.log(`✅ ${avaliadoresParaInserir.length} avaliadores adicionados para avaliação organizacional`);
                }
            } catch (error) {
                console.error('❌ Erro inesperado ao criar avaliações organizacionais:', error);
            }
        }
        
        async function notificarCicloAberto(cicloId) {
            try {
                console.log('🔔 Iniciando notificação de ciclo aberto:', cicloId);
                
                // Buscar nome do ciclo
                const { data: ciclo, error: cicloError } = await supabaseClient
                    .from('avaliacao_360_ciclos')
                    .select('nome')
                    .eq('id', cicloId)
                    .single();
                
                if (cicloError || !ciclo) {
                    console.warn('⚠️ Ciclo não encontrado ou erro ao buscar:', cicloError);
                    return;
                }
                
                // Buscar todos os avaliadores pendentes deste ciclo
                const { data: avaliacoes, error: avaliacoesError } = await supabaseClient
                    .from('avaliacao_360_avaliacoes')
                    .select('id')
                    .eq('ciclo_id', cicloId);
                
                if (avaliacoesError) {
                    console.warn('⚠️ Erro ao buscar avaliações:', avaliacoesError);
                    return;
                }
                
                if (!avaliacoes || avaliacoes.length === 0) {
                    console.log('ℹ️ Nenhuma avaliação encontrada para este ciclo ainda');
                    return;
                }
                
                const avaliacaoIds = avaliacoes.map(a => a.id);
                
                const { data: avaliadores, error: avaliadoresError } = await supabaseClient
                    .from('avaliacao_360_avaliadores')
                    .select('avaliador_id, id, avaliacao_id')
                    .in('avaliacao_id', avaliacaoIds)
                    .eq('status', 'pendente');
                
                if (avaliadoresError) {
                    console.warn('⚠️ Erro ao buscar avaliadores:', avaliadoresError);
                    return;
                }
                
                if (!avaliadores || avaliadores.length === 0) {
                    console.log('ℹ️ Nenhum avaliador pendente encontrado');
                    return;
                }
                
                // Criar notificações para cada avaliador
                const notificacoes = avaliadores.map(a => ({
                    usuario_id: a.avaliador_id,
                    tipo: 'ciclo_aberto',
                    titulo: 'Ciclo de Avaliação Aberto',
                    mensagem: `O ciclo "${ciclo.nome}" foi aberto. Você tem avaliações pendentes!`,
                    ciclo_id: cicloId,
                    avaliacao_id: a.avaliacao_id,
                    avaliador_id: a.id,
                    lida: false
                }));
                
                if (notificacoes.length > 0) {
                    const { error: insertError } = await supabaseClient
                        .from('avaliacao_360_notificacoes')
                        .insert(notificacoes);
                    
                    if (insertError) {
                        console.error('❌ Erro ao inserir notificações:', insertError);
                        showNotification('Ciclo salvo, mas houve erro ao enviar notificações', 'warning');
                    } else {
                        console.log('✅ Notificações enviadas:', notificacoes.length);
                        showNotification(`${notificacoes.length} usuário(s) notificado(s) sobre o ciclo aberto`, 'success');
                    }
                }
            } catch (error) {
                console.error('❌ Erro ao notificar ciclo aberto:', error);
                // Não mostrar erro ao usuário, apenas logar
            }
        }

        async function verCiclo(cicloId) {
            cicloAtualId = cicloId;
            const { data: ciclo, error } = await supabaseClient
                .from('avaliacao_360_ciclos')
                .select('*')
                .eq('id', cicloId)
                .single();
            
            if (error || !ciclo) {
                showNotification('Erro ao carregar ciclo', 'error');
                return;
            }
            
            // Criar modal de detalhes do ciclo com abas
            const modalHTML = `
                <div class="modal fade" id="modalVerCiclo" tabindex="-1" style="z-index: 1050;">
                    <div class="modal-dialog modal-xl" style="z-index: 1051;">
                        <div class="modal-content" style="pointer-events: auto;">
                            <div class="modal-header">
                                <h5 class="modal-title">${ciclo.nome}</h5>
                                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <div class="row mb-4">
                                    <div class="col-md-3">
                                        <div class="stats-card">
                                            <div class="number" id="statsTotalAvaliacoes">0</div>
                                            <div class="label">Total de Avaliações</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stats-card">
                                            <div class="number" id="statsConcluidas">0</div>
                                            <div class="label">Concluídas</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stats-card">
                                            <div class="number" id="statsPendentes">0</div>
                                            <div class="label">Pendentes</div>
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="stats-card">
                                            <div class="number" id="statsTaxaConclusao">0%</div>
                                            <div class="label">Taxa de Conclusão</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Abas de navegação -->
                                <ul class="nav nav-tabs mb-4" id="tabsGerenciamento" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="tab-competencias" data-bs-toggle="tab" data-bs-target="#pane-competencias" type="button" role="tab">
                                            <i class="fas fa-layer-group me-2"></i> Competências
                                        </button>
                                    </li>
                                    ${(currentUserProfile?.departamento === 'RH' || currentUserProfile?.role === 'admin') ? `
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="tab-avaliadores" data-bs-toggle="tab" data-bs-target="#pane-avaliadores" type="button" role="tab">
                                            <i class="fas fa-users me-2"></i> Avaliadores
                                        </button>
                                    </li>
                                    ` : ''}
                                </ul>
                                
                                <!-- Conteúdo das abas -->
                                <div class="tab-content" id="tabContentGerenciamento">
                                    <div class="tab-pane fade show active" id="pane-competencias" role="tabpanel">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h6 class="mb-0">Competências do Ciclo</h6>
                                            <button class="btn btn-sm btn-primary-modern" onclick="abrirModalCompetencias('${cicloId}')">
                                                <i class="fas fa-plus me-1"></i> Adicionar Competência
                                            </button>
                                        </div>
                                        <div id="competenciasCicloList">
                                            <!-- Competências serão carregadas aqui -->
                                        </div>
                                    </div>
                                    ${(currentUserProfile?.departamento === 'RH' || currentUserProfile?.role === 'admin') ? `
                                    <div class="tab-pane fade" id="pane-avaliadores" role="tabpanel">
                                        <div id="avaliadoresGerenciamentoContent">
                                            <!-- Conteúdo de gerenciamento de avaliadores será carregado aqui -->
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remover modal anterior se existir
            const modalAnterior = document.getElementById('modalVerCiclo');
            if (modalAnterior) {
                modalAnterior.remove();
            }
            
            document.body.insertAdjacentHTML('beforeend', modalHTML);
            const modalElement = document.getElementById('modalVerCiclo');
            
            const modal = configurarModalInterativo(modalElement);
            
            // Quando a aba de avaliadores for ativada, carregar o conteúdo
            const tabAvaliadores = document.getElementById('tab-avaliadores');
            if (tabAvaliadores) {
                tabAvaliadores.addEventListener('shown.bs.tab', async function() {
                    await carregarGerenciamentoAvaliadores(cicloId);
                });
            }
            
            // Ajustar backdrop após mostrar
            modalElement.addEventListener('shown.bs.modal', async function() {
                // Carregar dados iniciais
                await loadEstatisticasCiclo(cicloId);
                await loadCompetenciasCiclo(cicloId);
            }, { once: true });
            
            modalElement.addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
            
            modal.show();
        }
        
        // Nova função para carregar o gerenciamento de avaliadores diretamente na aba
        async function carregarGerenciamentoAvaliadores(cicloId) {
            const container = document.getElementById('avaliadoresGerenciamentoContent');
            if (!container) return;
            
            container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Carregando...</p></div>';
            
            try {
                const { data: ciclo } = await supabaseClient
                    .from('avaliacao_360_ciclos')
                    .select('tipo_avaliacao')
                    .eq('id', cicloId)
                    .single();
                
                const tipoAvaliacao = ciclo?.tipo_avaliacao || '';
                const isEquipe = tipoAvaliacao === 'equipe';
                
                // Para avaliação de equipe, mostrar seleção por departamento
                if (isEquipe) {
                    await carregarGerenciamentoAvaliadoresEquipe(cicloId, container);
                } else {
                    await carregarGerenciamentoAvaliadoresIndividual(cicloId, container);
                }
            } catch (error) {
                console.error('Erro ao carregar gerenciamento de avaliadores:', error);
                container.innerHTML = '<div class="alert alert-danger">Erro ao carregar avaliadores</div>';
            }
        }
        
        // Função para carregar gerenciamento de avaliadores para avaliação de equipe (por departamento)
        async function carregarGerenciamentoAvaliadoresEquipe(cicloId, container) {
            const { data: usuarios } = await supabaseClient
                .from('user_profiles')
                .select('id, nome, email, departamento, cargo')
                .eq('active', true)
                .order('departamento, nome');
            
            const departamentos = [...new Set(usuarios?.map(u => u.departamento).filter(Boolean) || [])].sort();
            
            // Buscar avaliações existentes
            const { data: avaliacoes } = await supabaseClient
                .from('avaliacao_360_avaliacoes')
                .select('id, equipe_nome, avaliado_por_lider_id')
                .eq('ciclo_id', cicloId)
                .eq('tipo_avaliacao', 'equipe');
            
            container.innerHTML = `
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Avaliação de Equipe:</strong> Selecione o departamento que será avaliado. O líder do departamento avaliará sua equipe como um todo.
                </div>
                <div class="mb-4">
                    <label class="form-label fw-bold">Selecionar Departamento</label>
                    <select class="form-select" id="departamentoEquipeGerenciamento" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.1) 100%); color: #ffffff; border: 2px solid rgba(255, 255, 255, 0.2);">
                        <option value="">Selecione um departamento...</option>
                        ${departamentos.map(dept => `<option value="${dept}" style="background: rgba(15, 15, 35, 1); color: #ffffff;">${dept}</option>`).join('')}
                    </select>
                </div>
                <div id="equipeAvaliacoesList">
                    ${avaliacoes && avaliacoes.length > 0 ? avaliacoes.map(a => `
                        <div class="card-modern p-3 mb-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong>${a.equipe_nome || 'Equipe'}</strong>
                                    <small class="d-block text-muted">Avaliação de equipe</small>
                                </div>
                                <button class="btn btn-sm btn-outline-danger" onclick="removerAvaliacaoEquipe('${a.id}')">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    `).join('') : '<p class="text-muted">Nenhuma avaliação de equipe criada</p>'}
                </div>
                <button class="btn btn-primary-modern mt-3" onclick="criarAvaliacaoEquipe('${cicloId}')">
                    <i class="fas fa-plus me-2"></i> Criar Avaliação de Equipe
                </button>
            `;
            
            // Event listener para seleção de departamento
            const selectDept = document.getElementById('departamentoEquipeGerenciamento');
            if (selectDept) {
                selectDept.addEventListener('change', function() {
                    if (this.value) {
                        mostrarLideresDepartamento(this.value, cicloId);
                    }
                });
            }
        }
        
        // Função para carregar gerenciamento de avaliadores para avaliação individual
        async function carregarGerenciamentoAvaliadoresIndividual(cicloId, container) {
            const { data: usuarios } = await supabaseClient
                .from('user_profiles')
                .select('id, nome, email, departamento, cargo')
                .eq('active', true)
                .order('nome');
            
            container.innerHTML = `
                <div class="mb-3">
                    <label class="form-label fw-bold">Selecionar Avaliado</label>
                    <select class="form-select" id="avaliadoSelectGerenciamento" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.1) 100%); color: #ffffff; border: 2px solid rgba(255, 255, 255, 0.2);">
                        <option value="">Selecione um avaliado...</option>
                        ${usuarios?.map(u => `<option value="${u.id}" style="background: rgba(15, 15, 35, 1); color: #ffffff;">${u.nome || u.email} - ${u.departamento || 'N/A'}</option>`).join('') || ''}
                    </select>
                </div>
                <div id="avaliadoresGerenciamentoDetalhes">
                    <p class="text-muted text-center py-4">Selecione um avaliado para gerenciar seus avaliadores</p>
                </div>
            `;
            
            const selectAvaliado = document.getElementById('avaliadoSelectGerenciamento');
            if (selectAvaliado) {
                selectAvaliado.addEventListener('change', async function() {
                    if (this.value) {
                        const detalhesContainer = document.getElementById('avaliadoresGerenciamentoDetalhes');
                        detalhesContainer.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Carregando...</p></div>';
                        
                        // Carregar avaliadores diretamente no container de detalhes
                        await loadAvaliadoresParaGerenciamento(this.value, detalhesContainer);
                    } else {
                        const detalhesContainer = document.getElementById('avaliadoresGerenciamentoDetalhes');
                        if (detalhesContainer) {
                            detalhesContainer.innerHTML = '<p class="text-muted text-center py-4">Selecione um avaliado para gerenciar seus avaliadores</p>';
                        }
                    }
                });
            }
        }
        
        // Versão adaptada de loadAvaliadores para o contexto de gerenciamento
        async function loadAvaliadoresParaGerenciamento(avaliadoId, container) {
            if (!avaliadoId || avaliadoId.trim() === '') {
                container.innerHTML = '<p class="text-danger">ID do avaliado inválido</p>';
                return;
            }
            
            // Usar a função loadAvaliadores existente mas adaptar para o novo container
            await loadAvaliadores(avaliadoId);
            
            // Copiar conteúdo do avaliadoresContent para o container de gerenciamento
            const avaliadoresContent = document.getElementById('avaliadoresContent');
            if (avaliadoresContent && container) {
                container.innerHTML = avaliadoresContent.innerHTML;
            }
        }
        
        async function mostrarLideresDepartamento(departamento, cicloId) {
            const { data: usuarios } = await supabaseClient
                .from('user_profiles')
                .select('id, nome, email, cargo')
                .eq('active', true)
                .eq('departamento', departamento)
                .order('nome');
            
            // Identificar líderes (geralmente têm cargo de coordenação, gerência ou direção)
            const cargosLideranca = ['coordenador', 'coordenadora', 'gerente', 'diretor', 'diretora', 'supervisor', 'supervisora'];
            const lideres = usuarios?.filter(u => 
                u.cargo && cargosLideranca.some(cargo => u.cargo.toLowerCase().includes(cargo.toLowerCase()))
            ) || [];
            
            const container = document.getElementById('equipeAvaliacoesList');
            if (!container) return;
            
            if (lideres.length === 0) {
                container.innerHTML += `
                    <div class="alert alert-warning mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Nenhum líder identificado no departamento ${departamento}. 
                        Você pode criar a avaliação de equipe mesmo assim.
                    </div>
                `;
            } else {
                container.innerHTML += `
                    <div class="card-modern p-3 mt-3">
                        <h6 class="mb-3">Líderes do Departamento ${departamento}</h6>
                        ${lideres.map(l => `
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                                <div>
                                    <strong>${l.nome || l.email}</strong>
                                    <small class="d-block text-muted">${l.cargo || 'N/A'}</small>
                                </div>
                                <button class="btn btn-sm btn-primary-modern" onclick="criarAvaliacaoEquipeComLider('${cicloId}', '${departamento}', '${l.id}')">
                                    <i class="fas fa-check me-1"></i> Usar este líder
                                </button>
                            </div>
                        `).join('')}
                    </div>
                `;
            }
        }
        
        async function criarAvaliacaoEquipe(cicloId) {
            const selectDept = document.getElementById('departamentoEquipeGerenciamento');
            if (!selectDept || !selectDept.value) {
                showNotification('Selecione um departamento primeiro', 'warning');
                return;
            }
            
            const departamento = selectDept.value;
            await mostrarLideresDepartamento(departamento, cicloId);
        }
        
        async function criarAvaliacaoEquipeComLider(cicloId, departamento, liderId) {
            try {
                // Verificar se já existe avaliação de equipe para este departamento neste ciclo
                const { data: avaliacaoExistente } = await supabaseClient
                    .from('avaliacao_360_avaliacoes')
                    .select('id')
                    .eq('ciclo_id', cicloId)
                    .eq('tipo_avaliacao', 'equipe')
                    .eq('equipe_nome', departamento)
                    .limit(1);
                
                if (avaliacaoExistente && avaliacaoExistente.length > 0) {
                    showNotification('Já existe uma avaliação de equipe para este departamento neste ciclo', 'warning');
                    return;
                }
                
                // Buscar membros da equipe (todos do departamento exceto o líder)
                const { data: membrosEquipe } = await supabaseClient
                    .from('user_profiles')
                    .select('id')
                    .eq('active', true)
                    .eq('departamento', departamento)
                    .neq('id', liderId);
                
                // Criar avaliação de equipe
                const { data: novaAvaliacao, error: errAval } = await supabaseClient
                    .from('avaliacao_360_avaliacoes')
                    .insert([{
                        ciclo_id: cicloId,
                        avaliado_id: null, // Em avaliação de equipe, não há um único avaliado
                        avaliado_por_lider_id: liderId,
                        tipo_avaliacao: 'equipe',
                        equipe_nome: departamento,
                        status: 'pendente'
                    }])
                    .select()
                    .single();
                
                if (errAval) {
                    tratarErro(errAval, 'Erro ao criar avaliação de equipe');
                    return;
                }
                
                // Criar avaliador (o líder que vai avaliar a equipe)
                const { data: avaliador, error: errAvaliador } = await supabaseClient
                    .from('avaliacao_360_avaliadores')
                    .insert([{
                        avaliacao_id: novaAvaliacao.id,
                        avaliador_id: liderId,
                        tipo_avaliador: 'gestor',
                        status: 'pendente',
                        anonimo: false
                    }])
                    .select()
                    .single();
                
                if (errAvaliador) {
                    console.error('Erro ao criar avaliador:', errAvaliador);
                }
                
                // Criar notificação para o líder
                await supabaseClient
                    .from('avaliacao_360_notificacoes')
                    .insert([{
                        usuario_id: liderId,
                        tipo: 'nova_avaliacao',
                        titulo: 'Avaliação de Equipe Disponível',
                        mensagem: `Você foi designado para avaliar a equipe do departamento ${departamento}`,
                        ciclo_id: cicloId,
                        avaliacao_id: novaAvaliacao.id,
                        avaliador_id: avaliador?.id || null,
                        lida: false
                    }]);
                
                showNotification('Avaliação de equipe criada com sucesso!', 'success');
                await carregarGerenciamentoAvaliadores(cicloId);
            } catch (error) {
                tratarErro(error, 'Erro ao criar avaliação de equipe');
            }
        }
        
        async function removerAvaliacaoEquipe(avaliacaoId) {
            if (!confirm('Tem certeza que deseja remover esta avaliação de equipe?')) return;
            
            const { error } = await supabaseClient
                .from('avaliacao_360_avaliacoes')
                .delete()
                .eq('id', avaliacaoId);
            
            if (error) {
                showNotification('Erro ao remover avaliação', 'error');
            } else {
                showNotification('Avaliação removida com sucesso', 'success');
                await carregarGerenciamentoAvaliadores(cicloAtualId);
            }
        }

        async function loadEstatisticasCiclo(cicloId) {
            const { data: avaliacoes, error } = await supabaseClient
                .from('avaliacao_360_avaliacoes')
                .select('status')
                .eq('ciclo_id', cicloId);
            
            if (error) return;
            
            const total = avaliacoes.length;
            const concluidas = avaliacoes.filter(a => a.status === 'concluida').length;
            const pendentes = avaliacoes.filter(a => a.status === 'pendente' || a.status === 'em_andamento').length;
            const taxa = total > 0 ? Math.round((concluidas / total) * 100) : 0;
            
            document.getElementById('statsTotalAvaliacoes').textContent = total;
            document.getElementById('statsConcluidas').textContent = concluidas;
            document.getElementById('statsPendentes').textContent = pendentes;
            document.getElementById('statsTaxaConclusao').textContent = taxa + '%';
        }

        async function loadCompetenciasCiclo(cicloId) {
            const { data, error } = await supabaseClient
                .from('avaliacao_360_competencias')
                .select('*')
                .eq('ciclo_id', cicloId)
                .order('ordem', { ascending: true });
            
            if (error) return;
            
            const container = document.getElementById('competenciasCicloList');
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-muted">Nenhuma competência cadastrada</p>';
                return;
            }
            
            container.innerHTML = data.map(c => `
                <div class="competencia-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${c.categoria}</strong> - ${c.competencia}
                            ${c.descricao ? `<p class="text-muted mb-0 mt-1">${c.descricao}</p>` : ''}
                            <small class="text-muted">Tipo: ${c.tipo_avaliacao} | Peso: ${c.peso}</small>
                        </div>
                        ${(currentUserProfile?.departamento === 'RH' || currentUserProfile?.role === 'admin') ? `
                            <button class="btn btn-sm btn-outline-primary" onclick="editarCompetencia('${c.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        // ========== COMPETÊNCIAS ==========
        // Templates de competências pré-definidos
        const TEMPLATES_COMPETENCIAS = {
            organizacao: [
                { categoria: 'Organizacional', competencia: 'Visão Estratégica', descricao: 'A empresa demonstra visão clara de futuro e estratégias bem definidas', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 1 },
                { categoria: 'Organizacional', competencia: 'Cultura Organizacional', descricao: 'Ambiente de trabalho positivo e alinhado com os valores da empresa', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 2 },
                { categoria: 'Organizacional', competencia: 'Comunicação Interna', descricao: 'Fluxo de informação eficiente e transparente na organização', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 3 },
                { categoria: 'Organizacional', competencia: 'Inovação', descricao: 'Empresa promove inovação e busca constantemente melhorias', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 4 },
                { categoria: 'Organizacional', competencia: 'Qualidade dos Serviços', descricao: 'Serviços e produtos oferecidos com alta qualidade', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 5 },
                { categoria: 'Recursos Humanos', competencia: 'Desenvolvimento de Pessoas', descricao: 'Empresa investe no desenvolvimento e crescimento dos colaboradores', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 6 },
                { categoria: 'Recursos Humanos', competencia: 'Reconhecimento e Valorização', descricao: 'Empresa reconhece e valoriza o trabalho dos colaboradores', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 7 },
                { categoria: 'Organizacional', competencia: 'Gestão de Processos', descricao: 'Processos organizados, eficientes e bem documentados', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 8 }
            ],
            lideranca: [
                { categoria: 'Liderança Estratégica', competencia: 'Visão e Direcionamento', descricao: 'Demonstra visão clara e direciona a equipe/departamento para objetivos estratégicos', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 1 },
                { categoria: 'Liderança', competencia: 'Liderança por Exemplo', descricao: 'Líder demonstra os valores e comportamentos esperados', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 2 },
                { categoria: 'Liderança', competencia: 'Tomada de Decisão', descricao: 'Decisões tomadas de forma ágil e fundamentada', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 3 },
                { categoria: 'Comunicação', competencia: 'Comunicação Eficaz', descricao: 'Comunica de forma clara e objetiva com a equipe', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 4 },
                { categoria: 'Gestão de Equipe', competencia: 'Desenvolvimento da Equipe', descricao: 'Investe no desenvolvimento e crescimento dos membros da equipe', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 5 },
                { categoria: 'Gestão de Equipe', competencia: 'Delegação', descricao: 'Delega responsabilidades de forma adequada e confia na equipe', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 6 },
                { categoria: 'Liderança', competencia: 'Motivação da Equipe', descricao: 'Mantém a equipe motivada e engajada', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 7 },
                { categoria: 'Gestão de Conflitos', competencia: 'Resolução de Conflitos', descricao: 'Resolve conflitos de forma construtiva e imparcial', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 8 },
                { categoria: 'Planejamento', competencia: 'Planejamento Estratégico', descricao: 'Planeja estrategicamente o futuro da equipe/departamento', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 9 },
                { categoria: 'Relacionamento', competencia: 'Relacionamento Interpessoal', descricao: 'Mantém relacionamentos positivos e respeitosos', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 10 },
                { categoria: 'Resultados', competencia: 'Orientação a Resultados', descricao: 'Foca em resultados e alcança objetivos estabelecidos', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 11 },
                { categoria: 'Liderança Hierárquica', competencia: 'Coordenação de Equipe', descricao: 'Coordena eficientemente as atividades e recursos da equipe', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 12 },
                { categoria: 'Liderança Hierárquica', competencia: 'Gestão de Performance', descricao: 'Avalia e gerencia o desempenho da equipe de forma justa e construtiva', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 13 }
            ],
            colaborador: [
                { categoria: 'Competências Técnicas', competencia: 'Conhecimento Técnico', descricao: 'Domina as competências técnicas necessárias para sua função', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 1 },
                { categoria: 'Competências Técnicas', competencia: 'Qualidade do Trabalho', descricao: 'Entrega trabalhos com alta qualidade e atenção aos detalhes', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 2 },
                { categoria: 'Competências Técnicas', competencia: 'Produtividade', descricao: 'Consegue entregar resultados dentro dos prazos estabelecidos', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 3 },
                { categoria: 'Comportamentais', competencia: 'Comunicação', descricao: 'Comunica-se de forma clara, objetiva e respeitosa', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 4 },
                { categoria: 'Comportamentais', competencia: 'Trabalho em Equipe', descricao: 'Colabora efetivamente com colegas e contribui para o sucesso da equipe', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 5 },
                { categoria: 'Comportamentais', competencia: 'Proatividade', descricao: 'Toma iniciativa e busca soluções sem esperar orientação', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 6 },
                { categoria: 'Comportamentais', competencia: 'Comprometimento', descricao: 'Demonstra compromisso com os objetivos e valores da organização', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 7 },
                { categoria: 'Desenvolvimento', competencia: 'Aprendizado Contínuo', descricao: 'Busca constantemente aprender e se desenvolver profissionalmente', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 8 },
                { categoria: 'Desenvolvimento', competencia: 'Adaptabilidade', descricao: 'Adapta-se bem a mudanças e novos desafios', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 9 },
                { categoria: 'Organizacionais', competencia: 'Organização e Planejamento', descricao: 'Organiza suas atividades e planeja seu trabalho de forma eficiente', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 10 },
                { categoria: 'Organizacionais', competencia: 'Pontualidade e Assiduidade', descricao: 'É pontual e assíduo em suas atividades', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 11 },
                { categoria: 'Relacionamento', competencia: 'Relacionamento Interpessoal', descricao: 'Mantém relacionamentos positivos e profissionais com colegas e clientes', tipo_avaliacao: 'numerica', peso: 1.0, ordem: 12 }
            ]
        };
        
        async function aplicarTemplateCompetencias(template) {
            if (!cicloAtualId) {
                showNotification('Erro: Nenhum ciclo selecionado', 'warning');
                return;
            }
            
            if (!confirm(`Deseja aplicar o template "${template === 'organizacao' ? 'Avaliar Organização' : 'Avaliar Liderança'}"? Isso irá adicionar as competências pré-definidas ao ciclo.`)) {
                return;
            }
            
            const competencias = TEMPLATES_COMPETENCIAS[template];
            if (!competencias) {
                showNotification('Template não encontrado', 'error');
                return;
            }
            
            try {
                // Adicionar todas as competências do template
                const competenciasParaInserir = competencias.map(c => ({
                    ...c,
                    ciclo_id: cicloAtualId,
                    obrigatoria: true
                }));
                
                const { error } = await supabaseClient
                    .from('avaliacao_360_competencias')
                    .insert(competenciasParaInserir);
                
                if (error) {
                    tratarErro(error, 'Erro ao aplicar template');
                    return;
                }
                
                showNotification(`Template aplicado com sucesso! ${competencias.length} competências adicionadas.`, 'success');
                await loadCompetencias(cicloAtualId);
            } catch (error) {
                tratarErro(error, 'Erro ao aplicar template');
            }
        }
        
        async function abrirModalCompetencias(cicloId) {
            cicloAtualId = cicloId;
            await loadCompetencias(cicloId);
            const modalElement = document.getElementById('modalCompetencias');
            if (modalElement) {
                // Garantir que o modal tenha z-index maior que o modal de ciclo
                modalElement.style.zIndex = '1060';
                const modalDialog = modalElement.querySelector('.modal-dialog');
                if (modalDialog) {
                    modalDialog.style.zIndex = '1061';
                }
                
                // Ajustar backdrop se existir
                setTimeout(() => {
                    const backdrops = document.querySelectorAll('.modal-backdrop');
                    if (backdrops.length > 1) {
                        // Se houver múltiplos backdrops (modal aninhado), ajustar o último
                        const lastBackdrop = backdrops[backdrops.length - 1];
                        lastBackdrop.style.zIndex = '1059';
                    }
                }, 100);
                
                const modal = new bootstrap.Modal(modalElement);
                modal.show();
            }
        }

        async function loadCompetencias(cicloId) {
            const { data, error } = await supabaseClient
                .from('avaliacao_360_competencias')
                .select('*')
                .eq('ciclo_id', cicloId)
                .order('ordem', { ascending: true });
            
            if (error) {
                console.error('Erro ao carregar competências:', error);
                return;
            }
            
            const container = document.getElementById('competenciasList');
            if (!data || data.length === 0) {
                container.innerHTML = '<p class="text-muted">Nenhuma competência cadastrada</p>';
                return;
            }
            
            container.innerHTML = data.map(c => `
                <div class="competencia-item">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${c.categoria}</strong> - ${c.competencia}
                            ${c.descricao ? `<p class="text-muted mb-0 mt-1">${c.descricao}</p>` : ''}
                            <small class="text-muted">Tipo: ${c.tipo_avaliacao} | Peso: ${c.peso} | Ordem: ${c.ordem}</small>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="editarCompetencia('${c.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="excluirCompetencia('${c.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function adicionarCompetencia() {
            document.getElementById('formCompetencia').reset();
            document.getElementById('competenciaId').value = '';
            document.getElementById('competenciaTipo').value = 'numerica';
            toggleCompetenciaTipo();
            new bootstrap.Modal(document.getElementById('modalCompetencia')).show();
        }

        function toggleCompetenciaTipo() {
            const tipo = document.getElementById('competenciaTipo').value;
            document.getElementById('escalaConfig').style.display = tipo === 'numerica' ? 'block' : 'none';
        }

        async function editarCompetencia(competenciaId) {
            const { data, error } = await supabaseClient
                .from('avaliacao_360_competencias')
                .select('*')
                .eq('id', competenciaId)
                .single();
            
            if (error || !data) {
                showNotification('Erro ao carregar competência', 'error');
                return;
            }
            
            document.getElementById('competenciaId').value = competenciaId;
            document.getElementById('competenciaCategoria').value = data.categoria;
            document.getElementById('competenciaNome').value = data.competencia;
            document.getElementById('competenciaDescricao').value = data.descricao || '';
            document.getElementById('competenciaTipo').value = data.tipo_avaliacao;
            document.getElementById('competenciaEscalaMin').value = data.escala_min || 1;
            document.getElementById('competenciaEscalaMax').value = data.escala_max || 5;
            document.getElementById('competenciaPeso').value = data.peso || 1.00;
            document.getElementById('competenciaOrdem').value = data.ordem || 0;
            document.getElementById('competenciaObrigatoria').checked = data.obrigatoria;
            
            toggleCompetenciaTipo();
            new bootstrap.Modal(document.getElementById('modalCompetencia')).show();
        }

        async function salvarCompetencia() {
            if (!cicloAtualId) {
                showNotification('Selecione um ciclo primeiro', 'warning');
                return;
            }
            
            const competenciaId = document.getElementById('competenciaId').value;
            const dados = {
                ciclo_id: cicloAtualId,
                categoria: document.getElementById('competenciaCategoria').value,
                competencia: document.getElementById('competenciaNome').value,
                descricao: document.getElementById('competenciaDescricao').value,
                tipo_avaliacao: document.getElementById('competenciaTipo').value,
                escala_min: parseInt(document.getElementById('competenciaEscalaMin').value) || 1,
                escala_max: parseInt(document.getElementById('competenciaEscalaMax').value) || 5,
                peso: parseFloat(document.getElementById('competenciaPeso').value) || 1.00,
                ordem: parseInt(document.getElementById('competenciaOrdem').value) || 0,
                obrigatoria: document.getElementById('competenciaObrigatoria').checked
            };
            
            let result;
            if (competenciaId) {
                result = await supabaseClient
                    .from('avaliacao_360_competencias')
                    .update(dados)
                    .eq('id', competenciaId);
            } else {
                result = await supabaseClient
                    .from('avaliacao_360_competencias')
                    .insert([dados]);
            }
            
            if (result.error) {
                tratarErro(result.error, 'Erro ao salvar competência');
                return;
            }
            
            bootstrap.Modal.getInstance(document.getElementById('modalCompetencia')).hide();
            await loadCompetencias(cicloAtualId);
            showNotification('Competência salva com sucesso!', 'success');
        }

        async function excluirCompetencia(competenciaId) {
            if (!confirm('Deseja realmente excluir esta competência?')) return;
            
            const { error } = await supabaseClient
                .from('avaliacao_360_competencias')
                .delete()
                .eq('id', competenciaId);
            
            if (error) {
                tratarErro(error, 'Erro ao excluir competência');
                return;
            }
            
            await loadCompetencias(cicloAtualId);
            showNotification('Competência excluída com sucesso!', 'success');
        }

        // ========== FUNÇÕES AUXILIARES ==========
        // Função auxiliar para configurar modal (reduz redundâncias)
        // Função consolidada para configurar modais interativos
        function configurarModalInterativo(modalElement) {
            if (!modalElement) return null;
            
            const modal = new bootstrap.Modal(modalElement, {
                backdrop: 'static',
                keyboard: true,
                focus: true
            });

            modalElement.addEventListener('shown.bs.modal', function() {
                modalElement.removeAttribute('aria-hidden');
                modalElement.setAttribute('aria-modal', 'true');
                
                // Ajustar backdrop
                const backdrops = document.querySelectorAll('.modal-backdrop');
                backdrops.forEach((backdrop, index) => {
                    if (index === backdrops.length - 1) {
                        backdrop.style.zIndex = '1059';
                    }
                });
                
                // Garantir interatividade
                modalElement.style.pointerEvents = 'auto';
                modalElement.style.zIndex = '1060';
                
                const modalDialog = modalElement.querySelector('.modal-dialog');
                if (modalDialog) {
                    modalDialog.style.pointerEvents = 'auto';
                    modalDialog.style.zIndex = '1061';
                }
                
                const modalContent = modalElement.querySelector('.modal-content');
                if (modalContent) {
                    modalContent.style.pointerEvents = 'auto';
                    modalContent.style.zIndex = '1062';
                }
                
                // Garantir interatividade em elementos clicáveis
                const clickableElements = modalElement.querySelectorAll('button, input, select, textarea, a, .btn');
                clickableElements.forEach(el => {
                    el.style.pointerEvents = 'auto';
                    el.style.cursor = 'pointer';
                    el.style.position = 'relative';
                    el.style.zIndex = '1063';
                });
            }, { once: true });

            modalElement.addEventListener('hidden.bs.modal', function() {
                modalElement.setAttribute('aria-hidden', 'true');
                modalElement.removeAttribute('aria-modal');
            }, { once: false });

            return modal;
        }
        
        // Função auxiliar para tratamento de erros com feedback ao usuário
        function tratarErro(erro, mensagemUsuario = 'Ocorreu um erro. Tente novamente.') {
            console.error('❌ Erro:', erro);
            showNotification(mensagemUsuario, 'error');
            return null;
        }
        
        // Função auxiliar para mostrar loading state
        function mostrarLoading(elementoId, texto = 'Carregando...') {
            const elemento = document.getElementById(elementoId);
            if (elemento) {
                elemento.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">${texto}</span>
                        </div>
                        <p class="mt-2 text-muted">${texto}</p>
                    </div>
                `;
            }
        }
        
        // ========== AVALIADORES ==========
        let tipoAvaliadorSelecionado = null; // Variável global para armazenar o tipo selecionado
        
        // Função simplificada - agora apenas para compatibilidade, mas o gerenciamento é feito via abas
        async function abrirModalAvaliadores(cicloId) {
            // Redirecionar para a aba de avaliadores no modal de gerenciamento
            const modalVerCiclo = document.getElementById('modalVerCiclo');
            if (modalVerCiclo) {
                const tabAvaliadores = document.getElementById('tab-avaliadores');
                if (tabAvaliadores) {
                    const tab = new bootstrap.Tab(tabAvaliadores);
                    tab.show();
                }
            } else {
                // Se o modal não estiver aberto, abrir o modal de gerenciamento
                await verCiclo(cicloId);
                setTimeout(() => {
                    const tabAvaliadores = document.getElementById('tab-avaliadores');
                    if (tabAvaliadores) {
                        const tab = new bootstrap.Tab(tabAvaliadores);
                        tab.show();
                    }
                }, 500);
            }
        }

        // Função para selecionar o tipo de avaliador (chamada quando clica nos cards)
        function selecionarTipoAvaliador(tipo) {
            tipoAvaliadorSelecionado = tipo;
            
            // Destacar o card selecionado
            document.querySelectorAll('#etapaTipoAvaliacao .card-modern').forEach(card => {
                card.style.border = '2px solid rgba(255, 255, 255, 0.2)';
                card.style.boxShadow = 'none';
                card.style.transform = 'scale(1)';
            });
            
            const cardSelecionado = document.querySelector(`#etapaTipoAvaliacao .card-modern[data-tipo="${tipo}"]`);
            if (cardSelecionado) {
                cardSelecionado.style.border = '3px solid #667eea';
                cardSelecionado.style.boxShadow = '0 0 20px rgba(102, 126, 234, 0.5)';
                cardSelecionado.style.transform = 'scale(1.02)';
            }
            
            // Aguardar um pouco para mostrar o feedback visual, depois avançar
            setTimeout(() => {
                // Esconder etapa de seleção do tipo
                const etapaTipo = document.getElementById('etapaTipoAvaliacao');
                if (etapaTipo) etapaTipo.style.display = 'none';
                
                // Mostrar etapa de seleção de avaliado e avaliadores
                const etapaSelecao = document.getElementById('etapaSelecaoAvaliadores');
                if (etapaSelecao) etapaSelecao.style.display = 'block';
            }, 300);
        }
        
        // Expor função globalmente
        window.selecionarTipoAvaliador = selecionarTipoAvaliador;

        async function loadAvaliadores(avaliadoId) {
            // Validar avaliadoId
            if (!avaliadoId || avaliadoId.trim() === '') {
                console.error('❌ avaliadoId não fornecido ou vazio');
                showNotification('Por favor, selecione um avaliado primeiro', 'warning');
                return;
            }
            
            // Buscar informações do ciclo para mostrar cargo/hierarquia
            const { data: cicloData, error: errCiclo } = await supabaseClient
                .from('avaliacao_360_ciclos')
                .select('tipo_avaliacao, cargo_avaliado')
                .eq('id', cicloAtualId)
                .single();
            
            const tipoAvaliacaoCiclo = cicloData?.tipo_avaliacao || '';
            const cargoAvaliado = cicloData?.cargo_avaliado || null;
            
            // Buscar avaliação existente ou criar
            const { data: avaliacoes, error: errAval } = await supabaseClient
                .from('avaliacao_360_avaliacoes')
                .select('id, tipo_avaliacao, avaliado_por_lider_id, equipe_nome')
                .eq('ciclo_id', cicloAtualId)
                .eq('avaliado_id', avaliadoId)
                .limit(1);
            
            const avaliacao = avaliacoes && avaliacoes.length > 0 ? avaliacoes[0] : null;
            let avaliacaoId = avaliacao?.id;
            
            if (errAval) {
                console.error('Erro ao buscar avaliação:', errAval);
                // Não retornar, continuar para criar nova avaliação
            }
            
            if (!avaliacaoId) {
                // Criar avaliação
                const dadosAvaliacao = {
                    ciclo_id: cicloAtualId,
                    avaliado_id: avaliadoId,
                    status: 'pendente',
                    tipo_avaliacao: 'individual' // Padrão é individual
                };
                
                // Se for avaliação de equipe, definir tipo
                if (tipoAvaliacaoCiclo === 'equipe') {
                    dadosAvaliacao.tipo_avaliacao = 'equipe';
                }
                
                const { data: novaAvaliacao, error } = await supabaseClient
                    .from('avaliacao_360_avaliacoes')
                    .insert([dadosAvaliacao])
                    .select()
                    .single();
                
                if (error) {
                    tratarErro(error, 'Erro ao criar avaliação');
                    return;
                }
                
                avaliacaoId = novaAvaliacao.id;
            }
            
            // Carregar avaliadores existentes
            const { data: avaliadores, error } = await supabaseClient
                .from('avaliacao_360_avaliadores')
                .select('*')
                .eq('avaliacao_id', avaliacaoId);
            
            // Enriquecer avaliadores com dados dos usuários
            if (avaliadores && avaliadores.length > 0) {
                const avaliadorIds = avaliadores.map(a => a.avaliador_id);
                const { data: avaliadoresData } = await supabaseClient
                    .from('user_profiles')
                    .select('id, nome, email, departamento')
                    .in('id', avaliadorIds);
                
                // Mapear dados dos avaliadores
                const avaliadoresMap = new Map((avaliadoresData || []).map(u => [u.id, u]));
                avaliadores.forEach(a => {
                    a.avaliador = avaliadoresMap.get(a.avaliador_id) || {
                        id: a.avaliador_id,
                        nome: 'Usuário não encontrado',
                        email: '',
                        departamento: 'N/A'
                    };
                });
            }
            
            // Buscar dados do avaliado
            const { data: avaliadoData, error: errAvaliado } = await supabaseClient
                .from('user_profiles')
                .select('*')
                .eq('id', avaliadoId)
                .single();
            
            // Buscar todos os usuários para a lista de avaliadores
            const { data: usuarios, error: errUsuarios } = await supabaseClient
                .from('user_profiles')
                .select('id, nome, email, departamento, cargo')
                .eq('active', true)
                .order('nome');
            
            if (errUsuarios) {
                console.error('❌ Erro ao buscar usuários:', errUsuarios);
            }
            
            console.log('👥 Usuários carregados:', usuarios?.length || 0);
            console.log('👥 Dados dos usuários:', usuarios);
            
            // Buscar pares (mesmo departamento, excluindo o próprio)
            const pares = usuarios?.filter(u => 
                u.id !== avaliadoId && 
                u.departamento === avaliadoData?.departamento &&
                u.active
            ) || [];
            
            const container = document.getElementById('avaliadoresContent');
            if (!container) {
                console.error('❌ Container avaliadoresContent não encontrado!');
                return;
            }
            
            console.log('✅ Renderizando lista de avaliadores com checkboxes...');
            
            // Buscar dados do avaliado para mostrar informações
            const { data: avaliadoInfo, error: errAvaliadoInfo } = await supabaseClient
                .from('user_profiles')
                .select('nome, email, cargo, departamento')
                .eq('id', avaliadoId)
                .single();
            
            // Montar informações contextuais
            let infoContextual = '';
            if (tipoAvaliacaoCiclo === 'lideranca' && cargoAvaliado) {
                const cargoLabel = cargoAvaliado === 'coordenacao' ? 'Coordenação' : 
                                  cargoAvaliado === 'gerencia' ? 'Gerência' : 
                                  cargoAvaliado === 'direcao' ? 'Direção' : cargoAvaliado;
                infoContextual = `<div class="alert alert-info mb-3" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 12px;">
                    <i class="fas fa-briefcase me-2"></i><strong>Cargo sendo avaliado:</strong> ${cargoLabel}
                </div>`;
            } else if (tipoAvaliacaoCiclo === 'colaborador' && avaliadoInfo) {
                infoContextual = `<div class="alert alert-info mb-3" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 12px;">
                    <i class="fas fa-user me-2"></i><strong>Colaborador sendo avaliado:</strong> ${avaliadoInfo.nome || avaliadoInfo.email} ${avaliadoInfo.cargo ? `(${avaliadoInfo.cargo})` : ''}
                </div>`;
            } else if (tipoAvaliacaoCiclo === 'equipe') {
                // Buscar todos os departamentos únicos
                const departamentosUnicos = [...new Set(usuarios?.map(u => u.departamento).filter(Boolean) || [])].sort();
                const departamentoSelecionado = avaliacao?.equipe_nome || avaliadoInfo?.departamento || '';
                
                infoContextual = `<div class="alert alert-info mb-3" style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%); border: 1px solid rgba(102, 126, 234, 0.3); border-radius: 12px;">
                    <i class="fas fa-users me-2"></i><strong>Tipo de avaliação:</strong> Avaliação de Equipe (o líder avalia seu time como um todo)
                </div>
                <div class="mb-3">
                    <label class="form-label" style="color: rgba(255, 255, 255, 0.95); font-weight: 600;">
                        <i class="fas fa-building me-2"></i>Selecionar Departamento da Equipe
                    </label>
                    <select class="form-select" id="departamentoEquipeSelect" onchange="filtrarPorDepartamentoEquipe()" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.1) 100%); color: #ffffff; border: 2px solid rgba(255, 255, 255, 0.2); pointer-events: auto;">
                        <option value="" style="background: rgba(15, 15, 35, 1); color: #ffffff;">Selecione um departamento...</option>
                        ${departamentosUnicos.map(dept => `<option value="${dept}" ${dept === departamentoSelecionado ? 'selected' : ''} style="background: rgba(15, 15, 35, 1); color: #ffffff;">${dept}</option>`).join('')}
                    </select>
                    <small style="color: rgba(255, 255, 255, 0.7); margin-top: 0.5rem; display: block;">
                        <i class="fas fa-info-circle me-1"></i> Selecione o departamento que será avaliado como equipe.
                    </small>
                </div>`;
            }
            
            container.innerHTML = `
                ${infoContextual}
                <div class="mb-4">
                    <h6 class="mb-3" style="color: rgba(255, 255, 255, 0.95); font-weight: 600;">
                        <i class="fas fa-users me-2"></i>Avaliadores para este ciclo
                    </h6>
                    <div id="avaliadoresList" style="max-height: 200px; overflow-y: auto;">
                        ${avaliadores && avaliadores.length > 0 ? avaliadores.map(a => `
                            <div class="d-flex justify-content-between align-items-center p-3 mb-2" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.04) 100%); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px;">
                                <div>
                                    <strong style="color: rgba(255, 255, 255, 0.95);">${a.avaliador?.nome || a.avaliador?.email || 'N/A'}</strong>
                                    <small class="d-block" style="color: rgba(255, 255, 255, 0.7); margin-top: 0.25rem;">
                                        ${a.tipo_avaliador} - ${a.status}
                                    </small>
                                </div>
                                <button class="btn btn-sm btn-outline-danger" onclick="removerAvaliador('${a.id}')" style="pointer-events: auto;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        `).join('') : '<p style="color: rgba(255, 255, 255, 0.7);">Nenhum avaliador adicionado</p>'}
                    </div>
                </div>
                
                <hr class="my-4" style="border-color: rgba(255, 255, 255, 0.1);">
                
                <div class="mb-4">
                    <h6 class="mb-3" style="color: rgba(255, 255, 255, 0.95); font-weight: 600;">
                        <i class="fas fa-user-plus me-2"></i>Adicionar Avaliadores
                    </h6>
                    
                    <div class="mb-3">
                        <label class="form-label" style="color: rgba(255, 255, 255, 0.95); font-weight: 600;">Busca Automática</label>
                        <div class="d-flex gap-2 flex-wrap">
                            <button class="btn btn-sm btn-outline-info" onclick="adicionarAutoAvaliacao('${avaliacaoId}', '${avaliadoId}')" style="pointer-events: auto;">
                                <i class="fas fa-user me-1"></i> Auto-avaliação
                            </button>
                            ${pares.length > 0 ? `
                                <button class="btn btn-sm btn-outline-info" onclick="adicionarParesAutomatico('${avaliacaoId}', '${avaliadoId}')" style="pointer-events: auto;">
                                    <i class="fas fa-users me-1"></i> Adicionar Pares (${pares.length})
                                </button>
                            ` : ''}
                            <button class="btn btn-sm btn-outline-info" onclick="adicionarSubordinadosAutomatico('${avaliacaoId}', '${avaliadoId}')" style="pointer-events: auto;">
                                <i class="fas fa-user-friends me-1"></i> Buscar Subordinados
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label" style="color: rgba(255, 255, 255, 0.95); font-weight: 600;">Tipo de Avaliador</label>
                        <select class="form-select" id="tipoAvaliadorSelect" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.1) 100%); color: #ffffff; border: 2px solid rgba(255, 255, 255, 0.2); pointer-events: auto;">
                            <option value="auto" ${tipoAvaliadorSelecionado === 'auto' ? 'selected' : ''} style="background: rgba(15, 15, 35, 1); color: #ffffff;">Auto-avaliação</option>
                            <option value="gestor" ${tipoAvaliadorSelecionado === 'gestor' ? 'selected' : ''} style="background: rgba(15, 15, 35, 1); color: #ffffff;">Gestor</option>
                            <option value="par" ${tipoAvaliadorSelecionado === 'par' ? 'selected' : ''} style="background: rgba(15, 15, 35, 1); color: #ffffff;">Par (Colega)</option>
                            <option value="subordinado" ${tipoAvaliadorSelecionado === 'subordinado' ? 'selected' : ''} style="background: rgba(15, 15, 35, 1); color: #ffffff;">Subordinado</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <label class="form-label mb-0" style="color: rgba(255, 255, 255, 0.95); font-weight: 600;">Selecionar Avaliadores</label>
                            <div>
                                <button type="button" class="btn btn-sm btn-outline-info" onclick="selecionarTodosAvaliadores()" style="pointer-events: auto; margin-right: 0.5rem;">
                                    <i class="fas fa-check-double me-1"></i> Selecionar Todos
                                </button>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="limparSelecaoAvaliadores()" style="pointer-events: auto;">
                                    <i class="fas fa-times me-1"></i> Limpar
                                </button>
                            </div>
                        </div>
                        <div class="input-group mb-2">
                            <span class="input-group-text" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.1) 100%); border: 2px solid rgba(255, 255, 255, 0.2); color: #ffffff;">
                                <i class="fas fa-search"></i>
                            </span>
                            <input type="text" id="buscarAvaliador" class="form-control" placeholder="Buscar avaliador por nome, email ou departamento..." style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.1) 100%); color: #ffffff; border: 2px solid rgba(255, 255, 255, 0.2); pointer-events: auto;" onkeyup="filtrarAvaliadores()">
                        </div>
                        <div id="listaAvaliadores" style="max-height: 300px; overflow-y: auto; border: 2px solid rgba(255, 255, 255, 0.2); border-radius: 8px; padding: 1rem; background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.04) 100%);">
                            ${usuarios && usuarios.length > 0 ? usuarios.filter(u => u.id !== avaliadoId).map(u => `
                                <div class="form-check mb-2 avaliador-item" data-avaliador-id="${u.id}" data-avaliador-nome="${(u.nome || u.email || '').toLowerCase()}" data-avaliador-email="${(u.email || '').toLowerCase()}" data-avaliador-dept="${(u.departamento || '').toLowerCase()}" style="pointer-events: auto;">
                                    <input class="form-check-input" type="checkbox" value="${u.id}" id="avaliador_${u.id}" style="pointer-events: auto; cursor: pointer;">
                                    <label class="form-check-label" for="avaliador_${u.id}" style="color: rgba(255, 255, 255, 0.95); cursor: pointer; pointer-events: auto;">
                                        <strong>${u.nome || u.email}</strong>
                                        ${u.email && u.nome ? `<small class="d-block" style="color: rgba(255, 255, 255, 0.7);">${u.email}</small>` : ''}
                                        <small class="d-block" style="color: rgba(255, 255, 255, 0.6);">${u.departamento || 'N/A'} ${u.cargo ? `- ${u.cargo}` : ''}</small>
                                    </label>
                                </div>
                            `).join('') : '<p style="color: rgba(255, 255, 255, 0.7);">Nenhum usuário disponível</p>'}
                        </div>
                        <small style="color: rgba(255, 255, 255, 0.7); margin-top: 0.5rem; display: block;">
                            <i class="fas fa-info-circle me-1"></i> Marque quantos avaliadores desejar. Use a busca para filtrar.
                        </small>
                    </div>
                    <button class="btn btn-primary-modern" onclick="adicionarAvaliadores('${avaliacaoId}')" style="pointer-events: auto;">
                        <i class="fas fa-plus me-2"></i> Adicionar Selecionados
                    </button>
                </div>
            `;
            
            console.log('✅ Lista de avaliadores renderizada com checkboxes');
            console.log('✅ Total de checkboxes criados:', document.querySelectorAll('#listaAvaliadores input[type="checkbox"]').length);
            
            // Garantir que os selects sejam visíveis após renderizar
            setTimeout(() => {
                const tipoSelect = document.getElementById('tipoAvaliadorSelect');
                
                if (tipoSelect) {
                    tipoSelect.style.background = 'linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.1) 100%)';
                    tipoSelect.style.color = '#ffffff';
                    tipoSelect.style.border = '2px solid rgba(255, 255, 255, 0.2)';
                }
                
                // Verificar se os checkboxes foram criados
                const checkboxes = document.querySelectorAll('#listaAvaliadores input[type="checkbox"]');
                console.log('🔍 Checkboxes encontrados após renderização:', checkboxes.length);
                
                if (checkboxes.length === 0) {
                    console.error('❌ Nenhum checkbox foi criado! Verifique se há usuários disponíveis.');
                }
            }, 100);
        }

        function selecionarTodosAvaliadores() {
            const checkboxes = document.querySelectorAll('#listaAvaliadores input[type="checkbox"]');
            const visibleCheckboxes = Array.from(checkboxes).filter(cb => {
                const item = cb.closest('.avaliador-item');
                return item && item.style.display !== 'none';
            });
            
            visibleCheckboxes.forEach(cb => {
                cb.checked = true;
            });
            
            const totalSelecionados = document.querySelectorAll('#listaAvaliadores input[type="checkbox"]:checked').length;
            showNotification(`${totalSelecionados} avaliador(es) selecionado(s)`, 'info');
        }

        function limparSelecaoAvaliadores() {
            const checkboxes = document.querySelectorAll('#listaAvaliadores input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
            showNotification('Seleção limpa', 'info');
        }

        function filtrarAvaliadores() {
            const termo = document.getElementById('buscarAvaliador').value.toLowerCase();
            const itens = document.querySelectorAll('#listaAvaliadores .avaliador-item');
            
            let visiveis = 0;
            itens.forEach(item => {
                const nome = item.getAttribute('data-avaliador-nome') || '';
                const email = item.getAttribute('data-avaliador-email') || '';
                const dept = item.getAttribute('data-avaliador-dept') || '';
                
                if (nome.includes(termo) || email.includes(termo) || dept.includes(termo)) {
                    item.style.display = 'block';
                    visiveis++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Mostrar mensagem se não houver resultados
            const listaContainer = document.getElementById('listaAvaliadores');
            let mensagemVazia = listaContainer.querySelector('.mensagem-vazia-busca');
            if (visiveis === 0 && termo) {
                if (!mensagemVazia) {
                    mensagemVazia = document.createElement('p');
                    mensagemVazia.className = 'mensagem-vazia-busca';
                    mensagemVazia.style.color = 'rgba(255, 255, 255, 0.7)';
                    mensagemVazia.style.textAlign = 'center';
                    mensagemVazia.style.padding = '1rem';
                    listaContainer.appendChild(mensagemVazia);
                }
                mensagemVazia.textContent = `Nenhum avaliador encontrado para "${termo}"`;
            } else if (mensagemVazia) {
                mensagemVazia.remove();
            }
        }

        async function adicionarAutoAvaliacao(avaliacaoId, avaliadoId) {
            const dados = [{
                avaliacao_id: avaliacaoId,
                avaliador_id: avaliadoId,
                tipo_avaliador: 'auto',
                status: 'pendente',
                anonimo: false
            }];
            
            const { data: avaliadoresInseridos, error } = await supabaseClient
                .from('avaliacao_360_avaliadores')
                .upsert(dados, { onConflict: 'avaliacao_id,avaliador_id,tipo_avaliador' })
                .select();
            
            if (error) {
                showNotification('Erro ao adicionar auto-avaliação: ' + error.message, 'error');
                return;
            }
            
            // Criar notificação para auto-avaliação
            if (avaliadoresInseridos && avaliadoresInseridos.length > 0) {
                const { data: avaliacao } = await supabaseClient
                    .from('avaliacao_360_avaliacoes')
                    .select(`
                        ciclo_id,
                        ciclo:avaliacao_360_ciclos (nome)
                    `)
                    .eq('id', avaliacaoId)
                    .single();
                
                if (avaliacao) {
                    await supabaseClient
                        .from('avaliacao_360_notificacoes')
                        .insert([{
                            usuario_id: avaliadoId,
                            tipo: 'nova_avaliacao',
                            titulo: 'Auto-avaliação Disponível',
                            mensagem: `Você pode realizar sua auto-avaliação no ciclo "${avaliacao.ciclo?.nome || 'Avaliação 360º'}"`,
                            ciclo_id: avaliacao.ciclo_id,
                            avaliacao_id: avaliacaoId,
                            avaliador_id: avaliadoresInseridos[0].id,
                            lida: false
                        }]);
                }
            }
            
            await loadAvaliadores(avaliadoId);
            showNotification('Auto-avaliação adicionada com sucesso!', 'success');
        }

        async function adicionarParesAutomatico(avaliacaoId, avaliadoId) {
            const { data: avaliadoData } = await supabaseClient
                .from('user_profiles')
                .select('departamento')
                .eq('id', avaliadoId)
                .single();
            
            const { data: pares } = await supabaseClient
                .from('user_profiles')
                .select('id')
                .eq('departamento', avaliadoData?.departamento)
                .eq('active', true)
                .neq('id', avaliadoId);
            
            if (!pares || pares.length === 0) {
                showNotification('Nenhum par encontrado no mesmo departamento', 'info');
                return;
            }
            
            const dados = pares.map(p => ({
                avaliacao_id: avaliacaoId,
                avaliador_id: p.id,
                tipo_avaliador: 'par',
                status: 'pendente',
                anonimo: true
            }));
            
            const { data: avaliadoresInseridos, error } = await supabaseClient
                .from('avaliacao_360_avaliadores')
                .upsert(dados, { onConflict: 'avaliacao_id,avaliador_id,tipo_avaliador' })
                .select();
            
            if (error) {
                showNotification('Erro ao adicionar pares: ' + error.message, 'error');
                return;
            }
            
            // Criar notificações
            if (avaliadoresInseridos && avaliadoresInseridos.length > 0) {
                const { data: avaliacao } = await supabaseClient
                    .from('avaliacao_360_avaliacoes')
                    .select(`
                        ciclo_id,
                        avaliado_id,
                        ciclo:avaliacao_360_ciclos (nome)
                    `)
                    .eq('id', avaliacaoId)
                    .single();
                
                // Buscar dados do avaliado separadamente
                if (avaliacao && avaliacao.avaliado_id) {
                    const avaliadosMap = await buscarDadosAvaliados([avaliacao.avaliado_id]);
                    avaliacao.avaliado = avaliadosMap.get(avaliacao.avaliado_id) || {
                        nome: 'Usuário não encontrado',
                        email: ''
                    };
                }
                
                if (avaliacao) {
                    const notificacoes = avaliadoresInseridos.map(a => ({
                        usuario_id: a.avaliador_id,
                        tipo: 'nova_avaliacao',
                        titulo: 'Nova Avaliação Disponível',
                        mensagem: `Você foi convidado para avaliar ${avaliacao.avaliado?.nome || avaliacao.avaliado?.email} no ciclo "${avaliacao.ciclo?.nome || 'Avaliação 360º'}"`,
                        ciclo_id: avaliacao.ciclo_id,
                        avaliacao_id: avaliacaoId,
                        avaliador_id: a.id,
                        lida: false
                    }));
                    
                    console.log('📬 Criando notificações (pares):', notificacoes);
                    
                    const { data: notificacoesInseridas, error: errNotificacoes } = await supabaseClient
                        .from('avaliacao_360_notificacoes')
                        .insert(notificacoes)
                        .select();
                    
                    if (errNotificacoes) {
                        console.error('❌ Erro ao criar notificações:', errNotificacoes);
                    } else {
                        console.log('✅ Notificações criadas (pares):', notificacoesInseridas?.length || 0);
                    }
                }
            }
            
            await loadAvaliadores(avaliadoId);
            showNotification(`${pares.length} par(es) adicionado(s) e notificado(s) com sucesso!`, 'success');
        }

        async function adicionarSubordinadosAutomatico(avaliacaoId, avaliadoId) {
            // Buscar subordinados (usuários que têm o avaliado como gestor)
            // Como não temos uma tabela de hierarquia, vamos buscar por departamento e cargo
            const { data: avaliadoData } = await supabaseClient
                .from('user_profiles')
                .select('departamento, cargo')
                .eq('id', avaliadoId)
                .single();
            
            // Buscar usuários do mesmo departamento com cargo inferior (lógica simplificada)
            const { data: todosUsuarios } = await supabaseClient
                .from('user_profiles')
                .select('id, nome, cargo, departamento')
                .eq('departamento', avaliadoData?.departamento)
                .eq('active', true)
                .neq('id', avaliadoId);
            
            // Filtrar subordinados (lógica: cargo diferente ou sem cargo definido)
            const subordinados = todosUsuarios?.filter(u => 
                u.cargo !== avaliadoData?.cargo && 
                (avaliadoData?.cargo?.toLowerCase().includes('gerente') || 
                 avaliadoData?.cargo?.toLowerCase().includes('coordenador') ||
                 avaliadoData?.cargo?.toLowerCase().includes('supervisor'))
            ) || [];
            
            if (subordinados.length === 0) {
                showNotification('Nenhum subordinado encontrado automaticamente. Adicione manualmente.', 'info');
                return;
            }
            
            const dados = subordinados.map(s => ({
                avaliacao_id: avaliacaoId,
                avaliador_id: s.id,
                tipo_avaliador: 'subordinado',
                status: 'pendente',
                anonimo: true
            }));
            
            const { data: avaliadoresInseridos, error } = await supabaseClient
                .from('avaliacao_360_avaliadores')
                .upsert(dados, { onConflict: 'avaliacao_id,avaliador_id,tipo_avaliador' })
                .select();
            
            if (error) {
                showNotification('Erro ao adicionar subordinados: ' + error.message, 'error');
                return;
            }
            
            // Criar notificações
            if (avaliadoresInseridos && avaliadoresInseridos.length > 0) {
                const { data: avaliacao } = await supabaseClient
                    .from('avaliacao_360_avaliacoes')
                    .select(`
                        ciclo_id,
                        avaliado_id,
                        ciclo:avaliacao_360_ciclos (nome)
                    `)
                    .eq('id', avaliacaoId)
                    .single();
                
                // Buscar dados do avaliado separadamente
                if (avaliacao && avaliacao.avaliado_id) {
                    const avaliadosMap = await buscarDadosAvaliados([avaliacao.avaliado_id]);
                    avaliacao.avaliado = avaliadosMap.get(avaliacao.avaliado_id) || {
                        nome: 'Usuário não encontrado',
                        email: ''
                    };
                }
                
                if (avaliacao) {
                    const notificacoes = avaliadoresInseridos.map(a => ({
                        usuario_id: a.avaliador_id,
                        tipo: 'nova_avaliacao',
                        titulo: 'Nova Avaliação Disponível',
                        mensagem: `Você foi convidado para avaliar ${avaliacao.avaliado?.nome || avaliacao.avaliado?.email} no ciclo "${avaliacao.ciclo?.nome || 'Avaliação 360º'}"`,
                        ciclo_id: avaliacao.ciclo_id,
                        avaliacao_id: avaliacaoId,
                        avaliador_id: a.id,
                        lida: false
                    }));
                    
                    await supabaseClient
                        .from('avaliacao_360_notificacoes')
                        .insert(notificacoes);
                }
            }
            
            await loadAvaliadores(avaliadoId);
            showNotification(`${subordinados.length} subordinado(s) adicionado(s) e notificado(s) com sucesso!`, 'success');
        }

        async function adicionarAvaliadores(avaliacaoId) {
            const tipoAvaliador = document.getElementById('tipoAvaliadorSelect').value;
            // Buscar checkboxes marcados
            const checkboxes = document.querySelectorAll('#listaAvaliadores input[type="checkbox"]:checked');
            const avaliadores = Array.from(checkboxes).map(cb => cb.value);
            
            console.log('🔍 Avaliadores selecionados:', avaliadores);
            console.log('🔍 Total de checkboxes marcados:', checkboxes.length);
            console.log('🔍 Tipo de avaliador:', tipoAvaliador);
            
            if (avaliadores.length === 0) {
                showNotification('Selecione pelo menos um avaliador', 'warning');
                return;
            }
            
            if (!tipoAvaliador) {
                showNotification('Selecione o tipo de avaliador', 'warning');
                return;
            }
            
            // Verificar quais avaliadores já existem para evitar duplicação
            const { data: avaliadoresExistentes } = await supabaseClient
                .from('avaliacao_360_avaliadores')
                .select('avaliador_id')
                .eq('avaliacao_id', avaliacaoId)
                .in('avaliador_id', avaliadores);
            
            const idsExistentes = new Set((avaliadoresExistentes || []).map(a => a.avaliador_id));
            const avaliadoresNovos = avaliadores.filter(id => !idsExistentes.has(id));
            
            console.log('📋 Avaliadores já existentes:', Array.from(idsExistentes));
            console.log('📋 Avaliadores novos para inserir:', avaliadoresNovos);
            
            if (avaliadoresNovos.length === 0) {
                showNotification('Todos os avaliadores selecionados já estão adicionados.', 'warning');
                limparSelecaoAvaliadores();
                return;
            }
            
            const dados = avaliadoresNovos.map(avaliadorId => ({
                avaliacao_id: avaliacaoId,
                avaliador_id: avaliadorId,
                tipo_avaliador: tipoAvaliador,
                status: 'pendente',
                anonimo: true
            }));
            
            // Inserir apenas os novos avaliadores
            const { data: avaliadoresInseridos, error } = await supabaseClient
                .from('avaliacao_360_avaliadores')
                .insert(dados)
                .select();
            
            if (error) {
                console.error('Erro ao adicionar avaliadores:', error);
                showNotification('Erro ao adicionar avaliadores: ' + error.message, 'error');
                return;
            }
            
            // Verificar quantos avaliadores foram realmente inseridos
            const totalInseridos = (avaliadoresInseridos || []).length;
            const totalSelecionados = avaliadores.length;
            const duplicados = totalSelecionados - avaliadoresNovos.length;
            
            console.log('📊 Total selecionado:', totalSelecionados);
            console.log('📊 Total inserido:', totalInseridos);
            console.log('📊 Duplicados detectados:', duplicados);
            
            if (duplicados > 0) {
                showNotification(`${duplicados} avaliador(es) já estava(m) adicionado(s). ${totalInseridos} novo(s) avaliador(es) adicionado(s).`, 'warning');
            }
            
            // Criar notificações para os avaliadores adicionados
            if (avaliadoresInseridos && avaliadoresInseridos.length > 0) {
                // Buscar dados da avaliação e ciclo
                const { data: avaliacao } = await supabaseClient
                    .from('avaliacao_360_avaliacoes')
                    .select(`
                        ciclo_id,
                        avaliado_id,
                        ciclo:avaliacao_360_ciclos (
                            nome,
                            status
                        )
                    `)
                    .eq('id', avaliacaoId)
                    .single();
                
                if (avaliacao) {
                    // Buscar dados do avaliado separadamente
                    if (avaliacao.avaliado_id) {
                        const avaliadosMap = await buscarDadosAvaliados([avaliacao.avaliado_id]);
                        avaliacao.avaliado = avaliadosMap.get(avaliacao.avaliado_id) || {
                            nome: 'Usuário não encontrado',
                            email: ''
                        };
                    }
                    
                    const notificacoes = avaliadoresInseridos.map(a => ({
                        usuario_id: a.avaliador_id,
                        tipo: 'nova_avaliacao',
                        titulo: 'Nova Avaliação Disponível',
                        mensagem: `Você foi convidado para avaliar ${avaliacao.avaliado?.nome || avaliacao.avaliado?.email || 'o usuário'} no ciclo "${avaliacao.ciclo?.nome || 'Avaliação 360º'}"`,
                        ciclo_id: avaliacao.ciclo_id,
                        avaliacao_id: avaliacaoId,
                        avaliador_id: a.id,
                        lida: false
                    }));
                    
                    console.log('📬 Criando notificações:', notificacoes);
                    
                    const { data: notificacoesInseridas, error: errNotificacoes } = await supabaseClient
                        .from('avaliacao_360_notificacoes')
                        .insert(notificacoes)
                        .select();
                    
                    if (errNotificacoes) {
                        console.error('❌ Erro ao criar notificações:', errNotificacoes);
                        showNotification('Avaliadores adicionados, mas houve erro ao criar notificações: ' + errNotificacoes.message, 'warning');
                    } else {
                        console.log('✅ Notificações criadas com sucesso:', notificacoesInseridas?.length || 0);
                    }
                }
            }
            
            const avaliadoId = document.getElementById('avaliadoSelect').value;
            await loadAvaliadores(avaliadoId);
            
            // Mostrar mensagem de sucesso apenas se não houve aviso anterior
            if (duplicados === 0) {
                showNotification(`${totalInseridos} avaliador(es) adicionado(s) e notificado(s) com sucesso!`, 'success');
            }
            
            // Limpar seleção após adicionar
            limparSelecaoAvaliadores();
            const buscarInput = document.getElementById('buscarAvaliador');
            if (buscarInput) {
                buscarInput.value = '';
                filtrarAvaliadores();
            }
        }

        async function removerAvaliador(avaliadorId) {
            if (!confirm('Deseja realmente remover este avaliador?')) return;
            
            // Buscar o avaliadoId antes de remover (para poder recarregar depois)
            const { data: avaliadorData } = await supabaseClient
                .from('avaliacao_360_avaliadores')
                .select('avaliacao_id')
                .eq('id', avaliadorId)
                .single();
            
            const { error } = await supabaseClient
                .from('avaliacao_360_avaliadores')
                .delete()
                .eq('id', avaliadorId);
            
            if (error) {
                tratarErro(error, 'Erro ao remover avaliador');
                return;
            }
            
            // Tentar obter avaliadoId do select primeiro
            let avaliadoId = document.getElementById('avaliadoSelect')?.value;
            
            // Se não houver no select, buscar da avaliação
            if ((!avaliadoId || avaliadoId.trim() === '') && avaliadorData) {
                const { data: avaliacao } = await supabaseClient
                    .from('avaliacao_360_avaliacoes')
                    .select('avaliado_id')
                    .eq('id', avaliadorData.avaliacao_id)
                    .single();
                
                if (avaliacao && avaliacao.avaliado_id) {
                    avaliadoId = avaliacao.avaliado_id;
                }
            }
            
            // Recarregar apenas se tiver avaliadoId válido
            if (avaliadoId && avaliadoId.trim() !== '') {
                await loadAvaliadores(avaliadoId);
            }
            
            showNotification('Avaliador removido com sucesso!', 'success');
        }

        async function salvarAvaliadores() {
            bootstrap.Modal.getInstance(document.getElementById('modalAvaliadores')).hide();
        }

        // ========== MINHAS AVALIAÇÕES ==========
        async function loadMinhasAvaliacoes() {
            // Avaliações onde sou avaliado
            const { data: avaliacoesComoAvaliado, error: err1 } = await supabaseClient
                .from('avaliacao_360_avaliacoes')
                .select(`
                    *,
                    ciclo:avaliacao_360_ciclos (
                        nome,
                        data_inicio,
                        data_fim,
                        data_limite_respostas
                    )
                `)
                .eq('avaliado_id', currentUserId)
                .order('criado_em', { ascending: false });
            
            // Enriquecer com dados do avaliado (que é o próprio usuário)
            if (avaliacoesComoAvaliado && !err1 && currentUserProfile) {
                avaliacoesComoAvaliado.forEach(av => {
                    av.avaliado = {
                        nome: currentUserProfile.nome,
                        email: currentUserProfile.email,
                        departamento: currentUserProfile.departamento,
                        cargo: currentUserProfile.cargo
                    };
                });
            }
            
            // Avaliações onde sou avaliador
            const { data: avaliadores, error: err2 } = await supabaseClient
                .from('avaliacao_360_avaliadores')
                .select('*')
                .eq('avaliador_id', currentUserId)
                .order('convidado_em', { ascending: false });
            
            console.log('🔍 Avaliadores encontrados:', avaliadores?.length || 0);
            console.log('🔍 Erro ao buscar avaliadores:', err2);
            
            // Buscar dados das avaliações separadamente
            if (avaliadores && !err2 && avaliadores.length > 0) {
                const avaliacaoIds = [...new Set(avaliadores.map(a => a.avaliacao_id).filter(Boolean))];
                
                if (avaliacaoIds.length > 0) {
                    // Buscar avaliações
                    const { data: avaliacoesData } = await supabaseClient
                        .from('avaliacao_360_avaliacoes')
                        .select('*')
                        .in('id', avaliacaoIds);
                    
                    // Buscar ciclos
                    const cicloIds = [...new Set((avaliacoesData || []).map(a => a.ciclo_id).filter(Boolean))];
                    const { data: ciclosData } = await supabaseClient
                        .from('avaliacao_360_ciclos')
                        .select('*')
                        .in('id', cicloIds);
                    
                    // Criar mapas para facilitar acesso
                    const avaliacoesMap = new Map((avaliacoesData || []).map(a => [a.id, a]));
                    const ciclosMap = new Map((ciclosData || []).map(c => [c.id, c]));
                    
                    // Buscar dados dos avaliados
                    const avaliadoIds = [...new Set((avaliacoesData || []).map(a => a.avaliado_id).filter(Boolean))];
                    const avaliadosMap = avaliadoIds.length > 0 ? await buscarDadosAvaliados(avaliadoIds) : new Map();
                    
                    // Enriquecer avaliadores com dados das avaliações e ciclos
                    avaliadores.forEach(avaliador => {
                        const avaliacao = avaliacoesMap.get(avaliador.avaliacao_id);
                        if (avaliacao) {
                            avaliador.avaliacao = avaliacao;
                            avaliador.avaliacao.ciclo = ciclosMap.get(avaliacao.ciclo_id);
                            avaliador.avaliacao.avaliado = avaliadosMap.get(avaliacao.avaliado_id) || {
                                nome: 'Usuário não encontrado',
                                email: '',
                                departamento: null,
                                cargo: null
                            };
                        }
                    });
                }
            }
            
            const container = document.getElementById('minhasAvaliacoesList');
            
            let html = '<div class="row">';
            
            // Seção: Avaliações onde sou avaliado
            html += `
                <div class="col-md-6 mb-4">
                    <div class="card-modern">
                        <h5 class="mb-3"><i class="fas fa-user me-2"></i> Avaliações sobre Mim</h5>
                        ${avaliacoesComoAvaliado && avaliacoesComoAvaliado.length > 0 ? 
                            avaliacoesComoAvaliado.map(a => `
                                <div class="border rounded p-3 mb-2">
                                    <strong>${a.ciclo?.nome}</strong>
                                    <p class="text-muted mb-1">Status: ${a.status}</p>
                                    <button class="btn btn-sm btn-primary-modern" onclick="verResultados('${a.id}')">
                                        Ver Resultados
                                    </button>
                                </div>
                            `).join('') : 
                            '<p class="text-muted">Nenhuma avaliação encontrada</p>'
                        }
                    </div>
                </div>
            `;
            
            // Seção: Avaliações que preciso responder
            html += `
                <div class="col-md-6 mb-4">
                    <div class="card-modern">
                        <h5 class="mb-3"><i class="fas fa-edit me-2"></i> Avaliações Pendentes</h5>
                        ${avaliadores && avaliadores.length > 0 ? 
                            (() => {
                                const pendentes = avaliadores.filter(a => a.status === 'pendente' || a.status === 'em_andamento');
                                console.log('📋 Total de avaliadores:', avaliadores.length);
                                console.log('📋 Avaliadores pendentes:', pendentes.length);
                                console.log('📋 Status dos avaliadores:', avaliadores.map(a => ({ id: a.id, status: a.status, avaliacao_id: a.avaliacao_id })));
                                
                                if (pendentes.length === 0) {
                                    return '<p class="text-muted">Nenhuma avaliação pendente. Todas as avaliações foram concluídas.</p>';
                                }
                                
                                return pendentes.map(a => {
                                const tipoLabel = {
                                    'auto': 'Auto-avaliação',
                                    'gestor': 'Avaliação do Gestor',
                                    'par': 'Avaliação de Par',
                                    'subordinado': 'Avaliação de Subordinado'
                                }[a.tipo_avaliador] || a.tipo_avaliador;
                                
                                const avaliado = a.avaliacao?.avaliado || {};
                                return `
                                <div class="border rounded p-3 mb-2" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.04) 100%); border-color: rgba(255, 255, 255, 0.1) !important;">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="flex-grow-1">
                                            <strong style="color: rgba(255, 255, 255, 0.95);">${a.avaliacao?.ciclo?.nome}</strong>
                                        </div>
                                        <span class="badge" style="background: ${a.status === 'pendente' ? 'rgba(255, 193, 7, 0.2)' : 'rgba(102, 126, 234, 0.2)'}; color: ${a.status === 'pendente' ? '#ffc107' : '#667eea'};">
                                            ${a.status === 'pendente' ? 'Pendente' : 'Em Andamento'}
                                        </span>
                                    </div>
                                    <div class="mb-2" style="padding: 0.75rem; background: rgba(102, 126, 234, 0.1); border-radius: 8px; border-left: 3px solid var(--primary);">
                                        <div style="color: rgba(255, 255, 255, 0.95); font-weight: 600; font-size: 1.1rem; margin-bottom: 0.25rem;">
                                            <i class="fas fa-user me-2"></i>${avaliado.nome || avaliado.email || 'Usuário'}
                                        </div>
                                        ${avaliado.cargo ? `<div style="color: rgba(255, 255, 255, 0.8); font-size: 0.9rem;"><i class="fas fa-briefcase me-2"></i>${avaliado.cargo}</div>` : ''}
                                        ${avaliado.departamento ? `<div style="color: rgba(255, 255, 255, 0.8); font-size: 0.9rem;"><i class="fas fa-building me-2"></i>${avaliado.departamento}</div>` : ''}
                                    </div>
                                    <p style="color: rgba(255, 255, 255, 0.7); font-size: 0.85rem; margin-bottom: 0.5rem;">
                                        <i class="fas fa-tag me-2"></i><strong>Tipo:</strong> ${tipoLabel}
                                    </p>
                                    ${a.avaliacao_id && a.id ? `
                                    <button class="btn btn-sm btn-primary-modern w-100" onclick="responderAvaliacao('${a.avaliacao_id}', '${a.id}')" style="pointer-events: auto;">
                                        <i class="fas fa-edit me-2"></i> Responder Avaliação
                                    </button>
                                    ` : `
                                    <button class="btn btn-sm btn-secondary w-100" disabled title="Dados incompletos - entre em contato com o RH">
                                        <i class="fas fa-exclamation-triangle me-2"></i> Dados Incompletos
                                    </button>
                                    `}
                                </div>
                            `;
                                }).join('');
                            })() : 
                            '<p class="text-muted" style="padding: 2rem; text-align: center;"><i class="fas fa-info-circle me-2"></i>Nenhuma avaliação pendente. Você não foi designado como avaliador em nenhum ciclo ativo.</p>'
                        }
                    </div>
                </div>
            `;
            
            html += '</div>';
            container.innerHTML = html;
            
            // Adicionar event listeners para os botões de excluir
            container.querySelectorAll('.btn-excluir-ciclo').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    const cicloId = this.dataset.cicloId;
                    const cicloNome = this.dataset.cicloNome || 'este ciclo';
                    confirmarExcluirCiclo(cicloId, cicloNome);
                });
            });
        }

        // ========== RESPONDER AVALIAÇÃO ==========
        async function responderAvaliacao(avaliacaoId, avaliadorId) {
            // Validar parâmetros
            if (!avaliacaoId || avaliacaoId.trim() === '') {
                console.error('❌ avaliacaoId não fornecido ou vazio');
                showNotification('Erro: ID da avaliação não fornecido', 'error');
                return;
            }
            
            if (!avaliadorId || avaliadorId.trim() === '') {
                console.error('❌ avaliadorId não fornecido ou vazio');
                showNotification('Erro: ID do avaliador não fornecido', 'error');
                return;
            }
            
            console.log('📝 Respondendo avaliação:', { avaliacaoId, avaliadorId });
            
            avaliacaoAtualId = avaliacaoId;
            avaliadorAtualId = avaliadorId;
            
            // Ativar tab de responder
            document.getElementById('avaliar-tab-item').style.display = 'block';
            document.getElementById('avaliar-tab').click();
            
            // Carregar dados da avaliação (sem relacionamento direto para evitar erros)
            const { data: avaliacao, error: err1 } = await supabaseClient
                .from('avaliacao_360_avaliacoes')
                .select('*')
                .eq('id', avaliacaoId)
                .single();
            
            if (err1) {
                console.error('❌ Erro ao buscar avaliação:', err1);
                tratarErro(err1, 'Erro ao carregar avaliação');
                return;
            }
            
            // Buscar dados do ciclo separadamente
            if (avaliacao && avaliacao.ciclo_id) {
                const { data: cicloData } = await supabaseClient
                    .from('avaliacao_360_ciclos')
                    .select('nome, descricao')
                    .eq('id', avaliacao.ciclo_id)
                    .single();
                
                avaliacao.ciclo = cicloData || { nome: 'Ciclo não encontrado', descricao: '' };
            }
            
            if (!avaliacao) {
                console.error('❌ Avaliação não encontrada');
                showNotification('Erro: Avaliação não encontrada', 'error');
                return;
            }
            
            console.log('✅ Avaliação carregada:', avaliacao);
            
            // Buscar dados do avaliado separadamente
            if (avaliacao.avaliado_id) {
                const avaliadosMap = await buscarDadosAvaliados([avaliacao.avaliado_id]);
                avaliacao.avaliado = avaliadosMap.get(avaliacao.avaliado_id) || {
                    nome: 'Usuário não encontrado',
                    email: ''
                };
            }
            
            // Carregar competências
            const { data: competencias, error: err2 } = await supabaseClient
                .from('avaliacao_360_competencias')
                .select('*')
                .eq('ciclo_id', avaliacao.ciclo_id)
                .order('ordem', { ascending: true });
            
            console.log('📋 Competências encontradas:', competencias?.length || 0);
            console.log('📋 Erro ao buscar competências:', err2);
            
            if (err2) {
                console.error('❌ Erro ao carregar competências:', err2);
                tratarErro(err2, 'Erro ao carregar competências');
                return;
            }
            
            if (!competencias || competencias.length === 0) {
                const container = document.getElementById('avaliarContent');
                container.innerHTML = `
                    <div class="card-modern">
                        <div class="alert alert-warning" style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.2) 0%, rgba(255, 193, 7, 0.1) 100%); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 12px; padding: 2rem; text-align: center;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; color: #ffc107; margin-bottom: 1rem;"></i>
                            <h4 style="color: rgba(255, 255, 255, 0.95); margin-bottom: 1rem;">Nenhuma Competência Cadastrada</h4>
                            <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 1.5rem;">
                                Este ciclo de avaliação ainda não possui competências cadastradas.<br>
                                Entre em contato com o RH para adicionar as competências que serão avaliadas.
                            </p>
                            <button class="btn btn-primary-modern" onclick="document.getElementById('minhas-avaliacoes-tab').click()">
                                <i class="fas fa-arrow-left me-2"></i> Voltar para Minhas Avaliações
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Carregar respostas existentes
            const { data: respostas, error: err3 } = await supabaseClient
                .from('avaliacao_360_respostas')
                .select('*')
                .eq('avaliacao_id', avaliacaoId)
                .eq('avaliador_id', avaliadorId);
            
            const respostasMap = {};
            if (respostas) {
                respostas.forEach(r => {
                    respostasMap[r.competencia_id] = r;
                });
            }
            
            // Buscar dados do avaliador para identificar tipo de avaliação
            const { data: avaliadorData } = await supabaseClient
                .from('avaliacao_360_avaliadores')
                .select('tipo_avaliador')
                .eq('id', avaliadorId)
                .single();
            
            const tipoAvaliador = avaliadorData?.tipo_avaliador || 'par';
            const tipoLabel = {
                'auto': 'Auto-avaliação',
                'gestor': 'Avaliação do Gestor',
                'par': 'Avaliação de Par (Colega)',
                'subordinado': 'Avaliação de Subordinado'
            }[tipoAvaliador] || 'Avaliação';
            
            // Renderizar formulário
            const container = document.getElementById('avaliarContent');
            container.innerHTML = `
                <div class="card-modern">
                    <div class="mb-4" style="padding: 1.5rem; background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(102, 126, 234, 0.05) 100%); border-radius: 12px; border-left: 4px solid var(--primary);">
                        <h3 class="mb-2" style="color: rgba(255, 255, 255, 0.95);">
                            <i class="fas fa-clipboard-list me-2"></i>${avaliacao.ciclo?.nome}
                        </h3>
                        <p style="color: rgba(255, 255, 255, 0.8); margin-bottom: 1rem;">
                            <i class="fas fa-tag me-2"></i><strong>Tipo de Avaliação:</strong> ${tipoLabel}
                        </p>
                        <div style="padding: 1rem; background: rgba(255, 255, 255, 0.05); border-radius: 8px;">
                            <div style="color: rgba(255, 255, 255, 0.95); font-size: 1.1rem; font-weight: 600; margin-bottom: 0.5rem;">
                                <i class="fas fa-user me-2"></i>Você está avaliando:
                            </div>
                            <div style="color: rgba(255, 255, 255, 0.95); font-size: 1.3rem; font-weight: 700; margin-bottom: 0.25rem;">
                                ${avaliacao.avaliado?.nome || avaliacao.avaliado?.email || 'Usuário'}
                            </div>
                            ${avaliacao.avaliado?.cargo ? `<div style="color: rgba(255, 255, 255, 0.85); font-size: 1rem; margin-bottom: 0.25rem;"><i class="fas fa-briefcase me-2"></i>${avaliacao.avaliado.cargo}</div>` : ''}
                            ${avaliacao.avaliado?.departamento ? `<div style="color: rgba(255, 255, 255, 0.85); font-size: 1rem;"><i class="fas fa-building me-2"></i>${avaliacao.avaliado.departamento}</div>` : ''}
                        </div>
                    </div>
                    
                    <form id="formAvaliacao">
                        ${competencias.map((c, index) => {
                            const resposta = respostasMap[c.id];
                            return `
                                <div class="competencia-item">
                                    <h6>${c.categoria} - ${c.competencia}</h6>
                                    ${c.descricao ? `<p class="text-muted">${c.descricao}</p>` : ''}
                                    
                                    ${c.tipo_avaliacao === 'numerica' ? `
                                        <div class="mb-3">
                                            <label class="form-label">Nota (${c.escala_min} a ${c.escala_max})</label>
                                            <input type="number" 
                                                   class="form-control" 
                                                   id="resposta_${c.id}" 
                                                   min="${c.escala_min}" 
                                                   max="${c.escala_max}" 
                                                   value="${resposta?.valor_numerico || ''}"
                                                   ${c.obrigatoria ? 'required' : ''}>
                                        </div>
                                    ` : ''}
                                    
                                    ${c.tipo_avaliacao === 'texto' ? `
                                        <div class="mb-3">
                                            <label class="form-label">Comentário</label>
                                            <textarea class="form-control" 
                                                      id="resposta_${c.id}" 
                                                      rows="3"
                                                      ${c.obrigatoria ? 'required' : ''}>${resposta?.valor_texto || ''}</textarea>
                                        </div>
                                    ` : ''}
                                    
                                    ${c.tipo_avaliacao === 'escala_likert' ? `
                                        <div class="mb-3">
                                            <label class="form-label">Escala Likert</label>
                                            <select class="form-select" id="resposta_${c.id}" ${c.obrigatoria ? 'required' : ''}>
                                                <option value="">Selecione...</option>
                                                <option value="discordo_totalmente" ${resposta?.valor_texto === 'discordo_totalmente' ? 'selected' : ''}>Discordo Totalmente</option>
                                                <option value="discordo" ${resposta?.valor_texto === 'discordo' ? 'selected' : ''}>Discordo</option>
                                                <option value="neutro" ${resposta?.valor_texto === 'neutro' ? 'selected' : ''}>Neutro</option>
                                                <option value="concordo" ${resposta?.valor_texto === 'concordo' ? 'selected' : ''}>Concordo</option>
                                                <option value="concordo_totalmente" ${resposta?.valor_texto === 'concordo_totalmente' ? 'selected' : ''}>Concordo Totalmente</option>
                                            </select>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        }).join('')}
                        
                        <div class="mt-4">
                            <button type="button" class="btn btn-primary-modern" onclick="salvarRespostas()">
                                <i class="fas fa-save me-2"></i> Salvar Respostas
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        async function salvarRespostas() {
            // Carregar competências novamente
            const { data: avaliacao } = await supabaseClient
                .from('avaliacao_360_avaliacoes')
                .select('ciclo_id')
                .eq('id', avaliacaoAtualId)
                .single();
            
            const { data: competencias } = await supabaseClient
                .from('avaliacao_360_competencias')
                .select('*')
                .eq('ciclo_id', avaliacao.ciclo_id);
            
            // Coletar respostas
            const respostas = [];
            for (const competencia of competencias) {
                const input = document.getElementById(`resposta_${competencia.id}`);
                if (!input) continue;
                
                const valor = input.value;
                if (!valor && competencia.obrigatoria) {
                    showNotification(`A competência "${competencia.competencia}" é obrigatória`, 'warning');
                    return;
                }
                
                if (valor) {
                    respostas.push({
                        avaliacao_id: avaliacaoAtualId,
                        avaliador_id: avaliadorAtualId,
                        competencia_id: competencia.id,
                        valor_numerico: competencia.tipo_avaliacao === 'numerica' ? parseFloat(valor) : null,
                        valor_texto: competencia.tipo_avaliacao !== 'numerica' ? valor : null
                    });
                }
            }
            
            // Salvar respostas (upsert)
            for (const resposta of respostas) {
                const { error } = await supabaseClient
                    .from('avaliacao_360_respostas')
                    .upsert(resposta, { onConflict: 'avaliacao_id,avaliador_id,competencia_id' });
                
                if (error) {
                    console.error('Erro ao salvar resposta:', error);
                }
            }
            
            // Atualizar status do avaliador
            await supabaseClient
                .from('avaliacao_360_avaliadores')
                .update({ 
                    status: 'concluida',
                    respondido_em: new Date().toISOString()
                })
                .eq('id', avaliadorAtualId);
            
            // Atualizar status da avaliação
            await supabaseClient
                .from('avaliacao_360_avaliacoes')
                .update({ 
                    status: 'concluida',
                    data_conclusao: new Date().toISOString()
                })
                .eq('id', avaliacaoAtualId);
            
            showNotification('Avaliação salva com sucesso!', 'success');
            await loadMinhasAvaliacoes();
            await registrarHistorico('avaliacao_concluida', `Avaliação ${avaliacaoAtualId} concluída`, avaliacaoAtualId);
        }

        // ========== RESULTADOS ==========
        async function verResultados(avaliacaoId) {
            document.getElementById('resultados-tab-item').style.display = 'block';
            document.getElementById('resultados-tab').click();
            
            // Carregar dados da avaliação
            const { data: avaliacao, error } = await supabaseClient
                .from('avaliacao_360_avaliacoes')
                .select(`
                    *,
                    ciclo:avaliacao_360_ciclos (
                        nome
                    )
                `)
                .eq('id', avaliacaoId)
                .single();
            
            if (error || !avaliacao) {
                showNotification('Erro ao carregar resultados', 'error');
                return;
            }
            
            // Buscar dados do avaliado separadamente
            if (avaliacao.avaliado_id) {
                const avaliadosMap = await buscarDadosAvaliados([avaliacao.avaliado_id]);
                avaliacao.avaliado = avaliadosMap.get(avaliacao.avaliado_id) || {
                    nome: 'Usuário não encontrado',
                    email: ''
                };
            }
            
            // Carregar todas as respostas
            const { data: respostas, error: err2 } = await supabaseClient
                .from('avaliacao_360_respostas')
                .select(`
                    *,
                    competencia:avaliacao_360_competencias (
                        categoria,
                        competencia,
                        tipo_avaliacao,
                        peso
                    ),
                    avaliador:avaliacao_360_avaliadores (
                        tipo_avaliador,
                        anonimo
                    )
                `)
                .eq('avaliacao_id', avaliacaoId);
            
            // Agrupar por competência e tipo de avaliador
            const resultados = {};
            respostas.forEach(r => {
                const key = `${r.competencia.id}_${r.avaliador.tipo_avaliador}`;
                if (!resultados[key]) {
                    resultados[key] = {
                        competencia: r.competencia,
                        tipo_avaliador: r.avaliador.tipo_avaliador,
                        valores: []
                    };
                }
                if (r.valor_numerico) {
                    resultados[key].valores.push(r.valor_numerico);
                }
            });
            
            // Agrupar por competência (todas as avaliações juntas)
            const resultadosPorCompetencia = {};
            respostas.forEach(r => {
                if (!resultadosPorCompetencia[r.competencia.id]) {
                    resultadosPorCompetencia[r.competencia.id] = {
                        competencia: r.competencia,
                        valores: [],
                        porTipo: {}
                    };
                }
                if (r.valor_numerico) {
                    resultadosPorCompetencia[r.competencia.id].valores.push(r.valor_numerico);
                    const tipo = r.avaliador.tipo_avaliador;
                    if (!resultadosPorCompetencia[r.competencia.id].porTipo[tipo]) {
                        resultadosPorCompetencia[r.competencia.id].porTipo[tipo] = [];
                    }
                    resultadosPorCompetencia[r.competencia.id].porTipo[tipo].push(r.valor_numerico);
                }
            });
            
            const container = document.getElementById('resultadosContent');
            container.innerHTML = `
                <div class="card-modern">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h3 class="mb-2">Resultados - ${avaliacao.ciclo?.nome}</h3>
                            <p class="text-muted mb-0">Avaliado: <strong>${avaliacao.avaliado?.nome || avaliacao.avaliado?.email}</strong></p>
                        </div>
                        <button class="btn btn-primary-modern" onclick="exportarResultados('${avaliacaoId}')">
                            <i class="fas fa-download me-2"></i> Exportar PDF
                        </button>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card-modern">
                                <h5 class="mb-3">Médias por Competência</h5>
                                <canvas id="chartResultadosCompetencias" height="80"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card-modern">
                                <h5 class="mb-3">Médias por Tipo de Avaliador</h5>
                                <canvas id="chartResultadosPorTipo" height="80"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <h5 class="mb-3">Detalhamento por Competência</h5>
                    ${Object.values(resultadosPorCompetencia).map((r, idx) => {
                        const mediaGeral = r.valores.length > 0 
                            ? (r.valores.reduce((a, b) => a + b, 0) / r.valores.length).toFixed(2)
                            : 'N/A';
                        
                        const mediasPorTipo = Object.entries(r.porTipo).map(([tipo, valores]) => {
                            const media = valores.length > 0 
                                ? (valores.reduce((a, b) => a + b, 0) / valores.length).toFixed(2)
                                : 'N/A';
                            return { tipo, media, count: valores.length };
                        });
                        
                        return `
                            <div class="competencia-item mb-3">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1">
                                        <h6>${r.competencia.categoria} - ${r.competencia.competencia}</h6>
                                        <p class="text-muted mb-2">${r.competencia.descricao || ''}</p>
                                        <div class="mb-2">
                                            <strong>Média Geral: ${mediaGeral}</strong>
                                            <span class="text-muted ms-2">(${r.valores.length} avaliações)</span>
                                        </div>
                                        <div>
                                            ${mediasPorTipo.map(m => `
                                                <span class="badge bg-info me-2">
                                                    ${m.tipo}: ${m.media} (${m.count})
                                                </span>
                                            `).join('')}
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            // Criar gráficos
            setTimeout(() => {
                criarGraficosResultados(resultadosPorCompetencia, respostas);
            }, 100);
        }

        function criarGraficosResultados(resultadosPorCompetencia, respostas) {
            // Gráfico de Médias por Competência
            const ctxCompetencias = document.getElementById('chartResultadosCompetencias');
            if (ctxCompetencias) {
                const labels = Object.values(resultadosPorCompetencia).map(r => r.competencia.competencia);
                const medias = Object.values(resultadosPorCompetencia).map(r => {
                    if (r.valores.length === 0) return 0;
                    return parseFloat((r.valores.reduce((a, b) => a + b, 0) / r.valores.length).toFixed(2));
                });
                
                new Chart(ctxCompetencias, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Média',
                            data: medias,
                            backgroundColor: 'rgba(102, 126, 234, 0.8)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 5,
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.6)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.6)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        }
                    }
                });
            }
            
            // Gráfico por Tipo de Avaliador
            const ctxPorTipo = document.getElementById('chartResultadosPorTipo');
            if (ctxPorTipo) {
                const tipos = ['auto', 'gestor', 'par', 'subordinado'];
                const mediasPorTipo = tipos.map(tipo => {
                    const valores = respostas
                        .filter(r => r.avaliador?.tipo_avaliador === tipo && r.valor_numerico)
                        .map(r => r.valor_numerico);
                    return valores.length > 0 
                        ? parseFloat((valores.reduce((a, b) => a + b, 0) / valores.length).toFixed(2))
                        : 0;
                });
                
                new Chart(ctxPorTipo, {
                    type: 'radar',
                    data: {
                        labels: ['Auto-avaliação', 'Gestor', 'Par', 'Subordinado'],
                        datasets: [{
                            label: 'Média',
                            data: mediasPorTipo,
                            backgroundColor: 'rgba(102, 126, 234, 0.2)',
                            borderColor: 'rgba(102, 126, 234, 1)',
                            borderWidth: 2,
                            pointBackgroundColor: 'rgba(102, 126, 234, 1)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'rgba(102, 126, 234, 1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                beginAtZero: true,
                                max: 5,
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.6)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                },
                                pointLabels: {
                                    color: 'rgba(255, 255, 255, 0.8)'
                                }
                            }
                        },
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.8)'
                                }
                            }
                        }
                    }
                });
            }
        }

        async function exportarResultados(avaliacaoId) {
            try {
                // Carregar dados da avaliação
                const { data: avaliacao, error } = await supabaseClient
                    .from('avaliacao_360_avaliacoes')
                    .select(`
                        *,
                        ciclo:avaliacao_360_ciclos (
                            nome,
                            descricao,
                            data_inicio,
                            data_fim
                        )
                    `)
                    .eq('id', avaliacaoId)
                    .single();
                
                if (error || !avaliacao) {
                    tratarErro(null, 'Erro ao carregar dados para exportação');
                    return;
                }
                
                // Buscar dados do avaliado separadamente
                if (avaliacao.avaliado_id) {
                    const avaliadosMap = await buscarDadosAvaliados([avaliacao.avaliado_id]);
                    avaliacao.avaliado = avaliadosMap.get(avaliacao.avaliado_id) || {
                        nome: 'Usuário não encontrado',
                        email: '',
                        departamento: null,
                        cargo: null
                    };
                }
                
                // Carregar respostas
                const { data: respostas, error: err2 } = await supabaseClient
                    .from('avaliacao_360_respostas')
                    .select(`
                        *,
                        competencia:avaliacao_360_competencias (
                            categoria,
                            competencia,
                            descricao,
                            tipo_avaliacao,
                            peso
                        ),
                        avaliador:avaliacao_360_avaliadores (
                            tipo_avaliador,
                            anonimo
                        )
                    `)
                    .eq('avaliacao_id', avaliacaoId);
                
                // Agrupar resultados
                const resultadosPorCompetencia = {};
                respostas.forEach(r => {
                    if (!resultadosPorCompetencia[r.competencia.id]) {
                        resultadosPorCompetencia[r.competencia.id] = {
                            competencia: r.competencia,
                            valores: [],
                            porTipo: {}
                        };
                    }
                    if (r.valor_numerico) {
                        resultadosPorCompetencia[r.competencia.id].valores.push(r.valor_numerico);
                        const tipo = r.avaliador.tipo_avaliador;
                        if (!resultadosPorCompetencia[r.competencia.id].porTipo[tipo]) {
                            resultadosPorCompetencia[r.competencia.id].porTipo[tipo] = [];
                        }
                        resultadosPorCompetencia[r.competencia.id].porTipo[tipo].push(r.valor_numerico);
                    }
                });
                
                // Criar PDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Cabeçalho
                doc.setFontSize(20);
                doc.text('Relatório de Avaliação 360º', 105, 20, { align: 'center' });
                
                doc.setFontSize(12);
                doc.text(`Ciclo: ${avaliacao.ciclo?.nome}`, 20, 35);
                doc.text(`Avaliado: ${avaliacao.avaliado?.nome || avaliacao.avaliado?.email}`, 20, 42);
                doc.text(`Departamento: ${avaliacao.avaliado?.departamento || 'N/A'}`, 20, 49);
                doc.text(`Cargo: ${avaliacao.avaliado?.cargo || 'N/A'}`, 20, 56);
                doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 63);
                
                let yPos = 75;
                
                // Tabela de resultados
                const tableData = [];
                Object.values(resultadosPorCompetencia).forEach(r => {
                    const mediaGeral = r.valores.length > 0 
                        ? (r.valores.reduce((a, b) => a + b, 0) / r.valores.length).toFixed(2)
                        : 'N/A';
                    
                    tableData.push([
                        r.competencia.categoria,
                        r.competencia.competencia,
                        mediaGeral,
                        r.valores.length.toString()
                    ]);
                });
                
                doc.autoTable({
                    startY: yPos,
                    head: [['Categoria', 'Competência', 'Média', 'Qtd. Avaliações']],
                    body: tableData,
                    theme: 'striped',
                    headStyles: { fillColor: [102, 126, 234] },
                    styles: { fontSize: 9 }
                });
                
                yPos = doc.lastAutoTable.finalY + 15;
                
                // Detalhamento por tipo
                doc.setFontSize(14);
                doc.text('Médias por Tipo de Avaliador', 20, yPos);
                yPos += 10;
                
                const tiposData = [];
                const tipos = ['auto', 'gestor', 'par', 'subordinado'];
                tipos.forEach(tipo => {
                    const valores = respostas
                        .filter(r => r.avaliador?.tipo_avaliador === tipo && r.valor_numerico)
                        .map(r => r.valor_numerico);
                    const media = valores.length > 0 
                        ? (valores.reduce((a, b) => a + b, 0) / valores.length).toFixed(2)
                        : '0.00';
                    tiposData.push([tipo.charAt(0).toUpperCase() + tipo.slice(1), media, valores.length.toString()]);
                });
                
                doc.autoTable({
                    startY: yPos,
                    head: [['Tipo de Avaliador', 'Média', 'Qtd.']],
                    body: tiposData,
                    theme: 'striped',
                    headStyles: { fillColor: [102, 126, 234] },
                    styles: { fontSize: 9 }
                });
                
                // Salvar PDF
                const fileName = `Avaliacao_360_${avaliacao.ciclo?.nome.replace(/\s/g, '_')}_${avaliacao.avaliado?.nome?.replace(/\s/g, '_') || 'Avaliado'}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
                
                showNotification('PDF exportado com sucesso!', 'success');
            } catch (error) {
                tratarErro(error, 'Erro ao exportar PDF');
            }
        }

        // ========== DASHBOARD ==========
        let charts = {};

        async function loadDashboard() {
            try {
                console.log('📊 Carregando dashboard...');
                
                // Carregar estatísticas
                const { data: ciclos, error: err1 } = await supabaseClient
                    .from('avaliacao_360_ciclos')
                    .select('*');
                
                if (err1) {
                    console.error('❌ Erro ao carregar ciclos:', err1);
                }
                
                const { data: avaliacoes, error: err2 } = await supabaseClient
                    .from('avaliacao_360_avaliacoes')
                    .select('*');
                
                if (err2) {
                    console.error('❌ Erro ao carregar avaliações:', err2);
                }
                
                const { data: avaliadores, error: err3 } = await supabaseClient
                    .from('avaliacao_360_avaliadores')
                    .select('*')
                    .eq('avaliador_id', currentUserId);
                
                if (err3) {
                    console.error('❌ Erro ao carregar avaliadores:', err3);
                }
                
                // Atualizar estatísticas
                const totalCiclos = ciclos?.length || 0;
                const ciclosAtivos = ciclos?.filter(c => c.status === 'aberto').length || 0;
                const avaliacoesPendentes = avaliadores?.filter(a => a.status === 'pendente' || a.status === 'em_andamento').length || 0;
                const totalAvaliacoes = avaliacoes?.length || 0;
                const concluidas = avaliacoes?.filter(a => a.status === 'concluida').length || 0;
                const taxaConclusao = totalAvaliacoes > 0 ? Math.round((concluidas / totalAvaliacoes) * 100) : 0;
                
                // Atualizar elementos do DOM
                const statTotalCiclos = document.getElementById('statTotalCiclos');
                const statCiclosAtivos = document.getElementById('statCiclosAtivos');
                const statAvaliacoesPendentes = document.getElementById('statAvaliacoesPendentes');
                const statTaxaConclusao = document.getElementById('statTaxaConclusao');
                
                if (statTotalCiclos) statTotalCiclos.textContent = totalCiclos;
                if (statCiclosAtivos) statCiclosAtivos.textContent = ciclosAtivos;
                if (statAvaliacoesPendentes) statAvaliacoesPendentes.textContent = avaliacoesPendentes;
                if (statTaxaConclusao) statTaxaConclusao.textContent = taxaConclusao + '%';
                
                console.log('✅ Estatísticas atualizadas:', {
                    totalCiclos,
                    ciclosAtivos,
                    avaliacoesPendentes,
                    taxaConclusao
                });
                
                // Aguardar um pouco para garantir que o DOM está pronto
                await new Promise(resolve => setTimeout(resolve, 100));
                
                // Inicializar gráficos
                initCharts(ciclos || [], avaliacoes || []);
                
                // Carregar últimas atividades
                await loadUltimasAtividades();
                
                console.log('✅ Dashboard carregado com sucesso');
            } catch (error) {
                console.error('❌ Erro ao carregar dashboard:', error);
                showNotification('Erro ao carregar dashboard. Recarregue a página.', 'error');
            }
        }

        function initCharts(ciclos, avaliacoes) {
            // Destruir gráficos existentes antes de criar novos
            if (charts.statusCiclos) {
                charts.statusCiclos.destroy();
            }
            if (charts.statusAvaliacoes) {
                charts.statusAvaliacoes.destroy();
            }
            if (charts.evolucao) {
                charts.evolucao.destroy();
            }
            
            // Gráfico de Status dos Ciclos
            const ctxStatusCiclos = document.getElementById('chartStatusCiclos');
            if (ctxStatusCiclos) {
                const statusCount = {
                    rascunho: ciclos?.filter(c => c.status === 'rascunho').length || 0,
                    aberto: ciclos?.filter(c => c.status === 'aberto').length || 0,
                    fechado: ciclos?.filter(c => c.status === 'fechado').length || 0,
                    finalizado: ciclos?.filter(c => c.status === 'finalizado').length || 0
                };
                
                charts.statusCiclos = new Chart(ctxStatusCiclos, {
                    type: 'doughnut',
                    data: {
                        labels: ['Rascunho', 'Aberto', 'Fechado', 'Finalizado'],
                        datasets: [{
                            data: [statusCount.rascunho, statusCount.aberto, statusCount.fechado, statusCount.finalizado],
                            backgroundColor: [
                                'rgba(108, 117, 125, 0.8)',
                                'rgba(23, 162, 184, 0.8)',
                                'rgba(220, 53, 69, 0.8)',
                                'rgba(17, 153, 142, 0.8)'
                            ],
                            borderWidth: 2,
                            borderColor: 'rgba(255, 255, 255, 0.1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.8)',
                                    padding: 15,
                                    font: { size: 12 }
                                }
                            }
                        }
                    }
                });
            }
            
            // Gráfico de Status das Avaliações
            const ctxStatusAvaliacoes = document.getElementById('chartStatusAvaliacoes');
            if (ctxStatusAvaliacoes) {
                const statusCount = {
                    pendente: avaliacoes?.filter(a => a.status === 'pendente').length || 0,
                    em_andamento: avaliacoes?.filter(a => a.status === 'em_andamento').length || 0,
                    concluida: avaliacoes?.filter(a => a.status === 'concluida').length || 0,
                    cancelada: avaliacoes?.filter(a => a.status === 'cancelada').length || 0
                };
                
                charts.statusAvaliacoes = new Chart(ctxStatusAvaliacoes, {
                    type: 'pie',
                    data: {
                        labels: ['Pendente', 'Em Andamento', 'Concluída', 'Cancelada'],
                        datasets: [{
                            data: [statusCount.pendente, statusCount.em_andamento, statusCount.concluida, statusCount.cancelada],
                            backgroundColor: [
                                'rgba(255, 193, 7, 0.8)',
                                'rgba(23, 162, 184, 0.8)',
                                'rgba(17, 153, 142, 0.8)',
                                'rgba(220, 53, 69, 0.8)'
                            ],
                            borderWidth: 2,
                            borderColor: 'rgba(255, 255, 255, 0.1)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.8)',
                                    padding: 15,
                                    font: { size: 12 }
                                }
                            }
                        }
                    }
                });
            }
            
            // Gráfico de Evolução
            const ctxEvolucao = document.getElementById('chartEvolucao');
            if (ctxEvolucao && avaliacoes) {
                // Agrupar por data de conclusão
                const evolucao = {};
                avaliacoes.filter(a => a.data_conclusao).forEach(a => {
                    const date = new Date(a.data_conclusao).toLocaleDateString('pt-BR');
                    evolucao[date] = (evolucao[date] || 0) + 1;
                });
                
                const labels = Object.keys(evolucao).sort();
                const data = labels.map(l => evolucao[l]);
                
                charts.evolucao = new Chart(ctxEvolucao, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Avaliações Concluídas',
                            data: data,
                            borderColor: 'rgba(102, 126, 234, 1)',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: {
                                    color: 'rgba(255, 255, 255, 0.8)'
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.6)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            },
                            x: {
                                ticks: {
                                    color: 'rgba(255, 255, 255, 0.6)'
                                },
                                grid: {
                                    color: 'rgba(255, 255, 255, 0.1)'
                                }
                            }
                        }
                    }
                });
            }
        }

        async function loadUltimasAtividades() {
            const { data: avaliadores, error } = await supabaseClient
                .from('avaliacao_360_avaliadores')
                .select(`
                    *,
                    avaliacao:avaliacao_360_avaliacoes (
                        avaliado_id,
                        ciclo:avaliacao_360_ciclos (
                            nome
                        )
                    )
                `)
                .eq('avaliador_id', currentUserId)
                .order('convidado_em', { ascending: false })
                .limit(10);
            
            if (error) return;
            
            // Buscar dados dos avaliados separadamente
            if (avaliadores && avaliadores.length > 0) {
                const avaliadoIds = [...new Set(avaliadores.map(a => a.avaliacao?.avaliado_id).filter(Boolean))];
                if (avaliadoIds.length > 0) {
                    const avaliadosMap = await buscarDadosAvaliados(avaliadoIds);
                    avaliadores.forEach(avaliador => {
                        if (avaliador.avaliacao?.avaliado_id) {
                            avaliador.avaliacao.avaliado = avaliadosMap.get(avaliador.avaliacao.avaliado_id) || {
                                nome: 'Usuário não encontrado',
                                email: ''
                            };
                        }
                    });
                }
            }
            
            const container = document.getElementById('ultimasAtividades');
            if (!avaliadores || avaliadores.length === 0) {
                container.innerHTML = '<p class="text-muted">Nenhuma atividade recente</p>';
                return;
            }
            
            container.innerHTML = avaliadores.map(a => {
                const statusClass = a.status === 'pendente' ? 'status-pendente' : 
                                   a.status === 'em_andamento' ? 'status-em-andamento' : 
                                   a.status === 'concluida' ? 'status-concluida' : 'status-cancelada';
                const statusLabel = a.status === 'pendente' ? 'Pendente' : 
                                   a.status === 'em_andamento' ? 'Em Andamento' : 
                                   a.status === 'concluida' ? 'Concluída' : 'Cancelada';
                
                return `
                    <div class="d-flex justify-content-between align-items-center p-3 mb-3" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.04) 100%); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 15px; transition: var(--transition);">
                        <div class="flex-grow-1">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-clipboard-list me-2" style="color: var(--primary);"></i>
                                <strong style="font-size: 1.1rem;">${a.avaliacao?.ciclo?.nome || 'N/A'}</strong>
                            </div>
                            <p class="text-muted mb-2" style="margin-left: 1.75rem;">
                                <i class="fas fa-user me-1"></i>
                                Avaliar: <strong>${a.avaliacao?.avaliado?.nome || a.avaliacao?.avaliado?.email || 'N/A'}</strong>
                            </p>
                            <div style="margin-left: 1.75rem;">
                                <span class="status-badge ${statusClass}">${statusLabel}</span>
                                ${a.convidado_em ? `<span class="text-muted ms-2" style="font-size: 0.85rem;"><i class="fas fa-clock me-1"></i>${formatDate(a.convidado_em)}</span>` : ''}
                            </div>
                        </div>
                        ${a.status === 'pendente' || a.status === 'em_andamento' ? `
                            <button class="btn btn-primary-modern btn-sm ms-3" onclick="responderAvaliacao('${a.avaliacao_id}', '${a.id}')">
                                <i class="fas fa-edit me-1"></i> Responder
                            </button>
                        ` : a.status === 'concluida' ? `
                            <button class="btn btn-outline-light btn-sm ms-3" onclick="verResultados('${a.avaliacao_id}')">
                                <i class="fas fa-chart-line me-1"></i> Ver Resultados
                            </button>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }

        // ========== COMPARAÇÃO ENTRE CICLOS ==========
        async function loadCiclosParaComparacao() {
            const { data: ciclos, error } = await supabaseClient
                .from('avaliacao_360_ciclos')
                .select('id, nome, data_inicio, data_fim')
                .in('status', ['fechado', 'finalizado'])
                .order('data_fim', { ascending: false });
            
            if (ciclos) {
                const select1 = document.getElementById('cicloComparacao1');
                const select2 = document.getElementById('cicloComparacao2');
                const options = '<option value="">Selecione um ciclo...</option>' +
                    ciclos.map(c => `<option value="${c.id}">${c.nome} (${formatDate(c.data_inicio)} - ${formatDate(c.data_fim)})</option>`).join('');
                
                if (select1) select1.innerHTML = options;
                if (select2) select2.innerHTML = options;
            }
            
            // Carregar avaliados
            const { data: usuarios } = await supabaseClient
                .from('user_profiles')
                .select('id, nome, email, departamento')
                .eq('active', true)
                .order('nome');
            
            if (usuarios) {
                const select = document.getElementById('avaliadoComparacao');
                if (select) {
                    select.innerHTML = '<option value="">Selecione um avaliado...</option>' +
                        usuarios.map(u => `<option value="${u.id}">${u.nome || u.email} - ${u.departamento || 'N/A'}</option>`).join('');
                }
            }
        }

        async function compararCiclos() {
            const ciclo1Id = document.getElementById('cicloComparacao1').value;
            const ciclo2Id = document.getElementById('cicloComparacao2').value;
            const avaliadoId = document.getElementById('avaliadoComparacao').value;
            
            if (!ciclo1Id || !ciclo2Id || !avaliadoId) {
                showNotification('Selecione ambos os ciclos e o avaliado', 'warning');
                return;
            }
            
            if (ciclo1Id === ciclo2Id) {
                showNotification('Selecione ciclos diferentes para comparar', 'warning');
                return;
            }
            
            // Carregar dados dos dois ciclos
            const [avaliacao1, avaliacao2] = await Promise.all([
                supabaseClient
                    .from('avaliacao_360_avaliacoes')
                    .select(`
                        *,
                        ciclo:avaliacao_360_ciclos (nome),
                        respostas:avaliacao_360_respostas (
                            *,
                            competencia:avaliacao_360_competencias (
                                categoria,
                                competencia,
                                peso
                            )
                        )
                    `)
                    .eq('ciclo_id', ciclo1Id)
                    .eq('avaliado_id', avaliadoId)
                    .single(),
                supabaseClient
                    .from('avaliacao_360_avaliacoes')
                    .select(`
                        *,
                        ciclo:avaliacao_360_ciclos (nome),
                        respostas:avaliacao_360_respostas (
                            *,
                            competencia:avaliacao_360_competencias (
                                categoria,
                                competencia,
                                peso
                            )
                        )
                    `)
                    .eq('ciclo_id', ciclo2Id)
                    .eq('avaliado_id', avaliadoId)
                    .single()
            ]);
            
            if (avaliacao1.error || avaliacao2.error) {
                showNotification('Erro ao carregar dados para comparação', 'error');
                return;
            }
            
            // Processar resultados
            const resultados1 = processarRespostas(avaliacao1.data?.respostas || []);
            const resultados2 = processarRespostas(avaliacao2.data?.respostas || []);
            
            // Renderizar comparação
            const container = document.getElementById('comparacaoContent');
            container.innerHTML = `
                <div class="card-modern">
                    <h3 class="mb-4">Comparação: ${avaliacao1.data?.ciclo?.nome} vs ${avaliacao2.data?.ciclo?.nome}</h3>
                    
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <div class="card-modern">
                                <h5 class="mb-3">Evolução por Competência</h5>
                                <canvas id="chartComparacao" height="100"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-modern">
                            <thead>
                                <tr>
                                    <th>Competência</th>
                                    <th>${avaliacao1.data?.ciclo?.nome}</th>
                                    <th>${avaliacao2.data?.ciclo?.nome}</th>
                                    <th>Variação</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${Object.keys(resultados1).map(compId => {
                                    const r1 = resultados1[compId];
                                    const r2 = resultados2[compId] || { media: 0, competencia: r1.competencia };
                                    const variacao = ((r2.media - r1.media) / r1.media * 100).toFixed(1);
                                    const variacaoClass = variacao > 0 ? 'text-success' : variacao < 0 ? 'text-danger' : 'text-muted';
                                    return `
                                        <tr>
                                            <td>${r1.competencia.categoria} - ${r1.competencia.competencia}</td>
                                            <td>${r1.media.toFixed(2)}</td>
                                            <td>${r2.media.toFixed(2)}</td>
                                            <td class="${variacaoClass}">
                                                ${variacao > 0 ? '+' : ''}${variacao}%
                                                <i class="fas fa-${variacao > 0 ? 'arrow-up' : variacao < 0 ? 'arrow-down' : 'minus'} ms-1"></i>
                                            </td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            // Criar gráfico de comparação
            setTimeout(() => {
                criarGraficoComparacao(resultados1, resultados2, avaliacao1.data?.ciclo?.nome, avaliacao2.data?.ciclo?.nome);
            }, 100);
        }

        function processarRespostas(respostas) {
            const resultados = {};
            respostas.forEach(r => {
                if (r.competencia && r.valor_numerico) {
                    if (!resultados[r.competencia.id]) {
                        resultados[r.competencia.id] = {
                            competencia: r.competencia,
                            valores: []
                        };
                    }
                    resultados[r.competencia.id].valores.push(r.valor_numerico);
                }
            });
            
            Object.keys(resultados).forEach(key => {
                const r = resultados[key];
                r.media = r.valores.length > 0 
                    ? r.valores.reduce((a, b) => a + b, 0) / r.valores.length
                    : 0;
            });
            
            return resultados;
        }

        function criarGraficoComparacao(resultados1, resultados2, nome1, nome2) {
            const ctx = document.getElementById('chartComparacao');
            if (!ctx) return;
            
            const competencias = Object.keys(resultados1);
            const labels = competencias.map(id => resultados1[id].competencia.competencia);
            const data1 = competencias.map(id => resultados1[id].media);
            const data2 = competencias.map(id => resultados2[id]?.media || 0);
            
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: nome1,
                        data: data1,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }, {
                        label: nome2,
                        data: data2,
                        backgroundColor: 'rgba(17, 153, 142, 0.8)',
                        borderColor: 'rgba(17, 153, 142, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'rgba(255, 255, 255, 0.8)'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 5,
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.6)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        x: {
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.6)'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        // ========== RELATÓRIOS ==========
        async function loadDadosRelatorios() {
            // Carregar ciclos
            const { data: ciclos } = await supabaseClient
                .from('avaliacao_360_ciclos')
                .select('id, nome')
                .order('criado_em', { ascending: false });
            
            if (ciclos) {
                const selects = ['relatorioCiclo', 'relatorioDeptCiclo', 'relatorioGeralCiclo'];
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="">Selecione...</option>' +
                            ciclos.map(c => `<option value="${c.id}">${c.nome}</option>`).join('');
                    }
                });
            }
            
            // Carregar avaliados
            const { data: usuarios } = await supabaseClient
                .from('user_profiles')
                .select('id, nome, email')
                .eq('active', true)
                .order('nome');
            
            if (usuarios) {
                const select = document.getElementById('relatorioAvaliado');
                if (select) {
                    select.innerHTML = '<option value="">Selecione...</option>' +
                        usuarios.map(u => `<option value="${u.id}">${u.nome || u.email}</option>`).join('');
                }
            }
            
            // Carregar departamentos
            const { data: depts } = await supabaseClient
                .from('user_profiles')
                .select('departamento')
                .not('departamento', 'is', null)
                .eq('active', true);
            
            if (depts) {
                const departamentos = [...new Set(depts.map(d => d.departamento))].sort();
                const select = document.getElementById('relatorioDepartamento');
                if (select) {
                    select.innerHTML = '<option value="">Selecione...</option>' +
                        departamentos.map(d => `<option value="${d}">${d}</option>`).join('');
                }
            }
        }

        async function gerarRelatorioIndividual() {
            const cicloId = document.getElementById('relatorioCiclo').value;
            const avaliadoId = document.getElementById('relatorioAvaliado').value;
            
            if (!cicloId || !avaliadoId) {
                showNotification('Selecione o ciclo e o avaliado', 'warning');
                return;
            }
            
            // Buscar avaliação
            const { data: avaliacao } = await supabaseClient
                .from('avaliacao_360_avaliacoes')
                .select('id')
                .eq('ciclo_id', cicloId)
                .eq('avaliado_id', avaliadoId)
                .single();
            
            if (avaliacao) {
                await exportarResultados(avaliacao.id);
            } else {
                showNotification('Avaliação não encontrada', 'error');
            }
        }

        async function gerarRelatorioDepartamento() {
            const cicloId = document.getElementById('relatorioDeptCiclo').value;
            const departamento = document.getElementById('relatorioDepartamento').value;
            
            if (!cicloId || !departamento) {
                showNotification('Selecione o ciclo e o departamento', 'warning');
                return;
            }
            
            // Buscar todas as avaliações do departamento
            const { data: avaliacoes, error } = await supabaseClient
                .from('avaliacao_360_avaliacoes')
                .select(`
                    *,
                    respostas:avaliacao_360_respostas (
                        *,
                        competencia:avaliacao_360_competencias (
                            categoria,
                            competencia,
                            peso
                        )
                    )
                `)
                .eq('ciclo_id', cicloId);
            
            if (error) {
                showNotification('Erro ao carregar dados', 'error');
                return;
            }
            
            // Enriquecer avaliações com dados dos avaliados
            avaliacoes = await enriquecerAvaliacoesComAvaliados(avaliacoes || []);
            const avaliacoesDept = avaliacoes.filter(a => a.avaliado?.departamento === departamento);
            
            if (avaliacoesDept.length === 0) {
                showNotification('Nenhuma avaliação encontrada para este departamento', 'info');
                return;
            }
            
            // Gerar PDF consolidado
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text('Relatório por Departamento', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`Departamento: ${departamento}`, 20, 35);
            doc.text(`Total de Avaliados: ${avaliacoesDept.length}`, 20, 42);
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 49);
            
            // Tabela consolidada
            const tableData = avaliacoesDept.map(a => {
                const respostas = a.respostas || [];
                const valores = respostas.filter(r => r.valor_numerico).map(r => r.valor_numerico);
                const media = valores.length > 0 
                    ? (valores.reduce((a, b) => a + b, 0) / valores.length).toFixed(2)
                    : '0.00';
                return [a.avaliado?.nome || a.avaliado?.email || 'N/A', media];
            });
            
            doc.autoTable({
                startY: 60,
                head: [['Avaliado', 'Média Geral']],
                body: tableData,
                theme: 'striped',
                headStyles: { fillColor: [102, 126, 234] }
            });
            
            const fileName = `Relatorio_Departamento_${departamento.replace(/\s/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            
            showNotification('Relatório gerado com sucesso!', 'success');
        }

        async function gerarRelatorioGeral() {
            const cicloId = document.getElementById('relatorioGeralCiclo').value;
            
            if (!cicloId) {
                showNotification('Selecione o ciclo', 'warning');
                return;
            }
            
            // Buscar todas as avaliações do ciclo
            const { data: avaliacoes, error } = await supabaseClient
                .from('avaliacao_360_avaliacoes')
                .select(`
                    *,
                    ciclo:avaliacao_360_ciclos (nome),
                    respostas:avaliacao_360_respostas (
                        *,
                        competencia:avaliacao_360_competencias (
                            categoria,
                            competencia
                        )
                    )
                `)
                .eq('ciclo_id', cicloId);
            
            if (error) {
                showNotification('Erro ao carregar dados', 'error');
                return;
            }
            
            // Enriquecer avaliações com dados dos avaliados
            avaliacoes = await enriquecerAvaliacoesComAvaliados(avaliacoes || []);
            
            // Gerar PDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            doc.setFontSize(20);
            doc.text('Relatório Geral de Avaliação 360º', 105, 20, { align: 'center' });
            
            doc.setFontSize(12);
            doc.text(`Ciclo: ${avaliacoes[0]?.ciclo?.nome || 'N/A'}`, 20, 35);
            doc.text(`Total de Avaliados: ${avaliacoes.length}`, 20, 42);
            doc.text(`Data: ${new Date().toLocaleDateString('pt-BR')}`, 20, 49);
            
            // Agrupar por departamento
            const porDepartamento = {};
            avaliacoes.forEach(a => {
                const dept = a.avaliado?.departamento || 'Sem Departamento';
                if (!porDepartamento[dept]) {
                    porDepartamento[dept] = [];
                }
                porDepartamento[dept].push(a);
            });
            
            let yPos = 60;
            Object.entries(porDepartamento).forEach(([dept, avals]) => {
                if (yPos > 250) {
                    doc.addPage();
                    yPos = 20;
                }
                
                doc.setFontSize(14);
                doc.text(`Departamento: ${dept}`, 20, yPos);
                yPos += 10;
                
                const tableData = avals.map(a => {
                    const respostas = a.respostas || [];
                    const valores = respostas.filter(r => r.valor_numerico).map(r => r.valor_numerico);
                    const media = valores.length > 0 
                        ? (valores.reduce((a, b) => a + b, 0) / valores.length).toFixed(2)
                        : '0.00';
                    return [a.avaliado?.nome || a.avaliado?.email || 'N/A', media, a.status];
                });
                
                doc.autoTable({
                    startY: yPos,
                    head: [['Avaliado', 'Média', 'Status']],
                    body: tableData,
                    theme: 'striped',
                    headStyles: { fillColor: [102, 126, 234] },
                    styles: { fontSize: 8 }
                });
                
                yPos = doc.lastAutoTable.finalY + 15;
            });
            
            const fileName = `Relatorio_Geral_${avaliacoes[0]?.ciclo?.nome?.replace(/\s/g, '_') || 'Ciclo'}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
            
            showNotification('Relatório geral gerado com sucesso!', 'success');
        }

        // ========== NOTIFICAÇÕES ==========
        function showNotification(message, type = 'info', duration = 3000) {
            const toast = document.createElement('div');
            toast.className = `notification-toast ${type}`;
            toast.innerHTML = `
                <div class="d-flex align-items-center">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>
                    <span>${message}</span>
                    <button class="btn-close btn-close-white ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
                </div>
            `;
            
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideInRight 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, duration);
        }

        // ========== HISTÓRICO ==========
        async function registrarHistorico(acao, detalhes, avaliacaoId = null) {
            try {
                // Criar tabela de histórico se não existir (via migração seria melhor, mas por enquanto vamos apenas logar)
                console.log('📝 Histórico:', {
                    acao,
                    detalhes,
                    avaliacaoId,
                    usuario: currentUserId,
                    timestamp: new Date().toISOString()
                });
                
                // Aqui você pode adicionar uma chamada para salvar no banco se criar uma tabela de histórico
            } catch (error) {
                console.error('Erro ao registrar histórico:', error);
            }
        }

        // ========== VALIDAÇÕES ==========
        function validarFormularioCiclo() {
            const nome = document.getElementById('cicloNome').value;
            const dataInicio = document.getElementById('cicloDataInicio').value;
            const dataFim = document.getElementById('cicloDataFim').value;
            const dataLimite = document.getElementById('cicloDataLimite').value;
            
            if (!nome || !dataInicio || !dataFim || !dataLimite) {
                showNotification('Preencha todos os campos obrigatórios', 'error');
                return false;
            }
            
            const inicio = new Date(dataInicio);
            const fim = new Date(dataFim);
            const limite = new Date(dataLimite);
            
            if (fim < inicio) {
                showNotification('A data de fim deve ser posterior à data de início', 'error');
                return false;
            }
            
            if (limite < inicio || limite > fim) {
                showNotification('A data limite deve estar entre o início e o fim do ciclo', 'error');
                return false;
            }
            
            return true;
        }

        // ========== UTILITÁRIOS ==========
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleDateString('pt-BR');
        }

        function formatDateTime(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return date.toLocaleString('pt-BR');
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Aplicar debounce na busca
        document.addEventListener('DOMContentLoaded', () => {
            const filtroBusca = document.getElementById('filtroBusca');
            if (filtroBusca) {
                filtroBusca.addEventListener('input', debounce(aplicarFiltros, 300));
            }
        });

        // Inicializar ao carregar
        // Inicializar quando o DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            // DOM já está pronto
            init();
        }
        
        // Fallback: atualizar visibilidade do botão após 1 segundo (caso o perfil demore para carregar)
        setTimeout(() => {
            if (currentUserProfile) {
                atualizarVisibilidadeBotaoNovoCiclo();
            }
        }, 1000);
    </script>
</body>
</html>
