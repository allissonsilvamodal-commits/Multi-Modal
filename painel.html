<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel de Disparo - Sistema Multimodal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="js/permissions.js"></script>
  <style>
    :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --warning: #f8961e;
            --danger: #f72585;
            --info: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --sidebar-width: 250px;
            --header-height: 70px;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        [data-theme="dark"] {
            --light: #1a1d28;
            --dark: #f8f9fa;
            --card-bg: #252836;
            --text-color: #e4e6eb;
            --border-color: #3a3f50;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fb;
            color: var(--dark);
            transition: var(--transition);
            overflow-x: hidden;
        }

        body[data-theme="dark"] {
            background-color: #121826;
            color: var(--text-color);
        }

        /* Layout Principal */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: var(--transition);
            z-index: 1000;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .sidebar-logo {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .sidebar-menu {
            padding: 1rem 0;
        }

        .menu-item {
            padding: 0.8rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: var(--transition);
            border-left: 3px solid transparent;
        }

        .menu-item:hover, .menu-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: white;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 2rem;
            transition: var(--transition);
        }

        /* Header */
        .header {
            background: white;
            padding: 1rem 2rem;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Cards */
    .modern-card {
      background: white;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
      overflow: hidden;
            transition: var(--transition);
    }
    
    .modern-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
        .card-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
            padding: 1.5rem;
            font-weight: 600;
      font-size: 1.1rem;
    }
    
        .card-body {
            padding: 2rem;
        }

        /* Stats Cards */
        .stats-grid {
      display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
        .stat-card {
      background: white;
      padding: 2rem;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
      text-align: center;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
            color: white;
        }

        .stat-icon.primary { background: var(--primary); }
        .stat-icon.success { background: var(--success); }
        .stat-icon.warning { background: var(--warning); }
        .stat-icon.info { background: var(--info); }

        .stat-number {
      font-size: 2.5rem;
            font-weight: 700;
            color: var(--dark);
      margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #6c757d;
            font-weight: 500;
        }

        /* Vehicle Classes */
    .vehicle-classes {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .vehicle-class {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
      padding: 1.5rem;
      text-align: center;
      cursor: pointer;
            transition: var(--transition);
    }
    
    .vehicle-class:hover {
      border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(67, 97, 238, 0.15);
    }
    
    .vehicle-class.active {
      border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
    }
    
        .vehicle-class-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .vehicle-class-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .vehicle-class-count {
      font-size: 0.9rem;
      opacity: 0.8;
    }
    
        /* Filters */
        .filters-container {
      background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
      margin-bottom: 2rem;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-control-modern {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            transition: var(--transition);
        }

        .form-control-modern:focus {
      border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
        }

        /* Motoristas List */
        .motoristas-container {
            background: white;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
      overflow: hidden;
        }

        .motoristas-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .motoristas-list {
            max-height: 600px;
            overflow-y: auto;
        }

        .motorista-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
            cursor: pointer;
        }

        .motorista-item:hover {
            background: #f8f9fa;
        }

        .motorista-item.selected {
            background: rgba(67, 97, 238, 0.1);
            border-left: 4px solid var(--primary);
        }

        .motorista-info h6 {
            margin: 0;
            font-weight: 600;
            color: var(--dark);
        }

        .motorista-details {
      font-size: 0.9rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        .motorista-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #dee2e6;
            border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
            transition: var(--transition);
        }

        .motorista-checkbox.checked {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        /* Pagination */
        .pagination-container {
      background: white;
            padding: 1.5rem;
            border-top: 1px solid #e9ecef;
        }

        .pagination-modern {
      display: flex;
      justify-content: center;
            gap: 0.5rem;
        }

        .page-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #dee2e6;
            background: white;
      color: var(--dark);
            text-decoration: none;
      border-radius: 8px;
            transition: var(--transition);
    }
    
        .page-btn:hover {
      background: var(--primary);
            color: white;
      border-color: var(--primary);
    }
    
        .page-btn.active {
            background: var(--primary);
      color: white;
            border-color: var(--primary);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Buttons */
        .btn-modern {
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: var(--transition);
            border: none;
        }

        .btn-voltar-portal {
            background: rgba(255, 255, 255, 0.1);
            color: var(--primary);
            border: 2px solid var(--primary);
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
        }

        .btn-voltar-portal:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(67, 97, 238, 0.3);
            text-decoration: none;
        }

        /* Dark mode para bot√£o voltar */
        body[data-theme="dark"] .btn-voltar-portal {
            background: rgba(255, 255, 255, 0.1);
            color: var(--primary);
            border-color: var(--primary);
        }

        body[data-theme="dark"] .btn-voltar-portal:hover {
            background: var(--primary);
            color: white;
        }

        .btn-toggle-theme {
            background: rgba(255, 255, 255, 0.1);
            color: var(--primary);
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            font-weight: 600;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .btn-toggle-theme:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        }

        /* Dark mode para bot√£o toggle */
        body[data-theme="dark"] .btn-toggle-theme {
            background: rgba(255, 255, 255, 0.1);
            color: var(--primary);
            border-color: var(--primary);
        }

        body[data-theme="dark"] .btn-toggle-theme:hover {
            background: var(--primary);
            color: white;
        }

        .btn-modern-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-modern-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(67, 97, 238, 0.3);
        }

        .btn-modern-success {
            background: linear-gradient(135deg, var(--success), #06b6d4);
            color: white;
        }

        .btn-modern-success:hover {
      transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 201, 240, 0.3);
        }

        .btn-modern-warning {
            background: linear-gradient(135deg, var(--warning), #f97316);
            color: white;
        }

        .btn-modern-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(248, 150, 30, 0.3);
        }

        .btn-modern-info {
            background: linear-gradient(135deg, var(--info), #3b82f6);
            color: white;
        }

        .btn-modern-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(72, 149, 239, 0.3);
        }

        /* Loading */
        .loading-spinner {
      display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Alerts */
        .alert-modern {
            border: none;
            border-radius: 10px;
      padding: 1rem 1.5rem;
            margin-bottom: 1rem;
        }

        .alert-modern-success {
            background: linear-gradient(135deg, rgba(76, 201, 240, 0.1), rgba(6, 182, 212, 0.1));
            color: #065f46;
            border-left: 4px solid var(--success);
        }

        .alert-modern-warning {
            background: linear-gradient(135deg, rgba(248, 150, 30, 0.1), rgba(249, 115, 22, 0.1));
            color: #92400e;
            border-left: 4px solid var(--warning);
        }

        .alert-modern-danger {
            background: linear-gradient(135deg, rgba(247, 37, 133, 0.1), rgba(236, 72, 153, 0.1));
            color: #991b1b;
            border-left: 4px solid var(--danger);
        }

        .alert-modern-info {
            background: linear-gradient(135deg, rgba(72, 149, 239, 0.1), rgba(59, 130, 246, 0.1));
            color: #1e40af;
            border-left: 4px solid var(--info);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .vehicle-classes {
                grid-template-columns: 1fr;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
            }
        }

        /* Dark Mode */
        body[data-theme="dark"] .modern-card,
        body[data-theme="dark"] .stat-card,
        body[data-theme="dark"] .filters-container,
        body[data-theme="dark"] .motoristas-container,
        body[data-theme="dark"] .pagination-container,
        body[data-theme="dark"] .vehicle-class {
            background: var(--card-bg);
            color: var(--text-color);
        }

        body[data-theme="dark"] .page-btn {
            background: rgba(255, 255, 255, 0.1) !important;
            color: var(--text-color) !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
        }

        body[data-theme="dark"] .page-btn:hover {
            background: var(--primary) !important;
            color: white !important;
            border-color: var(--primary) !important;
        }

        body[data-theme="dark"] .page-btn.active {
            background: var(--primary) !important;
            color: white !important;
            border-color: var(--primary) !important;
        }

        body[data-theme="dark"] .page-btn.disabled {
            background: rgba(255, 255, 255, 0.05) !important;
            color: rgba(255, 255, 255, 0.3) !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
            cursor: not-allowed !important;
        }

        body[data-theme="dark"] .text-muted {
            color: rgba(255, 255, 255, 0.6) !important;
        }

        body[data-theme="dark"] #infoPagina {
            color: rgba(255, 255, 255, 0.7) !important;
        }

        body[data-theme="dark"] .vehicle-class {
            border-color: var(--border-color);
        }

        body[data-theme="dark"] .vehicle-class:hover {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.1);
        }

        body[data-theme="dark"] .vehicle-class.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        /* Dark Mode - Bot√µes */
        body[data-theme="dark"] .btn-modern-primary,
        body[data-theme="dark"] .btn-modern-success,
        body[data-theme="dark"] .btn-modern-warning,
        body[data-theme="dark"] .btn-modern-info {
            color: white !important;
            opacity: 1 !important;
        }

        body[data-theme="dark"] .btn-modern-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary)) !important;
        }

        body[data-theme="dark"] .btn-modern-success {
            background: linear-gradient(135deg, var(--success), #06b6d4) !important;
        }

        body[data-theme="dark"] .btn-modern-warning {
            background: linear-gradient(135deg, var(--warning), #f97316) !important;
        }

        body[data-theme="dark"] .btn-modern-info {
            background: linear-gradient(135deg, var(--info), #3b82f6) !important;
        }

        body[data-theme="dark"] .motorista-item {
            border-bottom-color: var(--border-color);
        }

        body[data-theme="dark"] .motorista-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        body[data-theme="dark"] .form-control-modern {
            background: var(--card-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }

        body[data-theme="dark"] .form-control-modern:focus {
            background: var(--card-bg);
            border-color: var(--primary);
            color: var(--text-color);
    }

        /* Delay Counter Styles */
        .delay-counter-container {
            margin-top: 1rem;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .delay-counter-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--info);
            margin: 0 0.5rem;
            display: inline-block;
            min-width: 3rem;
            text-align: center;
        }

        .delay-counter-container .alert {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        body[data-theme="dark"] .delay-counter-number {
            color: var(--info);
        }
  </style>
</head>
<body>
<div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-rocket"></i>
                    <span>Painel Disparo</span>
            </div>
              </div>
            <div class="sidebar-menu">
                <a href="portal.html" class="menu-item">
                    <i class="fas fa-home"></i>
                    <span>Portal</span>
                </a>
                <a href="#" class="menu-item active">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="cadastro.html" class="menu-item">
                    <i class="fas fa-truck"></i>
                    <span>Motoristas</span>
                </a>
                <a href="#" class="menu-item">
                    <i class="fas fa-paper-plane"></i>
                    <span>Disparos</span>
                </a>
                <a href="relatorios.html" class="menu-item">
                    <i class="fas fa-chart-line"></i>
                    <span>Relat√≥rios</span>
                </a>
                <a href="settings.html" class="menu-item">
                    <i class="fas fa-cog"></i>
                    <span>Configura√ß√µes</span>
                </a>
            </div>
          </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="d-flex align-items-center">
                    <a href="portal.html" class="btn btn-voltar-portal me-3">
                        <i class="fas fa-arrow-left me-2"></i>
                        Voltar ao Portal
                    </a>
                    <h1 class="header-title">
                        <i class="fas fa-rocket me-2"></i>
                        Painel de Disparo de Mensagens
                    </h1>
                </div>
                <div class="header-actions">
                    <div class="user-badge">
                        <i class="fas fa-user me-2"></i>
                        <span id="userName">Usu√°rio</span>
                    </div>
                    <button class="btn btn-toggle-theme btn-sm" onclick="toggleTheme()">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-number" id="totalMotoristas">0</div>
                    <div class="stat-label">Total de Motoristas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-number" id="motoristasAtivos">0</div>
                    <div class="stat-label">Motoristas Ativos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon warning">
                        <i class="fas fa-hand-pointer"></i>
                    </div>
                    <div class="stat-number" id="motoristasSelecionados">0</div>
                    <div class="stat-label">Selecionados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon info">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="stat-number" id="categoriaAtiva">-</div>
                    <div class="stat-label">Categoria Ativa</div>
                </div>
            </div>

            <!-- Vehicle Classes -->
        <div class="modern-card">
          <div class="card-header">
                    <i class="fas fa-truck me-2"></i>
                    Selecionar Categoria de Ve√≠culo
          </div>
          <div class="card-body">
                    <div class="vehicle-classes">
                        <div class="vehicle-class" data-class="leve" onclick="selecionarClasse('leve')">
                            <div class="vehicle-class-icon">
                                <i class="fas fa-car"></i>
            </div>
                            <div class="vehicle-class-title">Leve</div>
                            <div class="vehicle-class-count" id="count-leve">0 motoristas</div>
          </div>
                        <div class="vehicle-class" data-class="medio" onclick="selecionarClasse('medio')">
                            <div class="vehicle-class-icon">
                                <i class="fas fa-truck"></i>
        </div>
                            <div class="vehicle-class-title">M√©dio</div>
                            <div class="vehicle-class-count" id="count-medio">0 motoristas</div>
              </div>
                        <div class="vehicle-class" data-class="pesado" onclick="selecionarClasse('pesado')">
                            <div class="vehicle-class-icon">
                                <i class="fas fa-truck-moving"></i>
            </div>
                            <div class="vehicle-class-title">Pesado</div>
                            <div class="vehicle-class-count" id="count-pesado">0 motoristas</div>
          </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters-container">
                <div class="row">
                    <div class="col-md-2">
                        <label class="form-label">Classe de Ve√≠culo</label>
                        <select id="filtroClasse" class="form-control form-control-modern">
                            <option value="">Todas as classes</option>
                            <option value="leve">Leve</option>
                            <option value="medio">M√©dio</option>
                            <option value="pesado">Pesado</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Tipo de Ve√≠culo</label>
                        <select id="filtroTipoVeiculo" class="form-control form-control-modern">
                            <option value="">Todos os tipos</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Carroceria</label>
                        <select id="filtroCarroceria" class="form-control form-control-modern">
                            <option value="">Todas as carrocerias</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Estado</label>
                        <select id="filtroEstado" class="form-control form-control-modern">
                            <option value="">Todos os estados</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Status</label>
                        <select id="filtroStatus" class="form-control form-control-modern">
                            <option value="">Todos os status</option>
                            <option value="ativo">Ativo</option>
                            <option value="inativo">Inativo</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Buscar</label>
                        <input type="text" id="filtroBusca" class="form-control form-control-modern" placeholder="Nome ou telefone...">
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button class="btn btn-modern btn-modern-primary me-2" id="btnBuscar">
                            <i class="fas fa-search me-2"></i>
                            Buscar
                        </button>
                        <button class="btn btn-modern btn-modern-success me-2 mb-2 mb-md-0" id="btnSelecionarTodos">
                            <i class="fas fa-check-double me-2"></i>
                            Selecionar Todos
                        </button>
                        <button class="btn btn-modern btn-modern-info me-2 mb-2 mb-md-0" id="btnSelecionarPagina">
                            <i class="fas fa-check-square me-2"></i>
                            Selecionar P√°gina
                        </button>
                        <button class="btn btn-modern btn-modern-warning mb-2 mb-md-0" id="btnLimparSelecao">
                            <i class="fas fa-times me-2"></i>
                            Limpar Sele√ß√£o
                        </button>
                </div>
              </div>
            </div>

            <!-- Motoristas List -->
            <div class="motoristas-container">
                <div class="motoristas-header">
                    <div>
                        <i class="fas fa-list me-2"></i>
                        Lista de Motoristas
                </div>
                    <div class="d-flex align-items-center gap-3">
                        <span class="badge bg-light text-dark" id="motoristasSelecionadosBadge">0 selecionados</span>
                        <div class="d-flex align-items-center">
                            <span class="me-2">Mostrar:</span>
                            <select id="itensPorPagina" class="form-select form-select-sm" style="width: auto;">
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="30">30</option>
                                <option value="40">40</option>
                                <option value="50" selected>50</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="motoristas-list" id="motoristasList">
                    <div class="text-center py-5">
                        <i class="fas fa-truck fs-1 text-muted mb-3"></i>
                        <p class="text-muted">Selecione uma categoria para carregar os motoristas</p>
              </div>
            </div>

                <!-- Pagination -->
                <div class="pagination-container">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <small class="text-muted" id="infoPagina">
                                P√°gina 1 de 1 - Total: 0 motoristas
                            </small>
              </div>
                        <div class="col-md-6">
                            <nav aria-label="Pagina√ß√£o">
                                <ul class="pagination-modern justify-content-end mb-0" id="paginacao">
                                    <!-- Pagina√ß√£o ser√° gerada via JavaScript -->
                </ul>
              </nav>
                        </div>
            </div>
          </div>
        </div>

            <!-- Message and Send -->
            <div class="modern-card">
          <div class="card-header">
                    <i class="fas fa-paper-plane me-2"></i>
                    Mensagem e Disparo
          </div>
          <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-4">
                                <label class="form-label">Mensagem Personalizada</label>
                                <div class="alert alert-modern alert-modern-info">
                                    <strong>Vari√°veis dispon√≠veis:</strong> {{name}}, {{telefone}}, {{estado}}, {{classe_veiculo}}, {{tipo_veiculo}}
              </div>
              <textarea 
                id="messageText" 
                class="form-control form-control-modern" 
                rows="5" 
                placeholder="Digite sua mensagem aqui... Use as vari√°veis acima para personalizar."
                                >Ol√° {{name}}, temos uma viagem dispon√≠vel para voc√™ na categoria {{classe_veiculo}}.</textarea>
                            </div>

                            <div class="mb-4">
                                <label class="form-label">Imagem (opcional)</label>
                                <div id="imageUploadWrapper">
                                    <input type="file" id="imageInput" class="form-control form-control-modern" accept="image/*">
                                    <small class="text-muted">Formatos aceitos: jpg, jpeg, png, webp. Tamanho m√°ximo 5MB.</small>
                                </div>
                                <div id="imagePreview" class="image-preview mt-3" style="display:none;">
                                    <div class="preview-info d-flex justify-content-between align-items-center">
                                        <div>
                                            <small class="text-muted" id="imageName">imagem.jpg</small>
                                        </div>
                                        <button class="btn btn-sm btn-outline-danger" id="btnRemoveImage">
                                            <i class="fas fa-times"></i> Remover
                                        </button>
                                    </div>
                                    <div class="preview-image mt-2 text-center">
                                        <img id="previewImg" src="" alt="Pr√©-visualiza√ß√£o" class="img-fluid rounded">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Test Field -->
                            <div class="mb-4">
                                <label class="form-label">Teste de Envio</label>
                                <div class="row g-2">
                                    <div class="col-md-8">
                                        <input 
                                            type="text" 
                                            id="telefoneTeste" 
                                            class="form-control form-control-modern" 
                                            placeholder="Digite o n√∫mero para teste (ex: 5511999999999)"
                                        >
                </div>
                  <div class="col-md-4">
                                        <button class="btn btn-modern btn-modern-primary w-100" id="btnTestarEnvio">
                                            <i class="fas fa-paper-plane me-2"></i>
                                            Enviar Teste
                    </button>
                  </div>
                </div>
                                <small class="text-muted">Digite um n√∫mero de telefone para testar o envio real</small>
              </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-4">
                                <label class="form-label">A√ß√µes</label>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-modern btn-modern-primary" id="btnTestarMensagem">
                                        <i class="fas fa-vial me-2"></i>
                                        Testar Mensagem
                  </button>
                                    <button class="btn btn-modern btn-modern-success" id="btnIniciarDisparo">
                                        <i class="fas fa-rocket me-2"></i>
                                        Iniciar Disparo
                  </button>
                                    <button class="btn btn-modern btn-modern-danger" id="btnPararDisparo" style="display: none;">
                                        <i class="fas fa-stop me-2"></i>
                                        Parar Disparo
                  </button>
              </div>
            </div>

                            <div class="mb-4">
                                <label class="form-label">Progresso</label>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
              </div>
                                <div class="text-center">
                                    <small class="text-muted" id="progressText">0 de 0 enviados</small>
              </div>
                                <!-- Contador de Delay -->
                                <div id="delayCounterContainer" class="delay-counter-container" style="display: none;">
                                    <div class="alert alert-modern alert-modern-info mb-2">
                                        <i class="fas fa-clock me-2"></i>
                                        <strong>Aguardando pr√≥ximo envio:</strong>
                                        <span id="delayCounter" class="delay-counter-number">0</span>
                                        <span>segundos</span>
                                    </div>
                                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

            <!-- Evolution API Status -->
        <div class="modern-card">
          <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <i class="fas fa-shield-alt me-2"></i>
                        Status Evolution API
            </div>
                    <button class="btn btn-modern btn-modern-primary btn-sm" id="btnVerificarEvolution">
                        <i class="fas fa-sync me-2"></i>
                        Verificar Status
                  </button>
              </div>
              <div class="card-body">
                    <div id="evolutionLog" style="max-height: 200px; overflow-y: auto; background: #f8fafc; border-radius: 12px; padding: 1rem;">
                        <div class="text-center text-muted">
                            <i class="fas fa-shield-alt fa-2x mb-3 d-block"></i>
                            Clique em "Verificar Status" para testar a Evolution API
                  </div>
                </div>
                  </div>
                </div>
                
            <!-- Disparo Log -->
            <div class="modern-card">
              <div class="card-header">
                    <i class="fas fa-list-alt me-2"></i>
                    Log de Disparo
              </div>
              <div class="card-body">
                    <div id="disparoLog" style="max-height: 300px; overflow-y: auto; background: #f8fafc; border-radius: 12px; padding: 1rem;">
                        <div class="text-center text-muted">
                            <i class="fas fa-clipboard-list fa-2x mb-3 d-block"></i>
                            Nenhum disparo realizado ainda
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        
    <!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
        // ========== CONFIGURA√á√ÉO DO SUPABASE ==========
        let supabaseUrl, supabaseKey, supabase;
        
async function inicializarSupabase() {
    try {
        const response = await fetch('/api/supabase-config');
        
                if (response.ok) {
        const config = await response.json();
                    
                    if (config.supabaseUrl && config.supabaseAnonKey) {
                        supabaseUrl = config.supabaseUrl;
                        supabaseKey = config.supabaseAnonKey;
                        supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                        console.log('‚úÖ Supabase configurado com sucesso');
        return true;
                    } else {
                        console.log('‚ö†Ô∏è Configura√ß√µes Supabase incompletas, usando modo offline');
                        return false;
                    }
                } else {
                    console.log('‚ö†Ô∏è Endpoint Supabase n√£o dispon√≠vel, usando modo offline');
                    return false;
                }
    } catch (error) {
                console.log('‚ö†Ô∏è Erro ao configurar Supabase, usando modo offline:', error.message);
        return false;
    }
}

        // ========== VARI√ÅVEIS GLOBAIS ==========
        let allMotoristas = [];
        let selectedMotoristas = new Set();
        let currentClass = null;
        let isDisparoAtivo = false;
        let disparoCancelado = false;
        let totalEnviados = 0;
        let totalFalhas = 0;
        
        // Vari√°veis de pagina√ß√£o otimizada para 20k+ motoristas
let currentPage = 1;
        let itemsPerPage = 100;
        let totalPages = 1;
        let motoristasFiltrados = [];
        let totalMotoristasCount = 0;

        // Estados brasileiros
const estados = [
  'AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA', 
  'MT', 'MS', 'MG', 'PA', 'PB', 'PR', 'PE', 'PI', 'RJ', 'RN', 
  'RS', 'RO', 'RR', 'SC', 'SP', 'SE', 'TO'
];

        // Mapeamentos de tipos de ve√≠culo e carroceria (do cadastro.html)
        const tiposVeiculo = {
            leve: ['3/4', 'Fiorino', 'Toco', 'VLC'],
            medio: ['Bitruck', 'Truck'],
            pesado: ['Bitrem', 'Carreta', 'Carreta LS', 'Rodotrem', 'Vanderleia']
        };

        const tiposCarroceriaMap = {
            bau: 'Ba√∫',
            bau_frigorifico: 'Ba√∫ Frigor√≠fico',
            bau_refrigerado: 'Ba√∫ Refrigerado',
            sider: 'Sider',
            cacamba: 'Ca√ßamba',
            graneleiro: 'Graneleiro',
            plataforma: 'Plataforma',
            prancha: 'Prancha',
            bitrem: 'Bitrem',
            carreta: 'Carreta',
            carreta_ls: 'Carreta LS',
            rodotrem: 'Rodotrem',
            vanderleia: 'Vanderleia',
            apenas_cavalo: 'Apenas Cavalo',
            cegonheiro: 'Cegonheiro',
            gaiola: 'Gaiola',
            tanque: 'Tanque'
        };

        // Fun√ß√£o para normalizar strings (remover acentos e converter para min√∫sculas)
        function normalizarTexto(texto) {
            if (!texto) return '';
            return texto
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remove acentos
                .trim();
        }

        // ========== INICIALIZA√á√ÉO ==========
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Inicializando Painel de Disparo Moderno...');
            
            // üîê Verificar permiss√£o de acesso
            const temPermissao = await verificarEAplicarPermissao('painel');
            if (!temPermissao) {
                console.log('‚ùå Sem permiss√£o para acessar o painel');
                return; // A fun√ß√£o verificarEAplicarPermissao j√° redireciona
            }
            
            // Tentar inicializar Supabase (n√£o cr√≠tico)
            const supabaseOk = await inicializarSupabase();
            if (supabaseOk) {
                console.log('‚úÖ Supabase conectado');
            } else {
                console.log('‚ö†Ô∏è Modo offline - usando dados mockados');
            }
            
            await verificarAutenticacao();
            await carregarEstatisticas();
            await carregarFiltros();
            configurarEventos();
            configurarUploadImagem();
            
            console.log('‚úÖ Painel inicializado com sucesso!');
        });

        // ========== AUTENTICA√á√ÉO ==========
        async function verificarAutenticacao() {
            console.log('üîê Iniciando verifica√ß√£o de autentica√ß√£o no painel...');
            
            try {
                // Primeiro, verificar se h√° dados de usu√°rio no localStorage
                const usuarioLocal = localStorage.getItem('loggedInUser');
                const lastActivity = localStorage.getItem('lastActivity');
                
                console.log('üì¶ Dados do localStorage:', usuarioLocal ? 'Encontrados' : 'N√£o encontrados');
                console.log('üì¶ Conte√∫do do localStorage:', usuarioLocal);
                
                if (usuarioLocal) {
                    let userData;
                    try {
                        userData = JSON.parse(usuarioLocal);
                    } catch (parseError) {
                        console.log('‚ö†Ô∏è Erro ao fazer parse do localStorage, usando como string');
                        userData = { username: usuarioLocal, email: usuarioLocal };
                    }
                    
                    const timeDiff = lastActivity ? Date.now() - parseInt(lastActivity) : 0;
                    const hoursDiff = timeDiff / (1000 * 60 * 60);
                    
                    console.log('üë§ Dados do usu√°rio:', userData);
                    console.log('‚è∞ Idade da sess√£o:', hoursDiff.toFixed(1), 'horas');
                    
                    // Sess√£o v√°lida por 12 horas (ou sem limite se n√£o h√° lastActivity)
                    if (!lastActivity || hoursDiff < 12) {
                        currentUser = userData.username || userData.email || userData;
                        document.getElementById('userName').textContent = currentUser;
                        console.log('‚úÖ Usu√°rio autenticado via localStorage:', currentUser);
                        return;
                    } else {
                        console.log('‚è∞ Sess√£o expirada, removendo dados');
                        localStorage.removeItem('loggedInUser');
                        localStorage.removeItem('lastActivity');
                    }
                }
                
                // Tentar verificar via Supabase se dispon√≠vel
                if (window.supabase) {
                    console.log('üîç Verificando via Supabase...');
                    try {
                        const { data: { session }, error } = await window.supabase.auth.getSession();
                        if (session && session.user) {
                            currentUser = session.user.email;
                    document.getElementById('userName').textContent = currentUser;
                            console.log('‚úÖ Usu√°rio autenticado via Supabase:', currentUser);
                            return;
                } else {
                            console.log('‚ö†Ô∏è Nenhuma sess√£o ativa no Supabase');
                        }
                    } catch (supabaseError) {
                        console.log('‚ö†Ô∏è Erro ao verificar Supabase:', supabaseError);
                    }
                } else {
                    console.log('‚ö†Ô∏è Supabase n√£o dispon√≠vel');
                }
                
                console.log('‚ùå Usu√°rio n√£o autenticado, redirecionando...');
                window.location.href = 'login.html';
                
            } catch (error) {
                console.error('‚ùå Erro na autentica√ß√£o:', error);
                
                // Fallback: tentar usar dados locais se dispon√≠veis
                const usuarioLocal = localStorage.getItem('loggedInUser');
                if (usuarioLocal) {
                    try {
                        const userData = JSON.parse(usuarioLocal);
                        currentUser = userData.username || userData.email || userData;
                    } catch {
                    currentUser = usuarioLocal;
                    }
                    document.getElementById('userName').textContent = currentUser;
                    console.log('‚ö†Ô∏è Usando dados locais devido a erro de rede');
                } else {
                    console.log('‚ùå Redirecionando para login...');
                    window.location.href = 'login.html';
                }
            }
        }

        // ========== CARREGAR ESTAT√çSTICAS (OTIMIZADO PARA 20K+) ==========
        async function carregarEstatisticas() {
            try {
                // Tentar carregar do Supabase com contagem otimizada
                if (supabase) {
                    // Contar total de motoristas
                    const { count: totalCount, error: totalError } = await supabase
                        .from('motoristas')
                        .select('*', { count: 'exact', head: true });

                    if (totalError) throw totalError;
                    
                    // Contar motoristas ativos
                    const { count: ativosCount, error: ativosError } = await supabase
                        .from('motoristas')
                        .select('*', { count: 'exact', head: true })
                        .eq('status', 'ativo');

                    if (ativosError) throw ativosError;

                    // Contar por classe de ve√≠culo
                    const { count: leveCount, error: leveError } = await supabase
                        .from('motoristas')
                        .select('*', { count: 'exact', head: true })
                        .eq('classe_veiculo', 'leve')
                        .eq('status', 'ativo');

                    const { count: medioCount, error: medioError } = await supabase
                        .from('motoristas')
                        .select('*', { count: 'exact', head: true })
                        .eq('classe_veiculo', 'medio')
                        .eq('status', 'ativo');

                    const { count: pesadoCount, error: pesadoError } = await supabase
                        .from('motoristas')
                        .select('*', { count: 'exact', head: true })
                        .eq('classe_veiculo', 'pesado')
                        .eq('status', 'ativo');

                    if (leveError || medioError || pesadoError) {
                        console.warn('‚ö†Ô∏è Erro ao contar por classe, usando valores padr√£o');
                    }
                    
                    totalMotoristasCount = totalCount || 0;
                    const totalAtivos = ativosCount || 0;
                    const leve = leveCount || 0;
                    const medio = medioCount || 0;
                    const pesado = pesadoCount || 0;
                    
                    console.log(`üìä Total de motoristas no Supabase: ${totalMotoristasCount.toLocaleString('pt-BR')}`);
                    console.log(`üìä Motoristas ativos: ${totalAtivos.toLocaleString('pt-BR')}`);
                    console.log(`üìä Por classe - Leve: ${leve}, M√©dio: ${medio}, Pesado: ${pesado}`);
                    
                    // Atualizar interface com dados reais
                    document.getElementById('totalMotoristas').textContent = totalMotoristasCount.toLocaleString('pt-BR');
                    document.getElementById('motoristasAtivos').textContent = totalAtivos.toLocaleString('pt-BR');
                    document.getElementById('motoristasSelecionados').textContent = '0';
                    document.getElementById('categoriaAtiva').textContent = '-';
                    
                    // Atualizar contadores de categoria
                    document.getElementById('count-leve').textContent = `${leve.toLocaleString('pt-BR')} motoristas`;
                    document.getElementById('count-medio').textContent = `${medio.toLocaleString('pt-BR')} motoristas`;
                    document.getElementById('count-pesado').textContent = `${pesado.toLocaleString('pt-BR')} motoristas`;
                    
                } else {
                    // Dados mockados para teste (simulando 20k+ motoristas)
                    totalMotoristasCount = 20150; // Simulando 20k+ motoristas
                    const totalAtivos = 18500; // Simulando 18.5k ativos
                    const leve = 6500; // Simulando distribui√ß√£o
                    const medio = 6000;
                    const pesado = 6000;
                    
                    console.log('üìä Usando dados mockados para teste');
                    
                    // Atualizar interface
                    document.getElementById('totalMotoristas').textContent = totalMotoristasCount.toLocaleString('pt-BR');
                    document.getElementById('motoristasAtivos').textContent = totalAtivos.toLocaleString('pt-BR');
                    document.getElementById('motoristasSelecionados').textContent = '0';
                    document.getElementById('categoriaAtiva').textContent = '-';
                    
                    // Atualizar contadores de categoria
                    document.getElementById('count-leve').textContent = `${leve.toLocaleString('pt-BR')} motoristas`;
                    document.getElementById('count-medio').textContent = `${medio.toLocaleString('pt-BR')} motoristas`;
                    document.getElementById('count-pesado').textContent = `${pesado.toLocaleString('pt-BR')} motoristas`;
                }
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar estat√≠sticas:', error);
                
                // Fallback para dados mockados
                totalMotoristasCount = 1000;
                const totalAtivos = 950;
                const leve = 350;
                const medio = 300;
                const pesado = 300;
                
                document.getElementById('totalMotoristas').textContent = totalMotoristasCount.toLocaleString('pt-BR');
                document.getElementById('motoristasAtivos').textContent = totalAtivos.toLocaleString('pt-BR');
                document.getElementById('motoristasSelecionados').textContent = '0';
                document.getElementById('categoriaAtiva').textContent = '-';
                
                // Atualizar contadores de categoria
                document.getElementById('count-leve').textContent = `${leve.toLocaleString('pt-BR')} motoristas`;
                document.getElementById('count-medio').textContent = `${medio.toLocaleString('pt-BR')} motoristas`;
                document.getElementById('count-pesado').textContent = `${pesado.toLocaleString('pt-BR')} motoristas`;
                
                mostrarAviso('Usando dados de exemplo - Supabase n√£o dispon√≠vel');
            }
        }

        // ========== CARREGAR FILTROS ==========
        async function carregarFiltros() {
            console.log('üîß Carregando filtros...');
            
            // Carregar estados
            const filtroEstado = document.getElementById('filtroEstado');
            if (filtroEstado) {
                estados.forEach(estado => {
                    const option = document.createElement('option');
                    option.value = estado;
                    option.textContent = estado;
                    filtroEstado.appendChild(option);
                });
                
                console.log('‚úÖ Filtro de estados carregado');
            }

            // Carregar tipos de ve√≠culo do backend (distinct via service role)
            const filtroTipoVeiculo = document.getElementById('filtroTipoVeiculo');
            if (filtroTipoVeiculo) {
                try {
                    const resp = await fetch('/api/filtros/motoristas/tipos');
                    if (resp.ok) {
                        const json = await resp.json();
                        (json.tipos || []).forEach(tipo => {
                            const option = document.createElement('option');
                            option.value = tipo;
                            option.textContent = tipo;
                            filtroTipoVeiculo.appendChild(option);
                        });
                        console.log('‚úÖ Filtro de tipos de ve√≠culo carregado:', (json.tipos||[]).length);
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao carregar tipos de ve√≠culo:', error.message);
                }
                
                console.log('‚úÖ Filtro de tipos de ve√≠culo carregado');
            }

            // Carregar carrocerias do backend (distinct via service role)
            const filtroCarroceria = document.getElementById('filtroCarroceria');
            if (filtroCarroceria) {
                try {
                    const resp = await fetch('/api/filtros/motoristas/carrocerias');
                    if (resp.ok) {
                        const json = await resp.json();
                        const valores = new Set((json.carrocerias||[]).map(v => (v||'').trim()).filter(Boolean));
                        // Unir com lista padronizada do cadastro (mesma "m√°scara")
                        Object.values(tiposCarroceriaMap||{}).forEach(lbl => { if(lbl) valores.add(lbl); });
                        // Garantir presen√ßa expl√≠cita dessas op√ß√µes
                        ['BASCULANTE','PORTA CONTAINER 20','PORTA CONTAINER 40','PORTA CONTAINER20/40'].forEach(v=>valores.add(v));
                        const listaOrdenada = Array.from(valores).sort((a,b)=> a.localeCompare(b,'pt-BR'));
                        listaOrdenada.forEach(valorOriginal => {
                            const option = document.createElement('option');
                            option.value = valorOriginal;
                            option.textContent = valorOriginal;
                            filtroCarroceria.appendChild(option);
                        });
                        console.log('‚úÖ Filtro de carrocerias carregado com', listaOrdenada.length, 'op√ß√µes');
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao carregar carrocerias:', error.message);
                }
            }
        }

        // ========== CONFIGURAR EVENTOS ==========
        function configurarEventos() {
            // Sele√ß√£o de classes de ve√≠culo
            document.querySelectorAll('.vehicle-class').forEach(element => {
                element.addEventListener('click', () => {
                    const classe = element.dataset.class;
                    selecionarClasse(classe);
                });
            });

            // Bot√µes de a√ß√£o
            document.getElementById('btnSelecionarTodos').addEventListener('click', selecionarTodos);
            document.getElementById('btnSelecionarPagina').addEventListener('click', selecionarPaginaAtual);
            document.getElementById('btnLimparSelecao').addEventListener('click', limparSelecao);
            document.getElementById('btnTestarMensagem').addEventListener('click', testarMensagem);
            document.getElementById('btnTestarEnvio').addEventListener('click', testarEnvioReal);
            document.getElementById('btnIniciarDisparo').addEventListener('click', iniciarDisparo);
            document.getElementById('btnPararDisparo').addEventListener('click', pararDisparo);
            document.getElementById('btnBuscar').addEventListener('click', aplicarFiltros);
            document.getElementById('btnVerificarEvolution').addEventListener('click', verificarEvolutionAPI);

            // Filtros
            document.getElementById('filtroClasse').addEventListener('change', aplicarFiltros);
            document.getElementById('filtroTipoVeiculo').addEventListener('change', aplicarFiltros);
            document.getElementById('filtroCarroceria').addEventListener('change', aplicarFiltros);
            document.getElementById('filtroEstado').addEventListener('change', aplicarFiltros);
            document.getElementById('filtroStatus').addEventListener('change', aplicarFiltros);
            document.getElementById('filtroBusca').addEventListener('input', aplicarFiltros);

            // Pagina√ß√£o
            document.getElementById('itensPorPagina').addEventListener('change', (e) => {
                itemsPerPage = parseInt(e.target.value);
                currentPage = 1;
                atualizarListaMotoristas(motoristasFiltrados);
            });

            console.log('‚úÖ Eventos configurados');
        }

        // ========== SELE√á√ÉO DE CLASSE ==========
        async function selecionarClasse(classe) {
            currentClass = classe;
            selectedMotoristas.clear();

            // Atualizar interface
            document.querySelectorAll('.vehicle-class').forEach(el => el.classList.remove('active'));
            document.querySelector(`[data-class="${classe}"]`).classList.add('active');
            
            document.getElementById('categoriaAtiva').textContent = classe.charAt(0).toUpperCase() + classe.slice(1);
            
            // Carregar motoristas da classe (otimizado para 20k+)
            await carregarMotoristas(classe);
        }

        // ========== CARREGAR MOTORISTAS (OTIMIZADO PARA 20K+) ==========
        async function carregarMotoristas(classe) {
            const motoristasList = document.getElementById('motoristasList');
            motoristasList.innerHTML = '<div class="text-center py-3"><div class="loading-spinner me-2"></div>Carregando motoristas...</div>';

            try {
                let todosMotoristas = [];
                
                // Tentar carregar do Supabase com pagina√ß√£o otimizada
                if (supabase) {
                    console.log(`üîç Carregando TODOS os motoristas da classe ${classe}...`);
                    
                    // Carregar TODOS os motoristas da classe (sem limite)
                    let from = 0;
                    const limit = 1000; // Carregar em lotes de 1000
                    let hasMore = true;
                    
                    while (hasMore) {
                        const { data: motoristas, error } = await supabase
                            .from('motoristas')
                            .select('id, nome, telefone1, telefone2, estado, classe_veiculo, tipo_veiculo, tipo_carroceria, status')
                            .eq('classe_veiculo', classe)
                            .eq('status', 'ativo')
                            .order('nome')
                            .range(from, from + limit - 1);

                        if (error) throw error;
                        
                        if (motoristas && motoristas.length > 0) {
                            todosMotoristas = todosMotoristas.concat(motoristas);
                            from += limit;
                            
                            // Atualizar progresso
                            motoristasList.innerHTML = `<div class="text-center py-3"><div class="loading-spinner me-2"></div>Carregando motoristas... ${todosMotoristas.length.toLocaleString('pt-BR')} encontrados</div>`;
                            
                            // Se retornou menos que o limite, n√£o h√° mais dados
                            if (motoristas.length < limit) {
                                hasMore = false;
                            }
                        } else {
                            hasMore = false;
                        }
                    }
                    
                    console.log(`üìû ${todosMotoristas.length.toLocaleString('pt-BR')} motoristas carregados para classe ${classe}`);
                } else {
                    // Usar dados mockados filtrados por classe
                    todosMotoristas = allMotoristas.filter(m => m.classe_veiculo === classe && m.status === 'ativo');
                }
                
                // Armazenar todos os motoristas filtrados
                motoristasFiltrados = todosMotoristas;
                currentPage = 1;
                
                // Atualizar estat√≠sticas
                document.getElementById('motoristasSelecionados').textContent = '0';
                document.getElementById('motoristasSelecionadosBadge').textContent = '0 selecionados';
                
                atualizarListaMotoristas(motoristasFiltrados);
                
            } catch (error) {
                console.error('‚ùå Erro ao carregar motoristas:', error);
                
                // Fallback para dados mockados
                motoristasFiltrados = allMotoristas.filter(m => m.classe_veiculo === classe && m.status === 'ativo');
                currentPage = 1;
                document.getElementById('motoristasSelecionados').textContent = '0';
                document.getElementById('motoristasSelecionadosBadge').textContent = '0 selecionados';
                atualizarListaMotoristas(motoristasFiltrados);
                
                mostrarAviso('Usando dados de exemplo - Supabase n√£o dispon√≠vel');
            }
        }

        // ========== ATUALIZAR LISTA DE MOTORISTAS (OTIMIZADA) ==========
        function atualizarListaMotoristas(motoristas) {
            const motoristasList = document.getElementById('motoristasList');
            
            if (motoristas.length === 0) {
                motoristasList.innerHTML = '<div class="text-center py-5"><i class="fas fa-truck fs-1 text-muted mb-3"></i><p class="text-muted">Nenhum motorista encontrado para esta categoria</p></div>';
                atualizarPaginacao(0);
                return;
            }

            // Calcular pagina√ß√£o
            totalPages = Math.ceil(motoristas.length / itemsPerPage);
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const motoristasPagina = motoristas.slice(startIndex, endIndex);

            motoristasList.innerHTML = motoristasPagina.map(motorista => `
                <div class="motorista-item ${selectedMotoristas.has(motorista.id) ? 'selected' : ''}" data-id="${motorista.id}">
                    <div class="motorista-info">
                        <h6>${motorista.nome || 'Nome n√£o informado'}</h6>
                        <div class="motorista-details">
                            <i class="fas fa-phone me-1"></i>${motorista.telefone1 || 'Telefone n√£o informado'}
                            ${motorista.telefone2 ? `<br><i class="fas fa-mobile-alt me-1"></i>${motorista.telefone2}` : ''}
                            ${motorista.estado ? `<br><i class="fas fa-map-marker-alt me-1"></i>${motorista.estado}` : ''}
                            ${motorista.tipo_veiculo ? `<br><i class="fas fa-truck me-1"></i>${motorista.tipo_veiculo}` : ''}
                            ${motorista.tipo_carroceria ? `<br><i class="fas fa-box me-1"></i>${tiposCarroceriaMap[motorista.tipo_carroceria] || motorista.tipo_carroceria}` : ''}
                        </div>
                    </div>
                    <div class="motorista-checkbox ${selectedMotoristas.has(motorista.id) ? 'checked' : ''}">
                        ${selectedMotoristas.has(motorista.id) ? '<i class="fas fa-check"></i>' : ''}
                    </div>
                </div>
            `).join('');

            // Adicionar eventos de clique
            motoristasList.querySelectorAll('.motorista-item').forEach(item => {
                item.addEventListener('click', () => {
                    const id = item.dataset.id;
                    toggleSelecaoMotorista(id);
                });
            });

            // Atualizar pagina√ß√£o
            atualizarPaginacao(motoristas.length);
        }

        // ========== TOGGLE SELE√á√ÉO DE MOTORISTA ==========
        function toggleSelecaoMotorista(id) {
            if (selectedMotoristas.has(id)) {
                selectedMotoristas.delete(id);
            } else {
                selectedMotoristas.add(id);
            }
            
            // Atualizar interface
            const item = document.querySelector(`[data-id="${id}"]`);
            if (item) {
                item.classList.toggle('selected');
                const checkbox = item.querySelector('.motorista-checkbox');
                checkbox.classList.toggle('checked');
                checkbox.innerHTML = selectedMotoristas.has(id) ? '<i class="fas fa-check"></i>' : '';
            }
            
            // Atualizar contadores
            atualizarContadorSelecionados();
        }

        // ========== SELECIONAR TODOS ==========
        function selecionarTodos() {
            // Selecionar TODOS os motoristas filtrados
            motoristasFiltrados.forEach(motorista => {
                selectedMotoristas.add(motorista.id);
            });
            
            atualizarListaMotoristas(motoristasFiltrados);
            atualizarContadorSelecionados();
        }

        // ========== SELECIONAR P√ÅGINA ATUAL ==========
        function selecionarPaginaAtual() {
            // Selecionar apenas os motoristas da p√°gina atual
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const motoristasPagina = motoristasFiltrados.slice(startIndex, endIndex);
            
            motoristasPagina.forEach(motorista => {
                selectedMotoristas.add(motorista.id);
            });
            
            atualizarListaMotoristas(motoristasFiltrados);
            atualizarContadorSelecionados();
        }

        // ========== ATUALIZAR CONTADOR DE SELECIONADOS ==========
        function atualizarContadorSelecionados() {
            const total = selectedMotoristas.size;
            document.getElementById('motoristasSelecionados').textContent = total.toLocaleString('pt-BR');
            document.getElementById('motoristasSelecionadosBadge').textContent = `${total.toLocaleString('pt-BR')} selecionados`;
        }

        // ========== LIMPAR SELE√á√ÉO ==========
        function limparSelecao() {
            selectedMotoristas.clear();
            atualizarListaMotoristas(motoristasFiltrados);
            atualizarContadorSelecionados();
        }

        // ========== APLICAR FILTROS (INTELIGENTE) ==========
        async function aplicarFiltros() {
            if (!currentClass) {
                mostrarAviso('Selecione uma categoria primeiro');
                return;
            }

            const filtroClasse = document.getElementById('filtroClasse').value;
            const filtroTipoVeiculo = document.getElementById('filtroTipoVeiculo').value;
            const filtroCarroceria = document.getElementById('filtroCarroceria').value;
            const filtroEstado = document.getElementById('filtroEstado').value;
            const filtroStatus = document.getElementById('filtroStatus').value;
            const filtroBusca = document.getElementById('filtroBusca').value.toLowerCase();

            console.log('üîç Aplicando filtros inteligentes...', {
                classe: filtroClasse,
                tipoVeiculo: filtroTipoVeiculo,
                carroceria: filtroCarroceria,
                estado: filtroEstado,
                status: filtroStatus,
                busca: filtroBusca
            });

            const motoristasList = document.getElementById('motoristasList');
            motoristasList.innerHTML = '<div class="text-center py-3"><div class="loading-spinner me-2"></div>Aplicando filtros...</div>';

            try {
                let todosMotoristas = [];
                
                if (supabase) {
                    // Determinar classe a usar: filtro do select tem prioridade sobre currentClass
                    const classeParaFiltro = filtroClasse || currentClass;
                    
                    if (!classeParaFiltro) {
                        mostrarAviso('Selecione uma categoria primeiro');
                        return;
                    }
                    
                    // Construir query do Supabase com filtros
                    let query = supabase
                        .from('motoristas')
                        .select('id, nome, telefone1, telefone2, estado, classe_veiculo, tipo_veiculo, tipo_carroceria, status')
                        .eq('classe_veiculo', classeParaFiltro);

                    // Aplicar filtro de status (se n√£o houver filtro, n√£o aplicar nenhum filtro de status)
                    if (filtroStatus) {
                        query = query.eq('status', filtroStatus);
                    }
                    // Se n√£o houver filtro de status especificado, n√£o filtrar por status

                    // N√ÉO aplicar filtros de tipo_veiculo e carroceria no Supabase
                    // Faremos isso client-side para garantir normaliza√ß√£o de mai√∫sculas/min√∫sculas e acentos
                    // Se aplicarmos aqui, pode n√£o funcionar quando banco tem "carreta" e filtro tem "Carreta"
                    // ou "bau" e filtro tem "Ba√∫"
                    
                    if (filtroEstado) {
                        query = query.eq('estado', filtroEstado);
                    }

                    // Para busca por nome/telefone, usar ilike
                    if (filtroBusca) {
                        query = query.or(`nome.ilike.%${filtroBusca}%,telefone1.ilike.%${filtroBusca}%,telefone2.ilike.%${filtroBusca}%`);
                    }

                    query = query.order('nome');

                    // Carregar TODOS os resultados filtrados
                    let from = 0;
                    const limit = 1000;
                    let hasMore = true;
                    
                    while (hasMore) {
                        const { data: motoristas, error } = await query.range(from, from + limit - 1);

                        if (error) throw error;
                        
                        if (motoristas && motoristas.length > 0) {
                            todosMotoristas = todosMotoristas.concat(motoristas);
                            from += limit;
                            
                            // Atualizar progresso
                            motoristasList.innerHTML = `<div class="text-center py-3"><div class="loading-spinner me-2"></div>Aplicando filtros... ${todosMotoristas.length.toLocaleString('pt-BR')} encontrados</div>`;
                            
                            if (motoristas.length < limit) {
                                hasMore = false;
                            }
                        } else {
                            hasMore = false;
                        }
                    }
                    
                    // Aplicar filtros de tipo de ve√≠culo e carroceria client-side para garantir normaliza√ß√£o
                    // Isso garante que funcione mesmo se o banco tiver "carreta" e o filtro "Carreta"
                    // ou "bau" e o filtro "Ba√∫"
                    if (filtroTipoVeiculo) {
                        const filtroNormalizado = normalizarTexto(filtroTipoVeiculo);
                        console.log('üîç Filtrando tipo de ve√≠culo:', {
                            filtroOriginal: filtroTipoVeiculo,
                            filtroNormalizado: filtroNormalizado,
                            totalAntes: todosMotoristas.length
                        });
                        
                        const antes = todosMotoristas.length;
                        todosMotoristas = todosMotoristas.filter(motorista => {
                            const tipoVeiculoMotorista = normalizarTexto(motorista.tipo_veiculo || '');
                            const match = tipoVeiculoMotorista.includes(filtroNormalizado) || 
                                         filtroNormalizado.includes(tipoVeiculoMotorista) ||
                                         tipoVeiculoMotorista === filtroNormalizado;
                            
                            if (!match && motorista.tipo_veiculo && filtroNormalizado) {
                                console.log('‚ùå Tipo ve√≠culo n√£o match:', {
                                    original: motorista.tipo_veiculo,
                                    normalizado: tipoVeiculoMotorista,
                                    filtro: filtroNormalizado
                                });
                            }
                            
                            return match;
                        });
                        
                        console.log(`‚úÖ Filtro de tipo de ve√≠culo: ${antes} ‚Üí ${todosMotoristas.length} motoristas`);
                    }
                    
                    if (filtroCarroceria) {
                        const filtroNormalizado = normalizarTexto(filtroCarroceria);
                        console.log('üîç Filtrando carroceria:', {
                            filtroOriginal: filtroCarroceria,
                            filtroNormalizado: filtroNormalizado,
                            totalAntes: todosMotoristas.length
                        });
                        
                        const antes = todosMotoristas.length;
                        todosMotoristas = todosMotoristas.filter(motorista => {
                            const carroceriaMotorista = normalizarTexto(motorista.tipo_carroceria || '');
                            
                            // Verificar se carroceria cont√©m o filtro OU se o filtro cont√©m a carroceria
                            // Isso garante que funcione para casos como:
                            // - Banco: "bau", Filtro: "Ba√∫" ‚Üí carroceria.includes("bau") = true
                            // - Banco: "Ba√∫ Frigor√≠fico", Filtro: "bau" ‚Üí carroceria.includes("bau") = true
                            const match = carroceriaMotorista.includes(filtroNormalizado) || 
                                         filtroNormalizado.includes(carroceriaMotorista) ||
                                         carroceriaMotorista === filtroNormalizado;
                            
                            if (!match && motorista.tipo_carroceria && filtroNormalizado) {
                                console.log('‚ùå N√£o match:', {
                                    original: motorista.tipo_carroceria,
                                    normalizado: carroceriaMotorista,
                                    filtro: filtroNormalizado,
                                    inclui: carroceriaMotorista.includes(filtroNormalizado),
                                    filtroIncluiCarroceria: filtroNormalizado.includes(carroceriaMotorista)
                                });
                            }
                            
                            return match;
                        });
                        
                        console.log(`‚úÖ Filtro de carroceria: ${antes} ‚Üí ${todosMotoristas.length} motoristas`);
                    }
                    
                    console.log(`üîç ${todosMotoristas.length.toLocaleString('pt-BR')} motoristas encontrados com filtros aplicados`);
                } else {
                    // Usar dados mockados com filtros locais
                    // Determinar classe a usar: filtro do select tem prioridade sobre currentClass
                    const classeParaFiltro = filtroClasse || currentClass;
                    
                    todosMotoristas = allMotoristas.filter(motorista => {
                        // Filtro de classe (usar filtroClasse se existir, sen√£o currentClass)
                        if (classeParaFiltro && motorista.classe_veiculo !== classeParaFiltro) return false;
                        
                        // Filtro de tipo de ve√≠culo (tolerante, case-insensitive, sem acentos)
                        if (filtroTipoVeiculo) {
                            const tipoVeiculoMotorista = normalizarTexto(motorista.tipo_veiculo || '');
                            const filtroNormalizado = normalizarTexto(filtroTipoVeiculo);
                            
                            // Verificar se tipo cont√©m o filtro OU se o filtro cont√©m o tipo
                            const match = tipoVeiculoMotorista.includes(filtroNormalizado) || 
                                         filtroNormalizado.includes(tipoVeiculoMotorista) ||
                                         tipoVeiculoMotorista === filtroNormalizado;
                            
                            if (!match) return false;
                        }
                        
                        // Filtro de carroceria (tolerante, cont√©m, case-insensitive, sem acentos)
                        if (filtroCarroceria) {
                            const carroceriaMotorista = normalizarTexto(motorista.tipo_carroceria || '');
                            const filtroNormalizado = normalizarTexto(filtroCarroceria);
                            
                            // Verificar se carroceria cont√©m o filtro OU se o filtro cont√©m a carroceria
                            const match = carroceriaMotorista.includes(filtroNormalizado) || 
                                         filtroNormalizado.includes(carroceriaMotorista) ||
                                         carroceriaMotorista === filtroNormalizado;
                            
                            if (!match) return false;
                        }
                        
                        // Filtro de estado
                        if (filtroEstado && motorista.estado !== filtroEstado) return false;
                        
                        // Filtro de status (se n√£o houver filtro, n√£o filtrar)
                        if (filtroStatus && motorista.status !== filtroStatus) return false;
                        
                        // Filtro de busca
                        if (filtroBusca) {
                            const nome = (motorista.nome || '').toLowerCase();
                            const telefone1 = (motorista.telefone1 || '').toLowerCase();
                            const telefone2 = (motorista.telefone2 || '').toLowerCase();
                            
                            if (!nome.includes(filtroBusca) && !telefone1.includes(filtroBusca) && !telefone2.includes(filtroBusca)) {
                                return false;
                            }
                        }
                        
                        return true;
                    });
                }
                
                // Armazenar resultados filtrados
                motoristasFiltrados = todosMotoristas;
                currentPage = 1;
                
                // Atualizar estat√≠sticas
                document.getElementById('motoristasSelecionados').textContent = '0';
                document.getElementById('motoristasSelecionadosBadge').textContent = '0 selecionados';
                
                atualizarListaMotoristas(motoristasFiltrados);
                
            } catch (error) {
                console.error('‚ùå Erro ao aplicar filtros:', error);
                
                // Fallback para filtros locais
                const classeParaFiltro = filtroClasse || currentClass;
                motoristasFiltrados = allMotoristas.filter(m => {
                    if (classeParaFiltro && m.classe_veiculo !== classeParaFiltro) return false;
                    // N√£o filtrar por status no fallback, mostrar todos
                    return true;
                });
                currentPage = 1;
                atualizarListaMotoristas(motoristasFiltrados);
                
                mostrarAviso('Erro ao aplicar filtros, usando dados locais');
            }
        }

        // ========== PAGINA√á√ÉO OTIMIZADA E INTELIGENTE ==========
        function atualizarPaginacao(totalItens) {
            const paginacao = document.getElementById('paginacao');
            const infoPagina = document.getElementById('infoPagina');
            
            // Limpar pagina√ß√£o anterior
            paginacao.innerHTML = '';
            
            if (totalItens === 0) {
                infoPagina.textContent = 'P√°gina 1 de 1 - Total: 0 motoristas';
                return;
            }

            // Calcular informa√ß√µes da p√°gina
            const inicio = (currentPage - 1) * itemsPerPage + 1;
            const fim = Math.min(currentPage * itemsPerPage, totalItens);
            const porcentagem = ((fim / totalItens) * 100).toFixed(1);
            
            // Informa√ß√µes detalhadas da p√°gina
            infoPagina.innerHTML = `
                <strong>P√°gina ${currentPage} de ${totalPages}</strong> - 
                Mostrando <strong>${inicio.toLocaleString('pt-BR')}-${fim.toLocaleString('pt-BR')}</strong> de 
                <strong>${totalItens.toLocaleString('pt-BR')}</strong> motoristas 
                <span class="text-muted">(${porcentagem}%)</span>
            `;

            // Bot√£o Anterior
            const btnAnterior = document.createElement('li');
            const isAnteriorDisabled = currentPage === 1;
            btnAnterior.innerHTML = `<a class="page-btn ${isAnteriorDisabled ? 'disabled' : ''}" href="#" onclick="return ${isAnteriorDisabled ? 'false' : `mudarPagina(${currentPage - 1})`};"><i class="fas fa-chevron-left me-1"></i>Anterior</a>`;
            paginacao.appendChild(btnAnterior);

            // P√°ginas numeradas (otimizado para muitas p√°ginas)
            const inicioPagina = Math.max(1, currentPage - 2);
            const fimPagina = Math.min(totalPages, currentPage + 2);

            // Primeira p√°gina
            if (inicioPagina > 1) {
                const li = document.createElement('li');
                li.innerHTML = `<a class="page-btn" href="#" onclick="mudarPagina(1)">1</a>`;
                paginacao.appendChild(li);
                
                if (inicioPagina > 2) {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="page-btn disabled"><i class="fas fa-ellipsis-h"></i></span>`;
                    paginacao.appendChild(li);
                }
            }

            // P√°ginas do meio
            for (let i = inicioPagina; i <= fimPagina; i++) {
                const li = document.createElement('li');
                li.innerHTML = `<a class="page-btn ${i === currentPage ? 'active' : ''}" href="#" onclick="mudarPagina(${i})">${i}</a>`;
                paginacao.appendChild(li);
            }

            // √öltima p√°gina
            if (fimPagina < totalPages) {
                if (fimPagina < totalPages - 1) {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="page-btn disabled"><i class="fas fa-ellipsis-h"></i></span>`;
                    paginacao.appendChild(li);
                }
                
                const li = document.createElement('li');
                li.innerHTML = `<a class="page-btn" href="#" onclick="mudarPagina(${totalPages})">${totalPages}</a>`;
                paginacao.appendChild(li);
            }

            // Bot√£o Pr√≥ximo
            const btnProximo = document.createElement('li');
            const isProximoDisabled = currentPage === totalPages;
            btnProximo.innerHTML = `<a class="page-btn ${isProximoDisabled ? 'disabled' : ''}" href="#" onclick="return ${isProximoDisabled ? 'false' : `mudarPagina(${currentPage + 1})`};"><i class="fas fa-chevron-right ms-1"></i>Pr√≥ximo</a>`;
            paginacao.appendChild(btnProximo);

            // Adicionar informa√ß√µes extras se houver muitos resultados
            if (totalItens > 10000) {
                const infoExtra = document.createElement('div');
                infoExtra.className = 'mt-2 text-center';
                infoExtra.innerHTML = `
                    <small class="text-muted">
                        <i class="fas fa-info-circle me-1"></i>
                        Sistema otimizado para ${totalItens.toLocaleString('pt-BR')} motoristas
                    </small>
                `;
                paginacao.parentNode.appendChild(infoExtra);
            }
        }

        function mudarPagina(pagina) {
            if (pagina < 1 || pagina > totalPages) return;
            
            currentPage = pagina;
            atualizarListaMotoristas(motoristasFiltrados);
        }

        let imagemSelecionada = null;
        let imagemPreviewUrl = null;

        function resetarImagem() {
            const input = document.getElementById('imageInput');
            const preview = document.getElementById('imagePreview');
            if (input) input.value = '';
            if (preview) preview.style.display = 'none';
            imagemSelecionada = null;
            if (imagemPreviewUrl) {
                URL.revokeObjectURL(imagemPreviewUrl);
                imagemPreviewUrl = null;
            }
        }

        function configurarUploadImagem() {
            const input = document.getElementById('imageInput');
            const btnRemove = document.getElementById('btnRemoveImage');

            if (!input || !btnRemove) return;

            const processFile = (file) => {
                if (!file) return;
                const maxSize = 5 * 1024 * 1024; // 5MB
                if (!file.type.startsWith('image/')) {
                    mostrarAviso('Selecione um arquivo de imagem v√°lido (jpg, png, webp).');
                    return;
                }
                if (file.size > maxSize) {
                    mostrarAviso('A imagem deve ter no m√°ximo 5MB.');
                    return;
                }

                imagemSelecionada = file;
                if (imagemPreviewUrl) {
                    URL.revokeObjectURL(imagemPreviewUrl);
                }
                imagemPreviewUrl = URL.createObjectURL(file);

                const preview = document.getElementById('imagePreview');
                const previewImg = document.getElementById('previewImg');
                const imageName = document.getElementById('imageName');
                if (preview && previewImg && imageName) {
                    previewImg.src = imagemPreviewUrl;
                    imageName.textContent = `${file.name} (${(file.size/1024).toFixed(1)} KB)`;
                    preview.style.display = 'block';
                }
            };

            input.addEventListener('change', (e) => processFile(e.target.files[0]));

            btnRemove.addEventListener('click', (e) => {
                e.preventDefault();
                resetarImagem();
            });
        }

        // ========== TESTAR MENSAGEM ==========
        function testarMensagem() {
            const mensagem = document.getElementById('messageText').value;
            
            if (!mensagem.trim()) {
                mostrarAviso('Digite uma mensagem para testar');
    return;
  }
  
            // Usar dados de exemplo
            const exemplo = {
                name: 'Jo√£o Silva',
                telefone: '11999999999',
                estado: 'SP',
                classe_veiculo: currentClass || 'leve',
                tipo_veiculo: 'Toco'
            };

            const mensagemTeste = mensagem
                .replace(/\{\{name\}\}/g, exemplo.name)
                .replace(/\{\{telefone\}\}/g, exemplo.telefone)
                .replace(/\{\{estado\}\}/g, exemplo.estado)
                .replace(/\{\{classe_veiculo\}\}/g, exemplo.classe_veiculo)
                .replace(/\{\{tipo_veiculo\}\}/g, exemplo.tipo_veiculo);

            mostrarSucesso(`Mensagem de teste:<br><br>"${mensagemTeste}"`);
        }

        // ========== TESTAR ENVIO REAL ==========
        async function testarEnvioReal() {
            const telefone = document.getElementById('telefoneTeste').value.trim();
            const mensagem = document.getElementById('messageText').value.trim();
            const imageFile = imagemSelecionada;
            
            if (!telefone) {
                mostrarAviso('Digite um n√∫mero de telefone para teste');
    return;
  }
  
            if (!mensagem) {
                mostrarAviso('Digite uma mensagem para enviar');
    return;
  }
  
            // Personalizar mensagem
            const mensagemPersonalizada = mensagem
                .replace(/\{\{name\}\}/g, 'Motorista Teste')
                .replace(/\{\{telefone\}\}/g, telefone)
                .replace(/\{\{estado\}\}/g, 'SP')
                .replace(/\{\{classe_veiculo\}\}/g, currentClass || 'leve')
                .replace(/\{\{tipo_veiculo\}\}/g, 'Toco');

            try {
                adicionarLog(`üîÑ Enviando teste para ${telefone}...`, 'info');
                if (imageFile) {
                    adicionarLog(`üñºÔ∏è Imagem anexada: ${imageFile.name}`, 'info');
                }
                
                // Buscar credenciais da Evolution API do usu√°rio logado
                const userData = localStorage.getItem('loggedInUser');
                let userEmail = null;
                let userId = null;
                
                if (userData) {
                    const user = JSON.parse(userData);
                    userEmail = user.email;
                    userId = user.id; // ‚úÖ Usar ID do localStorage
                    console.log('üë§ Usu√°rio identificado para teste:', userEmail);
                    console.log('üÜî User ID:', userId);
                } else {
                    mostrarErro('Usu√°rio n√£o autenticado. Fa√ßa login novamente.');
                    return;
                }
                
                // Enviar via Evolution API usando credenciais do usu√°rio
                const formData = new FormData();
                formData.append('number', telefone);
                formData.append('message', mensagemPersonalizada);
                formData.append('usuario', userEmail);
                formData.append('userId', userId);
                if (imageFile) {
                    formData.append('media', imageFile);
                }

                const response = await fetch('/webhook/send-supabase', {
                    method: 'POST',
                    body: formData
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                    adicionarLog(`‚úÖ Teste enviado com sucesso para ${telefone}`, 'success');
                    if (imageFile) {
                        adicionarLog(`üñºÔ∏è Imagem enviada: ${imageFile.name}`, 'info');
                    }
                        adicionarLog(`üè∑Ô∏è Inst√¢ncia usada: ${data.instancia || 'N/A'}`, 'info');
                        mostrarSucesso(`Mensagem de teste enviada para ${telefone}`);
            } else {
                        adicionarLog(`‚ùå Erro no teste: ${data.error || data.message}`, 'danger');
                        if (data.solution) {
                            adicionarLog(`üí° Solu√ß√£o: ${data.solution}`, 'warning');
                        }
                        mostrarErro(`Erro ao enviar teste: ${data.error || data.message}`);
          }
        } else {
                    const error = await response.text();
                    adicionarLog(`‚ùå Erro HTTP ${response.status}: ${error}`, 'danger');
                    mostrarErro(`Erro ao enviar teste: HTTP ${response.status}`);
                }
      } catch (error) {
                adicionarLog(`‚ùå Erro no teste: ${error.message}`, 'danger');
                mostrarErro(`Erro ao enviar teste: ${error.message}`);
            }
        }

        // ========== VERIFICAR EVOLUTION API ==========
        async function verificarEvolutionAPI() {
            const evolutionLog = document.getElementById('evolutionLog');
            evolutionLog.innerHTML = '<div class="text-center py-3"><div class="loading-spinner me-2"></div>Verificando Evolution API...</div>';

            try {
                // Buscar email do usu√°rio logado
                const userData = localStorage.getItem('loggedInUser');
                let userEmail = null;
                
                if (userData) {
                    const user = JSON.parse(userData);
                    userEmail = user.email;
                    console.log('üë§ Verificando Evolution API para usu√°rio:', userEmail);
                }
                
                // Verificar status da Evolution API (endpoint alternativo)
                const url = userEmail 
                    ? `/webhook/status-evolution?usuario=${encodeURIComponent(userEmail)}`
                    : '/webhook/status-evolution';
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    if (data.success) {
                        adicionarLogEvolution(`‚úÖ Evolution API conectada`, 'success');
                        adicionarLogEvolution(`üìä Status: ${data.status}`, 'info');
                        adicionarLogEvolution(`üîó URL: ${data.url}`, 'info');
                        adicionarLogEvolution(`üì± Inst√¢ncia: ${data.instance}`, 'info');
                        adicionarLogEvolution(`üí¨ ${data.message}`, 'success');
                    } else {
                        adicionarLogEvolution(`‚ùå Evolution API com problemas`, 'warning');
                        adicionarLogEvolution(`üìä Status: ${data.status}`, 'warning');
                        adicionarLogEvolution(`üîó URL: ${data.url}`, 'info');
                        adicionarLogEvolution(`üì± Inst√¢ncia: ${data.instance}`, 'info');
                        adicionarLogEvolution(`‚ùå Erro: ${data.error}`, 'danger');
                        adicionarLogEvolution(`üí¨ ${data.message}`, 'warning');
                    }
    } else {
                    const error = await response.text();
                    adicionarLogEvolution(`‚ùå Erro HTTP ${response.status}`, 'danger');
                    adicionarLogEvolution(`üí¨ ${error}`, 'danger');
                }
  } catch (error) {
                adicionarLogEvolution(`‚ùå Erro de conex√£o: ${error.message}`, 'danger');
                adicionarLogEvolution(`üí¨ Verifique se o servidor est√° rodando`, 'warning');
            }
        }

        function adicionarLogEvolution(mensagem, tipo = 'info') {
            const log = document.getElementById('evolutionLog');
            const timestamp = new Date().toLocaleTimeString();
            
            const logItem = document.createElement('div');
            logItem.className = `alert alert-modern alert-modern-${tipo} mb-2`;
            logItem.innerHTML = `<small>${timestamp}</small> - ${mensagem}`;
            
            log.appendChild(logItem);
            log.scrollTop = log.scrollHeight;
        }

        // ========== FUN√á√ÉO PARA AGUARDAR COM CONTADOR ==========
        async function aguardarComContador(segundos) {
            const delayCounterContainer = document.getElementById('delayCounterContainer');
            const delayCounter = document.getElementById('delayCounter');
            let tempoRestante = segundos;

            // Exibir contador
            delayCounterContainer.style.display = 'block';
            delayCounter.textContent = tempoRestante;

            // Atualizar contador a cada segundo
            while (tempoRestante > 0 && !disparoCancelado) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                if (disparoCancelado) break;
                tempoRestante--;
                delayCounter.textContent = tempoRestante;
            }

            // Ocultar contador
            delayCounterContainer.style.display = 'none';
        }

        // ========== PARAR DISPARO ==========
        function pararDisparo() {
            disparoCancelado = true;
            isDisparoAtivo = false;
            
            // Ocultar contador se estiver vis√≠vel
            document.getElementById('delayCounterContainer').style.display = 'none';
            
            // Atualizar interface
            document.getElementById('btnIniciarDisparo').disabled = false;
            document.getElementById('btnIniciarDisparo').innerHTML = '<i class="fas fa-rocket me-2"></i>Iniciar Disparo';
            document.getElementById('btnPararDisparo').style.display = 'none';
            
            adicionarLog(`‚èπÔ∏è Disparo cancelado pelo usu√°rio! Enviados: ${totalEnviados}, Falhas: ${totalFalhas}`, 'warning');
            mostrarAviso(`Disparo cancelado!<br>Enviados: ${totalEnviados}<br>Falhas: ${totalFalhas}`);
        }

        // ========== GERAR DELAY ALEAT√ìRIO ==========
        function gerarDelayAleatorio() {
            const min = 20; // 20 segundos
            const max = 80; // 80 segundos
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // ========== INICIAR DISPARO ==========
        async function iniciarDisparo() {
            if (!currentClass) {
                mostrarAviso('Selecione uma categoria primeiro');
                return;
            }

            if (selectedMotoristas.size === 0) {
                mostrarAviso('Selecione pelo menos um motorista');
                return;
            }

            const mensagem = document.getElementById('messageText').value.trim();
            if (!mensagem) {
                mostrarAviso('Digite uma mensagem para enviar');
    return;
            }

            const imageFile = imagemSelecionada;

            isDisparoAtivo = true;
            disparoCancelado = false;
            totalEnviados = 0;
            totalFalhas = 0;

            // Atualizar interface
            document.getElementById('btnIniciarDisparo').disabled = true;
            document.getElementById('btnIniciarDisparo').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
            document.getElementById('btnPararDisparo').style.display = 'block';

            // Ocultar contador inicialmente
            document.getElementById('delayCounterContainer').style.display = 'none';

            adicionarLog(`üöÄ Iniciando disparo para ${selectedMotoristas.size} motoristas...`, 'info');
            if (imageFile) {
                adicionarLog(`üñºÔ∏è Imagem anexada: ${imageFile.name}`, 'info');
            }

            // Converter Set em Array para ter controle de √≠ndice
            const motoristasArray = Array.from(selectedMotoristas);

            // Processar envios
            for (let i = 0; i < motoristasArray.length; i++) {
                // Verificar se o disparo foi cancelado
                if (disparoCancelado) {
                    adicionarLog(`‚èπÔ∏è Disparo interrompido na itera√ß√£o ${i + 1}`, 'warning');
                    break;
                }

                const motoristaId = motoristasArray[i];
                const motorista = motoristasFiltrados.find(m => m.id === motoristaId);
                if (!motorista) continue;

                // Aguardar delay aleat√≥rio ANTES de cada envio (exceto o primeiro)
                if (i > 0) {
                    // Verificar novamente se foi cancelado antes de aguardar
                    if (disparoCancelado) break;
                    
                    const delaySegundos = gerarDelayAleatorio();
                    adicionarLog(`‚è≥ Aguardando ${delaySegundos} segundos antes do pr√≥ximo envio...`, 'info');
                    await aguardarComContador(delaySegundos);
                    
                    // Verificar se foi cancelado durante a espera
                    if (disparoCancelado) break;
                }

                const mensagemPersonalizada = mensagem
                    .replace(/\{\{name\}\}/g, motorista.nome || 'Motorista')
                    .replace(/\{\{telefone\}\}/g, motorista.telefone1 || '')
                    .replace(/\{\{estado\}\}/g, motorista.estado || '')
                    .replace(/\{\{classe_veiculo\}\}/g, motorista.classe_veiculo || '')
                    .replace(/\{\{tipo_veiculo\}\}/g, motorista.tipo_veiculo || '');

                try {
                    // Buscar credenciais da Evolution API do usu√°rio logado
                    const userData = localStorage.getItem('loggedInUser');
                    let userEmail = null;
                    let userId = null;
                    
                    if (userData) {
                        const user = JSON.parse(userData);
                        userEmail = user.email;
                        userId = user.id; // ‚úÖ Usar ID do localStorage
                        console.log('üë§ Usu√°rio identificado:', userEmail);
                        console.log('üÜî User ID:', userId);
                    } else {
                        console.error('‚ùå Dados do usu√°rio n√£o encontrados no localStorage');
                        adicionarLog(`‚ö†Ô∏è Usu√°rio n√£o autenticado. Pulei: ${motorista.nome}`, 'warning');
                        totalFalhas++;
                        continue; // Pula para pr√≥ximo motorista
                    }
                    
                    const formData = new FormData();
                    formData.append('number', motorista.telefone1);
                    formData.append('message', mensagemPersonalizada);
                    formData.append('usuario', userEmail);
                    formData.append('userId', userId);
                    if (imageFile) {
                        formData.append('media', imageFile);
                    }

                    const response = await fetch('/webhook/send-supabase', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const data = await response.json();
                        if (data.success) {
                            totalEnviados++;
                            adicionarLog(`‚úÖ Enviado para ${motorista.nome} (${motorista.telefone1})`, 'success');
                            if (imageFile) {
                                adicionarLog(`üñºÔ∏è Imagem enviada: ${imageFile.name}`, 'info');
                            }
                            if (data.instancia) {
                                adicionarLog(`üè∑Ô∏è Usando inst√¢ncia: ${data.instancia}`, 'info');
                            }
                        } else {
                            totalFalhas++;
                            const errorMsg = data.error || data.message || 'Erro desconhecido';
                            adicionarLog(`‚ùå Falha para ${motorista.nome}: ${errorMsg}`, 'danger');
                            
                            // Se √© erro de credenciais, mostrar alerta especial
                            if (errorMsg.includes('Credenciais da Evolution API n√£o configuradas')) {
                                adicionarLog(`‚ö†Ô∏è CONFIGURE SUAS CREDENCIAIS em Settings > Evolution API`, 'warning');
                            }
                            
                            if (data.solution) {
                                adicionarLog(`üí° ${data.solution}`, 'warning');
                            }
                            
                            if (data.details) {
                                adicionarLog(`üìã Detalhes: ${data.details}`, 'info');
                            }
                        }
                    } else {
                        totalFalhas++;
                        const errorData = await response.json().catch(() => ({}));
                        adicionarLog(`‚ùå Falha para ${motorista.nome}: HTTP ${response.status}`, 'danger');
                        if (errorData.error) {
                            adicionarLog(`   Detalhes: ${errorData.error}`, 'danger');
                        }
                        if (errorData.solution) {
                            adicionarLog(`üí° ${errorData.solution}`, 'warning');
                        }
                    }
                } catch (error) {
                    totalFalhas++;
                    adicionarLog(`‚ùå Erro para ${motorista.nome}: ${error.message}`, 'danger');
                    console.error('‚ùå Erro ao enviar mensagem:', error);
                }

                // Verificar se foi cancelado ap√≥s o envio
                if (disparoCancelado) {
                    break;
                }

                // Atualizar progresso
                const progresso = ((totalEnviados + totalFalhas) / selectedMotoristas.size) * 100;
                document.getElementById('progressBar').style.width = `${progresso}%`;
                document.getElementById('progressText').textContent = `${totalEnviados + totalFalhas} de ${selectedMotoristas.size} enviados`;
            }

            // Finalizar
            isDisparoAtivo = false;
            document.getElementById('btnIniciarDisparo').disabled = false;
            document.getElementById('btnIniciarDisparo').innerHTML = '<i class="fas fa-rocket me-2"></i>Iniciar Disparo';
            document.getElementById('btnPararDisparo').style.display = 'none';
            document.getElementById('delayCounterContainer').style.display = 'none';

            // Mostrar mensagem final baseado se foi cancelado ou conclu√≠do
            if (disparoCancelado) {
                adicionarLog(`‚èπÔ∏è Disparo interrompido! Enviados: ${totalEnviados}, Falhas: ${totalFalhas}`, 'warning');
                mostrarAviso(`Disparo interrompido!<br>Enviados: ${totalEnviados}<br>Falhas: ${totalFalhas}`);
            } else {
                adicionarLog(`üéâ Disparo conclu√≠do! Enviados: ${totalEnviados}, Falhas: ${totalFalhas}`, 'success');
                mostrarSucesso(`Disparo conclu√≠do!<br>Enviados: ${totalEnviados}<br>Falhas: ${totalFalhas}`);
            }
        }

        // ========== UTILIT√ÅRIOS ==========
        function adicionarLog(mensagem, tipo = 'info') {
            const log = document.getElementById('disparoLog');
            const timestamp = new Date().toLocaleTimeString();
            
            const logItem = document.createElement('div');
            logItem.className = `alert alert-modern alert-modern-${tipo} mb-2`;
            logItem.innerHTML = `<small>${timestamp}</small> - ${mensagem}`;
            
            log.appendChild(logItem);
            log.scrollTop = log.scrollHeight;
        }

        function mostrarSucesso(mensagem) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-modern alert-modern-success alert-dismissible fade show';
            alert.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                ${mensagem}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alert, document.body.firstChild);
            
            setTimeout(() => alert.remove(), 5000);
        }

        function mostrarAviso(mensagem) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-modern alert-modern-warning alert-dismissible fade show';
            alert.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${mensagem}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alert, document.body.firstChild);
            
            setTimeout(() => alert.remove(), 5000);
        }

        function mostrarErro(mensagem) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-modern alert-modern-danger alert-dismissible fade show';
            alert.innerHTML = `
                <i class="fas fa-exclamation-circle me-2"></i>
                ${mensagem}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alert, document.body.firstChild);
            
            setTimeout(() => alert.remove(), 5000);
        }

        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            const icon = document.querySelector('.header-actions .btn i');
            icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        // Carregar tema salvo
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            
            const icon = document.querySelector('.header-actions .btn i');
            if (icon) {
                icon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
        });
</script>
</body>
</html>