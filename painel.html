<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Painel de Disparo - Sistema Multimodal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- QR Code Library - usando versão sem integrity para evitar problemas de cache -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
  <script src="js/permissions.js"></script>
  <style>
    :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --warning: #f8961e;
            --danger: #f72585;
            --info: #4895ef;
            --light: #f8f9fa;
            --dark: #212529;
            --sidebar-width: 250px;
            --header-height: 70px;
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }

        [data-theme="dark"] {
            --light: #1a1d28;
            --dark: #f8f9fa;
            --card-bg: #252836;
            --text-color: #e4e6eb;
            --border-color: #3a3f50;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fb;
            color: var(--dark);
            transition: var(--transition);
            overflow-x: hidden;
        }

        body[data-theme="dark"] {
            background-color: #121826;
            color: var(--text-color);
        }

        /* Layout Principal */
        .app-container {
            display: flex;
            min-height: 100vh;
        }

        /* Sidebar */
        .sidebar {
            width: var(--sidebar-width);
            background: linear-gradient(180deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            transition: var(--transition);
            z-index: 1000;
        }

        .sidebar-header {
            padding: 1.5rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            text-align: center;
        }

        .sidebar-logo {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .sidebar-menu {
            padding: 1rem 0;
        }

        .menu-item {
            padding: 0.8rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: var(--transition);
            border-left: 3px solid transparent;
        }

        .menu-item:hover, .menu-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border-left-color: white;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: var(--sidebar-width);
            padding: 2rem;
            transition: var(--transition);
        }

        /* Header */
        .header {
            background: white;
            padding: 1rem 2rem;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin: 0;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        /* Cards */
    .modern-card {
      background: white;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            margin-bottom: 2rem;
      overflow: hidden;
            transition: var(--transition);
    }
    
    .modern-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
    }
    
        .card-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
            padding: 1.5rem;
            font-weight: 600;
      font-size: 1.1rem;
    }
    
        .card-body {
            padding: 2rem;
        }

        .modal-content {
            background: white;
            border-radius: 18px;
            border: none;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .modal-header, .modal-footer {
            border: none;
            background: white;
        }

        .modal-header {
            padding: 1.5rem 2rem 1rem;
        }

        .modal-body {
            padding: 1rem 2rem 2rem;
        }

        body[data-theme="dark"] .modal-content {
            background: var(--card-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
        }

        body[data-theme="dark"] .modal-header,
        body[data-theme="dark"] .modal-footer {
            background: var(--card-bg);
            color: var(--text-color);
            border-color: var(--border-color);
        }

        body[data-theme="dark"] .modal-header .btn-close {
            filter: invert(1);
        }

        body[data-theme="dark"] .form-label,
        body[data-theme="dark"] .modal-body .text-muted {
            color: var(--text-color) !important;
        }

        body[data-theme="dark"] .modal-body .text-muted small {
            color: var(--text-color) !important;
        }
        

        /* Stats Cards */
        .stats-grid {
      display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 1.5rem;
      margin-bottom: 2rem;
    }
    
        .stat-card {
      background: white;
      padding: 2rem;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
      text-align: center;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
            color: white;
        }

        .stat-icon.primary { background: var(--primary); }
        .stat-icon.success { background: var(--success); }
        .stat-icon.warning { background: var(--warning); }
        .stat-icon.info { background: var(--info); }
        .stat-icon.danger { background: var(--danger, #dc3545); }

        .stat-number {
      font-size: 2.5rem;
            font-weight: 700;
            color: var(--dark);
      margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #6c757d;
            font-weight: 500;
        }

        /* Vehicle Classes */
    .vehicle-classes {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    
    .vehicle-class {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 15px;
      padding: 1.5rem;
      text-align: center;
      cursor: pointer;
            transition: var(--transition);
    }
    
    .vehicle-class:hover {
      border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(67, 97, 238, 0.15);
    }
    
    .vehicle-class.active {
      border-color: var(--primary);
            background: linear-gradient(135deg, var(--primary), var(--secondary));
      color: white;
    }
    
        .vehicle-class-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .vehicle-class-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .vehicle-class-count {
      font-size: 0.9rem;
      opacity: 0.8;
    }
    
        /* Filters */
        .filters-container {
      background: white;
            border-radius: 15px;
            padding: 1.5rem;
            box-shadow: var(--card-shadow);
      margin-bottom: 2rem;
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-control-modern {
            border: 2px solid #e9ecef;
            border-radius: 10px;
            padding: 0.75rem 1rem;
            transition: var(--transition);
        }

        .form-control-modern:focus {
      border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(67, 97, 238, 0.25);
        }

        /* Motoristas List */
        .motoristas-container {
            background: white;
            border-radius: 15px;
            box-shadow: var(--card-shadow);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 400px);
            min-height: 500px;
            max-height: 800px;
        }
        
        @media (max-height: 900px) {
            .motoristas-container {
                height: calc(100vh - 350px);
                min-height: 400px;
                max-height: 600px;
            }
        }
        
        @media (max-width: 768px) {
            .motoristas-container {
                height: calc(100vh - 300px);
                min-height: 300px;
                max-height: 500px;
            }
        }

        .motoristas-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }

        .motoristas-list {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            min-height: 0;
        }
        
        .motoristas-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .motoristas-list::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        
        .motoristas-list::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        
        .motoristas-list::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        .motorista-item {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: var(--transition);
            cursor: pointer;
        }

        .motorista-item:hover {
            background: #f8f9fa;
        }
        
        .motorista-item.telefone-erro {
            border-left: 3px solid #dc3545;
            background-color: rgba(220, 53, 69, 0.1);
        }
        
        .motorista-item.telefone-erro:hover {
            background-color: rgba(220, 53, 69, 0.15);
        }
        
        .motorista-item.telefone-erro .motorista-checkbox {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .motorista-item.selected {
            background: rgba(67, 97, 238, 0.1);
            border-left: 4px solid var(--primary);
        }

        .motorista-info h6 {
            margin: 0;
            font-weight: 600;
            color: var(--dark);
        }

        .motorista-details {
      font-size: 0.9rem;
            color: #6c757d;
            margin-top: 0.25rem;
        }

        .motorista-checkbox {
            width: 20px;
            height: 20px;
            border: 2px solid #dee2e6;
            border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
            transition: var(--transition);
        }

        .motorista-checkbox.checked {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }

        .motorista-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .motorista-favorito {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            color: #dee2e6;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
            font-size: 1.2rem;
        }

        .motorista-favorito:hover {
            background: rgba(255, 193, 7, 0.1);
            color: #ffc107;
        }

        .motorista-favorito.active {
            color: #ffc107;
        }

        .motorista-favorito.active:hover {
            color: #ff9800;
        }

        /* Pagination */
        .pagination-container {
            background: #f8f9fa;
            padding: 1rem 1.5rem;
            border-top: 1px solid #e9ecef;
            flex-shrink: 0;
        }
        
        @media (max-width: 768px) {
            .pagination-container {
                padding: 0.75rem 1rem;
            }
            
            .pagination-container .row {
                text-align: center;
            }
            
            .pagination-container .col-12 {
                margin-bottom: 0.5rem;
            }
            
            .pagination-modern {
                justify-content: center !important;
                max-width: 100%;
            }
            
            .page-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.85rem;
            }
        }
        
        /* Garantir que a paginação não ultrapasse o container */
        nav[aria-label="Paginação"] {
            overflow-x: auto;
            overflow-y: hidden;
            -webkit-overflow-scrolling: touch;
            max-width: 100%;
            width: 100%;
        }
        
        nav[aria-label="Paginação"]::-webkit-scrollbar {
            height: 4px;
        }
        
        nav[aria-label="Paginação"]::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        nav[aria-label="Paginação"]::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 2px;
        }
        
        /* Garantir que os botões não quebrem o layout */
        .pagination-container .col-md-4 {
            min-width: 0;
            overflow: hidden;
        }

        .pagination-modern {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            list-style: none;
            margin: 0;
            padding: 0;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        @media (max-width: 768px) {
            .pagination-modern {
                justify-content: center;
            }
        }
        
        .pagination-modern li {
            display: inline-flex;
            align-items: center;
        }

        .page-btn {
            padding: 0.5rem 1rem;
            border: 1px solid #dee2e6;
            background: white;
            color: var(--dark);
            text-decoration: none;
            border-radius: 8px;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            white-space: nowrap;
            font-size: 0.9rem;
            min-width: auto;
            cursor: pointer;
        }
        
        .page-btn span {
            display: inline-flex;
            align-items: center;
        }
    
        .page-btn:hover {
      background: var(--primary);
            color: white;
      border-color: var(--primary);
    }
    
        .page-btn.active {
            background: var(--primary);
      color: white;
            border-color: var(--primary);
        }

        .page-btn.disabled,
        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .page-btn.disabled:hover {
            background: white;
            color: var(--dark);
            border-color: #dee2e6;
        }

        /* Buttons */
        .btn-modern {
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: var(--transition);
            border: none;
        }

        .btn-voltar-portal {
            background: rgba(255, 255, 255, 0.1);
            color: var(--primary);
            border: 2px solid var(--primary);
            border-radius: 10px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: var(--transition);
            text-decoration: none;
            display: inline-flex;
            align-items: center;
        }

        .btn-voltar-portal:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(67, 97, 238, 0.3);
            text-decoration: none;
        }

        /* Dark mode para botão voltar */
        body[data-theme="dark"] .btn-voltar-portal {
            background: rgba(255, 255, 255, 0.1);
            color: var(--primary);
            border-color: var(--primary);
        }

        body[data-theme="dark"] .btn-voltar-portal:hover {
            background: var(--primary);
            color: white;
        }

        .btn-toggle-theme {
            background: rgba(255, 255, 255, 0.1);
            color: var(--primary);
            border: 2px solid var(--primary);
            border-radius: 8px;
            padding: 0.5rem 0.75rem;
            font-weight: 600;
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .btn-toggle-theme:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
        }

        /* Dark mode para botão toggle */
        body[data-theme="dark"] .btn-toggle-theme {
            background: rgba(255, 255, 255, 0.1);
            color: var(--primary);
            border-color: var(--primary);
        }

        body[data-theme="dark"] .btn-toggle-theme:hover {
            background: var(--primary);
            color: white;
        }

        .btn-modern-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        .btn-modern-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(67, 97, 238, 0.3);
        }

        .btn-modern-success {
            background: linear-gradient(135deg, var(--success), #06b6d4);
            color: white;
        }

        .btn-modern-success:hover {
      transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 201, 240, 0.3);
        }

        .btn-modern-warning {
            background: linear-gradient(135deg, var(--warning), #f97316);
            color: white;
        }

        .btn-modern-warning:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(248, 150, 30, 0.3);
        }

        .btn-modern-info {
            background: linear-gradient(135deg, var(--info), #3b82f6);
            color: white;
        }

        .btn-modern-info:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(72, 149, 239, 0.3);
        }

        /* Loading */
        .loading-spinner {
      display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Alerts */
        .alert-modern {
            border: none;
            border-radius: 10px;
      padding: 1rem 1.5rem;
            margin-bottom: 1rem;
        }

        .alert-modern-success {
            background: linear-gradient(135deg, rgba(76, 201, 240, 0.1), rgba(6, 182, 212, 0.1));
            color: #065f46;
            border-left: 4px solid var(--success);
        }

        .alert-modern-warning {
            background: linear-gradient(135deg, rgba(248, 150, 30, 0.1), rgba(249, 115, 22, 0.1));
            color: #92400e;
            border-left: 4px solid var(--warning);
        }

        .alert-modern-danger {
            background: linear-gradient(135deg, rgba(247, 37, 133, 0.1), rgba(236, 72, 153, 0.1));
            color: #991b1b;
            border-left: 4px solid var(--danger);
        }

        .alert-modern-info {
            background: linear-gradient(135deg, rgba(72, 149, 239, 0.1), rgba(59, 130, 246, 0.1));
            color: #1e40af;
            border-left: 4px solid var(--info);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .vehicle-classes {
                grid-template-columns: 1fr;
            }
            
            .filter-row {
                grid-template-columns: 1fr;
            }
        }

        /* Dark Mode */
        body[data-theme="dark"] .modern-card,
        body[data-theme="dark"] .stat-card,
        body[data-theme="dark"] .filters-container,
        body[data-theme="dark"] .motoristas-container,
        body[data-theme="dark"] .pagination-container,
        body[data-theme="dark"] .vehicle-class {
            background: var(--card-bg);
            color: var(--text-color);
        }

        body[data-theme="dark"] .page-btn {
            background: rgba(255, 255, 255, 0.1) !important;
            color: var(--text-color) !important;
            border-color: rgba(255, 255, 255, 0.2) !important;
        }

        body[data-theme="dark"] .page-btn:hover {
            background: var(--primary) !important;
            color: white !important;
            border-color: var(--primary) !important;
        }

        body[data-theme="dark"] .page-btn.active {
            background: var(--primary) !important;
            color: white !important;
            border-color: var(--primary) !important;
        }

        body[data-theme="dark"] .page-btn.disabled {
            background: rgba(255, 255, 255, 0.05) !important;
            color: rgba(255, 255, 255, 0.3) !important;
            border-color: rgba(255, 255, 255, 0.1) !important;
            cursor: not-allowed !important;
        }

        body[data-theme="dark"] .text-muted {
            color: rgba(255, 255, 255, 0.6) !important;
        }

        body[data-theme="dark"] #infoPagina {
            color: rgba(255, 255, 255, 0.7) !important;
        }

        body[data-theme="dark"] .vehicle-class {
            border-color: var(--border-color);
        }

        body[data-theme="dark"] .vehicle-class:hover {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.1);
        }

        body[data-theme="dark"] .vehicle-class.active {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
        }

        /* Dark Mode - Botões */
        body[data-theme="dark"] .btn-modern-primary,
        body[data-theme="dark"] .btn-modern-success,
        body[data-theme="dark"] .btn-modern-warning,
        body[data-theme="dark"] .btn-modern-info {
            color: white !important;
            opacity: 1 !important;
        }

        body[data-theme="dark"] .btn-modern-primary {
            background: linear-gradient(135deg, var(--primary), var(--secondary)) !important;
        }

        body[data-theme="dark"] .btn-modern-success {
            background: linear-gradient(135deg, var(--success), #06b6d4) !important;
        }

        body[data-theme="dark"] .btn-modern-warning {
            background: linear-gradient(135deg, var(--warning), #f97316) !important;
        }

        body[data-theme="dark"] .btn-modern-info {
            background: linear-gradient(135deg, var(--info), #3b82f6) !important;
        }

        body[data-theme="dark"] .motorista-item {
            border-bottom-color: var(--border-color);
        }

        body[data-theme="dark"] .motorista-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        body[data-theme="dark"] .form-control-modern {
            background: var(--card-bg);
            border-color: var(--border-color);
            color: var(--text-color);
        }

        body[data-theme="dark"] .form-control-modern:focus {
            background: var(--card-bg);
            border-color: var(--primary);
            color: var(--text-color);
    }

        /* Delay Counter Styles */
        .delay-counter-container {
            margin-top: 1rem;
            animation: fadeIn 0.3s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .delay-counter-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--info);
            margin: 0 0.5rem;
            display: inline-block;
            min-width: 3rem;
            text-align: center;
        }

        .delay-counter-container .alert {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        body[data-theme="dark"] .delay-counter-number {
            color: var(--info);
        }

        .treinamento-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.92);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 2rem;
        }

        .treinamento-overlay.ativo {
            display: flex;
        }

        .treinamento-overlay-card {
            max-width: 520px;
            width: 100%;
            background: rgba(15, 23, 42, 0.95);
            border-radius: 18px;
            border: 1px solid rgba(96, 165, 250, 0.35);
            padding: 2.5rem 2rem;
            text-align: center;
            box-shadow: 0 24px 60px rgba(15, 23, 42, 0.6);
            color: #e2e8f0;
        }

        .treinamento-overlay-card h2 {
            font-size: 1.6rem;
            font-weight: 700;
            color: #f8fafc;
            margin-bottom: 1rem;
        }

        .treinamento-overlay-card p {
            color: rgba(226, 232, 240, 0.78);
            margin-bottom: 1.75rem;
            line-height: 1.6;
        }

        .treinamento-overlay-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
        }

        .treinamento-overlay .btn {
            border-radius: 14px;
            font-weight: 600;
            padding: 0.75rem 1.5rem;
        }

        .treinamento-overlay .btn-training {
            background: linear-gradient(135deg, #38bdf8, #0ea5e9);
            border: none;
            color: #0b1120;
            box-shadow: 0 16px 32px rgba(56, 189, 248, 0.35);
        }

        .treinamento-overlay .btn-refresh {
            border: 1px solid rgba(148, 163, 184, 0.4);
            background: transparent;
            color: #e2e8f0;
        }

        .treinamento-overlay .badge {
            background: rgba(59, 130, 246, 0.2);
            color: #bfdbfe;
            border-radius: 999px;
            padding: 0.35rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
  </style>
</head>
<body>
<div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">
                    <i class="fas fa-rocket"></i>
                    <span>Painel Disparo</span>
            </div>
              </div>
            <div class="sidebar-menu">
                <a href="portal.html" class="menu-item">
                    <i class="fas fa-home"></i>
                    <span>Portal</span>
                </a>
                <a href="#" class="menu-item active">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </a>
                <a href="cadastro.html" class="menu-item">
                    <i class="fas fa-truck"></i>
                    <span>Motoristas</span>
                </a>
                <a href="#" class="menu-item">
                    <i class="fas fa-paper-plane"></i>
                    <span>Disparos</span>
                </a>
                <a href="relatorios.html" class="menu-item">
                    <i class="fas fa-chart-line"></i>
                    <span>Relatórios</span>
                </a>
                <a href="javascript:void(0)" class="menu-item" data-bs-toggle="modal" data-bs-target="#configSistemaModal" data-config-trigger="true">
                    <i class="fas fa-cog"></i>
                    <span>Configurações</span>
                </a>
            </div>
          </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="d-flex align-items-center">
                    <a href="portal.html" class="btn btn-voltar-portal me-3">
                        <i class="fas fa-arrow-left me-2"></i>
                        Voltar ao Portal
                    </a>
                    <h1 class="header-title">
                        <i class="fas fa-rocket me-2"></i>
                        Painel de Disparo de Mensagens
                    </h1>
                </div>
                <div class="header-actions">
                    <div class="user-badge">
                        <i class="fas fa-user me-2"></i>
                        <span id="userName">Usuário</span>
                    </div>
                    <button class="btn btn-toggle-theme btn-sm" onclick="toggleTheme()">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon primary">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-number" id="totalMotoristas">0</div>
                    <div class="stat-label">Total de Motoristas</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon success">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="stat-number" id="motoristasAtivos">0</div>
                    <div class="stat-label">Motoristas Ativos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon danger">
                        <i class="fas fa-times-circle"></i>
                    </div>
                    <div class="stat-number" id="motoristasInativos">0</div>
                    <div class="stat-label">Motoristas Inativos</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon warning">
                        <i class="fas fa-hand-pointer"></i>
                    </div>
                    <div class="stat-number" id="motoristasSelecionados">0</div>
                    <div class="stat-label">Selecionados</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon info">
                        <i class="fas fa-truck"></i>
                    </div>
                    <div class="stat-number" id="categoriaAtiva">-</div>
                    <div class="stat-label">Categoria Ativa</div>
                </div>
            </div>

            <!-- Vehicle Classes -->
        <div class="modern-card">
          <div class="card-header">
                    <i class="fas fa-truck me-2"></i>
                    Selecionar Categoria de Veículo
          </div>
          <div class="card-body">
                    <div class="vehicle-classes">
                        <div class="vehicle-class" data-class="leve" onclick="selecionarClasse('leve')">
                            <div class="vehicle-class-icon">
                                <i class="fas fa-car"></i>
            </div>
                            <div class="vehicle-class-title">Leve</div>
                            <div class="vehicle-class-count" id="count-leve">0 motoristas</div>
          </div>
                        <div class="vehicle-class" data-class="medio" onclick="selecionarClasse('medio')">
                            <div class="vehicle-class-icon">
                                <i class="fas fa-truck"></i>
        </div>
                            <div class="vehicle-class-title">Médio</div>
                            <div class="vehicle-class-count" id="count-medio">0 motoristas</div>
              </div>
                        <div class="vehicle-class" data-class="pesado" onclick="selecionarClasse('pesado')">
                            <div class="vehicle-class-icon">
                                <i class="fas fa-truck-moving"></i>
            </div>
                            <div class="vehicle-class-title">Pesado</div>
                            <div class="vehicle-class-count" id="count-pesado">0 motoristas</div>
          </div>
                    </div>
                </div>
            </div>

            <!-- Filters -->
            <div class="filters-container">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label">Tipo de Veículo</label>
                        <!-- Select "real" (usado pela lógica de filtros) fica oculto -->
                        <select id="filtroTipoVeiculo" class="form-control form-control-modern d-none" multiple>
                            <option value="">Todos os tipos</option>
                        </select>
                        <!-- Dropdown visual com checkboxes -->
                        <div class="dropdown w-100">
                            <button class="btn btn-modern btn-outline-secondary w-100 text-start d-flex justify-content-between align-items-center"
                                    type="button"
                                    id="dropdownTipoVeiculoBtn"
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false">
                                <span id="dropdownTipoVeiculoLabel">Todos os tipos</span>
                                <i class="fas fa-chevron-down ms-2"></i>
                            </button>
                            <div class="dropdown-menu w-100 p-2" aria-labelledby="dropdownTipoVeiculoBtn" id="dropdownTipoVeiculoMenu" style="max-height: 260px; overflow-y: auto;">
                                <!-- Checkboxes serão preenchidos via JS em carregarFiltros() -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Carroceria</label>
                        <!-- Select "real" oculto -->
                        <select id="filtroCarroceria" class="form-control form-control-modern d-none" multiple>
                            <option value="">Todas as carrocerias</option>
                        </select>
                        <!-- Dropdown visual com checkboxes -->
                        <div class="dropdown w-100">
                            <button class="btn btn-modern btn-outline-secondary w-100 text-start d-flex justify-content-between align-items-center"
                                    type="button"
                                    id="dropdownCarroceriaBtn"
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false">
                                <span id="dropdownCarroceriaLabel">Todas as carrocerias</span>
                                <i class="fas fa-chevron-down ms-2"></i>
                            </button>
                            <div class="dropdown-menu w-100 p-2" aria-labelledby="dropdownCarroceriaBtn" id="dropdownCarroceriaMenu" style="max-height: 260px; overflow-y: auto;">
                                <!-- Checkboxes serão preenchidos via JS em carregarFiltros() -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Estado</label>
                        <!-- Select "real" oculto para reaproveitar a lógica de filtros -->
                        <select id="filtroEstado" class="form-control form-control-modern d-none" multiple>
                            <option value="">Todos os estados</option>
                        </select>
                        <!-- Dropdown visual com checkboxes -->
                        <div class="dropdown w-100">
                            <button class="btn btn-modern btn-outline-secondary w-100 text-start d-flex justify-content-between align-items-center"
                                    type="button"
                                    id="dropdownEstadoBtn"
                                    data-bs-toggle="dropdown"
                                    aria-expanded="false">
                                <span id="dropdownEstadoLabel">Todos os estados</span>
                                <i class="fas fa-chevron-down ms-2"></i>
                            </button>
                            <div class="dropdown-menu w-100 p-2" aria-labelledby="dropdownEstadoBtn" id="dropdownEstadoMenu" style="max-height: 260px; overflow-y: auto;">
                                <!-- Checkboxes serão preenchidos via JS em carregarFiltros() -->
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Status</label>
                        <select id="filtroStatus" class="form-control form-control-modern">
                            <option value="">Todos os status</option>
                            <option value="ativo" selected>Ativo</option>
                            <option value="inativo">Inativo</option>
                            <option value="cadastro_pendente">Cadastro Pendente</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Buscar</label>
                        <input type="text" id="filtroBusca" class="form-control form-control-modern" placeholder="Nome ou telefone...">
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-md-2">
                        <label class="form-label">
                            <input type="checkbox" id="filtroFavoritos" class="form-check-input me-2">
                            Apenas Favoritos
                        </label>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-12">
                        <button class="btn btn-modern btn-modern-primary me-2" id="btnBuscar">
                            <i class="fas fa-search me-2"></i>
                            Buscar
                        </button>
                        <button class="btn btn-modern btn-modern-success me-2 mb-2 mb-md-0" id="btnSelecionarTodos">
                            <i class="fas fa-check-double me-2"></i>
                            Selecionar Todos
                        </button>
                        <button class="btn btn-modern btn-modern-info me-2 mb-2 mb-md-0" id="btnSelecionarPagina">
                            <i class="fas fa-check-square me-2"></i>
                            Selecionar Página
                        </button>
                        <button class="btn btn-modern btn-modern-warning mb-2 mb-md-0" id="btnLimparSelecao">
                            <i class="fas fa-times me-2"></i>
                            Limpar Seleção
                        </button>
                </div>
              </div>
            </div>

            <!-- Motoristas List -->
            <div class="motoristas-container">
                <div class="motoristas-header">
                    <div>
                        <i class="fas fa-list me-2"></i>
                        Lista de Motoristas
                </div>
                    <div class="d-flex align-items-center gap-3">
                        <button class="btn btn-sm btn-outline-light" onclick="sincronizarErrosDisparos()" title="Sincronizar erros de disparos da tabela disparos_log">
                            <i class="fas fa-sync-alt me-1"></i> Sincronizar Erros
                        </button>
                        <span class="badge bg-light text-dark" id="motoristasSelecionadosBadge">0 selecionados</span>
                        <div class="d-flex align-items-center">
                            <span class="me-2">Mostrar:</span>
                            <select id="itensPorPagina" class="form-select form-select-sm" style="width: auto;">
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="30">30</option>
                                <option value="40">40</option>
                                <option value="50" selected>50</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="motoristas-list" id="motoristasList">
                    <div class="text-center py-5">
                        <i class="fas fa-truck fs-1 text-muted mb-3"></i>
                        <p class="text-muted">Selecione uma categoria para carregar os motoristas</p>
                    </div>
                </div>

                <!-- Pagination -->
                <div class="pagination-container">
                    <div class="row align-items-center g-2">
                        <div class="col-12 col-md-4">
                            <small class="text-muted" id="infoPagina">
                                Página 1 de 1 - Total: 0 motoristas
                            </small>
                        </div>
                        <div class="col-12 col-md-4">
                            <div class="d-flex align-items-center justify-content-center gap-2 flex-wrap">
                                <label for="inputPagina" class="mb-0 small text-muted">Ir para:</label>
                                <input type="number" 
                                       id="inputPagina" 
                                       class="form-control form-control-sm" 
                                       style="width: 70px;" 
                                       min="1" 
                                       placeholder="1"
                                       onkeypress="if(event.key === 'Enter') navegarParaPagina()">
                                <button class="btn btn-sm btn-primary" onclick="navegarParaPagina()" title="Ir para página">
                                    <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-12 col-md-4">
                            <nav aria-label="Paginação" class="d-flex justify-content-center justify-content-md-end w-100">
                                <ul class="pagination-modern mb-0 w-100" id="paginacao" style="justify-content: center;">
                                    <!-- Paginação será gerada via JavaScript -->
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Message and Send -->
            <div class="modern-card">
          <div class="card-header">
                    <i class="fas fa-paper-plane me-2"></i>
                    Mensagem e Disparo
          </div>
          <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-4">
                                <label class="form-label">Mensagem Personalizada</label>
                                <div class="alert alert-modern alert-modern-info">
                                    <strong>Variáveis disponíveis:</strong> {{name}}, {{telefone}}, {{estado}}, {{classe_veiculo}}, {{tipo_veiculo}}, {{tipo_carroceria}}
              </div>
              <textarea 
                id="messageText" 
                class="form-control form-control-modern" 
                rows="5" 
                placeholder="Digite sua mensagem aqui... Use as variáveis acima para personalizar."
                                >Olá {{name}}, temos uma viagem disponível para você na categoria {{classe_veiculo}}.</textarea>
                            </div>

                            <div class="mb-4">
                                <label class="form-label">Imagem (opcional)</label>
                                <div id="imageUploadWrapper">
                                    <input type="file" id="imageInput" class="form-control form-control-modern" accept="image/*">
                                    <small class="text-muted">Formatos aceitos: jpg, jpeg, png, webp. Tamanho máximo 5MB.</small>
                                </div>
                                <div id="imagePreview" class="image-preview mt-3" style="display:none;">
                                    <div class="preview-info d-flex justify-content-between align-items-center">
                                        <div>
                                            <small class="text-muted" id="imageName">imagem.jpg</small>
                                        </div>
                                        <button class="btn btn-sm btn-outline-danger" id="btnRemoveImage">
                                            <i class="fas fa-times"></i> Remover
                                        </button>
                                    </div>
                                    <div class="preview-image mt-2 text-center">
                                        <img id="previewImg" src="" alt="Pré-visualização" class="img-fluid rounded">
                                    </div>
                                </div>
                            </div>

                            <div class="mb-4">
                                <label class="form-label">Áudio (opcional)</label>
                                <div id="audioRecordWrapper">
                                    <div class="d-flex gap-2 mb-2">
                                        <button class="btn btn-outline-primary" id="btnStartRecording" type="button">
                                            <i class="fas fa-microphone me-2"></i>Gravar Áudio
                                        </button>
                                        <button class="btn btn-outline-danger" id="btnStopRecording" type="button" style="display:none;">
                                            <i class="fas fa-stop me-2"></i>Parar Gravação
                                        </button>
                                        <button class="btn btn-outline-secondary" id="btnRemoveAudio" type="button" style="display:none;">
                                            <i class="fas fa-times me-2"></i>Remover
                                        </button>
                                    </div>
                                    <div id="audioPreview" class="mt-3" style="display:none;">
                                        <div class="d-flex align-items-center gap-3 p-3 border rounded">
                                            <div class="flex-grow-1">
                                                <div class="d-flex align-items-center gap-2 mb-2">
                                                    <i class="fas fa-volume-up text-primary"></i>
                                                    <small class="text-muted" id="audioInfo">Áudio gravado</small>
                                                    <span class="badge bg-secondary" id="audioDuration">0s</span>
                                                </div>
                                                <audio id="audioPlayer" controls class="w-100" style="max-width: 100%;">
                                                    <source id="audioSource" src="" type="audio/webm">
                                                    Seu navegador não suporta o elemento de áudio.
                                                </audio>
                                            </div>
                                        </div>
                                    </div>
                                    <small class="text-muted">Clique em "Gravar Áudio" para gravar uma mensagem de voz. Máximo 2 minutos.</small>
                                </div>
                            </div>
                            
                            <!-- Test Field -->
                            <div class="mb-4">
                                <label class="form-label">Teste de Envio</label>
                                <div class="row g-2">
                                    <div class="col-md-8">
                                        <input 
                                            type="text" 
                                            id="telefoneTeste" 
                                            class="form-control form-control-modern" 
                                            placeholder="Digite o número para teste (ex: 5511999999999)"
                                        >
                </div>
                  <div class="col-md-4">
                                        <button class="btn btn-modern btn-modern-primary w-100" id="btnTestarEnvio">
                                            <i class="fas fa-paper-plane me-2"></i>
                                            Enviar Teste
                    </button>
                  </div>
                </div>
                                <small class="text-muted">Digite um número de telefone para testar o envio real</small>
              </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-4">
                                <label class="form-label">Ações</label>
                                <div class="d-grid gap-2">
                                    <button class="btn btn-modern btn-modern-primary" id="btnTestarMensagem">
                                        <i class="fas fa-vial me-2"></i>
                                        Testar Mensagem
                  </button>
                                    <button class="btn btn-modern btn-modern-success" id="btnIniciarDisparo">
                                        <i class="fas fa-rocket me-2"></i>
                                        Iniciar Disparo
                  </button>
                                    <button class="btn btn-modern btn-modern-danger" id="btnPararDisparo" style="display: none;">
                                        <i class="fas fa-stop me-2"></i>
                                        Parar Disparo
                  </button>
              </div>
            </div>

                            <div class="mb-4">
                                <label class="form-label">Progresso</label>
                                <div class="progress mb-2" style="height: 8px;">
                                    <div class="progress-bar" id="progressBar" style="width: 0%"></div>
              </div>
                                <div class="text-center">
                                    <small class="text-muted" id="progressText">0 de 0 enviados</small>
              </div>
                                <!-- Contador de Delay -->
                                <div id="delayCounterContainer" class="delay-counter-container" style="display: none;">
                                    <div class="alert alert-modern alert-modern-info mb-2">
                                        <i class="fas fa-clock me-2"></i>
                                        <strong>Aguardando próximo envio:</strong>
                                        <span id="delayCounter" class="delay-counter-number">0</span>
                                        <span>segundos</span>
                                    </div>
                                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

            <!-- Evolution API Status -->
        <div class="modern-card">
          <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
                    <div class="d-flex align-items-center gap-2">
                        <i class="fas fa-shield-alt"></i>
                        <span>Status Evolution API</span>
            </div>
                    <div class="btn-group" role="group">
                        <button class="btn btn-modern btn-modern-primary btn-sm" id="btnVerificarEvolution">
                            <i class="fas fa-sync me-2"></i>
                            Verificar Status
                        </button>
                        <button class="btn btn-modern btn-modern-warning btn-sm" id="btnGerarQRCode">
                            <i class="fas fa-qrcode me-2"></i>
                            Gerar QR Code
                        </button>
                        <button class="btn btn-modern btn-modern-danger btn-sm" id="btnDeslogarInstancia">
                            <i class="fas fa-sign-out-alt me-2"></i>
                            Deslogar
                        </button>
                    </div>
              </div>
              <div class="card-body">
                    <div id="evolutionLog" style="max-height: 200px; overflow-y: auto; background: #f8fafc; border-radius: 12px; padding: 1rem;">
                        <div class="text-center text-muted">
                            <i class="fas fa-shield-alt fa-2x mb-3 d-block"></i>
                            Clique em "Verificar Status" para testar a Evolution API
                  </div>
                </div>
                  </div>
                </div>
                
            <!-- Disparo Log -->
            <div class="modern-card">
              <div class="card-header">
                    <i class="fas fa-list-alt me-2"></i>
                    Log de Disparo
              </div>
              <div class="card-body">
                    <div id="disparoLog" style="max-height: 300px; overflow-y: auto; background: #f8fafc; border-radius: 12px; padding: 1rem;">
                        <div class="text-center text-muted">
                            <i class="fas fa-clipboard-list fa-2x mb-3 d-block"></i>
                            Nenhum disparo realizado ainda
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <!-- Modal QR Code Evolution -->
        <div class="modal fade" id="modalQRCodeEvolution" tabindex="-1" aria-labelledby="modalQRCodeEvolutionLabel" aria-hidden="true">
          <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content" style="border-radius: 16px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
              <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 1.5rem;">
                <h5 class="modal-title" id="modalQRCodeEvolutionLabel" style="font-weight: 600;">
                  <i class="fas fa-qrcode me-2"></i>Conectar Instância Evolution
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
              </div>
              <div class="modal-body" style="padding: 2rem; background: #f8f9fa;">
                <!-- Instruções -->
                <div class="alert alert-info border-0 shadow-sm mb-4" style="border-radius: 12px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
                  <div class="d-flex align-items-start">
                    <i class="fas fa-info-circle fa-2x me-3 mt-1" style="color: #1976d2;"></i>
                    <div>
                      <h6 class="alert-heading mb-2" style="color: #1565c0; font-weight: 600;">
                        <i class="fas fa-mobile-alt me-2"></i>Como conectar:
                      </h6>
                      <ol class="mb-0 ps-3" style="color: #424242; line-height: 1.8;">
                        <li>Abra o <strong>WhatsApp</strong> no seu celular</li>
                        <li>Toque em <strong>Menu (⋮)</strong> ou <strong>Configurações</strong></li>
                        <li>Vá em <strong>Aparelhos conectados</strong></li>
                        <li>Toque em <strong>Conectar um aparelho</strong></li>
                        <li>Escaneie o QR Code abaixo</li>
                      </ol>
                    </div>
                  </div>
                </div>

                <!-- Container do QR Code -->
                <div class="text-center mb-4">
                  <div id="qrcodeEvolutionContainer" class="d-flex justify-content-center align-items-center" 
                       style="min-height: 320px; background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1); position: relative;">
                    <div class="text-muted w-100">
                      <div class="loading-spinner mb-3" style="width: 50px; height: 50px; margin: 0 auto;"></div>
                      <p class="mb-0" style="font-size: 1.1rem; font-weight: 500;">Gerando QR Code...</p>
                    </div>
                  </div>
                  
                  <!-- Informações adicionais -->
                  <div class="mt-3">
                    <p class="mb-2" id="qrcodeEvolutionInfo" style="color: #666; font-size: 0.95rem;">
                      <i class="fas fa-sync-alt me-2"></i>Use o aplicativo WhatsApp para escanear o código.
                    </p>
                    <small class="text-muted d-block" id="qrcodeEvolutionStatus" style="font-size: 0.85rem;"></small>
                  </div>
                </div>

                <!-- Dica -->
                <div class="alert alert-warning border-0 shadow-sm mb-0" style="border-radius: 12px; background: #fff3cd;">
                  <div class="d-flex align-items-center">
                    <i class="fas fa-lightbulb me-2" style="color: #856404;"></i>
                    <small class="mb-0" style="color: #856404;">
                      <strong>Dica:</strong> Certifique-se de que a tela do celular está com brilho máximo para facilitar a leitura do QR Code.
                    </small>
                  </div>
                </div>
              </div>
              <div class="modal-footer" style="background: #f8f9fa; border-top: 1px solid #e0e0e0; padding: 1rem 1.5rem;">
                <button type="button" class="btn btn-modern btn-modern-outline" data-bs-dismiss="modal">
                  <i class="fas fa-times me-2"></i>Fechar
                </button>
                <button type="button" class="btn btn-modern" id="btnAtualizarQRCode" style="display: none;">
                  <i class="fas fa-sync-alt me-2"></i>Atualizar QR Code
                </button>
              </div>
            </div>
          </div>
        </div>
        
    <!-- Configuração do Sistema Modal -->
    <div class="modal fade" id="configSistemaModal" tabindex="-1" aria-labelledby="configSistemaModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="configSistemaModalLabel"><i class="fas fa-sliders-h me-2"></i>Configuração do sistema de disparo</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
          </div>
          <div class="modal-body">
            <p class="text-muted mb-3">
              Ajuste como o disparador se comporta. Cada parâmetros foi escolhido para reduzir riscos de bloqueio no WhatsApp:
            </p>
            <ul class="list-unstyled text-muted small mb-4">
              <li><strong>Intervalo aleatório entre mensagens:</strong> define tempos diferentes entre cada envio (mínimo e máximo) para simular comportamento humano. Intervalos curtos e repetitivos podem ser interpretados como spam.</li>
              <li><strong>Limite de mensagens por bloco:</strong> número máximo de mensagens que podem ser disparadas em uma janela de tempo. Isso evita sequências muito longas em pouco tempo, que são rastreadas pela plataforma.</li>
              <li><strong>Janela do bloco (min):</strong> intervalo usado para contar o limite acima. Após essa janela, a contagem é reiniciada.</li>
              <li><strong>Pausa automática:</strong> quando o limite do bloco é atingido, o sistema impõe um tempo de espera obrigatório antes de retomar os envios. Esse descanso é essencial para a reputação do número.</li>
              <li><strong>Simular digitação:</strong> envia um sinal de “digitando...” antes da mensagem. A simulação torna a interação mais natural, reduzindo a chance de bloqueios automáticos.</li>
              <li><strong>Randomização de mensagens com IA:</strong> quando ativada, utiliza a OpenAI para gerar variações únicas de cada mensagem enviada, tornando os envios mais naturais e reduzindo a detecção de padrões repetitivos.</li>
            </ul>
            <p class="text-muted mb-3">
              Use valores conservadores. Ignorar essas limitações pode levar ao bloqueio definitivo do número no WhatsApp, pois a plataforma monitora padrões de envio agressivos. A Multimodal não se responsabiliza por números bloqueados quando os parâmetros forem reduzidos abaixo das recomendações.
            </p>
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Delay mínimo (segundos)</label>
                <input type="number" class="form-control form-control-modern" id="configDelayMin" min="1" max="600">
              </div>
              <div class="col-md-4">
                <label class="form-label">Delay máximo (segundos)</label>
                <input type="number" class="form-control form-control-modern" id="configDelayMax" min="1" max="600">
              </div>
              <div class="col-md-4">
                <label class="form-label">Mensagens por bloco</label>
                <input type="number" class="form-control form-control-modern" id="configMessageLimit" min="1" max="1000">
              </div>
              <div class="col-md-4">
                <label class="form-label">Janela do bloco (min)</label>
                <input type="number" class="form-control form-control-modern" id="configWindowMinutes" min="1" max="120">
              </div>
              <div class="col-md-4">
                <label class="form-label">Pausa automática (min)</label>
                <input type="number" class="form-control form-control-modern" id="configCooldownMinutes" min="1" max="240">
              </div>
              <div class="col-12">
                <div class="form-check form-switch mt-2">
                  <input class="form-check-input" type="checkbox" id="configSimulateTyping">
                  <label class="form-check-label" for="configSimulateTyping">
                    Simular digitação antes de cada envio
                  </label>
                </div>
              </div>
              <div class="col-12">
                <div class="form-check form-switch mt-2">
                  <input class="form-check-input" type="checkbox" id="configRandomMessageAI">
                  <label class="form-check-label" for="configRandomMessageAI">
                    Ativar randomização de mensagens com IA (OpenAI)
                  </label>
                </div>
              </div>
            </div>
            <div class="alert alert-modern alert-modern-info mt-3" id="configResumo"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-modern btn-modern-secondary" data-bs-dismiss="modal">Fechar</button>
            <button type="button" class="btn btn-modern btn-modern-primary" id="btnAplicarConfig">
              <i class="fas fa-save me-2"></i>
              Aplicar ajustes
            </button>
          </div>
        </div>
      </div>
    </div>
        
    <div id="treinamentoBloqueio" class="treinamento-overlay">
      <div class="treinamento-overlay-card">
        <div class="mb-3">
          <span class="badge"><i class="fas fa-graduation-cap me-2"></i>Treinamento obrigatório</span>
        </div>
        <h2>Conclua o treinamento antes de disparar</h2>
        <p>
          Para proteger a reputação do número e garantir o uso correto do disparador,
          somente usuários com o treinamento <strong>"Disparador de Mensagens"</strong> concluído podem enviar mensagens.
        </p>
        <div class="treinamento-overlay-actions">
          <a href="treinamento-disparador.html" target="_blank" class="btn btn-training">
            <i class="fas fa-play-circle me-2"></i> Fazer treinamento agora
          </a>
          <button type="button" class="btn btn-refresh" id="btnReverificarTreinamento">
            <i class="fas fa-rotate-right me-2"></i> Já concluí / Revalidar
          </button>
        </div>
      </div>
    </div>
    
    <!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
        // ========== CONFIGURAÇÃO DO SUPABASE ==========
        let supabaseUrl, supabaseKey, supabase;
        
        const CONFIG_DISPARO_STORAGE_KEY = 'painelDisparoConfig';
        const DEFAULT_DISPARO_CONFIG = {
            delayMin: 10,
            delayMax: 30,
            messageLimit: 50,
            cooldownMinutes: 15,
            windowMinutes: 5,
            simulateTyping: true,
            randomMessageAI: true
        };
        let configDisparo = { ...DEFAULT_DISPARO_CONFIG };
        let treinamentoConcluido = false;

        function getConfigResumoTexto() {
            const typingText = configDisparo.simulateTyping ? 'Simular digitação: ativado' : 'Simular digitação: desativado';
            const randomAIText = configDisparo.randomMessageAI ? 'Randomização IA: ativada' : 'Randomização IA: desativada';
            return `Intervalo entre disparos: ${configDisparo.delayMin}-${configDisparo.delayMax} segundos · Limite: ${configDisparo.messageLimit} mensagens a cada ${configDisparo.windowMinutes} minuto(s) · Pausa automática: ${configDisparo.cooldownMinutes} minuto(s) · ${typingText} · ${randomAIText}`;
        }

        function lerNumeroSeguro(valor, padrao, minimo, maximo) {
            let numero = parseInt(valor, 10);
            if (!Number.isFinite(numero)) numero = padrao;
            if (minimo !== undefined && numero < minimo) numero = minimo;
            if (maximo !== undefined && numero > maximo) numero = maximo;
            return numero;
        }

        function atualizarResumoConfig() {
            const resumo = document.getElementById('configResumo');
            if (resumo) {
                resumo.innerHTML = `
                    <strong>Intervalo entre disparos:</strong> ${configDisparo.delayMin}-${configDisparo.delayMax} segundos<br>
                    <strong>Limite por bloco:</strong> ${configDisparo.messageLimit} mensagens a cada ${configDisparo.windowMinutes} minuto(s)<br>
                    <strong>Pausa automática:</strong> ${configDisparo.cooldownMinutes} minuto(s) até a retomada<br>
                    <strong>Simular digitação:</strong> ${configDisparo.simulateTyping ? 'ativado' : 'desativado'}<br>
                    <strong>Randomização IA:</strong> ${configDisparo.randomMessageAI ? 'ativada' : 'desativada'}
                `;
            }
        }

        function salvarConfigDisparo() {
            localStorage.setItem(CONFIG_DISPARO_STORAGE_KEY, JSON.stringify(configDisparo));
        }

        function aplicarConfigDisparo(event, silencioso = false) {
            if (event && typeof event.preventDefault === 'function') {
                event.preventDefault();
            }

            const delayMinInput = document.getElementById('configDelayMin');
            const delayMaxInput = document.getElementById('configDelayMax');
            const messageLimitInput = document.getElementById('configMessageLimit');
            const cooldownMinutesInput = document.getElementById('configCooldownMinutes');
            const windowMinutesInput = document.getElementById('configWindowMinutes');
            const simulateTypingInput = document.getElementById('configSimulateTyping');
            const randomMessageAIInput = document.getElementById('configRandomMessageAI');

            const delayMin = lerNumeroSeguro(delayMinInput.value, configDisparo.delayMin, 1, 600);
            let delayMax = lerNumeroSeguro(delayMaxInput.value, configDisparo.delayMax, delayMin, 600);
            if (delayMax < delayMin) delayMax = delayMin;

            const messageLimit = lerNumeroSeguro(messageLimitInput.value, configDisparo.messageLimit, 1, 1000);
            const cooldownMinutes = lerNumeroSeguro(cooldownMinutesInput.value, configDisparo.cooldownMinutes, 1, 240);
            const windowMinutes = lerNumeroSeguro(windowMinutesInput.value, configDisparo.windowMinutes, 1, 120);
            const simulateTyping = simulateTypingInput?.checked ?? configDisparo.simulateTyping;
            const randomMessageAI = randomMessageAIInput?.checked ?? configDisparo.randomMessageAI;

            configDisparo = {
                delayMin,
                delayMax,
                messageLimit,
                cooldownMinutes,
                windowMinutes,
                simulateTyping,
                randomMessageAI
            };

            delayMinInput.value = configDisparo.delayMin;
            delayMaxInput.value = configDisparo.delayMax;
            messageLimitInput.value = configDisparo.messageLimit;
            cooldownMinutesInput.value = configDisparo.cooldownMinutes;
            windowMinutesInput.value = configDisparo.windowMinutes;
            if (simulateTypingInput) simulateTypingInput.checked = !!configDisparo.simulateTyping;
            if (randomMessageAIInput) randomMessageAIInput.checked = !!configDisparo.randomMessageAI;

            salvarConfigDisparo();
            atualizarResumoConfig();
            if (!silencioso) {
                mostrarSucesso('Configurações de disparo atualizadas com sucesso!');
            }
        }

        function carregarConfigDisparo() {
            try {
                const stored = localStorage.getItem(CONFIG_DISPARO_STORAGE_KEY);
                if (stored) {
                    const parsed = JSON.parse(stored);
                    configDisparo = {
                        ...DEFAULT_DISPARO_CONFIG,
                        ...parsed
                    };
                }
            } catch (error) {
                console.warn('⚠️ Não foi possível carregar config de disparo:', error);
                configDisparo = { ...DEFAULT_DISPARO_CONFIG };
            }

            const delayMinInput = document.getElementById('configDelayMin');
            const delayMaxInput = document.getElementById('configDelayMax');
            const messageLimitInput = document.getElementById('configMessageLimit');
            const cooldownMinutesInput = document.getElementById('configCooldownMinutes');
            const windowMinutesInput = document.getElementById('configWindowMinutes');
            const simulateTypingInput = document.getElementById('configSimulateTyping');
            const randomMessageAIInput = document.getElementById('configRandomMessageAI');

            if (delayMinInput && delayMaxInput && messageLimitInput && cooldownMinutesInput && windowMinutesInput) {
                delayMinInput.value = configDisparo.delayMin;
                delayMaxInput.value = configDisparo.delayMax;
                messageLimitInput.value = configDisparo.messageLimit;
                cooldownMinutesInput.value = configDisparo.cooldownMinutes;
                windowMinutesInput.value = configDisparo.windowMinutes;
                if (simulateTypingInput) simulateTypingInput.checked = !!configDisparo.simulateTyping;
                if (randomMessageAIInput) randomMessageAIInput.checked = !!configDisparo.randomMessageAI;
                atualizarResumoConfig();
                aplicarConfigDisparo(null, true);
            }
        }

        function bloquearDisparadorTreinamento() {
            treinamentoConcluido = false;
            ['btnIniciarDisparo', 'btnTestarEnvio', 'btnTestarMensagem'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.setAttribute('disabled', 'disabled');
                }
            });
            document.getElementById('treinamentoBloqueio')?.classList.add('ativo');
        }

        function liberarDisparadorTreinamento() {
            treinamentoConcluido = true;
            console.log('🔓 Liberando disparador - treinamento concluído');
            ['btnIniciarDisparo', 'btnTestarEnvio', 'btnTestarMensagem'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.removeAttribute('disabled');
                }
            });
            const bloqueio = document.getElementById('treinamentoBloqueio');
            if (bloqueio) {
                bloqueio.classList.remove('ativo');
                console.log('✅ Card de treinamento ocultado');
            } else {
                console.warn('⚠️ Elemento treinamentoBloqueio não encontrado');
            }
        }

        async function verificarTreinamentoObrigatorio(silencioso = false) {
            try {
                // Usar getAuthHeaders() que já foi criada para garantir consistência
                const headers = await getAuthHeaders();
                console.log('🔍 Verificando treinamento com headers:', { 
                    hasAuth: !!headers.Authorization, 
                    hasEmail: !!headers['X-User-Email'], 
                    hasUserId: !!headers['X-User-Id'] 
                });

                const response = await fetch('/api/treinamentos/status?slug=disparador_mensagens', {
                    method: 'GET',
                    credentials: 'include',
                    headers
                });

                console.log('📡 Resposta do treinamento:', response.status, response.statusText);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.warn('⚠️ Não foi possível verificar treinamento:', response.status, errorText);
                    bloquearDisparadorTreinamento();
                    if (!silencioso) {
                        if (response.status === 401) {
                            mostrarAviso('Faça login novamente para validar o treinamento antes de utilizar o disparador.');
                        } else {
                            mostrarAviso('Não foi possível validar o treinamento. Refaça o login ou repita a verificação após concluir o curso.');
                        }
                    }
                    return;
                }

                const data = await response.json();
                console.log('📊 Dados do treinamento:', data);

                if (data?.concluido) {
                    console.log('✅ Treinamento concluído! Liberando disparador...');
                    liberarDisparadorTreinamento();
                    if (!silencioso) {
                        mostrarSucesso('Treinamento validado! Você pode utilizar o disparador com segurança.');
                    }
                } else {
                    console.log('⚠️ Treinamento não concluído. Bloqueando disparador...');
                    bloquearDisparadorTreinamento();
                    if (!silencioso) {
                        mostrarAviso('Finalize o treinamento "Disparador de Mensagens" antes de utilizar o sistema.');
                    }
                }
            } catch (error) {
                console.error('❌ Erro ao verificar treinamento:', error);
                bloquearDisparadorTreinamento();
                if (!silencioso) {
                    mostrarAviso('Erro ao verificar o treinamento. Tente novamente em instantes.');
                }
            }
        }

async function inicializarSupabase() {
    try {
        const response = await fetch('/api/supabase-config');
        
                if (response.ok) {
        const config = await response.json();
                    
                    if (config.supabaseUrl && config.supabaseAnonKey) {
                        supabaseUrl = config.supabaseUrl;
                        supabaseKey = config.supabaseAnonKey;
                        supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
                        console.log('✅ Supabase configurado com sucesso');
                        
                        // Inicializar chat IA após Supabase estar pronto
                        if (window.inicializarChatIA) {
                            window.inicializarChatIA();
                        }
                        
        return true;
                    } else {
                        console.log('⚠️ Configurações Supabase incompletas, usando modo offline');
                        return false;
                    }
                } else {
                    console.log('⚠️ Endpoint Supabase não disponível, usando modo offline');
                    return false;
                }
    } catch (error) {
                console.log('⚠️ Erro ao configurar Supabase, usando modo offline:', error.message);
        return false;
    }
}

        // ========== VARIÁVEIS GLOBAIS ==========
        let allMotoristas = [];
        let selectedMotoristas = new Set();
        let motoristasFavoritos = new Set(); // Set de IDs de motoristas favoritos
        let currentUser = null; // Usuário atual autenticado
        let currentClass = null;
        let isDisparoAtivo = false;
        let disparoCancelado = false;
        let totalEnviados = 0;
        let totalFalhas = 0;
        
        // Variáveis de paginação otimizada para 20k+ motoristas
let currentPage = 1;
        let itemsPerPage = 50;
        let totalPages = 1;
        let motoristasFiltrados = [];
        let totalMotoristasCount = 0;

        // Estados brasileiros
const estados = [
  'AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA', 
  'MT', 'MS', 'MG', 'PA', 'PB', 'PR', 'PE', 'PI', 'RJ', 'RN', 
  'RS', 'RO', 'RR', 'SC', 'SP', 'SE', 'TO'
];

        // Mapeamentos de tipos de veículo e carroceria (do cadastro.html)
        const tiposVeiculo = {
            leve: ['3/4', 'Fiorino', 'Toco', 'VLC'],
            medio: ['Bitruck', 'Truck'],
            pesado: ['Bitrem', 'Carreta', 'Carreta LS', 'Rodotrem', 'Vanderleia']
        };

        const tiposCarroceriaMap = {
            bau: 'Baú',
            bau_frigorifico: 'Baú Frigorífico',
            bau_refrigerado: 'Baú Refrigerado',
            sider: 'Sider',
            cacamba: 'Caçamba',
            graneleiro: 'Graneleiro',
            plataforma: 'Plataforma',
            prancha: 'Prancha',
            bitrem: 'Bitrem',
            carreta: 'Carreta',
            carreta_ls: 'Carreta LS',
            rodotrem: 'Rodotrem',
            vanderleia: 'Vanderleia',
            apenas_cavalo: 'Apenas Cavalo',
            cegonheiro: 'Cegonheiro',
            gaiola: 'Gaiola',
            tanque: 'Tanque'
        };

        // Função para normalizar strings (remover acentos e converter para minúsculas)
        function normalizarTexto(texto) {
            if (!texto) return '';
            return texto
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '') // Remove acentos
                .trim();
        }

        function normalizarChaveCarroceria(valor) {
            return normalizarTexto(valor || '').replace(/[\s_]/g, '');
        }

        // ========== INICIALIZAÇÃO ==========
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🚀 Inicializando Painel de Disparo Moderno...');
            // 🔐 Verificar permissão de acesso
            const temPermissao = await verificarEAplicarPermissao('painel');
            if (!temPermissao) {
                console.log('❌ Sem permissão para acessar o painel');
                return; // A função verificarEAplicarPermissao já redireciona
            }
            
            // Tentar inicializar Supabase (não crítico)
            const supabaseOk = await inicializarSupabase();
            if (supabaseOk) {
                console.log('✅ Supabase conectado');
            } else {
                console.log('⚠️ Modo offline - usando dados mockados');
            }
            
            carregarConfigDisparo();
            
            await verificarAutenticacao();
            
            // Carregar dados principais PRIMEIRO (sem bloquear)
            await carregarEstatisticas();
            await carregarFiltros();
            await carregarFavoritos(); // Carregar favoritos do usuário
            
            // Inativar automaticamente contatos antigos com erro ao carregar a página
            inativarContatosComErro().catch(err => console.error('Erro ao inativar contatos:', err));
            
            // Selecionar automaticamente a categoria "pesado" ao carregar a página
            if (!currentClass) {
                console.log('🚚 Selecionando categoria "pesado" automaticamente...');
                await selecionarClasse('pesado');
            }
            
            configurarEventos();
            configurarUploadImagem();
            configurarGravacaoAudio();
            
            // Verificar treinamento ANTES de bloquear (para não mostrar o card se já estiver concluído)
            await verificarTreinamentoObrigatorio(true);
            
            // Sincronizar erros em background (não bloqueia o carregamento)
            if (supabaseOk) {
                console.log('🔄 Iniciando sincronização de erros em background...');
                sincronizarErrosDisparos().catch(error => {
                    console.warn('⚠️ Erro na sincronização de erros (não crítico):', error);
                });
            }
            
            console.log('✅ Painel inicializado com sucesso!');

            const configModalEl = document.getElementById('configSistemaModal');
            if (configModalEl && window.bootstrap) {
                const triggerElement = document.querySelector('[data-config-trigger="true"]');
                configModalEl.addEventListener('shown.bs.modal', () => {
                    const focusTarget = configModalEl.querySelector('#configDelayMin');
                    if (focusTarget) {
                        focusTarget.focus();
                    }
                });
                configModalEl.addEventListener('hidden.bs.modal', () => {
                    if (triggerElement) {
                        triggerElement.focus();
                    }
                });
            }
            
            const btnReverificarTreinamento = document.getElementById('btnReverificarTreinamento');
            if (btnReverificarTreinamento) {
                btnReverificarTreinamento.addEventListener('click', async () => {
                    btnReverificarTreinamento.disabled = true;
                    btnReverificarTreinamento.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Verificando...';
                    await verificarTreinamentoObrigatorio();
                    btnReverificarTreinamento.disabled = false;
                    btnReverificarTreinamento.innerHTML = '<i class="fas fa-rotate-right me-2"></i> Já concluí / Revalidar';
                });
            }
        });

        // ========== AUTENTICAÇÃO ==========
        async function verificarAutenticacao() {
            console.log('🔐 Iniciando verificação de autenticação no painel...');
            
            try {
                // Primeiro, verificar se há dados de usuário no localStorage
                const usuarioLocal = localStorage.getItem('loggedInUser');
                const lastActivity = localStorage.getItem('lastActivity');
                
                console.log('📦 Dados do localStorage:', usuarioLocal ? 'Encontrados' : 'Não encontrados');
                console.log('📦 Conteúdo do localStorage:', usuarioLocal);
                
                if (usuarioLocal) {
                    let userData;
                    try {
                        userData = JSON.parse(usuarioLocal);
                    } catch (parseError) {
                        console.log('⚠️ Erro ao fazer parse do localStorage, usando como string');
                        userData = { username: usuarioLocal, email: usuarioLocal };
                    }
                    
                    const timeDiff = lastActivity ? Date.now() - parseInt(lastActivity) : 0;
                    const hoursDiff = timeDiff / (1000 * 60 * 60);
                    
                    console.log('👤 Dados do usuário:', userData);
                    console.log('⏰ Idade da sessão:', hoursDiff.toFixed(1), 'horas');
                    
                    // Sessão válida por 12 horas (ou sem limite se não há lastActivity)
                    if (!lastActivity || hoursDiff < 12) {
                        currentUser = userData.username || userData.email || userData;
                        document.getElementById('userName').textContent = currentUser;
                        console.log('✅ Usuário autenticado via localStorage:', currentUser);
                        return;
                    } else {
                        console.log('⏰ Sessão expirada, removendo dados');
                        localStorage.removeItem('loggedInUser');
                        localStorage.removeItem('lastActivity');
                    }
                }
                
                // Tentar verificar via Supabase se disponível
                if (window.supabase) {
                    console.log('🔍 Verificando via Supabase...');
                    try {
                        const { data: { session }, error } = await window.supabase.auth.getSession();
                        if (session && session.user) {
                            currentUser = session.user.email;
                    document.getElementById('userName').textContent = currentUser;
                            console.log('✅ Usuário autenticado via Supabase:', currentUser);
                            return;
                } else {
                            console.log('⚠️ Nenhuma sessão ativa no Supabase');
                        }
                    } catch (supabaseError) {
                        console.log('⚠️ Erro ao verificar Supabase:', supabaseError);
                    }
                } else {
                    console.log('⚠️ Supabase não disponível');
                }
                
                console.log('❌ Usuário não autenticado, redirecionando...');
                window.location.href = 'login.html';
                
            } catch (error) {
                console.error('❌ Erro na autenticação:', error);
                
                // Fallback: tentar usar dados locais se disponíveis
                const usuarioLocal = localStorage.getItem('loggedInUser');
                if (usuarioLocal) {
                    try {
                        const userData = JSON.parse(usuarioLocal);
                        currentUser = userData.username || userData.email || userData;
                    } catch {
                    currentUser = usuarioLocal;
                    }
                    document.getElementById('userName').textContent = currentUser;
                    console.log('⚠️ Usando dados locais devido a erro de rede');
                } else {
                    console.log('❌ Redirecionando para login...');
                    window.location.href = 'login.html';
                }
            }
        }

        // ========== CARREGAR ESTATÍSTICAS (OTIMIZADO PARA 20K+) ==========
        async function carregarEstatisticas() {
            console.log('📊 Iniciando carregamento de estatísticas...');
            try {
                // Tentar carregar do Supabase com contagem otimizada
                if (!supabase) {
                    console.warn('⚠️ Supabase não inicializado, usando dados mockados');
                    throw new Error('Supabase não inicializado');
                }
                
                console.log('🔍 Buscando contagens do Supabase...');
                
                // Contar total de motoristas
                const { count: totalCount, error: totalError } = await supabase
                    .from('motoristas')
                    .select('*', { count: 'exact', head: true });

                if (totalError) {
                    console.error('❌ Erro ao contar total de motoristas:', totalError);
                    throw totalError;
                }
                
                // Contar motoristas ativos
                const { count: ativosCount, error: ativosError } = await supabase
                    .from('motoristas')
                    .select('*', { count: 'exact', head: true })
                    .eq('status', 'ativo');

                if (ativosError) {
                    console.error('❌ Erro ao contar motoristas ativos:', ativosError);
                    throw ativosError;
                }
                
                // Contar motoristas inativos
                const { count: inativosCount, error: inativosError } = await supabase
                    .from('motoristas')
                    .select('*', { count: 'exact', head: true })
                    .eq('status', 'inativo');

                if (inativosError) {
                    console.error('❌ Erro ao contar motoristas inativos:', inativosError);
                    throw inativosError;
                }

                // Contar por classe de veículo
                console.log('🔍 Contando motoristas por classe...');
                const { count: leveCount, error: leveError } = await supabase
                    .from('motoristas')
                    .select('*', { count: 'exact', head: true })
                    .eq('classe_veiculo', 'leve')
                    .eq('status', 'ativo');

                const { count: medioCount, error: medioError } = await supabase
                    .from('motoristas')
                    .select('*', { count: 'exact', head: true })
                    .eq('classe_veiculo', 'medio')
                    .eq('status', 'ativo');

                const { count: pesadoCount, error: pesadoError } = await supabase
                    .from('motoristas')
                    .select('*', { count: 'exact', head: true })
                    .eq('classe_veiculo', 'pesado')
                    .eq('status', 'ativo');

                if (leveError) console.warn('⚠️ Erro ao contar leve:', leveError);
                if (medioError) console.warn('⚠️ Erro ao contar médio:', medioError);
                if (pesadoError) console.warn('⚠️ Erro ao contar pesado:', pesadoError);
                
                totalMotoristasCount = totalCount || 0;
                const totalAtivos = ativosCount || 0;
                const totalInativos = inativosCount || 0;
                const leve = leveCount || 0;
                const medio = medioCount || 0;
                const pesado = pesadoCount || 0;
                
                console.log(`📊 Total de motoristas no Supabase: ${totalMotoristasCount.toLocaleString('pt-BR')}`);
                console.log(`📊 Motoristas ativos: ${totalAtivos.toLocaleString('pt-BR')}`);
                console.log(`📊 Motoristas inativos: ${totalInativos.toLocaleString('pt-BR')}`);
                console.log(`📊 Por classe - Leve: ${leve}, Médio: ${medio}, Pesado: ${pesado}`);
                
                // Atualizar interface com dados reais
                const totalMotoristasEl = document.getElementById('totalMotoristas');
                const motoristasAtivosEl = document.getElementById('motoristasAtivos');
                const motoristasInativosEl = document.getElementById('motoristasInativos');
                const motoristasSelecionadosEl = document.getElementById('motoristasSelecionados');
                const categoriaAtivaEl = document.getElementById('categoriaAtiva');
                const countLeveEl = document.getElementById('count-leve');
                const countMedioEl = document.getElementById('count-medio');
                const countPesadoEl = document.getElementById('count-pesado');
                
                if (totalMotoristasEl) {
                    totalMotoristasEl.textContent = totalMotoristasCount.toLocaleString('pt-BR');
                } else {
                    console.warn('⚠️ Elemento totalMotoristas não encontrado');
                }
                
                if (motoristasAtivosEl) {
                    motoristasAtivosEl.textContent = totalAtivos.toLocaleString('pt-BR');
                } else {
                    console.warn('⚠️ Elemento motoristasAtivos não encontrado');
                }
                
                if (motoristasInativosEl) {
                    motoristasInativosEl.textContent = totalInativos.toLocaleString('pt-BR');
                } else {
                    console.warn('⚠️ Elemento motoristasInativos não encontrado');
                }
                
                if (motoristasSelecionadosEl) {
                    motoristasSelecionadosEl.textContent = '0';
                }
                
                if (categoriaAtivaEl) {
                    categoriaAtivaEl.textContent = '-';
                }
                
                // Atualizar contadores de categoria
                if (countLeveEl) {
                    countLeveEl.textContent = `${leve.toLocaleString('pt-BR')} motoristas`;
                    console.log(`✅ Atualizado count-leve: ${leve}`);
                } else {
                    console.warn('⚠️ Elemento count-leve não encontrado');
                }
                
                if (countMedioEl) {
                    countMedioEl.textContent = `${medio.toLocaleString('pt-BR')} motoristas`;
                    console.log(`✅ Atualizado count-medio: ${medio}`);
                } else {
                    console.warn('⚠️ Elemento count-medio não encontrado');
                }
                
                if (countPesadoEl) {
                    countPesadoEl.textContent = `${pesado.toLocaleString('pt-BR')} motoristas`;
                    console.log(`✅ Atualizado count-pesado: ${pesado}`);
                } else {
                    console.warn('⚠️ Elemento count-pesado não encontrado');
                }
                
            } catch (error) {
                console.error('❌ Erro ao carregar estatísticas:', error);
                console.error('❌ Detalhes do erro:', error.message, error.code, error.details);
                
                // Fallback para dados mockados
                totalMotoristasCount = 1000;
                const totalAtivos = 950;
                const totalInativos = 50;
                const leve = 350;
                const medio = 300;
                const pesado = 300;
                
                const totalMotoristasEl = document.getElementById('totalMotoristas');
                const motoristasAtivosEl = document.getElementById('motoristasAtivos');
                const motoristasInativosEl = document.getElementById('motoristasInativos');
                const motoristasSelecionadosEl = document.getElementById('motoristasSelecionados');
                const categoriaAtivaEl = document.getElementById('categoriaAtiva');
                const countLeveEl = document.getElementById('count-leve');
                const countMedioEl = document.getElementById('count-medio');
                const countPesadoEl = document.getElementById('count-pesado');
                
                if (totalMotoristasEl) {
                    totalMotoristasEl.textContent = totalMotoristasCount.toLocaleString('pt-BR');
                }
                if (motoristasAtivosEl) {
                    motoristasAtivosEl.textContent = totalAtivos.toLocaleString('pt-BR');
                }
                if (motoristasInativosEl) {
                    motoristasInativosEl.textContent = totalInativos.toLocaleString('pt-BR');
                }
                if (motoristasSelecionadosEl) {
                    motoristasSelecionadosEl.textContent = '0';
                }
                if (categoriaAtivaEl) {
                    categoriaAtivaEl.textContent = '-';
                }
                
                // Atualizar contadores de categoria
                if (countLeveEl) {
                    countLeveEl.textContent = `${leve.toLocaleString('pt-BR')} motoristas`;
                }
                if (countMedioEl) {
                    countMedioEl.textContent = `${medio.toLocaleString('pt-BR')} motoristas`;
                }
                if (countPesadoEl) {
                    countPesadoEl.textContent = `${pesado.toLocaleString('pt-BR')} motoristas`;
                }
                
                mostrarAviso('Usando dados de exemplo - Supabase não disponível');
            }
        }

        // ========== CARREGAR FILTROS ==========
        async function carregarFiltros() {
            console.log('🔧 Carregando filtros...');
            
            // Carregar estados
            const filtroEstado = document.getElementById('filtroEstado');
            const dropdownEstadoMenu = document.getElementById('dropdownEstadoMenu');
            const dropdownEstadoLabel = document.getElementById('dropdownEstadoLabel');

            if (filtroEstado) {
                filtroEstado.innerHTML = '<option value=\"\">Todos os estados</option>';
                if (dropdownEstadoMenu) {
                    dropdownEstadoMenu.innerHTML = '';
                }

                const atualizarLabelEstado = () => {
                    const selecionados = Array.from(filtroEstado.selectedOptions)
                        .map(opt => opt.value)
                        .filter(v => v && v.trim() !== '');

                    if (!dropdownEstadoLabel) return;

                    if (selecionados.length === 0) {
                        dropdownEstadoLabel.textContent = 'Todos os estados';
                    } else if (selecionados.length === 1) {
                        dropdownEstadoLabel.textContent = selecionados[0];
                    } else {
                        dropdownEstadoLabel.textContent = `${selecionados.length} estados selecionados`;
                    }
                };

                // Checkbox "Todos os estados"
                if (dropdownEstadoMenu) {
                    const itemTodos = document.createElement('div');
                    itemTodos.className = 'dropdown-item';
                    itemTodos.innerHTML = `
                        <div class=\"form-check\">
                            <input class=\"form-check-input\" type=\"checkbox\" id=\"chkEstadoTodos\" checked>
                            <label class=\"form-check-label\" for=\"chkEstadoTodos\">Todos os estados</label>
                        </div>
                    `;
                    dropdownEstadoMenu.appendChild(itemTodos);

                    const chkTodos = itemTodos.querySelector('input');
                    chkTodos.addEventListener('change', () => {
                        if (chkTodos.checked) {
                            Array.from(filtroEstado.options).forEach(opt => { opt.selected = false; });
                            Array.from(dropdownEstadoMenu.querySelectorAll('.form-check-input'))
                                .forEach(input => {
                                    if (input !== chkTodos) input.checked = false;
                                });
                            atualizarLabelEstado();
                            aplicarFiltros();
                        } else {
                            const algumOutroMarcado = Array.from(dropdownEstadoMenu.querySelectorAll('.form-check-input'))
                                .some(input => input !== chkTodos && input.checked);
                            if (!algumOutroMarcado) {
                                chkTodos.checked = true;
                            }
                        }
                    });
                }

                estados.forEach(estado => {
                    const option = document.createElement('option');
                    option.value = estado;
                    option.textContent = estado;
                    filtroEstado.appendChild(option);

                    if (dropdownEstadoMenu) {
                        const idCheck = `chkEstado_${estado.replace(/[^a-zA-Z0-9]/g, '_')}`;
                        const item = document.createElement('div');
                        item.className = 'dropdown-item';
                        item.innerHTML = `
                            <div class=\"form-check\">
                                <input class=\"form-check-input\" type=\"checkbox\" id=\"${idCheck}\" data-valor=\"${estado}\">
                                <label class=\"form-check-label\" for=\"${idCheck}\">${estado}</label>
                            </div>
                        `;
                        dropdownEstadoMenu.appendChild(item);

                        const input = item.querySelector('input');
                        input.addEventListener('change', () => {
                            const optMatch = Array.from(filtroEstado.options).find(o => o.value === estado);
                            if (optMatch) {
                                optMatch.selected = input.checked;
                            }

                            const chkTodos = dropdownEstadoMenu.querySelector('#chkEstadoTodos');
                            if (chkTodos) {
                                if (input.checked) {
                                    chkTodos.checked = false;
                                } else {
                                    const algumMarcado = Array.from(dropdownEstadoMenu.querySelectorAll('.form-check-input'))
                                        .some(el => el !== chkTodos && el.checked);
                                    if (!algumMarcado) {
                                        chkTodos.checked = true;
                                        Array.from(filtroEstado.options).forEach(opt => { opt.selected = false; });
                                    }
                                }
                            }

                            atualizarLabelEstado();
                            aplicarFiltros();
                        });
                    }
                });

                atualizarLabelEstado();
                console.log('✅ Filtro de estados carregado');
            }

            // Carregar tipos de veículo do backend (distinct via service role)
            const filtroTipoVeiculo = document.getElementById('filtroTipoVeiculo');
            const dropdownTipoVeiculoMenu = document.getElementById('dropdownTipoVeiculoMenu');
            const dropdownTipoVeiculoLabel = document.getElementById('dropdownTipoVeiculoLabel');

            if (filtroTipoVeiculo) {
                filtroTipoVeiculo.innerHTML = '<option value=\"\">Todos os tipos</option>';
                if (dropdownTipoVeiculoMenu) {
                    dropdownTipoVeiculoMenu.innerHTML = '';
                }

                // Helper para atualizar o texto do botão conforme seleção
                const atualizarLabelTipoVeiculo = () => {
                    const selecionados = Array.from(filtroTipoVeiculo.selectedOptions)
                        .map(opt => opt.value)
                        .filter(v => v && v.trim() !== '');

                    if (!dropdownTipoVeiculoLabel) return;

                    if (selecionados.length === 0) {
                        dropdownTipoVeiculoLabel.textContent = 'Todos os tipos';
                    } else if (selecionados.length === 1) {
                        dropdownTipoVeiculoLabel.textContent = selecionados[0];
                    } else {
                        dropdownTipoVeiculoLabel.textContent = `${selecionados.length} tipos selecionados`;
                    }
                };

                try {
                    const resp = await fetch('/api/filtros/motoristas/tipos');
                    if (resp.ok) {
                        const json = await resp.json();
                        const valoresMap = new Map();

                        (json.tipos || []).forEach(tipo => {
                            const valor = (tipo || '').trim();
                            if (!valor) return;

                            const chave = valor.toLowerCase();
                            if (!valoresMap.has(chave)) {
                                valoresMap.set(chave, valor);
                            }
                        });

                        // Garantir que tipos críticos estejam presentes
                        ['Carreta', 'Bitrem', 'Rodotrem'].forEach(tipo => {
                            const chave = tipo.toLowerCase();
                            if (!valoresMap.has(chave)) {
                                valoresMap.set(chave, tipo);
                            }
                        });

                        // Criar checkbox "Todos"
                        if (dropdownTipoVeiculoMenu) {
                            const itemTodos = document.createElement('div');
                            itemTodos.className = 'dropdown-item';
                            itemTodos.innerHTML = `
                                <div class=\"form-check\">
                                    <input class=\"form-check-input\" type=\"checkbox\" id=\"chkTipoVeiculoTodos\" checked>
                                    <label class=\"form-check-label\" for=\"chkTipoVeiculoTodos\">Todos os tipos</label>
                                </div>
                            `;
                            dropdownTipoVeiculoMenu.appendChild(itemTodos);

                            const chkTodos = itemTodos.querySelector('input');
                            chkTodos.addEventListener('change', () => {
                                if (chkTodos.checked) {
                                    // Limpar todas as seleções no select e nos outros checkboxes
                                    Array.from(filtroTipoVeiculo.options).forEach(opt => { opt.selected = false; });
                                    Array.from(dropdownTipoVeiculoMenu.querySelectorAll('.form-check-input'))
                                        .forEach(input => {
                                            if (input !== chkTodos) input.checked = false;
                                        });
                                    atualizarLabelTipoVeiculo();
                                    aplicarFiltros();
                                } else {
                                    // Evitar estado sem nada marcado: mantemos "Todos" ligado se nenhum outro estiver marcado
                                    const algumOutroMarcado = Array.from(dropdownTipoVeiculoMenu.querySelectorAll('.form-check-input'))
                                        .some(input => input !== chkTodos && input.checked);
                                    if (!algumOutroMarcado) {
                                        chkTodos.checked = true;
                                    }
                                }
                            });
                        }

                        Array.from(valoresMap.values())
                            .sort((a, b) => a.localeCompare(b, 'pt-BR'))
                            .forEach(valor => {
                                const option = document.createElement('option');
                                option.value = valor;
                                option.textContent = valor;
                                filtroTipoVeiculo.appendChild(option);

                                if (dropdownTipoVeiculoMenu) {
                                    const idCheck = `chkTipoVeiculo_${valor.replace(/[^a-zA-Z0-9]/g, '_')}`;
                                    const item = document.createElement('div');
                                    item.className = 'dropdown-item';
                                    item.innerHTML = `
                                        <div class=\"form-check\">
                                            <input class=\"form-check-input\" type=\"checkbox\" id=\"${idCheck}\" data-valor=\"${valor}\">
                                            <label class=\"form-check-label\" for=\"${idCheck}\">${valor}</label>
                                        </div>
                                    `;
                                    dropdownTipoVeiculoMenu.appendChild(item);

                                    const input = item.querySelector('input');
                                    input.addEventListener('change', () => {
                                        const optMatch = Array.from(filtroTipoVeiculo.options).find(o => o.value === valor);
                                        if (optMatch) {
                                            optMatch.selected = input.checked;
                                        }

                                        // Se qualquer um específico estiver marcado, desmarca "Todos"
                                        const chkTodos = dropdownTipoVeiculoMenu.querySelector('#chkTipoVeiculoTodos');
                                        if (chkTodos) {
                                            if (input.checked) {
                                                chkTodos.checked = false;
                                            } else {
                                                const algumMarcado = Array.from(dropdownTipoVeiculoMenu.querySelectorAll('.form-check-input'))
                                                    .some(el => el !== chkTodos && el.checked);
                                                if (!algumMarcado) {
                                                    chkTodos.checked = true;
                                                    // E limpar seleção no select
                                                    Array.from(filtroTipoVeiculo.options).forEach(opt => { opt.selected = false; });
                                                }
                                            }
                                        }

                                        atualizarLabelTipoVeiculo();
                                        aplicarFiltros();
                                    });
                                }
                            });

                        atualizarLabelTipoVeiculo();
                        console.log('✅ Filtro de tipos de veículo carregado:', (json.tipos||[]).length);
                    }
                } catch (error) {
                    console.warn('⚠️ Erro ao carregar tipos de veículo:', error.message);
                }
                
                console.log('✅ Filtro de tipos de veículo carregado');
            }

            // Carregar carrocerias do backend (distinct via service role)
            const filtroCarroceria = document.getElementById('filtroCarroceria');
            const dropdownCarroceriaMenu = document.getElementById('dropdownCarroceriaMenu');
            const dropdownCarroceriaLabel = document.getElementById('dropdownCarroceriaLabel');

            if (filtroCarroceria) {
                filtroCarroceria.innerHTML = '<option value=\"\">Todas as carrocerias</option>';
                if (dropdownCarroceriaMenu) {
                    dropdownCarroceriaMenu.innerHTML = '';
                }

                const atualizarLabelCarroceria = () => {
                    const selecionados = Array.from(filtroCarroceria.selectedOptions)
                        .map(opt => opt.value)
                        .filter(v => v && v.trim() !== '');

                    if (!dropdownCarroceriaLabel) return;

                    if (selecionados.length === 0) {
                        dropdownCarroceriaLabel.textContent = 'Todas as carrocerias';
                    } else if (selecionados.length === 1) {
                        dropdownCarroceriaLabel.textContent = selecionados[0];
                    } else {
                        dropdownCarroceriaLabel.textContent = `${selecionados.length} carrocerias selecionadas`;
                    }
                };

                try {
                    const resp = await fetch('/api/filtros/motoristas/carrocerias');
                    if (resp.ok) {
                        const json = await resp.json();
                        // Usar Map para evitar duplicações case-insensitive e com variações de acentos/underscore
                        const valoresMap = new Map();
                        
                        const adicionarCarroceria = (valor) => {
                            const valorLimpo = (valor || '').trim();
                            if (!valorLimpo) return;
                            
                            const chave = normalizarChaveCarroceria(valorLimpo);
                            if (!chave) return;
                            
                            // Padronizar label (substituir underscores por espaços e capitalizar)
                            const labelFormatado = valorLimpo
                                .replace(/_/g, ' ')
                                .replace(/\s+/g, ' ')
                                .split(' ')
                                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                                .join(' ')
                                .trim();
                            
                            if (!valoresMap.has(chave)) {
                                valoresMap.set(chave, labelFormatado);
                            }
                        };
                        
                        // Primeiro, adicionar valores do backend
                        (json.carrocerias||[]).forEach(adicionarCarroceria);
                        
                        // Depois, adicionar valores padronizados do cadastro (sobrescrevem se já existirem)
                        Object.values(tiposCarroceriaMap||{}).forEach(lbl => {
                            if (!lbl) return;
                            const chave = normalizarChaveCarroceria(lbl);
                            if (!chave) return;
                            valoresMap.set(chave, lbl);
                        });
                        
                        const listaOrdenada = Array.from(valoresMap.values())
                            .sort((a,b)=> a.localeCompare(b,'pt-BR'));

                        // Checkbox "Todas"
                        if (dropdownCarroceriaMenu) {
                            const itemTodas = document.createElement('div');
                            itemTodas.className = 'dropdown-item';
                            itemTodas.innerHTML = `
                                <div class=\"form-check\">
                                    <input class=\"form-check-input\" type=\"checkbox\" id=\"chkCarroceriaTodas\" checked>
                                    <label class=\"form-check-label\" for=\"chkCarroceriaTodas\">Todas as carrocerias</label>
                                </div>
                            `;
                            dropdownCarroceriaMenu.appendChild(itemTodas);

                            const chkTodas = itemTodas.querySelector('input');
                            chkTodas.addEventListener('change', () => {
                                if (chkTodas.checked) {
                                    Array.from(filtroCarroceria.options).forEach(opt => { opt.selected = false; });
                                    Array.from(dropdownCarroceriaMenu.querySelectorAll('.form-check-input'))
                                        .forEach(input => {
                                            if (input !== chkTodas) input.checked = false;
                                        });
                                    atualizarLabelCarroceria();
                                    aplicarFiltros();
                                } else {
                                    const algumOutroMarcado = Array.from(dropdownCarroceriaMenu.querySelectorAll('.form-check-input'))
                                        .some(input => input !== chkTodas && input.checked);
                                    if (!algumOutroMarcado) {
                                        chkTodas.checked = true;
                                    }
                                }
                            });
                        }

                        listaOrdenada.forEach(valorOriginal => {
                            const option = document.createElement('option');
                            option.value = valorOriginal;
                            option.textContent = valorOriginal;
                            filtroCarroceria.appendChild(option);

                            if (dropdownCarroceriaMenu) {
                                const idCheck = `chkCarroceria_${valorOriginal.replace(/[^a-zA-Z0-9]/g, '_')}`;
                                const item = document.createElement('div');
                                item.className = 'dropdown-item';
                                item.innerHTML = `
                                    <div class=\"form-check\">
                                        <input class=\"form-check-input\" type=\"checkbox\" id=\"${idCheck}\" data-valor=\"${valorOriginal}\">
                                        <label class=\"form-check-label\" for=\"${idCheck}\">${valorOriginal}</label>
                                    </div>
                                `;
                                dropdownCarroceriaMenu.appendChild(item);

                                const input = item.querySelector('input');
                                input.addEventListener('change', () => {
                                    const optMatch = Array.from(filtroCarroceria.options).find(o => o.value === valorOriginal);
                                    if (optMatch) {
                                        optMatch.selected = input.checked;
                                    }

                                    const chkTodas = dropdownCarroceriaMenu.querySelector('#chkCarroceriaTodas');
                                    if (chkTodas) {
                                        if (input.checked) {
                                            chkTodas.checked = false;
                                        } else {
                                            const algumMarcado = Array.from(dropdownCarroceriaMenu.querySelectorAll('.form-check-input'))
                                                .some(el => el !== chkTodas && el.checked);
                                            if (!algumMarcado) {
                                                chkTodas.checked = true;
                                                Array.from(filtroCarroceria.options).forEach(opt => { opt.selected = false; });
                                            }
                                        }
                                    }

                                    atualizarLabelCarroceria();
                                    aplicarFiltros();
                                });
                            }
                        });

                        atualizarLabelCarroceria();
                        console.log('✅ Filtro de carrocerias carregado com', listaOrdenada.length, 'opções');
                    }
                } catch (error) {
                    console.warn('⚠️ Erro ao carregar carrocerias:', error.message);
                }
            }
        }

        // ========== CONFIGURAR EVENTOS ==========
        function configurarEventos() {
            // Seleção de classes de veículo
            document.querySelectorAll('.vehicle-class').forEach(element => {
                element.addEventListener('click', () => {
                    const classe = element.dataset.class;
                    selecionarClasse(classe);
                });
            });

            // Botões de ação
            document.getElementById('btnSelecionarTodos').addEventListener('click', selecionarTodos);
            document.getElementById('btnSelecionarPagina').addEventListener('click', selecionarPaginaAtual);
            document.getElementById('btnLimparSelecao').addEventListener('click', limparSelecao);
            document.getElementById('btnTestarMensagem').addEventListener('click', testarMensagem);
            document.getElementById('btnTestarEnvio').addEventListener('click', testarEnvioReal);
            document.getElementById('btnIniciarDisparo').addEventListener('click', iniciarDisparo);
            document.getElementById('btnPararDisparo').addEventListener('click', pararDisparo);
            document.getElementById('btnBuscar').addEventListener('click', aplicarFiltros);
            document.getElementById('btnVerificarEvolution').addEventListener('click', verificarEvolutionAPI);
            const btnGerarQRCode = document.getElementById('btnGerarQRCode');
            if (btnGerarQRCode) {
                btnGerarQRCode.addEventListener('click', gerarQRCodeEvolution);
            }
            const btnDeslogarInstancia = document.getElementById('btnDeslogarInstancia');
            if (btnDeslogarInstancia) {
                btnDeslogarInstancia.addEventListener('click', deslogarInstanciaEvolution);
            }
            const btnAplicarConfig = document.getElementById('btnAplicarConfig');
            if (btnAplicarConfig) {
                btnAplicarConfig.addEventListener('click', aplicarConfigDisparo);
            }
            ['configDelayMin','configDelayMax','configMessageLimit','configCooldownMinutes','configWindowMinutes','configSimulateTyping','configRandomMessageAI'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('change', () => aplicarConfigDisparo(null, true));
                    input.addEventListener('blur', () => aplicarConfigDisparo(null, true));
                }
            });

            // Filtros simples (estado, status, busca, favoritos)
            document.getElementById('filtroEstado').addEventListener('change', aplicarFiltros);
            document.getElementById('filtroStatus').addEventListener('change', aplicarFiltros);
            document.getElementById('filtroBusca').addEventListener('input', aplicarFiltros);
            document.getElementById('filtroFavoritos').addEventListener('change', aplicarFiltros);

            // Paginação
            document.getElementById('itensPorPagina').addEventListener('change', (e) => {
                itemsPerPage = parseInt(e.target.value);
                currentPage = 1;
                atualizarListaMotoristas(motoristasFiltrados);
            });

            console.log('✅ Eventos configurados');
        }

        // ========== OBTER HEADERS DE AUTENTICAÇÃO ==========
        async function getAuthHeaders() {
            const headers = {
                'Content-Type': 'application/json'
            };
            
            // Tentar obter token do Supabase
            if (supabase) {
                try {
                    const { data: { session } } = await supabase.auth.getSession();
                    if (session && session.access_token) {
                        headers['Authorization'] = `Bearer ${session.access_token}`;
                    }
                } catch (error) {
                    console.warn('⚠️ Erro ao obter sessão:', error);
                }
            }
            
            // Tentar obter email do localStorage (loggedInUser primeiro, depois userData como fallback)
            try {
                let userEmail = null;
                let userId = null;

                // Tentar loggedInUser primeiro
                const loggedInUserData = localStorage.getItem('loggedInUser');
                if (loggedInUserData) {
                    const parsed = JSON.parse(loggedInUserData);
                    userEmail = parsed.email;
                    userId = parsed.id;
                }

                // Fallback para userData
                if (!userEmail) {
                    const userData = localStorage.getItem('userData');
                    if (userData) {
                        const parsed = JSON.parse(userData);
                        userEmail = parsed.email;
                        userId = parsed.id;
                    }
                }

                if (userEmail) {
                    headers['X-User-Email'] = userEmail;
                }
                if (userId) {
                    headers['X-User-Id'] = userId;
                }
            } catch (error) {
                console.warn('⚠️ Erro ao obter email do localStorage:', error);
            }
            
            return headers;
        }

        // ========== SINCRONIZAR ERROS DE DISPAROS ==========
        async function sincronizarErrosDisparos() {
            try {
                console.log('🔄 Sincronizando erros de disparos da tabela disparos_log...');
                const headers = await getAuthHeaders();
                const response = await fetch('/api/motoristas/sincronizar-erros-disparos', {
                    method: 'POST',
                    headers: { ...headers, 'Content-Type': 'application/json' },
                    credentials: 'include'
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ Erro na resposta da sincronização:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                console.log('📊 Resultado da sincronização:', data);
                
                if (data.success) {
                    const mensagem = `✅ Sincronização concluída: ${data.processados} números processados, ${data.atualizados} motoristas atualizados, ${data.naoEncontrados} não encontrados`;
                    console.log(mensagem);
                    
                    // Mostrar notificação ao usuário
                    if (data.atualizados > 0) {
                        mostrarAviso(mensagem);
                    } else if (data.processados > 0 && data.atualizados === 0) {
                        mostrarAviso(`⚠️ ${data.processados} números processados mas nenhum motorista foi atualizado. Verifique se os números correspondem aos telefones dos motoristas.`);
                    }
                    
                    // Recarregar a lista apenas se houver uma classe selecionada E se a página já estiver carregada
                    // (evita recarregar durante a inicialização)
                    if (currentClass && document.readyState === 'complete') {
                        console.log('🔄 Recarregando lista de motoristas após sincronização...');
                        // Usar setTimeout para não bloquear
                        setTimeout(() => {
                            carregarMotoristas(currentClass).catch(error => {
                                console.warn('⚠️ Erro ao recarregar motoristas após sincronização:', error);
                            });
                        }, 1000);
                    }
                } else {
                    const erroMsg = `⚠️ Sincronização não teve sucesso: ${data.error}`;
                    console.warn(erroMsg);
                    mostrarAviso(erroMsg);
                }
            } catch (error) {
                console.error('❌ Erro ao sincronizar erros de disparos:', error);
                // Não bloquear o carregamento da página se a sincronização falhar
            }
        }

        // ========== SELEÇÃO DE CLASSE ==========
        // Tornar função global para ser acessível via onclick
        window.selecionarClasse = async function(classe) {
            currentClass = classe;
            selectedMotoristas.clear();

            // Atualizar interface
            document.querySelectorAll('.vehicle-class').forEach(el => el.classList.remove('active'));
            const classeElement = document.querySelector(`[data-class="${classe}"]`);
            if (classeElement) {
                classeElement.classList.add('active');
            }
            
            const categoriaAtivaEl = document.getElementById('categoriaAtiva');
            if (categoriaAtivaEl) {
                categoriaAtivaEl.textContent = classe.charAt(0).toUpperCase() + classe.slice(1);
            }
            
            // Carregar motoristas da classe (otimizado para 20k+)
            await carregarMotoristas(classe);
        };

        // ========== CARREGAR MOTORISTAS (OTIMIZADO PARA 20K+) ==========
        async function carregarMotoristas(classe) {
            console.log(`🚚 Iniciando carregamento de motoristas da classe: ${classe}`);
            const motoristasList = document.getElementById('motoristasList');
            if (!motoristasList) {
                console.error('❌ Elemento motoristasList não encontrado!');
                return;
            }
            motoristasList.innerHTML = '<div class="text-center py-3"><div class="loading-spinner me-2"></div>Carregando motoristas...</div>';

            try {
                let todosMotoristas = [];
                
                // Tentar carregar do Supabase com paginação otimizada
                if (!supabase) {
                    console.warn('⚠️ Supabase não inicializado, usando dados mockados');
                    todosMotoristas = allMotoristas.filter(m => m.classe_veiculo === classe && m.status === 'ativo');
                } else {
                    console.log(`🔍 Carregando TODOS os motoristas da classe ${classe}...`);
                    
                    // Carregar TODOS os motoristas da classe (sem limite)
                    let from = 0;
                    const limit = 1000; // Carregar em lotes de 1000
                    let hasMore = true;
                    
                    // Obter filtro de status do select (padrão: 'ativo')
                    const filtroStatus = document.getElementById('filtroStatus')?.value || 'ativo';
                    
                    while (hasMore) {
                        console.log(`📥 Buscando motoristas: de ${from} até ${from + limit - 1}`);
                        let query = supabase
                            .from('motoristas')
                            .select('id, nome, telefone1, telefone2, estado, classe_veiculo, tipo_veiculo, tipo_carroceria, status, telefone1_erro, telefone2_erro, telefone1_erro_motivo, telefone2_erro_motivo')
                            .eq('classe_veiculo', classe);
                        
                        // Aplicar filtro de status se especificado
                        if (filtroStatus) {
                            query = query.eq('status', filtroStatus);
                        }
                        
                        const { data: motoristas, error } = await query
                            .order('nome')
                            .range(from, from + limit - 1);

                        if (error) {
                            console.error('❌ Erro ao buscar motoristas:', error);
                            throw error;
                        }
                        
                        if (motoristas && motoristas.length > 0) {
                            todosMotoristas = todosMotoristas.concat(motoristas);
                            from += limit;
                            
                            // Atualizar progresso
                            motoristasList.innerHTML = `<div class="text-center py-3"><div class="loading-spinner me-2"></div>Carregando motoristas... ${todosMotoristas.length.toLocaleString('pt-BR')} encontrados</div>`;
                            
                            // Se retornou menos que o limite, não há mais dados
                            if (motoristas.length < limit) {
                                hasMore = false;
                            }
                        } else {
                            hasMore = false;
                        }
                    }
                    
                    console.log(`📞 ${todosMotoristas.length.toLocaleString('pt-BR')} motoristas carregados para classe ${classe}`);
                }
                
                // Armazenar todos os motoristas filtrados
                motoristasFiltrados = todosMotoristas;
                currentPage = 1;
                
                console.log(`✅ Total de motoristas filtrados: ${motoristasFiltrados.length}`);
                
                // Atualizar estatísticas
                const selecionadosEl = document.getElementById('motoristasSelecionados');
                const selecionadosBadgeEl = document.getElementById('motoristasSelecionadosBadge');
                if (selecionadosEl) selecionadosEl.textContent = '0';
                if (selecionadosBadgeEl) selecionadosBadgeEl.textContent = '0 selecionados';
                
                atualizarListaMotoristas(motoristasFiltrados);
                
            } catch (error) {
                console.error('❌ Erro ao carregar motoristas:', error);
                console.error('❌ Detalhes do erro:', error.message, error.code, error.details);
                
                // Mostrar mensagem de erro na lista
                const motoristasList = document.getElementById('motoristasList');
                if (motoristasList) {
                    motoristasList.innerHTML = `
                        <div class="text-center py-5">
                            <i class="fas fa-exclamation-triangle fs-1 text-warning mb-3"></i>
                            <p class="text-danger">Erro ao carregar motoristas</p>
                            <p class="text-muted small">${error.message || 'Erro desconhecido'}</p>
                            <button class="btn btn-primary mt-3" onclick="carregarMotoristas('${classe}')">
                                <i class="fas fa-redo me-2"></i>Tentar novamente
                            </button>
                        </div>
                    `;
                }
                
                // Fallback para dados mockados
                motoristasFiltrados = allMotoristas.filter(m => m.classe_veiculo === classe && m.status === 'ativo');
                currentPage = 1;
                const selecionadosEl = document.getElementById('motoristasSelecionados');
                const selecionadosBadgeEl = document.getElementById('motoristasSelecionadosBadge');
                if (selecionadosEl) selecionadosEl.textContent = '0';
                if (selecionadosBadgeEl) selecionadosBadgeEl.textContent = '0 selecionados';
                
                if (motoristasFiltrados.length > 0) {
                    atualizarListaMotoristas(motoristasFiltrados);
                    mostrarAviso('Usando dados de exemplo - Supabase não disponível');
                }
            }
        }

        // ========== ATUALIZAR LISTA DE MOTORISTAS (OTIMIZADA) ==========
        function atualizarListaMotoristas(motoristas) {
            const motoristasList = document.getElementById('motoristasList');
            
            if (motoristas.length === 0) {
                motoristasList.innerHTML = '<div class="text-center py-5"><i class="fas fa-truck fs-1 text-muted mb-3"></i><p class="text-muted">Nenhum motorista encontrado para esta categoria</p></div>';
                atualizarPaginacao(0);
                return;
            }

            // Calcular paginação
            totalPages = Math.ceil(motoristas.length / itemsPerPage);
            
            // Garantir que currentPage não exceda totalPages
            if (currentPage > totalPages && totalPages > 0) {
                currentPage = totalPages;
            }
            
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const motoristasPagina = motoristas.slice(startIndex, endIndex);
            
            // Atualizar o input de página
            const inputPagina = document.getElementById('inputPagina');
            if (inputPagina) {
                inputPagina.value = currentPage;
                inputPagina.max = totalPages;
            }

            motoristasList.innerHTML = motoristasPagina.map(motorista => {
                const temErroTelefone1 = motorista.telefone1_erro === true;
                const temErroTelefone2 = motorista.telefone2_erro === true;
                const temErro = temErroTelefone1 || temErroTelefone2;
                const desabilitado = temErro ? 'disabled' : '';
                const classeErro = temErro ? 'telefone-erro' : '';
                
                return `
                <div class="motorista-item ${selectedMotoristas.has(motorista.id) ? 'selected' : ''} ${classeErro}" 
                     data-id="${motorista.id}" 
                     ${desabilitado ? 'style="opacity: 0.6; cursor: not-allowed;"' : ''}>
                    <div class="motorista-info">
                        <h6>${motorista.nome || 'Nome não informado'}
                            ${temErro ? '<span class="badge bg-danger ms-2" title="Telefone com erro de disparo"><i class="fas fa-exclamation-triangle"></i> Erro</span>' : ''}
                        </h6>
                        <div class="motorista-details">
                            <i class="fas fa-phone me-1 ${temErroTelefone1 ? 'text-danger' : ''}"></i>
                            <span class="${temErroTelefone1 ? 'text-danger text-decoration-line-through' : ''}">
                                ${motorista.telefone1 || 'Telefone não informado'}
                            </span>
                            ${temErroTelefone1 && motorista.telefone1_erro_motivo ? `<br><small class="text-danger"><i class="fas fa-info-circle"></i> ${motorista.telefone1_erro_motivo.substring(0, 50)}</small>` : ''}
                            ${motorista.telefone2 ? `
                                <br><i class="fas fa-mobile-alt me-1 ${temErroTelefone2 ? 'text-danger' : ''}"></i>
                                <span class="${temErroTelefone2 ? 'text-danger text-decoration-line-through' : ''}">
                                    ${motorista.telefone2}
                                </span>
                                ${temErroTelefone2 && motorista.telefone2_erro_motivo ? `<br><small class="text-danger"><i class="fas fa-info-circle"></i> ${motorista.telefone2_erro_motivo.substring(0, 50)}</small>` : ''}
                            ` : ''}
                            ${motorista.estado ? `<br><i class="fas fa-map-marker-alt me-1"></i>${motorista.estado}` : ''}
                            ${motorista.tipo_veiculo ? `<br><i class="fas fa-truck me-1"></i>${motorista.tipo_veiculo}` : ''}
                            ${motorista.tipo_carroceria ? `<br><i class="fas fa-box me-1"></i>${tiposCarroceriaMap[motorista.tipo_carroceria] || motorista.tipo_carroceria}` : ''}
                        </div>
                    </div>
                    <div class="motorista-actions">
                        <button class="motorista-favorito ${motoristasFavoritos.has(motorista.id) ? 'active' : ''}" 
                                data-motorista-id="${motorista.id}" 
                                onclick="event.stopPropagation(); toggleFavorito('${motorista.id}')"
                                title="${motoristasFavoritos.has(motorista.id) ? 'Remover dos favoritos' : 'Adicionar aos favoritos'}">
                            <i class="fas fa-star"></i>
                        </button>
                    <div class="motorista-checkbox ${selectedMotoristas.has(motorista.id) ? 'checked' : ''} ${desabilitado ? 'disabled' : ''}">
                        ${selectedMotoristas.has(motorista.id) ? '<i class="fas fa-check"></i>' : ''}
                        </div>
                    </div>
                </div>
            `;
            }).join('');

            // Remover motoristas inativos e com erro da seleção
            motoristas.forEach(motorista => {
                if (selectedMotoristas.has(motorista.id)) {
                    // Remover se estiver inativo
                    if (motorista.status === 'inativo') {
                        selectedMotoristas.delete(motorista.id);
                    }
                    // Remover se tiver erro de telefone
                    else if (motorista.telefone1_erro || motorista.telefone2_erro) {
                        selectedMotoristas.delete(motorista.id);
                    }
                }
            });

            // Adicionar eventos de clique (apenas para motoristas sem erro)
            motoristasList.querySelectorAll('.motorista-item').forEach(item => {
                item.addEventListener('click', () => {
                    const id = item.dataset.id;
                    // Não permitir seleção se tiver erro de telefone
                    if (item.classList.contains('telefone-erro')) {
                        return;
                    }
                    toggleSelecaoMotorista(id);
                });
            });

            // Atualizar paginação
            atualizarPaginacao(motoristas.length);
            
            // Atualizar contador após remover motoristas com erro
            atualizarContadorSelecionados();
        }

        // ========== TOGGLE SELEÇÃO DE MOTORISTA ==========
        function toggleSelecaoMotorista(id) {
            // Verificar se o motorista existe
            const motorista = motoristasFiltrados.find(m => m.id === id);
            if (!motorista) return;
            
            // Verificar se o motorista está inativo
            if (motorista.status === 'inativo') {
                // Se já estiver selecionado, remover da seleção
                if (selectedMotoristas.has(id)) {
                    selectedMotoristas.delete(id);
                    const item = document.querySelector(`[data-id="${id}"]`);
                    if (item) {
                        item.classList.remove('selected');
                        const checkbox = item.querySelector('.motorista-checkbox');
                        checkbox.classList.remove('checked');
                        checkbox.innerHTML = '';
                    }
                    atualizarContadorSelecionados();
                }
                mostrarAviso('⚠️ Este motorista não pode ser selecionado pois está inativo.');
                return;
            }
            
            // Verificar se o motorista tem erro de telefone (independente do status - ativo ou inativo)
            if (motorista.telefone1_erro || motorista.telefone2_erro) {
                // Se já estiver selecionado, remover da seleção
                if (selectedMotoristas.has(id)) {
                    selectedMotoristas.delete(id);
                    const item = document.querySelector(`[data-id="${id}"]`);
                    if (item) {
                        item.classList.remove('selected');
                        const checkbox = item.querySelector('.motorista-checkbox');
                        checkbox.classList.remove('checked');
                        checkbox.innerHTML = '';
                    }
                    atualizarContadorSelecionados();
                }
                mostrarAviso('⚠️ Este motorista não pode ser selecionado pois possui telefone com erro de disparo.');
                return;
            }
            
            if (selectedMotoristas.has(id)) {
                selectedMotoristas.delete(id);
            } else {
                selectedMotoristas.add(id);
            }
            
            // Atualizar interface
            const item = document.querySelector(`[data-id="${id}"]`);
            if (item) {
                item.classList.toggle('selected');
                const checkbox = item.querySelector('.motorista-checkbox');
                checkbox.classList.toggle('checked');
                checkbox.innerHTML = selectedMotoristas.has(id) ? '<i class="fas fa-check"></i>' : '';
            }
            
            // Atualizar contadores
            atualizarContadorSelecionados();
        }

        // ========== SELECIONAR TODOS ==========
        function selecionarTodos() {
            // Selecionar até o limite configurado (itemsPerPage), excluindo motoristas com erro e inativos
            const limite = itemsPerPage;
            const motoristasParaSelecionar = motoristasFiltrados
                .slice(0, limite)
                .filter(motorista => {
                    // Não selecionar motoristas inativos
                    if (motorista.status === 'inativo') return false;
                    // Não selecionar motoristas com erro de telefone
                    return !motorista.telefone1_erro && !motorista.telefone2_erro;
                });
            
            let selecionados = 0;
            motoristasParaSelecionar.forEach(motorista => {
                selectedMotoristas.add(motorista.id);
                selecionados++;
            });
            
            if (selecionados < motoristasFiltrados.slice(0, limite).length) {
                const excluidos = motoristasFiltrados.slice(0, limite).length - selecionados;
                mostrarAviso(`⚠️ ${excluidos} motorista(s) com erro de telefone foram excluídos da seleção.`);
            }
            
            atualizarListaMotoristas(motoristasFiltrados);
            atualizarContadorSelecionados();
        }

        // ========== SELECIONAR PÁGINA ATUAL ==========
        function selecionarPaginaAtual() {
            // Selecionar apenas os motoristas da página atual, excluindo motoristas com erro e inativos
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const motoristasPagina = motoristasFiltrados
                .slice(startIndex, endIndex)
                .filter(motorista => {
                    // Não selecionar motoristas inativos
                    if (motorista.status === 'inativo') return false;
                    // Não selecionar motoristas com erro de telefone
                    return !motorista.telefone1_erro && !motorista.telefone2_erro;
                });
            
            let selecionados = 0;
            motoristasPagina.forEach(motorista => {
                selectedMotoristas.add(motorista.id);
                selecionados++;
            });
            
            const totalNaPagina = motoristasFiltrados.slice(startIndex, endIndex).length;
            if (selecionados < totalNaPagina) {
                const excluidos = totalNaPagina - selecionados;
                mostrarAviso(`⚠️ ${excluidos} motorista(s) com erro de telefone foram excluídos da seleção.`);
            }
            
            atualizarListaMotoristas(motoristasFiltrados);
            atualizarContadorSelecionados();
        }

        // ========== ATUALIZAR CONTADOR DE SELECIONADOS ==========
        function atualizarContadorSelecionados() {
            const total = selectedMotoristas.size;
            document.getElementById('motoristasSelecionados').textContent = total.toLocaleString('pt-BR');
            document.getElementById('motoristasSelecionadosBadge').textContent = `${total.toLocaleString('pt-BR')} selecionados`;
        }

        // ========== LIMPAR SELEÇÃO ==========
        function limparSelecao() {
            selectedMotoristas.clear();
            atualizarListaMotoristas(motoristasFiltrados);
            atualizarContadorSelecionados();
        }

        // ========== GERENCIAR FAVORITOS ==========
        async function carregarFavoritos() {
            try {
                if (!supabase || !currentUser) {
                    console.log('⚠️ Supabase ou usuário não disponível para carregar favoritos');
                    return;
                }

                // Buscar favoritos do usuário atual
                const { data, error } = await supabase
                    .from('motoristas_favoritos')
                    .select('motorista_id')
                    .eq('usuario_id', currentUser);

                if (error) {
                    console.error('❌ Erro ao carregar favoritos:', error);
                    return;
                }

                // Limpar e popular o Set de favoritos
                motoristasFavoritos.clear();
                if (data && data.length > 0) {
                    data.forEach(item => {
                        motoristasFavoritos.add(item.motorista_id);
                    });
                    console.log(`✅ ${motoristasFavoritos.size} favoritos carregados`);
                }
            } catch (error) {
                console.error('❌ Erro ao carregar favoritos:', error);
            }
        }

        async function toggleFavorito(motoristaId) {
            try {
                if (!supabase || !currentUser) {
                    mostrarAviso('Erro: usuário não autenticado');
                    return;
                }

                const isFavorito = motoristasFavoritos.has(motoristaId);

                if (isFavorito) {
                    // Remover dos favoritos
                    const { error } = await supabase
                        .from('motoristas_favoritos')
                        .delete()
                        .eq('usuario_id', currentUser)
                        .eq('motorista_id', motoristaId);

                    if (error) throw error;

                    motoristasFavoritos.delete(motoristaId);
                    console.log(`⭐ Favorito removido: ${motoristaId}`);
                } else {
                    // Adicionar aos favoritos
                    const { error } = await supabase
                        .from('motoristas_favoritos')
                        .insert([{
                            usuario_id: currentUser,
                            motorista_id: motoristaId,
                            created_at: new Date().toISOString()
                        }]);

                    if (error) throw error;

                    motoristasFavoritos.add(motoristaId);
                    console.log(`⭐ Favorito adicionado: ${motoristaId}`);
                }

                // Atualizar visual do botão
                const favoritoBtn = document.querySelector(`[data-motorista-id="${motoristaId}"]`);
                if (favoritoBtn) {
                    favoritoBtn.classList.toggle('active');
                    favoritoBtn.title = motoristasFavoritos.has(motoristaId) 
                        ? 'Remover dos favoritos' 
                        : 'Adicionar aos favoritos';
                }

                // Se o filtro de favoritos estiver ativo, reaplicar filtros
                const filtroFavoritos = document.getElementById('filtroFavoritos');
                if (filtroFavoritos && filtroFavoritos.checked) {
                    aplicarFiltros();
                }
            } catch (error) {
                console.error('❌ Erro ao alternar favorito:', error);
                mostrarAviso('Erro ao atualizar favorito. Tente novamente.');
            }
        }

        // ========== APLICAR FILTROS (INTELIGENTE) ==========
        async function aplicarFiltros() {
            if (!currentClass) {
                mostrarAviso('Selecione uma categoria primeiro');
                return;
            }

            const filtroTipoVeiculoSelect = document.getElementById('filtroTipoVeiculo');
            const filtroCarroceriaSelect = document.getElementById('filtroCarroceria');
            const filtroEstadoSelect = document.getElementById('filtroEstado');

            // Suportar múltiplas seleções (arrays de valores)
            const filtroTipoVeiculo = filtroTipoVeiculoSelect
                ? Array.from(filtroTipoVeiculoSelect.selectedOptions)
                    .map(opt => opt.value)
                    .filter(v => v && v.trim() !== '')
                : [];

            const filtroCarroceria = filtroCarroceriaSelect
                ? Array.from(filtroCarroceriaSelect.selectedOptions)
                    .map(opt => opt.value)
                    .filter(v => v && v.trim() !== '')
                : [];

            const filtroEstado = filtroEstadoSelect
                ? Array.from(filtroEstadoSelect.selectedOptions)
                    .map(opt => opt.value)
                    .filter(v => v && v.trim() !== '')
                : [];
            const filtroStatus = document.getElementById('filtroStatus').value;
            const filtroBusca = document.getElementById('filtroBusca').value.toLowerCase();
            const filtroFavoritos = document.getElementById('filtroFavoritos').checked;

            console.log('🔍 Aplicando filtros inteligentes...', {
                classe: currentClass,
                tipoVeiculo: filtroTipoVeiculo,
                carroceria: filtroCarroceria,
                estado: filtroEstado,
                status: filtroStatus,
                busca: filtroBusca,
                favoritos: filtroFavoritos
            });

            const motoristasList = document.getElementById('motoristasList');
            motoristasList.innerHTML = '<div class="text-center py-3"><div class="loading-spinner me-2"></div>Aplicando filtros...</div>';

            try {
                let todosMotoristas = [];
                
                if (supabase) {
                    // Usar currentClass (selecionado pelos cards)
                    if (!currentClass) {
                        mostrarAviso('Selecione uma categoria primeiro');
                        return;
                    }
                    
                    // Construir query do Supabase com filtros
                    let query = supabase
                        .from('motoristas')
                        .select('id, nome, telefone1, telefone2, estado, classe_veiculo, tipo_veiculo, tipo_carroceria, status')
                        .eq('classe_veiculo', currentClass);

                    // Aplicar filtro de status (se não houver filtro, não aplicar nenhum filtro de status)
                    if (filtroStatus) {
                        query = query.eq('status', filtroStatus);
                    }
                    // Se não houver filtro de status especificado, não filtrar por status

                    // NÃO aplicar filtros de tipo_veiculo e carroceria no Supabase
                    // Faremos isso client-side para garantir normalização de maiúsculas/minúsculas e acentos
                    // Se aplicarmos aqui, pode não funcionar quando banco tem "carreta" e filtro tem "Carreta"
                    // ou "bau" e filtro tem "Baú"
                    
                    if (filtroEstado && filtroEstado.length > 0) {
                        query = query.in('estado', filtroEstado);
                    }

                    // Para busca por nome/telefone, usar ilike
                    if (filtroBusca) {
                        query = query.or(`nome.ilike.%${filtroBusca}%,telefone1.ilike.%${filtroBusca}%,telefone2.ilike.%${filtroBusca}%`);
                    }

                    query = query.order('nome');

                    // Carregar TODOS os resultados filtrados
                    let from = 0;
                    const limit = 1000;
                    let hasMore = true;
                    
                    while (hasMore) {
                        const { data: motoristas, error } = await query.range(from, from + limit - 1);

                        if (error) throw error;
                        
                        if (motoristas && motoristas.length > 0) {
                            todosMotoristas = todosMotoristas.concat(motoristas);
                            from += limit;
                            
                            // Atualizar progresso
                            motoristasList.innerHTML = `<div class="text-center py-3"><div class="loading-spinner me-2"></div>Aplicando filtros... ${todosMotoristas.length.toLocaleString('pt-BR')} encontrados</div>`;
                            
                            if (motoristas.length < limit) {
                                hasMore = false;
                            }
                        } else {
                            hasMore = false;
                        }
                    }
                    
                    // Aplicar filtros de tipo de veículo e carroceria client-side para garantir normalização
                    // Agora suportando múltiplas seleções
                    if (Array.isArray(filtroTipoVeiculo) && filtroTipoVeiculo.length > 0) {
                        const filtrosNormalizados = filtroTipoVeiculo
                            .map(v => normalizarTexto(v))
                            .filter(v => v);

                        console.log('🔍 Filtrando tipo de veículo (múltiplo):', {
                            filtrosOriginais: filtroTipoVeiculo,
                            filtrosNormalizados,
                            totalAntes: todosMotoristas.length
                        });
                        
                        const antes = todosMotoristas.length;
                        todosMotoristas = todosMotoristas.filter(motorista => {
                            const tipoVeiculoMotorista = normalizarTexto(motorista.tipo_veiculo || '');
                            if (!tipoVeiculoMotorista) return false;

                            const match = filtrosNormalizados.some(filtroNormalizado =>
                                tipoVeiculoMotorista.includes(filtroNormalizado) ||
                                filtroNormalizado.includes(tipoVeiculoMotorista) ||
                                tipoVeiculoMotorista === filtroNormalizado
                            );
                            
                            return match;
                        });
                        
                        console.log(`✅ Filtro de tipo de veículo: ${antes} → ${todosMotoristas.length} motoristas`);
                    }
                    
                    if (Array.isArray(filtroCarroceria) && filtroCarroceria.length > 0) {
                        const filtrosNormalizados = filtroCarroceria
                            .map(v => normalizarChaveCarroceria(v))
                            .filter(v => v);

                        console.log('🔍 Filtrando carroceria (múltiplo):', {
                            filtrosOriginais: filtroCarroceria,
                            filtrosNormalizados,
                            totalAntes: todosMotoristas.length
                        });
                        
                        const antes = todosMotoristas.length;
                        todosMotoristas = todosMotoristas.filter(motorista => {
                            const carroceriaMotorista = normalizarChaveCarroceria(motorista.tipo_carroceria || '');
                            if (!carroceriaMotorista) return false;

                            const match = filtrosNormalizados.includes(carroceriaMotorista);
                            
                            return match;
                        });
                        
                        console.log(`✅ Filtro de carroceria: ${antes} → ${todosMotoristas.length} motoristas`);
                    }
                    
                    // Aplicar filtro de favoritos (client-side)
                    if (filtroFavoritos && motoristasFavoritos.size > 0) {
                        const antes = todosMotoristas.length;
                        todosMotoristas = todosMotoristas.filter(motorista => {
                            return motoristasFavoritos.has(motorista.id);
                        });
                        console.log(`✅ Filtro de favoritos: ${antes} → ${todosMotoristas.length} motoristas`);
                    } else if (filtroFavoritos && motoristasFavoritos.size === 0) {
                        // Se o filtro está ativo mas não há favoritos, retornar lista vazia
                        todosMotoristas = [];
                        console.log('⚠️ Filtro de favoritos ativo, mas nenhum favorito encontrado');
                    }
                    
                    console.log(`🔍 ${todosMotoristas.length.toLocaleString('pt-BR')} motoristas encontrados com filtros aplicados`);
                } else {
                    // Usar dados mockados com filtros locais
                    // Usar currentClass (selecionado pelos cards)
                    if (!currentClass) {
                        mostrarAviso('Selecione uma categoria primeiro');
                        return;
                    }
                    
                    todosMotoristas = allMotoristas.filter(motorista => {
                        // Filtro de classe usando currentClass
                        if (motorista.classe_veiculo !== currentClass) return false;
                        
                        // Filtro de tipo de veículo (tolerante, case-insensitive, sem acentos) com múltiplas seleções
                        if (Array.isArray(filtroTipoVeiculo) && filtroTipoVeiculo.length > 0) {
                            const tipoVeiculoMotorista = normalizarTexto(motorista.tipo_veiculo || '');
                            if (!tipoVeiculoMotorista) return false;

                            const filtrosNormalizados = filtroTipoVeiculo
                                .map(v => normalizarTexto(v))
                                .filter(v => v);

                            const match = filtrosNormalizados.some(filtroNormalizado =>
                                tipoVeiculoMotorista.includes(filtroNormalizado) ||
                                filtroNormalizado.includes(tipoVeiculoMotorista) ||
                                tipoVeiculoMotorista === filtroNormalizado
                            );
                            
                            if (!match) return false;
                        }
                        
                        // Filtro de carroceria (case-insensitive, sem acentos) com múltiplas seleções
                        if (Array.isArray(filtroCarroceria) && filtroCarroceria.length > 0) {
                            const carroceriaMotorista = normalizarChaveCarroceria(motorista.tipo_carroceria || '');
                            if (!carroceriaMotorista) return false;

                            const filtrosNormalizados = filtroCarroceria
                                .map(v => normalizarChaveCarroceria(v))
                                .filter(v => v);
                            
                            if (!filtrosNormalizados.includes(carroceriaMotorista)) return false;
                        }
                        
                        // Filtro de estado (múltipla seleção)
                        if (filtroEstado && filtroEstado.length > 0) {
                            if (!filtroEstado.includes(motorista.estado)) return false;
                        }
                        
                        // Filtro de status (se não houver filtro, não filtrar)
                        if (filtroStatus && motorista.status !== filtroStatus) return false;
                        
                        // Filtro de busca
                        if (filtroBusca) {
                            const nome = (motorista.nome || '').toLowerCase();
                            const telefone1 = (motorista.telefone1 || '').toLowerCase();
                            const telefone2 = (motorista.telefone2 || '').toLowerCase();
                            
                            if (!nome.includes(filtroBusca) && !telefone1.includes(filtroBusca) && !telefone2.includes(filtroBusca)) {
                                return false;
                            }
                        }
                        
                        // Filtro de favoritos
                        if (filtroFavoritos) {
                            if (!motoristasFavoritos.has(motorista.id)) {
                                return false;
                            }
                        }
                        
                        return true;
                    });
                }
                
                // Armazenar resultados filtrados
                motoristasFiltrados = todosMotoristas;
                currentPage = 1;
                
                // Atualizar estatísticas
                document.getElementById('motoristasSelecionados').textContent = '0';
                document.getElementById('motoristasSelecionadosBadge').textContent = '0 selecionados';
                
                atualizarListaMotoristas(motoristasFiltrados);
                
            } catch (error) {
                console.error('❌ Erro ao aplicar filtros:', error);
                
                // Fallback para filtros locais
                if (!currentClass) {
                    mostrarAviso('Selecione uma categoria primeiro');
                    return;
                }
                
                motoristasFiltrados = allMotoristas.filter(m => {
                    if (m.classe_veiculo !== currentClass) return false;
                    // Não filtrar por status no fallback, mostrar todos
                    return true;
                });
                currentPage = 1;
                atualizarListaMotoristas(motoristasFiltrados);
                
                mostrarAviso('Erro ao aplicar filtros, usando dados locais');
            }
        }

        // ========== PAGINAÇÃO OTIMIZADA E INTELIGENTE ==========
        function atualizarPaginacao(totalItens) {
            const paginacao = document.getElementById('paginacao');
            const infoPagina = document.getElementById('infoPagina');
            
            // Limpar paginação anterior
            paginacao.innerHTML = '';
            
            // Garantir que a paginação está centralizada em telas menores
            if (window.innerWidth <= 768) {
                paginacao.style.justifyContent = 'center';
            } else {
                paginacao.style.justifyContent = 'flex-end';
            }
            
            // Atualizar o input de página
            const inputPagina = document.getElementById('inputPagina');
            if (inputPagina) {
                inputPagina.value = currentPage;
                inputPagina.max = totalPages || 1;
            }
            
            if (totalItens === 0) {
                infoPagina.textContent = 'Página 1 de 1 - Total: 0 motoristas';
                if (inputPagina) {
                    inputPagina.value = 1;
                    inputPagina.max = 1;
                }
                return;
            }

            // Calcular informações da página
            const inicio = (currentPage - 1) * itemsPerPage + 1;
            const fim = Math.min(currentPage * itemsPerPage, totalItens);
            const porcentagem = ((fim / totalItens) * 100).toFixed(1);
            
            // Informações detalhadas da página
            infoPagina.innerHTML = `
                <strong>Página ${currentPage} de ${totalPages}</strong> - 
                Mostrando <strong>${inicio.toLocaleString('pt-BR')}-${fim.toLocaleString('pt-BR')}</strong> de 
                <strong>${totalItens.toLocaleString('pt-BR')}</strong> motoristas 
                <span class="text-muted">(${porcentagem}%)</span>
            `;

            // Botão Anterior
            const btnAnterior = document.createElement('li');
            const isAnteriorDisabled = currentPage === 1;
            btnAnterior.innerHTML = `<a class="page-btn ${isAnteriorDisabled ? 'disabled' : ''}" href="#" onclick="event.preventDefault(); return ${isAnteriorDisabled ? 'false' : `mudarPagina(${currentPage - 1})`};"><i class="fas fa-chevron-left me-1"></i>Anterior</a>`;
            paginacao.appendChild(btnAnterior);

            // Páginas numeradas (otimizado para muitas páginas)
            const inicioPagina = Math.max(1, currentPage - 2);
            const fimPagina = Math.min(totalPages, currentPage + 2);

            // Primeira página
            if (inicioPagina > 1) {
                const li = document.createElement('li');
                li.innerHTML = `<a class="page-btn" href="#" onclick="event.preventDefault(); mudarPagina(1); return false;">1</a>`;
                paginacao.appendChild(li);
                
                if (inicioPagina > 2) {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="page-btn disabled"><i class="fas fa-ellipsis-h"></i></span>`;
                    paginacao.appendChild(li);
                }
            }

            // Páginas do meio
            for (let i = inicioPagina; i <= fimPagina; i++) {
                const li = document.createElement('li');
                li.innerHTML = `<a class="page-btn ${i === currentPage ? 'active' : ''}" href="#" onclick="event.preventDefault(); mudarPagina(${i}); return false;">${i}</a>`;
                paginacao.appendChild(li);
            }

            // Última página
            if (fimPagina < totalPages) {
                if (fimPagina < totalPages - 1) {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="page-btn disabled"><i class="fas fa-ellipsis-h"></i></span>`;
                    paginacao.appendChild(li);
                }
                
                const li = document.createElement('li');
                li.innerHTML = `<a class="page-btn" href="#" onclick="event.preventDefault(); mudarPagina(${totalPages}); return false;">${totalPages}</a>`;
                paginacao.appendChild(li);
            }

            // Botão Próximo
            const btnProximo = document.createElement('li');
            const isProximoDisabled = currentPage === totalPages;
            btnProximo.innerHTML = `<a class="page-btn ${isProximoDisabled ? 'disabled' : ''}" href="#" onclick="event.preventDefault(); return ${isProximoDisabled ? 'false' : `mudarPagina(${currentPage + 1})`};"><i class="fas fa-chevron-right ms-1"></i>Próximo</a>`;
            paginacao.appendChild(btnProximo);

            // Adicionar informações extras se houver muitos resultados (apenas uma vez)
            const paginacaoContainer = paginacao.parentNode;
            let infoExtra = paginacaoContainer.querySelector('.info-extra-motoristas');
            
            if (totalItens > 10000) {
                if (!infoExtra) {
                    // Criar apenas se não existir
                    infoExtra = document.createElement('div');
                    infoExtra.className = 'info-extra-motoristas mt-2 text-center';
                    infoExtra.innerHTML = `
                        <small class="text-muted">
                            <i class="fas fa-info-circle me-1"></i>
                            Sistema otimizado para ${totalItens.toLocaleString('pt-BR')} motoristas
                        </small>
                    `;
                    paginacaoContainer.appendChild(infoExtra);
                }
            } else {
                // Remover se não precisar mais
                if (infoExtra) {
                    infoExtra.remove();
                }
            }
        }

        function mudarPagina(pagina) {
            if (pagina < 1 || pagina > totalPages) return;
            
            currentPage = pagina;
            atualizarListaMotoristas(motoristasFiltrados);
            // Atualizar o input de página
            const inputPagina = document.getElementById('inputPagina');
            if (inputPagina) {
                inputPagina.value = pagina;
            }
        }
        
        function navegarParaPagina() {
            const inputPagina = document.getElementById('inputPagina');
            if (!inputPagina) return;
            
            const pagina = parseInt(inputPagina.value);
            if (isNaN(pagina) || pagina < 1) {
                inputPagina.value = currentPage;
                return;
            }
            
            if (pagina > totalPages) {
                inputPagina.value = totalPages;
                mudarPagina(totalPages);
                return;
            }
            
            mudarPagina(pagina);
        }

        let imagemSelecionada = null;
        let imagemPreviewUrl = null;
        
        // Variáveis para gravação de áudio
        let mediaRecorder = null;
        let audioChunks = [];
        let audioBlob = null;
        let audioFile = null;
        let recordingStartTime = null;
        let recordingTimer = null;
        let audioStream = null;
        let currentMimeType = 'audio/webm';

        function resetarImagem() {
            const input = document.getElementById('imageInput');
            const preview = document.getElementById('imagePreview');
            if (input) input.value = '';
            if (preview) preview.style.display = 'none';
            imagemSelecionada = null;
            if (imagemPreviewUrl) {
                URL.revokeObjectURL(imagemPreviewUrl);
                imagemPreviewUrl = null;
            }
        }

        function configurarUploadImagem() {
            const input = document.getElementById('imageInput');
            const btnRemove = document.getElementById('btnRemoveImage');

            if (!input || !btnRemove) return;

            const processFile = (file) => {
                if (!file) return;
                const maxSize = 5 * 1024 * 1024; // 5MB
                if (!file.type.startsWith('image/')) {
                    mostrarAviso('Selecione um arquivo de imagem válido (jpg, png, webp).');
                    return;
                }
                if (file.size > maxSize) {
                    mostrarAviso('A imagem deve ter no máximo 5MB.');
                    return;
                }

                imagemSelecionada = file;
                if (imagemPreviewUrl) {
                    URL.revokeObjectURL(imagemPreviewUrl);
                }
                imagemPreviewUrl = URL.createObjectURL(file);
                
                // Remover áudio se houver imagem
                if (audioFile) {
                    resetarAudio();
                }

                const preview = document.getElementById('imagePreview');
                const previewImg = document.getElementById('previewImg');
                const imageName = document.getElementById('imageName');
                if (preview && previewImg && imageName) {
                    previewImg.src = imagemPreviewUrl;
                    imageName.textContent = `${file.name} (${(file.size/1024).toFixed(1)} KB)`;
                    preview.style.display = 'block';
                }
            };

            input.addEventListener('change', (e) => processFile(e.target.files[0]));

            btnRemove.addEventListener('click', (e) => {
                e.preventDefault();
                resetarImagem();
            });
        }

        // ========== GRAVAÇÃO DE ÁUDIO ==========
        function resetarAudio() {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
            }
            
            if (recordingTimer) {
                clearInterval(recordingTimer);
                recordingTimer = null;
            }
            
            // Parar stream se ainda estiver ativo
            if (audioStream) {
                audioStream.getTracks().forEach(track => track.stop());
                audioStream = null;
            }
            
            if (audioBlob) {
                const url = URL.createObjectURL(audioBlob);
                URL.revokeObjectURL(url);
            }
            
            audioBlob = null;
            audioFile = null;
            audioChunks = [];
            mediaRecorder = null;
            currentMimeType = 'audio/webm';
            
            const audioPreview = document.getElementById('audioPreview');
            const audioSource = document.getElementById('audioSource');
            const audioPlayer = document.getElementById('audioPlayer');
            const audioDuration = document.getElementById('audioDuration');
            const btnStart = document.getElementById('btnStartRecording');
            const btnStop = document.getElementById('btnStopRecording');
            const btnRemove = document.getElementById('btnRemoveAudio');
            
            if (audioPreview) audioPreview.style.display = 'none';
            if (audioSource) audioSource.src = '';
            if (audioPlayer) audioPlayer.load();
            if (audioDuration) audioDuration.textContent = '0s';
            if (btnStart) btnStart.style.display = 'inline-block';
            if (btnStop) btnStop.style.display = 'none';
            if (btnRemove) btnRemove.style.display = 'none';
            
            adicionarLog('🗑️ Áudio removido', 'info');
        }
        
        function configurarGravacaoAudio() {
            const btnStart = document.getElementById('btnStartRecording');
            const btnStop = document.getElementById('btnStopRecording');
            const btnRemove = document.getElementById('btnRemoveAudio');
            const audioPreview = document.getElementById('audioPreview');
            const audioPlayer = document.getElementById('audioPlayer');
            const audioSource = document.getElementById('audioSource');
            const audioDuration = document.getElementById('audioDuration');

            if (!btnStart || !btnStop || !btnRemove) return;

            async function iniciarGravacao() {
                try {
                    // Remover imagem se houver áudio
                    if (imagemSelecionada) {
                        resetarImagem();
                    }
                    
                    audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    // Tentar usar OGG Opus primeiro (preferido pelo WhatsApp)
                    // Se não suportar, tentar WebM Opus, depois WebM simples
                    currentMimeType = 'audio/ogg;codecs=opus';
                    if (!MediaRecorder.isTypeSupported(currentMimeType)) {
                        currentMimeType = 'audio/webm;codecs=opus';
                    }
                    if (!MediaRecorder.isTypeSupported(currentMimeType)) {
                        currentMimeType = 'audio/webm';
                    }
                    if (!MediaRecorder.isTypeSupported(currentMimeType)) {
                        currentMimeType = 'audio/mp4'; // Fallback
                    }
                    
                    console.log(`🎤 Codec selecionado: ${currentMimeType}`);
                    
                    mediaRecorder = new MediaRecorder(audioStream, {
                        mimeType: currentMimeType
                    });
                    
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        if (event.data.size > 0) {
                            audioChunks.push(event.data);
                        }
                    };
                    
                    mediaRecorder.onstop = () => {
                        const mimeTypeBase = currentMimeType.split(';')[0];
                        audioBlob = new Blob(audioChunks, { type: mimeTypeBase });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        
                        // Criar arquivo para envio
                        const fileExtension = currentMimeType.includes('ogg') ? '.ogg' : '.webm';
                        audioFile = new File([audioBlob], `audio_${Date.now()}${fileExtension}`, { type: mimeTypeBase });
                        
                        // Atualizar preview
                        audioSource.src = audioUrl;
                        audioSource.type = mimeTypeBase;
                        audioPlayer.load();
                        audioPreview.style.display = 'block';
                        
                        // Calcular duração real
                        audioPlayer.addEventListener('loadedmetadata', () => {
                            const duration = Math.round(audioPlayer.duration);
                            audioDuration.textContent = `${duration}s`;
                        }, { once: true });
                        
                        // Parar todas as tracks do stream
                        if (audioStream) {
                            audioStream.getTracks().forEach(track => track.stop());
                            audioStream = null;
                        }
                        
                        btnStart.style.display = 'inline-block';
                        btnStop.style.display = 'none';
                        btnRemove.style.display = 'inline-block';
                        
                        adicionarLog('🎤 Áudio gravado com sucesso', 'success');
                    };
                    
                    mediaRecorder.start();
                    recordingStartTime = Date.now();
                    
                    // Atualizar UI
                    btnStart.style.display = 'none';
                    btnStop.style.display = 'inline-block';
                    btnRemove.style.display = 'none';
                    audioPreview.style.display = 'none';
                    audioDuration.textContent = '0s';
                    
                    // Timer de duração
                    recordingTimer = setInterval(() => {
                        const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
                        audioDuration.textContent = `${elapsed}s`;
                        
                        // Limite de 2 minutos
                        if (elapsed >= 120) {
                            pararGravacao();
                            mostrarAviso('Limite de 2 minutos atingido. Gravação interrompida.');
                        }
                    }, 1000);
                    
                    adicionarLog('🎤 Gravação iniciada...', 'info');
                } catch (error) {
                    console.error('Erro ao iniciar gravação:', error);
                    mostrarErro('Erro ao acessar o microfone. Verifique as permissões do navegador.');
                }
            }
            
            function pararGravacao() {
                if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                    mediaRecorder.stop();
                }
                
                if (recordingTimer) {
                    clearInterval(recordingTimer);
                    recordingTimer = null;
                }
                
                // Parar stream se ainda estiver ativo
                if (audioStream) {
                    audioStream.getTracks().forEach(track => track.stop());
                    audioStream = null;
                }
            }
            
            btnStart.addEventListener('click', iniciarGravacao);
            btnStop.addEventListener('click', pararGravacao);
            btnRemove.addEventListener('click', resetarAudio);
        }

        // ========== TESTAR MENSAGEM ==========
        async function testarMensagem() {
            if (!treinamentoConcluido) {
                mostrarAviso('Finalize o treinamento "Disparador de Mensagens" antes de utilizar os recursos do disparador.');
                return;
            }
            const mensagem = document.getElementById('messageText').value;
            
            if (!mensagem.trim()) {
                mostrarAviso('Digite uma mensagem para testar');
    return;
  }
  
            // Usar dados de exemplo
            const exemplo = {
                name: 'João Silva',
                telefone: '11999999999',
                estado: 'SP',
                classe_veiculo: currentClass || 'leve',
                tipo_veiculo: 'Toco',
                tipo_carroceria: 'Sider'
            };

            const mensagemBase = mensagem
                .replace(/\{\{name\}\}/g, exemplo.name)
                .replace(/\{\{telefone\}\}/g, exemplo.telefone)
                .replace(/\{\{estado\}\}/g, exemplo.estado)
                .replace(/\{\{classe_veiculo\}\}/g, exemplo.classe_veiculo)
                .replace(/\{\{tipo_veiculo\}\}/g, exemplo.tipo_veiculo)
                .replace(/\{\{tipo_carroceria\}\}/g, exemplo.tipo_carroceria);

            const mensagemVariada = await gerarMensagemVariada(mensagemBase, {
                nome: exemplo.name,
                telefone: exemplo.telefone,
                estado: exemplo.estado,
                classeVeiculo: exemplo.classe_veiculo,
                tipoVeiculo: exemplo.tipo_veiculo,
                tipoCarroceria: exemplo.tipo_carroceria,
                origem: 'teste'
            });

            mostrarSucesso(`Mensagem de teste:<br><br>"${mensagemVariada}"`);
        }

        // ========== TESTAR ENVIO REAL ==========
        async function testarEnvioReal() {
            if (!treinamentoConcluido) {
                mostrarAviso('Finalize o treinamento "Disparador de Mensagens" antes de enviar mensagens.');
                return;
            }
            const telefone = document.getElementById('telefoneTeste').value.trim();
            const mensagem = document.getElementById('messageText').value.trim();
            const imageFile = imagemSelecionada;
            const audioFileToSend = audioFile;
            
            if (!telefone) {
                mostrarAviso('Digite um número de telefone para teste');
    return;
  }
  
            if (!mensagem) {
                mostrarAviso('Digite uma mensagem para enviar');
    return;
  }
  
            // Personalizar mensagem
            const mensagemBase = mensagem
                .replace(/\{\{name\}\}/g, 'Motorista Teste')
                .replace(/\{\{telefone\}\}/g, telefone)
                .replace(/\{\{estado\}\}/g, 'SP')
                .replace(/\{\{classe_veiculo\}\}/g, currentClass || 'leve')
                .replace(/\{\{tipo_veiculo\}\}/g, 'Toco')
                .replace(/\{\{tipo_carroceria\}\}/g, 'Sider');
            const mensagemPersonalizada = await gerarMensagemVariada(mensagemBase, {
                nome: 'Motorista Teste',
                telefone,
                estado: 'SP',
                classeVeiculo: currentClass || 'leve',
                tipoVeiculo: 'Toco',
                tipoCarroceria: 'Sider',
                origem: 'teste-envio'
            });

            try {
                adicionarLog(`🔄 Enviando teste para ${telefone}...`, 'info');
                if (imageFile) {
                    adicionarLog(`🖼️ Imagem anexada: ${imageFile.name}`, 'info');
                }
                
                if (audioFileToSend) {
                    adicionarLog(`🎤 Áudio anexado: ${audioFileToSend.name}`, 'info');
                }
                
                // Buscar credenciais da Evolution API do usuário logado
                const userData = localStorage.getItem('loggedInUser');
                let userEmail = null;
                let userId = null;
                
                if (userData) {
                    const user = JSON.parse(userData);
                    userEmail = user.email;
                    userId = user.id; // ✅ Usar ID do localStorage
                    console.log('👤 Usuário identificado para teste:', userEmail);
                    console.log('🆔 User ID:', userId);
                } else {
                    mostrarErro('Usuário não autenticado. Faça login novamente.');
                    return;
                }
                
                // Enviar via Evolution API usando credenciais do usuário
                const formData = new FormData();
                formData.append('number', telefone);
                formData.append('message', mensagemPersonalizada);
                formData.append('usuario', userEmail);
                formData.append('userId', userId);
                formData.append('maxMessages', configDisparo.messageLimit);
                formData.append('cooldownMinutes', configDisparo.cooldownMinutes);
                formData.append('windowMinutes', configDisparo.windowMinutes);
                formData.append('delayMin', configDisparo.delayMin);
                formData.append('delayMax', configDisparo.delayMax);
                formData.append('simulateTyping', configDisparo.simulateTyping ? 'true' : 'false');
                if (imageFile) {
                    formData.append('media', imageFile);
                } else if (audioFileToSend) {
                    formData.append('media', audioFileToSend);
                }

                const response = await fetch('/webhook/send-supabase', {
                    method: 'POST',
                    body: formData
                });

                if (response.status === 429) {
                    const data = await response.json().catch(() => ({}));
                    const restanteMin = data.remainingMinutes ?? 15;
                    adicionarLog(`⛔ Limite de envios atingido no teste. Aguarde ${restanteMin} minuto(s).`, 'warning');
                    mostrarAviso(`Limite de envios atingido.<br>Aguarde ${restanteMin} minuto(s) antes de reenviar.`);
                    return;
                }

                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        adicionarLog(`✅ Teste enviado com sucesso para ${telefone}`, 'success');
                        if (imageFile) {
                            adicionarLog(`🖼️ Imagem enviada: ${imageFile.name}`, 'info');
                        } else if (audioFileToSend) {
                            adicionarLog(`🎤 Áudio enviado: ${audioFileToSend.name}`, 'info');
                        }
                        adicionarLog(`🏷️ Instância usada: ${data.instancia || 'N/A'}`, 'info');
                        mostrarSucesso(`Mensagem de teste enviada para ${telefone}`);
                        if (data.cooldownTriggered) {
                            const cooldownMsg = data.cooldownMinutes
                                ? `⏳ Limite atingido. Pausa automática de ${data.cooldownMinutes} minuto(s) iniciada.`
                                : '⏳ Limite atingido. Pausa automática iniciada.';
                            adicionarLog(cooldownMsg, 'warning');
                            mostrarAviso(`${cooldownMsg}<br>Retome os envios após a pausa.`);
                        }
                    } else {
                        adicionarLog(`❌ Erro no teste: ${data.error || data.message}`, 'danger');
                        if (data.solution) {
                            adicionarLog(`💡 Solução: ${data.solution}`, 'warning');
                        }
                        mostrarErro(`Erro ao enviar teste: ${data.error || data.message}`);
                    }
                } else {
                    const error = await response.text();
                    adicionarLog(`❌ Erro HTTP ${response.status}: ${error}`, 'danger');
                    mostrarErro(`Erro ao enviar teste: HTTP ${response.status}`);
                }
      } catch (error) {
                adicionarLog(`❌ Erro no teste: ${error.message}`, 'danger');
                mostrarErro(`Erro ao enviar teste: ${error.message}`);
            }
        }

        // ========== VERIFICAR EVOLUTION API ==========
        async function verificarEvolutionAPI() {
            const evolutionLog = document.getElementById('evolutionLog');
            evolutionLog.innerHTML = '<div class="text-center py-3"><div class="loading-spinner me-2"></div>Verificando Evolution API...</div>';

            try {
                // Buscar email do usuário logado
                const userData = localStorage.getItem('loggedInUser');
                let userEmail = null;
                
                if (userData) {
                    const user = JSON.parse(userData);
                    userEmail = user.email;
                    console.log('👤 Verificando Evolution API para usuário:', userEmail);
                }
                
                // Verificar status da Evolution API (endpoint alternativo)
                const url = userEmail 
                    ? `/webhook/status-evolution?usuario=${encodeURIComponent(userEmail)}`
                    : '/webhook/status-evolution';
                
                const response = await fetch(url);
                
                if (response.ok) {
                    const data = await response.json();
                    
                    console.log('📡 Status Evolution API:', data);

                    // Status conectado
                    if (data.success && data.status === 'connected') {
                        adicionarLogEvolution(`✅ Evolution API CONECTADA`, 'success');
                        if (data.status) adicionarLogEvolution(`📊 Status: ${data.status}`, 'info');
                        if (data.url) adicionarLogEvolution(`🔗 URL: ${data.url}`, 'info');
                        if (data.instance) adicionarLogEvolution(`📱 Instância: ${data.instance}`, 'info');
                        if (data.message) adicionarLogEvolution(`💬 ${data.message}`, 'success');
                        return;
                    }

                    // Status desconectado (ex.: servidor fora do ar, sessão caída, sem conexão)
                    if (data.status === 'disconnected') {
                        adicionarLogEvolution(`⚠️ Evolution API DESCONECTADA`, 'warning');
                        if (data.url) adicionarLogEvolution(`🔗 URL: ${data.url}`, 'info');
                        if (data.instance) adicionarLogEvolution(`📱 Instância: ${data.instance}`, 'info');
                        if (data.error) adicionarLogEvolution(`❌ Detalhe técnico: ${data.error}`, 'danger');
                        adicionarLogEvolution(
                            `💬 A instância parece estar desconectada. Se você acabou de deslogar, gere um novo QR Code para reconectar.`,
                            'warning'
                        );
                        return;
                    }

                    // Erros gerais (configuração incorreta, erro HTTP, etc.)
                    adicionarLogEvolution(`❌ Evolution API com problemas`, 'warning');
                    if (data.status) adicionarLogEvolution(`📊 Status: ${data.status}`, 'warning');
                    if (data.url) adicionarLogEvolution(`🔗 URL: ${data.url}`, 'info');
                    if (data.instance) adicionarLogEvolution(`📱 Instância: ${data.instance}`, 'info');
                    if (data.error) adicionarLogEvolution(`❌ Erro: ${data.error}`, 'danger');
                    if (data.message) {
                        adicionarLogEvolution(`💬 ${data.message}`, 'warning');
                    } else {
                        adicionarLogEvolution(`💬 Verifique a configuração da Evolution API em Settings > Evolution API.`, 'warning');
                    }
    } else {
                    const error = await response.text();
                    adicionarLogEvolution(`❌ Erro HTTP ${response.status}`, 'danger');
                    adicionarLogEvolution(
                        `💬 ${error || 'O servidor da Evolution não respondeu corretamente. Verifique se a instância está online.'}`,
                        'danger'
                    );
                }
  } catch (error) {
                adicionarLogEvolution(`❌ Erro de conexão: ${error.message}`, 'danger');
                adicionarLogEvolution(
                    `💬 Verifique se o servidor da Evolution está rodando e se a instância está conectada. ` +
                    `Se você estiver deslogado, será necessário gerar um novo QR Code.`,
                    'warning'
                );
            }
        }

        function adicionarLogEvolution(mensagem, tipo = 'info') {
            const log = document.getElementById('evolutionLog');
            const timestamp = new Date().toLocaleTimeString();
            
            const logItem = document.createElement('div');
            logItem.className = `alert alert-modern alert-modern-${tipo} mb-2`;
            logItem.innerHTML = `<small>${timestamp}</small> - ${mensagem}`;
            
            log.appendChild(logItem);
            log.scrollTop = log.scrollHeight;
        }

        function getEvolutionModalInstance() {
            const modalEl = document.getElementById('modalQRCodeEvolution');
            if (!modalEl) return null;
            return bootstrap.Modal.getOrCreateInstance(modalEl);
        }

        function renderQRCodeEvolution(value) {
            const container = document.getElementById('qrcodeEvolutionContainer');
            if (!container) return;
            container.innerHTML = '';

            if (!value) {
                container.innerHTML = '<div class="text-muted w-100">QR Code não disponível. Tente novamente.</div>';
                return;
            }

            const sanitizedValue = value.trim();
            const isBase64 = sanitizedValue.startsWith('data:image') ||
                /^[A-Za-z0-9+/=]+$/.test(sanitizedValue.replace(/[\r\n]+/g, '')) && sanitizedValue.length > 200;

            // Limpar container
            container.innerHTML = '';
            
            // Criar wrapper com animação
            const wrapper = document.createElement('div');
            wrapper.style.cssText = 'position: relative; display: inline-block; padding: 20px; background: white; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); animation: fadeInScale 0.5s ease-out;';
            
            if (sanitizedValue.startsWith('data:image') || isBase64) {
                const img = document.createElement('img');
                img.alt = 'QR Code Evolution';
                img.className = 'img-fluid';
                img.style.cssText = 'max-width: 300px; max-height: 300px; width: 100%; height: auto; border-radius: 12px;';
                img.src = sanitizedValue.startsWith('data:image') ? sanitizedValue : `data:image/png;base64,${sanitizedValue}`;
                wrapper.appendChild(img);
            } else {
                const qrElement = document.createElement('div');
                qrElement.style.cssText = 'padding: 10px; background: white; border-radius: 12px;';
                wrapper.appendChild(qrElement);
                new QRCode(qrElement, {
                    text: sanitizedValue,
                    width: 300,
                    height: 300,
                    colorDark: '#000000',
                    colorLight: '#ffffff',
                    correctLevel: QRCode.CorrectLevel.H,
                    margin: 2
                });
            }
            
            container.appendChild(wrapper);
            
            // Adicionar animação CSS se não existir
            if (!document.getElementById('qrcodeAnimationStyle')) {
                const style = document.createElement('style');
                style.id = 'qrcodeAnimationStyle';
                style.textContent = `
                    @keyframes fadeInScale {
                        from {
                            opacity: 0;
                            transform: scale(0.9);
                        }
                        to {
                            opacity: 1;
                            transform: scale(1);
                        }
                    }
                `;
                document.head.appendChild(style);
            }
        }

        async function gerarQRCodeEvolution() {
            const btn = document.getElementById('btnGerarQRCode');
            const originalHtml = btn ? btn.innerHTML : '';
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Gerando...';
            }

            const modal = getEvolutionModalInstance();
            const container = document.getElementById('qrcodeEvolutionContainer');
            const info = document.getElementById('qrcodeEvolutionInfo');
            const status = document.getElementById('qrcodeEvolutionStatus');

            if (container) {
                container.innerHTML = '<div class="text-muted w-100"><div class="loading-spinner mb-3"></div>Gerando QR Code...</div>';
            }
            if (info) {
                info.textContent = 'Gerando QR Code...';
            }
            if (status) {
                status.textContent = '';
            }

            if (modal) {
                modal.show();
            }

            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/evolution/instance/qrcode', {
                    headers: { ...headers, 'Content-Type': 'application/json' },
                    credentials: 'include'
                });
                const data = await response.json();

                if (!data.success) {
                    const errorMsg = data.error || 'Não foi possível gerar o QR Code.';
                    if (errorMsg.includes('não configurada')) {
                        throw new Error('Você precisa configurar sua instância Evolution primeiro. Vá em Settings > Evolution API e cadastre sua instância.');
                    }
                    throw new Error(errorMsg);
                }

                renderQRCodeEvolution(data.qrcode);
                if (info) {
                    if (data.instanceName) {
                        info.innerHTML = `
                            <div class="d-flex align-items-center justify-content-center">
                                <i class="fas fa-server me-2" style="color: #667eea;"></i>
                                <strong style="color: #333;">Instância:</strong>
                                <span class="ms-2 badge bg-primary">${data.instanceName}</span>
                            </div>
                        `;
                    } else {
                        info.innerHTML = '<i class="fas fa-mobile-alt me-2"></i>Use o aplicativo WhatsApp para escanear o QR Code exibido.';
                    }
                }
                if (status && data.expiresIn) {
                    const minutes = Math.floor(data.expiresIn / 60);
                    const seconds = data.expiresIn % 60;
                    status.innerHTML = `
                        <i class="fas fa-clock me-2" style="color: #f8961e;"></i>
                        <strong>Este QR Code expira em:</strong> 
                        ${minutes > 0 ? `${minutes} minuto${minutes > 1 ? 's' : ''} e ` : ''}${seconds} segundo${seconds !== 1 ? 's' : ''}
                    `;
                    
                    // Mostrar botão de atualizar se o QR Code expirar em menos de 30 segundos
                    const btnAtualizar = document.getElementById('btnAtualizarQRCode');
                    if (btnAtualizar && data.expiresIn < 30) {
                        btnAtualizar.style.display = 'inline-block';
                        btnAtualizar.onclick = () => {
                            btnAtualizar.style.display = 'none';
                            gerarQRCodeEvolution();
                        };
                    }
                }
            } catch (error) {
                console.error('Erro ao gerar QR Code:', error);
                if (container) {
                    container.innerHTML = `
                        <div class="text-danger w-100">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            ${error.message || 'Erro ao gerar QR Code'}
                        </div>
                    `;
                }
                if (info) {
                    info.textContent = 'Tente novamente em instantes. Verifique se a instância está ativa.';
                }
                mostrarErro(error.message || 'Erro ao gerar QR Code da Evolution.');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml || '<i class="fas fa-qrcode me-2"></i>Gerar QR Code';
                }
            }
        }

        async function deslogarInstanciaEvolution() {
            if (!confirm('Deseja desconectar sua instância da Evolution? Será necessário ler o QR Code novamente.')) {
                return;
            }

            const btn = document.getElementById('btnDeslogarInstancia');
            const originalHtml = btn ? btn.innerHTML : '';
            if (btn) {
                btn.disabled = true;
                btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deslogando...';
            }

            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/evolution/instance/logout', {
                    method: 'POST',
                    headers: { ...headers, 'Content-Type': 'application/json' },
                    credentials: 'include'
                });
                const data = await response.json();

                if (!data.success) {
                    const errorMsg = data.error || 'Não foi possível desconectar a instância.';
                    if (errorMsg.includes('não configurada')) {
                        throw new Error('Você precisa configurar sua instância Evolution primeiro. Vá em Settings > Evolution API e cadastre sua instância.');
                    }
                    throw new Error(errorMsg);
                }

                // Mensagens imediatas para o usuário
                mostrarSucesso('Instância Evolution desconectada com sucesso. Gere um novo QR Code para reconectar.');
                adicionarLogEvolution('🔌 Instância Evolution desconectada pelo usuário. Nenhuma mensagem será enviada até reconectar.', 'warning');

                // Atualizar status (mostrará como desconectada se o servidor não estiver mais conectado)
                verificarEvolutionAPI();
            } catch (error) {
                console.error('Erro ao desconectar instância:', error);
                mostrarErro(error.message || 'Erro ao desconectar a instância Evolution.');
            } finally {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = originalHtml || '<i class="fas fa-sign-out-alt me-2"></i>Deslogar';
                }
            }
        }

        // ========== FUNÇÃO PARA AGUARDAR COM CONTADOR ==========
        async function aguardarComContador(segundos) {
            const delayCounterContainer = document.getElementById('delayCounterContainer');
            const delayCounter = document.getElementById('delayCounter');
            let tempoRestante = segundos;

            // Exibir contador
            delayCounterContainer.style.display = 'block';
            delayCounter.textContent = tempoRestante;

            // Atualizar contador a cada segundo
            while (tempoRestante > 0 && !disparoCancelado) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                if (disparoCancelado) break;
                tempoRestante--;
                delayCounter.textContent = tempoRestante;
            }

            // Ocultar contador
            delayCounterContainer.style.display = 'none';
        }

        // ========== PARAR DISPARO ==========
        function pararDisparo() {
            disparoCancelado = true;
            isDisparoAtivo = false;
            
            // Ocultar contador se estiver visível
            document.getElementById('delayCounterContainer').style.display = 'none';
            
            // Atualizar interface
            document.getElementById('btnIniciarDisparo').disabled = false;
            document.getElementById('btnIniciarDisparo').innerHTML = '<i class="fas fa-rocket me-2"></i>Iniciar Disparo';
            document.getElementById('btnPararDisparo').style.display = 'none';
            
            adicionarLog(`⏹️ Disparo cancelado pelo usuário! Enviados: ${totalEnviados}, Falhas: ${totalFalhas}`, 'warning');
            mostrarAviso(`Disparo cancelado!<br>Enviados: ${totalEnviados}<br>Falhas: ${totalFalhas}`);
        }

        // ========== GERAR DELAY ALEATÓRIO ==========
        function gerarDelayAleatorio() {
            const min = Math.max(1, parseInt(configDisparo.delayMin, 10) || DEFAULT_DISPARO_CONFIG.delayMin);
            const maxConfig = Math.max(min, parseInt(configDisparo.delayMax, 10) || min);
            if (maxConfig <= min) {
                return min;
            }
            return Math.floor(Math.random() * (maxConfig - min + 1)) + min;
        }

        function obterUsuarioAtual() {
            try {
                const usuarioLocal = localStorage.getItem('loggedInUser');
                if (usuarioLocal) {
                    const parsed = JSON.parse(usuarioLocal);
                    return {
                        email: parsed.email || parsed.username || parsed.user || null,
                        id: parsed.id || parsed.user_id || parsed.userId || null
                    };
                }
            } catch (error) {
                console.warn('⚠️ Não foi possível ler loggedInUser do localStorage:', error);
            }

            if (currentUser && typeof currentUser === 'string' && currentUser.includes('@')) {
                return { email: currentUser };
            }

            return null;
        }

        async function gerarMensagemVariada(textoOriginal, contextoExtra = {}) {
            if (!textoOriginal || !textoOriginal.trim()) {
                return textoOriginal;
            }

            // Verificar se a randomização de mensagens com IA está ativada
            if (!configDisparo.randomMessageAI) {
                return textoOriginal;
            }

            try {
                const usuarioAtual = obterUsuarioAtual();
                const headers = {
                    'Content-Type': 'application/json'
                };

                if (usuarioAtual?.email) {
                    headers['X-User-Email'] = usuarioAtual.email;
                }
                if (usuarioAtual?.id) {
                    headers['X-User-Id'] = usuarioAtual.id;
                }

                const response = await fetch('/api/mensagens/variar', {
                    method: 'POST',
                    headers,
                    credentials: 'include',
                    body: JSON.stringify({
                        mensagem: textoOriginal,
                        contexto: contextoExtra
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data && data.mensagem) {
                        return data.mensagem;
                    }
                } else if (response.status === 401) {
                    console.warn('⚠️ Sessão expirada ao variar mensagem. Usando texto original.');
                } else {
                    console.warn(`⚠️ Erro ao variar mensagem: HTTP ${response.status}`);
                }
            } catch (error) {
                console.warn('⚠️ Não foi possível gerar variação da mensagem:', error);
            }

            return textoOriginal;
        }

        // ========== INICIAR DISPARO ==========
        async function iniciarDisparo() {
            if (!treinamentoConcluido) {
                mostrarAviso('Finalize o treinamento "Disparador de Mensagens" antes de iniciar disparos.');
                return;
            }
            if (!currentClass) {
                mostrarAviso('Selecione uma categoria primeiro');
                return;
            }

            if (selectedMotoristas.size === 0) {
                mostrarAviso('Selecione pelo menos um motorista');
                return;
            }

            const mensagem = document.getElementById('messageText').value.trim();
            if (!mensagem) {
                mostrarAviso('Digite uma mensagem para enviar');
    return;
            }

            const imageFile = imagemSelecionada;
            const audioFileToSend = audioFile;

            isDisparoAtivo = true;
            disparoCancelado = false;
            totalEnviados = 0;
            totalFalhas = 0;

            // Atualizar interface
            document.getElementById('btnIniciarDisparo').disabled = true;
            document.getElementById('btnIniciarDisparo').innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Enviando...';
            document.getElementById('btnPararDisparo').style.display = 'block';

            // Ocultar contador inicialmente
            document.getElementById('delayCounterContainer').style.display = 'none';

            adicionarLog(`🚀 Iniciando disparo para ${selectedMotoristas.size} motoristas...`, 'info');
            if (imageFile) {
                adicionarLog(`🖼️ Imagem anexada: ${imageFile.name}`, 'info');
            }
            
            if (audioFileToSend) {
                adicionarLog(`🎤 Áudio anexado: ${audioFileToSend.name}`, 'info');
            }
            adicionarLog(`⚙️ Configuração: ${getConfigResumoTexto()}`, 'info');

            // Converter Set em Array e filtrar motoristas inativos e com erro
            const motoristasArray = Array.from(selectedMotoristas).filter(motoristaId => {
                const motorista = motoristasFiltrados.find(m => m.id === motoristaId);
                if (!motorista) {
                    selectedMotoristas.delete(motoristaId);
                    return false;
                }
                // Remover da seleção se estiver inativo
                if (motorista.status === 'inativo') {
                    selectedMotoristas.delete(motoristaId);
                    return false; // Não incluir no array de envio
                }
                // Remover da seleção se tiver erro de telefone
                if (motorista.telefone1_erro || motorista.telefone2_erro) {
                    selectedMotoristas.delete(motoristaId);
                    return false; // Não incluir no array de envio
                }
                return true;
            });

            // Se foram removidos motoristas, atualizar a interface
            const totalSelecionadosAntes = selectedMotoristas.size;
            if (motoristasArray.length < totalSelecionadosAntes) {
                const removidos = totalSelecionadosAntes - motoristasArray.length;
                adicionarLog(`⚠️ ${removidos} motorista(s) inativo(s) ou com erro de telefone foram removidos da seleção antes do disparo.`, 'warning');
                atualizarListaMotoristas(motoristasFiltrados);
                atualizarContadorSelecionados();
            }

            // Verificar se ainda há motoristas para enviar
            if (motoristasArray.length === 0) {
                isDisparoAtivo = false;
                document.getElementById('btnIniciarDisparo').disabled = false;
                document.getElementById('btnIniciarDisparo').innerHTML = '<i class="fas fa-rocket me-2"></i>Iniciar Disparo';
                document.getElementById('btnPararDisparo').style.display = 'none';
                mostrarAviso('Nenhum motorista válido selecionado. Todos os motoristas selecionados possuem erro de telefone.');
                return;
            }

            let motivoCancelamento = null;
            let minutosCooldownRestante = configDisparo.cooldownMinutes;

            // Processar envios
            for (let i = 0; i < motoristasArray.length; i++) {
                // Verificar se o disparo foi cancelado
                if (disparoCancelado) {
                    adicionarLog(`⏹️ Disparo interrompido na iteração ${i + 1}`, 'warning');
                    break;
                }

                const motoristaId = motoristasArray[i];
                const motorista = motoristasFiltrados.find(m => m.id === motoristaId);
                if (!motorista) continue;

                // Verificação adicional: garantir que está ativo
                if (motorista.status === 'inativo') {
                    adicionarLog(`⚠️ ${motorista.nome} foi pulado: está inativo.`, 'warning');
                    continue;
                }
                
                // Verificação adicional: garantir que não tem erro
                if (motorista.telefone1_erro || motorista.telefone2_erro) {
                    adicionarLog(`⚠️ ${motorista.nome} foi pulado: possui telefone com erro de disparo.`, 'warning');
                    continue;
                }

                // Aguardar delay aleatório ANTES de cada envio (exceto o primeiro)
                if (i > 0) {
                    // Verificar novamente se foi cancelado antes de aguardar
                    if (disparoCancelado) break;
                    
                    const delaySegundos = gerarDelayAleatorio();
                    adicionarLog(`⏳ Aguardando ${delaySegundos} segundos antes do próximo envio...`, 'info');
                    await aguardarComContador(delaySegundos);
                    
                    // Verificar se foi cancelado durante a espera
                    if (disparoCancelado) break;
                }

                const mensagemBase = mensagem
                    .replace(/\{\{name\}\}/g, motorista.nome || 'Motorista')
                    .replace(/\{\{telefone\}\}/g, motorista.telefone1 || '')
                    .replace(/\{\{estado\}\}/g, motorista.estado || '')
                    .replace(/\{\{classe_veiculo\}\}/g, motorista.classe_veiculo || '')
                    .replace(/\{\{tipo_veiculo\}\}/g, motorista.tipo_veiculo || '')
                    .replace(/\{\{tipo_carroceria\}\}/g, motorista.tipo_carroceria || '');
                const mensagemPersonalizada = await gerarMensagemVariada(mensagemBase, {
                    nome: motorista.nome,
                    telefone: motorista.telefone1,
                    estado: motorista.estado,
                    classeVeiculo: motorista.classe_veiculo,
                    tipoVeiculo: motorista.tipo_veiculo,
                    tipoCarroceria: motorista.tipo_carroceria,
                    ordemEnvio: i + 1,
                    totalSelecionados: motoristasArray.length
                });

                try {
                    // Buscar credenciais da Evolution API do usuário logado
                    const userData = localStorage.getItem('loggedInUser');
                    let userEmail = null;
                    let userId = null;
                    
                    if (userData) {
                        const user = JSON.parse(userData);
                        userEmail = user.email;
                        userId = user.id; // ✅ Usar ID do localStorage
                        console.log('👤 Usuário identificado:', userEmail);
                        console.log('🆔 User ID:', userId);
                    } else {
                        console.error('❌ Dados do usuário não encontrados no localStorage');
                        adicionarLog(`⚠️ Usuário não autenticado. Pulei: ${motorista.nome}`, 'warning');
                        totalFalhas++;
                        continue; // Pula para próximo motorista
                    }
                    
                    const formData = new FormData();
                    formData.append('number', motorista.telefone1);
                    formData.append('message', mensagemPersonalizada);
                    formData.append('usuario', userEmail);
                    formData.append('userId', userId);
                    formData.append('maxMessages', configDisparo.messageLimit);
                    formData.append('cooldownMinutes', configDisparo.cooldownMinutes);
                    formData.append('windowMinutes', configDisparo.windowMinutes);
                    formData.append('delayMin', configDisparo.delayMin);
                    formData.append('delayMax', configDisparo.delayMax);
                    formData.append('simulateTyping', configDisparo.simulateTyping ? 'true' : 'false');
                    if (imageFile) {
                        formData.append('media', imageFile);
                    } else if (audioFileToSend) {
                        formData.append('media', audioFileToSend);
                    }

                    const response = await fetch('/webhook/send-supabase', {
                        method: 'POST',
                        body: formData
                    });

                    let data = null;

                    if (response.status === 429) {
                        data = await response.json().catch(() => ({}));
                        totalFalhas++;
                        const restanteMin = data.remainingMinutes ?? 15;
                        adicionarLog(`⛔ Limite de envios atingido. Pausa obrigatória de ${restanteMin} minuto(s).`, 'warning');
                        mostrarAviso(`Limite de envios atingido.<br>Aguarde ${restanteMin} minuto(s) antes de continuar.`);
                        disparoCancelado = true;
                        motivoCancelamento = 'cooldown';
                        minutosCooldownRestante = restanteMin;
                        break;
                    }

                    if (response.ok) {
                        data = await response.json().catch(() => ({}));
                        if (data?.success) {
                            totalEnviados++;
                            adicionarLog(`✅ Enviado para ${motorista.nome} (${motorista.telefone1})`, 'success');
                            if (imageFile) {
                                adicionarLog(`🖼️ Imagem enviada: ${imageFile.name}`, 'info');
                            } else if (audioFileToSend) {
                                adicionarLog(`🎤 Áudio enviado: ${audioFileToSend.name}`, 'info');
                            }
                            if (data.instancia) {
                                adicionarLog(`🏷️ Usando instância: ${data.instancia}`, 'info');
                            }
                            if (data.cooldownTriggered) {
                                const cooldownMsg = data.cooldownMinutes
                                    ? `⏳ Limite atingido. Pausa automática de ${data.cooldownMinutes} minuto(s) iniciada.`
                                    : '⏳ Limite atingido. Pausa automática iniciada.';
                                adicionarLog(cooldownMsg, 'warning');
                                mostrarAviso(`${cooldownMsg}<br>Retome os envios após a pausa.`);
                                disparoCancelado = true;
                                motivoCancelamento = 'cooldown';
                                minutosCooldownRestante = data.cooldownMinutes || minutosCooldownRestante;
                                break;
                            }
                        } else {
                            totalFalhas++;
                            const errorMsg = data?.error || data?.message || 'Erro desconhecido';
                            adicionarLog(`❌ Falha para ${motorista.nome}: ${errorMsg}`, 'danger');
                            
                            // Marcar telefone com erro no banco de dados
                            try {
                                const headers = await getAuthHeaders();
                                const markResponse = await fetch('/api/motoristas/marcar-telefone-erro', {
                                    method: 'POST',
                                    headers: { ...headers, 'Content-Type': 'application/json' },
                                    credentials: 'include',
                                    body: JSON.stringify({
                                        motoristaId: motorista.id,
                                        telefone: motorista.telefone1,
                                        motivo: errorMsg.substring(0, 200) // Limitar tamanho
                                    })
                                });
                                const markData = await markResponse.json();
                                console.log(`📝 Telefone ${motorista.telefone1} marcado com erro para ${motorista.nome}`);
                                
                                // Atualizar o motorista na lista local
                                const motoristaIndex = motoristasFiltrados.findIndex(m => m.id === motorista.id);
                                if (motoristaIndex !== -1) {
                                    motoristasFiltrados[motoristaIndex].telefone1_erro = true;
                                    motoristasFiltrados[motoristaIndex].telefone1_erro_motivo = errorMsg.substring(0, 200);
                                    // Se o motorista foi inativado, atualizar o status
                                    if (markData.motoristaInativado) {
                                        motoristasFiltrados[motoristaIndex].status = 'inativo';
                                        adicionarLog(`🔄 ${motorista.nome} foi inativado automaticamente por ter erro`, 'info');
                                        // Remover da lista se filtro estiver em "ativo"
                                        atualizarMotoristaInativado(motorista.id, true);
                                    } else {
                                        // Recarregar apenas a página atual
                                        atualizarListaMotoristas(motoristasFiltrados);
                                    }
                                }
                            } catch (markError) {
                                console.error('❌ Erro ao marcar telefone com erro:', markError);
                            }
                            
                            if (errorMsg.includes('Credenciais da Evolution API não configuradas')) {
                                adicionarLog(`⚠️ CONFIGURE SUAS CREDENCIAIS em Settings > Evolution API`, 'warning');
                            }
                            
                            if (data?.solution) {
                                adicionarLog(`💡 ${data.solution}`, 'warning');
                            }
                            
                            if (data?.details) {
                                adicionarLog(`📋 Detalhes: ${data.details}`, 'info');
                            }
                        }
                    } else {
                        totalFalhas++;
                        const errorData = await response.json().catch(() => ({}));
                        const errorMsg = errorData.error || `HTTP ${response.status}`;
                        adicionarLog(`❌ Falha para ${motorista.nome}: HTTP ${response.status}`, 'danger');
                        
                        // Marcar telefone com erro no banco de dados
                        try {
                            const headers = await getAuthHeaders();
                            const markResponse = await fetch('/api/motoristas/marcar-telefone-erro', {
                                method: 'POST',
                                headers: { ...headers, 'Content-Type': 'application/json' },
                                credentials: 'include',
                                body: JSON.stringify({
                                    motoristaId: motorista.id,
                                    telefone: motorista.telefone1,
                                    motivo: errorMsg.substring(0, 200) // Limitar tamanho
                                })
                            });
                            const markData = await markResponse.json();
                            console.log(`📝 Telefone ${motorista.telefone1} marcado com erro para ${motorista.nome}`);
                            
                            // Atualizar o motorista na lista local
                            const motoristaIndex = motoristasFiltrados.findIndex(m => m.id === motorista.id);
                            if (motoristaIndex !== -1) {
                                motoristasFiltrados[motoristaIndex].telefone1_erro = true;
                                motoristasFiltrados[motoristaIndex].telefone1_erro_motivo = errorMsg.substring(0, 200);
                                // Se o motorista foi inativado, atualizar o status
                                if (markData.motoristaInativado) {
                                    motoristasFiltrados[motoristaIndex].status = 'inativo';
                                    adicionarLog(`🔄 ${motorista.nome} foi inativado automaticamente por ter erro`, 'info');
                                    // Remover da lista se filtro estiver em "ativo"
                                    atualizarMotoristaInativado(motorista.id, true);
                                } else {
                                    // Recarregar apenas a página atual
                                    atualizarListaMotoristas(motoristasFiltrados);
                                }
                            }
                        } catch (markError) {
                            console.error('❌ Erro ao marcar telefone com erro:', markError);
                        }
                        
                        if (errorData.error) {
                            adicionarLog(`   Detalhes: ${errorData.error}`, 'danger');
                        }
                        if (errorData.solution) {
                            adicionarLog(`💡 ${errorData.solution}`, 'warning');
                        }
                    }
                } catch (error) {
                    totalFalhas++;
                    adicionarLog(`❌ Erro para ${motorista.nome}: ${error.message}`, 'danger');
                    console.error('❌ Erro ao enviar mensagem:', error);
                    
                    // Marcar telefone com erro no banco de dados
                    try {
                        const headers = await getAuthHeaders();
                        const markResponse = await fetch('/api/motoristas/marcar-telefone-erro', {
                            method: 'POST',
                            headers: { ...headers, 'Content-Type': 'application/json' },
                            credentials: 'include',
                            body: JSON.stringify({
                                motoristaId: motorista.id,
                                telefone: motorista.telefone1,
                                motivo: error.message.substring(0, 200) // Limitar tamanho
                            })
                        });
                        const markData = await markResponse.json();
                        console.log(`📝 Telefone ${motorista.telefone1} marcado com erro para ${motorista.nome}`);
                        
                        // Atualizar o motorista na lista local
                        const motoristaIndex = motoristasFiltrados.findIndex(m => m.id === motorista.id);
                        if (motoristaIndex !== -1) {
                            motoristasFiltrados[motoristaIndex].telefone1_erro = true;
                            motoristasFiltrados[motoristaIndex].telefone1_erro_motivo = error.message.substring(0, 200);
                            // Se o motorista foi inativado, atualizar o status
                            if (markData.motoristaInativado) {
                                motoristasFiltrados[motoristaIndex].status = 'inativo';
                                adicionarLog(`🔄 ${motorista.nome} foi inativado automaticamente por ter erro`, 'info');
                                // Remover da lista se filtro estiver em "ativo"
                                atualizarMotoristaInativado(motorista.id, true);
                            } else {
                                // Recarregar apenas a página atual
                                atualizarListaMotoristas(motoristasFiltrados);
                            }
                        }
                    } catch (markError) {
                        console.error('❌ Erro ao marcar telefone com erro:', markError);
                    }
                }

                // Verificar se foi cancelado após o envio
                if (disparoCancelado) {
                    break;
                }

                // Atualizar progresso
                const progresso = ((totalEnviados + totalFalhas) / selectedMotoristas.size) * 100;
                document.getElementById('progressBar').style.width = `${progresso}%`;
                document.getElementById('progressText').textContent = `${totalEnviados + totalFalhas} de ${selectedMotoristas.size} enviados`;
            }

            // Finalizar
            isDisparoAtivo = false;
            document.getElementById('btnIniciarDisparo').disabled = false;
            document.getElementById('btnIniciarDisparo').innerHTML = '<i class="fas fa-rocket me-2"></i>Iniciar Disparo';
            document.getElementById('btnPararDisparo').style.display = 'none';
            document.getElementById('delayCounterContainer').style.display = 'none';

            // Mostrar mensagem final baseado se foi cancelado ou concluído
            if (disparoCancelado) {
                if (motivoCancelamento === 'cooldown') {
                    adicionarLog(`⏹️ Disparo interrompido devido ao limite de mensagens. Aguarde ${minutosCooldownRestante} minuto(s) para retomar.`, 'warning');
                    mostrarAviso(`Disparo interrompido devido ao limite de mensagens.<br>Aguarde ${minutosCooldownRestante} minuto(s) para retomar.`);
                } else {
                    adicionarLog(`⏹️ Disparo interrompido! Enviados: ${totalEnviados}, Falhas: ${totalFalhas}`, 'warning');
                    mostrarAviso(`Disparo interrompido!<br>Enviados: ${totalEnviados}<br>Falhas: ${totalFalhas}`);
                }
            } else {
                adicionarLog(`🎉 Disparo concluído! Enviados: ${totalEnviados}, Falhas: ${totalFalhas}`, 'success');
                mostrarSucesso(`Disparo concluído!<br>Enviados: ${totalEnviados}<br>Falhas: ${totalFalhas}`);
            }

            // Inativar automaticamente contatos antigos com erro após o disparo
            await inativarContatosComErro();
        }

        // ========== UTILITÁRIOS ==========
        function adicionarLog(mensagem, tipo = 'info') {
            const log = document.getElementById('disparoLog');
            const timestamp = new Date().toLocaleTimeString();
            
            const logItem = document.createElement('div');
            logItem.className = `alert alert-modern alert-modern-${tipo} mb-2`;
            logItem.innerHTML = `<small>${timestamp}</small> - ${mensagem}`;
            
            log.appendChild(logItem);
            log.scrollTop = log.scrollHeight;
        }

        function mostrarSucesso(mensagem) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-modern alert-modern-success alert-dismissible fade show';
            alert.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>
                ${mensagem}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alert, document.body.firstChild);
            
            setTimeout(() => alert.remove(), 5000);
        }

        function mostrarAviso(mensagem) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-modern alert-modern-warning alert-dismissible fade show';
            alert.innerHTML = `
                <i class="fas fa-exclamation-triangle me-2"></i>
                ${mensagem}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alert, document.body.firstChild);
            
            setTimeout(() => alert.remove(), 5000);
        }

        function mostrarErro(mensagem) {
            const alert = document.createElement('div');
            alert.className = 'alert alert-modern alert-modern-danger alert-dismissible fade show';
            alert.innerHTML = `
                <i class="fas fa-exclamation-circle me-2"></i>
                ${mensagem}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.insertBefore(alert, document.body.firstChild);
            
            setTimeout(() => alert.remove(), 5000);
        }

        // ========== FUNÇÃO AUXILIAR PARA ATUALIZAR MOTORISTA INATIVADO ==========
        function atualizarMotoristaInativado(motoristaId, statusInativo) {
            if (!statusInativo) return;
            
            // Verificar filtro de status atual
            const filtroStatus = document.getElementById('filtroStatus')?.value || '';
            
            // Se o filtro estiver em "ativo", remover o motorista da lista
            if (filtroStatus === 'ativo') {
                const motoristaIndex = motoristasFiltrados.findIndex(m => m.id === motoristaId);
                if (motoristaIndex !== -1) {
                    motoristasFiltrados.splice(motoristaIndex, 1);
                    // Remover também da seleção se estiver selecionado
                    selectedMotoristas.delete(motoristaId);
                    atualizarContadorSelecionados();
                }
            }
            
            // Atualizar a lista na tela
            atualizarListaMotoristas(motoristasFiltrados);
        }

        // ========== FUNÇÃO PARA INATIVAR CONTATOS COM ERRO ==========
        async function inativarContatosComErro() {
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/motoristas/inativar-com-erro', {
                    method: 'POST',
                    headers: { ...headers, 'Content-Type': 'application/json' },
                    credentials: 'include'
                });

                const data = await response.json();
                
                if (data.success) {
                    if (data.totalInativados > 0) {
                        console.log(`✅ ${data.totalInativados} contato(s) inativado(s) automaticamente por terem erro`);
                        adicionarLog(`🔄 ${data.totalInativados} contato(s) inativado(s) automaticamente por terem erro`, 'info');
                        
                        // Verificar filtro de status atual
                        const filtroStatus = document.getElementById('filtroStatus')?.value || '';
                        
                        // Se o filtro estiver em "ativo", remover os contatos inativados da lista
                        if (filtroStatus === 'ativo' && data.detalhes) {
                            const idsInativados = data.detalhes.map(d => d.id);
                            motoristasFiltrados = motoristasFiltrados.filter(m => !idsInativados.includes(m.id));
                            
                            // Remover também da seleção
                            idsInativados.forEach(id => selectedMotoristas.delete(id));
                            atualizarContadorSelecionados();
                            
                            // Atualizar a lista na tela
                            atualizarListaMotoristas(motoristasFiltrados);
                        }
                    }
                    return data;
                } else {
                    console.error('❌ Erro ao inativar contatos:', data.error);
                    return null;
                }
            } catch (error) {
                console.error('❌ Erro ao inativar contatos com erro:', error);
                return null;
            }
        }

        function toggleTheme() {
            const body = document.body;
            const currentTheme = body.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            const icon = document.querySelector('.header-actions .btn i');
            icon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        // Carregar tema salvo
        document.addEventListener('DOMContentLoaded', () => {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            
            const icon = document.querySelector('.header-actions .btn i');
            if (icon) {
                icon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
            }
        });
</script>
<!-- Chat IA -->
<link rel="stylesheet" href="css/chat-ia.css">
<script src="js/chat-ia.js"></script>
</body>
</html>