<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferramentas de Qualidade - Intranet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/permissions.js"></script>
    <style>
        body {
            background: #f8f9fa;
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        
        .header-section {
            background: #667eea;
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
        }
        
        .tool-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #dee2e6;
        }
        
        .tool-icon {
            width: 50px;
            height: 50px;
            background: #667eea;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }
        
        .nav-tabs .nav-link {
            color: #495057;
            border: none;
            border-bottom: 2px solid transparent;
            padding: 0.5rem 1rem;
        }
        
        .nav-tabs .nav-link:hover {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .nav-tabs .nav-link.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: transparent;
        }
        
        .form-section {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .ishikawa-container {
            position: relative;
            min-height: 500px;
            overflow: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .ishikawa-diagram {
            position: relative;
            margin: 20px auto;
            width: 100%;
            max-width: 1400px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .fishbone-spine {
            stroke: #2c3e50;
            stroke-width: 5;
            stroke-linecap: round;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2));
        }
        
        .fishbone-branch {
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.15));
        }
        
        .fishbone-branch.metodo { stroke: #3498db; }
        .fishbone-branch.maoobra { stroke: #e74c3c; }
        .fishbone-branch.material { stroke: #f39c12; }
        .fishbone-branch.maquina { stroke: #9b59b6; }
        .fishbone-branch.meioambiente { stroke: #27ae60; }
        .fishbone-branch.medicao { stroke: #16a085; }
        
        .fishbone-sub-branch {
            stroke: #7f8c8d;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            opacity: 0.8;
        }
        
        .fishbone-label {
            font-size: 15px;
            fill: #2c3e50;
            font-weight: 700;
            font-family: 'Segoe UI', Arial, sans-serif;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
        }
        
        .fishbone-causa-text {
            font-size: 11px;
            fill: #34495e;
            font-family: 'Segoe UI', Arial, sans-serif;
            font-weight: 500;
        }
        
        .fishbone-effect-box {
            fill: #e74c3c;
            stroke: #c0392b;
            stroke-width: 3;
            filter: drop-shadow(0 3px 6px rgba(0,0,0,0.3));
        }
        
        .fishbone-effect-text {
            fill: white;
            font-size: 17px;
            font-weight: bold;
            font-family: 'Segoe UI', Arial, sans-serif;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        
        .fishbone-category-box {
            stroke: #2c3e50;
            stroke-width: 2;
            rx: 6;
            ry: 6;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
        
        .fishbone-category-box.metodo { fill: #3498db; }
        .fishbone-category-box.maoobra { fill: #e74c3c; }
        .fishbone-category-box.material { fill: #f39c12; }
        .fishbone-category-box.maquina { fill: #9b59b6; }
        .fishbone-category-box.meioambiente { fill: #27ae60; }
        .fishbone-category-box.medicao { fill: #16a085; }
        
        .fishbone-category-text {
            fill: white;
            font-size: 13px;
            font-weight: bold;
            font-family: 'Segoe UI', Arial, sans-serif;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .fishbone-head {
            fill: #e74c3c;
            stroke: #c0392b;
            stroke-width: 3;
        }
        
        .fishbone-eye {
            fill: white;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
        }
        
        .fishbone-fin {
            fill: #e74c3c;
            stroke: #c0392b;
            stroke-width: 2;
            opacity: 0.9;
        }
        
        .action-item {
            background: white;
            border-left: 4px solid #667eea;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        
        .action-item.completed {
            border-left-color: #28a745;
            opacity: 0.8;
        }
        
        .acao-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .acao-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .acao-card.prioridade-alta {
            border-left: 4px solid #dc3545;
        }
        
        .acao-card.prioridade-media {
            border-left: 4px solid #ffc107;
        }
        
        .acao-card.prioridade-baixa {
            border-left: 4px solid #0dcaf0;
        }
        
        .acao-card.finalizado {
            background: #f8f9fa;
            opacity: 0.9;
        }
        
        .acao-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .acao-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .acao-info-item {
            display: flex;
            flex-direction: column;
        }
        
        .acao-info-item label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }
        
        .acao-info-item input,
        .acao-info-item select,
        .acao-info-item textarea {
            font-size: 0.9rem;
        }
        
        .acao-descricao {
            margin-bottom: 1rem;
        }
        
        .badge-status {
            padding: 0.35rem 0.65rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .progress-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .progress-container input {
            width: 80px;
        }
        
        .progress-container .progress {
            flex: 1;
            height: 20px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header-section">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-tools me-2"></i>Ferramentas de Qualidade</h1>
                    <p class="mb-0">Conjunto de ferramentas para an√°lise e melhoria cont√≠nua</p>
                </div>
                <div>
                    <a href="treinamentos.html" class="btn btn-light">
                        <i class="fas fa-arrow-left me-2"></i>Voltar aos Treinamentos
                    </a>
                    <a href="portal.html" class="btn btn-light ms-2">
                        <i class="fas fa-home me-2"></i>Portal
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Tabs de Ferramentas -->
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-5porques" type="button">
                    <i class="fas fa-question-circle me-1"></i>5 Porqu√™s
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-5w2h" type="button">
                    <i class="fas fa-clipboard-question me-1"></i>5W2H
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-ishikawa" type="button">
                    <i class="fas fa-project-diagram me-1"></i>Ishikawa
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-plano-acao" type="button">
                    <i class="fas fa-tasks me-1"></i>Plano de A√ß√£o
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-pdca" type="button">
                    <i class="fas fa-sync-alt me-1"></i>PDCA
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-brainstorm" type="button">
                    <i class="fas fa-lightbulb me-1"></i>Brainstorming
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-arquivos" type="button">
                    <i class="fas fa-archive me-1"></i>Arquivos
                    <span class="badge bg-danger ms-1" id="badgeAlertas" style="display: none;">0</span>
                </button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- Tab 5 Porqu√™s -->
            <div class="tab-pane fade show active" id="tab-5porques" role="tabpanel">
                <div class="tool-card">
                    <div class="d-flex align-items-center mb-4">
                        <div class="tool-icon">
                            <i class="fas fa-question-circle"></i>
                        </div>
                        <div class="ms-3">
                            <h3>5 Porqu√™s</h3>
                            <p class="text-muted mb-0">T√©cnica para identificar a causa raiz de um problema atrav√©s de perguntas sucessivas</p>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="mb-3">
                            <label class="form-label fw-bold">T√≠tulo:</label>
                            <input type="text" class="form-control" id="titulo5porques" placeholder="Ex: An√°lise de defeitos em produ√ß√£o">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Problema Identificado:</label>
                            <input type="text" class="form-control" id="problema5porques" placeholder="Descreva o problema inicial">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">1¬∫ Por qu√™?</label>
                            <input type="text" class="form-control" id="porque1" placeholder="Por que isso aconteceu?">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">2¬∫ Por qu√™?</label>
                            <input type="text" class="form-control" id="porque2" placeholder="Por que isso aconteceu?">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">3¬∫ Por qu√™?</label>
                            <input type="text" class="form-control" id="porque3" placeholder="Por que isso aconteceu?">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">4¬∫ Por qu√™?</label>
                            <input type="text" class="form-control" id="porque4" placeholder="Por que isso aconteceu?">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">5¬∫ Por qu√™?</label>
                            <input type="text" class="form-control" id="porque5" placeholder="Por que isso aconteceu?">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Causa Raiz Identificada:</label>
                            <textarea class="form-control" id="causaRaiz" rows="3" placeholder="Com base nas respostas, identifique a causa raiz"></textarea>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" onclick="salvar5Porques()">
                                <i class="fas fa-save me-2"></i>Salvar
                            </button>
                            <button class="btn btn-primary" onclick="exportar5Porques()">
                                <i class="fas fa-download me-2"></i>Exportar PDF
                            </button>
                            <button class="btn btn-secondary" onclick="limpar5Porques()">
                                <i class="fas fa-redo me-2"></i>Limpar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 5W2H -->
            <div class="tab-pane fade" id="tab-5w2h" role="tabpanel">
                <div class="tool-card">
                    <div class="d-flex align-items-center mb-4">
                        <div class="tool-icon">
                            <i class="fas fa-clipboard-question"></i>
                        </div>
                        <div class="ms-3">
                            <h3>5W2H</h3>
                            <p class="text-muted mb-0">Ferramenta para planejamento e organiza√ß√£o de a√ß√µes atrav√©s de perguntas espec√≠ficas</p>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="mb-3">
                            <label class="form-label fw-bold">T√≠tulo do 5W2H:</label>
                            <input type="text" class="form-control" id="titulo5w2h" placeholder="Nome/identifica√ß√£o deste 5W2H">
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label fw-bold mb-0">Linhas de Informa√ß√£o:</label>
                                <button class="btn btn-sm btn-primary" onclick="adicionarLinha5W2H()">
                                    <i class="fas fa-plus me-1"></i>Adicionar Linha
                                </button>
                            </div>
                            <div id="linhas5w2h">
                                <!-- Linhas ser√£o adicionadas aqui -->
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" onclick="salvar5W2H()">
                                <i class="fas fa-save me-2"></i>Salvar
                            </button>
                            <button class="btn btn-primary" onclick="exportar5W2H()">
                                <i class="fas fa-download me-2"></i>Exportar PDF
                            </button>
                            <button class="btn btn-secondary" onclick="limpar5W2H()">
                                <i class="fas fa-redo me-2"></i>Limpar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Ishikawa -->
            <div class="tab-pane fade" id="tab-ishikawa" role="tabpanel">
                <div class="tool-card">
                    <div class="d-flex align-items-center mb-4">
                        <div class="tool-icon">
                            <i class="fas fa-project-diagram"></i>
                        </div>
                        <div class="ms-3">
                            <h3>Diagrama de Ishikawa (Espinha de Peixe)</h3>
                            <p class="text-muted mb-0">Diagrama para identificar e organizar causas de um problema</p>
                        </div>
                    </div>
                    
                    <div class="form-section mb-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold">T√≠tulo do Diagrama:</label>
                            <input type="text" class="form-control" id="tituloIshikawa" placeholder="Ex: An√°lise de causas de defeitos">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Problema (Efeito):</label>
                            <input type="text" class="form-control" id="problemaIshikawa" placeholder="Descreva o problema principal">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold">M√©todo:</label>
                                <textarea class="form-control" id="ishikawa-metodo" rows="3" placeholder="Causas relacionadas ao m√©todo/processo"></textarea>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold">M√£o de Obra:</label>
                                <textarea class="form-control" id="ishikawa-maoobra" rows="3" placeholder="Causas relacionadas √†s pessoas"></textarea>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold">Material:</label>
                                <textarea class="form-control" id="ishikawa-material" rows="3" placeholder="Causas relacionadas aos materiais"></textarea>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold">M√°quina:</label>
                                <textarea class="form-control" id="ishikawa-maquina" rows="3" placeholder="Causas relacionadas √†s m√°quinas/equipamentos"></textarea>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold">Meio Ambiente:</label>
                                <textarea class="form-control" id="ishikawa-meioambiente" rows="3" placeholder="Causas relacionadas ao ambiente"></textarea>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold">Medi√ß√£o:</label>
                                <textarea class="form-control" id="ishikawa-medicao" rows="3" placeholder="Causas relacionadas √† medi√ß√£o"></textarea>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="visualizarIshikawa()">
                                <i class="fas fa-eye me-2"></i>Visualizar Diagrama
                            </button>
                            <button class="btn btn-success" onclick="salvarIshikawa()">
                                <i class="fas fa-save me-2"></i>Salvar
                            </button>
                            <button class="btn btn-info" onclick="exportarIshikawa()">
                                <i class="fas fa-download me-2"></i>Exportar PDF
                            </button>
                            <button class="btn btn-secondary" onclick="limparIshikawa()">
                                <i class="fas fa-redo me-2"></i>Limpar
                            </button>
                        </div>
                    </div>
                    
                    <div class="ishikawa-container" id="ishikawa-diagram-container" style="display: none;">
                        <svg id="ishikawa-svg" class="ishikawa-diagram"></svg>
                    </div>
                </div>
            </div>

            <!-- Tab Plano de A√ß√£o -->
            <div class="tab-pane fade" id="tab-plano-acao" role="tabpanel">
                <div class="tool-card">
                    <div class="d-flex align-items-center mb-4">
                        <div class="tool-icon">
                            <i class="fas fa-tasks"></i>
                        </div>
                        <div class="ms-3">
                            <h3>Plano de A√ß√£o Completo</h3>
                            <p class="text-muted mb-0">Gest√£o completa de a√ß√µes com gestor, respons√°veis, prazos, progresso e conting√™ncias</p>
                        </div>
                    </div>
                    
                    <div class="form-section mb-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold">T√≠tulo do Plano:</label>
                            <input type="text" class="form-control" id="tituloPlano" placeholder="Nome do plano de a√ß√£o">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Objetivo:</label>
                            <textarea class="form-control" id="objetivoPlano" rows="2" placeholder="Qual o objetivo deste plano?"></textarea>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">A√ß√µes</h5>
                            <button class="btn btn-primary btn-sm" onclick="adicionarAcao()">
                                <i class="fas fa-plus me-1"></i>Adicionar A√ß√£o
                            </button>
                        </div>
                        
                        <div id="listaAcoes">
                            <!-- A√ß√µes ser√£o adicionadas aqui -->
                        </div>
                        
                        <div class="alert alert-info mt-3" id="alertasPlano" style="display: none;">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Alertas de Prazo:</strong>
                            <div id="listaAlertasPlano"></div>
                        </div>
                        
                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-success" onclick="salvarPlanoAcao()">
                                <i class="fas fa-save me-2"></i>Salvar
                            </button>
                            <button class="btn btn-primary" onclick="exportarPlanoAcao()">
                                <i class="fas fa-download me-2"></i>Exportar PDF/Excel
                            </button>
                            <button class="btn btn-secondary" onclick="limparPlanoAcao()">
                                <i class="fas fa-redo me-2"></i>Limpar Tudo
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab PDCA -->
            <div class="tab-pane fade" id="tab-pdca" role="tabpanel">
                <div class="tool-card">
                    <div class="d-flex align-items-center mb-4">
                        <div class="tool-icon">
                            <i class="fas fa-sync-alt"></i>
                        </div>
                        <div class="ms-3">
                            <h3>PDCA (Plan-Do-Check-Act)</h3>
                            <p class="text-muted mb-0">Ciclo de melhoria cont√≠nua: Planejar, Executar, Verificar e Agir</p>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="mb-3">
                            <label class="form-label fw-bold">T√≠tulo:</label>
                            <input type="text" class="form-control" id="tituloPDCA" placeholder="Ex: Melhoria do processo de entrega">
                        </div>
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card h-100 border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>PLAN - Planejar</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Problema/Oportunidade:</label>
                                            <textarea class="form-control" id="pdca-problema" rows="2"></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Objetivo:</label>
                                            <textarea class="form-control" id="pdca-objetivo" rows="2"></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Plano de A√ß√£o:</label>
                                            <textarea class="form-control" id="pdca-plano" rows="3"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100 border-success">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0"><i class="fas fa-play me-2"></i>DO - Executar</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">O que foi executado:</label>
                                            <textarea class="form-control" id="pdca-executado" rows="3"></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Dificuldades encontradas:</label>
                                            <textarea class="form-control" id="pdca-dificuldades" rows="2"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card h-100 border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <h5 class="mb-0"><i class="fas fa-search me-2"></i>CHECK - Verificar</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Resultados obtidos:</label>
                                            <textarea class="form-control" id="pdca-resultados" rows="3"></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Compara√ß√£o com objetivo:</label>
                                            <textarea class="form-control" id="pdca-comparacao" rows="2"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100 border-danger">
                                    <div class="card-header bg-danger text-white">
                                        <h5 class="mb-0"><i class="fas fa-cog me-2"></i>ACT - Agir</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Padroniza√ß√£o:</label>
                                            <textarea class="form-control" id="pdca-padronizacao" rows="2"></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Pr√≥ximos passos:</label>
                                            <textarea class="form-control" id="pdca-proximos" rows="2"></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Pr√≥ximo ciclo PDCA:</label>
                                            <textarea class="form-control" id="pdca-proximo-ciclo" rows="2"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" onclick="salvarPDCA()">
                                <i class="fas fa-save me-2"></i>Salvar
                            </button>
                            <button class="btn btn-primary" onclick="exportarPDCA()">
                                <i class="fas fa-download me-2"></i>Exportar PDF
                            </button>
                            <button class="btn btn-secondary" onclick="limparPDCA()">
                                <i class="fas fa-redo me-2"></i>Limpar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Brainstorming -->
            <div class="tab-pane fade" id="tab-brainstorm" role="tabpanel">
                <div class="tool-card">
                    <div class="d-flex align-items-center mb-4">
                        <div class="tool-icon">
                            <i class="fas fa-lightbulb"></i>
                        </div>
                        <div class="ms-3">
                            <h3>Brainstorming</h3>
                            <p class="text-muted mb-0">T√©cnica para gerar ideias e solu√ß√µes criativas</p>
                        </div>
                    </div>
                    
                    <div class="form-section">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Tema/Problema:</label>
                            <input type="text" class="form-control" id="temaBrainstorm" placeholder="Qual o tema ou problema a ser discutido?">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Objetivo:</label>
                            <textarea class="form-control" id="objetivoBrainstorm" rows="2" placeholder="Qual o objetivo desta sess√£o?"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Regras:</label>
                            <ul class="list-group">
                                <li class="list-group-item"><i class="fas fa-check-circle text-success me-2"></i>N√£o critique ideias</li>
                                <li class="list-group-item"><i class="fas fa-check-circle text-success me-2"></i>Quantidade √© mais importante que qualidade</li>
                                <li class="list-group-item"><i class="fas fa-check-circle text-success me-2"></i>Construa sobre ideias dos outros</li>
                                <li class="list-group-item"><i class="fas fa-check-circle text-success me-2"></i>Pensamentos livres e criativos</li>
                            </ul>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Ideias:</label>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="novaIdeia" placeholder="Digite uma ideia...">
                                <button class="btn btn-primary" onclick="adicionarIdeia()">
                                    <i class="fas fa-plus"></i> Adicionar
                                </button>
                            </div>
                            <div id="listaIdeias" class="row g-2">
                                <!-- Ideias ser√£o adicionadas aqui -->
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Ideias Selecionadas (Top 5):</label>
                            <div id="ideiasSelecionadas" class="list-group">
                                <!-- Ideias selecionadas aparecer√£o aqui -->
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" onclick="salvarBrainstorm()">
                                <i class="fas fa-save me-2"></i>Salvar
                            </button>
                            <button class="btn btn-primary" onclick="exportarBrainstorm()">
                                <i class="fas fa-download me-2"></i>Exportar PDF
                            </button>
                            <button class="btn btn-secondary" onclick="limparBrainstorm()">
                                <i class="fas fa-redo me-2"></i>Limpar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Arquivos -->
            <div class="tab-pane fade" id="tab-arquivos" role="tabpanel">
                <div class="tool-card">
                    <div class="d-flex align-items-center mb-4">
                        <div class="tool-icon">
                            <i class="fas fa-archive"></i>
                        </div>
                        <div class="ms-3">
                            <h3>Ferramentas Arquivadas</h3>
                            <p class="text-muted mb-0">Consulte e gerencie suas ferramentas salvas</p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-md-4">
                                <select class="form-select" id="filtroTipoArquivo">
                                    <option value="">Todos os tipos</option>
                                    <option value="5porques">5 Porqu√™s</option>
                                    <option value="5w2h">5W2H</option>
                                    <option value="ishikawa">Ishikawa</option>
                                    <option value="plano_acao">Plano de A√ß√£o</option>
                                    <option value="pdca">PDCA</option>
                                    <option value="brainstorm">Brainstorming</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="filtroArquivado">
                                    <option value="false">Ativas</option>
                                    <option value="true">Arquivadas</option>
                                    <option value="">Todas</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-primary w-100" onclick="carregarFerramentasArquivadas()">
                                    <i class="fas fa-search me-2"></i>Filtrar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="listaFerramentasArquivadas">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Vari√°veis globais
        let acoesPlano = [];
        let ideiasBrainstorm = [];
        let ideiasSelecionadas = [];
        let linhas5W2H = [];
        let usuariosPlataforma = [];
        let ferramentaAtualId = null;
        let supabase = null;
        
        // Inicializar Supabase
        async function inicializarSupabase() {
            try {
                const response = await fetch('/api/supabase-config');
                if (!response.ok) {
                    throw new Error('Erro ao buscar configura√ß√£o do Supabase');
                }
                
                const config = await response.json();
                supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseAnonKey);
                window.supabase = supabase;
                console.log('‚úÖ Supabase inicializado');
                return true;
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao inicializar Supabase:', error);
                return false;
            }
        }
        
        // Obter headers de autentica√ß√£o
        async function getAuthHeaders() {
            const headers = {
                'Content-Type': 'application/json'
            };
            
            // Tentar obter token do Supabase
            if (supabase) {
                try {
                    const { data: { session } } = await supabase.auth.getSession();
                    if (session && session.access_token) {
                        headers['Authorization'] = `Bearer ${session.access_token}`;
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao obter sess√£o:', error);
                }
            }
            
            // Tentar obter email do localStorage
            try {
                const userData = localStorage.getItem('userData');
                if (userData) {
                    const parsed = JSON.parse(userData);
                    if (parsed.email) {
                        headers['X-User-Email'] = parsed.email;
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao obter email do localStorage:', error);
            }
            
            return headers;
        }
        
        // Carregar usu√°rios ao iniciar
        async function carregarUsuarios() {
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/ferramentas-qualidade/usuarios', {
                    headers: headers,
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    console.warn('‚ö†Ô∏è API de usu√°rios n√£o dispon√≠vel, tentando alternativa...');
                    // Tentar buscar via Supabase diretamente se dispon√≠vel
                    if (window.supabase) {
                        try {
                            const { data: usuarios, error } = await window.supabase
                                .from('user_profiles')
                                .select('id, nome, email, departamento, cargo')
                                .eq('active', true)
                                .order('nome');
                            
                            if (!error && usuarios) {
                                usuariosPlataforma = usuarios.map(u => ({
                                    id: u.id,
                                    nome: u.nome || u.email || 'Sem nome',
                                    email: u.email,
                                    departamento: u.departamento,
                                    cargo: u.cargo
                                }));
                                console.log('‚úÖ Usu√°rios carregados via Supabase:', usuariosPlataforma.length);
                                return;
                            }
                        } catch (supabaseError) {
                            console.warn('‚ö†Ô∏è Erro ao buscar usu√°rios via Supabase:', supabaseError);
                        }
                    }
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    usuariosPlataforma = data.usuarios || [];
                    console.log('‚úÖ Usu√°rios carregados:', usuariosPlataforma.length);
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao carregar usu√°rios:', error);
                // Continuar sem usu√°rios se houver erro
                usuariosPlataforma = [];
            }
        }
        
        // Carregar alertas ao iniciar
        async function carregarAlertas() {
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/ferramentas-qualidade/alertas', {
                    headers: headers,
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    // API n√£o dispon√≠vel, apenas ocultar badge
                    const badge = document.getElementById('badgeAlertas');
                    if (badge) badge.style.display = 'none';
                    return;
                }
                
                const data = await response.json();
                if (data.success && data.alertas) {
                    const alertasVencidos = data.alertas.filter(a => a.status === 'vencido' || a.status === 'em_alerta');
                    const badge = document.getElementById('badgeAlertas');
                    if (badge) {
                        if (alertasVencidos.length > 0) {
                            badge.textContent = alertasVencidos.length;
                            badge.style.display = 'inline-block';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è Erro ao carregar alertas:', error);
                // Ocultar badge em caso de erro
                const badge = document.getElementById('badgeAlertas');
                if (badge) badge.style.display = 'none';
            }
        }
        
        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', async () => {
            // Inicializar Supabase primeiro
            await inicializarSupabase();
            
            // Carregar usu√°rios (tentar√° API primeiro, depois Supabase direto)
            await carregarUsuarios();
            
            // Carregar alertas (n√£o cr√≠tico, apenas oculta badge se falhar)
            await carregarAlertas();
            setInterval(carregarAlertas, 60000);
            
            // Verificar se h√° ID na URL para carregar ferramenta
            const urlParams = new URLSearchParams(window.location.search);
            const ferramentaId = urlParams.get('id');
            if (ferramentaId) {
                console.log('üì• Carregando ferramenta da URL:', ferramentaId);
                await carregarFerramenta(ferramentaId);
            } else {
                // Comportamento normal: adicionar linha inicial do 5W2H
                adicionarLinha5W2H();
            }
            
            // Listener para aba de arquivos
            const tabArquivos = document.querySelector('[data-bs-target="#tab-arquivos"]');
            if (tabArquivos) {
                tabArquivos.addEventListener('shown.bs.tab', () => {
                    carregarFerramentasArquivadas();
                });
            }
            
            // Listener para aba de Plano de A√ß√£o - garantir que usu√°rios estejam carregados
            const tabPlanoAcao = document.querySelector('[data-bs-target="#tab-plano-acao"]');
            if (tabPlanoAcao) {
                tabPlanoAcao.addEventListener('shown.bs.tab', async () => {
                    // Se n√£o houver usu√°rios carregados, tentar recarregar
                    if (usuariosPlataforma.length === 0) {
                        console.log('üîÑ Recarregando usu√°rios ao abrir Plano de A√ß√£o...');
                        await carregarUsuarios();
                        // Re-renderizar a√ß√µes para atualizar os selects
                        if (acoesPlano.length > 0) {
                            renderizarAcoes();
                        }
                    }
                });
            }
            
            // Listener para aba de 5W2H - garantir que usu√°rios estejam carregados
            const tab5W2H = document.querySelector('[data-bs-target="#tab-5w2h"]');
            if (tab5W2H) {
                tab5W2H.addEventListener('shown.bs.tab', async () => {
                    // Se n√£o houver usu√°rios carregados, tentar recarregar
                    if (usuariosPlataforma.length === 0) {
                        console.log('üîÑ Recarregando usu√°rios ao abrir 5W2H...');
                        await carregarUsuarios();
                        // Re-renderizar linhas para atualizar os selects
                        if (linhas5W2H.length > 0) {
                            renderizarLinhas5W2H();
                        }
                    }
                });
            }
            
            // Permitir Enter no input de ideias
            const inputIdeia = document.getElementById('novaIdeia');
            if (inputIdeia) {
                inputIdeia.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        adicionarIdeia();
                    }
                });
            }
        });
        
        // Fun√ß√£o para formatar valor monet√°rio
        function formatarMoeda(inputId) {
            const input = document.getElementById(inputId);
            if (!input) return;
            
            let valor = input.value;
            if (!valor) return;
            
            // Remover caracteres n√£o num√©ricos exceto ponto e v√≠rgula
            valor = valor.toString().replace(/[^\d,.-]/g, '');
            
            // Converter v√≠rgula para ponto se necess√°rio
            valor = valor.replace(',', '.');
            
            // Garantir que seja um n√∫mero v√°lido
            const numValor = parseFloat(valor);
            if (isNaN(numValor)) {
                input.value = '';
                return;
            }
            
            // Atualizar o valor no input (mant√©m como n√∫mero para c√°lculos)
            input.value = numValor;
        }
        
        // Fun√ß√£o para formatar exibi√ß√£o de moeda
        function formatarExibicaoMoeda(valor) {
            if (!valor && valor !== 0) return '-';
            const numValor = parseFloat(valor.toString().replace(/[^\d,.-]/g, '').replace(',', '.'));
            if (isNaN(numValor)) return valor;
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(numValor);
        }
        
        // Fun√ß√£o para formatar data (vers√£o completa para 5W2H)
        function formatarData5W2H(data) {
            if (!data) return '-';
            try {
                // Se for uma string no formato YYYY-MM-DD (do input date), converter
                if (typeof data === 'string' && data.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const [ano, mes, dia] = data.split('-');
                    return `${dia}/${mes}/${ano}`;
                }
                const dataObj = new Date(data);
                if (isNaN(dataObj.getTime())) return data;
                return dataObj.toLocaleDateString('pt-BR');
            } catch (e) {
                return data;
            }
        }
        
        // Fun√ß√£o auxiliar para calcular dias restantes
        function calcularDiasRestantes(prazo) {
            if (!prazo) return null;
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            const prazoDate = new Date(prazo);
            prazoDate.setHours(0, 0, 0, 0);
            const diff = Math.floor((prazoDate - hoje) / (1000 * 60 * 60 * 24));
            return diff;
        }
        
        // Fun√ß√£o auxiliar para formatar status de prazo
        function formatarStatusPrazo(dias) {
            if (dias === null) return { texto: '-', classe: 'text-muted' };
            if (dias < 0) return { texto: `${Math.abs(dias)} dias atrasado`, classe: 'text-danger fw-bold' };
            if (dias === 0) return { texto: 'Vence hoje', classe: 'text-warning fw-bold' };
            if (dias <= 3) return { texto: `${dias} dias restantes`, classe: 'text-warning' };
            return { texto: `${dias} dias restantes`, classe: 'text-success' };
        }

        // ========== 5 PORQU√äS ==========
        function exportar5Porques() {
            const problema = document.getElementById('problema5porques').value;
            const porques = [
                document.getElementById('porque1').value,
                document.getElementById('porque2').value,
                document.getElementById('porque3').value,
                document.getElementById('porque4').value,
                document.getElementById('porque5').value
            ];
            const causaRaiz = document.getElementById('causaRaiz').value;
            
            const conteudo = `
                <h2>An√°lise 5 Porqu√™s</h2>
                <h3>Problema: ${problema}</h3>
                <ol>
                    ${porques.map((p, i) => `<li><strong>${i+1}¬∫ Por qu√™?</strong> ${p || 'N√£o preenchido'}</li>`).join('')}
                </ol>
                <h3>Causa Raiz Identificada:</h3>
                <p>${causaRaiz || 'N√£o identificada'}</p>
            `;
            
            imprimirConteudo(conteudo, 'An√°lise 5 Porqu√™s');
        }

        function limpar5Porques() {
            document.getElementById('titulo5porques').value = '';
            document.getElementById('problema5porques').value = '';
            document.getElementById('porque1').value = '';
            document.getElementById('porque2').value = '';
            document.getElementById('porque3').value = '';
            document.getElementById('porque4').value = '';
            document.getElementById('porque5').value = '';
            document.getElementById('causaRaiz').value = '';
            ferramentaAtualId = null;
        }
        
        async function salvar5Porques() {
            const titulo = document.getElementById('titulo5porques').value;
            const problema = document.getElementById('problema5porques').value;
            
            if (!titulo && !problema) {
                alert('Por favor, preencha pelo menos o t√≠tulo ou o problema.');
                return;
            }
            
            const dados = {
                problema: problema,
                porques: [
                    document.getElementById('porque1').value,
                    document.getElementById('porque2').value,
                    document.getElementById('porque3').value,
                    document.getElementById('porque4').value,
                    document.getElementById('porque5').value
                ],
                causa_raiz: document.getElementById('causaRaiz').value
            };
            
            const tituloFinal = titulo || `5 Porqu√™s: ${problema || 'Sem t√≠tulo'}`;
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/ferramentas-qualidade', {
                    method: 'POST',
                    headers: headers,
                    credentials: 'include',
                    body: JSON.stringify({
                        id: ferramentaAtualId,
                        tipo_ferramenta: '5porques',
                        titulo: tituloFinal,
                        dados: dados
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    ferramentaAtualId = data.ferramenta.id;
                    alert('‚úÖ 5 Porqu√™s salvo com sucesso!');
                } else {
                    alert('‚ùå Erro ao salvar: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('‚ùå Erro ao salvar 5 Porqu√™s:', error);
                alert('‚ùå Erro ao salvar 5 Porqu√™s: ' + error.message);
            }
        }

        // ========== 5W2H ==========
        function adicionarLinha5W2H() {
            const linha = {
                id: Date.now(),
                what: '',
                why: '',
                where: '',
                when: '',
                who: '',
                how: '',
                howMuch: '',
                howMany: ''
            };
            linhas5W2H.push(linha);
            renderizarLinhas5W2H();
        }
        
        function removerLinha5W2H(id) {
            linhas5W2H = linhas5W2H.filter(l => l.id !== id);
            renderizarLinhas5W2H();
        }
        
        function atualizarLinha5W2H(id, campo, valor) {
            const linha = linhas5W2H.find(l => l.id === id);
            if (linha) {
                linha[campo] = valor;
                
                // Se o campo for "who", sincronizar select e input
                if (campo === 'who') {
                    const selectElement = document.getElementById(`who-select-${id}`);
                    const inputElement = document.getElementById(`who-input-${id}`);
                    
                    // Se um usu√°rio foi selecionado no dropdown, limpar o input de texto
                    if (selectElement && selectElement.value === valor && usuariosPlataforma.find(u => u.id === valor)) {
                        if (inputElement) {
                            inputElement.value = '';
                        }
                    }
                    
                    // Se um texto foi digitado no input, limpar o select
                    if (inputElement && inputElement.value === valor && !usuariosPlataforma.find(u => u.id === valor)) {
                        if (selectElement) {
                            selectElement.value = '';
                        }
                    }
                }
            }
        }
        
        function renderizarLinhas5W2H() {
            const container = document.getElementById('linhas5w2h');
            container.innerHTML = '';
            
            linhas5W2H.forEach((linha, index) => {
                const div = document.createElement('div');
                div.className = 'card mb-3';
                div.innerHTML = `
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Linha ${index + 1}</strong>
                        <button class="btn btn-sm btn-danger" onclick="removerLinha5W2H(${linha.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label class="form-label small">O QU√ä (What)?</label>
                                <input type="text" class="form-control form-control-sm" 
                                       value="${linha.what || ''}" 
                                       onchange="atualizarLinha5W2H(${linha.id}, 'what', this.value)">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">POR QU√ä (Why)?</label>
                                <input type="text" class="form-control form-control-sm" 
                                       value="${linha.why || ''}" 
                                       onchange="atualizarLinha5W2H(${linha.id}, 'why', this.value)">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">ONDE (Where)?</label>
                                <input type="text" class="form-control form-control-sm" 
                                       value="${linha.where || ''}" 
                                       onchange="atualizarLinha5W2H(${linha.id}, 'where', this.value)">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">QUANDO (When)?</label>
                                <input type="date" class="form-control form-control-sm" 
                                       id="when-${linha.id}"
                                       value="${linha.when ? (typeof linha.when === 'string' && linha.when.match(/^\d{4}-\d{2}-\d{2}$/) ? linha.when : new Date(linha.when).toISOString().split('T')[0]) : ''}" 
                                       onchange="atualizarLinha5W2H(${linha.id}, 'when', this.value)">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">QUEM (Who)?</label>
                                <select class="form-select form-select-sm" 
                                        id="who-select-${linha.id}"
                                       onchange="atualizarLinha5W2H(${linha.id}, 'who', this.value)">
                                    <option value="">Selecione um usu√°rio...</option>
                                    ${usuariosPlataforma.map(u => `
                                        <option value="${u.id}" ${linha.who === u.id ? 'selected' : ''}>
                                            ${u.nome}${u.departamento ? ' - ' + u.departamento : ''}
                                        </option>
                                    `).join('')}
                                </select>
                                ${!linha.who || !usuariosPlataforma.find(u => u.id === linha.who) ? `
                                    <input type="text" class="form-control form-control-sm mt-1" 
                                           id="who-input-${linha.id}"
                                           value="${(linha.who && !usuariosPlataforma.find(u => u.id === linha.who) ? linha.who : '').replace(/"/g, "&quot;")}" 
                                           placeholder="Ou digite o nome do respons√°vel"
                                           onchange="atualizarLinha5W2H(${linha.id}, 'who', this.value)">
                                ` : ''}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">COMO (How)?</label>
                                <input type="text" class="form-control form-control-sm" 
                                       value="${linha.how || ''}" 
                                       onchange="atualizarLinha5W2H(${linha.id}, 'how', this.value)">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">QUANTO (How much)?</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" class="form-control" 
                                           id="howMuch-${linha.id}"
                                           step="0.01" 
                                           min="0" 
                                           placeholder="0,00"
                                           value="${linha.howMuch ? parseFloat(linha.howMuch.toString().replace(/[^\d,.-]/g, '').replace(',', '.')) || '' : ''}" 
                                           onchange="atualizarLinha5W2H(${linha.id}, 'howMuch', this.value)"
                                           onblur="formatarMoeda('howMuch-${linha.id}')">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">QUANTIDADE (How many)?</label>
                                <input type="number" class="form-control form-control-sm" 
                                       id="howMany-${linha.id}"
                                       step="1" 
                                       min="0" 
                                       placeholder="0"
                                       value="${linha.howMany || ''}" 
                                       onchange="atualizarLinha5W2H(${linha.id}, 'howMany', this.value)">
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        async function salvar5W2H() {
            const titulo = document.getElementById('titulo5w2h').value;
            if (!titulo) {
                alert('Por favor, preencha o t√≠tulo do 5W2H.');
                return;
            }
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/ferramentas-qualidade', {
                    method: 'POST',
                    headers: headers,
                    credentials: 'include',
                    body: JSON.stringify({
                        id: ferramentaAtualId,
                        tipo_ferramenta: '5w2h',
                        titulo: titulo,
                        dados: { linhas: linhas5W2H }
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    ferramentaAtualId = data.ferramenta.id;
                    alert('‚úÖ 5W2H salvo com sucesso!');
                } else {
                    alert('‚ùå Erro ao salvar: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('‚ùå Erro ao salvar 5W2H:', error);
                alert('‚ùå Erro ao salvar 5W2H.');
            }
        }
        
        function exportar5W2H() {
            const titulo = document.getElementById('titulo5w2h').value || 'An√°lise 5W2H';
            
            let htmlLinhas = linhas5W2H.map((linha, index) => `
                <tr>
                    <td><strong>Linha ${index + 1}</strong></td>
                    <td>${linha.what || '-'}</td>
                    <td>${linha.why || '-'}</td>
                    <td>${linha.where || '-'}</td>
                    <td>${formatarData5W2H(linha.when)}</td>
                    <td>${(linha.who && usuariosPlataforma.find(u => u.id === linha.who) ? usuariosPlataforma.find(u => u.id === linha.who).nome : linha.who) || '-'}</td>
                    <td>${linha.how || '-'}</td>
                    <td>${formatarExibicaoMoeda(linha.howMuch)}</td>
                    <td>${linha.howMany || '-'}</td>
                </tr>
            `).join('');
            
            const conteudo = `
                <h2>${titulo}</h2>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>O QU√ä</th>
                            <th>POR QU√ä</th>
                            <th>ONDE</th>
                            <th>QUANDO</th>
                            <th>QUEM</th>
                            <th>COMO</th>
                            <th>QUANTO</th>
                            <th>QUANTIDADE</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${htmlLinhas || '<tr><td colspan="9">Nenhuma linha cadastrada</td></tr>'}
                    </tbody>
                </table>
            `;
            
            imprimirConteudo(conteudo, titulo);
        }

        function limpar5W2H() {
            document.getElementById('titulo5w2h').value = '';
            linhas5W2H = [];
            ferramentaAtualId = null;
            renderizarLinhas5W2H();
            adicionarLinha5W2H();
        }

        // ========== ISHIKAWA ==========
        function visualizarIshikawa() {
            const problema = document.getElementById('problemaIshikawa').value;
            if (!problema) {
                alert('Por favor, preencha o problema primeiro.');
                return;
            }
            
            const container = document.getElementById('ishikawa-diagram-container');
            container.style.display = 'block';
            
            const svg = document.getElementById('ishikawa-svg');
            svg.innerHTML = '';
            
            const width = 1400;
            const height = 800;
            svg.setAttribute('width', width);
            svg.setAttribute('height', height);
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            
            // Fundo branco para o SVG
            const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            bg.setAttribute('width', width);
            bg.setAttribute('height', height);
            bg.setAttribute('fill', 'white');
            svg.appendChild(bg);
            
            const centerY = height / 2;
            const spineStartX = 200;
            const spineEndX = width - 120;
            
            // Desenhar espinha principal (horizontal da esquerda para direita)
            const spine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            spine.setAttribute('x1', spineStartX);
            spine.setAttribute('y1', centerY);
            spine.setAttribute('x2', spineEndX);
            spine.setAttribute('y2', centerY);
            spine.setAttribute('class', 'fishbone-spine');
            svg.appendChild(spine);
            
            // Desenhar cabe√ßa do peixe (forma mais realista com pol√≠gono)
            const headWidth = 160;
            const headHeight = 90;
            const headX = spineEndX;
            const headY = centerY - headHeight / 2;
            
            // Cabe√ßa do peixe em forma de losango/pol√≠gono
            const fishHead = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            const headPoints = [
                `${headX},${centerY}`, // Ponto na espinha (esquerda)
                `${headX + headWidth},${headY}`, // Topo direito
                `${headX + headWidth + 15},${centerY}`, // Ponto mais √† direita (boca)
                `${headX + headWidth},${headY + headHeight}` // Fundo direito
            ].join(' ');
            fishHead.setAttribute('points', headPoints);
            fishHead.setAttribute('class', 'fishbone-effect-box');
            svg.appendChild(fishHead);
            
            // Adicionar boca do peixe
            const mouth = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            const mouthPoints = [
                `${headX + headWidth + 15},${centerY}`,
                `${headX + headWidth + 25},${centerY - 8}`,
                `${headX + headWidth + 25},${centerY + 8}`
            ].join(' ');
            mouth.setAttribute('points', mouthPoints);
            mouth.setAttribute('fill', '#c0392b');
            mouth.setAttribute('stroke', '#a93226');
            mouth.setAttribute('stroke-width', '2');
            svg.appendChild(mouth);
            
            // Adicionar olho do peixe com destaque
            const eyeOuter = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            eyeOuter.setAttribute('cx', headX + headWidth - 25);
            eyeOuter.setAttribute('cy', centerY - 18);
            eyeOuter.setAttribute('r', 10);
            eyeOuter.setAttribute('fill', '#ffffff');
            eyeOuter.setAttribute('class', 'fishbone-eye');
            svg.appendChild(eyeOuter);
            
            const eyeInner = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            eyeInner.setAttribute('cx', headX + headWidth - 25);
            eyeInner.setAttribute('cy', centerY - 18);
            eyeInner.setAttribute('r', 6);
            eyeInner.setAttribute('fill', '#2c3e50');
            svg.appendChild(eyeInner);
            
            const eyePupil = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            eyePupil.setAttribute('cx', headX + headWidth - 25);
            eyePupil.setAttribute('cy', centerY - 18);
            eyePupil.setAttribute('r', 3);
            eyePupil.setAttribute('fill', '#000000');
            svg.appendChild(eyePupil);
            
            // Adicionar brilho no olho
            const eyeShine = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            eyeShine.setAttribute('cx', headX + headWidth - 23);
            eyeShine.setAttribute('cy', centerY - 20);
            eyeShine.setAttribute('r', 2);
            eyeShine.setAttribute('fill', '#ffffff');
            svg.appendChild(eyeShine);
            
            // Adicionar nadadeira superior
            const finTop = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            const finTopPoints = [
                `${headX + headWidth - 20},${headY}`,
                `${headX + headWidth - 5},${headY - 25}`,
                `${headX + headWidth + 10},${headY - 15}`
            ].join(' ');
            finTop.setAttribute('points', finTopPoints);
            finTop.setAttribute('class', 'fishbone-fin');
            svg.appendChild(finTop);
            
            // Adicionar nadadeira inferior
            const finBottom = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            const finBottomPoints = [
                `${headX + headWidth - 20},${headY + headHeight}`,
                `${headX + headWidth - 5},${headY + headHeight + 25}`,
                `${headX + headWidth + 10},${headY + headHeight + 15}`
            ].join(' ');
            finBottom.setAttribute('points', finBottomPoints);
            finBottom.setAttribute('class', 'fishbone-fin');
            svg.appendChild(finBottom);
            
            // Texto do problema dentro da cabe√ßa
            const textoEfeito = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            textoEfeito.setAttribute('x', headX + headWidth / 2 + 5);
            textoEfeito.setAttribute('y', centerY);
            textoEfeito.setAttribute('class', 'fishbone-effect-text');
            textoEfeito.setAttribute('text-anchor', 'middle');
            textoEfeito.setAttribute('dominant-baseline', 'middle');
            // Quebrar texto em m√∫ltiplas linhas se necess√°rio (ajustado para cabe√ßa maior)
            const palavras = problema.split(' ');
            let linhas = [];
            let linhaAtual = '';
            palavras.forEach(palavra => {
                if ((linhaAtual + palavra).length > 20) {
                    if (linhaAtual) linhas.push(linhaAtual);
                    linhaAtual = palavra;
                } else {
                    linhaAtual += (linhaAtual ? ' ' : '') + palavra;
                }
            });
            if (linhaAtual) linhas.push(linhaAtual);
            
            linhas.forEach((linha, i) => {
                const tspan = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
                tspan.setAttribute('x', headX + headWidth / 2 + 5);
                tspan.setAttribute('dy', i === 0 ? (linhas.length === 1 ? 0 : -8) : 18);
                tspan.textContent = linha;
                textoEfeito.appendChild(tspan);
            });
            svg.appendChild(textoEfeito);
            
            // Categorias organizadas em 3 de cada lado (superior e inferior)
            const categoriasSuperiores = [
                { nome: 'M√©todo', id: 'ishikawa-metodo', pos: 0 },
                { nome: 'M√£o de Obra', id: 'ishikawa-maoobra', pos: 1 },
                { nome: 'Material', id: 'ishikawa-material', pos: 2 }
            ];
            
            const categoriasInferiores = [
                { nome: 'M√°quina', id: 'ishikawa-maquina', pos: 0 },
                { nome: 'Meio Ambiente', id: 'ishikawa-meioambiente', pos: 1 },
                { nome: 'Medi√ß√£o', id: 'ishikawa-medicao', pos: 2 }
            ];
            
            const branchSpacing = (spineEndX - spineStartX) / 4;
            const branchLength = 200;
            
            // Fun√ß√£o para obter classe de categoria
            function getCategoriaClass(nome) {
                const mapa = {
                    'M√©todo': 'metodo',
                    'M√£o de Obra': 'maoobra',
                    'Material': 'material',
                    'M√°quina': 'maquina',
                    'Meio Ambiente': 'meioambiente',
                    'Medi√ß√£o': 'medicao'
                };
                return mapa[nome] || 'metodo';
            }
            
            // Fun√ß√£o para desenhar categoria
            function desenharCategoria(cat, branchX, branchY, isSuperior) {
                const categoriaClass = getCategoriaClass(cat.nome);
                
                // Desenhar ramo principal (vertical conectando √† espinha)
                const branch = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                branch.setAttribute('x1', branchX);
                branch.setAttribute('y1', branchY);
                branch.setAttribute('x2', branchX);
                branch.setAttribute('y2', centerY);
                branch.setAttribute('class', `fishbone-branch ${categoriaClass}`);
                svg.appendChild(branch);
                
                // Desenhar linha horizontal no final do ramo (perpendicular √† espinha)
                const branchEnd = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                branchEnd.setAttribute('x1', branchX - 130);
                branchEnd.setAttribute('y1', branchY);
                branchEnd.setAttribute('x2', branchX);
                branchEnd.setAttribute('y2', branchY);
                branchEnd.setAttribute('class', `fishbone-branch ${categoriaClass}`);
                svg.appendChild(branchEnd);
                
                // Caixa para categoria com cor espec√≠fica
                const categoryBox = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                categoryBox.setAttribute('x', branchX - 140);
                categoryBox.setAttribute('y', branchY - 17);
                categoryBox.setAttribute('width', 120);
                categoryBox.setAttribute('height', 34);
                categoryBox.setAttribute('class', `fishbone-category-box ${categoriaClass}`);
                svg.appendChild(categoryBox);
                
                // Texto da categoria
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', branchX - 80);
                label.setAttribute('y', branchY + 4);
                label.setAttribute('class', 'fishbone-category-text');
                label.setAttribute('text-anchor', 'middle');
                label.setAttribute('dominant-baseline', 'middle');
                label.textContent = cat.nome;
                svg.appendChild(label);
                
                // Causas (sub-ramos diagonais)
                const causas = document.getElementById(cat.id).value.split('\n').filter(c => c.trim());
                if (causas.length > 0) {
                    const causaSpacing = branchLength / (causas.length + 1);
                    
                causas.forEach((causa, i) => {
                        const causaY = centerY + (isSuperior ? -causaSpacing * (i + 1) : causaSpacing * (i + 1));
                        const causaX = branchX - 130;
                    
                        // Sub-ramo (linha diagonal conectando causa ao ramo horizontal)
                    const causaBranch = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        causaBranch.setAttribute('x1', causaX - 80);
                    causaBranch.setAttribute('y1', causaY);
                        causaBranch.setAttribute('x2', causaX);
                        causaBranch.setAttribute('y2', branchY);
                        causaBranch.setAttribute('class', 'fishbone-sub-branch');
                    svg.appendChild(causaBranch);
                    
                    // Texto da causa
                    const causaTexto = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        causaTexto.setAttribute('x', causaX - 90);
                    causaTexto.setAttribute('y', causaY);
                        causaTexto.setAttribute('class', 'fishbone-causa-text');
                    causaTexto.setAttribute('text-anchor', 'end');
                        causaTexto.setAttribute('dominant-baseline', 'middle');
                        // Quebrar texto longo
                        const textoCurto = causa.length > 25 ? causa.substring(0, 22) + '...' : causa;
                        causaTexto.textContent = textoCurto;
                    svg.appendChild(causaTexto);
                });
                }
            }
            
            // Adicionar seta na ponta da espinha (cauda do peixe)
            const tailArrow = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            const tailPoints = [
                `${spineStartX},${centerY}`,
                `${spineStartX - 20},${centerY - 15}`,
                `${spineStartX - 20},${centerY + 15}`
            ].join(' ');
            tailArrow.setAttribute('points', tailPoints);
            tailArrow.setAttribute('fill', '#2c3e50');
            tailArrow.setAttribute('stroke', '#1a252f');
            tailArrow.setAttribute('stroke-width', '2');
            svg.appendChild(tailArrow);
            
            // Desenhar categorias superiores (acima da espinha)
            categoriasSuperiores.forEach((cat, index) => {
                const branchX = spineStartX + (index + 1) * branchSpacing;
                const branchY = centerY - branchLength;
                desenharCategoria(cat, branchX, branchY, true);
            });
            
            // Desenhar categorias inferiores (abaixo da espinha)
            categoriasInferiores.forEach((cat, index) => {
                const branchX = spineStartX + (index + 1) * branchSpacing;
                const branchY = centerY + branchLength;
                desenharCategoria(cat, branchX, branchY, false);
            });
        }

        function exportarIshikawa() {
            const problema = document.getElementById('problemaIshikawa').value;
            const categorias = [
                { nome: 'M√©todo', id: 'ishikawa-metodo' },
                { nome: 'M√£o de Obra', id: 'ishikawa-maoobra' },
                { nome: 'Material', id: 'ishikawa-material' },
                { nome: 'M√°quina', id: 'ishikawa-maquina' },
                { nome: 'Meio Ambiente', id: 'ishikawa-meioambiente' },
                { nome: 'Medi√ß√£o', id: 'ishikawa-medicao' }
            ];
            
            let htmlCategorias = categorias.map(cat => {
                const causas = document.getElementById(cat.id).value.split('\n').filter(c => c.trim());
                return `
                    <tr>
                        <td><strong>${cat.nome}</strong></td>
                        <td>
                            <ul>
                                ${causas.map(c => `<li>${c}</li>`).join('')}
                            </ul>
                        </td>
                    </tr>
                `;
            }).join('');
            
            const conteudo = `
                <h2>Diagrama de Ishikawa</h2>
                <h3>Problema (Efeito): ${problema}</h3>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Categoria</th>
                            <th>Causas</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${htmlCategorias}
                    </tbody>
                </table>
            `;
            
            imprimirConteudo(conteudo, 'Diagrama de Ishikawa');
        }

        async function salvarIshikawa() {
            const titulo = document.getElementById('tituloIshikawa').value;
            const problema = document.getElementById('problemaIshikawa').value;
            
            if (!titulo && !problema) {
                alert('Por favor, preencha pelo menos o t√≠tulo ou o problema.');
                return;
            }
            
            const categorias = [
                { nome: 'M√©todo', id: 'ishikawa-metodo' },
                { nome: 'M√£o de Obra', id: 'ishikawa-maoobra' },
                { nome: 'Material', id: 'ishikawa-material' },
                { nome: 'M√°quina', id: 'ishikawa-maquina' },
                { nome: 'Meio Ambiente', id: 'ishikawa-meioambiente' },
                { nome: 'Medi√ß√£o', id: 'ishikawa-medicao' }
            ];
            
            const dados = {
                problema: problema,
                categorias: categorias.map(cat => ({
                    nome: cat.nome,
                    causas: document.getElementById(cat.id).value.split('\n').filter(c => c.trim())
                }))
            };
            
            const tituloFinal = titulo || `Diagrama de Ishikawa: ${problema || 'Sem t√≠tulo'}`;
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/ferramentas-qualidade', {
                    method: 'POST',
                    headers: headers,
                    credentials: 'include',
                    body: JSON.stringify({
                        id: ferramentaAtualId,
                        tipo_ferramenta: 'ishikawa',
                        titulo: tituloFinal,
                        dados: dados
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    ferramentaAtualId = data.ferramenta.id;
                    alert('‚úÖ Diagrama de Ishikawa salvo com sucesso!');
                } else {
                    alert('‚ùå Erro ao salvar: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('‚ùå Erro ao salvar diagrama de Ishikawa:', error);
                alert('‚ùå Erro ao salvar diagrama de Ishikawa: ' + error.message);
            }
        }

        function limparIshikawa() {
            document.getElementById('tituloIshikawa').value = '';
            document.getElementById('problemaIshikawa').value = '';
            ['ishikawa-metodo', 'ishikawa-maoobra', 'ishikawa-material', 'ishikawa-maquina', 'ishikawa-meioambiente', 'ishikawa-medicao'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('ishikawa-diagram-container').style.display = 'none';
            ferramentaAtualId = null;
        }

        // ========== PLANO DE A√á√ÉO ==========
        function escaparHtml(texto) {
            if (!texto) return '';
            const div = document.createElement('div');
            div.textContent = texto;
            return div.innerHTML;
        }
        
        function calcularDiasEntreDatas(dataInicio, dataFim) {
            if (!dataInicio || !dataFim) return null;
            const inicio = new Date(dataInicio);
            const fim = new Date(dataFim);
            inicio.setHours(0, 0, 0, 0);
            fim.setHours(0, 0, 0, 0);
            const diff = Math.floor((fim - inicio) / (1000 * 60 * 60 * 24));
            return diff;
        }
        
        function formatarData(data) {
            if (!data) return '-';
            const d = new Date(data);
            const dia = String(d.getDate()).padStart(2, '0');
            const mes = String(d.getMonth() + 1).padStart(2, '0');
            return `${dia}-${mes}`;
        }
        
        function adicionarAcao() {
            const acao = {
                id: Date.now().toString(),
                descricao: '',
                gestor_imediato: '',
                responsavel_id: '',
                prioridade: 'M√âDIA',
                progresso: 0,
                inicio: '',
                revisao: '',
                finalizacao: '',
                status: 'PENDENTE',
                obs: '',
                acao_contingencia: ''
            };
            
            acoesPlano.push(acao);
            renderizarAcoes();
            atualizarAlertasPlano();
        }

        function removerAcao(id) {
            acoesPlano = acoesPlano.filter(a => a.id !== id);
            renderizarAcoes();
            atualizarAlertasPlano();
        }

        function atualizarAcao(id, campo, valor) {
            const acao = acoesPlano.find(a => a.id === id);
            if (acao) {
                acao[campo] = valor;
                if (campo === 'progresso') {
                    acao.progresso = parseInt(valor) || 0;
                }
                renderizarAcoes();
                atualizarAlertasPlano();
            }
        }

        function renderizarAcoes() {
            const container = document.getElementById('listaAcoes');
            container.innerHTML = '';
            
            if (acoesPlano.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-5"><i class="fas fa-tasks fa-3x mb-3"></i><p>Nenhuma a√ß√£o cadastrada. Clique em "Adicionar A√ß√£o" para come√ßar.</p></div>';
                return;
            }
            
            acoesPlano.forEach((acao, index) => {
                const dias = calcularDiasEntreDatas(acao.inicio, acao.finalizacao);
                const responsavelNome = usuariosPlataforma.find(u => u.id === acao.responsavel_id)?.nome || acao.responsavel_id || '';
                const statusClass = acao.status === 'FINALIZADO' ? 'success' : acao.status === 'EM ANDAMENTO' ? 'warning' : 'secondary';
                const prioridadeClass = acao.prioridade === 'ALTA' ? 'alta' : acao.prioridade === 'M√âDIA' ? 'media' : 'baixa';
                const finalizadoClass = acao.status === 'FINALIZADO' ? 'finalizado' : '';
                
                const card = document.createElement('div');
                card.className = `acao-card prioridade-${prioridadeClass} ${finalizadoClass}`;
                card.innerHTML = `
                    <div class="acao-header">
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-secondary">#${index + 1}</span>
                            <span class="badge bg-${statusClass} badge-status">${acao.status || 'PENDENTE'}</span>
                            <span class="badge bg-${acao.prioridade === 'ALTA' ? 'danger' : acao.prioridade === 'M√âDIA' ? 'warning' : 'info'}">${acao.prioridade || 'M√âDIA'}</span>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="removerAcao('${acao.id}')" title="Remover a√ß√£o">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    <div class="acao-descricao">
                        <label class="form-label fw-bold">A√á√ÉO</label>
                        <textarea class="form-control" rows="2" 
                                  placeholder="Descreva a a√ß√£o a ser realizada..." 
                                  onchange="atualizarAcao('${acao.id}', 'descricao', this.value)">${(acao.descricao || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;")}</textarea>
                    </div>
                    
                    <div class="acao-info-grid">
                        <div class="acao-info-item">
                            <label>GESTOR IMEDIATO</label>
                            <input type="text" class="form-control" 
                                   value="${(acao.gestor_imediato || '').replace(/"/g, "&quot;")}" 
                                   placeholder="Nome do gestor"
                                   onchange="atualizarAcao('${acao.id}', 'gestor_imediato', this.value)">
                        </div>
                        
                        <div class="acao-info-item">
                            <label>RESPONS√ÅVEL</label>
                            <select class="form-select" 
                                    onchange="atualizarAcao('${acao.id}', 'responsavel_id', this.value)">
                                <option value="">Selecione ou digite abaixo...</option>
                                ${usuariosPlataforma.map(u => `
                                    <option value="${u.id}" ${acao.responsavel_id === u.id ? 'selected' : ''}>
                                        ${u.nome}${u.departamento ? ' - ' + u.departamento : ''}
                                    </option>
                                `).join('')}
                            </select>
                            ${!acao.responsavel_id || !usuariosPlataforma.find(u => u.id === acao.responsavel_id) ? `
                                <input type="text" class="form-control mt-1" 
                                       value="${(acao.responsavel_id && !usuariosPlataforma.find(u => u.id === acao.responsavel_id) ? acao.responsavel_id : '').replace(/"/g, "&quot;")}" 
                                       placeholder="Ou digite o nome do respons√°vel"
                                       onchange="atualizarAcao('${acao.id}', 'responsavel_id', this.value)">
                            ` : ''}
                        </div>
                        
                        <div class="acao-info-item">
                            <label>PRIORIDADE</label>
                            <select class="form-select" 
                                    onchange="atualizarAcao('${acao.id}', 'prioridade', this.value)">
                                <option value="BAIXA" ${acao.prioridade === 'BAIXA' ? 'selected' : ''}>BAIXA</option>
                                <option value="M√âDIA" ${acao.prioridade === 'M√âDIA' ? 'selected' : ''}>M√âDIA</option>
                                <option value="ALTA" ${acao.prioridade === 'ALTA' ? 'selected' : ''}>ALTA</option>
                            </select>
                        </div>
                        
                        <div class="acao-info-item">
                            <label>PROGRESSO</label>
                            <div class="progress-container">
                                <input type="number" class="form-control" min="0" max="100" 
                                       value="${acao.progresso || 0}" 
                                       onchange="atualizarAcao('${acao.id}', 'progresso', this.value)">
                                <span>%</span>
                                <div class="progress">
                                    <div class="progress-bar ${acao.progresso >= 100 ? 'bg-success' : acao.progresso >= 50 ? 'bg-warning' : 'bg-info'}" 
                                         role="progressbar" style="width: ${acao.progresso || 0}%">
                                        ${acao.progresso || 0}%
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="acao-info-item">
                            <label>√çNICIO</label>
                            <input type="date" class="form-control" 
                                   value="${acao.inicio || ''}" 
                                   onchange="atualizarAcao('${acao.id}', 'inicio', this.value)">
                        </div>
                        
                        <div class="acao-info-item">
                            <label>REVIS√ÉO</label>
                            <input type="date" class="form-control" 
                                   value="${acao.revisao || ''}" 
                                   onchange="atualizarAcao('${acao.id}', 'revisao', this.value)">
                        </div>
                        
                        <div class="acao-info-item">
                            <label>FINALIZA√á√ÉO</label>
                            <input type="date" class="form-control" 
                                   value="${acao.finalizacao || ''}" 
                                   onchange="atualizarAcao('${acao.id}', 'finalizacao', this.value)">
                        </div>
                        
                        <div class="acao-info-item">
                            <label>DIAS</label>
                            <input type="text" class="form-control" 
                                   value="${dias !== null ? dias + ' dias' : '-'}" 
                                   readonly 
                                   style="background: #f8f9fa;">
                        </div>
                        
                        <div class="acao-info-item">
                            <label>STATUS</label>
                            <select class="form-select" 
                                    onchange="atualizarAcao('${acao.id}', 'status', this.value)">
                                <option value="PENDENTE" ${acao.status === 'PENDENTE' ? 'selected' : ''}>PENDENTE</option>
                                <option value="EM ANDAMENTO" ${acao.status === 'EM ANDAMENTO' ? 'selected' : ''}>EM ANDAMENTO</option>
                                <option value="FINALIZADO" ${acao.status === 'FINALIZADO' ? 'selected' : ''}>FINALIZADO</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label class="form-label fw-bold">OBS</label>
                            <textarea class="form-control" rows="2" 
                                      placeholder="Observa√ß√µes adicionais..." 
                                      onchange="atualizarAcao('${acao.id}', 'obs', this.value)">${(acao.obs || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;")}</textarea>
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="form-label fw-bold">A√á√ÉO DE CONTING√äNCIA</label>
                            <textarea class="form-control" rows="2" 
                                      placeholder="Descreva a a√ß√£o de conting√™ncia..." 
                                      onchange="atualizarAcao('${acao.id}', 'acao_contingencia', this.value)">${(acao.acao_contingencia || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;")}</textarea>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        function atualizarAlertasPlano() {
            const alertasContainer = document.getElementById('listaAlertasPlano');
            const alertasDiv = document.getElementById('alertasPlano');
            if (!alertasContainer || !alertasDiv) return;
            
            const alertas = acoesPlano
                .filter(a => a.finalizacao && a.responsavel_id)
                .map(a => {
                    const dias = calcularDiasRestantes(a.finalizacao);
                    const responsavel = usuariosPlataforma.find(u => u.id === a.responsavel_id);
                    return { ...a, dias, responsavel };
                })
                .filter(a => a.dias !== null && (a.dias < 0 || a.dias <= 3));
            
            if (alertas.length === 0) {
                alertasDiv.style.display = 'none';
                return;
            }
            
            alertasDiv.style.display = 'block';
            alertasContainer.innerHTML = alertas.map(a => {
                const status = formatarStatusPrazo(a.dias);
                return `
                    <div class="alert alert-${a.dias < 0 ? 'danger' : 'warning'} mb-2 py-2">
                        <strong>${a.descricao || 'A√ß√£o sem descri√ß√£o'}</strong> - 
                        Respons√°vel: ${a.responsavel?.nome || a.responsavel_id || 'N√£o definido'} - 
                        <span class="${status.classe}">${status.texto}</span>
                    </div>
                `;
            }).join('');
        }
        
        async function salvarPlanoAcao() {
            const titulo = document.getElementById('tituloPlano').value;
            const objetivo = document.getElementById('objetivoPlano').value;
            
            if (!titulo) {
                alert('Por favor, preencha o t√≠tulo do plano de a√ß√£o.');
                return;
            }
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/ferramentas-qualidade', {
                    method: 'POST',
                    headers: headers,
                    credentials: 'include',
                    body: JSON.stringify({
                        id: ferramentaAtualId,
                        tipo_ferramenta: 'plano_acao',
                        titulo: titulo,
                        dados: {
                            objetivo: objetivo,
                            acoes: acoesPlano.map(a => ({
                                id: a.id,
                                descricao: a.descricao,
                                gestor_imediato: a.gestor_imediato,
                                responsavel_id: a.responsavel_id,
                                prioridade: a.prioridade,
                                progresso: a.progresso,
                                inicio: a.inicio,
                                revisao: a.revisao,
                                finalizacao: a.finalizacao,
                                status: a.status,
                                obs: a.obs,
                                acao_contingencia: a.acao_contingencia
                            }))
                        }
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå Erro na resposta da API:', response.status, errorText);
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                if (data.success) {
                    ferramentaAtualId = data.ferramenta.id;
                    alert('‚úÖ Plano de A√ß√£o salvo com sucesso!');
                    // Tentar recarregar alertas (n√£o cr√≠tico se falhar)
                    try {
                        await carregarAlertas();
                    } catch (alertError) {
                        console.warn('‚ö†Ô∏è Erro ao recarregar alertas:', alertError);
                    }
                } else {
                    alert('‚ùå Erro ao salvar: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('‚ùå Erro ao salvar plano de a√ß√£o:', error);
                alert('‚ùå Erro ao salvar plano de a√ß√£o: ' + error.message + '\n\nVerifique se o servidor est√° rodando e se voc√™ est√° autenticado.');
            }
        }

        function exportarPlanoAcao() {
            const titulo = document.getElementById('tituloPlano').value || 'Plano de A√ß√£o';
            const objetivo = document.getElementById('objetivoPlano').value;
            
            let htmlAcoes = acoesPlano.map((acao, index) => {
                const responsavel = usuariosPlataforma.find(u => u.id === acao.responsavel_id);
                const dias = calcularDiasEntreDatas(acao.inicio, acao.finalizacao);
                return `
                    <tr>
                        <td>${acao.descricao || '-'}</td>
                        <td>${acao.gestor_imediato || '-'}</td>
                        <td>${responsavel?.nome || acao.responsavel_id || '-'}</td>
                        <td>${acao.prioridade || '-'}</td>
                        <td>${acao.progresso || 0}%</td>
                        <td>${formatarData(acao.inicio)}</td>
                        <td>${formatarData(acao.revisao)}</td>
                        <td>${formatarData(acao.finalizacao)}</td>
                        <td>${dias !== null ? dias : '-'}</td>
                        <td>${acao.status || '-'}</td>
                        <td>${acao.obs || '-'}</td>
                        <td>${acao.acao_contingencia || '-'}</td>
                    </tr>
                `;
            }).join('');
            
            const conteudo = `
                <h2>${titulo}</h2>
                <h3>Objetivo:</h3>
                <p>${objetivo || '-'}</p>
                <table class="table table-bordered" style="font-size: 10px;">
                    <thead>
                        <tr>
                            <th>A√á√ÉO</th>
                            <th>GESTOR IMEDIATO</th>
                            <th>RESPONS√ÅVEL</th>
                            <th>PRIORIDADE</th>
                            <th>PROGRESSO</th>
                            <th>√çNICIO</th>
                            <th>REVIS√ÉO</th>
                            <th>FINALIZA√á√ÉO</th>
                            <th>DIAS</th>
                            <th>STATUS</th>
                            <th>OBS</th>
                            <th>A√á√ÉO DE CONTING√äNCIA</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${htmlAcoes || '<tr><td colspan="12">Nenhuma a√ß√£o cadastrada</td></tr>'}
                    </tbody>
                </table>
            `;
            
            imprimirConteudo(conteudo, titulo);
        }

        function limparPlanoAcao() {
            document.getElementById('tituloPlano').value = '';
            document.getElementById('objetivoPlano').value = '';
            acoesPlano = [];
            ferramentaAtualId = null;
            renderizarAcoes();
            atualizarAlertasPlano();
        }
        
        // ========== ARQUIVOS ==========
        async function carregarFerramentasArquivadas() {
            const container = document.getElementById('listaFerramentasArquivadas');
            const tipo = document.getElementById('filtroTipoArquivo').value;
            const arquivado = document.getElementById('filtroArquivado').value;
            
            container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div></div>';
            
            try {
                let url = '/api/ferramentas-qualidade?';
                if (tipo) url += `tipo=${tipo}&`;
                if (arquivado !== '') url += `arquivado=${arquivado}`;
                
                const response = await fetch(url, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    const ferramentas = data.ferramentas || [];
                    
                    if (ferramentas.length === 0) {
                        container.innerHTML = '<div class="alert alert-info">Nenhuma ferramenta encontrada.</div>';
                        return;
                    }
                    
                    const tiposNome = {
                        '5porques': '5 Porqu√™s',
                        '5w2h': '5W2H',
                        'ishikawa': 'Ishikawa',
                        'plano_acao': 'Plano de A√ß√£o',
                        'pdca': 'PDCA',
                        'brainstorm': 'Brainstorming'
                    };
                    
                    container.innerHTML = ferramentas.map(f => {
                        const dataCriacao = new Date(f.criado_em).toLocaleDateString('pt-BR');
                        const temAlerta = f.tem_prazos && f.proximo_vencimento && 
                            new Date(f.proximo_vencimento) <= new Date();
                        
                        return `
                            <div class="card mb-3 ${f.arquivado ? 'border-secondary' : temAlerta ? 'border-warning' : ''}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h5 class="card-title">
                                                ${f.titulo}
                                                ${f.arquivado ? '<span class="badge bg-secondary ms-2">Arquivado</span>' : ''}
                                                ${temAlerta ? '<span class="badge bg-warning ms-2">Prazo pr√≥ximo</span>' : ''}
                                            </h5>
                                            <p class="text-muted mb-2">
                                                <strong>Tipo:</strong> ${tiposNome[f.tipo_ferramenta] || f.tipo_ferramenta} | 
                                                <strong>Criado em:</strong> ${dataCriacao}
                                            </p>
                                        </div>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-primary" onclick="carregarFerramenta('${f.id}')">
                                                <i class="fas fa-edit"></i> Editar
                                            </button>
                                            <button class="btn btn-sm btn-${f.arquivado ? 'success' : 'secondary'}" 
                                                    onclick="arquivarFerramenta('${f.id}', ${!f.arquivado})">
                                                <i class="fas fa-${f.arquivado ? 'folder-open' : 'archive'}"></i> 
                                                ${f.arquivado ? 'Desarquivar' : 'Arquivar'}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div class="alert alert-danger">Erro ao carregar ferramentas.</div>';
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar ferramentas:', error);
                container.innerHTML = '<div class="alert alert-danger">Erro ao carregar ferramentas.</div>';
            }
        }
        
        async function carregarFerramenta(id) {
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`/api/ferramentas-qualidade/${id}`, {
                    headers: headers,
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    const f = data.ferramenta;
                    ferramentaAtualId = f.id;
                    
                    if (f.tipo_ferramenta === '5w2h') {
                        document.getElementById('titulo5w2h').value = f.titulo || '';
                        linhas5W2H = f.dados?.linhas || [];
                        // Garantir que usu√°rios estejam carregados antes de renderizar
                        if (usuariosPlataforma.length === 0) {
                            await carregarUsuarios();
                        }
                        renderizarLinhas5W2H();
                        const tab5w2h = document.querySelector('[data-bs-target="#tab-5w2h"]');
                        if (tab5w2h) tab5w2h.click();
                    } else if (f.tipo_ferramenta === '5porques') {
                        // Extrair t√≠tulo (remover prefixo "5 Porqu√™s: " se existir)
                        const titulo = f.titulo?.replace(/^5 Porqu√™s:\s*/i, '') || '';
                        document.getElementById('titulo5porques').value = titulo;
                        document.getElementById('problema5porques').value = f.dados?.problema || '';
                        if (f.dados?.porques) {
                            f.dados.porques.forEach((porque, index) => {
                                const campo = document.getElementById(`porque${index + 1}`);
                                if (campo) campo.value = porque || '';
                            });
                        }
                        document.getElementById('causaRaiz').value = f.dados?.causa_raiz || '';
                        const tab5Porques = document.querySelector('[data-bs-target="#tab-5porques"]');
                        if (tab5Porques) tab5Porques.click();
                    } else if (f.tipo_ferramenta === 'pdca') {
                        // Extrair t√≠tulo (remover prefixo "PDCA: " se existir)
                        const titulo = f.titulo?.replace(/^PDCA:\s*/i, '') || '';
                        document.getElementById('tituloPDCA').value = titulo;
                        if (f.dados) {
                            document.getElementById('pdca-problema').value = f.dados.problema || '';
                            document.getElementById('pdca-objetivo').value = f.dados.objetivo || '';
                            document.getElementById('pdca-plano').value = f.dados.plano || '';
                            document.getElementById('pdca-executado').value = f.dados.executado || '';
                            document.getElementById('pdca-dificuldades').value = f.dados.dificuldades || '';
                            document.getElementById('pdca-resultados').value = f.dados.resultados || '';
                            document.getElementById('pdca-comparacao').value = f.dados.comparacao || '';
                            document.getElementById('pdca-padronizacao').value = f.dados.padronizacao || '';
                            document.getElementById('pdca-proximos').value = f.dados.proximos || '';
                            document.getElementById('pdca-proximo-ciclo').value = f.dados.proximoCiclo || '';
                        }
                        const tabPDCA = document.querySelector('[data-bs-target="#tab-pdca"]');
                        if (tabPDCA) tabPDCA.click();
                    } else if (f.tipo_ferramenta === 'brainstorm') {
                        // Extrair t√≠tulo (remover prefixo "Brainstorming: " se existir)
                        const titulo = f.titulo?.replace(/^Brainstorming:\s*/i, '') || '';
                        document.getElementById('temaBrainstorm').value = f.dados?.tema || titulo || '';
                        document.getElementById('objetivoBrainstorm').value = f.dados?.objetivo || '';
                        ideiasBrainstorm = f.dados?.ideias || [];
                        ideiasSelecionadas = f.dados?.ideias_selecionadas || [];
                        renderizarIdeias();
                        renderizarIdeiasSelecionadas();
                        const tabBrainstorm = document.querySelector('[data-bs-target="#tab-brainstorm"]');
                        if (tabBrainstorm) tabBrainstorm.click();
                    } else if (f.tipo_ferramenta === 'ishikawa') {
                        // Extrair t√≠tulo (remover prefixo "Diagrama de Ishikawa: " se existir)
                        const titulo = f.titulo?.replace(/^Diagrama de Ishikawa:\s*/i, '') || '';
                        document.getElementById('tituloIshikawa').value = titulo;
                        document.getElementById('problemaIshikawa').value = f.dados?.problema || '';
                        if (f.dados?.categorias) {
                            // Mapear nomes das categorias para IDs dos campos
                            const mapeamentoCategorias = {
                                'M√©todo': 'ishikawa-metodo',
                                'M√£o de Obra': 'ishikawa-maoobra',
                                'Material': 'ishikawa-material',
                                'M√°quina': 'ishikawa-maquina',
                                'Meio Ambiente': 'ishikawa-meioambiente',
                                'Medi√ß√£o': 'ishikawa-medicao'
                            };
                            
                            f.dados.categorias.forEach(cat => {
                                const campoId = mapeamentoCategorias[cat.nome];
                                if (campoId) {
                                    const campo = document.getElementById(campoId);
                                    if (campo) {
                                        campo.value = cat.causas?.join('\n') || '';
                                    }
                                }
                            });
                        }
                        // Visualizar automaticamente se houver problema
                        if (f.dados?.problema) {
                            visualizarIshikawa();
                        }
                        const tabIshikawa = document.querySelector('[data-bs-target="#tab-ishikawa"]');
                        if (tabIshikawa) tabIshikawa.click();
                    } else if (f.tipo_ferramenta === 'plano_acao') {
                        document.getElementById('tituloPlano').value = f.titulo || '';
                        document.getElementById('objetivoPlano').value = f.dados?.objetivo || '';
                        acoesPlano = f.dados?.acoes || [];
                        renderizarAcoes();
                        atualizarAlertasPlano();
                        const tabPlano = document.querySelector('[data-bs-target="#tab-plano-acao"]');
                        if (tabPlano) tabPlano.click();
                    }
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar ferramenta:', error);
                alert('Erro ao carregar ferramenta.');
            }
        }
        
        async function arquivarFerramenta(id, arquivar) {
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`/api/ferramentas-qualidade/${id}/arquivar`, {
                    method: 'PUT',
                    headers: headers,
                    credentials: 'include',
                    body: JSON.stringify({ arquivado: arquivar })
                });
                
                const data = await response.json();
                if (data.success) {
                    carregarFerramentasArquivadas();
                } else {
                    alert('Erro ao arquivar ferramenta.');
                }
            } catch (error) {
                console.error('‚ùå Erro ao arquivar ferramenta:', error);
                alert('Erro ao arquivar ferramenta.');
            }
        }

        // ========== PDCA ==========
        function exportarPDCA() {
            const dados = {
                problema: document.getElementById('pdca-problema').value,
                objetivo: document.getElementById('pdca-objetivo').value,
                plano: document.getElementById('pdca-plano').value,
                executado: document.getElementById('pdca-executado').value,
                dificuldades: document.getElementById('pdca-dificuldades').value,
                resultados: document.getElementById('pdca-resultados').value,
                comparacao: document.getElementById('pdca-comparacao').value,
                padronizacao: document.getElementById('pdca-padronizacao').value,
                proximos: document.getElementById('pdca-proximos').value,
                proximoCiclo: document.getElementById('pdca-proximo-ciclo').value
            };
            
            const conteudo = `
                <h2>Ciclo PDCA</h2>
                <div style="border: 2px solid #007bff; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #007bff;">PLAN - Planejar</h3>
                    <p><strong>Problema/Oportunidade:</strong> ${dados.problema || '-'}</p>
                    <p><strong>Objetivo:</strong> ${dados.objetivo || '-'}</p>
                    <p><strong>Plano de A√ß√£o:</strong> ${dados.plano || '-'}</p>
                </div>
                <div style="border: 2px solid #28a745; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #28a745;">DO - Executar</h3>
                    <p><strong>O que foi executado:</strong> ${dados.executado || '-'}</p>
                    <p><strong>Dificuldades encontradas:</strong> ${dados.dificuldades || '-'}</p>
                </div>
                <div style="border: 2px solid #ffc107; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #856404;">CHECK - Verificar</h3>
                    <p><strong>Resultados obtidos:</strong> ${dados.resultados || '-'}</p>
                    <p><strong>Compara√ß√£o com objetivo:</strong> ${dados.comparacao || '-'}</p>
                </div>
                <div style="border: 2px solid #dc3545; padding: 20px;">
                    <h3 style="color: #dc3545;">ACT - Agir</h3>
                    <p><strong>Padroniza√ß√£o:</strong> ${dados.padronizacao || '-'}</p>
                    <p><strong>Pr√≥ximos passos:</strong> ${dados.proximos || '-'}</p>
                    <p><strong>Pr√≥ximo ciclo PDCA:</strong> ${dados.proximoCiclo || '-'}</p>
                </div>
            `;
            
            imprimirConteudo(conteudo, 'Ciclo PDCA');
        }

        function limparPDCA() {
            document.getElementById('tituloPDCA').value = '';
            ['pdca-problema', 'pdca-objetivo', 'pdca-plano', 'pdca-executado', 'pdca-dificuldades', 
             'pdca-resultados', 'pdca-comparacao', 'pdca-padronizacao', 'pdca-proximos', 'pdca-proximo-ciclo'].forEach(id => {
                document.getElementById(id).value = '';
            });
            ferramentaAtualId = null;
        }
        
        async function salvarPDCA() {
            const titulo = document.getElementById('tituloPDCA').value;
            const dados = {
                problema: document.getElementById('pdca-problema').value,
                objetivo: document.getElementById('pdca-objetivo').value,
                plano: document.getElementById('pdca-plano').value,
                executado: document.getElementById('pdca-executado').value,
                dificuldades: document.getElementById('pdca-dificuldades').value,
                resultados: document.getElementById('pdca-resultados').value,
                comparacao: document.getElementById('pdca-comparacao').value,
                padronizacao: document.getElementById('pdca-padronizacao').value,
                proximos: document.getElementById('pdca-proximos').value,
                proximoCiclo: document.getElementById('pdca-proximo-ciclo').value
            };
            
            if (!titulo && !dados.problema) {
                alert('Por favor, preencha pelo menos o t√≠tulo ou o problema.');
                return;
            }
            
            const tituloFinal = titulo || `PDCA: ${dados.problema || 'Sem t√≠tulo'}`;
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/ferramentas-qualidade', {
                    method: 'POST',
                    headers: headers,
                    credentials: 'include',
                    body: JSON.stringify({
                        id: ferramentaAtualId,
                        tipo_ferramenta: 'pdca',
                        titulo: tituloFinal,
                        dados: dados
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    ferramentaAtualId = data.ferramenta.id;
                    alert('‚úÖ PDCA salvo com sucesso!');
                } else {
                    alert('‚ùå Erro ao salvar: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('‚ùå Erro ao salvar PDCA:', error);
                alert('‚ùå Erro ao salvar PDCA: ' + error.message);
            }
        }

        // ========== BRAINSTORMING ==========
        function adicionarIdeia() {
            const input = document.getElementById('novaIdeia');
            const ideia = input.value.trim();
            
            if (!ideia) {
                alert('Por favor, digite uma ideia.');
                return;
            }
            
            ideiasBrainstorm.push({
                id: Date.now(),
                texto: ideia
            });
            
            input.value = '';
            renderizarIdeias();
        }

        function removerIdeia(id) {
            ideiasBrainstorm = ideiasBrainstorm.filter(i => i.id !== id);
            ideiasSelecionadas = ideiasSelecionadas.filter(i => i !== id);
            renderizarIdeias();
            renderizarIdeiasSelecionadas();
        }

        function selecionarIdeia(id) {
            if (ideiasSelecionadas.includes(id)) {
                ideiasSelecionadas = ideiasSelecionadas.filter(i => i !== id);
            } else {
                if (ideiasSelecionadas.length < 5) {
                    ideiasSelecionadas.push(id);
                } else {
                    alert('Voc√™ pode selecionar no m√°ximo 5 ideias.');
                    return;
                }
            }
            renderizarIdeias();
            renderizarIdeiasSelecionadas();
        }

        function renderizarIdeias() {
            const container = document.getElementById('listaIdeias');
            container.innerHTML = '';
            
            ideiasBrainstorm.forEach(ideia => {
                const isSelected = ideiasSelecionadas.includes(ideia.id);
                const div = document.createElement('div');
                div.className = 'col-md-4';
                div.innerHTML = `
                    <div class="card ${isSelected ? 'border-primary bg-primary text-white' : ''}" style="cursor: pointer;" onclick="selecionarIdeia(${ideia.id})">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>${ideia.texto}</span>
                                ${isSelected ? '<i class="fas fa-check-circle"></i>' : ''}
                            </div>
                            <button class="btn btn-sm btn-danger mt-2" onclick="event.stopPropagation(); removerIdeia(${ideia.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function renderizarIdeiasSelecionadas() {
            const container = document.getElementById('ideiasSelecionadas');
            container.innerHTML = '';
            
            ideiasSelecionadas.forEach(id => {
                const ideia = ideiasBrainstorm.find(i => i.id === id);
                if (ideia) {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.textContent = ideia.texto;
                    container.appendChild(li);
                }
            });
        }

        function exportarBrainstorm() {
            const tema = document.getElementById('temaBrainstorm').value;
            const objetivo = document.getElementById('objetivoBrainstorm').value;
            
            let htmlIdeias = ideiasBrainstorm.map((ideia, index) => {
                const isSelected = ideiasSelecionadas.includes(ideia.id);
                return `<li>${ideia.texto} ${isSelected ? '<strong>(Selecionada)</strong>' : ''}</li>`;
            }).join('');
            
            let htmlSelecionadas = ideiasSelecionadas.map(id => {
                const ideia = ideiasBrainstorm.find(i => i.id === id);
                return ideia ? `<li>${ideia.texto}</li>` : '';
            }).join('');
            
            const conteudo = `
                <h2>Brainstorming</h2>
                <p><strong>Tema/Problema:</strong> ${tema || '-'}</p>
                <p><strong>Objetivo:</strong> ${objetivo || '-'}</p>
                <h3>Todas as Ideias (${ideiasBrainstorm.length}):</h3>
                <ul>${htmlIdeias || '<li>Nenhuma ideia registrada</li>'}</ul>
                <h3>Top 5 Ideias Selecionadas:</h3>
                <ol>${htmlSelecionadas || '<li>Nenhuma ideia selecionada</li>'}</ol>
            `;
            
            imprimirConteudo(conteudo, 'Brainstorming');
        }

        function limparBrainstorm() {
            document.getElementById('temaBrainstorm').value = '';
            document.getElementById('objetivoBrainstorm').value = '';
            ideiasBrainstorm = [];
            ideiasSelecionadas = [];
            ferramentaAtualId = null;
            renderizarIdeias();
            renderizarIdeiasSelecionadas();
        }
        
        async function salvarBrainstorm() {
            const tema = document.getElementById('temaBrainstorm').value;
            
            if (!tema) {
                alert('Por favor, preencha o tema/problema.');
                return;
            }
            
            const dados = {
                tema: tema,
                objetivo: document.getElementById('objetivoBrainstorm').value,
                ideias: ideiasBrainstorm,
                ideias_selecionadas: ideiasSelecionadas
            };
            
            const tituloFinal = `Brainstorming: ${tema}`;
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/ferramentas-qualidade', {
                    method: 'POST',
                    headers: headers,
                    credentials: 'include',
                    body: JSON.stringify({
                        id: ferramentaAtualId,
                        tipo_ferramenta: 'brainstorm',
                        titulo: tituloFinal,
                        dados: dados
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    ferramentaAtualId = data.ferramenta.id;
                    alert('‚úÖ Brainstorming salvo com sucesso!');
                } else {
                    alert('‚ùå Erro ao salvar: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('‚ùå Erro ao salvar Brainstorming:', error);
                alert('‚ùå Erro ao salvar Brainstorming: ' + error.message);
            }
        }

        // ========== FUN√á√ÉO AUXILIAR PARA IMPRIMIR ==========
        function imprimirConteudo(conteudo, titulo) {
            const janela = window.open('', '_blank');
            if (!janela) {
                alert('Por favor, permita pop-ups para esta funcionalidade.');
                return;
            }
            
            const scriptTag = '<scr' + 'ipt>';
            const scriptClose = '</scr' + 'ipt>';
            
            const html = '<!DOCTYPE html>' +
                '<html>' +
                '<head>' +
                '<title>' + (titulo || 'Documento') + '</title>' +
                '<style>' +
                'body { font-family: Arial, sans-serif; padding: 20px; }' +
                'table { border-collapse: collapse; width: 100%; margin: 20px 0; }' +
                'th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }' +
                'th { background-color: #f2f2f2; }' +
                '</style>' +
                '</head>' +
                '<body>' +
                conteudo +
                scriptTag +
                'window.onload = function() { window.print(); }' +
                scriptClose +
                '</body>' +
                '</html>';
            
            janela.document.open();
            janela.document.write(html);
            janela.document.close();
        }

    </script>
    
    <!-- Chat IA -->
    <link rel="stylesheet" href="css/chat-ia.css">
    <script src="js/chat-ia.js"></script>
</body>
</html>
