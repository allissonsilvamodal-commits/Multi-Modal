<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferramentas de Qualidade - Intranet</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/permissions.js"></script>
    <style>
        body {
            background: #f8f9fa;
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        
        .header-section {
            background: #667eea;
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 2rem;
        }
        
        .tool-card {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #dee2e6;
        }
        
        .tool-icon {
            width: 50px;
            height: 50px;
            background: #667eea;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }
        
        .nav-tabs .nav-link {
            color: #495057;
            border: none;
            border-bottom: 2px solid transparent;
            padding: 0.5rem 1rem;
        }
        
        .nav-tabs .nav-link:hover {
            color: #667eea;
            border-bottom-color: #667eea;
        }
        
        .nav-tabs .nav-link.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: transparent;
        }
        
        .form-section {
            background: #f8f9fa;
            border-radius: 4px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .ishikawa-container {
            position: relative;
            min-height: 500px;
            overflow: auto;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        
        .ishikawa-diagram {
            position: relative;
            margin: 20px auto;
            width: 100%;
            max-width: 1400px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .fishbone-spine {
            stroke: #2c3e50;
            stroke-width: 5;
            stroke-linecap: round;
            filter: drop-shadow(0 2px 3px rgba(0,0,0,0.2));
        }
        
        .fishbone-branch {
            stroke-width: 3;
            stroke-linecap: round;
            stroke-linejoin: round;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.15));
        }
        
        .fishbone-branch.metodo { stroke: #3498db; }
        .fishbone-branch.maoobra { stroke: #e74c3c; }
        .fishbone-branch.material { stroke: #f39c12; }
        .fishbone-branch.maquina { stroke: #9b59b6; }
        .fishbone-branch.meioambiente { stroke: #27ae60; }
        .fishbone-branch.medicao { stroke: #16a085; }
        
        .fishbone-sub-branch {
            stroke: #7f8c8d;
            stroke-width: 2;
            stroke-linecap: round;
            stroke-linejoin: round;
            opacity: 0.8;
        }
        
        .fishbone-label {
            font-size: 15px;
            fill: #2c3e50;
            font-weight: 700;
            font-family: 'Segoe UI', Arial, sans-serif;
            text-shadow: 0 1px 2px rgba(255,255,255,0.8);
        }
        
        .fishbone-causa-text {
            font-size: 11px;
            fill: #34495e;
            font-family: 'Segoe UI', Arial, sans-serif;
            font-weight: 500;
        }
        
        .fishbone-effect-box {
            fill: #e74c3c;
            stroke: #c0392b;
            stroke-width: 3;
            filter: drop-shadow(0 3px 6px rgba(0,0,0,0.3));
        }
        
        .fishbone-effect-text {
            fill: white;
            font-size: 17px;
            font-weight: bold;
            font-family: 'Segoe UI', Arial, sans-serif;
            text-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }
        
        .fishbone-category-box {
            stroke: #2c3e50;
            stroke-width: 2;
            rx: 6;
            ry: 6;
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.2));
        }
        
        .fishbone-category-box.metodo { fill: #3498db; }
        .fishbone-category-box.maoobra { fill: #e74c3c; }
        .fishbone-category-box.material { fill: #f39c12; }
        .fishbone-category-box.maquina { fill: #9b59b6; }
        .fishbone-category-box.meioambiente { fill: #27ae60; }
        .fishbone-category-box.medicao { fill: #16a085; }
        
        .fishbone-category-text {
            fill: white;
            font-size: 13px;
            font-weight: bold;
            font-family: 'Segoe UI', Arial, sans-serif;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
        }
        
        .fishbone-head {
            fill: #e74c3c;
            stroke: #c0392b;
            stroke-width: 3;
        }
        
        .fishbone-eye {
            fill: white;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.3));
        }
        
        .fishbone-fin {
            fill: #e74c3c;
            stroke: #c0392b;
            stroke-width: 2;
            opacity: 0.9;
        }
        
        .action-item {
            background: white;
            border-left: 4px solid #667eea;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            border: 1px solid #dee2e6;
        }
        
        .action-item.completed {
            border-left-color: #28a745;
            opacity: 0.8;
        }
        
        .acao-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .acao-card:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        .acao-card.prioridade-alta {
            border-left: 4px solid #dc3545;
        }
        
        .acao-card.prioridade-media {
            border-left: 4px solid #ffc107;
        }
        
        .acao-card.prioridade-baixa {
            border-left: 4px solid #0dcaf0;
        }
        
        .acao-card.finalizado {
            background: #f8f9fa;
            opacity: 0.9;
        }
        
        .acao-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .acao-info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .acao-info-item {
            display: flex;
            flex-direction: column;
        }
        
        .acao-info-item label {
            font-size: 0.75rem;
            font-weight: 600;
            color: #6c757d;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }
        
        .acao-info-item input,
        .acao-info-item select,
        .acao-info-item textarea {
            font-size: 0.9rem;
        }
        
        .acao-descricao {
            margin-bottom: 1rem;
        }
        
        .badge-status {
            padding: 0.35rem 0.65rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .progress-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .progress-container input {
            width: 80px;
        }
        
        .progress-container .progress {
            flex: 1;
            height: 20px;
        }
        
        /* Fluxo Visual das Ferramentas */
        .fluxo-container {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .fluxo-titulo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            margin-bottom: 1.5rem;
            text-align: center;
        }
        
        .fluxo-etapas {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
            position: relative;
        }
        
        .fluxo-etapa {
            flex: 1;
            min-width: 100px;
            max-width: 120px;
            text-align: center;
            position: relative;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .fluxo-etapa:hover {
            transform: translateY(-5px);
        }
        
        .fluxo-etapa-numero {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #e9ecef;
            color: #6c757d;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
            margin: 0 auto 0.5rem;
            border: 3px solid #e9ecef;
            transition: all 0.3s ease;
        }
        
        .fluxo-etapa.pendente .fluxo-etapa-numero {
            background: #e9ecef;
            border-color: #e9ecef;
            color: #6c757d;
        }
        
        .fluxo-etapa.em-andamento .fluxo-etapa-numero {
            background: #fff3cd;
            border-color: #ffc107;
            color: #856404;
            animation: pulse 2s infinite;
        }
        
        .fluxo-etapa.concluido .fluxo-etapa-numero {
            background: #d4edda;
            border-color: #28a745;
            color: #155724;
        }
        
        .fluxo-etapa-nome {
            font-size: 0.75rem;
            font-weight: 600;
            color: #495057;
            margin-top: 0.5rem;
        }
        
        .fluxo-etapa-icone {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: #6c757d;
        }
        
        .fluxo-etapa.concluido .fluxo-etapa-icone {
            color: #28a745;
        }
        
        .fluxo-etapa.em-andamento .fluxo-etapa-icone {
            color: #ffc107;
        }
        
        .fluxo-connector {
            flex: 1;
            height: 3px;
            background: #e9ecef;
            margin: 0 0.5rem;
            position: relative;
            min-width: 30px;
        }
        
        .fluxo-connector.concluido {
            background: #28a745;
        }
        
        .fluxo-connector::after {
            content: '→';
            position: absolute;
            right: -10px;
            top: -8px;
            color: #6c757d;
            font-size: 1.2rem;
        }
        
        .fluxo-connector.concluido::after {
            color: #28a745;
        }
        
        /* Cores específicas por ferramenta */
        .etapa-swot { --cor-etapa: #3498db; }
        .etapa-brainstorm { --cor-etapa: #9b59b6; }
        .etapa-forca-impacto { --cor-etapa: #e74c3c; }
        .etapa-ishikawa { --cor-etapa: #17a2b8; }
        .etapa-5porques { --cor-etapa: #f39c12; }
        .etapa-5w2h { --cor-etapa: #27ae60; }
        .etapa-pdca { --cor-etapa: #16a085; }
        .etapa-plano-acao { --cor-etapa: #c0392b; }
        .etapa-relatorio { --cor-etapa: #34495e; }
        
        .fluxo-etapa.em-andamento.etapa-swot .fluxo-etapa-numero,
        .fluxo-etapa.concluido.etapa-swot .fluxo-etapa-numero {
            background: var(--cor-etapa);
            border-color: var(--cor-etapa);
            color: white;
        }
        
        .fluxo-etapa.em-andamento.etapa-brainstorm .fluxo-etapa-numero,
        .fluxo-etapa.concluido.etapa-brainstorm .fluxo-etapa-numero {
            background: var(--cor-etapa);
            border-color: var(--cor-etapa);
            color: white;
        }
        
        .fluxo-etapa.em-andamento.etapa-forca-impacto .fluxo-etapa-numero,
        .fluxo-etapa.concluido.etapa-forca-impacto .fluxo-etapa-numero {
            background: var(--cor-etapa);
            border-color: var(--cor-etapa);
            color: white;
        }
        
        .fluxo-etapa.em-andamento.etapa-ishikawa .fluxo-etapa-numero,
        .fluxo-etapa.concluido.etapa-ishikawa .fluxo-etapa-numero {
            background: var(--cor-etapa);
            border-color: var(--cor-etapa);
            color: white;
        }
        
        .fluxo-etapa.em-andamento.etapa-5porques .fluxo-etapa-numero,
        .fluxo-etapa.concluido.etapa-5porques .fluxo-etapa-numero {
            background: var(--cor-etapa);
            border-color: var(--cor-etapa);
            color: white;
        }
        
        .fluxo-etapa.em-andamento.etapa-5w2h .fluxo-etapa-numero,
        .fluxo-etapa.concluido.etapa-5w2h .fluxo-etapa-numero {
            background: var(--cor-etapa);
            border-color: var(--cor-etapa);
            color: white;
        }
        
        .fluxo-etapa.em-andamento.etapa-pdca .fluxo-etapa-numero,
        .fluxo-etapa.concluido.etapa-pdca .fluxo-etapa-numero {
            background: var(--cor-etapa);
            border-color: var(--cor-etapa);
            color: white;
        }
        
        .fluxo-etapa.em-andamento.etapa-plano-acao .fluxo-etapa-numero,
        .fluxo-etapa.concluido.etapa-plano-acao .fluxo-etapa-numero {
            background: var(--cor-etapa);
            border-color: var(--cor-etapa);
            color: white;
        }
        
        .fluxo-etapa.em-andamento.etapa-relatorio .fluxo-etapa-numero,
        .fluxo-etapa.concluido.etapa-relatorio .fluxo-etapa-numero {
            background: var(--cor-etapa);
            border-color: var(--cor-etapa);
            color: white;
        }
        
        /* Botão Ajuda IA */
        .btn-ia {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-ia:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .btn-ia i {
            margin-right: 0.5rem;
        }
        
        @media (max-width: 768px) {
            .fluxo-etapas {
                flex-direction: column;
            }
            
            .fluxo-connector {
                width: 3px;
                height: 30px;
                margin: 0.5rem 0;
            }
            
            .fluxo-connector::after {
                content: '↓';
                right: -8px;
                top: auto;
                bottom: -10px;
            }
        }
        
        /* ========== ESTILOS PARA RELATÓRIO PROFISSIONAL MELHORADO ========== */
        .relatorio-profissional {
            max-width: 1200px;
            margin: 0 auto;
            background: #ffffff;
            color: #1e293b;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.7;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            border-radius: 8px;
            overflow: hidden;
        }
        
        /* Cabeçalho Fixo */
        .relatorio-header-fixed {
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 50%, #60a5fa 100%);
            color: white;
            padding: 30px 40px;
            border-bottom: 3px solid rgba(255,255,255,0.2);
        }
        
        .relatorio-header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .relatorio-logo-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .relatorio-logo {
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            flex-shrink: 0;
        }
        
        .relatorio-empresa-nome {
            font-size: 1.8rem;
            font-weight: 700;
            margin: 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.15);
            letter-spacing: -0.5px;
        }
        
        .relatorio-empresa-subtitulo {
            font-size: 0.9rem;
            margin: 4px 0 0 0;
            opacity: 0.95;
            font-weight: 400;
        }
        
        .relatorio-header-badge {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            backdrop-filter: blur(10px);
            font-weight: 500;
            font-size: 0.95rem;
        }
        
        /* Container Principal com Layout de Duas Colunas */
        .relatorio-container {
            display: flex;
            gap: 30px;
            padding: 30px 40px;
            background: #f8fafc;
        }
        
        .relatorio-main-content {
            flex: 1;
            min-width: 0;
        }
        
        /* Box de Dados do Projeto */
        .relatorio-projeto-box {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
            border-left: 4px solid #2563eb;
        }
        
        .relatorio-projeto-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .relatorio-projeto-icon-box {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.3rem;
        }
        
        .relatorio-projeto-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }
        
        .relatorio-projeto-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }
        
        .relatorio-projeto-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 3px solid #3b82f6;
        }
        
        .relatorio-projeto-item i {
            color: #2563eb;
            font-size: 1.2rem;
            margin-top: 2px;
            flex-shrink: 0;
        }
        
        .relatorio-projeto-item strong {
            display: block;
            color: #64748b;
            font-size: 0.85rem;
            margin-bottom: 4px;
            font-weight: 600;
        }
        
        .relatorio-projeto-item span {
            color: #1e293b;
            font-size: 0.95rem;
            font-weight: 500;
        }
        
        /* Seções do Relatório */
        .relatorio-secoes {
            display: flex;
            flex-direction: column;
            gap: 25px;
        }
        
        .relatorio-secao-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border-left: 4px solid #64748b;
            transition: all 0.3s ease;
        }
        
        .relatorio-secao-card:hover {
            box-shadow: 0 4px 16px rgba(37, 99, 235, 0.12);
            transform: translateY(-2px);
        }
        
        .relatorio-secao-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 18px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .relatorio-secao-icon-box {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .relatorio-secao-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }
        
        .relatorio-secao-body {
            padding-top: 5px;
        }
        
        .relatorio-paragrafo {
            margin: 0 0 14px 0;
            color: #475569;
            text-align: justify;
            font-size: 0.95rem;
            line-height: 1.8;
        }
        
        .relatorio-item-lista {
            margin: 10px 0;
            padding-left: 25px;
            position: relative;
            color: #475569;
            line-height: 1.8;
            font-size: 0.95rem;
        }
        
        .relatorio-item-lista::before {
            content: '▸';
            position: absolute;
            left: 0;
            color: #2563eb;
            font-weight: bold;
            font-size: 1.1rem;
        }
        
        .relatorio-destaque-box {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-left: 4px solid #f59e0b;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 8px;
            font-weight: 600;
            color: #92400e;
            font-size: 0.95rem;
            box-shadow: 0 2px 8px rgba(245, 158, 11, 0.15);
        }
        
        /* Sidebar */
        .relatorio-sidebar {
            width: 320px;
            flex-shrink: 0;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .relatorio-sidebar-box {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.06);
            border-top: 3px solid #2563eb;
        }
        
        .relatorio-sidebar-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .relatorio-sidebar-header i {
            color: #2563eb;
            font-size: 1.2rem;
        }
        
        .relatorio-sidebar-header h4 {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0;
        }
        
        .relatorio-sidebar-content {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .relatorio-insight-item {
            display: flex;
            gap: 12px;
            padding: 12px;
            background: #f8fafc;
            border-radius: 8px;
            border-left: 3px solid #3b82f6;
        }
        
        .relatorio-insight-item i {
            color: #2563eb;
            font-size: 1.1rem;
            flex-shrink: 0;
            margin-top: 2px;
        }
        
        .relatorio-insight-item p {
            margin: 0;
            color: #475569;
            font-size: 0.9rem;
            line-height: 1.6;
        }
        
        .relatorio-indicator {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-radius: 8px;
            border-left: 3px solid #2563eb;
        }
        
        .relatorio-indicator-label {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #475569;
            font-size: 0.9rem;
            font-weight: 500;
        }
        
        .relatorio-indicator-label i {
            color: #2563eb;
        }
        
        .relatorio-indicator-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: #2563eb;
        }
        
        .relatorio-resumo-section {
            margin-top: 10px;
        }
        
        .relatorio-resumo-section strong {
            display: flex;
            align-items: center;
            gap: 8px;
            color: #1e293b;
            font-size: 0.95rem;
            margin-bottom: 10px;
        }
        
        .relatorio-resumo-section strong i {
            color: #2563eb;
        }
        
        .relatorio-resumo-section ul {
            margin: 0;
            padding-left: 25px;
            color: #475569;
            font-size: 0.9rem;
            line-height: 1.7;
        }
        
        .relatorio-resumo-section li {
            margin-bottom: 6px;
        }
        
        /* Rodapé Fixo */
        .relatorio-footer-fixed {
            background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            color: white;
            padding: 25px 40px;
            border-top: 3px solid rgba(255,255,255,0.1);
        }
        
        .relatorio-footer-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 15px;
        }
        
        .relatorio-footer-left p,
        .relatorio-footer-right p {
            margin: 0;
            font-size: 0.9rem;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .relatorio-footer-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.2);
            margin: 15px 0;
        }
        
        .relatorio-footer-copyright {
            text-align: center;
            margin: 0;
            font-size: 0.85rem;
            opacity: 0.7;
        }
        
        /* Estilos para impressão/PDF */
        @media print {
            .relatorio-profissional {
                max-width: 100%;
                margin: 0;
                padding: 0;
                box-shadow: none;
            }
            
            .relatorio-container {
                flex-direction: column;
                padding: 20px;
            }
            
            .relatorio-sidebar {
                width: 100%;
                page-break-inside: avoid;
            }
            
            .relatorio-header-fixed,
            .relatorio-footer-fixed {
                padding: 15px 20px;
                page-break-inside: avoid;
            }
            
            .relatorio-secao-card {
                page-break-inside: avoid;
                margin-bottom: 15px;
            }
        }
        
        /* Estilos responsivos */
        @media (max-width: 1024px) {
            .relatorio-container {
                flex-direction: column;
            }
            
            .relatorio-sidebar {
                width: 100%;
            }
        }
        
        @media (max-width: 768px) {
            .relatorio-header-content,
            .relatorio-footer-content {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .relatorio-header-fixed,
            .relatorio-container,
            .relatorio-footer-fixed {
                padding: 20px;
            }
            
            .relatorio-projeto-grid {
                grid-template-columns: 1fr;
            }
            
            .relatorio-projeto-title {
                font-size: 1.3rem;
            }
            
            .relatorio-empresa-nome {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header-section">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-tools me-2"></i>Ferramentas de Qualidade</h1>
                    <p class="mb-0">Conjunto de ferramentas para análise e melhoria contínua</p>
                </div>
                <div>
                    <a href="treinamentos.html" class="btn btn-light">
                        <i class="fas fa-arrow-left me-2"></i>Voltar aos Treinamentos
                    </a>
                    <a href="portal.html" class="btn btn-light ms-2">
                        <i class="fas fa-home me-2"></i>Portal
                    </a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Fluxo Visual das Ferramentas -->
        <div class="fluxo-container">
            <h3 class="fluxo-titulo">
                <i class="fas fa-project-diagram me-2"></i>Fluxo de Análise e Melhoria Contínua
            </h3>
            
            <!-- Seletor de Projeto -->
            <div class="card mb-3" id="seletorProjetoCard">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-folder-open me-2"></i>Projeto de Análise</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Selecione ou crie um projeto:</label>
                            <select class="form-select mb-2" id="selectProjeto" onchange="selecionarProjeto()">
                                <option value="">-- Criar Novo Projeto --</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold">Novo Projeto:</label>
                            <div class="input-group">
                                <input type="text" class="form-control" id="novoProjetoTitulo" placeholder="Título do projeto">
                                <button class="btn btn-primary" onclick="criarNovoProjeto()">
                                    <i class="fas fa-plus"></i> Criar
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="infoProjetoAtual" class="mt-3" style="display: none;">
                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Projeto Atual:</strong> <span id="nomeProjetoAtual"></span>
                            <br>
                            <small>Problema: <span id="problemaProjetoAtual"></span></small>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div class="progress" style="height: 25px; flex: 1; margin-right: 1rem;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" id="progressoGeral" style="width: 0%">
                        <span id="textoProgresso">0% Completo</span>
                    </div>
                </div>
                <button class="btn btn-sm btn-outline-danger" onclick="limparTodoFluxo()" title="Limpar todo o progresso">
                    <i class="fas fa-redo me-1"></i>Limpar Fluxo
                </button>
            </div>
            <div class="fluxo-etapas" id="fluxoEtapas">
                <div class="fluxo-etapa etapa-swot pendente" data-etapa="swot" onclick="navegarParaEtapa('swot')">
                    <div class="fluxo-etapa-numero">1</div>
                    <div class="fluxo-etapa-icone"><i class="fas fa-th"></i></div>
                    <div class="fluxo-etapa-nome">SWOT</div>
                </div>
                <div class="fluxo-connector"></div>
                <div class="fluxo-etapa etapa-brainstorm pendente" data-etapa="brainstorm" onclick="navegarParaEtapa('brainstorm')">
                    <div class="fluxo-etapa-numero">2</div>
                    <div class="fluxo-etapa-icone"><i class="fas fa-lightbulb"></i></div>
                    <div class="fluxo-etapa-nome">Brainstorming</div>
                </div>
                <div class="fluxo-connector"></div>
                <div class="fluxo-etapa etapa-forca-impacto pendente" data-etapa="forca-impacto" onclick="navegarParaEtapa('forca-impacto')">
                    <div class="fluxo-etapa-numero">3</div>
                    <div class="fluxo-etapa-icone"><i class="fas fa-chart-scatter"></i></div>
                    <div class="fluxo-etapa-nome">Força x Impacto</div>
                </div>
                <div class="fluxo-connector"></div>
                <div class="fluxo-etapa etapa-ishikawa pendente" data-etapa="ishikawa" onclick="navegarParaEtapa('ishikawa')">
                    <div class="fluxo-etapa-numero">4</div>
                    <div class="fluxo-etapa-icone"><i class="fas fa-project-diagram"></i></div>
                    <div class="fluxo-etapa-nome">Ishikawa</div>
                </div>
                <div class="fluxo-connector"></div>
                <div class="fluxo-etapa etapa-5porques pendente" data-etapa="5porques" onclick="navegarParaEtapa('5porques')">
                    <div class="fluxo-etapa-numero">5</div>
                    <div class="fluxo-etapa-icone"><i class="fas fa-question-circle"></i></div>
                    <div class="fluxo-etapa-nome">5 Porquês</div>
                </div>
                <div class="fluxo-connector"></div>
                <div class="fluxo-etapa etapa-5w2h pendente" data-etapa="5w2h" onclick="navegarParaEtapa('5w2h')">
                    <div class="fluxo-etapa-numero">6</div>
                    <div class="fluxo-etapa-icone"><i class="fas fa-clipboard-question"></i></div>
                    <div class="fluxo-etapa-nome">5W2H</div>
                </div>
                <div class="fluxo-connector"></div>
                <div class="fluxo-etapa etapa-pdca pendente" data-etapa="pdca" onclick="navegarParaEtapa('pdca')">
                    <div class="fluxo-etapa-numero">7</div>
                    <div class="fluxo-etapa-icone"><i class="fas fa-sync-alt"></i></div>
                    <div class="fluxo-etapa-nome">PDCA</div>
                </div>
                <div class="fluxo-connector"></div>
                <div class="fluxo-etapa etapa-plano-acao pendente" data-etapa="plano-acao" onclick="navegarParaEtapa('plano-acao')">
                    <div class="fluxo-etapa-numero">8</div>
                    <div class="fluxo-etapa-icone"><i class="fas fa-tasks"></i></div>
                    <div class="fluxo-etapa-nome">Plano de Ação</div>
                </div>
                <div class="fluxo-connector"></div>
                <div class="fluxo-etapa etapa-relatorio pendente" data-etapa="relatorio" onclick="navegarParaEtapa('relatorio')">
                    <div class="fluxo-etapa-numero">9</div>
                    <div class="fluxo-etapa-icone"><i class="fas fa-file-alt"></i></div>
                    <div class="fluxo-etapa-nome">Relatório IA</div>
                </div>
            </div>
        </div>
        
        <!-- Tabs de Ferramentas -->
        <ul class="nav nav-tabs mb-4" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-swot" type="button">
                    <i class="fas fa-th me-1"></i>SWOT
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-brainstorm" type="button">
                    <i class="fas fa-lightbulb me-1"></i>Brainstorming
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-forca-impacto" type="button">
                    <i class="fas fa-chart-scatter me-1"></i>Força x Impacto
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-ishikawa" type="button">
                    <i class="fas fa-project-diagram me-1"></i>Ishikawa
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-5porques" type="button">
                    <i class="fas fa-question-circle me-1"></i>5 Porquês
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-5w2h" type="button">
                    <i class="fas fa-clipboard-question me-1"></i>5W2H
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-pdca" type="button">
                    <i class="fas fa-sync-alt me-1"></i>PDCA
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-plano-acao" type="button">
                    <i class="fas fa-tasks me-1"></i>Plano de Ação
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-relatorio" type="button">
                    <i class="fas fa-file-alt me-1"></i>Relatório IA
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-arquivos" type="button">
                    <i class="fas fa-archive me-1"></i>Arquivos
                    <span class="badge bg-danger ms-1" id="badgeAlertas" style="display: none;">0</span>
                </button>
            </li>
        </ul>

        <div class="tab-content">
            <!-- Tab SWOT -->
            <div class="tab-pane fade show active" id="tab-swot" role="tabpanel">
                <div class="tool-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="tool-icon" style="background: #3498db;">
                                <i class="fas fa-th"></i>
                            </div>
                            <div class="ms-3">
                                <h3>Análise SWOT</h3>
                                <p class="text-muted mb-0">Identifique Forças, Fraquezas, Oportunidades e Ameaças</p>
                            </div>
                        </div>
                        <button class="btn btn-ia" onclick="assistenteQualidade('swot')">
                            <i class="fas fa-robot"></i>Ajuda da IA
                        </button>
                    </div>
                    
                    <div class="form-section">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Título:</label>
                            <input type="text" class="form-control" id="tituloSwot" placeholder="Ex: Análise SWOT - Processo de Produção">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Contexto/Problema:</label>
                            <textarea class="form-control" id="contextoSwot" rows="3" placeholder="Descreva o contexto ou problema que será analisado..."></textarea>
                        </div>
                        <div class="mb-3">
                            <button class="btn btn-primary" onclick="gerarSwotComIA()">
                                <i class="fas fa-magic me-2"></i>Gerar Análise com IA
                            </button>
                        </div>
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <div class="card border-success h-100">
                                <div class="card-header bg-success text-white">
                                    <h5 class="mb-0"><i class="fas fa-thumbs-up me-2"></i>Forças</h5>
                                </div>
                                <div class="card-body">
                                    <div id="swot-forcas">
                                        <div class="mb-2">
                                            <input type="text" class="form-control form-control-sm swot-item" placeholder="Adicione uma força..." data-quadrante="forcas">
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-success mt-2" onclick="adicionarItemSwot('forcas')">
                                        <i class="fas fa-plus"></i> Adicionar
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-danger h-100">
                                <div class="card-header bg-danger text-white">
                                    <h5 class="mb-0"><i class="fas fa-thumbs-down me-2"></i>Fraquezas</h5>
                                </div>
                                <div class="card-body">
                                    <div id="swot-fraquezas">
                                        <div class="mb-2">
                                            <input type="text" class="form-control form-control-sm swot-item" placeholder="Adicione uma fraqueza..." data-quadrante="fraquezas">
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-danger mt-2" onclick="adicionarItemSwot('fraquezas')">
                                        <i class="fas fa-plus"></i> Adicionar
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-info h-100">
                                <div class="card-header bg-info text-white">
                                    <h5 class="mb-0"><i class="fas fa-arrow-up me-2"></i>Oportunidades</h5>
                                </div>
                                <div class="card-body">
                                    <div id="swot-oportunidades">
                                        <div class="mb-2">
                                            <input type="text" class="form-control form-control-sm swot-item" placeholder="Adicione uma oportunidade..." data-quadrante="oportunidades">
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-info mt-2" onclick="adicionarItemSwot('oportunidades')">
                                        <i class="fas fa-plus"></i> Adicionar
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card border-warning h-100">
                                <div class="card-header bg-warning text-dark">
                                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Ameaças</h5>
                                </div>
                                <div class="card-body">
                                    <div id="swot-ameacas">
                                        <div class="mb-2">
                                            <input type="text" class="form-control form-control-sm swot-item" placeholder="Adicione uma ameaça..." data-quadrante="ameacas">
                                        </div>
                                    </div>
                                    <button class="btn btn-sm btn-outline-warning mt-2" onclick="adicionarItemSwot('ameacas')">
                                        <i class="fas fa-plus"></i> Adicionar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 d-flex gap-2">
                        <button class="btn btn-primary" onclick="salvarSwot()">
                            <i class="fas fa-save me-2"></i>Salvar
                        </button>
                        <button class="btn btn-secondary" onclick="limparSwot()">
                            <i class="fas fa-trash me-2"></i>Limpar
                        </button>
                        <button class="btn btn-success" onclick="exportarSwot()">
                            <i class="fas fa-file-pdf me-2"></i>Exportar PDF
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Tab 5 Porquês -->
            <div class="tab-pane fade" id="tab-5porques" role="tabpanel">
                <div class="tool-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="tool-icon">
                                <i class="fas fa-question-circle"></i>
                            </div>
                            <div class="ms-3">
                                <h3>5 Porquês</h3>
                                <p class="text-muted mb-0">Técnica para identificar a causa raiz de um problema através de perguntas sucessivas</p>
                            </div>
                        </div>
                        <button class="btn btn-ia" onclick="assistenteQualidade('5porques')">
                            <i class="fas fa-robot"></i>Ajuda da IA
                        </button>
                    </div>
                    
                    <div class="form-section">
                        <div class="mb-3">
                            <button class="btn btn-primary" onclick="passarDadosPara5Porques()">
                                <i class="fas fa-arrow-down me-2"></i>Importar do Ishikawa
                            </button>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Título:</label>
                            <input type="text" class="form-control" id="titulo5porques" placeholder="Ex: Análise de defeitos em produção">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Problema Identificado:</label>
                            <input type="text" class="form-control" id="problema5porques" placeholder="Descreva o problema inicial">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">1º Por quê?</label>
                            <input type="text" class="form-control" id="porque1" placeholder="Por que isso aconteceu?">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">2º Por quê?</label>
                            <input type="text" class="form-control" id="porque2" placeholder="Por que isso aconteceu?">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">3º Por quê?</label>
                            <input type="text" class="form-control" id="porque3" placeholder="Por que isso aconteceu?">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">4º Por quê?</label>
                            <input type="text" class="form-control" id="porque4" placeholder="Por que isso aconteceu?">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">5º Por quê?</label>
                            <input type="text" class="form-control" id="porque5" placeholder="Por que isso aconteceu?">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Causa Raiz Identificada:</label>
                            <textarea class="form-control" id="causaRaiz" rows="3" placeholder="Com base nas respostas, identifique a causa raiz"></textarea>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" onclick="salvar5Porques()">
                                <i class="fas fa-save me-2"></i>Salvar
                            </button>
                            <button class="btn btn-primary" onclick="exportar5Porques()">
                                <i class="fas fa-download me-2"></i>Exportar PDF
                            </button>
                            <button class="btn btn-secondary" onclick="limpar5Porques()">
                                <i class="fas fa-redo me-2"></i>Limpar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab 5W2H -->
            <div class="tab-pane fade" id="tab-5w2h" role="tabpanel">
                <div class="tool-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="tool-icon">
                                <i class="fas fa-clipboard-question"></i>
                            </div>
                            <div class="ms-3">
                                <h3>5W2H</h3>
                                <p class="text-muted mb-0">Ferramenta para planejamento e organização de ações através de perguntas específicas</p>
                            </div>
                        </div>
                        <button class="btn btn-ia" onclick="assistenteQualidade('5w2h')">
                            <i class="fas fa-robot"></i>Ajuda da IA
                        </button>
                    </div>
                    
                    <div class="form-section">
                        <div class="mb-3">
                            <button class="btn btn-primary" onclick="passarDadosPara5W2H()">
                                <i class="fas fa-arrow-down me-2"></i>Importar do 5 Porquês
                            </button>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Título do 5W2H:</label>
                            <input type="text" class="form-control" id="titulo5w2h" placeholder="Nome/identificação deste 5W2H">
                        </div>
                        
                        <div class="mb-3">
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <label class="form-label fw-bold mb-0">Linhas de Informação:</label>
                                <button class="btn btn-sm btn-primary" onclick="adicionarLinha5W2H()">
                                    <i class="fas fa-plus me-1"></i>Adicionar Linha
                                </button>
                            </div>
                            <div id="linhas5w2h">
                                <!-- Linhas serão adicionadas aqui -->
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" onclick="salvar5W2H()">
                                <i class="fas fa-save me-2"></i>Salvar
                            </button>
                            <button class="btn btn-primary" onclick="exportar5W2H()">
                                <i class="fas fa-download me-2"></i>Exportar PDF
                            </button>
                            <button class="btn btn-secondary" onclick="limpar5W2H()">
                                <i class="fas fa-redo me-2"></i>Limpar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Força x Impacto -->
            <div class="tab-pane fade" id="tab-forca-impacto" role="tabpanel">
                <div class="tool-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="tool-icon" style="background: #e74c3c;">
                                <i class="fas fa-chart-scatter"></i>
                            </div>
                            <div class="ms-3">
                                <h3>Matriz Força x Impacto</h3>
                                <p class="text-muted mb-0">Priorize ações baseado em facilidade de implementação e impacto</p>
                            </div>
                        </div>
                        <button class="btn btn-ia" onclick="assistenteQualidade('forca-impacto')">
                            <i class="fas fa-robot"></i>Ajuda da IA
                        </button>
                    </div>
                    
                    <div class="form-section">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Título:</label>
                            <input type="text" class="form-control" id="tituloForcaImpacto" placeholder="Ex: Priorização de Melhorias">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Descrição:</label>
                            <textarea class="form-control" id="descricaoForcaImpacto" rows="2" placeholder="Descreva o contexto da análise..."></textarea>
                        </div>
                        <div class="mb-3">
                            <button class="btn btn-primary" onclick="importarDoBrainstorm()">
                                <i class="fas fa-download me-2"></i>Importar do Brainstorming
                            </button>
                            <button class="btn btn-info" onclick="analisarComIA()">
                                <i class="fas fa-magic me-2"></i>Analisar com IA
                            </button>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-9">
                            <div id="matriz-container" style="position: relative; min-height: 500px; border: 2px solid #dee2e6; border-radius: 8px; background: #f8f9fa;">
                                <svg id="matriz-svg" width="100%" height="500" style="background: white; border-radius: 8px;">
                                    <!-- Eixos -->
                                    <line x1="50" y1="450" x2="750" y2="450" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                                    <line x1="50" y1="450" x2="50" y2="50" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
                                    
                                    <!-- Labels dos eixos -->
                                    <text x="400" y="480" text-anchor="middle" font-size="16" font-weight="bold">Força/Facilidade (1-5)</text>
                                    <text x="20" y="250" text-anchor="middle" font-size="16" font-weight="bold" transform="rotate(-90, 20, 250)">Impacto (1-5)</text>
                                    
                                    <!-- Quadrantes -->
                                    <rect x="50" y="50" width="350" height="400" fill="#d4edda" opacity="0.3"/>
                                    <text x="225" y="250" text-anchor="middle" font-size="14" font-weight="bold" fill="#28a745">Alto Impacto<br/>Baixa Força</text>
                                    
                                    <rect x="400" y="50" width="350" height="400" fill="#d1ecf1" opacity="0.3"/>
                                    <text x="575" y="250" text-anchor="middle" font-size="14" font-weight="bold" fill="#17a2b8">Alto Impacto<br/>Alta Força</text>
                                    
                                    <rect x="50" y="450" width="350" height="0" fill="#fff3cd" opacity="0.3"/>
                                    <text x="225" y="470" text-anchor="middle" font-size="14" font-weight="bold" fill="#856404">Baixo Impacto<br/>Baixa Força</text>
                                    
                                    <rect x="400" y="450" width="350" height="0" fill="#f8d7da" opacity="0.3"/>
                                    <text x="575" y="470" text-anchor="middle" font-size="14" font-weight="bold" fill="#721c24">Baixo Impacto<br/>Alta Força</text>
                                    
                                    <!-- Marcadores de escala -->
                                    <text x="50" y="465" text-anchor="middle" font-size="12">1</text>
                                    <text x="200" y="465" text-anchor="middle" font-size="12">2</text>
                                    <text x="350" y="465" text-anchor="middle" font-size="12">3</text>
                                    <text x="500" y="465" text-anchor="middle" font-size="12">4</text>
                                    <text x="650" y="465" text-anchor="middle" font-size="12">5</text>
                                    
                                    <text x="35" y="450" text-anchor="end" font-size="12">1</text>
                                    <text x="35" y="350" text-anchor="end" font-size="12">2</text>
                                    <text x="35" y="250" text-anchor="end" font-size="12">3</text>
                                    <text x="35" y="150" text-anchor="end" font-size="12">4</text>
                                    <text x="35" y="50" text-anchor="end" font-size="12">5</text>
                                    
                                    <!-- Definição de seta -->
                                    <defs>
                                        <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                            <polygon points="0 0, 10 3, 0 6" fill="#333"/>
                                        </marker>
                                    </defs>
                                </svg>
                                
                                <div id="itens-matriz" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;">
                                    <!-- Itens arrastáveis serão adicionados aqui -->
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="card">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0">Itens para Priorizar</h6>
                                </div>
                                <div class="card-body" id="lista-itens-priorizar" style="max-height: 400px; overflow-y: auto;">
                                    <p class="text-muted small">Adicione itens ou importe do Brainstorming</p>
                                </div>
                                <div class="card-footer">
                                    <button class="btn btn-sm btn-primary w-100" onclick="adicionarItemPriorizacao()">
                                        <i class="fas fa-plus"></i> Adicionar Item
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 d-flex gap-2">
                        <button class="btn btn-primary" onclick="salvarForcaImpacto()">
                            <i class="fas fa-save me-2"></i>Salvar
                        </button>
                        <button class="btn btn-secondary" onclick="limparForcaImpacto()">
                            <i class="fas fa-trash me-2"></i>Limpar
                        </button>
                        <button class="btn btn-success" onclick="exportarForcaImpacto()">
                            <i class="fas fa-file-pdf me-2"></i>Exportar PDF
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tab Ishikawa -->
            <div class="tab-pane fade" id="tab-ishikawa" role="tabpanel">
                <div class="tool-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="tool-icon">
                                <i class="fas fa-project-diagram"></i>
                            </div>
                            <div class="ms-3">
                                <h3>Diagrama de Ishikawa (Espinha de Peixe)</h3>
                                <p class="text-muted mb-0">Diagrama para identificar e organizar causas de um problema</p>
                            </div>
                        </div>
                        <button class="btn btn-ia" onclick="assistenteQualidade('ishikawa')">
                            <i class="fas fa-robot"></i>Ajuda da IA
                        </button>
                    </div>
                    
                    <div class="form-section mb-4">
                        <div class="mb-3">
                            <button class="btn btn-primary" onclick="passarDadosParaIshikawa()">
                                <i class="fas fa-arrow-down me-2"></i>Importar Causas do Brainstorming/Força x Impacto
                            </button>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Título do Diagrama:</label>
                            <input type="text" class="form-control" id="tituloIshikawa" placeholder="Ex: Análise de causas de defeitos">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Problema (Efeito):</label>
                            <input type="text" class="form-control" id="problemaIshikawa" placeholder="Descreva o problema principal">
                        </div>
                        
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold">Método:</label>
                                <textarea class="form-control" id="ishikawa-metodo" rows="3" placeholder="Causas relacionadas ao método/processo"></textarea>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold">Mão de Obra:</label>
                                <textarea class="form-control" id="ishikawa-maoobra" rows="3" placeholder="Causas relacionadas às pessoas"></textarea>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold">Material:</label>
                                <textarea class="form-control" id="ishikawa-material" rows="3" placeholder="Causas relacionadas aos materiais"></textarea>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold">Máquina:</label>
                                <textarea class="form-control" id="ishikawa-maquina" rows="3" placeholder="Causas relacionadas às máquinas/equipamentos"></textarea>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold">Meio Ambiente:</label>
                                <textarea class="form-control" id="ishikawa-meioambiente" rows="3" placeholder="Causas relacionadas ao ambiente"></textarea>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label fw-bold">Medição:</label>
                                <textarea class="form-control" id="ishikawa-medicao" rows="3" placeholder="Causas relacionadas à medição"></textarea>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="visualizarIshikawa()">
                                <i class="fas fa-eye me-2"></i>Visualizar Diagrama
                            </button>
                            <button class="btn btn-success" onclick="salvarIshikawa()">
                                <i class="fas fa-save me-2"></i>Salvar
                            </button>
                            <button class="btn btn-info" onclick="exportarIshikawa()">
                                <i class="fas fa-download me-2"></i>Exportar PDF
                            </button>
                            <button class="btn btn-secondary" onclick="limparIshikawa()">
                                <i class="fas fa-redo me-2"></i>Limpar
                            </button>
                        </div>
                    </div>
                    
                    <div class="ishikawa-container" id="ishikawa-diagram-container" style="display: none;">
                        <svg id="ishikawa-svg" class="ishikawa-diagram"></svg>
                    </div>
                </div>
            </div>

            <!-- Tab Plano de Ação -->
            <div class="tab-pane fade" id="tab-plano-acao" role="tabpanel">
                <div class="tool-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="tool-icon">
                                <i class="fas fa-tasks"></i>
                            </div>
                            <div class="ms-3">
                                <h3>Plano de Ação Completo</h3>
                                <p class="text-muted mb-0">Gestão completa de ações com gestor, responsáveis, prazos, progresso e contingências</p>
                            </div>
                        </div>
                        <button class="btn btn-ia" onclick="assistenteQualidade('plano-acao')">
                            <i class="fas fa-robot"></i>Ajuda da IA
                        </button>
                    </div>
                    
                    <div class="form-section mb-4">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Título do Plano:</label>
                            <input type="text" class="form-control" id="tituloPlano" placeholder="Nome do plano de ação">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Objetivo:</label>
                            <textarea class="form-control" id="objetivoPlano" rows="2" placeholder="Qual o objetivo deste plano?"></textarea>
                        </div>
                        
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0">Ações</h5>
                            <button class="btn btn-primary btn-sm" onclick="adicionarAcao()">
                                <i class="fas fa-plus me-1"></i>Adicionar Ação
                            </button>
                        </div>
                        
                        <div id="listaAcoes">
                            <!-- Ações serão adicionadas aqui -->
                        </div>
                        
                        <div class="alert alert-info mt-3" id="alertasPlano" style="display: none;">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Alertas de Prazo:</strong>
                            <div id="listaAlertasPlano"></div>
                        </div>
                        
                        <div class="d-flex gap-2 mt-3">
                            <button class="btn btn-success" onclick="salvarPlanoAcao()">
                                <i class="fas fa-save me-2"></i>Salvar
                            </button>
                            <button class="btn btn-primary" onclick="exportarPlanoAcao()">
                                <i class="fas fa-download me-2"></i>Exportar PDF/Excel
                            </button>
                            <button class="btn btn-secondary" onclick="limparPlanoAcao()">
                                <i class="fas fa-redo me-2"></i>Limpar Tudo
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab PDCA -->
            <div class="tab-pane fade" id="tab-pdca" role="tabpanel">
                <div class="tool-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="tool-icon">
                                <i class="fas fa-sync-alt"></i>
                            </div>
                            <div class="ms-3">
                                <h3>PDCA (Plan-Do-Check-Act)</h3>
                                <p class="text-muted mb-0">Ciclo de melhoria contínua: Planejar, Executar, Verificar e Agir</p>
                            </div>
                        </div>
                        <button class="btn btn-ia" onclick="assistenteQualidade('pdca')">
                            <i class="fas fa-robot"></i>Ajuda da IA
                        </button>
                    </div>
                    
                    <div class="form-section">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Título:</label>
                            <input type="text" class="form-control" id="tituloPDCA" placeholder="Ex: Melhoria do processo de entrega">
                        </div>
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card h-100 border-primary">
                                    <div class="card-header bg-primary text-white">
                                        <h5 class="mb-0"><i class="fas fa-clipboard-list me-2"></i>PLAN - Planejar</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Problema/Oportunidade:</label>
                                            <textarea class="form-control" id="pdca-problema" rows="2"></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Objetivo:</label>
                                            <textarea class="form-control" id="pdca-objetivo" rows="2"></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Plano de Ação:</label>
                                            <textarea class="form-control" id="pdca-plano" rows="3"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100 border-success">
                                    <div class="card-header bg-success text-white">
                                        <h5 class="mb-0"><i class="fas fa-play me-2"></i>DO - Executar</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">O que foi executado:</label>
                                            <textarea class="form-control" id="pdca-executado" rows="3"></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Dificuldades encontradas:</label>
                                            <textarea class="form-control" id="pdca-dificuldades" rows="2"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="card h-100 border-warning">
                                    <div class="card-header bg-warning text-dark">
                                        <h5 class="mb-0"><i class="fas fa-search me-2"></i>CHECK - Verificar</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Resultados obtidos:</label>
                                            <textarea class="form-control" id="pdca-resultados" rows="3"></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Comparação com objetivo:</label>
                                            <textarea class="form-control" id="pdca-comparacao" rows="2"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="card h-100 border-danger">
                                    <div class="card-header bg-danger text-white">
                                        <h5 class="mb-0"><i class="fas fa-cog me-2"></i>ACT - Agir</h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Padronização:</label>
                                            <textarea class="form-control" id="pdca-padronizacao" rows="2"></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Próximos passos:</label>
                                            <textarea class="form-control" id="pdca-proximos" rows="2"></textarea>
                                        </div>
                                        <div class="mb-3">
                                            <label class="form-label fw-bold">Próximo ciclo PDCA:</label>
                                            <textarea class="form-control" id="pdca-proximo-ciclo" rows="2"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" onclick="salvarPDCA()">
                                <i class="fas fa-save me-2"></i>Salvar
                            </button>
                            <button class="btn btn-primary" onclick="exportarPDCA()">
                                <i class="fas fa-download me-2"></i>Exportar PDF
                            </button>
                            <button class="btn btn-secondary" onclick="limparPDCA()">
                                <i class="fas fa-redo me-2"></i>Limpar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Brainstorming -->
            <div class="tab-pane fade" id="tab-brainstorm" role="tabpanel">
                <div class="tool-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="tool-icon">
                                <i class="fas fa-lightbulb"></i>
                            </div>
                            <div class="ms-3">
                                <h3>Brainstorming</h3>
                                <p class="text-muted mb-0">Técnica para gerar ideias e soluções criativas</p>
                            </div>
                        </div>
                        <button class="btn btn-ia" onclick="assistenteQualidade('brainstorm')">
                            <i class="fas fa-robot"></i>Ajuda da IA
                        </button>
                    </div>
                    
                    <div class="form-section">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Tema/Problema:</label>
                            <input type="text" class="form-control" id="temaBrainstorm" placeholder="Qual o tema ou problema a ser discutido?">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Objetivo:</label>
                            <textarea class="form-control" id="objetivoBrainstorm" rows="2" placeholder="Qual o objetivo desta sessão?"></textarea>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Regras:</label>
                            <ul class="list-group">
                                <li class="list-group-item"><i class="fas fa-check-circle text-success me-2"></i>Não critique ideias</li>
                                <li class="list-group-item"><i class="fas fa-check-circle text-success me-2"></i>Quantidade é mais importante que qualidade</li>
                                <li class="list-group-item"><i class="fas fa-check-circle text-success me-2"></i>Construa sobre ideias dos outros</li>
                                <li class="list-group-item"><i class="fas fa-check-circle text-success me-2"></i>Pensamentos livres e criativos</li>
                            </ul>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Ideias:</label>
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="novaIdeia" placeholder="Digite uma ideia...">
                                <button class="btn btn-primary" onclick="adicionarIdeia()">
                                    <i class="fas fa-plus"></i> Adicionar
                                </button>
                            </div>
                            <div id="listaIdeias" class="row g-2">
                                <!-- Ideias serão adicionadas aqui -->
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Ideias Selecionadas (Top 5):</label>
                            <div id="ideiasSelecionadas" class="list-group">
                                <!-- Ideias selecionadas aparecerão aqui -->
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" onclick="salvarBrainstorm()">
                                <i class="fas fa-save me-2"></i>Salvar
                            </button>
                            <button class="btn btn-primary" onclick="exportarBrainstorm()">
                                <i class="fas fa-download me-2"></i>Exportar PDF
                            </button>
                            <button class="btn btn-secondary" onclick="limparBrainstorm()">
                                <i class="fas fa-redo me-2"></i>Limpar
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Relatório IA -->
            <div class="tab-pane fade" id="tab-relatorio" role="tabpanel">
                <div class="tool-card">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <div class="tool-icon" style="background: #34495e;">
                                <i class="fas fa-file-alt"></i>
                            </div>
                            <div class="ms-3">
                                <h3>Relatório Automático com IA</h3>
                                <p class="text-muted mb-0">Gere relatórios consolidados de todas as etapas da análise</p>
                            </div>
                        </div>
                        <button class="btn btn-ia" onclick="gerarRelatorioCompleto()">
                            <i class="fas fa-robot"></i>Gerar Relatório com IA
                        </button>
                    </div>
                    
                    <div class="form-section">
                        <div class="card mb-4 border-primary">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0"><i class="fas fa-folder-open me-2"></i>Selecionar Projeto</h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label class="form-label fw-bold">Projeto para Relatório:</label>
                                    <select class="form-select" id="selectProjetoRelatorio" onchange="selecionarProjetoRelatorio()">
                                        <option value="">-- Selecione um projeto --</option>
                                    </select>
                                </div>
                                <div id="infoProjetoRelatorio" class="alert alert-info mb-0" style="display: none;">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <strong>Projeto selecionado:</strong> <span id="nomeProjetoRelatorio"></span><br>
                                    <small><strong>Problema:</strong> <span id="problemaProjetoRelatorio"></span></small>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">Título do Relatório:</label>
                            <input type="text" class="form-control" id="tituloRelatorio" placeholder="Ex: Relatório de Análise - Processo de Produção">
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-bold">Contexto Adicional:</label>
                            <textarea class="form-control" id="contextoRelatorio" rows="3" placeholder="Adicione informações adicionais que devem ser consideradas no relatório..."></textarea>
                        </div>
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Dica:</strong> Selecione um projeto acima para gerar o relatório com base em todas as ferramentas vinculadas a ele. 
                            Você pode solicitar insights adicionais através do campo "Feedback da IA" abaixo.
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header bg-primary text-white">
                            <h5 class="mb-0"><i class="fas fa-file-alt me-2"></i>Relatório Gerado</h5>
                        </div>
                        <div class="card-body">
                            <div id="conteudoRelatorio" style="min-height: 400px; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                                <p class="text-muted text-center">
                                    <i class="fas fa-robot fa-3x mb-3 d-block"></i>
                                    Clique em "Gerar Relatório com IA" para criar um relatório consolidado de todas as etapas.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card mb-4">
                        <div class="card-header bg-info text-white">
                            <h5 class="mb-0"><i class="fas fa-comments me-2"></i>Feedback da IA</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label fw-bold">Solicitar Insights Adicionais:</label>
                                <textarea class="form-control" id="feedbackIA" rows="3" placeholder="Ex: Quais são os principais riscos identificados? Quais ações têm maior probabilidade de sucesso?"></textarea>
                            </div>
                            <button class="btn btn-info" onclick="solicitarFeedbackIA()">
                                <i class="fas fa-paper-plane me-2"></i>Enviar Pergunta para IA
                            </button>
                            <div id="respostaFeedbackIA" class="mt-3" style="display: none;">
                                <div class="alert alert-light border">
                                    <strong>Resposta da IA:</strong>
                                    <div id="conteudoFeedbackIA" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex gap-2">
                        <button class="btn btn-success" onclick="exportarRelatorioPDF()">
                            <i class="fas fa-file-pdf me-2"></i>Exportar PDF
                        </button>
                        <button class="btn btn-primary" onclick="salvarRelatorio()">
                            <i class="fas fa-save me-2"></i>Salvar Relatório
                        </button>
                        <button class="btn btn-secondary" onclick="limparRelatorio()">
                            <i class="fas fa-redo me-2"></i>Limpar
                        </button>
                    </div>
                </div>
            </div>

            <!-- Tab Arquivos -->
            <div class="tab-pane fade" id="tab-arquivos" role="tabpanel">
                <div class="tool-card">
                    <div class="d-flex align-items-center mb-4">
                        <div class="tool-icon">
                            <i class="fas fa-archive"></i>
                        </div>
                        <div class="ms-3">
                            <h3>Ferramentas Arquivadas</h3>
                            <p class="text-muted mb-0">Consulte e gerencie suas ferramentas salvas</p>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="row">
                            <div class="col-md-4">
                                <select class="form-select" id="filtroTipoArquivo">
                                    <option value="">Todos os tipos</option>
                                    <option value="5porques">5 Porquês</option>
                                    <option value="5w2h">5W2H</option>
                                    <option value="ishikawa">Ishikawa</option>
                                    <option value="plano_acao">Plano de Ação</option>
                                    <option value="pdca">PDCA</option>
                                    <option value="brainstorm">Brainstorming</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <select class="form-select" id="filtroArquivado">
                                    <option value="false">Ativas</option>
                                    <option value="true">Arquivadas</option>
                                    <option value="">Todas</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <button class="btn btn-primary w-100" onclick="carregarFerramentasArquivadas()">
                                    <i class="fas fa-search me-2"></i>Filtrar
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="listaFerramentasArquivadas">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script type="module">
        // Importar módulo de orquestração de ferramentas de qualidade com IA
        import { executarFerramenta } from './js/modules/iaTools/index.js';
        
        // Tornar disponível globalmente
        window.executarFerramentaIA = executarFerramenta;
    </script>
    <script>
        // Variáveis globais
        let acoesPlano = [];
        let ideiasBrainstorm = [];
        let ideiasSelecionadas = [];
        let linhas5W2H = [];
        let usuariosPlataforma = [];
        let ferramentaAtualId = null;
        let supabase = null;
        let projetoAtual = null; // Projeto atual sendo trabalhado
        let projetosDisponiveis = []; // Lista de projetos do usuário
        let projetoSelecionadoRelatorio = null; // Projeto selecionado especificamente para o relatório
        
        // Sistema de status das etapas
        let statusEtapas = {
            'swot': 'pendente',
            'brainstorm': 'pendente',
            'forca-impacto': 'pendente',
            'ishikawa': 'pendente',
            '5porques': 'pendente',
            '5w2h': 'pendente',
            'pdca': 'pendente',
            'plano-acao': 'pendente',
            'relatorio': 'pendente'
        };
        
        // Dados compartilhados entre etapas
        let dadosCompartilhados = {
            contexto: '',
            problemas: [],
            causas: [],
            acoes: [],
            prioridades: []
        };
        
        // Inicializar Supabase
        async function inicializarSupabase() {
            try {
                const response = await fetch('/api/supabase-config');
                if (!response.ok) {
                    throw new Error('Erro ao buscar configuração do Supabase');
                }
                
                const config = await response.json();
                supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseAnonKey);
                window.supabase = supabase;
                console.log('✅ Supabase inicializado');
                return true;
            } catch (error) {
                console.warn('⚠️ Erro ao inicializar Supabase:', error);
                return false;
            }
        }
        
        // Obter headers de autenticação
        async function getAuthHeaders() {
            const headers = {
                'Content-Type': 'application/json'
            };
            
            // Tentar obter token do Supabase
            if (supabase) {
                try {
                    const { data: { session } } = await supabase.auth.getSession();
                    if (session && session.access_token) {
                        headers['Authorization'] = `Bearer ${session.access_token}`;
                    }
                } catch (error) {
                    console.warn('⚠️ Erro ao obter sessão:', error);
                }
            }
            
            // Tentar obter email do localStorage
            try {
                const userData = localStorage.getItem('userData');
                if (userData) {
                    const parsed = JSON.parse(userData);
                    if (parsed.email) {
                        headers['X-User-Email'] = parsed.email;
                    }
                }
            } catch (error) {
                console.warn('⚠️ Erro ao obter email do localStorage:', error);
            }
            
            return headers;
        }
        
        // Carregar usuários ao iniciar
        async function carregarUsuarios() {
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/ferramentas-qualidade/usuarios', {
                    headers: headers,
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    console.warn('⚠️ API de usuários não disponível, tentando alternativa...');
                    // Tentar buscar via Supabase diretamente se disponível
                    if (window.supabase) {
                        try {
                            const { data: usuarios, error } = await window.supabase
                                .from('user_profiles')
                                .select('id, nome, email, departamento, cargo')
                                .eq('active', true)
                                .order('nome');
                            
                            if (!error && usuarios) {
                                usuariosPlataforma = usuarios.map(u => ({
                                    id: u.id,
                                    nome: u.nome || u.email || 'Sem nome',
                                    email: u.email,
                                    departamento: u.departamento,
                                    cargo: u.cargo
                                }));
                                console.log('✅ Usuários carregados via Supabase:', usuariosPlataforma.length);
                                return;
                            }
                        } catch (supabaseError) {
                            console.warn('⚠️ Erro ao buscar usuários via Supabase:', supabaseError);
                        }
                    }
                    return;
                }
                
                const data = await response.json();
                if (data.success) {
                    usuariosPlataforma = data.usuarios || [];
                    console.log('✅ Usuários carregados:', usuariosPlataforma.length);
                }
            } catch (error) {
                console.warn('⚠️ Erro ao carregar usuários:', error);
                // Continuar sem usuários se houver erro
                usuariosPlataforma = [];
            }
        }
        
        // Carregar alertas ao iniciar
        async function carregarAlertas() {
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/ferramentas-qualidade/alertas', {
                    headers: headers,
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    // API não disponível, apenas ocultar badge
                    const badge = document.getElementById('badgeAlertas');
                    if (badge) badge.style.display = 'none';
                    return;
                }
                
                const data = await response.json();
                if (data.success && data.alertas) {
                    const alertasVencidos = data.alertas.filter(a => a.status === 'vencido' || a.status === 'em_alerta');
                    const badge = document.getElementById('badgeAlertas');
                    if (badge) {
                        if (alertasVencidos.length > 0) {
                            badge.textContent = alertasVencidos.length;
                            badge.style.display = 'inline-block';
                        } else {
                            badge.style.display = 'none';
                        }
                    }
                }
            } catch (error) {
                console.warn('⚠️ Erro ao carregar alertas:', error);
                // Ocultar badge em caso de erro
                const badge = document.getElementById('badgeAlertas');
                if (badge) badge.style.display = 'none';
            }
        }
        
        // Carregar projetos do usuário
        async function carregarProjetos() {
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/projetos-qualidade', {
                    headers: headers,
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success && data.projetos) {
                        projetosDisponiveis = data.projetos;
                        atualizarSelectProjetos();
                        
                        // Tentar carregar projeto do localStorage
                        const projetoSalvoId = localStorage.getItem('projetoAtualId');
                        if (projetoSalvoId) {
                            const projetoSalvo = projetosDisponiveis.find(p => p.id === projetoSalvoId);
                            if (projetoSalvo) {
                                projetoAtual = projetoSalvo;
                                atualizarInfoProjeto();
                                await carregarFerramentasDoProjeto();
                            }
                        }
                    }
                }
            } catch (error) {
                console.warn('⚠️ Erro ao carregar projetos:', error);
            }
        }
        
        function atualizarSelectProjetos() {
            const select = document.getElementById('selectProjeto');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Criar Novo Projeto --</option>';
            
            projetosDisponiveis.forEach(projeto => {
                const option = document.createElement('option');
                option.value = projeto.id;
                option.textContent = `${projeto.titulo} (${projeto.status})`;
                if (projetoAtual && projeto.id === projetoAtual.id) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
            
            // Atualizar também o select do relatório
            atualizarSelectProjetoRelatorio();
        }
        
        function atualizarSelectProjetoRelatorio() {
            const select = document.getElementById('selectProjetoRelatorio');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- Selecione um projeto --</option>';
            
            projetosDisponiveis.forEach(projeto => {
                const option = document.createElement('option');
                option.value = projeto.id;
                option.textContent = `${projeto.titulo} (${projeto.status})`;
                if (projetoSelecionadoRelatorio && projeto.id === projetoSelecionadoRelatorio.id) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        }
        
        async function selecionarProjetoRelatorio() {
            const select = document.getElementById('selectProjetoRelatorio');
            const projetoId = select.value;
            
            if (!projetoId) {
                projetoSelecionadoRelatorio = null;
                const infoDiv = document.getElementById('infoProjetoRelatorio');
                if (infoDiv) infoDiv.style.display = 'none';
                return;
            }
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`/api/projetos-qualidade/${projetoId}`, {
                    headers: headers,
                    credentials: 'include'
                });
                
                const data = await response.json();
                if (data.success && data.projeto) {
                    projetoSelecionadoRelatorio = data.projeto;
                    
                    // Atualizar informações exibidas
                    const infoDiv = document.getElementById('infoProjetoRelatorio');
                    const nomeSpan = document.getElementById('nomeProjetoRelatorio');
                    const problemaSpan = document.getElementById('problemaProjetoRelatorio');
                    
                    if (infoDiv && nomeSpan && problemaSpan) {
                        nomeSpan.textContent = projetoSelecionadoRelatorio.titulo;
                        problemaSpan.textContent = projetoSelecionadoRelatorio.problema || 'Não especificado';
                        infoDiv.style.display = 'block';
                    }
                    
                    // Preencher título do relatório se estiver vazio
                    const tituloRelatorio = document.getElementById('tituloRelatorio');
                    if (tituloRelatorio && !tituloRelatorio.value) {
                        tituloRelatorio.value = `Relatório - ${projetoSelecionadoRelatorio.titulo}`;
                    }
                } else {
                    alert('❌ Erro ao carregar projeto: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao selecionar projeto para relatório:', error);
                alert('❌ Erro ao selecionar projeto: ' + error.message);
            }
        }
        
        async function criarNovoProjeto() {
            const titulo = document.getElementById('novoProjetoTitulo').value.trim();
            if (!titulo) {
                alert('Por favor, informe o título do projeto.');
                return;
            }
            
            const problema = prompt('Descreva o problema que será analisado neste projeto:');
            if (problema === null) return; // Usuário cancelou
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/projetos-qualidade', {
                    method: 'POST',
                    headers: { ...headers, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        titulo: titulo,
                        problema: problema || null,
                        descricao: null
                    }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                if (data.success && data.projeto) {
                    projetoAtual = data.projeto;
                    projetosDisponiveis.unshift(projetoAtual);
                    atualizarSelectProjetos();
                    atualizarInfoProjeto();
                    document.getElementById('novoProjetoTitulo').value = '';
                    localStorage.setItem('projetoAtualId', projetoAtual.id);
                    alert('✅ Projeto criado com sucesso!');
                } else {
                    alert('❌ Erro ao criar projeto: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao criar projeto:', error);
                alert('❌ Erro ao criar projeto: ' + error.message);
            }
        }
        
        async function selecionarProjeto() {
            const select = document.getElementById('selectProjeto');
            const projetoId = select.value;
            
            if (!projetoId) {
                projetoAtual = null;
                atualizarInfoProjeto();
                localStorage.removeItem('projetoAtualId');
                
                // Limpar dados quando não há projeto selecionado
                limparTodosDados();
                return;
            }
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`/api/projetos-qualidade/${projetoId}`, {
                    headers: headers,
                    credentials: 'include'
                });
                
                const data = await response.json();
                if (data.success && data.projeto) {
                    projetoAtual = data.projeto;
                    atualizarInfoProjeto();
                    
                    // Mostrar loading
                    const infoDiv = document.getElementById('infoProjetoAtual');
                    if (infoDiv) {
                        const loadingMsg = document.createElement('div');
                        loadingMsg.className = 'alert alert-info mt-2 mb-0';
                        loadingMsg.id = 'loadingFerramentas';
                        loadingMsg.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Carregando ferramentas do projeto...';
                        infoDiv.appendChild(loadingMsg);
                    }
                    
                    // Carregar ferramentas do projeto
                    const quantidadeFerramentas = await carregarFerramentasDoProjeto();
                    
                    // Remover loading
                    const loadingMsg = document.getElementById('loadingFerramentas');
                    if (loadingMsg) loadingMsg.remove();
                    
                    // Mostrar mensagem baseada na quantidade de ferramentas
                    if (infoDiv) {
                        if (quantidadeFerramentas > 0) {
                            // Mostrar mensagem de sucesso
                            const successMsg = document.createElement('div');
                            successMsg.className = 'alert alert-success mt-2 mb-0';
                            successMsg.innerHTML = `<i class="fas fa-check-circle me-2"></i>${quantidadeFerramentas} ferramenta(s) carregada(s)! Você pode usar os botões "Importar" nas ferramentas.`;
                            infoDiv.appendChild(successMsg);
                            setTimeout(() => successMsg.remove(), 5000);
                        } else {
                            // Mostrar mensagem informativa
                            const infoMsg = document.createElement('div');
                            infoMsg.className = 'alert alert-info mt-2 mb-0';
                            infoMsg.innerHTML = `<i class="fas fa-info-circle me-2"></i>Projeto selecionado. Comece preenchendo as ferramentas e salvando-as para vinculá-las ao projeto.`;
                            infoDiv.appendChild(infoMsg);
                            setTimeout(() => infoMsg.remove(), 5000);
                        }
                    }
                    
                    localStorage.setItem('projetoAtualId', projetoAtual.id);
                } else {
                    alert('❌ Erro ao carregar projeto: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao selecionar projeto:', error);
                alert('❌ Erro ao selecionar projeto: ' + error.message);
            }
        }
        
        function limparTodosDados() {
            // Limpar variáveis globais
            ideiasBrainstorm = [];
            ideiasSelecionadas = [];
            itensPriorizacao = [];
            acoesPlano = [];
            linhas5W2H = [];
            
            // Limpar campos de formulário (opcional - pode ser agressivo)
            // Por enquanto, apenas limpar variáveis para não perder dados não salvos
        }
        
        function atualizarInfoProjeto() {
            const infoDiv = document.getElementById('infoProjetoAtual');
            const nomeSpan = document.getElementById('nomeProjetoAtual');
            const problemaSpan = document.getElementById('problemaProjetoAtual');
            
            if (projetoAtual && infoDiv && nomeSpan && problemaSpan) {
                infoDiv.style.display = 'block';
                nomeSpan.textContent = projetoAtual.titulo;
                problemaSpan.textContent = projetoAtual.problema || 'Não especificado';
            } else if (infoDiv) {
                infoDiv.style.display = 'none';
            }
        }
        
        async function carregarFerramentasDoProjeto() {
            if (!projetoAtual) return 0;
            
            console.log('📥 Carregando ferramentas do projeto:', projetoAtual.titulo);
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`/api/projetos-qualidade/${projetoAtual.id}`, {
                    headers: headers,
                    credentials: 'include'
                });
                
                const data = await response.json();
                if (data.success && data.projeto) {
                    const ferramentas = data.projeto.ferramentas || [];
                    console.log(`✅ Encontradas ${ferramentas.length} ferramentas no projeto`);
                    
                    if (ferramentas.length > 0) {
                        // Carregar cada ferramenta nas variáveis globais e preencher campos
                        for (const ferramenta of ferramentas) {
                            await carregarDadosFerramenta(ferramenta);
                        }
                        
                        // Atualizar status das etapas baseado nas ferramentas carregadas
                        atualizarStatusEtapasDoProjeto(ferramentas);
                        
                        // Atualizar progresso geral
                        atualizarProgressoGeral();
                        
                        console.log('✅ Ferramentas do projeto carregadas com sucesso');
                    } else {
                        console.log('ℹ️ Projeto selecionado, mas ainda não possui ferramentas salvas.');
                    }
                    
                    return ferramentas.length;
                } else {
                    console.warn('⚠️ Erro ao carregar projeto:', data.error || 'Erro desconhecido');
                    return 0;
                }
            } catch (error) {
                console.error('❌ Erro ao carregar ferramentas do projeto:', error);
                return 0;
            }
        }
        
        async function carregarDadosFerramenta(ferramenta) {
            try {
                const tipo = ferramenta.tipo_ferramenta;
                const dados = ferramenta.dados || {};
                
                switch (tipo) {
                    case 'swot':
                        document.getElementById('tituloSwot').value = ferramenta.titulo || '';
                        document.getElementById('contextoSwot').value = dados.contexto || '';
                        
                        // Preencher itens SWOT
                        if (dados.itens) {
                            const itens = dados.itens;
                            ['forcas', 'fraquezas', 'oportunidades', 'ameacas'].forEach(quadrante => {
                                if (itens[quadrante] && Array.isArray(itens[quadrante])) {
                                    itens[quadrante].forEach((item, idx) => {
                                        if (idx === 0) {
                                            // Primeiro item já existe, apenas preencher
                                            const input = document.querySelector(`.swot-item[data-quadrante="${quadrante}"]`);
                                            if (input) input.value = item;
                                        } else {
                                            // Adicionar novos campos
                                            adicionarItemSwot(quadrante);
                                            setTimeout(() => {
                                                const inputs = document.querySelectorAll(`.swot-item[data-quadrante="${quadrante}"]`);
                                                if (inputs[idx]) inputs[idx].value = item;
                                            }, 50);
                                        }
                                    });
                                }
                            });
                        }
                        break;
                        
                    case 'brainstorm':
                        document.getElementById('temaBrainstorm').value = dados.tema || ferramenta.titulo || '';
                        document.getElementById('objetivoBrainstorm').value = dados.objetivo || '';
                        
                        // Normalizar formato das ideias (pode vir como array de strings ou objetos)
                        if (dados.ideias && Array.isArray(dados.ideias)) {
                            ideiasBrainstorm = dados.ideias.map((ideia, idx) => {
                                if (typeof ideia === 'string') {
                                    return { id: Date.now() + idx, texto: ideia };
                                } else if (ideia.texto) {
                                    return { id: ideia.id || Date.now() + idx, texto: ideia.texto };
                                } else {
                                    return { id: Date.now() + idx, texto: String(ideia) };
                                }
                            });
                        } else {
                            ideiasBrainstorm = [];
                        }
                        
                        // Carregar ideias selecionadas se existirem
                        if (dados.ideias_selecionadas && Array.isArray(dados.ideias_selecionadas)) {
                            ideiasSelecionadas = dados.ideias_selecionadas;
                        } else {
                            ideiasSelecionadas = [];
                        }
                        
                        renderizarIdeias();
                        renderizarIdeiasSelecionadas();
                        console.log(`✅ Brainstorming carregado: ${ideiasBrainstorm.length} ideias`);
                        break;
                        
                    case 'forca_impacto':
                        document.getElementById('tituloForcaImpacto').value = ferramenta.titulo || '';
                        document.getElementById('descricaoForcaImpacto').value = dados.descricao || '';
                        itensPriorizacao = dados.itens || [];
                        renderizarItensPriorizacao();
                        atualizarMatrizGrafico();
                        break;
                        
                    case 'ishikawa':
                        document.getElementById('tituloIshikawa').value = ferramenta.titulo || '';
                        document.getElementById('problemaIshikawa').value = dados.problema || '';
                        if (dados.categorias) {
                            // Verificar se é array (formato novo) ou objeto (formato antigo)
                            if (Array.isArray(dados.categorias)) {
                                // Formato novo: array de objetos com nome e causas
                                const mapeamentoCategorias = {
                                    'Método': 'ishikawa-metodo',
                                    'Mão de Obra': 'ishikawa-maoobra',
                                    'Material': 'ishikawa-material',
                                    'Máquina': 'ishikawa-maquina',
                                    'Meio Ambiente': 'ishikawa-meioambiente',
                                    'Medição': 'ishikawa-medicao'
                                };
                                
                                dados.categorias.forEach(cat => {
                                    const campoId = mapeamentoCategorias[cat.nome];
                                    if (campoId) {
                                        const campo = document.getElementById(campoId);
                                        if (campo) {
                                            campo.value = cat.causas?.join('\n') || '';
                                        }
                                    }
                                });
                            } else {
                                // Formato antigo: objeto com chaves sendo nomes de categorias
                                Object.keys(dados.categorias).forEach(categoria => {
                                    const campoId = `ishikawa-${categoria.toLowerCase().replace(/\s+/g, '')}`;
                                    const campo = document.getElementById(campoId);
                                    if (campo && dados.categorias[categoria]) {
                                        campo.value = Array.isArray(dados.categorias[categoria]) 
                                            ? dados.categorias[categoria].join('\n')
                                            : dados.categorias[categoria];
                                    }
                                });
                            }
                        }
                        break;
                        
                    case '5porques':
                        document.getElementById('titulo5porques').value = ferramenta.titulo || '';
                        document.getElementById('problema5porques').value = dados.problema || '';
                        if (dados.porques && Array.isArray(dados.porques)) {
                            dados.porques.forEach((porque, index) => {
                                const campo = document.getElementById(`porque${index + 1}`);
                                if (campo) campo.value = porque;
                            });
                        }
                        break;
                        
                    case '5w2h':
                        document.getElementById('titulo5w2h').value = ferramenta.titulo || '';
                        linhas5W2H = dados.linhas || [];
                        if (usuariosPlataforma.length === 0) {
                            await carregarUsuarios();
                        }
                        renderizarLinhas5W2H();
                        break;
                        
                    case 'pdca':
                        document.getElementById('tituloPDCA').value = ferramenta.titulo || '';
                        if (dados.problema) document.getElementById('pdca-problema').value = dados.problema;
                        if (dados.plan) document.getElementById('pdca-plan').value = dados.plan;
                        if (dados.do) document.getElementById('pdca-do').value = dados.do;
                        if (dados.check) document.getElementById('pdca-check').value = dados.check;
                        if (dados.act) document.getElementById('pdca-act').value = dados.act;
                        break;
                        
                    case 'plano_acao':
                        document.getElementById('tituloPlano').value = ferramenta.titulo || '';
                        document.getElementById('objetivoPlano').value = dados.objetivo || '';
                        acoesPlano = dados.acoes || [];
                        if (usuariosPlataforma.length === 0) {
                            await carregarUsuarios();
                        }
                        renderizarAcoes();
                        atualizarAlertasPlano();
                        break;
                        
                    case 'relatorio':
                        document.getElementById('tituloRelatorio').value = ferramenta.titulo || '';
                        document.getElementById('contextoRelatorio').value = dados.contexto || '';
                        if (dados.conteudo) {
                            document.getElementById('conteudoRelatorio').innerHTML = dados.conteudo;
                        }
                        break;
                }
            } catch (error) {
                console.error(`❌ Erro ao carregar dados da ferramenta ${ferramenta.tipo_ferramenta}:`, error);
            }
        }
        
        function atualizarStatusEtapasDoProjeto(ferramentas) {
            // Mapear tipos de ferramentas para etapas
            const mapeamentoTipos = {
                'swot': 'swot',
                'brainstorm': 'brainstorm',
                'forca_impacto': 'forca-impacto',
                'ishikawa': 'ishikawa',
                '5porques': '5porques',
                '5w2h': '5w2h',
                'pdca': 'pdca',
                'plano_acao': 'plano-acao',
                'relatorio': 'relatorio'
            };
            
            // Marcar etapas como concluídas se houver ferramenta correspondente
            ferramentas.forEach(ferramenta => {
                const etapa = mapeamentoTipos[ferramenta.tipo_ferramenta];
                if (etapa && statusEtapas.hasOwnProperty(etapa)) {
                    statusEtapas[etapa] = 'concluido';
                    atualizarStatusEtapa(etapa, 'concluido');
                }
            });
            
            // Salvar status atualizado
            salvarStatusEtapas();
        }
        
        // Verificar se há projeto antes de permitir ações
        function verificarProjeto() {
            if (!projetoAtual) {
                alert('⚠️ Por favor, selecione ou crie um projeto antes de usar as ferramentas.');
                return false;
            }
            return true;
        }
        
        // Inicialização
        document.addEventListener('DOMContentLoaded', async () => {
            // Carregar status das etapas salvas
            carregarStatusEtapas();
            
            // Inicializar Supabase primeiro
            await inicializarSupabase();
            
            // Carregar usuários (tentará API primeiro, depois Supabase direto)
            await carregarUsuarios();
            
            // Carregar projetos do usuário
            await carregarProjetos();
            
            // Carregar alertas (não crítico, apenas oculta badge se falhar)
            await carregarAlertas();
            setInterval(carregarAlertas, 60000);
            
            // Atualizar progresso inicial
            atualizarProgressoGeral();
            
            // Verificar se há ID na URL para carregar ferramenta
            const urlParams = new URLSearchParams(window.location.search);
            const ferramentaId = urlParams.get('id');
            if (ferramentaId) {
                console.log('📥 Carregando ferramenta da URL:', ferramentaId);
                await carregarFerramenta(ferramentaId);
            } else {
                // Comportamento normal: adicionar linha inicial do 5W2H
                adicionarLinha5W2H();
            }
            
            // Listener para aba de arquivos
            const tabArquivos = document.querySelector('[data-bs-target="#tab-arquivos"]');
            if (tabArquivos) {
                tabArquivos.addEventListener('shown.bs.tab', () => {
                    carregarFerramentasArquivadas();
                });
            }
            
            // Listener para aba de Relatório IA - carregar projetos quando abrir
            const tabRelatorio = document.querySelector('[data-bs-target="#tab-relatorio"]');
            if (tabRelatorio) {
                tabRelatorio.addEventListener('shown.bs.tab', () => {
                    // Atualizar select de projetos do relatório
                    atualizarSelectProjetoRelatorio();
                });
            }
            
            // Listener para aba de Plano de Ação - garantir que usuários estejam carregados
            const tabPlanoAcao = document.querySelector('[data-bs-target="#tab-plano-acao"]');
            if (tabPlanoAcao) {
                tabPlanoAcao.addEventListener('shown.bs.tab', async () => {
                    // Se não houver usuários carregados, tentar recarregar
                    if (usuariosPlataforma.length === 0) {
                        console.log('🔄 Recarregando usuários ao abrir Plano de Ação...');
                        await carregarUsuarios();
                        // Re-renderizar ações para atualizar os selects
                        if (acoesPlano.length > 0) {
                            renderizarAcoes();
                        }
                    }
                });
            }
            
            // Listener para aba de 5W2H - garantir que usuários estejam carregados
            const tab5W2H = document.querySelector('[data-bs-target="#tab-5w2h"]');
            if (tab5W2H) {
                tab5W2H.addEventListener('shown.bs.tab', async () => {
                    // Se não houver usuários carregados, tentar recarregar
                    if (usuariosPlataforma.length === 0) {
                        console.log('🔄 Recarregando usuários ao abrir 5W2H...');
                        await carregarUsuarios();
                        // Re-renderizar linhas para atualizar os selects
                        if (linhas5W2H.length > 0) {
                            renderizarLinhas5W2H();
                        }
                    }
                });
            }
            
            // Permitir Enter no input de ideias
            const inputIdeia = document.getElementById('novaIdeia');
            if (inputIdeia) {
                inputIdeia.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        adicionarIdeia();
                    }
                });
            }
        });
        
        // Função para formatar valor monetário
        function formatarMoeda(inputId) {
            const input = document.getElementById(inputId);
            if (!input) return;
            
            let valor = input.value;
            if (!valor) return;
            
            // Remover caracteres não numéricos exceto ponto e vírgula
            valor = valor.toString().replace(/[^\d,.-]/g, '');
            
            // Converter vírgula para ponto se necessário
            valor = valor.replace(',', '.');
            
            // Garantir que seja um número válido
            const numValor = parseFloat(valor);
            if (isNaN(numValor)) {
                input.value = '';
                return;
            }
            
            // Atualizar o valor no input (mantém como número para cálculos)
            input.value = numValor;
        }
        
        // Função para formatar exibição de moeda
        function formatarExibicaoMoeda(valor) {
            if (!valor && valor !== 0) return '-';
            const numValor = parseFloat(valor.toString().replace(/[^\d,.-]/g, '').replace(',', '.'));
            if (isNaN(numValor)) return valor;
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(numValor);
        }
        
        // Função para formatar data (versão completa para 5W2H)
        function formatarData5W2H(data) {
            if (!data) return '-';
            try {
                // Se for uma string no formato YYYY-MM-DD (do input date), converter
                if (typeof data === 'string' && data.match(/^\d{4}-\d{2}-\d{2}$/)) {
                    const [ano, mes, dia] = data.split('-');
                    return `${dia}/${mes}/${ano}`;
                }
                const dataObj = new Date(data);
                if (isNaN(dataObj.getTime())) return data;
                return dataObj.toLocaleDateString('pt-BR');
            } catch (e) {
                return data;
            }
        }
        
        // Função auxiliar para calcular dias restantes
        function calcularDiasRestantes(prazo) {
            if (!prazo) return null;
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            const prazoDate = new Date(prazo);
            prazoDate.setHours(0, 0, 0, 0);
            const diff = Math.floor((prazoDate - hoje) / (1000 * 60 * 60 * 24));
            return diff;
        }
        
        // Função auxiliar para formatar status de prazo
        function formatarStatusPrazo(dias) {
            if (dias === null) return { texto: '-', classe: 'text-muted' };
            if (dias < 0) return { texto: `${Math.abs(dias)} dias atrasado`, classe: 'text-danger fw-bold' };
            if (dias === 0) return { texto: 'Vence hoje', classe: 'text-warning fw-bold' };
            if (dias <= 3) return { texto: `${dias} dias restantes`, classe: 'text-warning' };
            return { texto: `${dias} dias restantes`, classe: 'text-success' };
        }

        // ========== 5 PORQUÊS ==========
        function exportar5Porques() {
            const problema = document.getElementById('problema5porques').value;
            const porques = [
                document.getElementById('porque1').value,
                document.getElementById('porque2').value,
                document.getElementById('porque3').value,
                document.getElementById('porque4').value,
                document.getElementById('porque5').value
            ];
            const causaRaiz = document.getElementById('causaRaiz').value;
            
            const conteudo = `
                <h2>Análise 5 Porquês</h2>
                <h3>Problema: ${problema}</h3>
                <ol>
                    ${porques.map((p, i) => `<li><strong>${i+1}º Por quê?</strong> ${p || 'Não preenchido'}</li>`).join('')}
                </ol>
                <h3>Causa Raiz Identificada:</h3>
                <p>${causaRaiz || 'Não identificada'}</p>
            `;
            
            imprimirConteudo(conteudo, 'Análise 5 Porquês');
        }

        function limpar5Porques() {
            document.getElementById('titulo5porques').value = '';
            document.getElementById('problema5porques').value = '';
            document.getElementById('porque1').value = '';
            document.getElementById('porque2').value = '';
            document.getElementById('porque3').value = '';
            document.getElementById('porque4').value = '';
            document.getElementById('porque5').value = '';
            document.getElementById('causaRaiz').value = '';
            ferramentaAtualId = null;
        }
        
        async function salvar5Porques() {
            if (!verificarProjeto()) return;
            
            const titulo = document.getElementById('titulo5porques').value;
            const problema = document.getElementById('problema5porques').value;
            
            if (!titulo && !problema) {
                alert('Por favor, preencha pelo menos o título ou o problema.');
                return;
            }
            
            const porques = [
                document.getElementById('porque1').value.trim(),
                document.getElementById('porque2').value.trim(),
                document.getElementById('porque3').value.trim(),
                document.getElementById('porque4').value.trim(),
                document.getElementById('porque5').value.trim()
            ].filter(p => p); // Filtrar strings vazias
            
            const dados = {
                problema: problema,
                porques: porques,
                causa_raiz: document.getElementById('causaRaiz').value.trim()
            };
            
            const tituloFinal = titulo || `5 Porquês: ${problema || 'Sem título'}`;
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/ferramentas-qualidade', {
                    method: 'POST',
                    headers: { ...headers, 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        id: ferramentaAtualId,
                        tipo_ferramenta: '5porques',
                        titulo: tituloFinal,
                        dados: dados,
                        projeto_id: projetoAtual?.id || null
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    ferramentaAtualId = data.ferramenta.id;
                    alert('✅ 5 Porquês salvo com sucesso!');
                    atualizarStatusEtapa('5porques', 'concluido');
                    salvarStatusEtapas();
                } else {
                    alert('❌ Erro ao salvar: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('❌ Erro ao salvar 5 Porquês:', error);
                alert('❌ Erro ao salvar 5 Porquês: ' + error.message);
            }
        }

        // ========== 5W2H ==========
        function adicionarLinha5W2H() {
            const linha = {
                id: Date.now(),
                what: '',
                why: '',
                where: '',
                when: '',
                who: '',
                how: '',
                howMuch: '',
                howMany: ''
            };
            linhas5W2H.push(linha);
            renderizarLinhas5W2H();
        }
        
        function removerLinha5W2H(id) {
            linhas5W2H = linhas5W2H.filter(l => l.id !== id);
            renderizarLinhas5W2H();
        }
        
        function atualizarLinha5W2H(id, campo, valor) {
            const linha = linhas5W2H.find(l => l.id === id);
            if (linha) {
                linha[campo] = valor;
                
                // Se o campo for "who", sincronizar select e input
                if (campo === 'who') {
                    const selectElement = document.getElementById(`who-select-${id}`);
                    const inputElement = document.getElementById(`who-input-${id}`);
                    
                    // Se um usuário foi selecionado no dropdown, limpar o input de texto
                    if (selectElement && selectElement.value === valor && usuariosPlataforma.find(u => u.id === valor)) {
                        if (inputElement) {
                            inputElement.value = '';
                        }
                    }
                    
                    // Se um texto foi digitado no input, limpar o select
                    if (inputElement && inputElement.value === valor && !usuariosPlataforma.find(u => u.id === valor)) {
                        if (selectElement) {
                            selectElement.value = '';
                        }
                    }
                }
            }
        }
        
        function renderizarLinhas5W2H() {
            const container = document.getElementById('linhas5w2h');
            container.innerHTML = '';
            
            linhas5W2H.forEach((linha, index) => {
                const div = document.createElement('div');
                div.className = 'card mb-3';
                div.innerHTML = `
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <strong>Linha ${index + 1}</strong>
                        <button class="btn btn-sm btn-danger" onclick="removerLinha5W2H(${linha.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row g-2">
                            <div class="col-md-6">
                                <label class="form-label small">O QUÊ (What)?</label>
                                <input type="text" class="form-control form-control-sm" 
                                       value="${linha.what || ''}" 
                                       onchange="atualizarLinha5W2H(${linha.id}, 'what', this.value)">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">POR QUÊ (Why)?</label>
                                <input type="text" class="form-control form-control-sm" 
                                       value="${linha.why || ''}" 
                                       onchange="atualizarLinha5W2H(${linha.id}, 'why', this.value)">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">ONDE (Where)?</label>
                                <input type="text" class="form-control form-control-sm" 
                                       value="${linha.where || ''}" 
                                       onchange="atualizarLinha5W2H(${linha.id}, 'where', this.value)">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">QUANDO (When)?</label>
                                <input type="date" class="form-control form-control-sm" 
                                       id="when-${linha.id}"
                                       value="${linha.when ? (typeof linha.when === 'string' && linha.when.match(/^\d{4}-\d{2}-\d{2}$/) ? linha.when : new Date(linha.when).toISOString().split('T')[0]) : ''}" 
                                       onchange="atualizarLinha5W2H(${linha.id}, 'when', this.value)">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">QUEM (Who)?</label>
                                <select class="form-select form-select-sm" 
                                        id="who-select-${linha.id}"
                                       onchange="atualizarLinha5W2H(${linha.id}, 'who', this.value)">
                                    <option value="">Selecione um usuário...</option>
                                    ${usuariosPlataforma.map(u => `
                                        <option value="${u.id}" ${linha.who === u.id ? 'selected' : ''}>
                                            ${u.nome}${u.departamento ? ' - ' + u.departamento : ''}
                                        </option>
                                    `).join('')}
                                </select>
                                ${!linha.who || !usuariosPlataforma.find(u => u.id === linha.who) ? `
                                    <input type="text" class="form-control form-control-sm mt-1" 
                                           id="who-input-${linha.id}"
                                           value="${(linha.who && !usuariosPlataforma.find(u => u.id === linha.who) ? linha.who : '').replace(/"/g, "&quot;")}" 
                                           placeholder="Ou digite o nome do responsável"
                                           onchange="atualizarLinha5W2H(${linha.id}, 'who', this.value)">
                                ` : ''}
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">COMO (How)?</label>
                                <input type="text" class="form-control form-control-sm" 
                                       value="${linha.how || ''}" 
                                       onchange="atualizarLinha5W2H(${linha.id}, 'how', this.value)">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">QUANTO (How much)?</label>
                                <div class="input-group input-group-sm">
                                    <span class="input-group-text">R$</span>
                                    <input type="number" class="form-control" 
                                           id="howMuch-${linha.id}"
                                           step="0.01" 
                                           min="0" 
                                           placeholder="0,00"
                                           value="${linha.howMuch ? parseFloat(linha.howMuch.toString().replace(/[^\d,.-]/g, '').replace(',', '.')) || '' : ''}" 
                                           onchange="atualizarLinha5W2H(${linha.id}, 'howMuch', this.value)"
                                           onblur="formatarMoeda('howMuch-${linha.id}')">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">QUANTIDADE (How many)?</label>
                                <input type="number" class="form-control form-control-sm" 
                                       id="howMany-${linha.id}"
                                       step="1" 
                                       min="0" 
                                       placeholder="0"
                                       value="${linha.howMany || ''}" 
                                       onchange="atualizarLinha5W2H(${linha.id}, 'howMany', this.value)">
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }
        
        async function salvar5W2H() {
            if (!verificarProjeto()) return;
            
            const titulo = document.getElementById('titulo5w2h').value;
            if (!titulo) {
                alert('Por favor, preencha o título do 5W2H.');
                return;
            }
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/ferramentas-qualidade', {
                    method: 'POST',
                    headers: { ...headers, 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        id: ferramentaAtualId,
                        tipo_ferramenta: '5w2h',
                        titulo: titulo,
                        dados: { linhas: linhas5W2H },
                        projeto_id: projetoAtual?.id || null
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    ferramentaAtualId = data.ferramenta.id;
                    alert('✅ 5W2H salvo com sucesso!');
                    atualizarStatusEtapa('5w2h', 'concluido');
                    salvarStatusEtapas();
                } else {
                    alert('❌ Erro ao salvar: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('❌ Erro ao salvar 5W2H:', error);
                alert('❌ Erro ao salvar 5W2H.');
            }
        }
        
        function exportar5W2H() {
            const titulo = document.getElementById('titulo5w2h').value || 'Análise 5W2H';
            
            let htmlLinhas = linhas5W2H.map((linha, index) => `
                <tr>
                    <td><strong>Linha ${index + 1}</strong></td>
                    <td>${linha.what || '-'}</td>
                    <td>${linha.why || '-'}</td>
                    <td>${linha.where || '-'}</td>
                    <td>${formatarData5W2H(linha.when)}</td>
                    <td>${(linha.who && usuariosPlataforma.find(u => u.id === linha.who) ? usuariosPlataforma.find(u => u.id === linha.who).nome : linha.who) || '-'}</td>
                    <td>${linha.how || '-'}</td>
                    <td>${formatarExibicaoMoeda(linha.howMuch)}</td>
                    <td>${linha.howMany || '-'}</td>
                </tr>
            `).join('');
            
            const conteudo = `
                <h2>${titulo}</h2>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>O QUÊ</th>
                            <th>POR QUÊ</th>
                            <th>ONDE</th>
                            <th>QUANDO</th>
                            <th>QUEM</th>
                            <th>COMO</th>
                            <th>QUANTO</th>
                            <th>QUANTIDADE</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${htmlLinhas || '<tr><td colspan="9">Nenhuma linha cadastrada</td></tr>'}
                    </tbody>
                </table>
            `;
            
            imprimirConteudo(conteudo, titulo);
        }

        function limpar5W2H() {
            document.getElementById('titulo5w2h').value = '';
            linhas5W2H = [];
            ferramentaAtualId = null;
            renderizarLinhas5W2H();
            adicionarLinha5W2H();
        }

        // ========== ISHIKAWA ==========
        function visualizarIshikawa() {
            const problema = document.getElementById('problemaIshikawa').value;
            if (!problema) {
                alert('Por favor, preencha o problema primeiro.');
                return;
            }
            
            const container = document.getElementById('ishikawa-diagram-container');
            container.style.display = 'block';
            
            const svg = document.getElementById('ishikawa-svg');
            svg.innerHTML = '';
            
            const width = 1400;
            const height = 800;
            svg.setAttribute('width', width);
            svg.setAttribute('height', height);
            svg.setAttribute('viewBox', `0 0 ${width} ${height}`);
            
            // Fundo branco para o SVG
            const bg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
            bg.setAttribute('width', width);
            bg.setAttribute('height', height);
            bg.setAttribute('fill', 'white');
            svg.appendChild(bg);
            
            const centerY = height / 2;
            const spineStartX = 200;
            const spineEndX = width - 120;
            
            // Desenhar espinha principal (horizontal da esquerda para direita)
            const spine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            spine.setAttribute('x1', spineStartX);
            spine.setAttribute('y1', centerY);
            spine.setAttribute('x2', spineEndX);
            spine.setAttribute('y2', centerY);
            spine.setAttribute('class', 'fishbone-spine');
            svg.appendChild(spine);
            
            // Desenhar cabeça do peixe (forma mais realista com polígono)
            const headWidth = 160;
            const headHeight = 90;
            const headX = spineEndX;
            const headY = centerY - headHeight / 2;
            
            // Cabeça do peixe em forma de losango/polígono
            const fishHead = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            const headPoints = [
                `${headX},${centerY}`, // Ponto na espinha (esquerda)
                `${headX + headWidth},${headY}`, // Topo direito
                `${headX + headWidth + 15},${centerY}`, // Ponto mais à direita (boca)
                `${headX + headWidth},${headY + headHeight}` // Fundo direito
            ].join(' ');
            fishHead.setAttribute('points', headPoints);
            fishHead.setAttribute('class', 'fishbone-effect-box');
            svg.appendChild(fishHead);
            
            // Adicionar boca do peixe
            const mouth = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            const mouthPoints = [
                `${headX + headWidth + 15},${centerY}`,
                `${headX + headWidth + 25},${centerY - 8}`,
                `${headX + headWidth + 25},${centerY + 8}`
            ].join(' ');
            mouth.setAttribute('points', mouthPoints);
            mouth.setAttribute('fill', '#c0392b');
            mouth.setAttribute('stroke', '#a93226');
            mouth.setAttribute('stroke-width', '2');
            svg.appendChild(mouth);
            
            // Adicionar olho do peixe com destaque
            const eyeOuter = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            eyeOuter.setAttribute('cx', headX + headWidth - 25);
            eyeOuter.setAttribute('cy', centerY - 18);
            eyeOuter.setAttribute('r', 10);
            eyeOuter.setAttribute('fill', '#ffffff');
            eyeOuter.setAttribute('class', 'fishbone-eye');
            svg.appendChild(eyeOuter);
            
            const eyeInner = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            eyeInner.setAttribute('cx', headX + headWidth - 25);
            eyeInner.setAttribute('cy', centerY - 18);
            eyeInner.setAttribute('r', 6);
            eyeInner.setAttribute('fill', '#2c3e50');
            svg.appendChild(eyeInner);
            
            const eyePupil = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            eyePupil.setAttribute('cx', headX + headWidth - 25);
            eyePupil.setAttribute('cy', centerY - 18);
            eyePupil.setAttribute('r', 3);
            eyePupil.setAttribute('fill', '#000000');
            svg.appendChild(eyePupil);
            
            // Adicionar brilho no olho
            const eyeShine = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            eyeShine.setAttribute('cx', headX + headWidth - 23);
            eyeShine.setAttribute('cy', centerY - 20);
            eyeShine.setAttribute('r', 2);
            eyeShine.setAttribute('fill', '#ffffff');
            svg.appendChild(eyeShine);
            
            // Adicionar nadadeira superior
            const finTop = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            const finTopPoints = [
                `${headX + headWidth - 20},${headY}`,
                `${headX + headWidth - 5},${headY - 25}`,
                `${headX + headWidth + 10},${headY - 15}`
            ].join(' ');
            finTop.setAttribute('points', finTopPoints);
            finTop.setAttribute('class', 'fishbone-fin');
            svg.appendChild(finTop);
            
            // Adicionar nadadeira inferior
            const finBottom = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            const finBottomPoints = [
                `${headX + headWidth - 20},${headY + headHeight}`,
                `${headX + headWidth - 5},${headY + headHeight + 25}`,
                `${headX + headWidth + 10},${headY + headHeight + 15}`
            ].join(' ');
            finBottom.setAttribute('points', finBottomPoints);
            finBottom.setAttribute('class', 'fishbone-fin');
            svg.appendChild(finBottom);
            
            // Texto do problema dentro da cabeça
            const textoEfeito = document.createElementNS('http://www.w3.org/2000/svg', 'text');
            textoEfeito.setAttribute('x', headX + headWidth / 2 + 5);
            textoEfeito.setAttribute('y', centerY);
            textoEfeito.setAttribute('class', 'fishbone-effect-text');
            textoEfeito.setAttribute('text-anchor', 'middle');
            textoEfeito.setAttribute('dominant-baseline', 'middle');
            // Quebrar texto em múltiplas linhas se necessário (ajustado para cabeça maior)
            const palavras = problema.split(' ');
            let linhas = [];
            let linhaAtual = '';
            palavras.forEach(palavra => {
                if ((linhaAtual + palavra).length > 20) {
                    if (linhaAtual) linhas.push(linhaAtual);
                    linhaAtual = palavra;
                } else {
                    linhaAtual += (linhaAtual ? ' ' : '') + palavra;
                }
            });
            if (linhaAtual) linhas.push(linhaAtual);
            
            linhas.forEach((linha, i) => {
                const tspan = document.createElementNS('http://www.w3.org/2000/svg', 'tspan');
                tspan.setAttribute('x', headX + headWidth / 2 + 5);
                tspan.setAttribute('dy', i === 0 ? (linhas.length === 1 ? 0 : -8) : 18);
                tspan.textContent = linha;
                textoEfeito.appendChild(tspan);
            });
            svg.appendChild(textoEfeito);
            
            // Categorias organizadas em 3 de cada lado (superior e inferior)
            const categoriasSuperiores = [
                { nome: 'Método', id: 'ishikawa-metodo', pos: 0 },
                { nome: 'Mão de Obra', id: 'ishikawa-maoobra', pos: 1 },
                { nome: 'Material', id: 'ishikawa-material', pos: 2 }
            ];
            
            const categoriasInferiores = [
                { nome: 'Máquina', id: 'ishikawa-maquina', pos: 0 },
                { nome: 'Meio Ambiente', id: 'ishikawa-meioambiente', pos: 1 },
                { nome: 'Medição', id: 'ishikawa-medicao', pos: 2 }
            ];
            
            const branchSpacing = (spineEndX - spineStartX) / 4;
            const branchLength = 200;
            
            // Função para obter classe de categoria
            function getCategoriaClass(nome) {
                const mapa = {
                    'Método': 'metodo',
                    'Mão de Obra': 'maoobra',
                    'Material': 'material',
                    'Máquina': 'maquina',
                    'Meio Ambiente': 'meioambiente',
                    'Medição': 'medicao'
                };
                return mapa[nome] || 'metodo';
            }
            
            // Função para desenhar categoria
            function desenharCategoria(cat, branchX, branchY, isSuperior) {
                const categoriaClass = getCategoriaClass(cat.nome);
                
                // Desenhar ramo principal (vertical conectando à espinha)
                const branch = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                branch.setAttribute('x1', branchX);
                branch.setAttribute('y1', branchY);
                branch.setAttribute('x2', branchX);
                branch.setAttribute('y2', centerY);
                branch.setAttribute('class', `fishbone-branch ${categoriaClass}`);
                svg.appendChild(branch);
                
                // Desenhar linha horizontal no final do ramo (perpendicular à espinha)
                const branchEnd = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                branchEnd.setAttribute('x1', branchX - 130);
                branchEnd.setAttribute('y1', branchY);
                branchEnd.setAttribute('x2', branchX);
                branchEnd.setAttribute('y2', branchY);
                branchEnd.setAttribute('class', `fishbone-branch ${categoriaClass}`);
                svg.appendChild(branchEnd);
                
                // Caixa para categoria com cor específica
                const categoryBox = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
                categoryBox.setAttribute('x', branchX - 140);
                categoryBox.setAttribute('y', branchY - 17);
                categoryBox.setAttribute('width', 120);
                categoryBox.setAttribute('height', 34);
                categoryBox.setAttribute('class', `fishbone-category-box ${categoriaClass}`);
                svg.appendChild(categoryBox);
                
                // Texto da categoria
                const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                label.setAttribute('x', branchX - 80);
                label.setAttribute('y', branchY + 4);
                label.setAttribute('class', 'fishbone-category-text');
                label.setAttribute('text-anchor', 'middle');
                label.setAttribute('dominant-baseline', 'middle');
                label.textContent = cat.nome;
                svg.appendChild(label);
                
                // Causas (sub-ramos diagonais)
                const causas = document.getElementById(cat.id).value.split('\n').filter(c => c.trim());
                if (causas.length > 0) {
                    const causaSpacing = branchLength / (causas.length + 1);
                    
                causas.forEach((causa, i) => {
                        const causaY = centerY + (isSuperior ? -causaSpacing * (i + 1) : causaSpacing * (i + 1));
                        const causaX = branchX - 130;
                    
                        // Sub-ramo (linha diagonal conectando causa ao ramo horizontal)
                    const causaBranch = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                        causaBranch.setAttribute('x1', causaX - 80);
                    causaBranch.setAttribute('y1', causaY);
                        causaBranch.setAttribute('x2', causaX);
                        causaBranch.setAttribute('y2', branchY);
                        causaBranch.setAttribute('class', 'fishbone-sub-branch');
                    svg.appendChild(causaBranch);
                    
                    // Texto da causa
                    const causaTexto = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                        causaTexto.setAttribute('x', causaX - 90);
                    causaTexto.setAttribute('y', causaY);
                        causaTexto.setAttribute('class', 'fishbone-causa-text');
                    causaTexto.setAttribute('text-anchor', 'end');
                        causaTexto.setAttribute('dominant-baseline', 'middle');
                        // Quebrar texto longo
                        const textoCurto = causa.length > 25 ? causa.substring(0, 22) + '...' : causa;
                        causaTexto.textContent = textoCurto;
                    svg.appendChild(causaTexto);
                });
                }
            }
            
            // Adicionar seta na ponta da espinha (cauda do peixe)
            const tailArrow = document.createElementNS('http://www.w3.org/2000/svg', 'polygon');
            const tailPoints = [
                `${spineStartX},${centerY}`,
                `${spineStartX - 20},${centerY - 15}`,
                `${spineStartX - 20},${centerY + 15}`
            ].join(' ');
            tailArrow.setAttribute('points', tailPoints);
            tailArrow.setAttribute('fill', '#2c3e50');
            tailArrow.setAttribute('stroke', '#1a252f');
            tailArrow.setAttribute('stroke-width', '2');
            svg.appendChild(tailArrow);
            
            // Desenhar categorias superiores (acima da espinha)
            categoriasSuperiores.forEach((cat, index) => {
                const branchX = spineStartX + (index + 1) * branchSpacing;
                const branchY = centerY - branchLength;
                desenharCategoria(cat, branchX, branchY, true);
            });
            
            // Desenhar categorias inferiores (abaixo da espinha)
            categoriasInferiores.forEach((cat, index) => {
                const branchX = spineStartX + (index + 1) * branchSpacing;
                const branchY = centerY + branchLength;
                desenharCategoria(cat, branchX, branchY, false);
            });
        }

        function exportarIshikawa() {
            const problema = document.getElementById('problemaIshikawa').value;
            const categorias = [
                { nome: 'Método', id: 'ishikawa-metodo' },
                { nome: 'Mão de Obra', id: 'ishikawa-maoobra' },
                { nome: 'Material', id: 'ishikawa-material' },
                { nome: 'Máquina', id: 'ishikawa-maquina' },
                { nome: 'Meio Ambiente', id: 'ishikawa-meioambiente' },
                { nome: 'Medição', id: 'ishikawa-medicao' }
            ];
            
            let htmlCategorias = categorias.map(cat => {
                const causas = document.getElementById(cat.id).value.split('\n').filter(c => c.trim());
                return `
                    <tr>
                        <td><strong>${cat.nome}</strong></td>
                        <td>
                            <ul>
                                ${causas.map(c => `<li>${c}</li>`).join('')}
                            </ul>
                        </td>
                    </tr>
                `;
            }).join('');
            
            const conteudo = `
                <h2>Diagrama de Ishikawa</h2>
                <h3>Problema (Efeito): ${problema}</h3>
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Categoria</th>
                            <th>Causas</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${htmlCategorias}
                    </tbody>
                </table>
            `;
            
            imprimirConteudo(conteudo, 'Diagrama de Ishikawa');
        }

        async function salvarIshikawa() {
            if (!verificarProjeto()) return;
            
            const titulo = document.getElementById('tituloIshikawa').value;
            const problema = document.getElementById('problemaIshikawa').value;
            
            if (!titulo && !problema) {
                alert('Por favor, preencha pelo menos o título ou o problema.');
                return;
            }
            
            const categorias = [
                { nome: 'Método', id: 'ishikawa-metodo' },
                { nome: 'Mão de Obra', id: 'ishikawa-maoobra' },
                { nome: 'Material', id: 'ishikawa-material' },
                { nome: 'Máquina', id: 'ishikawa-maquina' },
                { nome: 'Meio Ambiente', id: 'ishikawa-meioambiente' },
                { nome: 'Medição', id: 'ishikawa-medicao' }
            ];
            
            // Converter array de categorias para objeto onde a chave é o nome da categoria
            const categoriasObj = {};
            categorias.forEach(cat => {
                const causas = document.getElementById(cat.id).value.split('\n').filter(c => c.trim());
                if (causas.length > 0) {
                    categoriasObj[cat.nome] = causas;
                }
            });
            
            const dados = {
                problema: problema,
                categorias: categoriasObj
            };
            
            const tituloFinal = titulo || `Diagrama de Ishikawa: ${problema || 'Sem título'}`;
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/ferramentas-qualidade', {
                    method: 'POST',
                    headers: { ...headers, 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        id: ferramentaAtualId,
                        tipo_ferramenta: 'ishikawa',
                        titulo: tituloFinal,
                        dados: dados,
                        projeto_id: projetoAtual?.id || null
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    ferramentaAtualId = data.ferramenta.id;
                    alert('✅ Diagrama de Ishikawa salvo com sucesso!');
                    atualizarStatusEtapa('ishikawa', 'concluido');
                    salvarStatusEtapas();
                } else {
                    alert('❌ Erro ao salvar: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('❌ Erro ao salvar diagrama de Ishikawa:', error);
                alert('❌ Erro ao salvar diagrama de Ishikawa: ' + error.message);
            }
        }

        function limparIshikawa() {
            document.getElementById('tituloIshikawa').value = '';
            document.getElementById('problemaIshikawa').value = '';
            ['ishikawa-metodo', 'ishikawa-maoobra', 'ishikawa-material', 'ishikawa-maquina', 'ishikawa-meioambiente', 'ishikawa-medicao'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('ishikawa-diagram-container').style.display = 'none';
            ferramentaAtualId = null;
        }

        // ========== PLANO DE AÇÃO ==========
        function escaparHtml(texto) {
            if (!texto) return '';
            const div = document.createElement('div');
            div.textContent = texto;
            return div.innerHTML;
        }
        
        function calcularDiasEntreDatas(dataInicio, dataFim) {
            if (!dataInicio || !dataFim) return null;
            const inicio = new Date(dataInicio);
            const fim = new Date(dataFim);
            inicio.setHours(0, 0, 0, 0);
            fim.setHours(0, 0, 0, 0);
            const diff = Math.floor((fim - inicio) / (1000 * 60 * 60 * 24));
            return diff;
        }
        
        function formatarData(data) {
            if (!data) return '-';
            const d = new Date(data);
            const dia = String(d.getDate()).padStart(2, '0');
            const mes = String(d.getMonth() + 1).padStart(2, '0');
            return `${dia}-${mes}`;
        }
        
        function adicionarAcao() {
            const acao = {
                id: Date.now().toString(),
                descricao: '',
                gestor_imediato: '',
                responsavel_id: '',
                prioridade: 'MÉDIA',
                progresso: 0,
                inicio: '',
                revisao: '',
                finalizacao: '',
                status: 'PENDENTE',
                obs: '',
                acao_contingencia: ''
            };
            
            acoesPlano.push(acao);
            renderizarAcoes();
            atualizarAlertasPlano();
        }

        function removerAcao(id) {
            acoesPlano = acoesPlano.filter(a => a.id !== id);
            renderizarAcoes();
            atualizarAlertasPlano();
        }

        function atualizarAcao(id, campo, valor) {
            const acao = acoesPlano.find(a => a.id === id);
            if (acao) {
                acao[campo] = valor;
                if (campo === 'progresso') {
                    acao.progresso = parseInt(valor) || 0;
                }
                renderizarAcoes();
                atualizarAlertasPlano();
            }
        }

        function renderizarAcoes() {
            const container = document.getElementById('listaAcoes');
            container.innerHTML = '';
            
            if (acoesPlano.length === 0) {
                container.innerHTML = '<div class="text-center text-muted py-5"><i class="fas fa-tasks fa-3x mb-3"></i><p>Nenhuma ação cadastrada. Clique em "Adicionar Ação" para começar.</p></div>';
                return;
            }
            
            acoesPlano.forEach((acao, index) => {
                const dias = calcularDiasEntreDatas(acao.inicio, acao.finalizacao);
                const responsavelNome = usuariosPlataforma.find(u => u.id === acao.responsavel_id)?.nome || acao.responsavel_id || '';
                const statusClass = acao.status === 'FINALIZADO' ? 'success' : acao.status === 'EM ANDAMENTO' ? 'warning' : 'secondary';
                const prioridadeClass = acao.prioridade === 'ALTA' ? 'alta' : acao.prioridade === 'MÉDIA' ? 'media' : 'baixa';
                const finalizadoClass = acao.status === 'FINALIZADO' ? 'finalizado' : '';
                
                const card = document.createElement('div');
                card.className = `acao-card prioridade-${prioridadeClass} ${finalizadoClass}`;
                card.innerHTML = `
                    <div class="acao-header">
                        <div class="d-flex align-items-center gap-2">
                            <span class="badge bg-secondary">#${index + 1}</span>
                            <span class="badge bg-${statusClass} badge-status">${acao.status || 'PENDENTE'}</span>
                            <span class="badge bg-${acao.prioridade === 'ALTA' ? 'danger' : acao.prioridade === 'MÉDIA' ? 'warning' : 'info'}">${acao.prioridade || 'MÉDIA'}</span>
                        </div>
                        <button class="btn btn-sm btn-danger" onclick="removerAcao('${acao.id}')" title="Remover ação">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    <div class="acao-descricao">
                        <label class="form-label fw-bold">AÇÃO</label>
                        <textarea class="form-control" rows="2" 
                                  placeholder="Descreva a ação a ser realizada..." 
                                  onchange="atualizarAcao('${acao.id}', 'descricao', this.value)">${(acao.descricao || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;")}</textarea>
                    </div>
                    
                    <div class="acao-info-grid">
                        <div class="acao-info-item">
                            <label>GESTOR IMEDIATO</label>
                            <input type="text" class="form-control" 
                                   value="${(acao.gestor_imediato || '').replace(/"/g, "&quot;")}" 
                                   placeholder="Nome do gestor"
                                   onchange="atualizarAcao('${acao.id}', 'gestor_imediato', this.value)">
                        </div>
                        
                        <div class="acao-info-item">
                            <label>RESPONSÁVEL</label>
                            <select class="form-select" 
                                    onchange="atualizarAcao('${acao.id}', 'responsavel_id', this.value)">
                                <option value="">Selecione ou digite abaixo...</option>
                                ${usuariosPlataforma.map(u => `
                                    <option value="${u.id}" ${acao.responsavel_id === u.id ? 'selected' : ''}>
                                        ${u.nome}${u.departamento ? ' - ' + u.departamento : ''}
                                    </option>
                                `).join('')}
                            </select>
                            ${!acao.responsavel_id || !usuariosPlataforma.find(u => u.id === acao.responsavel_id) ? `
                                <input type="text" class="form-control mt-1" 
                                       value="${(acao.responsavel_id && !usuariosPlataforma.find(u => u.id === acao.responsavel_id) ? acao.responsavel_id : '').replace(/"/g, "&quot;")}" 
                                       placeholder="Ou digite o nome do responsável"
                                       onchange="atualizarAcao('${acao.id}', 'responsavel_id', this.value)">
                            ` : ''}
                        </div>
                        
                        <div class="acao-info-item">
                            <label>PRIORIDADE</label>
                            <select class="form-select" 
                                    onchange="atualizarAcao('${acao.id}', 'prioridade', this.value)">
                                <option value="BAIXA" ${acao.prioridade === 'BAIXA' ? 'selected' : ''}>BAIXA</option>
                                <option value="MÉDIA" ${acao.prioridade === 'MÉDIA' ? 'selected' : ''}>MÉDIA</option>
                                <option value="ALTA" ${acao.prioridade === 'ALTA' ? 'selected' : ''}>ALTA</option>
                            </select>
                        </div>
                        
                        <div class="acao-info-item">
                            <label>PROGRESSO</label>
                            <div class="progress-container">
                                <input type="number" class="form-control" min="0" max="100" 
                                       value="${acao.progresso || 0}" 
                                       onchange="atualizarAcao('${acao.id}', 'progresso', this.value)">
                                <span>%</span>
                                <div class="progress">
                                    <div class="progress-bar ${acao.progresso >= 100 ? 'bg-success' : acao.progresso >= 50 ? 'bg-warning' : 'bg-info'}" 
                                         role="progressbar" style="width: ${acao.progresso || 0}%">
                                        ${acao.progresso || 0}%
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="acao-info-item">
                            <label>ÍNICIO</label>
                            <input type="date" class="form-control" 
                                   value="${acao.inicio || ''}" 
                                   onchange="atualizarAcao('${acao.id}', 'inicio', this.value)">
                        </div>
                        
                        <div class="acao-info-item">
                            <label>REVISÃO</label>
                            <input type="date" class="form-control" 
                                   value="${acao.revisao || ''}" 
                                   onchange="atualizarAcao('${acao.id}', 'revisao', this.value)">
                        </div>
                        
                        <div class="acao-info-item">
                            <label>FINALIZAÇÃO</label>
                            <input type="date" class="form-control" 
                                   value="${acao.finalizacao || ''}" 
                                   onchange="atualizarAcao('${acao.id}', 'finalizacao', this.value)">
                        </div>
                        
                        <div class="acao-info-item">
                            <label>DIAS</label>
                            <input type="text" class="form-control" 
                                   value="${dias !== null ? dias + ' dias' : '-'}" 
                                   readonly 
                                   style="background: #f8f9fa;">
                        </div>
                        
                        <div class="acao-info-item">
                            <label>STATUS</label>
                            <select class="form-select" 
                                    onchange="atualizarAcao('${acao.id}', 'status', this.value)">
                                <option value="PENDENTE" ${acao.status === 'PENDENTE' ? 'selected' : ''}>PENDENTE</option>
                                <option value="EM ANDAMENTO" ${acao.status === 'EM ANDAMENTO' ? 'selected' : ''}>EM ANDAMENTO</option>
                                <option value="FINALIZADO" ${acao.status === 'FINALIZADO' ? 'selected' : ''}>FINALIZADO</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-2">
                            <label class="form-label fw-bold">OBS</label>
                            <textarea class="form-control" rows="2" 
                                      placeholder="Observações adicionais..." 
                                      onchange="atualizarAcao('${acao.id}', 'obs', this.value)">${(acao.obs || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;")}</textarea>
                        </div>
                        <div class="col-md-6 mb-2">
                            <label class="form-label fw-bold">AÇÃO DE CONTINGÊNCIA</label>
                            <textarea class="form-control" rows="2" 
                                      placeholder="Descreva a ação de contingência..." 
                                      onchange="atualizarAcao('${acao.id}', 'acao_contingencia', this.value)">${(acao.acao_contingencia || '').replace(/'/g, "&#39;").replace(/"/g, "&quot;")}</textarea>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        function atualizarAlertasPlano() {
            const alertasContainer = document.getElementById('listaAlertasPlano');
            const alertasDiv = document.getElementById('alertasPlano');
            if (!alertasContainer || !alertasDiv) return;
            
            const alertas = acoesPlano
                .filter(a => a.finalizacao && a.responsavel_id)
                .map(a => {
                    const dias = calcularDiasRestantes(a.finalizacao);
                    const responsavel = usuariosPlataforma.find(u => u.id === a.responsavel_id);
                    return { ...a, dias, responsavel };
                })
                .filter(a => a.dias !== null && (a.dias < 0 || a.dias <= 3));
            
            if (alertas.length === 0) {
                alertasDiv.style.display = 'none';
                return;
            }
            
            alertasDiv.style.display = 'block';
            alertasContainer.innerHTML = alertas.map(a => {
                const status = formatarStatusPrazo(a.dias);
                return `
                    <div class="alert alert-${a.dias < 0 ? 'danger' : 'warning'} mb-2 py-2">
                        <strong>${a.descricao || 'Ação sem descrição'}</strong> - 
                        Responsável: ${a.responsavel?.nome || a.responsavel_id || 'Não definido'} - 
                        <span class="${status.classe}">${status.texto}</span>
                    </div>
                `;
            }).join('');
        }
        
        async function salvarPlanoAcao() {
            if (!verificarProjeto()) return;
            
            const titulo = document.getElementById('tituloPlano').value;
            const objetivo = document.getElementById('objetivoPlano').value;
            
            if (!titulo) {
                alert('Por favor, preencha o título do plano de ação.');
                return;
            }
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/ferramentas-qualidade', {
                    method: 'POST',
                    headers: { ...headers, 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        id: ferramentaAtualId,
                        tipo_ferramenta: 'plano_acao',
                        titulo: titulo,
                        dados: {
                            objetivo: objetivo,
                            acoes: acoesPlano.map(a => ({
                                id: a.id,
                                acao: a.descricao || a.acao, // Usar 'acao' como campo principal
                                descricao: a.descricao || a.acao, // Manter compatibilidade
                                gestor_imediato: a.gestor_imediato,
                                responsavel: a.responsavel_id, // Backend também aceita 'responsavel'
                                responsavel_id: a.responsavel_id,
                                prioridade: a.prioridade,
                                progresso: a.progresso,
                                inicio: a.inicio,
                                revisao: a.revisao,
                                finalizacao: a.finalizacao,
                                prazo: a.finalizacao || a.prazo, // Backend procura por 'prazo' ou 'finalizacao'
                                status: a.status,
                                obs: a.obs,
                                acao_contingencia: a.acao_contingencia
                            }))
                        },
                        projeto_id: projetoAtual?.id || null
                    })
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('❌ Erro na resposta da API:', response.status, errorText);
                    throw new Error(`Erro ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                if (data.success) {
                    ferramentaAtualId = data.ferramenta.id;
                    alert('✅ Plano de Ação salvo com sucesso!');
                    atualizarStatusEtapa('plano-acao', 'concluido');
                    salvarStatusEtapas();
                    // Tentar recarregar alertas (não crítico se falhar)
                    try {
                        await carregarAlertas();
                    } catch (alertError) {
                        console.warn('⚠️ Erro ao recarregar alertas:', alertError);
                    }
                } else {
                    alert('❌ Erro ao salvar: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('❌ Erro ao salvar plano de ação:', error);
                alert('❌ Erro ao salvar plano de ação: ' + error.message + '\n\nVerifique se o servidor está rodando e se você está autenticado.');
            }
        }

        function exportarPlanoAcao() {
            const titulo = document.getElementById('tituloPlano').value || 'Plano de Ação';
            const objetivo = document.getElementById('objetivoPlano').value;
            
            let htmlAcoes = acoesPlano.map((acao, index) => {
                const responsavel = usuariosPlataforma.find(u => u.id === acao.responsavel_id);
                const dias = calcularDiasEntreDatas(acao.inicio, acao.finalizacao);
                return `
                    <tr>
                        <td>${acao.descricao || '-'}</td>
                        <td>${acao.gestor_imediato || '-'}</td>
                        <td>${responsavel?.nome || acao.responsavel_id || '-'}</td>
                        <td>${acao.prioridade || '-'}</td>
                        <td>${acao.progresso || 0}%</td>
                        <td>${formatarData(acao.inicio)}</td>
                        <td>${formatarData(acao.revisao)}</td>
                        <td>${formatarData(acao.finalizacao)}</td>
                        <td>${dias !== null ? dias : '-'}</td>
                        <td>${acao.status || '-'}</td>
                        <td>${acao.obs || '-'}</td>
                        <td>${acao.acao_contingencia || '-'}</td>
                    </tr>
                `;
            }).join('');
            
            const conteudo = `
                <h2>${titulo}</h2>
                <h3>Objetivo:</h3>
                <p>${objetivo || '-'}</p>
                <table class="table table-bordered" style="font-size: 10px;">
                    <thead>
                        <tr>
                            <th>AÇÃO</th>
                            <th>GESTOR IMEDIATO</th>
                            <th>RESPONSÁVEL</th>
                            <th>PRIORIDADE</th>
                            <th>PROGRESSO</th>
                            <th>ÍNICIO</th>
                            <th>REVISÃO</th>
                            <th>FINALIZAÇÃO</th>
                            <th>DIAS</th>
                            <th>STATUS</th>
                            <th>OBS</th>
                            <th>AÇÃO DE CONTINGÊNCIA</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${htmlAcoes || '<tr><td colspan="12">Nenhuma ação cadastrada</td></tr>'}
                    </tbody>
                </table>
            `;
            
            imprimirConteudo(conteudo, titulo);
        }

        function limparPlanoAcao() {
            document.getElementById('tituloPlano').value = '';
            document.getElementById('objetivoPlano').value = '';
            acoesPlano = [];
            ferramentaAtualId = null;
            renderizarAcoes();
            atualizarAlertasPlano();
        }
        
        // ========== ARQUIVOS ==========
        async function carregarFerramentasArquivadas() {
            const container = document.getElementById('listaFerramentasArquivadas');
            const tipo = document.getElementById('filtroTipoArquivo').value;
            const arquivado = document.getElementById('filtroArquivado').value;
            
            container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div></div>';
            
            try {
                let url = '/api/ferramentas-qualidade?';
                if (tipo) url += `tipo=${tipo}&`;
                if (arquivado !== '') url += `arquivado=${arquivado}`;
                
                const response = await fetch(url, {
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    const ferramentas = data.ferramentas || [];
                    
                    if (ferramentas.length === 0) {
                        container.innerHTML = '<div class="alert alert-info">Nenhuma ferramenta encontrada.</div>';
                        return;
                    }
                    
                    const tiposNome = {
                        '5porques': '5 Porquês',
                        '5w2h': '5W2H',
                        'ishikawa': 'Ishikawa',
                        'plano_acao': 'Plano de Ação',
                        'pdca': 'PDCA',
                        'brainstorm': 'Brainstorming'
                    };
                    
                    container.innerHTML = ferramentas.map(f => {
                        const dataCriacao = new Date(f.criado_em).toLocaleDateString('pt-BR');
                        const temAlerta = f.tem_prazos && f.proximo_vencimento && 
                            new Date(f.proximo_vencimento) <= new Date();
                        
                        return `
                            <div class="card mb-3 ${f.arquivado ? 'border-secondary' : temAlerta ? 'border-warning' : ''}">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div class="flex-grow-1">
                                            <h5 class="card-title">
                                                ${f.titulo}
                                                ${f.arquivado ? '<span class="badge bg-secondary ms-2">Arquivado</span>' : ''}
                                                ${temAlerta ? '<span class="badge bg-warning ms-2">Prazo próximo</span>' : ''}
                                            </h5>
                                            <p class="text-muted mb-2">
                                                <strong>Tipo:</strong> ${tiposNome[f.tipo_ferramenta] || f.tipo_ferramenta} | 
                                                <strong>Criado em:</strong> ${dataCriacao}
                                            </p>
                                        </div>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-primary" onclick="carregarFerramenta('${f.id}')">
                                                <i class="fas fa-edit"></i> Editar
                                            </button>
                                            <button class="btn btn-sm btn-${f.arquivado ? 'success' : 'secondary'}" 
                                                    onclick="arquivarFerramenta('${f.id}', ${!f.arquivado})">
                                                <i class="fas fa-${f.arquivado ? 'folder-open' : 'archive'}"></i> 
                                                ${f.arquivado ? 'Desarquivar' : 'Arquivar'}
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    container.innerHTML = '<div class="alert alert-danger">Erro ao carregar ferramentas.</div>';
                }
            } catch (error) {
                console.error('❌ Erro ao carregar ferramentas:', error);
                container.innerHTML = '<div class="alert alert-danger">Erro ao carregar ferramentas.</div>';
            }
        }
        
        async function carregarFerramenta(id) {
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`/api/ferramentas-qualidade/${id}`, {
                    headers: headers,
                    credentials: 'include'
                });
                const data = await response.json();
                
                if (data.success) {
                    const f = data.ferramenta;
                    ferramentaAtualId = f.id;
                    
                    if (f.tipo_ferramenta === '5w2h') {
                        document.getElementById('titulo5w2h').value = f.titulo || '';
                        linhas5W2H = f.dados?.linhas || [];
                        // Garantir que usuários estejam carregados antes de renderizar
                        if (usuariosPlataforma.length === 0) {
                            await carregarUsuarios();
                        }
                        renderizarLinhas5W2H();
                        const tab5w2h = document.querySelector('[data-bs-target="#tab-5w2h"]');
                        if (tab5w2h) tab5w2h.click();
                    } else if (f.tipo_ferramenta === '5porques') {
                        // Extrair título (remover prefixo "5 Porquês: " se existir)
                        const titulo = f.titulo?.replace(/^5 Porquês:\s*/i, '') || '';
                        document.getElementById('titulo5porques').value = titulo;
                        document.getElementById('problema5porques').value = f.dados?.problema || '';
                        if (f.dados?.porques) {
                            f.dados.porques.forEach((porque, index) => {
                                const campo = document.getElementById(`porque${index + 1}`);
                                if (campo) campo.value = porque || '';
                            });
                        }
                        document.getElementById('causaRaiz').value = f.dados?.causa_raiz || '';
                        const tab5Porques = document.querySelector('[data-bs-target="#tab-5porques"]');
                        if (tab5Porques) tab5Porques.click();
                    } else if (f.tipo_ferramenta === 'pdca') {
                        // Extrair título (remover prefixo "PDCA: " se existir)
                        const titulo = f.titulo?.replace(/^PDCA:\s*/i, '') || '';
                        document.getElementById('tituloPDCA').value = titulo;
                        if (f.dados) {
                            document.getElementById('pdca-problema').value = f.dados.problema || '';
                            document.getElementById('pdca-objetivo').value = f.dados.objetivo || '';
                            document.getElementById('pdca-plano').value = f.dados.plano || '';
                            document.getElementById('pdca-executado').value = f.dados.executado || '';
                            document.getElementById('pdca-dificuldades').value = f.dados.dificuldades || '';
                            document.getElementById('pdca-resultados').value = f.dados.resultados || '';
                            document.getElementById('pdca-comparacao').value = f.dados.comparacao || '';
                            document.getElementById('pdca-padronizacao').value = f.dados.padronizacao || '';
                            document.getElementById('pdca-proximos').value = f.dados.proximos || '';
                            document.getElementById('pdca-proximo-ciclo').value = f.dados.proximoCiclo || '';
                        }
                        const tabPDCA = document.querySelector('[data-bs-target="#tab-pdca"]');
                        if (tabPDCA) tabPDCA.click();
                    } else if (f.tipo_ferramenta === 'brainstorm') {
                        // Extrair título (remover prefixo "Brainstorming: " se existir)
                        const titulo = f.titulo?.replace(/^Brainstorming:\s*/i, '') || '';
                        document.getElementById('temaBrainstorm').value = f.dados?.tema || titulo || '';
                        document.getElementById('objetivoBrainstorm').value = f.dados?.objetivo || '';
                        ideiasBrainstorm = f.dados?.ideias || [];
                        ideiasSelecionadas = f.dados?.ideias_selecionadas || [];
                        renderizarIdeias();
                        renderizarIdeiasSelecionadas();
                        const tabBrainstorm = document.querySelector('[data-bs-target="#tab-brainstorm"]');
                        if (tabBrainstorm) tabBrainstorm.click();
                    } else if (f.tipo_ferramenta === 'ishikawa') {
                        // Extrair título (remover prefixo "Diagrama de Ishikawa: " se existir)
                        const titulo = f.titulo?.replace(/^Diagrama de Ishikawa:\s*/i, '') || '';
                        document.getElementById('tituloIshikawa').value = titulo;
                        document.getElementById('problemaIshikawa').value = f.dados?.problema || '';
                        if (f.dados?.categorias) {
                            // Mapear nomes das categorias para IDs dos campos
                            const mapeamentoCategorias = {
                                'Método': 'ishikawa-metodo',
                                'Mão de Obra': 'ishikawa-maoobra',
                                'Material': 'ishikawa-material',
                                'Máquina': 'ishikawa-maquina',
                                'Meio Ambiente': 'ishikawa-meioambiente',
                                'Medição': 'ishikawa-medicao'
                            };
                            
                            f.dados.categorias.forEach(cat => {
                                const campoId = mapeamentoCategorias[cat.nome];
                                if (campoId) {
                                    const campo = document.getElementById(campoId);
                                    if (campo) {
                                        campo.value = cat.causas?.join('\n') || '';
                                    }
                                }
                            });
                        }
                        // Visualizar automaticamente se houver problema
                        if (f.dados?.problema) {
                            visualizarIshikawa();
                        }
                        const tabIshikawa = document.querySelector('[data-bs-target="#tab-ishikawa"]');
                        if (tabIshikawa) tabIshikawa.click();
                    } else if (f.tipo_ferramenta === 'plano_acao') {
                        document.getElementById('tituloPlano').value = f.titulo || '';
                        document.getElementById('objetivoPlano').value = f.dados?.objetivo || '';
                        acoesPlano = f.dados?.acoes || [];
                        renderizarAcoes();
                        atualizarAlertasPlano();
                        const tabPlano = document.querySelector('[data-bs-target="#tab-plano-acao"]');
                        if (tabPlano) tabPlano.click();
                    }
                }
            } catch (error) {
                console.error('❌ Erro ao carregar ferramenta:', error);
                alert('Erro ao carregar ferramenta.');
            }
        }
        
        async function arquivarFerramenta(id, arquivar) {
            try {
                const headers = await getAuthHeaders();
                const response = await fetch(`/api/ferramentas-qualidade/${id}/arquivar`, {
                    method: 'PUT',
                    headers: headers,
                    credentials: 'include',
                    body: JSON.stringify({ arquivado: arquivar })
                });
                
                const data = await response.json();
                if (data.success) {
                    carregarFerramentasArquivadas();
                } else {
                    alert('Erro ao arquivar ferramenta.');
                }
            } catch (error) {
                console.error('❌ Erro ao arquivar ferramenta:', error);
                alert('Erro ao arquivar ferramenta.');
            }
        }

        // ========== PDCA ==========
        function exportarPDCA() {
            const dados = {
                problema: document.getElementById('pdca-problema').value,
                objetivo: document.getElementById('pdca-objetivo').value,
                plano: document.getElementById('pdca-plano').value,
                executado: document.getElementById('pdca-executado').value,
                dificuldades: document.getElementById('pdca-dificuldades').value,
                resultados: document.getElementById('pdca-resultados').value,
                comparacao: document.getElementById('pdca-comparacao').value,
                padronizacao: document.getElementById('pdca-padronizacao').value,
                proximos: document.getElementById('pdca-proximos').value,
                proximoCiclo: document.getElementById('pdca-proximo-ciclo').value
            };
            
            const conteudo = `
                <h2>Ciclo PDCA</h2>
                <div style="border: 2px solid #007bff; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #007bff;">PLAN - Planejar</h3>
                    <p><strong>Problema/Oportunidade:</strong> ${dados.problema || '-'}</p>
                    <p><strong>Objetivo:</strong> ${dados.objetivo || '-'}</p>
                    <p><strong>Plano de Ação:</strong> ${dados.plano || '-'}</p>
                </div>
                <div style="border: 2px solid #28a745; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #28a745;">DO - Executar</h3>
                    <p><strong>O que foi executado:</strong> ${dados.executado || '-'}</p>
                    <p><strong>Dificuldades encontradas:</strong> ${dados.dificuldades || '-'}</p>
                </div>
                <div style="border: 2px solid #ffc107; padding: 20px; margin-bottom: 20px;">
                    <h3 style="color: #856404;">CHECK - Verificar</h3>
                    <p><strong>Resultados obtidos:</strong> ${dados.resultados || '-'}</p>
                    <p><strong>Comparação com objetivo:</strong> ${dados.comparacao || '-'}</p>
                </div>
                <div style="border: 2px solid #dc3545; padding: 20px;">
                    <h3 style="color: #dc3545;">ACT - Agir</h3>
                    <p><strong>Padronização:</strong> ${dados.padronizacao || '-'}</p>
                    <p><strong>Próximos passos:</strong> ${dados.proximos || '-'}</p>
                    <p><strong>Próximo ciclo PDCA:</strong> ${dados.proximoCiclo || '-'}</p>
                </div>
            `;
            
            imprimirConteudo(conteudo, 'Ciclo PDCA');
        }

        function limparPDCA() {
            document.getElementById('tituloPDCA').value = '';
            ['pdca-problema', 'pdca-objetivo', 'pdca-plano', 'pdca-executado', 'pdca-dificuldades', 
             'pdca-resultados', 'pdca-comparacao', 'pdca-padronizacao', 'pdca-proximos', 'pdca-proximo-ciclo'].forEach(id => {
                document.getElementById(id).value = '';
            });
            ferramentaAtualId = null;
        }
        
        async function salvarPDCA() {
            if (!verificarProjeto()) return;
            
            const titulo = document.getElementById('tituloPDCA').value;
            
            // Estruturar dados do PDCA como arrays para cada etapa
            const dados = {
                problema: document.getElementById('pdca-problema').value,
                objetivo: document.getElementById('pdca-objetivo').value,
                plan: document.getElementById('pdca-plano').value ? [document.getElementById('pdca-plano').value] : [],
                do: document.getElementById('pdca-executado').value ? [document.getElementById('pdca-executado').value] : [],
                check: document.getElementById('pdca-dificuldades').value || document.getElementById('pdca-resultados').value || document.getElementById('pdca-comparacao').value 
                    ? [
                        document.getElementById('pdca-dificuldades').value,
                        document.getElementById('pdca-resultados').value,
                        document.getElementById('pdca-comparacao').value
                    ].filter(v => v.trim()) : [],
                act: document.getElementById('pdca-padronizacao').value || document.getElementById('pdca-proximos').value || document.getElementById('pdca-proximo-ciclo').value
                    ? [
                        document.getElementById('pdca-padronizacao').value,
                        document.getElementById('pdca-proximos').value,
                        document.getElementById('pdca-proximo-ciclo').value
                    ].filter(v => v.trim()) : []
            };
            
            if (!titulo && !dados.problema) {
                alert('Por favor, preencha pelo menos o título ou o problema.');
                return;
            }
            
            const tituloFinal = titulo || `PDCA: ${dados.problema || 'Sem título'}`;
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/ferramentas-qualidade', {
                    method: 'POST',
                    headers: { ...headers, 'Content-Type': 'application/json' },
                    credentials: 'include',
                    body: JSON.stringify({
                        id: ferramentaAtualId,
                        tipo_ferramenta: 'pdca',
                        titulo: tituloFinal,
                        dados: dados,
                        projeto_id: projetoAtual?.id || null
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    ferramentaAtualId = data.ferramenta.id;
                    alert('✅ PDCA salvo com sucesso!');
                    atualizarStatusEtapa('pdca', 'concluido');
                    salvarStatusEtapas();
                } else {
                    alert('❌ Erro ao salvar: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('❌ Erro ao salvar PDCA:', error);
                alert('❌ Erro ao salvar PDCA: ' + error.message);
            }
        }

        // ========== BRAINSTORMING ==========
        function adicionarIdeia() {
            const input = document.getElementById('novaIdeia');
            const ideia = input.value.trim();
            
            if (!ideia) {
                alert('Por favor, digite uma ideia.');
                return;
            }
            
            ideiasBrainstorm.push({
                id: Date.now(),
                texto: ideia
            });
            
            input.value = '';
            renderizarIdeias();
        }

        function removerIdeia(id) {
            ideiasBrainstorm = ideiasBrainstorm.filter(i => i.id !== id);
            ideiasSelecionadas = ideiasSelecionadas.filter(i => i !== id);
            renderizarIdeias();
            renderizarIdeiasSelecionadas();
        }

        function selecionarIdeia(id) {
            if (ideiasSelecionadas.includes(id)) {
                ideiasSelecionadas = ideiasSelecionadas.filter(i => i !== id);
            } else {
                if (ideiasSelecionadas.length < 5) {
                    ideiasSelecionadas.push(id);
                } else {
                    alert('Você pode selecionar no máximo 5 ideias.');
                    return;
                }
            }
            renderizarIdeias();
            renderizarIdeiasSelecionadas();
        }

        function renderizarIdeias() {
            const container = document.getElementById('listaIdeias');
            container.innerHTML = '';
            
            ideiasBrainstorm.forEach(ideia => {
                const isSelected = ideiasSelecionadas.includes(ideia.id);
                const div = document.createElement('div');
                div.className = 'col-md-4';
                div.innerHTML = `
                    <div class="card ${isSelected ? 'border-primary bg-primary text-white' : ''}" style="cursor: pointer;" onclick="selecionarIdeia(${ideia.id})">
                        <div class="card-body p-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>${ideia.texto}</span>
                                ${isSelected ? '<i class="fas fa-check-circle"></i>' : ''}
                            </div>
                            <button class="btn btn-sm btn-danger mt-2" onclick="event.stopPropagation(); removerIdeia(${ideia.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
        }

        function renderizarIdeiasSelecionadas() {
            const container = document.getElementById('ideiasSelecionadas');
            container.innerHTML = '';
            
            ideiasSelecionadas.forEach(id => {
                const ideia = ideiasBrainstorm.find(i => i.id === id);
                if (ideia) {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.textContent = ideia.texto;
                    container.appendChild(li);
                }
            });
        }

        function exportarBrainstorm() {
            const tema = document.getElementById('temaBrainstorm').value;
            const objetivo = document.getElementById('objetivoBrainstorm').value;
            
            let htmlIdeias = ideiasBrainstorm.map((ideia, index) => {
                const isSelected = ideiasSelecionadas.includes(ideia.id);
                return `<li>${ideia.texto} ${isSelected ? '<strong>(Selecionada)</strong>' : ''}</li>`;
            }).join('');
            
            let htmlSelecionadas = ideiasSelecionadas.map(id => {
                const ideia = ideiasBrainstorm.find(i => i.id === id);
                return ideia ? `<li>${ideia.texto}</li>` : '';
            }).join('');
            
            const conteudo = `
                <h2>Brainstorming</h2>
                <p><strong>Tema/Problema:</strong> ${tema || '-'}</p>
                <p><strong>Objetivo:</strong> ${objetivo || '-'}</p>
                <h3>Todas as Ideias (${ideiasBrainstorm.length}):</h3>
                <ul>${htmlIdeias || '<li>Nenhuma ideia registrada</li>'}</ul>
                <h3>Top 5 Ideias Selecionadas:</h3>
                <ol>${htmlSelecionadas || '<li>Nenhuma ideia selecionada</li>'}</ol>
            `;
            
            imprimirConteudo(conteudo, 'Brainstorming');
        }

        function limparBrainstorm() {
            document.getElementById('temaBrainstorm').value = '';
            document.getElementById('objetivoBrainstorm').value = '';
            ideiasBrainstorm = [];
            ideiasSelecionadas = [];
            ferramentaAtualId = null;
            renderizarIdeias();
            renderizarIdeiasSelecionadas();
        }
        
        async function salvarBrainstorm() {
            const tema = document.getElementById('temaBrainstorm').value;
            
            if (!tema) {
                alert('Por favor, preencha o tema/problema.');
                return;
            }
            
            const dados = {
                tema: tema,
                objetivo: document.getElementById('objetivoBrainstorm').value,
                ideias: ideiasBrainstorm,
                ideias_selecionadas: ideiasSelecionadas
            };
            
            const tituloFinal = `Brainstorming: ${tema}`;
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/ferramentas-qualidade', {
                    method: 'POST',
                    headers: headers,
                    credentials: 'include',
                    body: JSON.stringify({
                        id: ferramentaAtualId,
                        tipo_ferramenta: 'brainstorm',
                        titulo: tituloFinal,
                        dados: dados
                    })
                });
                
                const data = await response.json();
                if (data.success) {
                    ferramentaAtualId = data.ferramenta.id;
                    alert('✅ Brainstorming salvo com sucesso!');
                    atualizarStatusEtapa('brainstorm', 'concluido');
                    salvarStatusEtapas();
                } else {
                    alert('❌ Erro ao salvar: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('❌ Erro ao salvar Brainstorming:', error);
                alert('❌ Erro ao salvar Brainstorming: ' + error.message);
            }
        }

        // ========== FUNÇÃO AUXILIAR PARA IMPRIMIR ==========
        function imprimirConteudo(conteudo, titulo) {
            const janela = window.open('', '_blank');
            if (!janela) {
                alert('Por favor, permita pop-ups para esta funcionalidade.');
                return;
            }
            
            const scriptTag = '<scr' + 'ipt>';
            const scriptClose = '</scr' + 'ipt>';
            
            // Incluir estilos do relatório profissional se o conteúdo contiver a classe
            const estilosRelatorio = conteudo.includes('relatorio-profissional') ? `
                <style>
                    .relatorio-profissional {
                        max-width: 1200px;
                        margin: 0 auto;
                        background: #ffffff;
                        color: #1e293b;
                        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                        line-height: 1.7;
                    }
                    .relatorio-header-fixed {
                        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 50%, #60a5fa 100%);
                        color: white;
                        padding: 30px 40px;
                        border-bottom: 3px solid rgba(255,255,255,0.2);
                    }
                    .relatorio-header-content {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        flex-wrap: wrap;
                        gap: 20px;
                    }
                    .relatorio-logo-section {
                        display: flex;
                        align-items: center;
                        gap: 20px;
                    }
                    .relatorio-logo {
                        width: 60px;
                        height: 60px;
                        background: rgba(255, 255, 255, 0.15);
                        border-radius: 10px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    }
                    .relatorio-empresa-nome {
                        font-size: 1.8rem;
                        font-weight: 700;
                        margin: 0;
                    }
                    .relatorio-empresa-subtitulo {
                        font-size: 0.9rem;
                        margin: 4px 0 0 0;
                        opacity: 0.95;
                    }
                    .relatorio-header-badge {
                        background: rgba(255, 255, 255, 0.2);
                        padding: 10px 20px;
                        border-radius: 20px;
                        display: inline-flex;
                        align-items: center;
                        gap: 8px;
                    }
                    .relatorio-container {
                        display: flex;
                        gap: 30px;
                        padding: 30px 40px;
                        background: #f8fafc;
                    }
                    .relatorio-main-content {
                        flex: 1;
                        min-width: 0;
                    }
                    .relatorio-projeto-box {
                        background: white;
                        border-radius: 12px;
                        padding: 25px;
                        margin-bottom: 30px;
                        box-shadow: 0 2px 8px rgba(37, 99, 235, 0.1);
                        border-left: 4px solid #2563eb;
                    }
                    .relatorio-projeto-header {
                        display: flex;
                        align-items: center;
                        gap: 15px;
                        margin-bottom: 20px;
                        padding-bottom: 15px;
                        border-bottom: 2px solid #e2e8f0;
                    }
                    .relatorio-projeto-icon-box {
                        width: 50px;
                        height: 50px;
                        background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
                        border-radius: 10px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: 1.3rem;
                    }
                    .relatorio-projeto-title {
                        font-size: 1.5rem;
                        font-weight: 600;
                        color: #1e293b;
                        margin: 0;
                    }
                    .relatorio-projeto-grid {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
                        gap: 20px;
                    }
                    .relatorio-projeto-item {
                        display: flex;
                        align-items: flex-start;
                        gap: 12px;
                        padding: 15px;
                        background: #f8fafc;
                        border-radius: 8px;
                        border-left: 3px solid #3b82f6;
                    }
                    .relatorio-projeto-item i {
                        color: #2563eb;
                        font-size: 1.2rem;
                        flex-shrink: 0;
                    }
                    .relatorio-projeto-item strong {
                        display: block;
                        color: #64748b;
                        font-size: 0.85rem;
                        margin-bottom: 4px;
                    }
                    .relatorio-projeto-item span {
                        color: #1e293b;
                        font-size: 0.95rem;
                    }
                    .relatorio-secoes {
                        display: flex;
                        flex-direction: column;
                        gap: 25px;
                    }
                    .relatorio-secao-card {
                        background: white;
                        border-radius: 12px;
                        padding: 25px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
                        border-left: 4px solid #64748b;
                    }
                    .relatorio-secao-header {
                        display: flex;
                        align-items: center;
                        gap: 15px;
                        margin-bottom: 18px;
                        padding-bottom: 15px;
                        border-bottom: 2px solid #f1f5f9;
                    }
                    .relatorio-secao-icon-box {
                        width: 45px;
                        height: 45px;
                        border-radius: 10px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        color: white;
                        font-size: 1.2rem;
                    }
                    .relatorio-secao-title {
                        font-size: 1.3rem;
                        font-weight: 600;
                        color: #1e293b;
                        margin: 0;
                    }
                    .relatorio-paragrafo {
                        margin: 0 0 14px 0;
                        color: #475569;
                        text-align: justify;
                        font-size: 0.95rem;
                        line-height: 1.8;
                    }
                    .relatorio-item-lista {
                        margin: 10px 0;
                        padding-left: 25px;
                        position: relative;
                        color: #475569;
                        line-height: 1.8;
                        font-size: 0.95rem;
                    }
                    .relatorio-item-lista::before {
                        content: '▸';
                        position: absolute;
                        left: 0;
                        color: #2563eb;
                        font-weight: bold;
                    }
                    .relatorio-destaque-box {
                        background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                        border-left: 4px solid #f59e0b;
                        padding: 15px 20px;
                        margin: 20px 0;
                        border-radius: 8px;
                        font-weight: 600;
                        color: #92400e;
                    }
                    .relatorio-sidebar {
                        width: 320px;
                        flex-shrink: 0;
                        display: flex;
                        flex-direction: column;
                        gap: 20px;
                    }
                    .relatorio-sidebar-box {
                        background: white;
                        border-radius: 12px;
                        padding: 20px;
                        box-shadow: 0 2px 8px rgba(0,0,0,0.06);
                        border-top: 3px solid #2563eb;
                    }
                    .relatorio-sidebar-header {
                        display: flex;
                        align-items: center;
                        gap: 10px;
                        margin-bottom: 15px;
                        padding-bottom: 12px;
                        border-bottom: 2px solid #f1f5f9;
                    }
                    .relatorio-sidebar-header i {
                        color: #2563eb;
                        font-size: 1.2rem;
                    }
                    .relatorio-sidebar-header h4 {
                        font-size: 1.1rem;
                        font-weight: 600;
                        color: #1e293b;
                        margin: 0;
                    }
                    .relatorio-sidebar-content {
                        display: flex;
                        flex-direction: column;
                        gap: 15px;
                    }
                    .relatorio-insight-item {
                        display: flex;
                        gap: 12px;
                        padding: 12px;
                        background: #f8fafc;
                        border-radius: 8px;
                        border-left: 3px solid #3b82f6;
                    }
                    .relatorio-insight-item i {
                        color: #2563eb;
                        font-size: 1.1rem;
                        flex-shrink: 0;
                    }
                    .relatorio-insight-item p {
                        margin: 0;
                        color: #475569;
                        font-size: 0.9rem;
                        line-height: 1.6;
                    }
                    .relatorio-indicator {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 12px;
                        background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
                        border-radius: 8px;
                        border-left: 3px solid #2563eb;
                    }
                    .relatorio-indicator-label {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        color: #475569;
                        font-size: 0.9rem;
                    }
                    .relatorio-indicator-label i {
                        color: #2563eb;
                    }
                    .relatorio-indicator-value {
                        font-size: 1.8rem;
                        font-weight: 700;
                        color: #2563eb;
                    }
                    .relatorio-resumo-section {
                        margin-top: 10px;
                    }
                    .relatorio-resumo-section strong {
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        color: #1e293b;
                        font-size: 0.95rem;
                        margin-bottom: 10px;
                    }
                    .relatorio-resumo-section ul {
                        margin: 0;
                        padding-left: 25px;
                        color: #475569;
                        font-size: 0.9rem;
                        line-height: 1.7;
                    }
                    .relatorio-footer-fixed {
                        background: linear-gradient(135deg, #1e293b 0%, #334155 100%);
                        color: white;
                        padding: 25px 40px;
                        border-top: 3px solid rgba(255,255,255,0.1);
                    }
                    .relatorio-footer-content {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        flex-wrap: wrap;
                        gap: 20px;
                        margin-bottom: 15px;
                    }
                    .relatorio-footer-left p,
                    .relatorio-footer-right p {
                        margin: 0;
                        font-size: 0.9rem;
                        opacity: 0.9;
                    }
                    .relatorio-footer-divider {
                        height: 1px;
                        background: rgba(255, 255, 255, 0.2);
                        margin: 15px 0;
                    }
                    .relatorio-footer-copyright {
                        text-align: center;
                        margin: 0;
                        font-size: 0.85rem;
                        opacity: 0.7;
                    }
                    @media print {
                        body { margin: 0; padding: 0; }
                        .relatorio-profissional { box-shadow: none; }
                        .relatorio-container { flex-direction: column; }
                        .relatorio-sidebar { width: 100%; }
                    }
                </style>
            ` : '';
            
            const html = '<!DOCTYPE html>' +
                '<html lang="pt-BR">' +
                '<head>' +
                '<meta charset="UTF-8">' +
                '<title>' + (titulo || 'Documento') + '</title>' +
                '<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">' +
                '<style>' +
                'body { font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif; padding: 20px; margin: 0; background: #f5f5f5; }' +
                'table { border-collapse: collapse; width: 100%; margin: 20px 0; }' +
                'th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }' +
                'th { background-color: #f2f2f2; }' +
                estilosRelatorio +
                '</style>' +
                '</head>' +
                '<body>' +
                conteudo +
                scriptTag +
                'window.onload = function() { window.print(); }' +
                scriptClose +
                '</body>' +
                '</html>';
            
            janela.document.open();
            janela.document.write(html);
            janela.document.close();
        }

        // ========== FUNÇÕES DO FLUXO VISUAL (OTIMIZADAS) ==========
        let navegacaoEmAndamento = false;
        
        function navegarParaEtapa(etapa) {
            // Prevenir múltiplas navegações simultâneas
            if (navegacaoEmAndamento) {
                return;
            }
            
            navegacaoEmAndamento = true;
            
            // Usar requestAnimationFrame para não bloquear a UI
            requestAnimationFrame(() => {
                try {
                    const tabMap = {
                        'swot': '#tab-swot',
                        'brainstorm': '#tab-brainstorm',
                        'forca-impacto': '#tab-forca-impacto',
                        'ishikawa': '#tab-ishikawa',
                        '5porques': '#tab-5porques',
                        '5w2h': '#tab-5w2h',
                        'pdca': '#tab-pdca',
                        'plano-acao': '#tab-plano-acao',
                        'relatorio': '#tab-relatorio'
                    };
                    
                    const tabSelector = tabMap[etapa];
                    if (tabSelector) {
                        const tab = document.querySelector(`[data-bs-target="${tabSelector}"]`);
                        if (tab) {
                            // Usar setTimeout para não bloquear
                            setTimeout(() => {
                                tab.click();
                                verificarHabilitacaoEtapa(etapa);
                                navegacaoEmAndamento = false;
                            }, 0);
                        } else {
                            navegacaoEmAndamento = false;
                        }
                    } else {
                        navegacaoEmAndamento = false;
                    }
                } catch (error) {
                    console.error('Erro ao navegar para etapa:', error);
                    navegacaoEmAndamento = false;
                }
            });
        }

        function atualizarProgressoGeral() {
            const etapas = ['swot', 'brainstorm', 'forca-impacto', 'ishikawa', '5porques', '5w2h', 'pdca', 'plano-acao', 'relatorio'];
            const concluidas = etapas.filter(e => statusEtapas[e] === 'concluido').length;
            const porcentagem = Math.round((concluidas / etapas.length) * 100);
            
            const progressBar = document.getElementById('progressoGeral');
            const textoProgresso = document.getElementById('textoProgresso');
            
            if (progressBar) {
                progressBar.style.width = porcentagem + '%';
                progressBar.setAttribute('aria-valuenow', porcentagem);
                
                // Mudar cor baseado na porcentagem
                progressBar.classList.remove('bg-success', 'bg-warning', 'bg-info');
                if (porcentagem === 100) {
                    progressBar.classList.add('bg-success');
                } else if (porcentagem >= 50) {
                    progressBar.classList.add('bg-info');
                } else {
                    progressBar.classList.add('bg-warning');
                }
            }
            
            if (textoProgresso) {
                textoProgresso.textContent = `${porcentagem}% Completo (${concluidas}/${etapas.length} etapas)`;
            }
        }

        function atualizarStatusEtapa(etapa, status) {
            statusEtapas[etapa] = status;
            const etapaEl = document.querySelector(`[data-etapa="${etapa}"]`);
            if (etapaEl) {
                // Remover classes de status anteriores
                etapaEl.classList.remove('pendente', 'em-andamento', 'concluido');
                // Adicionar nova classe
                etapaEl.classList.add(status);
                
                // Atualizar conectores
                atualizarConectores();
                
                // Atualizar progresso geral
                atualizarProgressoGeral();
                
                // Salvar status no localStorage
                salvarStatusEtapas();
            }
        }

        function limparTodoFluxo() {
            if (!confirm('Tem certeza que deseja limpar todo o progresso do fluxo?\n\nIsso resetará todas as etapas para "pendente", mas não apagará os dados salvos.')) {
                return;
            }
            
            // Resetar todos os status
            Object.keys(statusEtapas).forEach(etapa => {
                statusEtapas[etapa] = 'pendente';
                atualizarStatusEtapa(etapa, 'pendente');
            });
            
            // Limpar dados compartilhados
            dadosCompartilhados = {
                contexto: '',
                problemas: [],
                causas: [],
                acoes: [],
                prioridades: []
            };
            
            salvarStatusEtapas();
            alert('✅ Fluxo limpo com sucesso!');
        }

        function atualizarConectores() {
            const etapas = ['swot', 'brainstorm', 'forca-impacto', 'ishikawa', '5porques', '5w2h', 'pdca', 'plano-acao', 'relatorio'];
            const conectores = document.querySelectorAll('.fluxo-connector');
            
            conectores.forEach((connector, index) => {
                if (index < etapas.length - 1) {
                    const etapaAtual = etapas[index];
                    const statusAtual = statusEtapas[etapaAtual];
                    
                    if (statusAtual === 'concluido') {
                        connector.classList.add('concluido');
                    } else {
                        connector.classList.remove('concluido');
                    }
                }
            });
        }

        function verificarHabilitacaoEtapa(etapa) {
            const ordemEtapas = ['swot', 'brainstorm', 'forca-impacto', 'ishikawa', '5porques', '5w2h', 'pdca', 'plano-acao', 'relatorio'];
            const indexAtual = ordemEtapas.indexOf(etapa);
            
            // Sempre permitir acesso à primeira etapa
            if (indexAtual === 0) {
                return true;
            }
            
            // Verificar se etapas anteriores foram concluídas (opcional - pode ser flexível)
            // Por enquanto, apenas marcamos como "em-andamento" quando acessada
            if (statusEtapas[etapa] === 'pendente') {
                atualizarStatusEtapa(etapa, 'em-andamento');
            }
            
            return true;
        }

        function salvarStatusEtapas() {
            try {
                localStorage.setItem('statusEtapasQualidade', JSON.stringify(statusEtapas));
                localStorage.setItem('dadosCompartilhadosQualidade', JSON.stringify(dadosCompartilhados));
            } catch (error) {
                console.warn('⚠️ Erro ao salvar status:', error);
            }
        }

        function carregarStatusEtapas() {
            try {
                const statusSalvo = localStorage.getItem('statusEtapasQualidade');
                if (statusSalvo) {
                    statusEtapas = { ...statusEtapas, ...JSON.parse(statusSalvo) };
                }
                
                const dadosSalvos = localStorage.getItem('dadosCompartilhadosQualidade');
                if (dadosSalvos) {
                    dadosCompartilhados = { ...dadosCompartilhados, ...JSON.parse(dadosSalvos) };
                }
                
                // Aplicar status carregados
                Object.keys(statusEtapas).forEach(etapa => {
                    atualizarStatusEtapa(etapa, statusEtapas[etapa]);
                });
                
                // Atualizar progresso geral após carregar
                atualizarProgressoGeral();
            } catch (error) {
                console.warn('⚠️ Erro ao carregar status:', error);
            }
        }

        // Função para passar dados do Brainstorming para Força x Impacto (OTIMIZADA)
        function passarDadosBrainstormParaForcaImpacto() {
            // Usar requestAnimationFrame para não bloquear a UI
            requestAnimationFrame(() => {
                if (ideiasBrainstorm.length === 0) {
                    alert('⚠️ Nenhuma ideia do Brainstorming disponível para importar.\n\nCertifique-se de que:\n1. Você salvou o Brainstorming no projeto atual\n2. O projeto está selecionado\n3. Os dados foram carregados corretamente');
                    return;
                }
                
                // Usar setTimeout para operações DOM não bloquearem
                setTimeout(() => {
                    // Limpar itens existentes
                    itensPriorizacao = [];
                    
                    // Importar ideias (otimizado com for loop)
                    for (let i = 0; i < ideiasBrainstorm.length; i++) {
                        const ideia = ideiasBrainstorm[i];
                        itensPriorizacao.push({
                            id: ideia.id || Date.now() + Math.random() + i,
                            descricao: ideia.texto || ideia,
                            forca: 3,
                            impacto: 3,
                            x: 400,
                            y: 250
                        });
                    }
                    
                    // Renderizar de forma assíncrona
                    requestAnimationFrame(() => {
                        renderizarItensPriorizacao();
                        atualizarMatrizGrafico();
                        dadosCompartilhados.acoes = ideiasBrainstorm.map(i => i.texto || i);
                        salvarStatusEtapas();
                        
                        alert(`✅ ${ideiasBrainstorm.length} ideia(s) importada(s) do Brainstorming!`);
                    });
                }, 0);
            });
        }

        // Função para passar dados do Brainstorming/Força x Impacto para Ishikawa (OTIMIZADA)
        function passarDadosParaIshikawa() {
            // Usar requestAnimationFrame para não bloquear a UI
            requestAnimationFrame(() => {
                const causas = [];
                
                // Buscar causas do Brainstorming (otimizado com for loop)
                if (ideiasBrainstorm.length > 0) {
                    for (let i = 0; i < ideiasBrainstorm.length; i++) {
                        const ideia = ideiasBrainstorm[i];
                        if (ideia && ideia.texto) {
                            causas.push(ideia.texto);
                        }
                    }
                }
                
                // Buscar causas da Matriz Força x Impacto (otimizado)
                if (itensPriorizacao.length > 0) {
                    const causasSet = new Set(causas); // Usar Set para verificação O(1)
                    for (let i = 0; i < itensPriorizacao.length; i++) {
                        const item = itensPriorizacao[i];
                        if (item && item.descricao && !causasSet.has(item.descricao)) {
                            causas.push(item.descricao);
                            causasSet.add(item.descricao);
                        }
                    }
                }
                
                if (causas.length === 0) {
                    alert('⚠️ Nenhuma causa disponível para importar.\n\nCertifique-se de que:\n1. Você salvou o Brainstorming ou Matriz Força x Impacto no projeto atual\n2. O projeto está selecionado\n3. Os dados foram carregados corretamente');
                    return;
                }
                
                // Batch de operações DOM usando DocumentFragment
                const categorias = ['ishikawa-metodo', 'ishikawa-maoobra', 'ishikawa-material', 'ishikawa-maquina', 'ishikawa-meioambiente', 'ishikawa-medicao'];
                const causasPorCategoria = Math.ceil(causas.length / categorias.length);
                
                // Usar setTimeout para não bloquear
                setTimeout(() => {
                    for (let i = 0; i < categorias.length; i++) {
                        const campo = document.getElementById(categorias[i]);
                        if (campo) {
                            const inicio = i * causasPorCategoria;
                            const fim = Math.min(inicio + causasPorCategoria, causas.length);
                            const causasCategoria = causas.slice(inicio, fim);
                            campo.value = causasCategoria.join('\n');
                        }
                    }
                    
                    dadosCompartilhados.causas = causas;
                    salvarStatusEtapas();
                    
                    alert(`✅ ${causas.length} causa(s) importada(s) para o Diagrama de Ishikawa!`);
                }, 0);
            });
        }

        // Função para passar dados do Ishikawa para 5 Porquês
        function passarDadosPara5Porques() {
            const todasCausas = [];
            
            // Coletar causas de todas as categorias do Ishikawa
            const categorias = ['ishikawa-metodo', 'ishikawa-maoobra', 'ishikawa-material', 'ishikawa-maquina', 'ishikawa-meioambiente', 'ishikawa-medicao'];
            categorias.forEach(catId => {
                const campo = document.getElementById(catId);
                if (campo && campo.value.trim()) {
                    const causas = campo.value.trim().split('\n').filter(c => c.trim());
                    todasCausas.push(...causas);
                }
            });
            
            if (todasCausas.length === 0) {
                alert('Nenhuma causa encontrada no Diagrama de Ishikawa.');
                return;
            }
            
            // Preencher o problema do 5 Porquês com a primeira causa ou problema do Ishikawa
            const problemaIshikawa = document.getElementById('problemaIshikawa')?.value || '';
            if (problemaIshikawa) {
                document.getElementById('problema5porques').value = problemaIshikawa;
            } else if (todasCausas.length > 0) {
                document.getElementById('problema5porques').value = todasCausas[0];
            }
            
            dadosCompartilhados.problemas = todasCausas;
            salvarStatusEtapas();
            
            alert(`✅ Dados do Ishikawa importados para 5 Porquês!`);
        }

        // Função para passar dados para 5W2H
        // Função para passar dados do 5 Porquês para 5W2H (OTIMIZADA)
        function passarDadosPara5W2H() {
            // Usar requestAnimationFrame para não bloquear a UI
            requestAnimationFrame(() => {
                // Buscar informações do 5 Porquês
                const problema5Porques = document.getElementById('problema5porques')?.value || '';
                const causaRaiz = document.getElementById('causaRaiz')?.value || '';
                
                if (!problema5Porques && !causaRaiz) {
                    alert('Complete o 5 Porquês primeiro para importar dados.');
                    return;
                }
                
                // Usar setTimeout para operações DOM não bloquearem
                setTimeout(() => {
                    // Se não houver linhas no 5W2H, criar uma nova
                    if (linhas5W2H.length === 0) {
                        adicionarLinha5W2H();
                    }
                    
                    // Preencher a primeira linha com dados do 5 Porquês
                    const primeiraLinha = linhas5W2H[0];
                    if (primeiraLinha) {
                        const linhaEl = document.getElementById(`linha-5w2h-${primeiraLinha.id}`);
                        if (linhaEl) {
                            const campoWhat = linhaEl.querySelector(`#what-${primeiraLinha.id}`);
                            const campoWhy = linhaEl.querySelector(`#why-${primeiraLinha.id}`);
                            
                            if (campoWhat && problema5Porques) {
                                campoWhat.value = problema5Porques;
                            }
                            if (campoWhy && causaRaiz) {
                                campoWhy.value = causaRaiz;
                            }
                        }
                    }
                    
                    // Renderizar de forma assíncrona
                    requestAnimationFrame(() => {
                        renderizarLinhas5W2H();
                        alert('✅ Dados do 5 Porquês importados para 5W2H!');
                    });
                }, 0);
            });
        }

        // ========== FUNÇÕES SWOT ==========
        function adicionarItemSwot(quadrante) {
            const container = document.getElementById(`swot-${quadrante}`);
            const novoItem = document.createElement('div');
            novoItem.className = 'mb-2 d-flex gap-2';
            novoItem.innerHTML = `
                <input type="text" class="form-control form-control-sm swot-item" placeholder="Adicione um item..." data-quadrante="${quadrante}">
                <button class="btn btn-sm btn-outline-danger" onclick="removerItemSwot(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            container.appendChild(novoItem);
        }

        function removerItemSwot(btn) {
            btn.closest('.mb-2').remove();
        }

        function obterItensSwot() {
            const itens = {
                forcas: [],
                fraquezas: [],
                oportunidades: [],
                ameacas: []
            };
            
            document.querySelectorAll('.swot-item').forEach(input => {
                const valor = input.value.trim();
                if (valor) {
                    const quadrante = input.getAttribute('data-quadrante');
                    if (itens[quadrante]) {
                        itens[quadrante].push(valor);
                    }
                }
            });
            
            return itens;
        }

        async function salvarSwot() {
            if (!verificarProjeto()) return;
            
            const titulo = document.getElementById('tituloSwot').value;
            if (!titulo) {
                alert('Por favor, preencha o título.');
                return;
            }
            
            const dados = {
                contexto: document.getElementById('contextoSwot').value,
                itens: obterItensSwot()
            };
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/ferramentas-qualidade', {
                    method: 'POST',
                    headers: { ...headers, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tipo_ferramenta: 'swot',
                        titulo: titulo,
                        dados: dados,
                        projeto_id: projetoAtual?.id || null
                    }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('✅ SWOT salva com sucesso no projeto "' + projetoAtual.titulo + '"!');
                    ferramentaAtualId = data.ferramenta?.id;
                    atualizarStatusEtapa('swot', 'concluido');
                    // Salvar contexto nos dados compartilhados
                    dadosCompartilhados.contexto = document.getElementById('contextoSwot').value;
                    salvarStatusEtapas();
                } else {
                    alert('❌ Erro ao salvar: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao salvar SWOT:', error);
                alert('❌ Erro ao salvar SWOT: ' + error.message);
            }
        }

        function limparSwot() {
            document.getElementById('tituloSwot').value = '';
            document.getElementById('contextoSwot').value = '';
            document.querySelectorAll('.swot-item').forEach(input => {
                if (input.value.trim()) {
                    input.value = '';
                }
            });
            ferramentaAtualId = null;
        }

        function exportarSwot() {
            const titulo = document.getElementById('tituloSwot').value || 'Análise SWOT';
            const contexto = document.getElementById('contextoSwot').value;
            const itens = obterItensSwot();
            
            const conteudo = `
                <h2>${titulo}</h2>
                ${contexto ? `<p><strong>Contexto:</strong> ${contexto}</p>` : ''}
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 20px;">
                    <div>
                        <h3 style="color: #28a745;">Forças</h3>
                        <ul>${itens.forcas.map(f => `<li>${f}</li>`).join('') || '<li>Nenhuma força registrada</li>'}</ul>
                    </div>
                    <div>
                        <h3 style="color: #dc3545;">Fraquezas</h3>
                        <ul>${itens.fraquezas.map(f => `<li>${f}</li>`).join('') || '<li>Nenhuma fraqueza registrada</li>'}</ul>
                    </div>
                    <div>
                        <h3 style="color: #17a2b8;">Oportunidades</h3>
                        <ul>${itens.oportunidades.map(o => `<li>${o}</li>`).join('') || '<li>Nenhuma oportunidade registrada</li>'}</ul>
                    </div>
                    <div>
                        <h3 style="color: #ffc107;">Ameaças</h3>
                        <ul>${itens.ameacas.map(a => `<li>${a}</li>`).join('') || '<li>Nenhuma ameaça registrada</li>'}</ul>
                    </div>
                </div>
            `;
            
            imprimirConteudo(conteudo, titulo);
        }

        // ========== FUNÇÕES SWOT ==========
        async function gerarSwotComIA() {
            const contexto = document.getElementById('contextoSwot').value;
            if (!contexto) {
                alert('Por favor, preencha o contexto/problema para gerar a análise com IA.');
                return;
            }
            
            try {
                // Usar módulo de orquestração
                if (window.executarFerramentaIA) {
                    const resultado = await window.executarFerramentaIA('swot', contexto);
                    
                    if (resultado.success && resultado.dados) {
                        const swot = resultado.dados.swot || resultado.dados;
                        
                        // Preencher os campos com a resposta da IA
                        swot.forcas?.forEach(f => {
                            adicionarItemSwot('forcas');
                        });
                        swot.fraquezas?.forEach(f => {
                            adicionarItemSwot('fraquezas');
                        });
                        swot.oportunidades?.forEach(o => {
                            adicionarItemSwot('oportunidades');
                        });
                        swot.ameacas?.forEach(a => {
                            adicionarItemSwot('ameacas');
                        });
                        
                        // Preencher valores
                        setTimeout(() => {
                            const inputs = document.querySelectorAll('.swot-item');
                            const valores = [
                                ...(swot.forcas || []),
                                ...(swot.fraquezas || []),
                                ...(swot.oportunidades || []),
                                ...(swot.ameacas || [])
                            ];
                            
                            valores.forEach((valor, i) => {
                                if (inputs[i]) inputs[i].value = valor;
                            });
                        }, 100);
                        
                        alert('✅ Análise SWOT gerada com sucesso pela IA!');
                    } else {
                        alert('❌ Erro ao gerar análise: ' + (resultado.error || 'Erro desconhecido'));
                    }
                } else {
                    // Fallback para método antigo se módulo não estiver disponível
                    throw new Error('Módulo de IA não disponível');
                }
            } catch (error) {
                console.error('Erro ao gerar SWOT com IA:', error);
                
                // Fallback para método antigo
                try {
                    const headers = await getAuthHeaders();
                    const response = await fetch('/api/ferramentas-qualidade/ia/swot', {
                        method: 'POST',
                        headers: { ...headers, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contexto: contexto }),
                        credentials: 'include'
                    });
                    
                    const data = await response.json();
                    if (data.success && data.swot) {
                        const swot = data.swot;
                        swot.forcas?.forEach(f => adicionarItemSwot('forcas'));
                        swot.fraquezas?.forEach(f => adicionarItemSwot('fraquezas'));
                        swot.oportunidades?.forEach(o => adicionarItemSwot('oportunidades'));
                        swot.ameacas?.forEach(a => adicionarItemSwot('ameacas'));
                        
                        setTimeout(() => {
                            const inputs = document.querySelectorAll('.swot-item');
                            let idx = 0;
                            [...swot.forcas || [], ...swot.fraquezas || [], ...swot.oportunidades || [], ...swot.ameacas || []].forEach((valor, i) => {
                                if (inputs[i]) inputs[i].value = valor;
                            });
                        }, 100);
                        
                        alert('✅ Análise SWOT gerada com sucesso pela IA!');
                    } else {
                        alert('❌ Erro ao gerar análise: ' + (data.error || 'Erro desconhecido'));
                    }
                } catch (fallbackError) {
                    alert('❌ Erro ao gerar análise: ' + error.message);
                }
            }
        }

        // ========== FUNÇÕES FORÇA X IMPACTO ==========
        let itensPriorizacao = [];

        function adicionarItemPriorizacao() {
            const descricao = prompt('Digite a descrição do item:');
            if (!descricao) return;
            
            const item = {
                id: Date.now(),
                descricao: descricao,
                forca: 3,
                impacto: 3,
                x: 400,
                y: 250
            };
            
            itensPriorizacao.push(item);
            renderizarItensPriorizacao();
        }

        function renderizarItensPriorizacao() {
            const container = document.getElementById('lista-itens-priorizar');
            container.innerHTML = '';
            
            if (itensPriorizacao.length === 0) {
                container.innerHTML = '<p class="text-muted small">Adicione itens ou importe do Brainstorming</p>';
                atualizarMatrizGrafico();
                return;
            }
            
            itensPriorizacao.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'card mb-2';
                div.innerHTML = `
                    <div class="card-body p-2">
                        <small><strong>${index + 1}.</strong> ${item.descricao}</small>
                        <div class="mt-1">
                            <div class="input-group input-group-sm">
                                <span class="input-group-text">Força:</span>
                                <input type="number" min="1" max="5" class="form-control" value="${item.forca}" 
                                    onchange="atualizarItemPriorizacao(${item.id}, 'forca', this.value)">
                            </div>
                            <div class="input-group input-group-sm mt-1">
                                <span class="input-group-text">Impacto:</span>
                                <input type="number" min="1" max="5" class="form-control" value="${item.impacto}" 
                                    onchange="atualizarItemPriorizacao(${item.id}, 'impacto', this.value)">
                            </div>
                        </div>
                        <button class="btn btn-sm btn-danger w-100 mt-1" onclick="removerItemPriorizacao(${item.id})">
                            <i class="fas fa-trash"></i> Remover
                        </button>
                    </div>
                `;
                container.appendChild(div);
            });
            
            atualizarMatrizGrafico();
        }

        function atualizarItemPriorizacao(id, campo, valor) {
            const item = itensPriorizacao.find(i => i.id === id);
            if (item) {
                item[campo] = parseInt(valor) || 1;
                // Calcular posição no gráfico
                item.x = 50 + ((item.forca - 1) * 140);
                item.y = 450 - ((item.impacto - 1) * 100);
                atualizarMatrizGrafico();
            }
        }

        function removerItemPriorizacao(id) {
            itensPriorizacao = itensPriorizacao.filter(i => i.id !== id);
            renderizarItensPriorizacao();
        }

        function atualizarMatrizGrafico() {
            const svg = document.getElementById('matriz-svg');
            if (!svg) return;
            
            // Remover marcadores antigos (exceto os elementos base)
            const marcadoresAntigos = svg.querySelectorAll('.item-marcador');
            marcadoresAntigos.forEach(m => m.remove());
            
            // Adicionar marcadores para cada item
            itensPriorizacao.forEach((item, index) => {
                const x = 50 + ((item.forca - 1) * 140);
                const y = 450 - ((item.impacto - 1) * 100);
                
                // Criar círculo para o item
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('class', 'item-marcador');
                circle.setAttribute('cx', x);
                circle.setAttribute('cy', y);
                circle.setAttribute('r', '8');
                circle.setAttribute('fill', '#667eea');
                circle.setAttribute('stroke', '#fff');
                circle.setAttribute('stroke-width', '2');
                circle.setAttribute('data-index', index);
                circle.style.cursor = 'pointer';
                
                // Criar texto com número do item
                const text = document.createElementNS('http://www.w3.org/2000/svg', 'text');
                text.setAttribute('class', 'item-marcador');
                text.setAttribute('x', x);
                text.setAttribute('y', y - 12);
                text.setAttribute('text-anchor', 'middle');
                text.setAttribute('font-size', '10');
                text.setAttribute('font-weight', 'bold');
                text.setAttribute('fill', '#fff');
                text.textContent = (index + 1).toString();
                
                svg.appendChild(circle);
                svg.appendChild(text);
            });
        }

        async function importarDoBrainstorm() {
            // Usar função de passagem de dados
            passarDadosBrainstormParaForcaImpacto();
        }

        async function analisarComIA() {
            if (itensPriorizacao.length === 0) {
                alert('Adicione itens primeiro ou importe do Brainstorming.');
                return;
            }
            
            const descricoes = itensPriorizacao.map(i => i.descricao).join(', ');
            
            try {
                // Usar módulo de orquestração
                if (window.executarFerramentaIA) {
                    const resultado = await window.executarFerramentaIA('forcaImpacto', descricoes);
                    
                    if (resultado.success && resultado.dados) {
                        const priorizacoes = resultado.dados.priorizacoes || resultado.dados;
                        
                        if (Array.isArray(priorizacoes)) {
                            priorizacoes.forEach((p, idx) => {
                                if (itensPriorizacao[idx]) {
                                    itensPriorizacao[idx].forca = p.forca || 3;
                                    itensPriorizacao[idx].impacto = p.impacto || 3;
                                }
                            });
                        } else if (priorizacoes.length && Array.isArray(priorizacoes)) {
                            // Formato alternativo
                            priorizacoes.forEach((p, idx) => {
                                if (itensPriorizacao[idx]) {
                                    itensPriorizacao[idx].forca = p.forca || 3;
                                    itensPriorizacao[idx].impacto = p.impacto || 3;
                                }
                            });
                        }
                        
                        renderizarItensPriorizacao();
                        alert('✅ Priorização gerada com sucesso pela IA!');
                    } else {
                        alert('❌ Erro ao analisar: ' + (resultado.error || 'Erro desconhecido'));
                    }
                } else {
                    throw new Error('Módulo de IA não disponível');
                }
            } catch (error) {
                console.error('Erro ao analisar com IA:', error);
                
                // Fallback para método antigo
                try {
                    const headers = await getAuthHeaders();
                    const response = await fetch('/api/ferramentas-qualidade/ia/priorizacao', {
                        method: 'POST',
                        headers: { ...headers, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ itens: descricoes }),
                        credentials: 'include'
                    });
                    
                    const data = await response.json();
                    if (data.success && data.priorizacoes) {
                        data.priorizacoes.forEach((p, idx) => {
                            if (itensPriorizacao[idx]) {
                                itensPriorizacao[idx].forca = p.forca || 3;
                                itensPriorizacao[idx].impacto = p.impacto || 3;
                            }
                        });
                        renderizarItensPriorizacao();
                        alert('✅ Priorização gerada com sucesso pela IA!');
                    } else {
                        alert('❌ Erro ao analisar: ' + (data.error || 'Erro desconhecido'));
                    }
                } catch (fallbackError) {
                    alert('❌ Erro ao analisar: ' + error.message);
                }
            }
        }

        async function salvarForcaImpacto() {
            const titulo = document.getElementById('tituloForcaImpacto').value;
            if (!titulo) {
                alert('Por favor, preencha o título.');
                return;
            }
            
            const dados = {
                descricao: document.getElementById('descricaoForcaImpacto').value,
                itens: itensPriorizacao
            };
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/ferramentas-qualidade', {
                    method: 'POST',
                    headers: { ...headers, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tipo_ferramenta: 'forca_impacto',
                        titulo: titulo,
                        dados: dados
                    }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('✅ Matriz Força x Impacto salva com sucesso!');
                    ferramentaAtualId = data.ferramenta?.id;
                    atualizarStatusEtapa('forca-impacto', 'concluido');
                    salvarStatusEtapas();
                } else {
                    alert('❌ Erro ao salvar: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao salvar Força x Impacto:', error);
                alert('❌ Erro ao salvar: ' + error.message);
            }
        }

        function limparForcaImpacto() {
            document.getElementById('tituloForcaImpacto').value = '';
            document.getElementById('descricaoForcaImpacto').value = '';
            itensPriorizacao = [];
            renderizarItensPriorizacao();
            ferramentaAtualId = null;
        }

        function exportarForcaImpacto() {
            const titulo = document.getElementById('tituloForcaImpacto').value || 'Matriz Força x Impacto';
            const descricao = document.getElementById('descricaoForcaImpacto').value;
            
            const conteudo = `
                <h2>${titulo}</h2>
                ${descricao ? `<p><strong>Descrição:</strong> ${descricao}</p>` : ''}
                <h3>Itens Priorizados:</h3>
                <table border="1" style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr>
                            <th>Item</th>
                            <th>Força</th>
                            <th>Impacto</th>
                            <th>Prioridade</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${itensPriorizacao.map(item => `
                            <tr>
                                <td>${item.descricao}</td>
                                <td>${item.forca}</td>
                                <td>${item.impacto}</td>
                                <td>${item.forca * item.impacto}</td>
                            </tr>
                        `).join('') || '<tr><td colspan="4">Nenhum item registrado</td></tr>'}
                    </tbody>
                </table>
            `;
            
            imprimirConteudo(conteudo, titulo);
        }

        // ========== FUNÇÕES DE INTEGRAÇÃO COM IA ==========
        async function assistenteQualidade(ferramenta) {
            const prompts = {
                'swot': 'Explique o que é a ferramenta SWOT e como aplicá-la em um caso prático.',
                'brainstorm': 'Explique o que é Brainstorming e como aplicá-lo em um caso prático.',
                'forca-impacto': 'Explique o que é a Matriz Força x Impacto e como aplicá-la em um caso prático.',
                'ishikawa': 'Explique o que é o Diagrama de Ishikawa e como aplicá-lo em um caso prático.',
                '5porques': 'Explique o que é a ferramenta 5 Porquês e como aplicá-la em um caso prático.',
                '5w2h': 'Explique o que é a ferramenta 5W2H e como aplicá-la em um caso prático.',
                'pdca': 'Explique o que é o PDCA e como aplicá-lo em um caso prático.',
                'plano-acao': 'Explique o que é um Plano de Ação e como estruturá-lo corretamente.'
            };
            
            const prompt = prompts[ferramenta] || 'Explique esta ferramenta de qualidade.';
            
            try {
                // Usar módulo de orquestração quando aplicável
                const ferramentasComModulo = {
                    'ishikawa': 'ishikawa',
                    '5porques': 'cincoPorques',
                    '5w2h': 'cincoW2H',
                    'pdca': 'pdca',
                    'plano-acao': 'planoAcao'
                };
                
                const ferramentaModulo = ferramentasComModulo[ferramenta];
                
                if (ferramentaModulo && window.executarFerramentaIA) {
                    // Usar módulo para ferramentas específicas
                    const resultado = await window.executarFerramentaIA(ferramentaModulo, prompt);
                    
                    if (resultado.success && resultado.resposta) {
                        alert('Ajuda da IA:\n\n' + resultado.resposta);
                        return;
                    }
                }
                
                // Fallback para método antigo (assistente genérico)
                const headers = await getAuthHeaders();
                const response = await fetch('/api/ferramentas-qualidade/ia/assistente', {
                    method: 'POST',
                    headers: { ...headers, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        ferramenta: ferramenta,
                        prompt: prompt 
                    }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                if (data.success && data.resposta) {
                    alert('Ajuda da IA:\n\n' + data.resposta);
                } else {
                    alert('❌ Erro ao obter ajuda: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao obter ajuda da IA:', error);
                alert('❌ Erro ao obter ajuda: ' + error.message);
            }
        }

        // Função para formatar o relatório de forma profissional
        function formatarRelatorioProfissional(relatorioTexto, titulo, projeto) {
            const dataAtual = new Date().toLocaleDateString('pt-BR', { 
                day: '2-digit', 
                month: 'long', 
                year: 'numeric' 
            });
            
            // Mapeamento de emojis/títulos para ícones e cores
            const mapeamentoSecoes = {
                '💼': { icon: 'fas fa-briefcase', title: 'Relatório de Análise', color: '#2563eb' },
                '📌': { icon: 'fas fa-map-pin', title: 'Dados do Projeto', color: '#3b82f6' },
                '🧠': { icon: 'fas fa-brain', title: 'Resumo Executivo', color: '#6366f1' },
                '🔍': { icon: 'fas fa-search', title: 'Problema Identificado', color: '#8b5cf6' },
                '⚙️': { icon: 'fas fa-cogs', title: 'Análise Realizada', color: '#a855f7' },
                '🧩': { icon: 'fas fa-puzzle-piece', title: 'Causas Raiz', color: '#ec4899' },
                '🚀': { icon: 'fas fa-rocket', title: 'Ações Planejadas', color: '#f59e0b' },
                '🎯': { icon: 'fas fa-bullseye', title: 'Resultados Esperados', color: '#10b981' },
                '🔄': { icon: 'fas fa-sync-alt', title: 'Próximos Passos', color: '#06b6d4' },
                '🤖': { icon: 'fas fa-robot', title: 'Observação Final', color: '#64748b' }
            };
            
            // Dividir o relatório em seções baseado em emojis ou títulos
            const linhas = relatorioTexto.split('\n');
            let secoes = [];
            let secaoAtual = { titulo: '', conteudo: [], emoji: '' };
            
            linhas.forEach(linha => {
                linha = linha.trim();
                if (!linha) return;
                
                // Detectar emojis ou títulos em maiúsculas
                const emojiMatch = linha.match(/^([💼📌🧠🔍⚙️🧩🚀🎯🔄🤖])\s/);
                const tituloMatch = linha.match(/^([A-ZÁÀÂÃÉÊÍÓÔÕÚÇ\s]{3,})$/);
                const tituloNumerado = linha.match(/^(\d+[\.\)]\s)/);
                const markdownTitle = linha.match(/^(#{1,3})\s/);
                
                if (emojiMatch) {
                    if (secaoAtual.titulo || secaoAtual.conteudo.length > 0) {
                        secoes.push(secaoAtual);
                    }
                    secaoAtual = { 
                        titulo: linha.replace(emojiMatch[0], '').trim(), 
                        conteudo: [], 
                        emoji: emojiMatch[1] 
                    };
                } else if (tituloMatch || tituloNumerado || markdownTitle) {
                    if (secaoAtual.titulo || secaoAtual.conteudo.length > 0) {
                        secoes.push(secaoAtual);
                    }
                    secaoAtual = { titulo: linha, conteudo: [], emoji: '' };
                } else {
                    secaoAtual.conteudo.push(linha);
                }
            });
            
            if (secaoAtual.titulo || secaoAtual.conteudo.length > 0) {
                secoes.push(secaoAtual);
            }
            
            // Se não conseguiu dividir em seções, usar o texto completo
            if (secoes.length === 0 || (secoes.length === 1 && !secoes[0].titulo)) {
                secoes = [{ titulo: '', conteudo: linhas.filter(l => l.trim()), emoji: '' }];
            }
            
            // Extrair informações para sidebar
            const causasRaiz = [];
            const acoesPlanejadas = [];
            const resultadosEsperados = [];
            
            secoes.forEach(secao => {
                if (secao.emoji === '🧩' || secao.titulo.toLowerCase().includes('causa')) {
                    secao.conteudo.forEach(item => {
                        if (item.trim() && !item.match(/^[A-Z]/)) {
                            causasRaiz.push(item.trim());
                        }
                    });
                }
                if (secao.emoji === '🚀' || secao.titulo.toLowerCase().includes('ação')) {
                    secao.conteudo.forEach(item => {
                        if (item.trim() && !item.match(/^[A-Z]/)) {
                            acoesPlanejadas.push(item.trim());
                        }
                    });
                }
                if (secao.emoji === '🎯' || secao.titulo.toLowerCase().includes('resultado')) {
                    secao.conteudo.forEach(item => {
                        if (item.trim() && !item.match(/^[A-Z]/)) {
                            resultadosEsperados.push(item.trim());
                        }
                    });
                }
            });
            
            // Construir HTML profissional com layout de duas colunas
            htmlFormatado = `
                <div class="relatorio-profissional">
                    <!-- Cabeçalho Fixo -->
                    <div class="relatorio-header-fixed">
                        <div class="relatorio-header-content">
                            <div class="relatorio-logo-section">
                                <div class="relatorio-logo">
                                    <svg width="60" height="60" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
                                        <defs>
                                            <linearGradient id="logoGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                                <stop offset="0%" style="stop-color:#2563eb;stop-opacity:1" />
                                                <stop offset="50%" style="stop-color:#3b82f6;stop-opacity:1" />
                                                <stop offset="100%" style="stop-color:#60a5fa;stop-opacity:1" />
                                            </linearGradient>
                                        </defs>
                                        <circle cx="50" cy="50" r="45" fill="url(#logoGradient)" opacity="0.15"/>
                                        <path d="M30 30 L50 20 L70 30 L70 50 L50 60 L30 50 Z" fill="url(#logoGradient)"/>
                                        <path d="M40 40 L50 35 L60 40 L60 50 L50 55 L40 50 Z" fill="white" opacity="0.95"/>
                                    </svg>
                                </div>
                                <div class="relatorio-empresa">
                                    <h1 class="relatorio-empresa-nome">Grupo Multimodal</h1>
                                    <p class="relatorio-empresa-subtitulo">Sistema de Gestão da Qualidade</p>
                                </div>
                            </div>
                            <div class="relatorio-header-badge">
                                <i class="fas fa-file-alt"></i>
                                <span>Relatório de Análise de Projeto</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Container Principal -->
                    <div class="relatorio-container">
                        <!-- Conteúdo Principal -->
                        <div class="relatorio-main-content">
                            <!-- Dados do Projeto -->
                            <div class="relatorio-projeto-box">
                                <div class="relatorio-projeto-header">
                                    <div class="relatorio-projeto-icon-box">
                                        <i class="fas fa-map-pin"></i>
                                    </div>
                                    <h2 class="relatorio-projeto-title">📌 Dados do Projeto</h2>
                                </div>
                                <div class="relatorio-projeto-grid">
                                    <div class="relatorio-projeto-item">
                                        <i class="fas fa-folder-open"></i>
                                        <div>
                                            <strong>Projeto:</strong>
                                            <span>${projeto?.titulo || 'Não especificado'}</span>
                                        </div>
                                    </div>
                                    <div class="relatorio-projeto-item">
                                        <i class="fas fa-info-circle"></i>
                                        <div>
                                            <strong>Status:</strong>
                                            <span>${projeto?.status || 'Em Andamento'}</span>
                                        </div>
                                    </div>
                                    <div class="relatorio-projeto-item">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        <div>
                                            <strong>Problema:</strong>
                                            <span>${projeto?.problema || 'Não especificado'}</span>
                                        </div>
                                    </div>
                                    <div class="relatorio-projeto-item">
                                        <i class="fas fa-calendar-alt"></i>
                                        <div>
                                            <strong>Data:</strong>
                                            <span>${dataAtual}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Seções do Relatório -->
                            <div class="relatorio-secoes">
                                ${secoes.map((secao, index) => {
                                    const secaoInfo = secao.emoji ? mapeamentoSecoes[secao.emoji] : null;
                                    const icone = secaoInfo?.icon || 'fas fa-file-alt';
                                    const corSecao = secaoInfo?.color || '#64748b';
                                    
                                    return `
                                        <div class="relatorio-secao-card" style="border-left-color: ${corSecao};">
                                            ${secao.titulo ? `
                                                <div class="relatorio-secao-header">
                                                    <div class="relatorio-secao-icon-box" style="background: ${corSecao};">
                                                        <i class="${icone}"></i>
                                                    </div>
                                                    <h3 class="relatorio-secao-title">
                                                        ${secao.emoji ? secao.emoji + ' ' : ''}${secao.titulo}
                                                    </h3>
                                                </div>
                                            ` : ''}
                                            <div class="relatorio-secao-body">
                                                ${secao.conteudo.map(paragrafo => {
                                                    // Detectar listas
                                                    if (paragrafo.match(/^[-•*]\s/) || paragrafo.match(/^\d+[\.\)]\s/)) {
                                                        return `<div class="relatorio-item-lista">${paragrafo.replace(/^[-•*]\s/, '• ')}</div>`;
                                                    }
                                                    // Detectar destaques
                                                    if (paragrafo.match(/^(IMPORTANTE|ATENÇÃO|CONCLUSÃO|RECOMENDAÇÃO)/i)) {
                                                        return `<div class="relatorio-destaque-box">${paragrafo}</div>`;
                                                    }
                                                    return `<p class="relatorio-paragrafo">${paragrafo}</p>`;
                                                }).join('')}
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        </div>
                        
                        <!-- Sidebar com Insights e Indicadores -->
                        <div class="relatorio-sidebar">
                            <!-- Insights da IA -->
                            <div class="relatorio-sidebar-box">
                                <div class="relatorio-sidebar-header">
                                    <i class="fas fa-robot"></i>
                                    <h4>Insights da IA</h4>
                                </div>
                                <div class="relatorio-sidebar-content">
                                    <div class="relatorio-insight-item">
                                        <i class="fas fa-lightbulb"></i>
                                        <p>Este relatório foi gerado automaticamente por Inteligência Artificial, com base nas informações registradas no sistema.</p>
                                    </div>
                                    <div class="relatorio-insight-item">
                                        <i class="fas fa-chart-line"></i>
                                        <p>Recomenda-se monitorar os indicadores de qualidade após a implementação das ações planejadas.</p>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Indicadores-Chave -->
                            <div class="relatorio-sidebar-box">
                                <div class="relatorio-sidebar-header">
                                    <i class="fas fa-chart-bar"></i>
                                    <h4>Indicadores-Chave</h4>
                                </div>
                                <div class="relatorio-sidebar-content">
                                    <div class="relatorio-indicator">
                                        <div class="relatorio-indicator-label">
                                            <i class="fas fa-puzzle-piece"></i>
                                            Causas Identificadas
                                        </div>
                                        <div class="relatorio-indicator-value">${causasRaiz.length}</div>
                                    </div>
                                    <div class="relatorio-indicator">
                                        <div class="relatorio-indicator-label">
                                            <i class="fas fa-rocket"></i>
                                            Ações Planejadas
                                        </div>
                                        <div class="relatorio-indicator-value">${acoesPlanejadas.length}</div>
                                    </div>
                                    <div class="relatorio-indicator">
                                        <div class="relatorio-indicator-label">
                                            <i class="fas fa-bullseye"></i>
                                            Resultados Esperados
                                        </div>
                                        <div class="relatorio-indicator-value">${resultadosEsperados.length}</div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Resumo Rápido -->
                            ${causasRaiz.length > 0 || acoesPlanejadas.length > 0 ? `
                                <div class="relatorio-sidebar-box">
                                    <div class="relatorio-sidebar-header">
                                        <i class="fas fa-list-ul"></i>
                                        <h4>Resumo Rápido</h4>
                                    </div>
                                    <div class="relatorio-sidebar-content">
                                        ${causasRaiz.length > 0 ? `
                                            <div class="relatorio-resumo-section">
                                                <strong><i class="fas fa-puzzle-piece"></i> Principais Causas:</strong>
                                                <ul>
                                                    ${causasRaiz.slice(0, 3).map(causa => `<li>${causa}</li>`).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                        ${acoesPlanejadas.length > 0 ? `
                                            <div class="relatorio-resumo-section">
                                                <strong><i class="fas fa-rocket"></i> Ações Prioritárias:</strong>
                                                <ul>
                                                    ${acoesPlanejadas.slice(0, 3).map(acao => `<li>${acao}</li>`).join('')}
                                                </ul>
                                            </div>
                                        ` : ''}
                                    </div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    
                    <!-- Rodapé Fixo -->
                    <div class="relatorio-footer-fixed">
                        <div class="relatorio-footer-content">
                            <div class="relatorio-footer-left">
                                <p>
                                    <i class="fas fa-robot"></i>
                                    Relatório gerado automaticamente por Inteligência Artificial
                                </p>
                            </div>
                            <div class="relatorio-footer-right">
                                <p>Página 1 | ${dataAtual}</p>
                            </div>
                        </div>
                        <div class="relatorio-footer-divider"></div>
                        <p class="relatorio-footer-copyright">
                            © ${new Date().getFullYear()} Grupo Multimodal — Todos os direitos reservados.
                        </p>
                    </div>
                </div>
            `;
            
            return htmlFormatado;
        }
        // ========== FUNÇÕES DE RELATÓRIO ==========
        async function gerarRelatorioCompleto() {
            // Verificar se há projeto selecionado para o relatório
            if (!projetoSelecionadoRelatorio) {
                alert('⚠️ Por favor, selecione um projeto antes de gerar o relatório.');
                document.getElementById('selectProjetoRelatorio')?.focus();
                return;
            }
            
            const titulo = document.getElementById('tituloRelatorio').value || projetoSelecionadoRelatorio.titulo || 'Relatório de Análise';
            const contexto = document.getElementById('contextoRelatorio').value;
            
            // Mostrar loading
            const conteudoRelatorio = document.getElementById('conteudoRelatorio');
            conteudoRelatorio.innerHTML = `
                <div class="text-center py-5">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Gerando relatório...</span>
                    </div>
                    <p class="text-muted">Gerando relatório para o projeto "${projetoSelecionadoRelatorio.titulo}"...</p>
                </div>
            `;
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/ferramentas-qualidade/ia/relatorio', {
                    method: 'POST',
                    headers: { ...headers, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        titulo: titulo,
                        contexto: contexto,
                        projeto_id: projetoSelecionadoRelatorio.id // Usar o projeto selecionado para o relatório
                    }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                if (data.success && data.relatorio) {
                    // Formatar relatório de forma profissional
                    const relatorioFormatado = formatarRelatorioProfissional(
                        data.relatorio,
                        titulo,
                        projetoSelecionadoRelatorio
                    );
                    
                    conteudoRelatorio.innerHTML = relatorioFormatado;
                    alert('✅ Relatório gerado com sucesso para o projeto "' + projetoSelecionadoRelatorio.titulo + '"!');
                } else {
                    conteudoRelatorio.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Erro:</strong> ${data.error || 'Erro desconhecido ao gerar relatório'}
                        </div>
                    `;
                    alert('❌ Erro ao gerar relatório: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao gerar relatório:', error);
                conteudoRelatorio.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Erro:</strong> ${error.message}
                    </div>
                `;
                alert('❌ Erro ao gerar relatório: ' + error.message);
            }
        }

        async function solicitarFeedbackIA() {
            const feedback = document.getElementById('feedbackIA').value;
            if (!feedback) {
                alert('Por favor, digite sua pergunta.');
                return;
            }
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/ferramentas-qualidade/ia/feedback', {
                    method: 'POST',
                    headers: { ...headers, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ feedback: feedback }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                if (data.success && data.resposta) {
                    document.getElementById('conteudoFeedbackIA').innerHTML = data.resposta.replace(/\n/g, '<br>');
                    document.getElementById('respostaFeedbackIA').style.display = 'block';
                } else {
                    alert('❌ Erro ao obter resposta: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao solicitar feedback:', error);
                alert('❌ Erro ao solicitar feedback: ' + error.message);
            }
        }

        function exportarRelatorioPDF() {
            const conteudo = document.getElementById('conteudoRelatorio').innerHTML;
            if (!conteudo || conteudo.includes('fa-robot')) {
                alert('Gere um relatório primeiro.');
                return;
            }
            
            const titulo = document.getElementById('tituloRelatorio').value || 'Relatório de Análise';
            imprimirConteudo(conteudo, titulo);
        }

        async function salvarRelatorio() {
            const titulo = document.getElementById('tituloRelatorio').value;
            const conteudo = document.getElementById('conteudoRelatorio').innerHTML;
            
            if (!titulo || conteudo.includes('fa-robot')) {
                alert('Gere um relatório primeiro.');
                return;
            }
            
            try {
                const headers = await getAuthHeaders();
                const response = await fetch('/api/ferramentas-qualidade', {
                    method: 'POST',
                    headers: { ...headers, 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        tipo_ferramenta: 'relatorio',
                        titulo: titulo,
                        dados: {
                            contexto: document.getElementById('contextoRelatorio').value,
                            conteudo: conteudo
                        }
                    }),
                    credentials: 'include'
                });
                
                const data = await response.json();
                if (data.success) {
                    alert('✅ Relatório salvo com sucesso!');
                    ferramentaAtualId = data.ferramenta?.id;
                    atualizarStatusEtapa('relatorio', 'concluido');
                    salvarStatusEtapas();
                } else {
                    alert('❌ Erro ao salvar: ' + (data.error || 'Erro desconhecido'));
                }
            } catch (error) {
                console.error('Erro ao salvar relatório:', error);
                alert('❌ Erro ao salvar: ' + error.message);
            }
        }

        function limparRelatorio() {
            document.getElementById('tituloRelatorio').value = '';
            document.getElementById('contextoRelatorio').value = '';
            document.getElementById('feedbackIA').value = '';
            document.getElementById('conteudoRelatorio').innerHTML = `
                <p class="text-muted text-center">
                    <i class="fas fa-robot fa-3x mb-3 d-block"></i>
                    Clique em "Gerar Relatório com IA" para criar um relatório consolidado de todas as etapas.
                </p>
            `;
            document.getElementById('respostaFeedbackIA').style.display = 'none';
            ferramentaAtualId = null;
        }

    </script>
    
    <!-- Chat IA -->
    <link rel="stylesheet" href="css/chat-ia.css">
    <script src="js/chat-ia.js"></script>
</body>
</html>
