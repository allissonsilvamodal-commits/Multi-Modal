<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios Inteligentes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #f093fb;
            --success: #11998e;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --dark: #0f0f23;
            --white: #ffffff;
            --glass: rgba(255, 255, 255, 0.09);
            --glass-border: rgba(255, 255, 255, 0.14);
            --text-primary: #ffffff;
            --text-secondary: rgba(255,255,255,0.85);
            --border-radius: 22px;
            --box-shadow: 0 8px 32px rgba(0,0,0,.24);
            --transition: all 0.4s cubic-bezier(0.4,0,0.2,1);
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg,#0f0f23 0%,#1a1a2e 64%,#16213e 100%);
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
        }
        #particles-js { position: fixed; top: 0; left:0; width: 100vw;height: 100vh;z-index:-1; }
        .light-effect {
            position:absolute; z-index:-1; border-radius:50%; filter:blur(45px); animation: float 7s infinite alternate ease-in-out; opacity:.5;
        }
        .light-effect:nth-child(1){width:300px;height:300px;background:radial-gradient(circle,#667eea30 0%,transparent 78%);top:14%;left:7%;}
        .light-effect:nth-child(2){width:260px;height:280px;background:radial-gradient(circle,#f093fb25 0%,transparent 80%);bottom:14%;right:7%;animation-delay:2s;}
        .light-effect:nth-child(3){width:220px;height:200px;background:radial-gradient(circle,#764ba240 0%,transparent 85%);top:60%;left:52%;animation-delay:4s;}
        @keyframes float { 0%,100%{transform:translateY(0) scale(1);} 50%{transform:translateY(-14px) scale(1.06);} }
        .navbar {
            background: rgba(15,15,35,0.90);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.23);
        }
        .navbar-brand { font-weight: 700; font-size: 1.6rem;background: linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip: text;-webkit-text-fill-color: transparent; background-clip:text; }
        .nav-tabs { border: none;margin-bottom: 0 !important; position: relative; z-index: 10;}
        .nav-tabs .nav-link { color: var(--text-secondary); background: var(--glass); margin-right:6px; border:none; border-radius: 12px 12px 0 0; padding:12px 20px; font-size:0.95rem; font-weight: 600; transition: var(--transition); }
        .nav-tabs .nav-link.active { background: linear-gradient(90deg,#667eea80,#764ba260,#f093fb15); color: var(--primary); border-bottom:2.5px solid var(--accent); }
        .main-container { padding: 1.5rem 0 1rem 0; min-height:calc(100vh - 70px);}        
        .main-container .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 0 1.5rem; 
            position: relative;
            box-sizing: border-box;
        }
        
        
        /* Garantir que abas ocultas não ocupem espaço */
        #abaColetas[style*="display: none"],
        #abaBI[style*="display: none"],
        #abaCadastros[style*="display: none"],
        #abaBIGestao[style*="display: none"] {
            display: none !important;
            height: 0 !important;
            overflow: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        @media (max-width: 1200px) {
            .main-container .container {
                padding: 0 1rem;
            }
        }
        @media (max-width: 768px) {
            .main-container .container {
                padding: 0 0.75rem;
            }
        }
        #abaBI, #abaCadastros, #abaBIGestao { 
            width: 100%; 
            max-width: 100%;
            padding: 0; 
            margin: 0; 
            position: relative;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        .card-futuristic,.metric-card { background: var(--glass); border-radius: var(--border-radius); border:1.5px solid var(--glass-border); box-shadow: var(--box-shadow); backdrop-filter:blur(18px); position:relative; transition: var(--transition);overflow:hidden;}
        .card-futuristic {margin-bottom:1.5rem;}
        .card-futuristic:hover{ box-shadow:0 14px 52px 0 #222b4e2c; border:1.5px solid var(--primary);}        
        .metric-card { text-align:center; padding:1.5rem 0 1.3rem 0; }
        .metric-value { font-size:1.6rem;font-weight:800; letter-spacing:-1px; margin-bottom: .35rem; background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text; }
        .metric-label { font-size:0.9rem;color:var(--text-secondary);font-weight:600;}
        .filter-card{ background: var(--glass); border: 1px solid var(--glass-border);border-radius: 12px;box-shadow:0 2px 20px #23213e13;margin-bottom:1.2rem;padding:0.9rem 1rem; }
        .form-label { color:var(--text-secondary);font-weight:600;margin-bottom:.4rem; font-size:0.85rem;}
        .form-select, .form-control {background:rgba(255,255,255,0.11);color:#fff; border:1.2px solid var(--glass-border); border-radius: 10px;padding:.6rem .9rem; font-size:0.9rem;}
        .form-select:focus,.form-control:focus{outline:none;border-color:var(--primary);} 
        .dashboard-row {display:flex;gap:1.2rem;flex-wrap:wrap; margin-bottom:1.2rem}
        .dashboard-row>.col,.dashboard-row>div{flex:1 1 180px;min-width:160px;}
        .charts-row {display:flex;gap:1.2rem;flex-wrap:wrap;margin-bottom:1.2rem}
        .charts-row>.card-futuristic{flex:1 1 280px;min-width:260px;}

        /* Harmonizar layout de BI Disparos, Cadastros e BI Gestão */
        #abaBI .dashboard-row,
        #abaBIGestao .dashboard-row,
        #abaCadastros .dashboard-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.2rem;
            margin-bottom: 1.2rem;
        }
        #abaBI .metric-card,
        #abaBIGestao .metric-card,
        #abaCadastros .metric-card {
            height: 100%;
        }
        #abaBI .charts-row,
        #abaBIGestao .charts-row,
        #abaCadastros .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.2rem;
            margin-bottom: 1.2rem;
        }
        #abaBI .charts-row .card-futuristic,
        #abaBIGestao .charts-row .card-futuristic,
        #abaCadastros .charts-row .card-futuristic {
            height: 380px;
            min-height: 380px;
            max-height: 380px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-sizing: border-box;
        }
        #abaBI .charts-row .card-futuristic .chart-container,
        #abaBIGestao .charts-row .card-futuristic .chart-container,
        #abaCadastros .charts-row .card-futuristic .chart-container {
            flex: 1 1 0;
            height: calc(380px - 55px);
            max-height: calc(380px - 55px);
            min-height: 0;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            box-sizing: border-box;
            padding: 0.75rem 1rem;
        }
        #abaBI .charts-row .card-futuristic .chart-container canvas,
        #abaBIGestao .charts-row .card-futuristic .chart-container canvas,
        #abaCadastros .charts-row .card-futuristic .chart-container canvas {
            max-width: calc(100% - 2rem) !important;
            max-height: calc(100% - 1.5rem) !important;
            width: auto !important;
            height: auto !important;
            box-sizing: border-box;
        }
        #abaBI .filter-card .row,
        #abaBIGestao .filter-card .row,
        #abaCadastros .filter-card .row {
            display: grid !important;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 0.85rem 1.2rem;
            margin: 0;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        #abaBI .filter-card .row > div,
        #abaBIGestao .filter-card .row > div,
        #abaCadastros .filter-card .row > div {
            width: 100%;
            max-width: 100%;
            padding: 0;
            box-sizing: border-box;
        }
        /* Garantir que a aba do BI Gestão respeite o padding do container */
        #abaBIGestao {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        #abaBIGestao .dashboard-row,
        #abaBIGestao .filter-card,
        #abaBIGestao .charts-row {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            margin-left: 0;
            margin-right: 0;
        }
        #abaBIGestao .card-futuristic {
            max-width: 100%;
            box-sizing: border-box;
        }
        .chart-container { 
            background:none;
            padding:0.75rem 1rem;
            border-radius:10px;
            position:relative;
            display:flex;
            align-items:center;
            justify-content:center;
            overflow:hidden;
            box-sizing:border-box;
        }
        .chart-container canvas { 
            max-width:calc(100% - 2rem) !important;
            max-height:calc(100% - 1.5rem) !important;
            width:auto !important;
            height:auto !important;
            box-sizing:border-box;
        }
        .card-header-futuristic {
            padding:0.75rem 1rem;
            border-bottom:1px solid var(--glass-border);
            margin-bottom:0;
            height:auto;
            min-height:45px;
            max-height:55px;
            flex-shrink:0;
            box-sizing:border-box;
        }
        .card-header-futuristic h5 {
            margin:0;
            font-size:0.95rem;
            font-weight:700;
            line-height:1.3;
        }
        .table-tech thead th {background:rgba(102,126,234,0.08);color:var(--text-primary);font-weight:700;}
        .table-tech th, .table-tech td{font-size:1rem; color:var(--text-primary); padding:1rem .7rem;}
        .loading-overlay { position: fixed; inset: 0; background: rgba(28,20,65,0.20); display: none; align-items: center; justify-content: center; z-index: 1050; }
        .spinner { width: 40px; height: 40px; border: 4px solid #dbeafe; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width:1020px){ .dashboard-row,.charts-row{flex-direction:column;gap:1.3rem;} }
        /* Botões futurísticos e toggle de tema */
        .btn-futuristic { background: linear-gradient(135deg, var(--primary), var(--secondary)); border: none; border-radius: 50px; padding: 0.75rem 1.2rem; font-weight: 600; color: #fff; transition: var(--transition); position: relative; overflow: hidden; }
        .btn-futuristic:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102,126,234,0.35); }
        .theme-toggle { background: var(--glass); border: 1px solid var(--glass-border); border-radius: 50px; padding: 8px 14px; color: var(--text-primary); transition: var(--transition); backdrop-filter: blur(10px); }
        .theme-toggle:hover { background: rgba(102,126,234,0.20); box-shadow: 0 0 18px rgba(102, 126, 234, 0.28); transform: translateY(-1px); }
        /* Cabeçalho de cards */
        .card-header-futuristic { 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            border-radius: var(--border-radius) var(--border-radius) 0 0; 
            padding: 0.75rem 1rem; 
            border: none; 
            position: relative; 
            overflow: hidden;
            flex-shrink: 0;
            min-height: 45px;
        }
        .card-header-futuristic h5 { 
            color: #fff; 
            margin: 0; 
            font-weight: 700; 
            font-size: 0.95rem; 
            line-height: 1.4;
        }
        .card-header-futuristic::before { content: ''; position: absolute; inset: 0; background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.12) 50%, transparent 70%); animation: shimmer 3s infinite; }
        @keyframes shimmer { 0% { transform: translateX(-100%);} 100% { transform: translateX(100%);} }
        /* Light mode overrides */
        body.light-mode { color: #0f0f23; background: linear-gradient(135deg, #eef2ff 0%, #f8fafc 60%, #ffffff 100%); }
        body.light-mode .navbar { background: rgba(255,255,255,0.85); border-bottom: 1px solid rgba(0,0,0,0.08); }
        body.light-mode .navbar-brand { -webkit-text-fill-color: initial; background: linear-gradient(135deg, #4f46e5, #a855f7); -webkit-background-clip: text; background-clip: text; }
        body.light-mode .card-futuristic, body.light-mode .metric-card, body.light-mode .filter-card { background: rgba(255,255,255,0.75); border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 8px 26px rgba(0,0,0,0.10); }
        body.light-mode .metric-label, body.light-mode .form-label { color: #334155; }
        /* Corrigir metric-value no tema claro - remover transparência e usar cor sólida */
        body.light-mode .metric-value { 
            -webkit-text-fill-color: #4f46e5 !important; 
            background: linear-gradient(135deg, #4f46e5, #a855f7) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            color: #4f46e5 !important;
        }
        /* Corrigir card-header no tema claro */
        body.light-mode .card-header-futuristic h5 { color: #fff !important; }
        body.light-mode .card-header-futuristic { background: linear-gradient(135deg, #4f46e5, #764ba2) !important; }
        /* Corrigir textos gerais no tema claro */
        body.light-mode, body.light-mode * { color: #0f172a; }
        body.light-mode .table-tech thead th { background: #eef2ff; color: #0f172a; }
        body.light-mode .table-tech td, body.light-mode .table-tech th { color: #0f172a; }
        body.light-mode .form-select, body.light-mode .form-control { background: rgba(255,255,255,0.95); color: #0f172a; border: 1px solid rgba(0,0,0,0.12); }
        /* Corrigir selects no modo escuro */
        .form-select option, .form-control option { background: #1a1a2e; color: #fff; }
        body.light-mode .form-select option, body.light-mode .form-control option { background: #fff; color: #0f172a; }
        /* Input date no modo escuro */
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        body.light-mode input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0); }
        body.light-mode .nav-tabs .nav-link { color: #334155; background: rgba(0,0,0,0.04); }
        body.light-mode .nav-tabs .nav-link.active { color: #4f46e5; border-bottom-color: #a855f7; background: linear-gradient(90deg, #e0e7ff, #f3e8ff, #fdf4ff); }
        body.light-mode .theme-toggle { color: #0f172a; background: rgba(255,255,255,0.8); border: 1px solid rgba(0,0,0,0.08); }
        /* Corrigir textos dentro de cards e containers */
        body.light-mode .card-body, body.light-mode .card-body * { color: #0f172a !important; }
        body.light-mode .p-3, body.light-mode .p-4, body.light-mode .p-5 { color: #0f172a !important; }
        body.light-mode .text-muted { color: #64748b !important; }
        body.light-mode .alert { color: #0f172a !important; }
        body.light-mode .alert-info { background: rgba(59, 130, 246, 0.1) !important; border-left-color: #3b82f6 !important; color: #0f172a !important; }
        body.light-mode .badge { color: #0f172a !important; }
        body.light-mode h5, body.light-mode h6 { color: #0f172a !important; }
        body.light-mode ul, body.light-mode li { color: #0f172a !important; }
        body.light-mode span { color: inherit; }
        /* Corrigir loading overlay no tema claro */
        body.light-mode .loading-overlay { background: rgba(255,255,255,0.85) !important; }
        body.light-mode .loading-text { color: #0f172a !important; }
        /* Corrigir ícones e elementos com cor branca */
        body.light-mode .fas, body.light-mode .far, body.light-mode .fab { color: inherit; }
        body.light-mode .text-success { color: #059669 !important; }
        body.light-mode .text-danger { color: #dc2626 !important; }
        body.light-mode .text-warning { color: #d97706 !important; }
        body.light-mode .text-info { color: #0284c7 !important; }
    </style>
</head>
<body>
    <div class="light-effect"></div>
    <div class="light-effect"></div>
    <div class="light-effect"></div>
    <div id="particles-js"></div>
    <nav class="navbar navbar-expand-lg">
        <div class="container d-flex justify-content-between align-items-center">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <i class="fas fa-chart-bar me-2"></i> Relatórios Inteligentes
            </a>
            <div class="d-flex align-items-center gap-2">
                <a href="portal.html" class="btn btn-futuristic"><i class="fas fa-arrow-left me-2"></i>Voltar ao Portal</a>
                <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
            </div>
        </div>
    </nav>
    <div class="main-container">
    <div class="container">
            <ul class="nav nav-tabs" id="tabsRelatorios">
                <li class="nav-item"><button class="nav-link active" id="tabColetas" onclick="mostrarAba('coletas')">Coletas</button></li>
                <li class="nav-item"><button class="nav-link" id="tabBI" onclick="mostrarAba('bi')">BI Disparos</button></li>
				<li class="nav-item"><button class="nav-link" id="tabCadastros" onclick="mostrarAba('cadastros')">Cadastros</button></li>
                <li class="nav-item"><button class="nav-link" id="tabBIGestao" onclick="mostrarAba('bi-gestao')">BI Gestão de Dados</button></li>
            </ul>
            <div id="abaColetas">
                <div class="dashboard-row">
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="totalColetas">0</div>
                        <div class="metric-label"><i class="fas fa-box"></i> Total de Coletas</div>
                </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="emAndamento">0</div>
                        <div class="metric-label"><i class="fas fa-clock"></i> Em Andamento</div>
            </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="concluidas">0</div>
                        <div class="metric-label"><i class="fas fa-check-circle"></i> Concluídas</div>
                </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="canceladas">0</div>
                        <div class="metric-label"><i class="fas fa-times-circle"></i> Canceladas</div>
            </div>
                </div>
                <div class="filter-card">
            <div class="row">
                        <div class="col-md-4 mb-2">
                    <label class="form-label"><i class="fas fa-calendar"></i> Período</label>
                    <select id="filtroPeriodo" class="form-select">
                        <option value="hoje">Hoje</option>
                        <option value="semana" selected>Esta Semana</option>
                        <option value="mes">Este Mês</option>
                        <option value="ano">Este Ano</option>
                        <option value="todos">Todos</option>
                    </select>
                </div>
                        <div class="col-md-4 mb-2">
                    <label class="form-label"><i class="fas fa-user"></i> Usuário</label>
                    <select id="filtroUsuario" class="form-select">
                        <option value="">Todos os usuários</option>
                    </select>
                </div>
                        <div class="col-md-4 mb-2 d-flex align-items-end">
                            <button class="btn btn-futuristic w-100" onclick="aplicarFiltros()">
                                <i class="fas fa-filter me-1"></i>Aplicar Filtros
                    </button>
                </div>
            </div>
        </div>
                <div class="charts-row">
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-chart-pie me-2"></i>Distribuição por Status</h5></div>
                        <div class="chart-container"><canvas id="chartStatus"></canvas></div>
                    </div>
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-chart-bar me-2"></i>Coletas por Mês</h5></div>
                        <div class="chart-container"><canvas id="chartMensal"></canvas></div>
                    </div>
                </div>
                <div class="charts-row">
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-users me-2"></i>Performance por Usuário</h5></div>
                        <div class="chart-container"><canvas id="chartUsuarios"></canvas></div>
            </div>
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-priority-high me-2"></i>Por Prioridade</h5></div>
                        <div class="chart-container"><canvas id="chartPrioridade"></canvas></div>
                    </div>
                    </div>
                <div class="card-futuristic">
                    <div class="card-header-futuristic"><h5><i class="fas fa-table me-2"></i>Relatório Detalhado</h5></div>
            <div class="table-responsive p-3">
                <table class="table table-tech">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Título</th>
                            <th>Status</th>
                            <th>Etapa</th>
                            <th>Data</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaRelatorio">
                                <tr><td colspan="6" class="text-center text-muted py-4">Carregando dados...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
                <div class="dashboard-row">
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="tempoMedio">0</div>
                        <div class="metric-label"><i class="fas fa-clock"></i> Tempo Médio</div>
                </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="taxaSucesso">0%</div>
                        <div class="metric-label"><i class="fas fa-percentage"></i> Taxa de Sucesso</div>
            </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="noPrazo">0</div>
                        <div class="metric-label"><i class="fas fa-calendar-check"></i> No Prazo</div>
                </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="atrasadas">0</div>
                        <div class="metric-label"><i class="fas fa-exclamation-triangle"></i> Atrasadas</div>
            </div>
                </div>
            </div>
            <div id="abaBI" style="display:none">
                <div class="dashboard-row">
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="kpiTotalDisp">0</div>
                        <div class="metric-label"><i class="fas fa-paper-plane"></i> Total de Disparos</div>
                </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="kpiUsuariosDisp">0</div>
                        <div class="metric-label"><i class="fas fa-users"></i> Usuários Enviando</div>
            </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="kpiDepartamentosDisp">0</div>
                        <div class="metric-label"><i class="fas fa-building"></i> Departamentos Ativos</div>
        </div>
                    </div>
                <div class="filter-card">
                    <div class="row">
                        <div class="col-md-2 mb-2">
                            <label class="form-label"><i class="fas fa-calendar"></i> Período</label>
                            <select id="filtroPeriodoDisp" class="form-select" onchange="atualizarVisibilidadeDatasDisp(); carregarDisparos();">
                                <option value="hoje">Hoje</option>
                                <option value="mes" selected>Este Mês</option>
                                <option value="ano">Este Ano</option>
                                <option value="todos">Todos</option>
                                <option value="personalizado">Personalizado</option>
                            </select>
                    </div>
                        <div class="col-md-2 mb-2" id="containerDataInicioDisp" style="display:none;">
                            <label class="form-label"><i class="fas fa-calendar-alt"></i> Data Início</label>
                            <input type="date" id="filtroDataInicioDisp" class="form-control" onchange="if(document.getElementById('filtroPeriodoDisp').value==='personalizado') carregarDisparos();">
                        </div>
                        <div class="col-md-2 mb-2" id="containerDataFimDisp" style="display:none;">
                            <label class="form-label"><i class="fas fa-calendar-check"></i> Data Fim</label>
                            <input type="date" id="filtroDataFimDisp" class="form-control" onchange="if(document.getElementById('filtroPeriodoDisp').value==='personalizado') carregarDisparos();">
                        </div>
                        <div class="col-md-3 mb-2" id="containerUsuarioDisp">
                            <label class="form-label"><i class="fas fa-user"></i> Usuário</label>
                            <select id="filtroUsuarioDisp" class="form-select" onchange="carregarDisparos()">
                                <option value="">Todos os usuários</option>
                            </select>
                </div>
                        <div class="col-md-3 mb-2" id="containerDepartamentoDisp">
                            <label class="form-label"><i class="fas fa-building"></i> Departamento</label>
                            <select id="filtroDepartamentoDisp" class="form-select" onchange="carregarDisparos()">
                                <option value="">Todos os departamentos</option>
                            </select>
            </div>
                    </div>
                    </div>
                <div class="charts-row">
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-user"></i> Disparos por Usuário</h5></div>
                        <div class="chart-container"><canvas id="chartUsuarioDisp"></canvas></div>
                </div>
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-building"></i> Disparos por Departamento</h5></div>
                        <div class="chart-container"><canvas id="chartDepartamentoDisp"></canvas></div>
            </div>
        </div>
                <div class="charts-row">
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-calendar"></i> Disparos por Período</h5></div>
                        <div class="chart-container"><canvas id="chartTemporalDisp"></canvas></div>
                    </div>
                </div>
                <div class="motoristas-falhas-section">
                    <div class="card-futuristic" style="margin-top: 0;">
                        <div class="card-header-futuristic">
                            <h5><i class="fas fa-exclamation-triangle me-2"></i>Motoristas com Falhas nos Disparos</h5>
                        </div>
                        <div class="p-4" style="padding-top: 1.5rem;">
                            <div class="dashboard-row" style="margin-top:0;">
                                <div class="metric-card card-futuristic">
                                    <div class="metric-value" id="statTotalFalhas">0</div>
                                    <div class="metric-label"><i class="fas fa-exclamation-triangle"></i> Total de Falhas</div>
                                </div>
                                <div class="metric-card card-futuristic">
                                    <div class="metric-value" id="statMotoristasUnicos">0</div>
                                    <div class="metric-label"><i class="fas fa-users"></i> Motoristas Únicos</div>
                                </div>
                                <div class="metric-card card-futuristic">
                                    <div class="metric-value" id="statFalhasUltimos7Dias">0</div>
                                    <div class="metric-label"><i class="fas fa-calendar-week"></i> Últimos 7 Dias</div>
                                </div>
                                <div class="metric-card card-futuristic">
                                    <div class="metric-value" id="statTaxaErroFalhas">0%</div>
                                    <div class="metric-label"><i class="fas fa-percentage"></i> Taxa de Erro</div>
                                </div>
                            </div>
                            <div class="alert alert-info mb-4" style="background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; color: var(--text-primary); border-radius: 10px; padding: 1rem 1.25rem;">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Registro de Falhas:</strong> Esta visão resume os números com problemas nos disparos. Clique abaixo para abrir o painel completo de correções.
                            </div>
                            <div class="row g-4 mb-4">
                                <div class="col-md-6">
                                    <div class="card-futuristic p-4" style="height: 100%;">
                                        <h6 class="mb-3" style="color: var(--text-primary); font-weight: 700;"><i class="fas fa-list-check me-2"></i>Funcionalidades</h6>
                                        <ul style="list-style: none; padding: 0; color: var(--text-secondary);">
                                            <li class="mb-3"><i class="fas fa-check-circle text-success me-2"></i>Visualizar todas as falhas de disparo</li>
                                            <li class="mb-3"><i class="fas fa-check-circle text-success me-2"></i>Filtrar por período, número ou nome</li>
                                            <li class="mb-3"><i class="fas fa-check-circle text-success me-2"></i>Editar telefones diretamente</li>
                                            <li class="mb-3"><i class="fas fa-check-circle text-success me-2"></i>Estatísticas em tempo real</li>
                                            <li class="mb-3"><i class="fas fa-check-circle text-success me-2"></i>Identificar motoristas não encontrados</li>
                                            <li class="mb-0"><i class="fas fa-check-circle text-success me-2"></i>Análise detalhada por motivo da falha</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card-futuristic p-4" style="height: 100%;">
                                        <h6 class="mb-3" style="color: var(--text-primary); font-weight: 700;"><i class="fas fa-chart-bar me-2"></i>Análise Rápida</h6>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span style="color: var(--text-secondary); font-size: 0.9rem;">Falhas por Motivo</span>
                                                <span class="badge" style="background: rgba(102, 126, 234, 0.2); color: var(--primary);" id="badgeMotivosFalhas">Carregando...</span>
                                            </div>
                                            <div class="progress" style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden;">
                                                <div class="progress-bar" role="progressbar" style="width: 0%; background: linear-gradient(90deg, var(--primary), var(--accent));" id="progressFalhas"></div>
                                            </div>
                                        </div>
                                        <div class="mt-4">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span style="color: var(--text-secondary); font-size: 0.9rem;">Última Atualização</span>
                                                <span style="color: var(--text-secondary); font-size: 0.85rem;" id="ultimaAtualizacaoFalhas">-</span>
                                            </div>
                                            <a href="motoristas-falhas.html" class="btn btn-futuristic w-100" target="_blank" style="margin-top: 0.5rem;">
                                                <i class="fas fa-external-link-alt me-2"></i>Abrir Página Completa
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="abaCadastros" style="display:none">
				<div class="dashboard-row">
					<div class="metric-card card-futuristic">
						<div class="metric-value" id="kpiTotalMot">0</div>
						<div class="metric-label"><i class="fas fa-id-card"></i> Total de Cadastros</div>
					</div>
					<div class="metric-card card-futuristic">
						<div class="metric-value" id="kpiUsuariosMot">0</div>
						<div class="metric-label"><i class="fas fa-users"></i> Usuários Cadastrando</div>
					</div>
					<div class="metric-card card-futuristic">
						<div class="metric-value" id="kpiDepartamentosMot">0</div>
						<div class="metric-label"><i class="fas fa-building"></i> Departamentos Ativos</div>
					</div>
				</div>
				<div class="filter-card">
					<div class="row">
						<div class="col-md-2 mb-2">
							<label class="form-label"><i class="fas fa-calendar"></i> Período</label>
							<select id="filtroPeriodoMot" class="form-select" onchange="atualizarVisibilidadeDatasMot(); carregarMotoristas();">
								<option value="hoje">Hoje</option>
								<option value="mes" selected>Este Mês</option>
								<option value="ano">Este Ano</option>
								<option value="todos">Todos</option>
								<option value="personalizado">Personalizado</option>
							</select>
						</div>
						<div class="col-md-2 mb-2" id="containerDataInicioMot" style="display:none;">
							<label class="form-label"><i class="fas fa-calendar-alt"></i> Data Início</label>
							<input type="date" id="filtroDataInicioMot" class="form-control" onchange="if(document.getElementById('filtroPeriodoMot').value==='personalizado') carregarMotoristas();">
						</div>
						<div class="col-md-2 mb-2" id="containerDataFimMot" style="display:none;">
							<label class="form-label"><i class="fas fa-calendar-check"></i> Data Fim</label>
							<input type="date" id="filtroDataFimMot" class="form-control" onchange="if(document.getElementById('filtroPeriodoMot').value==='personalizado') carregarMotoristas();">
						</div>
                        <div class="col-md-3 mb-2" id="containerUsuarioMot">
							<label class="form-label"><i class="fas fa-user"></i> Usuário</label>
							<select id="filtroUsuarioMot" class="form-select" onchange="carregarMotoristas()">
								<option value="">Todos os usuários</option>
							</select>
						</div>
                        <div class="col-md-3 mb-2" id="containerDepartamentoMot">
							<label class="form-label"><i class="fas fa-building"></i> Departamento</label>
							<select id="filtroDepartamentoMot" class="form-select" onchange="carregarMotoristas()">
								<option value="">Todos os departamentos</option>
							</select>
						</div>
					</div>
				</div>
				<div class="charts-row">
					<div class="card-futuristic">
						<div class="card-header-futuristic"><h5><i class="fas fa-user"></i> Cadastros por Usuário</h5></div>
						<div class="chart-container"><canvas id="chartUsuarioMot"></canvas></div>
					</div>
					<div class="card-futuristic">
						<div class="card-header-futuristic"><h5><i class="fas fa-building"></i> Cadastros por Departamento</h5></div>
						<div class="chart-container"><canvas id="chartDepartamentoMot"></canvas></div>
					</div>
				</div>
				<div class="charts-row">
					<div class="card-futuristic">
						<div class="card-header-futuristic"><h5><i class="fas fa-calendar"></i> Cadastros por Período</h5></div>
						<div class="chart-container"><canvas id="chartTemporalMot"></canvas></div>
					</div>
                    </div>
                </div>
            </div>
            
            <!-- ABA BI GESTÃO DE DADOS -->
            <div id="abaBIGestao" style="display:none">
                <div class="dashboard-row" style="margin-top: 0;">
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="totalLancamentosGestao">0</div>
                        <div class="metric-label"><i class="fas fa-database"></i> Total de Lançamentos</div>
                    </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="totalEditadosGestao">0</div>
                        <div class="metric-label"><i class="fas fa-edit"></i> Lançamentos Editados</div>
                    </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="taxaEdicaoGestao">0%</div>
                        <div class="metric-label"><i class="fas fa-percentage"></i> Taxa de Edição</div>
                    </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="tempoMedioRespostaGestao">0 min</div>
                        <div class="metric-label"><i class="fas fa-clock"></i> Tempo Médio de Resposta</div>
                    </div>
                </div>
                
                <div class="filter-card">
                    <div class="row">
                        <div class="col-md-4 mb-2">
                            <label class="form-label"><i class="fas fa-calendar"></i> Período</label>
                            <select id="filtroPeriodoGestao" class="form-select" onchange="atualizarVisibilidadeDatasGestao(); carregarBIGestao();">
                                <option value="todos" selected>Todos</option>
                                <option value="hoje">Hoje</option>
                                <option value="semana">Últimos 7 dias</option>
                                <option value="mes">Últimos 30 dias</option>
                                <option value="trimestre">Últimos 90 dias</option>
                                <option value="ano">Último ano</option>
                                <option value="personalizado">Personalizado</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-2" id="containerDataInicioGestao" style="display:none;">
                            <label class="form-label"><i class="fas fa-calendar-check"></i> Data Início</label>
                            <input type="date" id="filtroDataInicioGestao" class="form-control" onchange="if(document.getElementById('filtroPeriodoGestao').value==='personalizado') carregarBIGestao();">
                        </div>
                        <div class="col-md-4 mb-2" id="containerDataFimGestao" style="display:none;">
                            <label class="form-label"><i class="fas fa-calendar-check"></i> Data Fim</label>
                            <input type="date" id="filtroDataFimGestao" class="form-control" onchange="if(document.getElementById('filtroPeriodoGestao').value==='personalizado') carregarBIGestao();">
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label"><i class="fas fa-building"></i> Operação</label>
                            <select id="filtroOperacaoGestao" class="form-select" onchange="carregarBIGestao();">
                                <option value="">Todas</option>
                                <option value="Jaboatão">Jaboatão</option>
                                <option value="Usinas">Usinas</option>
                                <option value="Paraíba">Paraíba</option>
                                <option value="Alagoas">Alagoas</option>
                                <option value="Bahia">Bahia</option>
                                <option value="Ambev">Ambev</option>
                                <option value="Cabo">Cabo</option>
                                <option value="São paulo">São paulo</option>
                                <option value="Célula de documentação">Célula de documentação</option>
                                <option value="Contas a pagar">Contas a pagar</option>
                                <option value="Controladoria">Controladoria</option>
                                <option value="Price">Price</option>
                                <option value="Ti">Ti</option>
                                <option value="Célula contratação">Célula contratação</option>
                                <option value="Projetos">Projetos</option>
                                <option value="GR">GR</option>
                                <option value="Comercial">Comercial</option>
                                <option value="Customer Service">Customer Service</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="charts-row">
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-exclamation-triangle"></i> Lançamentos por Tipo de Erro</h5></div>
                        <div class="chart-container"><canvas id="chartTipoErroGestao"></canvas></div>
                    </div>
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-cogs"></i> Lançamentos por Operação</h5></div>
                        <div class="chart-container"><canvas id="chartOperacaoGestao"></canvas></div>
                    </div>
                </div>
                
                <div class="charts-row">
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-user-tie"></i> Top 10 Responsáveis</h5></div>
                        <div class="chart-container"><canvas id="chartResponsavelGestao"></canvas></div>
                    </div>
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-calendar"></i> Evolução Temporal</h5></div>
                        <div class="chart-container"><canvas id="chartTemporalGestao"></canvas></div>
                    </div>
                </div>
                
                <div class="charts-row">
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-sitemap"></i> Árvore de Perdas - Tipos de Erros</h5></div>
                        <div class="chart-container"><canvas id="chartUsuarioGestao"></canvas></div>
                    </div>
                </div>
            </div>
            
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="text-center"><div class="spinner"></div><p class="loading-text">Carregando relatórios...</p></div>
        </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
	<script src="js/permissions.js"></script>
    <script>
    function mostrarAba(aba) {
        document.getElementById('tabColetas').classList.toggle('active', aba==='coletas');
        document.getElementById('tabBI').classList.toggle('active', aba==='bi');
		const tabCad = document.getElementById('tabCadastros');
		if(tabCad) tabCad.classList.toggle('active', aba==='cadastros');
        const tabBIGestao = document.getElementById('tabBIGestao');
        if(tabBIGestao) tabBIGestao.classList.toggle('active', aba==='bi-gestao');
        
        // Ocultar todas as abas primeiro para evitar espaçamento
        const abaColetas = document.getElementById('abaColetas');
        const abaBI = document.getElementById('abaBI');
		const abaCad = document.getElementById('abaCadastros');
        const abaBIGestao = document.getElementById('abaBIGestao');
        
        if(abaColetas) abaColetas.style.display = 'none';
        if(abaBI) abaBI.style.display = 'none';
        if(abaCad) abaCad.style.display = 'none';
        if(abaBIGestao) abaBIGestao.style.display = 'none';
        
        // Mostrar apenas a aba selecionada
        if(aba==='coletas' && abaColetas) abaColetas.style.display = '';
        if(aba==='bi' && abaBI) abaBI.style.display = '';
        if(aba==='cadastros' && abaCad) abaCad.style.display = '';
        if(aba==='bi-gestao' && abaBIGestao) {
            abaBIGestao.style.display = '';
            if(typeof carregarBIGestao === 'function') {
                if(typeof atualizarVisibilidadeDatasGestao === 'function') atualizarVisibilidadeDatasGestao();
                carregarBIGestao();
            }
        }
        const navTabs = document.getElementById('tabsRelatorios');
        if (navTabs) {
            navTabs.style.marginBottom = '';
        }
        if(aba==='bi' && typeof carregarDisparos==='function' && typeof carregarFiltrosDisparos==='function') {
            // Sempre recarregar filtros e dados para refletir novos logs
            if(typeof atualizarVisibilidadeDatasDisp==='function') atualizarVisibilidadeDatasDisp();
            carregarFiltrosDisparos().then(async () => {
                await carregarDisparos();
                await carregarEstatisticasFalhas().catch(err => console.error('Erro estatísticas falhas:', err));
            });
        }
		if(aba==='cadastros'){
			(async ()=>{
				try{
					const st = await fetch('/api/auth/status', { credentials:'include' });
					if(handleUnauthorized(st)) return;
                    // Sempre recarregar filtros e dados de motoristas
					if(typeof atualizarVisibilidadeDatasMot==='function') atualizarVisibilidadeDatasMot();
                    await carregarFiltrosMotoristas();
                    await carregarMotoristas();
				}catch(e){ console.error('Erro ao carregar Motoristas:', e); }
			})();
		}
    }
    
    // ====== ESTATÍSTICAS DE FALHAS ======
    async function carregarEstatisticasFalhas() {
        try {
            const sb = await getSupabaseClientRel();
            if (!sb) {
                document.getElementById('statTotalFalhas').textContent = '0';
                document.getElementById('statMotoristasUnicos').textContent = '0';
                document.getElementById('statFalhasUltimos7Dias').textContent = '0';
                document.getElementById('statTaxaErroFalhas').textContent = '0%';
                return;
            }

            // Obter os mesmos filtros aplicados nos disparos
            const periodo = document.getElementById('filtroPeriodoDisp')?.value || 'mes';
            const usuarioId = document.getElementById('filtroUsuarioDisp')?.value || '';
            const departamento = document.getElementById('filtroDepartamentoDisp')?.value || '';
            
            let range;
            if(periodo === 'personalizado'){
                const dataInicio = document.getElementById('filtroDataInicioDisp')?.value;
                const dataFim = document.getElementById('filtroDataFimDisp')?.value;
                range = {
                    inicio: dataInicio ? new Date(dataInicio + 'T00:00:00') : null,
                    fim: dataFim ? new Date(dataFim + 'T23:59:59') : null
                };
            } else {
                range = periodoToRange(periodo);
            }

            // Construir query com filtros
            let query = sb
                .from('disparos_log')
                .select('numero, created_at, user_id, departamento')
                .eq('status', 'error');
            
            // Aplicar filtro de data
            if (range.inicio) {
                query = query.gte('created_at', range.inicio.toISOString());
            }
            if (range.fim) {
                query = query.lte('created_at', range.fim.toISOString());
            }
            
            // Aplicar filtro de usuário
            if (usuarioId) {
                query = query.eq('user_id', usuarioId);
            }
            
            // Aplicar filtro de departamento
            if (departamento) {
                query = query.eq('departamento', departamento);
            }
            
            const { data: falhas, error } = await query.order('created_at', { ascending: false });

            if (error) throw error;

            const totalFalhas = falhas ? falhas.length : 0;
            const numerosUnicos = new Set(falhas ? falhas.map(f => f.numero).filter(Boolean) : []);
            const motoristasUnicos = numerosUnicos.size;

            // Falhas dos últimos 7 dias (dentro do período filtrado)
            const seteDiasAtras = new Date();
            seteDiasAtras.setDate(seteDiasAtras.getDate() - 7);
            // Se o período filtrado começar antes de 7 dias atrás, usar o início do período
            const dataLimite = range.inicio && range.inicio > seteDiasAtras ? range.inicio : seteDiasAtras;
            const falhasUltimos7Dias = falhas ? falhas.filter(f => {
                const dataFalha = new Date(f.created_at);
                return dataFalha >= dataLimite;
            }).length : 0;

            // Calcular taxa de erro baseada no período filtrado
            // Buscar total de disparos no período para calcular taxa real
            let totalDisparosPeriodo = totalFalhas; // Por padrão, usar apenas falhas se não conseguir buscar total
            try {
                // Tentar buscar total de disparos no período via API
                const params = new URLSearchParams({
                    inicio: range.inicio ? range.inicio.toISOString() : '',
                    fim: range.fim ? range.fim.toISOString() : '',
                    usuarioId: usuarioId || '',
                    departamento: departamento || ''
                });
                const totalResp = await fetch(`/api/relatorios/disparos/kpis?${params}`, { credentials:'include' });
                if (totalResp.ok) {
                    const totalData = await totalResp.json();
                    totalDisparosPeriodo = totalData.total || totalFalhas;
                }
            } catch (e) {
                console.warn('Não foi possível buscar total de disparos para calcular taxa:', e);
            }
            
            const taxaErro = totalDisparosPeriodo > 0 ? ((totalFalhas / totalDisparosPeriodo) * 100).toFixed(1) : 0;

            // Agrupar por motivo (simplificado)
            const motivosMap = new Map();
            if (falhas && falhas.length > 0) {
                falhas.forEach(f => {
                    // Análise básica do número
                    const numeroLimpo = (f.numero || '').replace(/\D/g, '');
                    let motivo = 'outro';
                    if (!numeroLimpo || numeroLimpo.length < 10) motivo = 'numero_invalido';
                    else if (!numeroLimpo.startsWith('55')) motivo = 'sem_ddi';
                    else if (numeroLimpo.length > 15) motivo = 'numero_longo';
                    else motivo = 'outro';
                    
                    motivosMap.set(motivo, (motivosMap.get(motivo) || 0) + 1);
                });
            }
            const totalMotivos = Array.from(motivosMap.values()).reduce((a, b) => a + b, 0);
            const maiorMotivo = Array.from(motivosMap.entries()).sort((a, b) => b[1] - a[1])[0];
            const percentualMaiorMotivo = maiorMotivo && totalMotivos > 0 ? ((maiorMotivo[1] / totalMotivos) * 100).toFixed(0) : 0;

            // Atualizar elementos
            document.getElementById('statTotalFalhas').textContent = totalFalhas.toLocaleString('pt-BR');
            document.getElementById('statMotoristasUnicos').textContent = motoristasUnicos.toLocaleString('pt-BR');
            document.getElementById('statFalhasUltimos7Dias').textContent = falhasUltimos7Dias.toLocaleString('pt-BR');
            document.getElementById('statTaxaErroFalhas').textContent = taxaErro + '%';

            // Atualizar badge e progress bar
            const badgeMotivos = document.getElementById('badgeMotivosFalhas');
            const progressFalhas = document.getElementById('progressFalhas');
            if (badgeMotivos && maiorMotivo) {
                const motivoNome = {
                    'numero_invalido': 'Número Inválido',
                    'sem_ddi': 'Sem DDI',
                    'numero_longo': 'Número Longo',
                    'outro': 'Outros'
                }[maiorMotivo[0]] || 'Outros';
                badgeMotivos.textContent = `${motivoNome}: ${percentualMaiorMotivo}%`;
            }
            if (progressFalhas) {
                progressFalhas.style.width = percentualMaiorMotivo + '%';
            }

            // Atualizar última atualização
            const ultimaAtualizacao = document.getElementById('ultimaAtualizacaoFalhas');
            if (ultimaAtualizacao) {
                ultimaAtualizacao.textContent = new Date().toLocaleString('pt-BR', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

        } catch (error) {
            console.error('Erro ao carregar estatísticas de falhas:', error);
            document.getElementById('statTotalFalhas').textContent = 'Erro';
            document.getElementById('statMotoristasUnicos').textContent = 'Erro';
            document.getElementById('statFalhasUltimos7Dias').textContent = 'Erro';
            document.getElementById('statTaxaErroFalhas').textContent = 'Erro';
        }
    }
    
    function toggleTheme(){
        const body = document.body;
        const themeIcon = document.querySelector('#themeToggle i');
        if(body.classList.contains('light-mode')){
            body.classList.remove('light-mode');
            if(themeIcon) themeIcon.className = 'fas fa-moon';
            localStorage.setItem('theme','dark');
                } else {
            body.classList.add('light-mode');
            if(themeIcon) themeIcon.className = 'fas fa-sun';
            localStorage.setItem('theme','light');
        }
        // Recarregar gráficos para atualizar cores
        const abaAtiva = document.getElementById('abaBI')?.style.display !== 'none' ? 'bi' : 
                         document.getElementById('abaCadastros')?.style.display !== 'none' ? 'cadastros' :
                         document.getElementById('abaBIGestao')?.style.display !== 'none' ? 'bi-gestao' : 'coletas';
        if(abaAtiva === 'bi' && typeof carregarDisparos === 'function') {
            carregarDisparos();
        } else if(abaAtiva === 'cadastros' && typeof carregarMotoristas === 'function') {
            carregarMotoristas();
        } else if(abaAtiva === 'bi-gestao' && typeof carregarBIGestao === 'function') {
            carregarBIGestao();
        }
    }
    document.addEventListener('DOMContentLoaded', ()=>{
        const savedTheme = localStorage.getItem('theme') || 'dark';
        if(savedTheme==='light'){
            document.body.classList.add('light-mode');
            const themeIcon = document.querySelector('#themeToggle i');
            if(themeIcon) themeIcon.className = 'fas fa-sun';
        }
			(async ()=>{
				try{
					if(typeof verificarEAplicarPermissao==='function'){
						const ok = await verificarEAplicarPermissao('relatorios');
						if(!ok) return; // será redirecionado pelo permissions.js
					}
					mostrarAba('coletas');
				}catch(e){
					console.error('Erro ao verificar permissão para relatórios:', e);
					// fallback: ainda mostra aba coletas (não exige chamadas protegidas imediatamente)
        mostrarAba('coletas');
				}
			})();
		});

	// ====== SUPABASE (reutiliza endpoint backend para config) ======
	let _sbClient = null;
	async function getSupabaseClientRel(){
		if(_sbClient) return _sbClient;
		const resp = await fetch('/api/supabase-config');
		if(!resp.ok) return null;
		const cfg = await resp.json();
		if(typeof window.supabase==='undefined') return null;
		_sbClient = window.supabase.createClient(cfg.supabaseUrl, cfg.supabaseAnonKey);
		return _sbClient;
	}

	function handleUnauthorized(resp){
		if(resp && resp.status===401){
			alert('Sessão expirada ou não autenticada. Faça login para acessar os relatórios.');
			return true;
		}
		return false;
	}

	// ====== MOTORISTAS - FILTROS E CARGA ======
	let chartUsuarioMot = null, chartDepartamentoMot = null, chartTemporalMot = null;

	function periodoToRange(periodo){
		const now = new Date();
		let inicio = null;
		if(periodo==='hoje'){
			inicio = new Date(now.getFullYear(), now.getMonth(), now.getDate());
		}else if(periodo==='mes'){
			inicio = new Date(now.getFullYear(), now.getMonth(), 1);
		}else if(periodo==='ano'){
			inicio = new Date(now.getFullYear(), 0, 1);
		}
		return { inicio, fim: now };
	}

	function atualizarVisibilidadeDatasMot(){
		const periodo = document.getElementById('filtroPeriodoMot')?.value;
		const containerInicio = document.getElementById('containerDataInicioMot');
		const containerFim = document.getElementById('containerDataFimMot');
		if(periodo === 'personalizado'){
			if(containerInicio) containerInicio.style.display = '';
			if(containerFim) containerFim.style.display = '';
		} else {
			if(containerInicio) containerInicio.style.display = 'none';
			if(containerFim) containerFim.style.display = 'none';
		}
	}

	async function carregarFiltrosMotoristas(){
		const resp = await fetch('/api/relatorios/motoristas/filtros', { credentials: 'include' });
		if(handleUnauthorized(resp)) return;
		if(!resp.ok) return;
		const json = await resp.json();
		const usuarios = json.usuarios || [];
		const departamentos = json.departamentos || [];
		const selUsuario = document.getElementById('filtroUsuarioMot');
		const selDept = document.getElementById('filtroDepartamentoMot');
		if(selUsuario){
			selUsuario.innerHTML = '<option value="">Todos os usuários</option>' +
			usuarios.map(u=>`<option value="${u.id}">${u.nome||u.id}</option>`).join('');
		}
		if(selDept){
			selDept.innerHTML = '<option value="">Todos os departamentos</option>' +
			departamentos.map(d=>`<option value="${d}">${d}</option>`).join('');
		}
	}

	// Função para obter cores dos gráficos baseado no tema
	function getChartColors(){
		const isLight = document.body.classList.contains('light-mode');
		return {
			textColor: isLight ? 'rgba(15,23,42,0.8)' : 'rgba(255,255,255,0.7)',
			gridColor: isLight ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)',
			dataLabelColor: isLight ? '#0f172a' : '#fff',
			legendColor: isLight ? 'rgba(15,23,42,0.9)' : 'rgba(255,255,255,0.9)'
		};
	}

	function ensureChart(ctxId, type, data, options){
		const ctx = document.getElementById(ctxId);
		if(!ctx) return null;
		if(ctx._chart){ ctx._chart.destroy(); }
		ctx._chart = new Chart(ctx, { type, data, options });
		return ctx._chart;
	}

	async function carregarMotoristas(){
		const overlay = document.getElementById('loadingOverlay');
		if(overlay) overlay.style.display = 'flex';
		try{
			const periodo = document.getElementById('filtroPeriodoMot')?.value || 'mes';
			const usuarioId = document.getElementById('filtroUsuarioMot')?.value || '';
			const departamento = document.getElementById('filtroDepartamentoMot')?.value || '';
			let range;
			if(periodo === 'personalizado'){
				const dataInicio = document.getElementById('filtroDataInicioMot')?.value;
				const dataFim = document.getElementById('filtroDataFimMot')?.value;
				range = {
					inicio: dataInicio ? new Date(dataInicio + 'T00:00:00') : null,
					fim: dataFim ? new Date(dataFim + 'T23:59:59') : null
				};
			} else {
				range = periodoToRange(periodo);
			}
			const params = new URLSearchParams({
				inicio: range.inicio ? range.inicio.toISOString() : '',
				fim: range.fim ? range.fim.toISOString() : '',
				usuarioId,
				departamento
			});
			const [kpiResp, seriesResp] = await Promise.all([
				fetch(`/api/relatorios/motoristas/kpis?${params}`, { credentials:'include' }),
				fetch(`/api/relatorios/motoristas/series?${params}`, { credentials:'include' })
			]);
			if(handleUnauthorized(kpiResp) || handleUnauthorized(seriesResp)) return;
			if(kpiResp.ok){
				const k = await kpiResp.json();
				document.getElementById('kpiTotalMot').innerText = (k.total||0).toString();
				document.getElementById('kpiUsuariosMot').innerText = (k.usuarios||0).toString();
				document.getElementById('kpiDepartamentosMot').innerText = (k.departamentos||0).toString();
			}
			if(seriesResp.ok){
				const s = await seriesResp.json();
				const ctxUserMot = document.getElementById('chartUsuarioMot');
				const ctxDeptMot = document.getElementById('chartDepartamentoMot');
				const ctxDayMot = document.getElementById('chartTemporalMot');
				
				if(ctxUserMot){
					if(ctxUserMot._chart) ctxUserMot._chart.destroy();
					const colors = getChartColors();
					ctxUserMot._chart = new Chart(ctxUserMot, {
						type:'bar',
						data:{ 
							labels: (s.byUser||[]).map(u=>u.nome),
							datasets:[{ label:'Motoristas', data: (s.byUser||[]).map(u=>u.count), backgroundColor:'#667eea' }]
						},
						options:{ 
							responsive:true, 
							maintainAspectRatio:false,
							plugins:{ legend:{ display:false }},
							scales: {
								y: {
									beginAtZero: true,
									ticks: { color: colors.textColor },
									grid: { color: colors.gridColor }
								},
								x: {
									ticks: { color: colors.textColor },
									grid: { color: colors.gridColor }
								}
							}
						},
						plugins: [{
							id: 'datalabels',
							afterDatasetsDraw: (chart) => {
								const ctx = chart.ctx;
								chart.data.datasets.forEach((dataset, i) => {
									const meta = chart.getDatasetMeta(i);
									meta.data.forEach((element, index) => {
										const value = dataset.data[index];
										if (value !== null && value !== undefined && value !== 0) {
											ctx.save();
											ctx.fillStyle = colors.dataLabelColor;
											ctx.font = 'bold 12px Arial';
											ctx.textAlign = 'center';
											ctx.textBaseline = 'bottom';
											const position = element.tooltipPosition();
											const valueStr = String(value);
											ctx.fillText(valueStr, position.x, position.y - 5);
											ctx.restore();
										}
									});
								});
							}
						}]
					});
				}
				
				if(ctxDeptMot){
					if(ctxDeptMot._chart) ctxDeptMot._chart.destroy();
					const colors = getChartColors();
					ctxDeptMot._chart = new Chart(ctxDeptMot, {
						type:'bar',
						data:{ 
							labels: (s.byDepartment||[]).map(d=>d.departamento),
							datasets:[{ label:'Motoristas', data: (s.byDepartment||[]).map(d=>d.count), backgroundColor:'#22c55e' }]
						},
						options:{ 
							responsive:true, 
							maintainAspectRatio:false,
							plugins:{ legend:{ display:false }},
							scales: {
								y: {
									beginAtZero: true,
									ticks: { color: colors.textColor },
									grid: { color: colors.gridColor }
								},
								x: {
									ticks: { color: colors.textColor },
									grid: { color: colors.gridColor }
								}
							}
						},
						plugins: [{
							id: 'datalabels',
							afterDatasetsDraw: (chart) => {
								const ctx = chart.ctx;
								chart.data.datasets.forEach((dataset, i) => {
									const meta = chart.getDatasetMeta(i);
									meta.data.forEach((element, index) => {
										const value = dataset.data[index];
										if (value !== null && value !== undefined && value !== 0) {
											ctx.save();
											ctx.fillStyle = colors.dataLabelColor;
											ctx.font = 'bold 12px Arial';
											ctx.textAlign = 'center';
											ctx.textBaseline = 'bottom';
											const position = element.tooltipPosition();
											const valueStr = String(value);
											ctx.fillText(valueStr, position.x, position.y - 5);
											ctx.restore();
										}
									});
								});
							}
						}]
					});
				}
				
				if(ctxDayMot){
					if(ctxDayMot._chart) ctxDayMot._chart.destroy();
					const colors = getChartColors();
					ctxDayMot._chart = new Chart(ctxDayMot, {
						type:'line',
						data:{ 
							labels: (s.byDay||[]).map(d=>d.date),
							datasets:[{ label:'Cadastros', data: (s.byDay||[]).map(d=>d.count), borderColor:'#f59e0b', backgroundColor:'rgba(245,158,11,0.25)', fill:true, tension:0.3, pointRadius: 5, pointHoverRadius: 7 }]
						},
						options:{ 
							responsive:true,
							maintainAspectRatio:false,
							plugins: {
								legend: { display: true, labels: { color: colors.legendColor } }
							},
							scales: {
								y: {
									beginAtZero: true,
									ticks: { color: colors.textColor },
									grid: { color: colors.gridColor }
								},
								x: {
									ticks: { color: colors.textColor },
									grid: { color: colors.gridColor }
								}
							}
						},
						plugins: [{
							id: 'datalabels',
							afterDatasetsDraw: (chart) => {
								const ctx = chart.ctx;
								chart.data.datasets.forEach((dataset, i) => {
									const meta = chart.getDatasetMeta(i);
									meta.data.forEach((element, index) => {
										const value = dataset.data[index];
										if (value !== null && value !== undefined && value !== 0) {
											ctx.save();
											ctx.fillStyle = colors.dataLabelColor;
											ctx.font = 'bold 11px Arial';
											ctx.textAlign = 'center';
											ctx.textBaseline = 'bottom';
											const position = element.tooltipPosition();
											const valueStr = String(value);
											ctx.fillText(valueStr, position.x, position.y - 8);
											ctx.restore();
										}
									});
								});
							}
						}]
					});
				}
			}
		} finally {
			if(overlay) overlay.style.display = 'none';
		}
	}

    // ====== DISPAROS - FILTROS E CARGA ======
    function atualizarVisibilidadeDatasDisp(){
        const periodo = document.getElementById('filtroPeriodoDisp')?.value;
        const containerInicio = document.getElementById('containerDataInicioDisp');
        const containerFim = document.getElementById('containerDataFimDisp');
        if(periodo === 'personalizado'){
            if(containerInicio) containerInicio.style.display = '';
            if(containerFim) containerFim.style.display = '';
        } else {
            if(containerInicio) containerInicio.style.display = 'none';
            if(containerFim) containerFim.style.display = 'none';
        }
    }

    async function carregarFiltrosDisparos(){
        const resp = await fetch('/api/relatorios/disparos/filtros', { credentials:'include' });
        if(handleUnauthorized(resp)) return;
        if(!resp.ok) return;
        const json = await resp.json();
        const usuarios = json.usuarios || [];
        const departamentos = json.departamentos || [];
        const selUsuario = document.getElementById('filtroUsuarioDisp');
        const selDept = document.getElementById('filtroDepartamentoDisp');
        if(selUsuario){
            selUsuario.innerHTML = '<option value="">Todos os usuários</option>' +
                usuarios.map(u=>`<option value="${u.id}">${u.nome||u.id}</option>`).join('');
        }
        if(selDept){
            selDept.innerHTML = '<option value="">Todos os departamentos</option>' +
                departamentos.map(d=>`<option value="${d}">${d}</option>`).join('');
        }
    }

    async function carregarDisparos(){
        const overlay = document.getElementById('loadingOverlay');
        if(overlay) overlay.style.display = 'flex';
        try {
            const periodo = document.getElementById('filtroPeriodoDisp')?.value || 'mes';
            const usuarioId = document.getElementById('filtroUsuarioDisp')?.value || '';
            const departamento = document.getElementById('filtroDepartamentoDisp')?.value || '';
            let range;
            if(periodo === 'personalizado'){
                const dataInicio = document.getElementById('filtroDataInicioDisp')?.value;
                const dataFim = document.getElementById('filtroDataFimDisp')?.value;
                range = {
                    inicio: dataInicio ? new Date(dataInicio + 'T00:00:00') : null,
                    fim: dataFim ? new Date(dataFim + 'T23:59:59') : null
                };
            } else {
                range = periodoToRange(periodo);
            }
            const params = new URLSearchParams({
                inicio: range.inicio ? range.inicio.toISOString() : '',
                fim: range.fim ? range.fim.toISOString() : '',
                usuarioId,
                departamento
            });
            const [kpiResp, seriesResp] = await Promise.all([
                fetch(`/api/relatorios/disparos/kpis?${params}`, { credentials:'include' }),
                fetch(`/api/relatorios/disparos/series?${params}`, { credentials:'include' })
            ]);
            if(handleUnauthorized(kpiResp) || handleUnauthorized(seriesResp)) return;
            if(kpiResp.ok){
                const k = await kpiResp.json();
                document.getElementById('kpiTotalDisp').innerText = (k.total||0).toString();
                document.getElementById('kpiUsuariosDisp').innerText = (k.usuarios||0).toString();
                document.getElementById('kpiDepartamentosDisp').innerText = (k.departamentos||0).toString();
                if((k.total||0)===0){ console.warn('BI Disparos: nenhum registro no período/filtros atuais'); }
            } else {
                console.error('Erro KPIs disparos:', await kpiResp.text());
            }
            if(seriesResp.ok){
                const s = await seriesResp.json();
                const ctxUser = document.getElementById('chartUsuarioDisp');
                const ctxDept = document.getElementById('chartDepartamentoDisp');
                const ctxDay = document.getElementById('chartTemporalDisp');
                if(ctxUser){
                    if(ctxUser._chart) ctxUser._chart.destroy();
                    const colors = getChartColors();
                    ctxUser._chart = new Chart(ctxUser, {
                        type:'bar',
                        data:{ labels:(s.byUser||[]).map(u=>u.nome), datasets:[{ label:'Disparos', data:(s.byUser||[]).map(u=>u.count), backgroundColor:'#4f46e5' }] },
                        options:{ 
                            responsive:true, 
                            maintainAspectRatio:false,
                            plugins:{ 
                                legend:{ display:false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: colors.textColor },
                                    grid: { color: colors.gridColor }
                                },
                                x: {
                                    ticks: { color: colors.textColor },
                                    grid: { color: colors.gridColor }
                                }
                            }
                        },
                        plugins: [{
                            id: 'datalabels',
                            afterDatasetsDraw: (chart) => {
                                const ctx = chart.ctx;
                                chart.data.datasets.forEach((dataset, i) => {
                                    const meta = chart.getDatasetMeta(i);
                                    meta.data.forEach((element, index) => {
                                        const value = dataset.data[index];
                                        if (value !== null && value !== undefined && value !== 0) {
                                            ctx.save();
                                            ctx.fillStyle = colors.dataLabelColor;
                                            ctx.font = 'bold 12px Arial';
                                            ctx.textAlign = 'center';
                                            ctx.textBaseline = 'bottom';
                                            const position = element.tooltipPosition();
                                            const valueStr = String(value);
                                            ctx.fillText(valueStr, position.x, position.y - 5);
                                            ctx.restore();
                                        }
                                    });
                                });
                            }
                        }]
                    });
                }
                if(ctxDept){
                    if(ctxDept._chart) ctxDept._chart.destroy();
                    const colors = getChartColors();
                    ctxDept._chart = new Chart(ctxDept, {
                        type:'bar',
                        data:{ labels:(s.byDepartment||[]).map(d=>d.departamento), datasets:[{ label:'Disparos', data:(s.byDepartment||[]).map(d=>d.count), backgroundColor:'#10b981' }] },
                        options:{ 
                            responsive:true, 
                            maintainAspectRatio:false,
                            plugins:{ 
                                legend:{ display:false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: colors.textColor },
                                    grid: { color: colors.gridColor }
                                },
                                x: {
                                    ticks: { color: colors.textColor },
                                    grid: { color: colors.gridColor }
                                }
                            }
                        },
                        plugins: [{
                            id: 'datalabels',
                            afterDatasetsDraw: (chart) => {
                                const ctx = chart.ctx;
                                chart.data.datasets.forEach((dataset, i) => {
                                    const meta = chart.getDatasetMeta(i);
                                    meta.data.forEach((element, index) => {
                                        const value = dataset.data[index];
                                        if (value !== null && value !== undefined && value !== 0) {
                                            ctx.save();
                                            ctx.fillStyle = colors.dataLabelColor;
                                            ctx.font = 'bold 12px Arial';
                                            ctx.textAlign = 'center';
                                            ctx.textBaseline = 'bottom';
                                            const position = element.tooltipPosition();
                                            const valueStr = String(value);
                                            ctx.fillText(valueStr, position.x, position.y - 5);
                                            ctx.restore();
                                        }
                                    });
                                });
                            }
                        }]
                    });
                }
                if(ctxDay){
                    if(ctxDay._chart) ctxDay._chart.destroy();
                    const colors = getChartColors();
                    ctxDay._chart = new Chart(ctxDay, {
                        type:'line',
                        data:{ labels:(s.byDay||[]).map(d=>d.date), datasets:[{ label:'Disparos', data:(s.byDay||[]).map(d=>d.count), borderColor:'#f59e0b', backgroundColor:'rgba(245,158,11,0.25)', fill:true, tension:0.3, pointRadius: 5, pointHoverRadius: 7 }] },
                        options:{ 
                            responsive:true,
                            maintainAspectRatio:false,
                            plugins: {
                                legend: { display: true, labels: { color: colors.legendColor } }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: colors.textColor },
                                    grid: { color: colors.gridColor }
                                },
                                x: {
                                    ticks: { color: colors.textColor },
                                    grid: { color: colors.gridColor }
                                }
                            }
                        },
                        plugins: [{
                            id: 'datalabels',
                            afterDatasetsDraw: (chart) => {
                                const ctx = chart.ctx;
                                chart.data.datasets.forEach((dataset, i) => {
                                    const meta = chart.getDatasetMeta(i);
                                    meta.data.forEach((element, index) => {
                                        const value = dataset.data[index];
                                        if (value !== null && value !== undefined && value !== 0) {
                                            ctx.save();
                                            ctx.fillStyle = colors.dataLabelColor;
                                            ctx.font = 'bold 11px Arial';
                                            ctx.textAlign = 'center';
                                            ctx.textBaseline = 'bottom';
                                            const position = element.tooltipPosition();
                                            const valueStr = String(value);
                                            ctx.fillText(valueStr, position.x, position.y - 8);
                                            ctx.restore();
                                        }
                                    });
                                });
                            }
                        }]
                    });
                }
            } else {
                console.error('Erro séries disparos:', await seriesResp.text());
            }
            // Carregar estatísticas de falhas com os mesmos filtros
            await carregarEstatisticasFalhas().catch(err => console.error('Erro ao carregar estatísticas de falhas:', err));
        } catch (error) {
            console.error('Erro ao carregar disparos:', error);
        } finally {
            if(overlay) overlay.style.display = 'none';
        }
    }
    
    // ========== BI GESTÃO DE DADOS ==========
    let chartTipoErroGestao = null, chartOperacaoGestao = null, chartResponsavelGestao = null;
    let chartTemporalGestao = null, chartUsuarioGestao = null;
    
    function atualizarVisibilidadeDatasGestao() {
        const periodo = document.getElementById('filtroPeriodoGestao').value;
        const containerInicio = document.getElementById('containerDataInicioGestao');
        const containerFim = document.getElementById('containerDataFimGestao');
        
        if (containerInicio && containerFim) {
            if (periodo === 'personalizado') {
                containerInicio.style.display = 'block';
                containerFim.style.display = 'block';
            } else {
                containerInicio.style.display = 'none';
                containerFim.style.display = 'none';
            }
        }
    }
    
    function calcularPeriodoGestao() {
        const periodoSelect = document.getElementById('filtroPeriodoGestao');
        const periodo = periodoSelect ? periodoSelect.value : 'todos';
        const hoje = new Date();
        hoje.setHours(23, 59, 59, 999);
        let inicio = null;
        let fim = new Date(hoje);
        
        switch(periodo) {
            case 'hoje':
                inicio = new Date(hoje);
                inicio.setHours(0, 0, 0, 0);
                break;
            case 'semana':
                inicio = new Date(hoje);
                inicio.setDate(inicio.getDate() - 7);
                break;
            case 'mes':
                inicio = new Date(hoje);
                inicio.setDate(inicio.getDate() - 30);
                break;
            case 'trimestre':
                inicio = new Date(hoje);
                inicio.setDate(inicio.getDate() - 90);
                break;
            case 'ano':
                inicio = new Date(hoje);
                inicio.setFullYear(inicio.getFullYear() - 1);
                break;
            case 'personalizado':
                const dataInicio = document.getElementById('filtroDataInicioGestao')?.value;
                const dataFim = document.getElementById('filtroDataFimGestao')?.value;
                if (dataInicio) inicio = new Date(dataInicio);
                if (dataFim) {
                    fim = new Date(dataFim);
                    fim.setHours(23, 59, 59, 999);
                }
                break;
            case 'todos':
            default:
                inicio = null;
                fim = null;
        }
        
        return {
            inicio: inicio ? inicio.toISOString().split('T')[0] : '',
            fim: fim ? fim.toISOString().split('T')[0] : ''
        };
    }
    
    async function carregarBIGestao() {
        const overlay = document.getElementById('loadingOverlay');
        if(overlay) overlay.style.display = 'flex';
        
        try {
            const periodo = calcularPeriodoGestao();
            const operacaoSelect = document.getElementById('filtroOperacaoGestao');
            const operacao = operacaoSelect ? operacaoSelect.value : '';
            
            const params = new URLSearchParams({
                inicio: periodo.inicio || '',
                fim: periodo.fim || ''
            });
            
            if (operacao && operacao.trim() !== '') {
                params.append('operacao', operacao.trim());
            }
            
            console.log('🔍 Carregando BI Gestão - Parâmetros:', { inicio: periodo.inicio, fim: periodo.fim });
            
            // Carregar KPIs
            const kpisResp = await fetch(`/api/relatorios/gestao-dados/kpis?${params}`, { credentials: 'include' });
            
            if (!kpisResp.ok) {
                console.error('❌ Erro ao buscar KPIs:', kpisResp.status, await kpisResp.text());
                throw new Error(`Erro ao buscar KPIs: ${kpisResp.status}`);
            }
            
            let kpisData = null;
            kpisData = await kpisResp.json();
            console.log('📊 KPIs recebidos:', kpisData);
            
            // Atualizar cards de métricas
            document.getElementById('totalLancamentosGestao').textContent = (kpisData.total || 0).toLocaleString('pt-BR');
            document.getElementById('totalEditadosGestao').textContent = (kpisData.totalEditados || 0).toLocaleString('pt-BR');
            document.getElementById('taxaEdicaoGestao').textContent = (kpisData.taxaEdicao || 0) + '%';
            
            const tempoMedio = kpisData.tempoMedioResposta || 0;
            const horas = Math.floor(tempoMedio / 60);
            const minutos = tempoMedio % 60;
            let tempoFormatado = '';
            if (horas > 0) {
                tempoFormatado = `${horas}h ${minutos}min`;
            } else {
                tempoFormatado = `${minutos}min`;
            }
            document.getElementById('tempoMedioRespostaGestao').textContent = tempoFormatado;
            
            // Carregar séries
            const seriesResp = await fetch(`/api/relatorios/gestao-dados/series?${params}`, { credentials: 'include' });
            
            if (!seriesResp.ok) {
                console.error('❌ Erro ao buscar séries:', seriesResp.status, await seriesResp.text());
                throw new Error(`Erro ao buscar séries: ${seriesResp.status}`);
            }
            
            const s = await seriesResp.json();
            console.log('📈 Séries recebidas:', s);
            const colors = getChartColors();
            
            // Gráfico de Tipo de Erro (Doughnut Melhorado)
            const ctxTipoErro = document.getElementById('chartTipoErroGestao');
            if (ctxTipoErro) {
                if (ctxTipoErro._chart) ctxTipoErro._chart.destroy();
                
                const tiposErroData = (s.byTipoErro || []).filter(d => d && d.tipo && d.count > 0).slice(0, 10);
                const totalTipos = tiposErroData.reduce((sum, d) => sum + (d.count || 0), 0);
                
                if (tiposErroData.length > 0) {
                    ctxTipoErro._chart = new Chart(ctxTipoErro, {
                        type: 'doughnut',
                        data: {
                            labels: tiposErroData.map(d => d.tipo.length > 20 ? d.tipo.substring(0, 20) + '...' : d.tipo),
                            datasets: [{
                                data: tiposErroData.map(d => d.count),
                                backgroundColor: [
                                    '#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe',
                                    '#43e97b', '#fa709a', '#fee140', '#30cfd0', '#a8edea'
                                ],
                                borderWidth: 2,
                                borderColor: colors.gridColor
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '60%',
                            layout: {
                                padding: 10
                            },
                            plugins: {
                                legend: { 
                                    display: true, 
                                    position: 'right',
                                    labels: { 
                                        color: colors.legendColor, 
                                        font: { size: 11, weight: '500' },
                                        padding: 12,
                                        usePointStyle: true,
                                        pointStyle: 'circle'
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.85)',
                                    padding: 12,
                                    titleFont: { size: 13, weight: 'bold' },
                                    bodyFont: { size: 12 },
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed;
                                            const percentage = totalTipos > 0 ? ((value / totalTipos) * 100).toFixed(1) : 0;
                                            return `${value} lançamentos (${percentage}%)`;
                                        }
                                    },
                                    cornerRadius: 8
                                }
                            }
                        },
                        plugins: [{
                            id: 'datalabels',
                            afterDatasetsDraw: (chart) => {
                                const ctx = chart.ctx;
                                chart.data.datasets.forEach((dataset, i) => {
                                    const meta = chart.getDatasetMeta(i);
                                    meta.data.forEach((element, index) => {
                                        const value = dataset.data[index];
                                        if (value !== null && value !== undefined && value !== 0) {
                                            ctx.save();
                                            ctx.fillStyle = colors.dataLabelColor;
                                            ctx.font = 'bold 12px Arial';
                                            ctx.textAlign = 'center';
                                            ctx.textBaseline = 'middle';
                                            const position = element.tooltipPosition();
                                            ctx.fillText(String(value), position.x, position.y);
                                            ctx.restore();
                                        }
                                    });
                                });
                            }
                        }]
                    });
                }
            }
            
            // Gráfico de Operação (Barra Vertical Melhorado)
            const ctxOperacao = document.getElementById('chartOperacaoGestao');
            if (ctxOperacao) {
                if (ctxOperacao._chart) ctxOperacao._chart.destroy();
                
                const operacoesData = (s.byOperacao || []).filter(d => d && d.operacao && d.count > 0).slice(0, 12);
                const totalOperacoes = operacoesData.reduce((sum, d) => sum + (d.count || 0), 0);
                
                if (operacoesData.length > 0) {
                
                // Criar gradiente de cores harmonioso
                const gradientColors = [
                    '#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe',
                    '#43e97b', '#fa709a', '#fee140', '#30cfd0', '#a8edea',
                    '#ff6b6b', '#48dbfb'
                ];
                
                ctxOperacao._chart = new Chart(ctxOperacao, {
                    type: 'bar',
                    data: {
                        labels: operacoesData.map(d => d.operacao.length > 15 ? d.operacao.substring(0, 15) + '...' : d.operacao),
                        datasets: [{
                            label: 'Lançamentos',
                            data: operacoesData.map(d => d.count),
                            backgroundColor: (context) => {
                                const index = context.dataIndex;
                                return gradientColors[index % gradientColors.length];
                            },
                            borderColor: (context) => {
                                const index = context.dataIndex;
                                return gradientColors[index % gradientColors.length];
                            },
                            borderWidth: 2,
                            borderRadius: {
                                topLeft: 6,
                                topRight: 6,
                                bottomLeft: 0,
                                bottomRight: 0
                            },
                            barThickness: 'flex',
                            maxBarThickness: 50,
                            categoryPercentage: 0.7,
                            barPercentage: 0.8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                left: 5,
                                right: 15,
                                top: 15,
                                bottom: 5
                            }
                        },
                        plugins: {
                            legend: { 
                                display: false 
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.85)',
                                padding: 12,
                                titleFont: {
                                    size: 13,
                                    weight: 'bold'
                                },
                                bodyFont: {
                                    size: 12
                                },
                                displayColors: true,
                                callbacks: {
                                    title: function(context) {
                                        const index = context[0].dataIndex;
                                        return operacoesData[index].operacao;
                                    },
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        const percentage = totalOperacoes > 0 ? ((value / totalOperacoes) * 100).toFixed(1) : 0;
                                        return `${value} lançamentos (${percentage}% do total)`;
                                    }
                                },
                                cornerRadius: 8,
                                borderColor: 'rgba(255, 255, 255, 0.1)',
                                borderWidth: 1
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { 
                                    color: colors.textColor,
                                    font: {
                                        size: 11,
                                        weight: '500'
                                    },
                                    stepSize: 1,
                                    padding: 8,
                                    callback: function(value) {
                                        return Number.isInteger(value) ? value : '';
                                    }
                                },
                                grid: { 
                                    color: colors.gridColor,
                                    drawBorder: false,
                                    lineWidth: 1
                                }
                            },
                            x: {
                                ticks: { 
                                    color: colors.textColor,
                                    font: {
                                        size: 10,
                                        weight: '500'
                                    },
                                    maxRotation: 45,
                                    minRotation: 45,
                                    padding: 8
                                },
                                grid: { 
                                    display: false,
                                    drawBorder: false
                                }
                            }
                        },
                        animation: {
                            duration: 1200,
                            easing: 'easeOutQuart'
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    },
                    plugins: [{
                        id: 'datalabels',
                        afterDatasetsDraw: (chart) => {
                            const ctx = chart.ctx;
                            const chartArea = chart.chartArea;
                            
                            chart.data.datasets.forEach((dataset, i) => {
                                const meta = chart.getDatasetMeta(i);
                                meta.data.forEach((element, index) => {
                                    const value = dataset.data[index];
                                    if (value !== null && value !== undefined && value !== 0) {
                                        ctx.save();
                                        
                                        // Calcular posição do topo da barra
                                            const barTop = element.y;
                                        const barBottom = barTop + element.height;
                                        
                                        // Posicionar label sempre no topo da barra
                                        let labelY = barTop - 8; // 8px acima do topo da barra
                                        
                                        // Se o label estiver muito próximo do topo do chartArea, colocar dentro da barra
                                        if (labelY < chartArea.top + 20) {
                                            // Colocar dentro da barra, próximo ao topo
                                            labelY = barTop + 18;
                                        }
                                        
                                        // Garantir que o label esteja sempre visível
                                        const minY = chartArea.top + 5;
                                        const maxY = chartArea.bottom - 5;
                                        labelY = Math.max(minY, Math.min(maxY, labelY));
                                        
                                        const text = String(value);
                                        ctx.font = 'bold 13px Arial';
                                        ctx.textAlign = 'center';
                                        ctx.textBaseline = 'middle';
                                        
                                        const textMetrics = ctx.measureText(text);
                                        const textWidth = textMetrics.width;
                                        const textHeight = 16;
                                        const padding = 6;
                                        
                                        // Calcular posição X centralizada na barra
                                        const labelX = element.x;
                                        
                                        // Desenhar fundo do label
                                        const bgX = labelX - textWidth / 2 - padding;
                                        const bgY = labelY - textHeight / 2;
                                        
                                        // Fundo escuro semi-transparente
                                        ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                                        ctx.fillRect(bgX, bgY, textWidth + padding * 2, textHeight);
                                        
                                        // Borda branca sutil
                                        ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
                                        ctx.lineWidth = 1;
                                        ctx.strokeRect(bgX, bgY, textWidth + padding * 2, textHeight);
                                        
                                        // Desenhar texto branco
                                        ctx.fillStyle = '#ffffff';
                                        ctx.fillText(text, labelX, labelY);
                                        
                                        ctx.restore();
                                    }
                                });
                            });
                        }
                    }]
                });
                }
            }
            
            // Gráfico de Responsáveis (Barra Horizontal Melhorado)
            const ctxResponsavel = document.getElementById('chartResponsavelGestao');
            if (ctxResponsavel && kpisData) {
                if (ctxResponsavel._chart) ctxResponsavel._chart.destroy();
                
                const responsaveisData = (kpisData.topResponsaveis || []).filter(d => d && d.responsavel && d.count > 0).slice(0, 10);
                const totalResponsaveis = responsaveisData.reduce((sum, d) => sum + (d.count || 0), 0);
                
                if (responsaveisData.length > 0) {
                    ctxResponsavel._chart = new Chart(ctxResponsavel, {
                        type: 'bar',
                        data: {
                            labels: responsaveisData.map(d => d.responsavel),
                            datasets: [{
                                label: 'Lançamentos',
                                data: responsaveisData.map(d => d.count),
                                backgroundColor: '#f093fb',
                                borderColor: '#764ba2',
                                borderWidth: 2,
                                borderRadius: {
                                    topRight: 6,
                                    bottomRight: 6,
                                    topLeft: 0,
                                    bottomLeft: 0
                                }
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            layout: {
                                padding: {
                                    left: 5,
                                    right: 15,
                                    top: 10,
                                    bottom: 10
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.85)',
                                    padding: 12,
                                    titleFont: { size: 13, weight: 'bold' },
                                    bodyFont: { size: 12 },
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed.x;
                                            const percentage = totalResponsaveis > 0 ? ((value / totalResponsaveis) * 100).toFixed(1) : 0;
                                            return `${value} lançamentos (${percentage}%)`;
                                        }
                                    },
                                    cornerRadius: 8
                                }
                            },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    ticks: { 
                                        color: colors.textColor,
                                        font: { size: 11, weight: '500' },
                                        stepSize: 1,
                                        padding: 8,
                                        callback: function(value) {
                                            return Number.isInteger(value) ? value : '';
                                        }
                                    },
                                    grid: { 
                                        color: colors.gridColor,
                                        drawBorder: false,
                                        lineWidth: 1
                                    }
                                },
                                y: {
                                    ticks: { 
                                        color: colors.textColor,
                                        font: { size: 11, weight: '500' },
                                        padding: 8
                                    },
                                    grid: { 
                                        display: false,
                                        drawBorder: false
                                    }
                                }
                            },
                            animation: {
                                duration: 1000,
                                easing: 'easeOutQuart'
                            }
                        },
                        plugins: [{
                            id: 'datalabels',
                            afterDatasetsDraw: (chart) => {
                                const ctx = chart.ctx;
                                const chartArea = chart.chartArea;
                                
                                chart.data.datasets.forEach((dataset, i) => {
                                    const meta = chart.getDatasetMeta(i);
                                    meta.data.forEach((element, index) => {
                                        const value = dataset.data[index];
                                        if (value !== null && value !== undefined && value !== 0) {
                                            ctx.save();
                                            
                                            // Posição da barra horizontal
                                            const barX = element.x;
                                            const barY = element.y;
                                            const barWidth = element.width;
                                            
                                            // Calcular posição do label (dentro ou fora da barra)
                                            let labelX = barX + barWidth + 10; // Tentar fora da barra primeiro
                                            
                                            // Se a barra for muito larga e o label sair do canvas, colocar dentro
                                            if (labelX > chartArea.right - 30) {
                                                labelX = barX + barWidth - 8; // Colocar dentro da barra, próximo ao final
                                            }
                                            
                                            // Garantir que o label esteja sempre visível
                                            const minX = chartArea.left + 5;
                                            const maxX = chartArea.right - 5;
                                            labelX = Math.max(minX, Math.min(maxX, labelX));
                                            
                                            const text = String(value);
                                            ctx.font = 'bold 12px Arial';
                                            ctx.textAlign = labelX > barX + barWidth ? 'left' : 'right';
                                            ctx.textBaseline = 'middle';
                                            
                                            const textMetrics = ctx.measureText(text);
                                            const textWidth = textMetrics.width;
                                            const textHeight = 14;
                                            const padding = 5;
                                            
                                            // Calcular posição do fundo do label
                                            let bgX, bgY;
                                            if (labelX > barX + barWidth) {
                                                // Label fora da barra (à direita)
                                                bgX = labelX;
                                                bgY = barY - textHeight / 2;
                                            } else {
                                                // Label dentro da barra
                                                bgX = labelX - textWidth - padding;
                                                bgY = barY - textHeight / 2;
                                            }
                                            
                                            // Desenhar fundo do label
                                            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                                            ctx.fillRect(bgX - padding, bgY, textWidth + padding * 2, textHeight);
                                            
                                            // Borda branca sutil
                                            ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
                                            ctx.lineWidth = 1;
                                            ctx.strokeRect(bgX - padding, bgY, textWidth + padding * 2, textHeight);
                                            
                                            // Desenhar texto branco
                                            ctx.fillStyle = '#ffffff';
                                            ctx.fillText(text, labelX, barY);
                                            
                                            ctx.restore();
                                        }
                                    });
                                });
                            }
                        }]
                    });
                }
            }
            
            // Gráfico Temporal (Linha Melhorado)
            const ctxTemporal = document.getElementById('chartTemporalGestao');
            if (ctxTemporal) {
                if (ctxTemporal._chart) ctxTemporal._chart.destroy();
                
                const temporalData = (s.byDay || []).filter(d => d && d.date && d.count !== undefined).sort((a, b) => a.date.localeCompare(b.date));
                
                if (temporalData.length > 0) {
                    ctxTemporal._chart = new Chart(ctxTemporal, {
                        type: 'line',
                        data: {
                            labels: temporalData.map(d => {
                                try {
                                    const date = new Date(d.date);
                                    if (isNaN(date.getTime())) return d.date;
                                    return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                                } catch (e) {
                                    return d.date;
                                }
                            }),
                            datasets: [{
                                label: 'Lançamentos',
                                data: temporalData.map(d => d.count || 0),
                                borderColor: '#4facfe',
                                backgroundColor: 'rgba(79, 172, 254, 0.2)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                pointBackgroundColor: '#4facfe',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointHoverBackgroundColor: '#00f2fe',
                                pointHoverBorderColor: '#ffffff',
                                pointHoverBorderWidth: 3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            layout: {
                                padding: {
                                    left: 5,
                                    right: 10,
                                    top: 5,
                                    bottom: 5
                                }
                            },
                            plugins: {
                                legend: { 
                                    display: true, 
                                    labels: { 
                                        color: colors.legendColor,
                                        font: { size: 12, weight: '500' },
                                        usePointStyle: true
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.85)',
                                    padding: 12,
                                    titleFont: { size: 13, weight: 'bold' },
                                    bodyFont: { size: 12 },
                                    callbacks: {
                                        title: function(context) {
                                            const index = context[0].dataIndex;
                                            try {
                                                const date = new Date(temporalData[index].date);
                                                if (!isNaN(date.getTime())) {
                                                    return date.toLocaleDateString('pt-BR', { 
                                                        weekday: 'long',
                                                        day: '2-digit', 
                                                        month: 'long', 
                                                        year: 'numeric' 
                                                    });
                                                }
                                            } catch (e) {}
                                            return temporalData[index].date;
                                        },
                                        label: function(context) {
                                            return `${context.parsed.y} lançamentos`;
                                        }
                                    },
                                    cornerRadius: 8,
                                    displayColors: true
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { 
                                        color: colors.textColor,
                                        font: { size: 11, weight: '500' },
                                        stepSize: 1,
                                        padding: 8,
                                        callback: function(value) {
                                            return Number.isInteger(value) ? value : '';
                                        }
                                    },
                                    grid: { 
                                        color: colors.gridColor,
                                        drawBorder: false,
                                        lineWidth: 1
                                    }
                                },
                                x: {
                                    ticks: { 
                                        color: colors.textColor,
                                        font: { size: 10, weight: '500' },
                                        padding: 8,
                                        maxRotation: 45,
                                        minRotation: 45
                                    },
                                    grid: { 
                                        color: colors.gridColor,
                                        drawBorder: false,
                                        lineWidth: 1
                                    }
                                }
                            },
                            animation: {
                                duration: 1200,
                                easing: 'easeOutQuart'
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            }
                        },
                        plugins: [{
                            id: 'datalabels',
                            afterDatasetsDraw: (chart) => {
                                const ctx = chart.ctx;
                                const chartArea = chart.chartArea;
                                
                                chart.data.datasets.forEach((dataset, i) => {
                                    const meta = chart.getDatasetMeta(i);
                                    meta.data.forEach((element, index) => {
                                        const value = dataset.data[index];
                                        if (value !== null && value !== undefined && value !== 0) {
                                            ctx.save();
                                            
                                            // Posição do ponto no gráfico
                                            const pointX = element.x;
                                            const pointY = element.y;
                                            
                                            // Calcular posição do label (acima ou abaixo conforme necessário)
                                            let labelY = pointY - 18; // Tentar acima primeiro
                                            
                                            // Se estiver muito próximo do topo, colocar abaixo
                                            if (labelY < chartArea.top + 25) {
                                                labelY = pointY + 18; // Colocar abaixo do ponto
                                            }
                                            
                                            // Garantir que o label esteja sempre visível
                                            const minY = chartArea.top + 10;
                                            const maxY = chartArea.bottom - 10;
                                            labelY = Math.max(minY, Math.min(maxY, labelY));
                                            
                                            // Verificar se o label está dentro dos limites horizontais
                                            const text = String(value);
                                            ctx.font = 'bold 12px Arial';
                                            ctx.textAlign = 'center';
                                            ctx.textBaseline = 'middle';
                                            
                                            const textMetrics = ctx.measureText(text);
                                            const textWidth = textMetrics.width;
                                            const textHeight = 14;
                                            const padding = 6;
                                            
                                            // Ajustar posição X se estiver muito próximo das bordas
                                            let labelX = pointX;
                                            const minX = chartArea.left + textWidth / 2 + padding;
                                            const maxX = chartArea.right - textWidth / 2 - padding;
                                            
                                            if (labelX < minX) {
                                                labelX = minX;
                                            } else if (labelX > maxX) {
                                                labelX = maxX;
                                            }
                                            
                                            // Desenhar fundo do label
                                            const bgX = labelX - textWidth / 2 - padding;
                                            const bgY = labelY - textHeight / 2;
                                            
                                            // Fundo escuro semi-transparente
                                            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                                            ctx.fillRect(bgX, bgY, textWidth + padding * 2, textHeight);
                                            
                                            // Borda branca sutil
                                            ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
                                            ctx.lineWidth = 1;
                                            ctx.strokeRect(bgX, bgY, textWidth + padding * 2, textHeight);
                                            
                                            // Desenhar texto branco
                                            ctx.fillStyle = '#ffffff';
                                            ctx.fillText(text, labelX, labelY);
                                            
                                            ctx.restore();
                                        }
                                    });
                                });
                            }
                        }]
                    });
                }
            }
            
            // Árvore de Perdas - Tipos de Erros Agrupados por Data
            const ctxUsuario = document.getElementById('chartUsuarioGestao');
            if (ctxUsuario && s) {
                if (ctxUsuario._chart) ctxUsuario._chart.destroy();
                
                // Usar dados já disponíveis de byDataETipoErro
                const dadosAgrupados = s.byDataETipoErro || [];
                
                if (dadosAgrupados.length > 0) {
                    // Agrupar por data e tipo de erro
                    const dadosPorData = new Map();
                    
                    dadosAgrupados.forEach(record => {
                        if (!record.data || !record.tipoErro) return;
                        
                        const data = record.data;
                        const tipoErro = record.tipoErro;
                        const count = record.count || 0;
                        
                        if (!dadosPorData.has(data)) {
                            dadosPorData.set(data, new Map());
                        }
                        
                        const tiposPorData = dadosPorData.get(data);
                        tiposPorData.set(tipoErro, (tiposPorData.get(tipoErro) || 0) + count);
                    });
                        
                        // Obter todas as datas e tipos de erros únicos
                        const datas = Array.from(dadosPorData.keys()).sort();
                        const todosTiposErro = Array.from(new Set(
                            Array.from(dadosPorData.values())
                                .flatMap(map => Array.from(map.keys()))
                        ));
                        
                        // Pegar os top 8 tipos de erros mais frequentes
                        const tiposFrequencia = new Map();
                        todosTiposErro.forEach(tipo => {
                            let total = 0;
                            dadosPorData.forEach((tiposMap) => {
                                total += tiposMap.get(tipo) || 0;
                            });
                            tiposFrequencia.set(tipo, total);
                        });
                        
                        const topTipos = Array.from(tiposFrequencia.entries())
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 8)
                            .map(([tipo]) => tipo);
                        
                        // Limitar a 15 datas mais recentes
                        const datasLimitadas = datas.slice(-15);
                        
                        // Cores distintas e contrastantes para cada tipo de erro
                        const coresTipos = {
                            'Erro operacional': '#e74c3c', // Vermelho vibrante
                            'Falta de Documentação / Anexo Ausente': '#3498db', // Azul
                            'Informações Incompletas ou Incorretas': '#f39c12', // Laranja
                            'Erro de Nomeclatura de Arquivos': '#9b59b6', // Roxo
                            'Erro de Tabela': '#e67e22', // Laranja escuro
                            'Divergência Financeira': '#1abc9c', // Turquesa
                            'Erro em Documentos Fiscais e Regulatórios': '#f1c40f', // Amarelo
                            'Problema Operacional / Autorização / Procedimento': '#34495e', // Cinza escuro
                            'Erro de Sistema / Integração / Processamento': '#e91e63', // Rosa/Magenta
                            'Erro de Peso / Quantidade / Medidas': '#27ae60', // Verde
                            'Erro de Classificação e produto': '#16a085' // Verde água
                        };
                        
                        // Paleta de cores padrão com alto contraste
                        const coresPadrao = [
                            '#e74c3c', // Vermelho
                            '#3498db', // Azul
                            '#f39c12', // Laranja
                            '#9b59b6', // Roxo
                            '#1abc9c', // Turquesa
                            '#e67e22', // Laranja escuro
                            '#f1c40f', // Amarelo
                            '#34495e'  // Cinza escuro
                        ];
                        
                        // Criar datasets para cada tipo de erro com estilo limpo e elegante
                        const datasets = topTipos.map((tipo, index) => {
                            const cor = coresTipos[tipo] || coresPadrao[index % coresPadrao.length];
                            
                            return {
                                label: tipo.length > 30 ? tipo.substring(0, 30) + '...' : tipo,
                                data: datasLimitadas.map(data => {
                                    const tiposMap = dadosPorData.get(data);
                                    return tiposMap ? (tiposMap.get(tipo) || 0) : 0;
                                }),
                                backgroundColor: cor,
                                borderColor: 'rgba(255, 255, 255, 0.3)',
                                borderWidth: 1,
                                borderRadius: {
                                    topLeft: 5,
                                    topRight: 5,
                                    bottomLeft: 0,
                                    bottomRight: 0
                                },
                                barThickness: 'flex',
                                maxBarThickness: 55,
                                categoryPercentage: 0.75,
                                barPercentage: 0.85
                            };
                        });
                        
                        // Formatar labels de data
                        const labels = datasLimitadas.map(data => {
                            try {
                                const date = new Date(data);
                                if (!isNaN(date.getTime())) {
                                    return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                                }
                            } catch (e) {}
                            return data;
                        });
                        
                    if (datasets.length > 0 && labels.length > 0) {
                        ctxUsuario._chart = new Chart(ctxUsuario, {
                                type: 'bar',
                                data: {
                                    labels: labels,
                                    datasets: datasets
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    layout: {
                                        padding: {
                                            left: 10,
                                            right: 20,
                                            top: 20,
                                            bottom: 10
                                        }
                                    },
                                    plugins: {
                                        legend: {
                                            display: true,
                                            position: 'right',
                                            align: 'start',
                                            labels: {
                                                color: colors.legendColor,
                                                font: { 
                                                    size: 11, 
                                                    weight: '500',
                                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                                },
                                                padding: 10,
                                                usePointStyle: true,
                                                pointStyle: 'circle',
                                                boxWidth: 12,
                                                boxHeight: 12
                                            }
                                        },
                                        tooltip: {
                                            enabled: true,
                                            backgroundColor: 'rgba(0, 0, 0, 0.88)',
                                            padding: 14,
                                            titleFont: { 
                                                size: 14, 
                                                weight: 'bold',
                                                family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                            },
                                            bodyFont: { 
                                                size: 12,
                                                family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                            },
                                            footerFont: {
                                                size: 12,
                                                weight: 'bold',
                                                family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                            },
                                            mode: 'index',
                                            intersect: false,
                                            axis: 'x',
                                            callbacks: {
                                                title: function(context) {
                                                    if (!context || context.length === 0) return '';
                                                    const index = context[0].dataIndex;
                                                    try {
                                                        const date = new Date(datasLimitadas[index]);
                                                        if (!isNaN(date.getTime())) {
                                                            return date.toLocaleDateString('pt-BR', { 
                                                                weekday: 'long',
                                                                day: '2-digit', 
                                                                month: 'long', 
                                                                year: 'numeric' 
                                                            });
                                                        }
                                                    } catch (e) {}
                                                    return datasLimitadas[index] || '';
                                                },
                                                label: function(context) {
                                                    if (!context) return '';
                                                    const datasetLabel = context.dataset.label || '';
                                                    const value = context.parsed.y || 0;
                                                    const allContexts = context.chart.tooltip.dataPoints || [];
                                                    const total = allContexts.reduce((sum, item) => sum + (item.parsed.y || 0), 0);
                                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                                    return `${datasetLabel}: ${value} (${percentage}%)`;
                                                },
                                                footer: function(context) {
                                                    if (!context || context.length === 0) return '';
                                                    const total = context.reduce((sum, item) => sum + (item.parsed.y || 0), 0);
                                                    return `Total: ${total} ocorrências`;
                                                }
                                            },
                                            cornerRadius: 8,
                                            displayColors: true,
                                            boxPadding: 6,
                                            borderColor: 'rgba(255, 255, 255, 0.1)',
                                            borderWidth: 1,
                                            titleSpacing: 8,
                                            bodySpacing: 5,
                                            footerSpacing: 8
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            stacked: true,
                                            ticks: { 
                                                color: colors.textColor,
                                                font: { 
                                                    size: 11, 
                                                    weight: '500',
                                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                                },
                                                stepSize: 1,
                                                padding: 10,
                                                callback: function(value) {
                                                    return Number.isInteger(value) ? value : '';
                                                }
                                            },
                                            grid: { 
                                                color: colors.gridColor,
                                                drawBorder: false,
                                                lineWidth: 1,
                                                drawTicks: false
                                            },
                                            title: {
                                                display: true,
                                                text: 'Quantidade de Ocorrências',
                                                color: colors.textColor,
                                                font: {
                                                    size: 12,
                                                    weight: 'bold',
                                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                                },
                                                padding: {
                                                    top: 5,
                                                    bottom: 15
                                                }
                                            }
                                        },
                                        x: {
                                            stacked: true,
                                            ticks: { 
                                                color: colors.textColor,
                                                font: { 
                                                    size: 11, 
                                                    weight: '500',
                                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                                },
                                                padding: 10,
                                                maxRotation: 45,
                                                minRotation: 45
                                            },
                                            grid: { 
                                                display: false,
                                                drawBorder: false
                                            }
                                        }
                                    },
                                    animation: {
                                        duration: 1500,
                                        easing: 'easeOutCubic'
                                    },
                                    interaction: {
                                        mode: 'index',
                                        intersect: false
                                    }
                                }
                            });
            } else {
                        console.warn('⚠️ Nenhum dado disponível para árvore de perdas agrupada por data');
                    }
                } else {
                    console.warn('⚠️ Nenhum dado de byDataETipoErro disponível');
                }
            } else {
                console.warn('⚠️ Elemento chartUsuarioGestao não encontrado ou dados de séries não disponíveis');
            }
        } catch (error) {
            console.error('❌ Erro ao carregar BI Gestão de Dados:', error);
            alert('Erro ao carregar dados do BI Gestão de Dados. Verifique o console para mais detalhes.');
        } finally {
            if(overlay) overlay.style.display = 'none';
        }
    }
    </script>
<!-- Chat IA -->
<link rel="stylesheet" href="css/chat-ia.css">
<script src="js/chat-ia.js"></script>
</body>
</html>