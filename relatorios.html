<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios Inteligentes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #f093fb;
            --success: #11998e;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --dark: #0f0f23;
            --white: #ffffff;
            --glass: rgba(255, 255, 255, 0.09);
            --glass-border: rgba(255, 255, 255, 0.14);
            --text-primary: #ffffff;
            --text-secondary: rgba(255,255,255,0.85);
            --border-radius: 22px;
            --box-shadow: 0 8px 32px rgba(0,0,0,.24);
            --transition: all 0.4s cubic-bezier(0.4,0,0.2,1);
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg,#0f0f23 0%,#1a1a2e 64%,#16213e 100%);
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
        }
        #particles-js { position: fixed; top: 0; left:0; width: 100vw;height: 100vh;z-index:-1; }
        .light-effect {
            position:absolute; z-index:-1; border-radius:50%; filter:blur(45px); animation: float 7s infinite alternate ease-in-out; opacity:.5;
        }
        .light-effect:nth-child(1){width:300px;height:300px;background:radial-gradient(circle,#667eea30 0%,transparent 78%);top:14%;left:7%;}
        .light-effect:nth-child(2){width:260px;height:280px;background:radial-gradient(circle,#f093fb25 0%,transparent 80%);bottom:14%;right:7%;animation-delay:2s;}
        .light-effect:nth-child(3){width:220px;height:200px;background:radial-gradient(circle,#764ba240 0%,transparent 85%);top:60%;left:52%;animation-delay:4s;}
        @keyframes float { 0%,100%{transform:translateY(0) scale(1);} 50%{transform:translateY(-14px) scale(1.06);} }
        .navbar {
            background: rgba(15,15,35,0.90);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.23);
        }
        .navbar-brand { font-weight: 700; font-size: 1.6rem;background: linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip: text;-webkit-text-fill-color: transparent; background-clip:text; }
        .nav-tabs { border: none;margin-bottom: 1.75rem;}
        .nav-tabs .nav-link { color: var(--text-secondary); background: var(--glass); margin-right:8px; border:none; border-radius: 16px 16px 0 0; padding:18px 32px; font-size:1.07rem; font-weight: 600; transition: var(--transition); }
        .nav-tabs .nav-link.active { background: linear-gradient(90deg,#667eea80,#764ba260,#f093fb15); color: var(--primary); border-bottom:2.5px solid var(--accent); }
        .main-container { padding: 2.5rem 0 1.3rem 0; min-height:calc(100vh - 70px);}        
        .card-futuristic,.metric-card { background: var(--glass); border-radius: var(--border-radius); border:1.5px solid var(--glass-border); box-shadow: var(--box-shadow); backdrop-filter:blur(18px); position:relative; transition: var(--transition);overflow:hidden;}
        .card-futuristic {margin-bottom:2.5rem;}
        .card-futuristic:hover{ box-shadow:0 14px 52px 0 #222b4e2c; border:1.5px solid var(--primary);}        
        .metric-card { text-align:center; padding:2.5rem 0 2.2rem 0; }
        .metric-value { font-size:2.1rem;font-weight:800; letter-spacing:-1.5px; margin-bottom: .45rem; background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text; }
        .metric-label { font-size:1.05rem;color:var(--text-secondary);font-weight:600;}
        .filter-card{ background: var(--glass); border: 1px solid var(--glass-border);border-radius: 15px;box-shadow:0 2px 20px #23213e13;margin-bottom:1.6rem;padding:1.2rem 1.4rem; }
        .form-label { color:var(--text-secondary);font-weight:600;margin-bottom:.5rem; }
        .form-select, .form-control {background:rgba(255,255,255,0.11);color:#fff; border:1.2px solid var(--glass-border); border-radius: 13px;padding:.85rem 1.2rem; font-size:1rem;}
        .form-select:focus,.form-control:focus{outline:none;border-color:var(--primary);} 
        .dashboard-row {display:flex;gap:2rem;flex-wrap:wrap; margin-bottom:1.6rem}
        .dashboard-row>.col,.dashboard-row>div{flex:1 1 230px;min-width:220px;}
        .charts-row {display:flex;gap:1.7rem;flex-wrap:wrap;margin-bottom:1.7rem}
        .charts-row>.card-futuristic{flex:1 1 330px;min-width:300px;}
        .chart-container { background:none;padding:.7rem 1.4rem;border-radius:13px;}
        .table-tech thead th {background:rgba(102,126,234,0.08);color:var(--text-primary);font-weight:700;}
        .table-tech th, .table-tech td{font-size:1rem; color:var(--text-primary); padding:1rem .7rem;}
        .loading-overlay { position: fixed; inset: 0; background: rgba(28,20,65,0.20); display: none; align-items: center; justify-content: center; z-index: 1050; }
        .spinner { width: 40px; height: 40px; border: 4px solid #dbeafe; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width:1020px){ .dashboard-row,.charts-row{flex-direction:column;gap:1.3rem;} }
        /* Botões futurísticos e toggle de tema */
        .btn-futuristic { background: linear-gradient(135deg, var(--primary), var(--secondary)); border: none; border-radius: 50px; padding: 0.75rem 1.2rem; font-weight: 600; color: #fff; transition: var(--transition); position: relative; overflow: hidden; }
        .btn-futuristic:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102,126,234,0.35); }
        .theme-toggle { background: var(--glass); border: 1px solid var(--glass-border); border-radius: 50px; padding: 8px 14px; color: var(--text-primary); transition: var(--transition); backdrop-filter: blur(10px); }
        .theme-toggle:hover { background: rgba(102,126,234,0.20); box-shadow: 0 0 18px rgba(102, 126, 234, 0.28); transform: translateY(-1px); }
        /* Cabeçalho de cards */
        .card-header-futuristic { background: linear-gradient(135deg, var(--primary), var(--secondary)); border-radius: var(--border-radius) var(--border-radius) 0 0; padding: 1rem 1.25rem; border: none; position: relative; overflow: hidden; }
        .card-header-futuristic h5 { color: #fff; margin: 0; font-weight: 700; }
        .card-header-futuristic::before { content: ''; position: absolute; inset: 0; background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.12) 50%, transparent 70%); animation: shimmer 3s infinite; }
        @keyframes shimmer { 0% { transform: translateX(-100%);} 100% { transform: translateX(100%);} }
        /* Light mode overrides */
        body.light-mode { color: #0f0f23; background: linear-gradient(135deg, #eef2ff 0%, #f8fafc 60%, #ffffff 100%); }
        body.light-mode .navbar { background: rgba(255,255,255,0.85); border-bottom: 1px solid rgba(0,0,0,0.08); }
        body.light-mode .navbar-brand { -webkit-text-fill-color: initial; background: linear-gradient(135deg, #4f46e5, #a855f7); -webkit-background-clip: text; background-clip: text; }
        body.light-mode .card-futuristic, body.light-mode .metric-card, body.light-mode .filter-card { background: rgba(255,255,255,0.75); border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 8px 26px rgba(0,0,0,0.10); }
        body.light-mode .metric-label, body.light-mode .form-label { color: #334155; }
        body.light-mode .table-tech thead th { background: #eef2ff; color: #0f172a; }
        body.light-mode .table-tech td, body.light-mode .table-tech th { color: #0f172a; }
        body.light-mode .form-select, body.light-mode .form-control { background: rgba(255,255,255,0.95); color: #0f172a; border: 1px solid rgba(0,0,0,0.12); }
        body.light-mode .nav-tabs .nav-link { color: #334155; background: rgba(0,0,0,0.04); }
        body.light-mode .nav-tabs .nav-link.active { color: #4f46e5; border-bottom-color: #a855f7; background: linear-gradient(90deg, #e0e7ff, #f3e8ff, #fdf4ff); }
        body.light-mode .theme-toggle { color: #0f172a; background: rgba(255,255,255,0.8); border: 1px solid rgba(0,0,0,0.08); }
    </style>
</head>
<body>
    <div class="light-effect"></div>
    <div class="light-effect"></div>
    <div class="light-effect"></div>
    <div id="particles-js"></div>
    <nav class="navbar navbar-expand-lg">
        <div class="container d-flex justify-content-between align-items-center">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <i class="fas fa-chart-bar me-2"></i> Relatórios Inteligentes
            </a>
            <div class="d-flex align-items-center gap-2">
                <a href="portal.html" class="btn btn-futuristic"><i class="fas fa-arrow-left me-2"></i>Voltar ao Portal</a>
                <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
            </div>
        </div>
    </nav>
    <div class="main-container">
    <div class="container">
            <ul class="nav nav-tabs" id="tabsRelatorios">
                <li class="nav-item"><button class="nav-link active" id="tabColetas" onclick="mostrarAba('coletas')">Coletas</button></li>
                <li class="nav-item"><button class="nav-link" id="tabBI" onclick="mostrarAba('bi')">BI Disparos</button></li>
				<li class="nav-item"><button class="nav-link" id="tabMotoristas" onclick="mostrarAba('motoristas')">Motoristas</button></li>
            </ul>
            <div id="abaColetas">
                <div class="dashboard-row">
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="totalColetas">0</div>
                        <div class="metric-label"><i class="fas fa-box"></i> Total de Coletas</div>
                </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="emAndamento">0</div>
                        <div class="metric-label"><i class="fas fa-clock"></i> Em Andamento</div>
            </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="concluidas">0</div>
                        <div class="metric-label"><i class="fas fa-check-circle"></i> Concluídas</div>
                </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="canceladas">0</div>
                        <div class="metric-label"><i class="fas fa-times-circle"></i> Canceladas</div>
            </div>
                </div>
                <div class="filter-card">
            <div class="row">
                        <div class="col-md-4 mb-2">
                    <label class="form-label"><i class="fas fa-calendar"></i> Período</label>
                    <select id="filtroPeriodo" class="form-select">
                        <option value="hoje">Hoje</option>
                        <option value="semana" selected>Esta Semana</option>
                        <option value="mes">Este Mês</option>
                        <option value="ano">Este Ano</option>
                        <option value="todos">Todos</option>
                    </select>
                </div>
                        <div class="col-md-4 mb-2">
                    <label class="form-label"><i class="fas fa-user"></i> Usuário</label>
                    <select id="filtroUsuario" class="form-select">
                        <option value="">Todos os usuários</option>
                    </select>
                </div>
                        <div class="col-md-4 mb-2 d-flex align-items-end">
                            <button class="btn btn-futuristic w-100" onclick="aplicarFiltros()">
                                <i class="fas fa-filter me-1"></i>Aplicar Filtros
                    </button>
                </div>
            </div>
        </div>
                <div class="charts-row">
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-chart-pie me-2"></i>Distribuição por Status</h5></div>
                        <div class="chart-container"><canvas id="chartStatus"></canvas></div>
                    </div>
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-chart-bar me-2"></i>Coletas por Mês</h5></div>
                        <div class="chart-container"><canvas id="chartMensal"></canvas></div>
                    </div>
                </div>
                <div class="charts-row">
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-users me-2"></i>Performance por Usuário</h5></div>
                        <div class="chart-container"><canvas id="chartUsuarios"></canvas></div>
            </div>
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-priority-high me-2"></i>Por Prioridade</h5></div>
                        <div class="chart-container"><canvas id="chartPrioridade"></canvas></div>
                    </div>
                    </div>
                <div class="card-futuristic">
                    <div class="card-header-futuristic"><h5><i class="fas fa-table me-2"></i>Relatório Detalhado</h5></div>
            <div class="table-responsive p-3">
                <table class="table table-tech">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Título</th>
                            <th>Status</th>
                            <th>Etapa</th>
                            <th>Data</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaRelatorio">
                                <tr><td colspan="6" class="text-center text-muted py-4">Carregando dados...</td></tr>
                    </tbody>
                </table>
            </div>
        </div>
                <div class="dashboard-row">
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="tempoMedio">0</div>
                        <div class="metric-label"><i class="fas fa-clock"></i> Tempo Médio</div>
                </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="taxaSucesso">0%</div>
                        <div class="metric-label"><i class="fas fa-percentage"></i> Taxa de Sucesso</div>
            </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="noPrazo">0</div>
                        <div class="metric-label"><i class="fas fa-calendar-check"></i> No Prazo</div>
                </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="atrasadas">0</div>
                        <div class="metric-label"><i class="fas fa-exclamation-triangle"></i> Atrasadas</div>
            </div>
                </div>
            </div>
            <div id="abaBI" style="display:none">
                <div class="dashboard-row">
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="kpiTotalDisp">0</div>
                        <div class="metric-label"><i class="fas fa-paper-plane"></i> Total de Disparos</div>
                </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="kpiUsuariosDisp">0</div>
                        <div class="metric-label"><i class="fas fa-users"></i> Usuários Enviando</div>
            </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="kpiDepartamentosDisp">0</div>
                        <div class="metric-label"><i class="fas fa-building"></i> Departamentos Ativos</div>
        </div>
                    </div>
			<div id="abaMotoristas" style="display:none">
				<div class="dashboard-row">
					<div class="metric-card card-futuristic">
						<div class="metric-value" id="kpiTotalMot">0</div>
						<div class="metric-label"><i class="fas fa-id-card"></i> Total de Motoristas</div>
					</div>
					<div class="metric-card card-futuristic">
						<div class="metric-value" id="kpiUsuariosMot">0</div>
						<div class="metric-label"><i class="fas fa-users"></i> Usuários Cadastrando</div>
					</div>
					<div class="metric-card card-futuristic">
						<div class="metric-value" id="kpiDepartamentosMot">0</div>
						<div class="metric-label"><i class="fas fa-building"></i> Departamentos Ativos</div>
					</div>
				</div>
				<div class="filter-card">
					<div class="row">
						<div class="col-md-3 mb-2">
							<label class="form-label"><i class="fas fa-calendar"></i> Período</label>
							<select id="filtroPeriodoMot" class="form-select" onchange="carregarMotoristas()">
								<option value="hoje">Hoje</option>
								<option value="mes" selected>Este Mês</option>
								<option value="ano">Este Ano</option>
								<option value="todos">Todos</option>
							</select>
						</div>
						<div class="col-md-4 mb-2">
							<label class="form-label"><i class="fas fa-user"></i> Usuário</label>
							<select id="filtroUsuarioMot" class="form-select" onchange="carregarMotoristas()">
								<option value="">Todos os usuários</option>
							</select>
						</div>
						<div class="col-md-5 mb-2">
							<label class="form-label"><i class="fas fa-building"></i> Departamento</label>
							<select id="filtroDepartamentoMot" class="form-select" onchange="carregarMotoristas()">
								<option value="">Todos os departamentos</option>
							</select>
						</div>
					</div>
				</div>
				<div class="charts-row">
					<div class="card-futuristic">
						<div class="card-header-futuristic"><h5><i class="fas fa-user"></i> Motoristas por Usuário (Criador)</h5></div>
						<div class="chart-container"><canvas id="chartUsuarioMot"></canvas></div>
					</div>
					<div class="card-futuristic">
						<div class="card-header-futuristic"><h5><i class="fas fa-building"></i> Motoristas por Departamento</h5></div>
						<div class="chart-container"><canvas id="chartDepartamentoMot"></canvas></div>
					</div>
				</div>
				<div class="charts-row">
					<div class="card-futuristic w-100">
						<div class="card-header-futuristic"><h5><i class="fas fa-calendar"></i> Cadastros de Motoristas por Período</h5></div>
						<div class="chart-container"><canvas id="chartTemporalMot"></canvas></div>
					</div>
        </div>
                    </div>
                <div class="filter-card">
                    <div class="row">
                        <div class="col-md-3 mb-2">
                            <label class="form-label"><i class="fas fa-calendar"></i> Período</label>
                            <select id="filtroPeriodoDisp" class="form-select" onchange="carregarDisparos()">
                                <option value="hoje">Hoje</option>
                                <option value="mes" selected>Este Mês</option>
                                <option value="ano">Este Ano</option>
                                <option value="todos">Todos</option>
                            </select>
                    </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label"><i class="fas fa-user"></i> Usuário</label>
                            <select id="filtroUsuarioDisp" class="form-select" onchange="carregarDisparos()">
                                <option value="">Todos os usuários</option>
                            </select>
                </div>
                        <div class="col-md-5 mb-2">
                            <label class="form-label"><i class="fas fa-building"></i> Departamento</label>
                            <select id="filtroDepartamentoDisp" class="form-select" onchange="carregarDisparos()">
                                <option value="">Todos os departamentos</option>
                            </select>
            </div>
                    </div>
                    </div>
                <div class="charts-row">
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-user"></i> Disparos por Usuário</h5></div>
                        <div class="chart-container"><canvas id="chartUsuarioDisp"></canvas></div>
                </div>
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-building"></i> Disparos por Departamento</h5></div>
                        <div class="chart-container"><canvas id="chartDepartamentoDisp"></canvas></div>
            </div>
        </div>
                <div class="charts-row">
                    <div class="card-futuristic w-100">
                        <div class="card-header-futuristic"><h5><i class="fas fa-calendar"></i> Disparos por Período</h5></div>
                        <div class="chart-container"><canvas id="chartTemporalDisp"></canvas></div>
                    </div>
                    </div>
                </div>
            </div>
                    </div>
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="text-center"><div class="spinner"></div><p class="loading-text">Carregando relatórios...</p></div>
        </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
	<script src="js/permissions.js"></script>
    <script>
    function mostrarAba(aba) {
        document.getElementById('tabColetas').classList.toggle('active', aba==='coletas');
        document.getElementById('tabBI').classList.toggle('active', aba==='bi');
		const tabMot = document.getElementById('tabMotoristas');
		if(tabMot) tabMot.classList.toggle('active', aba==='motoristas');
        document.getElementById('abaColetas').style.display = aba==='coletas' ? '' : 'none';
        document.getElementById('abaBI').style.display = aba==='bi' ? '' : 'none';
		const abaMot = document.getElementById('abaMotoristas');
		if(abaMot) abaMot.style.display = aba==='motoristas' ? '' : 'none';
        if(aba==='bi' && typeof carregarDisparos==='function' && typeof carregarFiltrosDisparos==='function') {
            if(!window._rel_bi_inited){
                carregarFiltrosDisparos().then(() => carregarDisparos());
                window._rel_bi_inited=true;
            }
        }
		if(aba==='motoristas'){
			(async ()=>{
				try{
					const st = await fetch('/api/auth/status', { credentials:'include' });
					if(handleUnauthorized(st)) return;
					if(!window._rel_mot_inited){
						await carregarFiltrosMotoristas();
						await carregarMotoristas();
						window._rel_mot_inited=true;
					}else{
						await carregarMotoristas();
					}
				}catch(e){ console.error('Erro ao carregar Motoristas:', e); }
			})();
		}
    }
    function toggleTheme(){
        const body = document.body;
        const themeIcon = document.querySelector('#themeToggle i');
        if(body.classList.contains('light-mode')){
            body.classList.remove('light-mode');
            if(themeIcon) themeIcon.className = 'fas fa-moon';
            localStorage.setItem('theme','dark');
                } else {
            body.classList.add('light-mode');
            if(themeIcon) themeIcon.className = 'fas fa-sun';
            localStorage.setItem('theme','light');
        }
    }
    document.addEventListener('DOMContentLoaded', ()=>{
        const savedTheme = localStorage.getItem('theme') || 'dark';
        if(savedTheme==='light'){
            document.body.classList.add('light-mode');
            const themeIcon = document.querySelector('#themeToggle i');
            if(themeIcon) themeIcon.className = 'fas fa-sun';
        }
			(async ()=>{
				try{
					if(typeof verificarEAplicarPermissao==='function'){
						const ok = await verificarEAplicarPermissao('relatorios');
						if(!ok) return; // será redirecionado pelo permissions.js
					}
					mostrarAba('coletas');
				}catch(e){
					console.error('Erro ao verificar permissão para relatórios:', e);
					// fallback: ainda mostra aba coletas (não exige chamadas protegidas imediatamente)
        mostrarAba('coletas');
				}
			})();
		});

	// ====== SUPABASE (reutiliza endpoint backend para config) ======
	let _sbClient = null;
	async function getSupabaseClientRel(){
		if(_sbClient) return _sbClient;
		const resp = await fetch('/api/supabase-config');
		if(!resp.ok) return null;
		const cfg = await resp.json();
		if(typeof window.supabase==='undefined') return null;
		_sbClient = window.supabase.createClient(cfg.supabaseUrl, cfg.supabaseAnonKey);
		return _sbClient;
	}

	function handleUnauthorized(resp){
		if(resp && resp.status===401){
			alert('Sessão expirada ou não autenticada. Faça login para acessar os relatórios.');
			return true;
		}
		return false;
	}

	// ====== MOTORISTAS - FILTROS E CARGA ======
	let chartUsuarioMot = null, chartDepartamentoMot = null, chartTemporalMot = null;

	function periodoToRange(periodo){
		const now = new Date();
		let inicio = null;
		if(periodo==='hoje'){
			inicio = new Date(now.getFullYear(), now.getMonth(), now.getDate());
		}else if(periodo==='mes'){
			inicio = new Date(now.getFullYear(), now.getMonth(), 1);
		}else if(periodo==='ano'){
			inicio = new Date(now.getFullYear(), 0, 1);
		}
		return { inicio, fim: now };
	}

	async function carregarFiltrosMotoristas(){
		const resp = await fetch('/api/relatorios/motoristas/filtros', { credentials: 'include' });
		if(handleUnauthorized(resp)) return;
		if(!resp.ok) return;
		const json = await resp.json();
		const usuarios = json.usuarios || [];
		const departamentos = json.departamentos || [];
		const selUsuario = document.getElementById('filtroUsuarioMot');
		const selDept = document.getElementById('filtroDepartamentoMot');
		if(selUsuario){
			selUsuario.innerHTML = '<option value="">Todos os usuários</option>' +
			usuarios.map(u=>`<option value="${u.id}">${u.nome||u.id}</option>`).join('');
		}
		if(selDept){
			selDept.innerHTML = '<option value="">Todos os departamentos</option>' +
			departamentos.map(d=>`<option value="${d}">${d}</option>`).join('');
		}
	}

	function ensureChart(ctxId, type, data, options){
		const ctx = document.getElementById(ctxId);
		if(!ctx) return null;
		if(ctx._chart){ ctx._chart.destroy(); }
		ctx._chart = new Chart(ctx, { type, data, options });
		return ctx._chart;
	}

	async function carregarMotoristas(){
		const overlay = document.getElementById('loadingOverlay');
		if(overlay) overlay.style.display = 'flex';
		try{
			const periodo = document.getElementById('filtroPeriodoMot')?.value || 'mes';
			const usuarioId = document.getElementById('filtroUsuarioMot')?.value || '';
			const departamento = document.getElementById('filtroDepartamentoMot')?.value || '';
			const range = periodoToRange(periodo);
			const params = new URLSearchParams({
				inicio: range.inicio ? range.inicio.toISOString() : '',
				fim: range.fim ? range.fim.toISOString() : '',
				usuarioId,
				departamento
			});
			const [kpiResp, seriesResp] = await Promise.all([
				fetch(`/api/relatorios/motoristas/kpis?${params}`, { credentials:'include' }),
				fetch(`/api/relatorios/motoristas/series?${params}`, { credentials:'include' })
			]);
			if(handleUnauthorized(kpiResp) || handleUnauthorized(seriesResp)) return;
			if(kpiResp.ok){
				const k = await kpiResp.json();
				document.getElementById('kpiTotalMot').innerText = (k.total||0).toString();
				document.getElementById('kpiUsuariosMot').innerText = (k.usuarios||0).toString();
				document.getElementById('kpiDepartamentosMot').innerText = (k.departamentos||0).toString();
			}
			if(seriesResp.ok){
				const s = await seriesResp.json();
				chartUsuarioMot = ensureChart('chartUsuarioMot','bar',{
					labels: (s.byUser||[]).map(u=>u.nome),
					datasets:[{ label:'Motoristas', data: (s.byUser||[]).map(u=>u.count), backgroundColor:'#667eea' }]
				},{ responsive:true, plugins:{ legend:{ display:false }}});
				chartDepartamentoMot = ensureChart('chartDepartamentoMot','bar',{
					labels: (s.byDepartment||[]).map(d=>d.departamento),
					datasets:[{ label:'Motoristas', data: (s.byDepartment||[]).map(d=>d.count), backgroundColor:'#22c55e' }]
				},{ responsive:true, plugins:{ legend:{ display:false }}});
				chartTemporalMot = ensureChart('chartTemporalMot','line',{
					labels: (s.byDay||[]).map(d=>d.date),
					datasets:[{ label:'Cadastros', data: (s.byDay||[]).map(d=>d.count), borderColor:'#f59e0b', backgroundColor:'rgba(245,158,11,0.25)', fill:true, tension:0.3 }]
				},{ responsive:true });
			}
		} finally {
			if(overlay) overlay.style.display = 'none';
		}
	}
    </script>
</body>
</html>