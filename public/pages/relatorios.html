<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios Inteligentes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #f093fb;
            --success: #11998e;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --dark: #0f0f23;
            --white: #ffffff;
            --glass: rgba(255, 255, 255, 0.09);
            --glass-border: rgba(255, 255, 255, 0.14);
            --text-primary: #ffffff;
            --text-secondary: rgba(255,255,255,0.85);
            --border-radius: 22px;
            --box-shadow: 0 8px 32px rgba(0,0,0,.24);
            --transition: all 0.4s cubic-bezier(0.4,0,0.2,1);
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg,#0f0f23 0%,#1a1a2e 64%,#16213e 100%);
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
        }
        #particles-js { position: fixed; top: 0; left:0; width: 100vw;height: 100vh;z-index:-1; }
        .light-effect {
            position:absolute; z-index:-1; border-radius:50%; filter:blur(45px); animation: float 7s infinite alternate ease-in-out; opacity:.5;
        }
        .light-effect:nth-child(1){width:300px;height:300px;background:radial-gradient(circle,#667eea30 0%,transparent 78%);top:14%;left:7%;}
        .light-effect:nth-child(2){width:260px;height:280px;background:radial-gradient(circle,#f093fb25 0%,transparent 80%);bottom:14%;right:7%;animation-delay:2s;}
        .light-effect:nth-child(3){width:220px;height:200px;background:radial-gradient(circle,#764ba240 0%,transparent 85%);top:60%;left:52%;animation-delay:4s;}
        @keyframes float { 0%,100%{transform:translateY(0) scale(1);} 50%{transform:translateY(-14px) scale(1.06);} }
        .navbar {
            background: rgba(15,15,35,0.90);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            box-shadow: 0 4px 20px rgba(0,0,0,0.23);
        }
        .navbar-brand { font-weight: 700; font-size: 1.6rem;background: linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip: text;-webkit-text-fill-color: transparent; background-clip:text; }
        .nav-tabs { border: none;margin-bottom: 0 !important; position: relative; z-index: 10;}
        .nav-tabs .nav-link { color: var(--text-secondary); background: var(--glass); margin-right:6px; border:none; border-radius: 12px 12px 0 0; padding:12px 20px; font-size:0.95rem; font-weight: 600; transition: var(--transition); }
        .nav-tabs .nav-link.active { background: linear-gradient(90deg,#667eea80,#764ba260,#f093fb15); color: var(--primary); border-bottom:2.5px solid var(--accent); }
        .main-container { padding: 1.5rem 0 1rem 0; min-height:calc(100vh - 70px);}        
        .main-container .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 0 1.5rem; 
            position: relative;
            box-sizing: border-box;
        }
        
        
        /* Garantir que abas ocultas não ocupem espaço */
        #abaColetas[style*="display: none"],
        #abaBI[style*="display: none"],
        #abaCadastros[style*="display: none"],
        #abaBIGestao[style*="display: none"] {
            display: none !important;
            height: 0 !important;
            overflow: hidden !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        @media (max-width: 1200px) {
            .main-container .container {
                padding: 0 1rem;
            }
        }
        @media (max-width: 768px) {
            .main-container .container {
                padding: 0 0.75rem;
            }
        }
        #abaBI, #abaCadastros, #abaBIGestao { 
            width: 100%; 
            max-width: 100%;
            padding: 0; 
            margin: 0; 
            position: relative;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        .card-futuristic,.metric-card { background: var(--glass); border-radius: var(--border-radius); border:1.5px solid var(--glass-border); box-shadow: var(--box-shadow); backdrop-filter:blur(18px); position:relative; transition: var(--transition);overflow:hidden;}
        .card-futuristic {margin-bottom:1.5rem;}
        .card-futuristic:hover{ box-shadow:0 14px 52px 0 #222b4e2c; border:1.5px solid var(--primary);}        
        .metric-card { 
            text-align:center; 
            padding:1.8rem 1rem 1.5rem 1rem; 
            position: relative;
            overflow: hidden;
        }
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(102,126,234,0.5), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .metric-card:hover::before {
            opacity: 1;
        }
        .metric-value { 
            font-size: 2.25rem;
            font-weight: 700; 
            letter-spacing: -1.5px; 
            margin-bottom: 0.625rem; 
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 1;
        }
        .metric-label { 
            font-size: 0.875rem;
            color: rgba(255,255,255,0.65);
            font-weight: 500;
            letter-spacing: 0.3px;
            position: relative;
            z-index: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-transform: uppercase;
        }
        .metric-label i {
            font-size: 1rem;
            color: rgba(102,126,234,0.7);
        }
        .filter-card{ 
            background: rgba(15, 15, 35, 0.4);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.1), 0 1px 4px rgba(0, 0, 0, 0.06);
            margin-bottom: 2rem;
            padding: 1.5rem; 
            position: relative;
            overflow: hidden;
        }
        .form-label { 
            color: rgba(255,255,255,0.7);
            font-weight: 500;
            margin-bottom: 0.625rem; 
            font-size: 0.8125rem;
            letter-spacing: 0.2px;
        }
        .form-select, .form-control {
            background: rgba(255,255,255,0.05);
            color: rgba(255,255,255,0.9); 
            border: 1px solid rgba(255,255,255,0.1); 
            border-radius: 10px;
            padding: 0.75rem 1rem; 
            font-size: 0.875rem;
            transition: all 0.3s ease;
        }
        .form-select:focus,.form-control:focus{
            outline: none;
            background: rgba(255,255,255,0.08);
            border-color: rgba(102,126,234,0.5);
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        .form-select:hover,.form-control:hover{
            border-color: rgba(255,255,255,0.15);
        } 
        .dashboard-row {display:flex;gap:1.2rem;flex-wrap:wrap; margin-bottom:1.2rem}
        .dashboard-row>.col,.dashboard-row>div{flex:1 1 180px;min-width:160px;}
        .charts-row {display:flex;gap:1.2rem;flex-wrap:wrap;margin-bottom:1.2rem}
        .charts-row>.card-futuristic{flex:1 1 280px;min-width:260px;}

        /* Harmonizar layout de BI Disparos, Cadastros, BI Gestão e Coletas */
        #abaBI .dashboard-row,
        #abaBIGestao .dashboard-row,
        #abaCadastros .dashboard-row,
        #abaColetas .dashboard-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1.2rem;
            margin-bottom: 1.2rem;
        }
        #abaBI .metric-card,
        #abaBIGestao .metric-card,
        #abaCadastros .metric-card,
        #abaColetas .metric-card {
            height: 100%;
        }
        /* ========== BI DE COLETAS — Modelo enterprise (Tableau/Power BI + glassmorphism) ========== */
        #abaColetas.bi-coletas-aba {
            padding: 0 0 2rem;
            max-width: 100%;
            box-sizing: border-box;
        }

        /* Header: título claro, sem poluição visual (overview in 5 segundos) */
        #abaColetas .bi-coletas-hero {
            background: rgba(255, 255, 255, 0.04);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 1.5rem 2rem;
            margin-bottom: 1.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            backdrop-filter: blur(12px);
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.12);
        }
        #abaColetas .bi-coletas-hero h2 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            letter-spacing: -0.02em;
        }
        #abaColetas .bi-coletas-hero h2 i {
            color: #818cf8;
            opacity: 0.95;
        }
        #abaColetas .bi-coletas-hero .bi-coletas-sub {
            display: block;
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.875rem;
            font-weight: 400;
            margin-top: 0.25rem;
        }
        .bi-coletas-hero-badge {
            align-items: center;
            gap: 0.5rem;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.8rem;
            font-weight: 500;
        }
        .bi-live-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #22c55e;
            box-shadow: 0 0 8px rgba(34, 197, 94, 0.5);
        }

        /* Seções: hierarquia clara, espaçamento consistente (25px entre blocos) */
        .bi-coletas-section {
            margin-bottom: 2rem;
        }
        .bi-coletas-section-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        .bi-coletas-section-title i {
            color: #818cf8;
            font-size: 0.9rem;
        }

        /* KPIs: uma linha, cards limpos (princípio overview first) */
        .bi-coletas-kpis {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 1rem;
        }
        .bi-kpi-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 10px;
            padding: 1rem 0.75rem;
            text-align: center;
            transition: background 0.2s, border-color 0.2s;
        }
        .bi-kpi-card:hover {
            background: rgba(255, 255, 255, 0.08);
            border-color: rgba(129, 140, 248, 0.3);
        }
        .bi-kpi-card--highlight {
            border-color: rgba(34, 197, 94, 0.25);
            background: rgba(34, 197, 94, 0.06);
        }
        .bi-kpi-card--highlight .bi-kpi-value {
            color: #4ade80;
        }
        .bi-kpi-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #fff;
            line-height: 1.2;
            margin-bottom: 0.25rem;
        }
        .bi-kpi-label {
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.5);
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        .bi-kpi-label i {
            margin-right: 0.25rem;
            color: rgba(129, 140, 248, 0.8);
            font-size: 0.65rem;
        }

        /* Filtros: barra compacta no topo (best practice) */
        #abaColetas .bi-coletas-filter,
        #abaColetas .filter-card.bi-coletas-filter {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 10px;
            padding: 1.25rem 1.5rem;
            margin-bottom: 1.75rem;
        }
        #abaColetas .bi-coletas-filter .form-label,
        #abaColetas .filter-card.bi-coletas-filter .form-label {
            color: rgba(255, 255, 255, 0.65);
            font-size: 0.75rem;
        }
        #abaColetas .bi-coletas-filter .form-label i,
        #abaColetas .filter-card.bi-coletas-filter .form-label i {
            color: #818cf8;
        }
        #abaColetas .bi-coletas-filter .form-select,
        #abaColetas .bi-coletas-filter .form-control,
        #abaColetas .filter-card.bi-coletas-filter .form-select,
        #abaColetas .filter-card.bi-coletas-filter .form-control {
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            color: #fff;
            font-size: 0.875rem;
        }
        #abaColetas .bi-coletas-filter .form-select:focus,
        #abaColetas .bi-coletas-filter .form-control:focus {
            border-color: #818cf8;
            box-shadow: 0 0 0 2px rgba(129, 140, 248, 0.2);
        }
        .bi-coletas-filter .row {
            display: grid !important;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 1rem;
        }

        /* Cards de gráficos Coletas: mesmo estilo do BI Gestão (gradiente no header, sem override) */

        /* Tabela: legível, zebra sutil */
        .bi-coletas-table-card {
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.02);
        }
        .bi-coletas-table-card .table-tech { margin-bottom: 0; }
        #abaColetas .table-tech thead th {
            background: rgba(129, 140, 248, 0.12) !important;
            color: #fff !important;
            font-size: 0.8rem;
            font-weight: 600;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
            padding: 0.75rem 1rem;
        }
        #abaColetas .table-tech tbody td {
            font-size: 0.85rem;
            padding: 0.65rem 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.04);
        }
        #abaColetas .table-tech tbody tr:hover {
            background: rgba(255, 255, 255, 0.04) !important;
        }

        @media (min-width: 768px) {
            .bi-coletas-kpis { grid-template-columns: repeat(4, 1fr); }
        }
        @media (min-width: 1024px) {
            .bi-coletas-kpis { grid-template-columns: repeat(6, 1fr); }
        }

        /* Hero BI Gestão (manter compatível) */
        #abaBIGestao .bi-gestao-hero {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 45%, var(--accent) 100%);
            border-radius: 16px;
            padding: 1.5rem 2rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 1rem;
            border: 1px solid rgba(255,255,255,0.2);
            box-shadow: 0 8px 32px rgba(102,126,234,0.25), inset 0 1px 0 rgba(255,255,255,0.2);
            position: relative;
            overflow: hidden;
        }
        #abaBIGestao .bi-gestao-hero::before {
            content: '';
            position: absolute;
            inset: 0;
            background-image: 
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 24px 24px;
            pointer-events: none;
        }
        #abaBIGestao .bi-gestao-hero h2,
        #abaBIGestao .bi-gestao-hero .bi-gestao-sub {
            position: relative;
            z-index: 1;
        }
        
        /* Metric Cards — mesmo padrão tecnológico do BI Gestão */
        #abaColetas .metric-card {
            background: var(--glass);
            border: 1.5px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            backdrop-filter: blur(18px);
            padding: 1.8rem 1rem 1.5rem;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        #abaColetas .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(102,126,234,0.5), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        #abaColetas .metric-card:hover {
            border-color: var(--primary);
            box-shadow: 0 14px 52px rgba(102,126,234,0.2);
        }
        #abaColetas .metric-card:hover::before {
            opacity: 1;
        }
        #abaColetas .metric-value {
            font-size: 2.25rem;
            font-weight: 700;
            letter-spacing: -1.5px;
            margin-bottom: 0.625rem;
            background: linear-gradient(135deg, rgba(255,255,255,0.95) 0%, rgba(255,255,255,0.85) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        #abaColetas .metric-label {
            font-size: 0.875rem;
            color: rgba(255,255,255,0.65);
            font-weight: 500;
            letter-spacing: 0.3px;
            text-transform: uppercase;
        }
        #abaColetas .metric-label i {
            color: rgba(102,126,234,0.7);
        }
        
        /* Chart Cards — headers com gradiente forte como BI Gestão */
        #abaColetas .card-futuristic {
            background: var(--glass);
            border: 1.5px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            backdrop-filter: blur(18px);
            transition: var(--transition);
            overflow: hidden;
        }
        #abaColetas .card-futuristic:hover {
            border-color: var(--primary);
            box-shadow: 0 14px 52px rgba(102,126,234,0.2);
        }
        /* Headers iguais ao BI Gestão: gradiente primary → secondary → accent */
        #abaColetas .card-header-futuristic {
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            padding: 0.85rem 1rem;
            border: none;
            min-height: 45px;
            max-height: 55px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.2), 0 2px 10px rgba(0,0,0,0.1);
        }
        #abaColetas .card-header-futuristic h5 {
            margin: 0;
            font-size: 0.95rem;
            font-weight: 700;
            color: #fff;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        #abaColetas .card-header-futuristic h5 i {
            filter: drop-shadow(0 0 4px rgba(255,255,255,0.5));
        }
        /* Hints sob gráficos (como BI Gestão) */
        #abaColetas .chart-hint {
            display: block;
            text-align: center;
            margin-top: 0.5rem;
            padding: 0 1rem;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.6);
        }
        #abaColetas .chart-hint i {
            margin-right: 0.25rem;
        }
        
        /* Filter Card — grid como BI Gestão */
        #abaColetas .filter-card {
            background: var(--glass);
            border: 1.5px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: var(--box-shadow);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        #abaColetas .filter-card .row {
            display: grid !important;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.85rem 1.2rem;
            margin: 0;
            width: 100%;
        }
        #abaColetas .filter-card .row > div {
            width: 100%;
            max-width: 100%;
            padding: 0;
            box-sizing: border-box;
        }
        #abaColetas .form-label {
            color: rgba(255,255,255,0.7);
            font-weight: 500;
            font-size: 0.8125rem;
            margin-bottom: 0.5rem;
        }
        #abaColetas .form-label i {
            color: rgba(102,126,234,0.7);
        }
        #abaColetas .form-select,
        #abaColetas .form-control {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px;
            padding: 0.75rem 1rem;
            color: rgba(255,255,255,0.9);
            font-size: 0.875rem;
        }
        #abaColetas .form-select:focus,
        #abaColetas .form-control:focus {
            outline: none;
            border-color: rgba(102,126,234,0.5);
            box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
        }
        
        #abaColetas .dashboard-row {
            gap: 1.2rem;
            margin-bottom: 1.5rem;
        }
        /* Gráficos: mesmo padrão do BI Gestão — tamanho contido, 2–3 por linha */
        #abaColetas .charts-row {
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        #abaColetas .table-tech thead th {
            background: rgba(102,126,234,0.15) !important;
            color: #fff !important;
            font-weight: 700;
            border-bottom: 2px solid rgba(102,126,234,0.3);
        }
        #abaColetas .table-tech tbody td {
            color: rgba(255,255,255,0.9);
            border-bottom: 1px solid rgba(255,255,255,0.08);
        }
        #abaColetas .table-tech tbody tr:hover {
            background: rgba(102,126,234,0.15) !important;
        }
        #abaBI .charts-row,
        #abaBIGestao .charts-row,
        #abaCadastros .charts-row,
        #abaColetas .charts-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        #abaBI .charts-row .card-futuristic,
        #abaBIGestao .charts-row .card-futuristic,
        #abaCadastros .charts-row .card-futuristic,
        #abaColetas .charts-row .card-futuristic {
            height: 360px;
            min-height: 360px;
            max-height: 360px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-sizing: border-box;
        }
        #abaBI .charts-row .card-futuristic .chart-container,
        #abaBIGestao .charts-row .card-futuristic .chart-container,
        #abaCadastros .charts-row .card-futuristic .chart-container,
        #abaColetas .charts-row .card-futuristic .chart-container {
            flex: 1 1 0;
            min-height: 260px;
            height: 280px;
            overflow: hidden;
            display: block;
            box-sizing: border-box;
            padding: 0.5rem 0.75rem;
            position: relative;
        }
        #abaBI .charts-row .card-futuristic .chart-container canvas,
        #abaBIGestao .charts-row .card-futuristic .chart-container canvas,
        #abaCadastros .charts-row .card-futuristic .chart-container canvas,
        #abaColetas .charts-row .card-futuristic .chart-container canvas {
            width: 100% !important;
            height: 100% !important;
            max-width: 100% !important;
            max-height: 100% !important;
            display: block;
            box-sizing: border-box;
        }
        #abaBI .filter-card .row,
        #abaBIGestao .filter-card .row,
        #abaCadastros .filter-card .row,
        #abaColetas .filter-card .row {
            display: grid !important;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 0.85rem 1.2rem;
            margin: 0;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        #abaBI .filter-card .row > div,
        #abaBIGestao .filter-card .row > div,
        #abaCadastros .filter-card .row > div,
        #abaColetas .filter-card .row > div {
            width: 100%;
            max-width: 100%;
            padding: 0;
            box-sizing: border-box;
        }
        /* Garantir que a aba do BI Gestão respeite o padding do container */
        #abaBIGestao {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            overflow-x: hidden;
        }
        #abaBIGestao .dashboard-row,
        #abaBIGestao .filter-card,
        #abaBIGestao .charts-row {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            margin-left: 0;
            margin-right: 0;
        }
        #abaBIGestao .card-futuristic {
            max-width: 100%;
            box-sizing: border-box;
        }
        .chart-container { 
            background: none;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            position: relative;
            display: flex;
            align-items: stretch;
            justify-content: stretch;
            overflow: hidden;
            box-sizing: border-box;
            min-height: 240px;
            height: 100%;
            flex: 1 1 auto;
        }
        .chart-container canvas { 
            width: 100% !important;
            height: 100% !important;
            max-width: 100% !important;
            max-height: 100% !important;
            display: block;
            box-sizing: border-box;
        }
        .card-header-futuristic {
            background: linear-gradient(135deg, var(--primary), var(--secondary), var(--accent));
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            padding: 0.85rem 1rem;
            border: none;
            margin-bottom: 0;
            height: auto;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            min-height: 45px;
            box-shadow: inset 0 1px 0 rgba(255,255,255,0.2), 
                        0 2px 10px rgba(0,0,0,0.1);
            min-height:45px;
            max-height:55px;
            flex-shrink:0;
            box-sizing:border-box;
        }
        .card-header-futuristic h5 {
            margin:0;
            font-size:0.95rem;
            font-weight:700;
            line-height:1.3;
            color: #fff;
            position: relative;
            z-index: 2;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
        }
        .card-header-futuristic h5 i {
            filter: drop-shadow(0 0 4px rgba(255,255,255,0.5));
        }
        .table-tech { background: transparent; border-collapse: collapse; }
        /* Modo escuro (noturno) - forçar texto branco com máxima especificidade */
        body:not(.light-mode) .table.table-tech,
        body:not(.light-mode) .table.table-tech *,
        body:not(.light-mode) .table.table-tech th,
        body:not(.light-mode) .table.table-tech td,
        body:not(.light-mode) .table.table-tech thead th,
        body:not(.light-mode) .table.table-tech tbody td,
        body:not(.light-mode) .table.table-tech span,
        body:not(.light-mode) .table.table-tech div {
            color: #ffffff !important;
        }
        body:not(.light-mode) .table.table-tech .text-muted,
        body:not(.light-mode) .table.table-tech td.text-muted {
            color: rgba(255,255,255,0.8) !important;
        }
        /* Badges dentro da tabela no modo escuro */
        body:not(.light-mode) .table.table-tech .badge,
        body:not(.light-mode) .table.table-tech .badge.bg-warning,
        body:not(.light-mode) .table.table-tech .badge.bg-info,
        body:not(.light-mode) .table.table-tech .badge.bg-success,
        body:not(.light-mode) .table.table-tech .badge.bg-danger,
        body:not(.light-mode) .table.table-tech .badge.bg-secondary {
            color: #ffffff !important;
            font-weight: 600;
        }
        .table-tech {
            background: transparent !important;
            color: var(--text-primary) !important;
        }
        .table-tech thead th {
            background: rgba(102,126,234,0.15) !important;
            color: #ffffff !important;
            font-weight: 700;
            border-bottom: 2px solid rgba(102,126,234,0.3);
        }
        .table-tech tbody {
            background: transparent !important;
        }
        .table-tech th, .table-tech td {
            font-size: 1rem;
            color: #ffffff !important;
            padding: 1rem .7rem;
            border-bottom: 1px solid rgba(255,255,255,0.08);
            background: transparent !important;
        }
        .table-tech tbody tr {
            background: transparent !important;
        }
        .table-tech tbody tr:hover { 
            background: rgba(102,126,234,0.15) !important; 
        }
        .table-tech .text-muted { 
            color: rgba(255,255,255,0.8) !important; 
        }
        /* Forçar fundo transparente no container da tabela e células */
        .table-responsive {
            background: transparent !important;
            background-color: transparent !important;
        }
        body:not(.light-mode) .table-responsive {
            background: transparent !important;
            background-color: transparent !important;
        }
        body:not(.light-mode) .table.table-tech tbody tr,
        body:not(.light-mode) .table.table-tech tbody td {
            background: transparent !important;
            background-color: transparent !important;
        }
        /* Garantir que todas as células tenham texto branco visível */
        body:not(.light-mode) .table.table-tech tbody td,
        body:not(.light-mode) .table.table-tech tbody td * {
            color: #ffffff !important;
        }
        /* Forçar cores no modo escuro */
        body:not(.light-mode) .table-tech tbody td {
            color: #ffffff !important;
            background: transparent !important;
        }
        body:not(.light-mode) .table-tech tbody tr:nth-child(even) {
            background: rgba(255,255,255,0.02) !important;
        }
        body:not(.light-mode) .table-tech tbody tr:nth-child(even):hover {
            background: rgba(102,126,234,0.15) !important;
        }
        .loading-overlay { position: fixed; inset: 0; background: rgba(28,20,65,0.20); display: none; align-items: center; justify-content: center; z-index: 1050; }
        .spinner { width: 40px; height: 40px; border: 4px solid #dbeafe; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @media (max-width:1020px){ .dashboard-row,.charts-row{flex-direction:column;gap:1.3rem;} }
        /* Botões futurísticos e toggle de tema */
        .btn-futuristic { background: linear-gradient(135deg, var(--primary), var(--secondary)); border: none; border-radius: 50px; padding: 0.75rem 1.2rem; font-weight: 600; color: #fff; transition: var(--transition); position: relative; overflow: hidden; }
        .btn-futuristic:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(102,126,234,0.35); }
        .theme-toggle { background: var(--glass); border: 1px solid var(--glass-border); border-radius: 50px; padding: 8px 14px; color: var(--text-primary); transition: var(--transition); backdrop-filter: blur(10px); }
        .theme-toggle:hover { background: rgba(102,126,234,0.20); box-shadow: 0 0 18px rgba(102, 126, 234, 0.28); transform: translateY(-1px); }
        /* Cabeçalho de cards */
        .card-header-futuristic { 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            border-radius: var(--border-radius) var(--border-radius) 0 0; 
            padding: 0.75rem 1rem; 
            border: none; 
            position: relative; 
            overflow: hidden;
            flex-shrink: 0;
            min-height: 45px;
        }
        .card-header-futuristic h5 { 
            color: #fff; 
            margin: 0; 
            font-weight: 700; 
            font-size: 0.95rem; 
            line-height: 1.4;
            position: relative;
            z-index: 2;
            text-shadow: 0 1px 3px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
        }
        .card-header-futuristic h5 i {
            filter: drop-shadow(0 0 4px rgba(255,255,255,0.5));
        }
        .card-header-futuristic::before { 
            content: ''; 
            position: absolute; 
            inset: 0; 
            background: linear-gradient(45deg, transparent 30%, rgba(255,255,255,0.15) 50%, transparent 70%); 
            animation: shimmer 3s infinite; 
            z-index: 1;
        }
        .card-header-futuristic::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 50% 0%, rgba(255,255,255,0.1) 0%, transparent 70%);
            z-index: 1;
        }
        @keyframes shimmer { 
            0% { transform: translateX(-100%); } 
            100% { transform: translateX(100%); } 
        }
        /* Light mode overrides */
        body.light-mode { color: #0f0f23; background: linear-gradient(135deg, #eef2ff 0%, #f8fafc 60%, #ffffff 100%); }
        body.light-mode .navbar { background: rgba(255,255,255,0.85); border-bottom: 1px solid rgba(0,0,0,0.08); }
        body.light-mode .navbar-brand { -webkit-text-fill-color: initial; background: linear-gradient(135deg, #4f46e5, #a855f7); -webkit-background-clip: text; background-clip: text; }
        body.light-mode .card-futuristic, body.light-mode .metric-card, body.light-mode .filter-card { background: rgba(255,255,255,0.75); border: 1px solid rgba(0,0,0,0.08); box-shadow: 0 8px 26px rgba(0,0,0,0.10); }
        body.light-mode .metric-label, body.light-mode .form-label { color: #334155; }
        /* Corrigir metric-value no tema claro - remover transparência e usar cor sólida */
        body.light-mode .metric-value { 
            -webkit-text-fill-color: #4f46e5 !important; 
            background: linear-gradient(135deg, #4f46e5, #a855f7) !important;
            -webkit-background-clip: text !important;
            background-clip: text !important;
            color: #4f46e5 !important;
        }
        /* Corrigir card-header no tema claro */
        body.light-mode .card-header-futuristic h5 { color: #fff !important; }
        body.light-mode .card-header-futuristic { background: linear-gradient(135deg, #4f46e5, #764ba2) !important; }
        /* Corrigir textos gerais no tema claro */
        body.light-mode, body.light-mode * { color: #0f172a; }
        body.light-mode .table-tech thead th { background: #eef2ff; color: #0f172a !important; border-bottom: 2px solid rgba(79,70,229,0.2); }
        body.light-mode .table-tech td, body.light-mode .table-tech th { color: #0f172a !important; border-bottom: 1px solid rgba(0,0,0,0.08); }
        body.light-mode .table-tech tbody tr:hover { background: rgba(239,246,255,0.8); }
        body.light-mode .table-tech .text-muted { color: #64748b !important; }
        body.light-mode .form-select, body.light-mode .form-control { background: rgba(255,255,255,0.95); color: #0f172a; border: 1px solid rgba(0,0,0,0.12); }
        /* Corrigir selects no modo escuro */
        .form-select option, .form-control option { background: #1a1a2e; color: #fff; }
        body.light-mode .form-select option, body.light-mode .form-control option { background: #fff; color: #0f172a; }
        /* Input date no modo escuro */
        input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(1); cursor: pointer; }
        body.light-mode input[type="date"]::-webkit-calendar-picker-indicator { filter: invert(0); }
        body.light-mode .nav-tabs .nav-link { color: #334155; background: rgba(0,0,0,0.04); }
        body.light-mode .nav-tabs .nav-link.active { color: #4f46e5; border-bottom-color: #a855f7; background: linear-gradient(90deg, #e0e7ff, #f3e8ff, #fdf4ff); }
        body.light-mode .theme-toggle { color: #0f172a; background: rgba(255,255,255,0.8); border: 1px solid rgba(0,0,0,0.08); }
        
        /* Light mode - BI de Coletas (visual tecnológico) */
        body.light-mode #abaColetas .bi-coletas-hero {
            background: linear-gradient(135deg, #0e7490 0%, #06b6d4 40%, #6366f1 80%, #8b5cf6 100%);
            border-color: rgba(6, 182, 212, 0.4);
            box-shadow: 0 8px 40px rgba(6, 182, 212, 0.25), inset 0 1px 0 rgba(255,255,255,0.2);
        }
        body.light-mode .bi-kpi-card {
            background: linear-gradient(145deg, rgba(255,255,255,0.95) 0%, rgba(248,250,252,0.98) 100%);
            border-color: rgba(6, 182, 212, 0.25);
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
        }
        body.light-mode .bi-kpi-card:hover {
            border-color: rgba(6, 182, 212, 0.5);
            box-shadow: 0 8px 28px rgba(6, 182, 212, 0.15);
        }
        body.light-mode .bi-kpi-value { color: #0f172a; }
        body.light-mode .bi-kpi-label { color: rgba(15, 23, 42, 0.65); }
        body.light-mode .bi-kpi-label i { color: #0891b2; }
        body.light-mode .bi-kpi-card--highlight {
            border-color: rgba(34, 197, 94, 0.35);
            background: linear-gradient(145deg, rgba(34, 197, 94, 0.08) 0%, rgba(255,255,255,0.95) 100%);
        }
        body.light-mode .bi-kpi-card--highlight .bi-kpi-value {
            background: linear-gradient(135deg, #059669, #10b981);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        body.light-mode .bi-coletas-section-title { color: #0f172a; }
        body.light-mode .bi-coletas-section-title i { color: #0891b2; }
        body.light-mode #abaColetas .bi-coletas-filter,
        body.light-mode #abaColetas .filter-card.bi-coletas-filter {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(6, 182, 212, 0.2);
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
        }
        body.light-mode #abaColetas .bi-coletas-filter .form-label,
        body.light-mode #abaColetas .filter-card.bi-coletas-filter .form-label { color: #334155; }
        body.light-mode #abaColetas .bi-coletas-filter .form-select,
        body.light-mode #abaColetas .bi-coletas-filter .form-control {
            background: #fff;
            color: #0f172a;
            border: 1px solid rgba(0,0,0,0.12);
        }
        body.light-mode #abaColetas .card-futuristic {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(6, 182, 212, 0.2);
            box-shadow: 0 4px 20px rgba(0,0,0,0.06);
        }
        body.light-mode #abaColetas .card-futuristic:hover {
            border-color: rgba(6, 182, 212, 0.4);
            box-shadow: 0 8px 32px rgba(6, 182, 212, 0.12);
        }
        body.light-mode #abaColetas .card-header-futuristic {
            background: linear-gradient(135deg, #0e7490 0%, #06b6d4 50%, #6366f1 100%);
        }
        body.light-mode #abaColetas .card-header-futuristic h5 { color: #fff; }
        body.light-mode #abaColetas .chart-hint { color: #64748b; }
        body.light-mode .bi-coletas-table-card {
            background: rgba(255,255,255,0.95);
            border-color: rgba(6, 182, 212, 0.2);
        }
        body.light-mode #abaColetas .metric-card {
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid rgba(0, 0, 0, 0.08);
        }
        body.light-mode #abaColetas .metric-value {
            background: linear-gradient(135deg, #1e293b 0%, #475569 100%);
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        body.light-mode #abaColetas .metric-label { color: rgba(15, 23, 42, 0.65); }
        
        /* Corrigir textos dentro de cards e containers */
        body.light-mode .card-body, body.light-mode .card-body * { color: #0f172a !important; }
        body.light-mode .p-3, body.light-mode .p-4, body.light-mode .p-5 { color: #0f172a !important; }
        body.light-mode .text-muted { color: #64748b !important; }
        body.light-mode .alert { color: #0f172a !important; }
        body.light-mode .alert-info { background: rgba(59, 130, 246, 0.1) !important; border-left-color: #3b82f6 !important; color: #0f172a !important; }
        body.light-mode .badge { color: #0f172a !important; }
        body.light-mode h5, body.light-mode h6 { color: #0f172a !important; }
        body.light-mode ul, body.light-mode li { color: #0f172a !important; }
        body.light-mode span { color: inherit; }
        /* Corrigir loading overlay no tema claro */
        body.light-mode .loading-overlay { background: rgba(255,255,255,0.85) !important; }
        body.light-mode .loading-text { color: #0f172a !important; }
        /* Corrigir ícones e elementos com cor branca */
        body.light-mode .fas, body.light-mode .far, body.light-mode .fab { color: inherit; }
        body.light-mode .text-success { color: #059669 !important; }
        body.light-mode .text-danger { color: #dc2626 !important; }
        body.light-mode .text-warning { color: #d97706 !important; }
        body.light-mode .text-info { color: #0284c7 !important; }
    </style>
</head>
<body>
    <div class="light-effect"></div>
    <div class="light-effect"></div>
    <div class="light-effect"></div>
    <div id="particles-js"></div>
    <nav class="navbar navbar-expand-lg">
        <div class="container d-flex justify-content-between align-items-center">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <i class="fas fa-chart-bar me-2"></i> Relatórios Inteligentes
            </a>
            <div class="d-flex align-items-center gap-2">
                <a href="portal.html" class="btn btn-futuristic"><i class="fas fa-arrow-left me-2"></i>Voltar ao Portal</a>
                <button class="theme-toggle" id="themeToggle" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
            </div>
        </div>
    </nav>
    <div class="main-container">
    <div class="container">
            <ul class="nav nav-tabs" id="tabsRelatorios">
                <li class="nav-item"><button class="nav-link active" id="tabColetas" onclick="mostrarAba('coletas')">Coletas</button></li>
                <li class="nav-item"><button class="nav-link" id="tabBI" onclick="mostrarAba('bi')">BI Disparos</button></li>
				<li class="nav-item"><button class="nav-link" id="tabCadastros" onclick="mostrarAba('cadastros')">Cadastros</button></li>
                <li class="nav-item"><button class="nav-link" id="tabBIGestao" onclick="mostrarAba('bi-gestao')">BI Gestão de Dados</button></li>
            </ul>
            <div id="abaColetas" style="display:none" class="bi-coletas-aba">
                <div class="bi-coletas-hero">
                    <div>
                        <h2><i class="fas fa-chart-line"></i> BI de Coletas</h2>
                        <span class="bi-coletas-sub">Pipeline, conversão e performance em tempo real</span>
                    </div>
                    <div class="bi-coletas-hero-badge d-none d-md-flex">
                        <span class="bi-live-dot"></span>
                        <span>Dados ao vivo</span>
                    </div>
                </div>

                <section class="bi-coletas-section">
                    <h3 class="bi-coletas-section-title"><i class="fas fa-tachometer-alt"></i> Resumo</h3>
                    <div class="bi-coletas-kpis">
                        <div class="bi-kpi-card">
                            <div class="bi-kpi-value" id="totalColetas">0</div>
                            <div class="bi-kpi-label"><i class="fas fa-box"></i> Total</div>
                        </div>
                        <div class="bi-kpi-card">
                            <div class="bi-kpi-value" id="emAndamento">0</div>
                            <div class="bi-kpi-label"><i class="fas fa-clock"></i> Em andamento</div>
                        </div>
                        <div class="bi-kpi-card">
                            <div class="bi-kpi-value" id="concluidas">0</div>
                            <div class="bi-kpi-label"><i class="fas fa-check-circle"></i> Concluídas</div>
                        </div>
                        <div class="bi-kpi-card">
                            <div class="bi-kpi-value" id="canceladas">0</div>
                            <div class="bi-kpi-label"><i class="fas fa-times-circle"></i> Canceladas</div>
                        </div>
                        <div class="bi-kpi-card bi-kpi-card--highlight">
                            <div class="bi-kpi-value" id="valorTotal">R$ 0</div>
                            <div class="bi-kpi-label"><i class="fas fa-dollar-sign"></i> Valor total</div>
                        </div>
                        <div class="bi-kpi-card">
                            <div class="bi-kpi-value" id="valorMedio">R$ 0</div>
                            <div class="bi-kpi-label"><i class="fas fa-chart-line"></i> Valor médio</div>
                        </div>
                        <div class="bi-kpi-card">
                            <div class="bi-kpi-value" id="kmTotal">0 km</div>
                            <div class="bi-kpi-label"><i class="fas fa-route"></i> KM total</div>
                        </div>
                        <div class="bi-kpi-card">
                            <div class="bi-kpi-value" id="kmMedio">0 km</div>
                            <div class="bi-kpi-label"><i class="fas fa-tachometer-alt"></i> KM médio</div>
                        </div>
                        <div class="bi-kpi-card">
                            <div class="bi-kpi-value" id="ganhou">0</div>
                            <div class="bi-kpi-label"><i class="fas fa-trophy"></i> Ganhou</div>
                        </div>
                        <div class="bi-kpi-card">
                            <div class="bi-kpi-value" id="perdeu">0</div>
                            <div class="bi-kpi-label"><i class="fas fa-times"></i> Perdeu</div>
                        </div>
                        <div class="bi-kpi-card">
                            <div class="bi-kpi-value" id="comMotorista">0</div>
                            <div class="bi-kpi-label"><i class="fas fa-user-tie"></i> Com motorista</div>
                        </div>
                        <div class="bi-kpi-card">
                            <div class="bi-kpi-value" id="semMotorista">0</div>
                            <div class="bi-kpi-label"><i class="fas fa-user-slash"></i> Sem motorista</div>
                        </div>
                    </div>
                </section>

                <section class="bi-coletas-section">
                    <h3 class="bi-coletas-section-title"><i class="fas fa-filter"></i> Filtros</h3>
                <div class="filter-card bi-coletas-filter">
            <div class="row">
                        <div class="col-md-4 mb-2">
                    <label class="form-label"><i class="fas fa-calendar"></i> Período</label>
                            <select id="filtroPeriodo" class="form-select" onchange="atualizarVisibilidadeDatasColetas(); aplicarFiltros();">
                                <option value="todos" selected>Todos</option>
                        <option value="hoje">Hoje</option>
                                <option value="semana">Últimos 7 dias</option>
                                <option value="mes">Últimos 30 dias</option>
                                <option value="trimestre">Últimos 90 dias</option>
                                <option value="ano">Último ano</option>
                                <option value="personalizado">Personalizado</option>
                    </select>
                </div>
                        <div class="col-md-4 mb-2" id="containerDataInicioColetas" style="display:none;">
                            <label class="form-label"><i class="fas fa-calendar-check"></i> Data Início</label>
                            <input type="date" id="filtroDataInicioColetas" class="form-control" onchange="if(document.getElementById('filtroPeriodo').value==='personalizado') aplicarFiltros();">
                        </div>
                        <div class="col-md-4 mb-2" id="containerDataFimColetas" style="display:none;">
                            <label class="form-label"><i class="fas fa-calendar-check"></i> Data Fim</label>
                            <input type="date" id="filtroDataFimColetas" class="form-control" onchange="if(document.getElementById('filtroPeriodo').value==='personalizado') aplicarFiltros();">
                        </div>
                        <div class="col-md-4 mb-2">
                    <label class="form-label"><i class="fas fa-user"></i> Usuário</label>
                            <select id="filtroUsuario" class="form-select" onchange="aplicarFiltros()">
                        <option value="">Todos os usuários</option>
                    </select>
                </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label"><i class="fas fa-building"></i> Filial</label>
                            <select id="filtroFilial" class="form-select" onchange="aplicarFiltros()">
                                <option value="">Todas as filiais</option>
                            </select>
                </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label"><i class="fas fa-handshake"></i> Cliente</label>
                            <select id="filtroCliente" class="form-select" onchange="aplicarFiltros()">
                                <option value="">Todos os clientes</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label"><i class="fas fa-truck"></i> Tipo de Veículo</label>
                            <select id="filtroTipoVeiculo" class="form-select" onchange="aplicarFiltros()">
                                <option value="">Todos os tipos</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label"><i class="fas fa-box"></i> Tipo de Carroceria</label>
                            <select id="filtroTipoCarroceria" class="form-select" onchange="aplicarFiltros()">
                                <option value="">Todos os tipos</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label"><i class="fas fa-search"></i> Coleta específica</label>
                            <input type="text" id="filtroColetaEspecifica" class="form-control" placeholder="Ex: Filial #123, cliente ou número..."
                                onchange="aplicarFiltros()" onkeypress="if(event.key==='Enter'){ event.preventDefault(); aplicarFiltros(); }" title="Buscar análise de uma coleta por identificação (Filial #Número), cliente ou número da coleta">
                        </div>
                        <div class="col-12 mt-2 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-light btn-sm" onclick="limparFiltrosColetas();" title="Limpar todos os filtros e recarregar">
                                <i class="fas fa-eraser me-1"></i> Limpar filtros
                            </button>
                        </div>
                    </div>
                </div>
                </section>

                <!-- Gráficos: mesmo padrão do BI Gestão de Dados (card + chart-container + hint) -->
                <div class="charts-row">
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-chart-pie"></i> Distribuição por Status</h5></div>
                        <div class="chart-container"><canvas id="chartStatus"></canvas></div>
                        <small class="text-muted d-block text-center mt-2" style="padding: 0 1rem;"><i class="fas fa-mouse-pointer"></i> Clique em um segmento para ver detalhes</small>
                    </div>
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-chart-bar"></i> Coletas por Mês</h5></div>
                        <div class="chart-container"><canvas id="chartMensal"></canvas></div>
                        <small class="text-muted d-block text-center mt-2" style="padding: 0 1rem;"><i class="fas fa-mouse-pointer"></i> Clique em uma barra para ver detalhes</small>
                    </div>
                </div>
                <div class="charts-row">
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-users"></i> Performance por Usuário</h5></div>
                        <div class="chart-container"><canvas id="chartUsuarios"></canvas></div>
                        <small class="text-muted d-block text-center mt-2" style="padding: 0 1rem;"><i class="fas fa-mouse-pointer"></i> Clique em uma barra para ver detalhes</small>
                    </div>
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-priority-high"></i> Por Prioridade</h5></div>
                        <div class="chart-container"><canvas id="chartPrioridade"></canvas></div>
                        <small class="text-muted d-block text-center mt-2" style="padding: 0 1rem;"><i class="fas fa-mouse-pointer"></i> Clique em um segmento para ver detalhes</small>
                    </div>
                </div>
                <div class="charts-row">
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-building"></i> Por Filial</h5></div>
                        <div class="chart-container"><canvas id="chartFilial"></canvas></div>
                        <small class="text-muted d-block text-center mt-2" style="padding: 0 1rem;"><i class="fas fa-mouse-pointer"></i> Clique em uma barra para ver detalhes</small>
                    </div>
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-handshake"></i> Top 10 Clientes</h5></div>
                        <div class="chart-container"><canvas id="chartClientes"></canvas></div>
                        <small class="text-muted d-block text-center mt-2" style="padding: 0 1rem;"><i class="fas fa-mouse-pointer"></i> Clique em uma barra para ver detalhes</small>
                    </div>
                </div>
                <div class="charts-row">
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-stream"></i> Pipeline por Etapa</h5></div>
                        <div class="chart-container"><canvas id="chartEtapas"></canvas></div>
                        <small class="text-muted d-block text-center mt-2" style="padding: 0 1rem;"><i class="fas fa-mouse-pointer"></i> Clique em uma barra para ver detalhes</small>
                    </div>
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-clock"></i> Tempo médio por etapa</h5></div>
                        <div class="chart-container"><canvas id="chartTempoPorEtapa"></canvas></div>
                        <small class="text-muted d-block text-center mt-2" style="padding: 0 1rem;"><i class="fas fa-mouse-pointer"></i> Clique em uma barra para ver detalhes</small>
                    </div>
                </div>
                <div class="charts-row">
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-truck"></i> Tipos de Veículo</h5></div>
                        <div class="chart-container"><canvas id="chartTiposVeiculo"></canvas></div>
                        <small class="text-muted d-block text-center mt-2" style="padding: 0 1rem;"><i class="fas fa-mouse-pointer"></i> Clique em um segmento para ver detalhes</small>
                    </div>
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-box"></i> Tipos de Carroceria</h5></div>
                        <div class="chart-container"><canvas id="chartTiposCarroceria"></canvas></div>
                        <small class="text-muted d-block text-center mt-2" style="padding: 0 1rem;"><i class="fas fa-mouse-pointer"></i> Clique em um segmento para ver detalhes</small>
                    </div>
                </div>
                <div class="charts-row">
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-trophy"></i> Resultado Final</h5></div>
                        <div class="chart-container"><canvas id="chartResultadoFinal"></canvas></div>
                        <small class="text-muted d-block text-center mt-2" style="padding: 0 1rem;"><i class="fas fa-mouse-pointer"></i> Clique em um segmento para ver detalhes</small>
                    </div>
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-map-marked-alt"></i> Top 10 Rotas (Origem → Destino)</h5></div>
                        <div class="chart-container"><canvas id="chartRotas"></canvas></div>
                        <small class="text-muted d-block text-center mt-2" style="padding: 0 1rem;"><i class="fas fa-mouse-pointer"></i> Clique em uma barra para ver detalhes</small>
                    </div>
                </div>
                <div class="charts-row">
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-calendar-alt"></i> Evolução de Valores por Mês</h5></div>
                        <div class="chart-container"><canvas id="chartValoresMensal"></canvas></div>
                        <small class="text-muted d-block text-center mt-2" style="padding: 0 1rem;"><i class="fas fa-mouse-pointer"></i> Clique em um ponto para ver detalhes</small>
                    </div>
                </div>

                <section class="bi-coletas-section">
                    <h3 class="bi-coletas-section-title"><i class="fas fa-table"></i> Relatório Detalhado</h3>
                <div class="card-futuristic bi-coletas-table-card">
                    <div class="card-header-futuristic d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <h5 class="mb-0"><i class="fas fa-table me-2"></i>Relatório Detalhado</h5>
                        <button type="button" class="btn btn-sm btn-outline-light" onclick="exportarColetasCSV();" title="Exportar CSV">
                            <i class="fas fa-file-csv me-1"></i> Exportar CSV
                        </button>
                    </div>
            <div class="table-responsive p-3">
                <table class="table table-tech">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Cliente</th>
                            <th>Origem → Destino</th>
                            <th>Status</th>
                            <th>Etapa</th>
                            <th>Valor</th>
                            <th>Resultado</th>
                            <th>Data</th>
                        </tr>
                    </thead>
                    <tbody id="tabelaRelatorio">
                        <tr><td colspan="8" class="text-center text-muted py-4">Carregando dados...</td></tr>
                    </tbody>
                </table>
            </div>
                </div>
                </section>
                <div class="dashboard-row">
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="tempoMedio">0</div>
                        <div class="metric-label"><i class="fas fa-clock"></i> Tempo Médio (dias)</div>
                </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="taxaSucesso">0%</div>
                        <div class="metric-label"><i class="fas fa-percentage"></i> Taxa de Sucesso</div>
            </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="tempoCicloMedio">0 dias</div>
                        <div class="metric-label"><i class="fas fa-sync-alt"></i> Ciclo Médio (Coleta→Entrega)</div>
                </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="taxaConversao">0%</div>
                        <div class="metric-label"><i class="fas fa-chart-line"></i> Taxa Conversão (Ganhou)</div>
            </div>
                </div>
            </div>
            <div id="abaBI" style="display:none">
                <div class="dashboard-row">
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="kpiTotalDisp">0</div>
                        <div class="metric-label"><i class="fas fa-paper-plane"></i> Total de Disparos</div>
                </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="kpiUsuariosDisp">0</div>
                        <div class="metric-label"><i class="fas fa-users"></i> Usuários Enviando</div>
            </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="kpiDepartamentosDisp">0</div>
                        <div class="metric-label"><i class="fas fa-building"></i> Departamentos Ativos</div>
        </div>
                    </div>
                <div class="filter-card">
                    <div class="row">
                        <div class="col-md-2 mb-2">
                            <label class="form-label"><i class="fas fa-calendar"></i> Período</label>
                            <select id="filtroPeriodoDisp" class="form-select" onchange="atualizarVisibilidadeDatasDisp(); carregarDisparos();">
                                <option value="hoje">Hoje</option>
                                <option value="mes" selected>Este Mês</option>
                                <option value="ano">Este Ano</option>
                                <option value="todos">Todos</option>
                                <option value="personalizado">Personalizado</option>
                            </select>
                    </div>
                        <div class="col-md-2 mb-2" id="containerDataInicioDisp" style="display:none;">
                            <label class="form-label"><i class="fas fa-calendar-alt"></i> Data Início</label>
                            <input type="date" id="filtroDataInicioDisp" class="form-control" onchange="if(document.getElementById('filtroPeriodoDisp').value==='personalizado') carregarDisparos();">
                        </div>
                        <div class="col-md-2 mb-2" id="containerDataFimDisp" style="display:none;">
                            <label class="form-label"><i class="fas fa-calendar-check"></i> Data Fim</label>
                            <input type="date" id="filtroDataFimDisp" class="form-control" onchange="if(document.getElementById('filtroPeriodoDisp').value==='personalizado') carregarDisparos();">
                        </div>
                        <div class="col-md-3 mb-2" id="containerUsuarioDisp">
                            <label class="form-label"><i class="fas fa-user"></i> Usuário</label>
                            <select id="filtroUsuarioDisp" class="form-select" onchange="carregarDisparos()">
                                <option value="">Todos os usuários</option>
                            </select>
                </div>
                        <div class="col-md-3 mb-2" id="containerDepartamentoDisp">
                            <label class="form-label"><i class="fas fa-building"></i> Departamento</label>
                            <select id="filtroDepartamentoDisp" class="form-select" onchange="carregarDisparos()">
                                <option value="">Todos os departamentos</option>
                            </select>
            </div>
                    </div>
                    </div>
                <div class="charts-row">
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-user"></i> Disparos por Usuário</h5></div>
                        <div class="chart-container"><canvas id="chartUsuarioDisp"></canvas></div>
                </div>
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-building"></i> Disparos por Departamento</h5></div>
                        <div class="chart-container"><canvas id="chartDepartamentoDisp"></canvas></div>
            </div>
        </div>
                <div class="charts-row">
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-calendar"></i> Disparos por Período</h5></div>
                        <div class="chart-container"><canvas id="chartTemporalDisp"></canvas></div>
                    </div>
                </div>
                <div class="motoristas-falhas-section">
                    <div class="card-futuristic" style="margin-top: 0;">
                        <div class="card-header-futuristic">
                            <h5><i class="fas fa-exclamation-triangle me-2"></i>Motoristas com Falhas nos Disparos</h5>
                        </div>
                        <div class="p-4" style="padding-top: 1.5rem;">
                            <div class="dashboard-row" style="margin-top:0;">
                                <div class="metric-card card-futuristic">
                                    <div class="metric-value" id="statTotalFalhas">0</div>
                                    <div class="metric-label"><i class="fas fa-exclamation-triangle"></i> Total de Falhas</div>
                                </div>
                                <div class="metric-card card-futuristic">
                                    <div class="metric-value" id="statMotoristasUnicos">0</div>
                                    <div class="metric-label"><i class="fas fa-users"></i> Motoristas Únicos</div>
                                </div>
                                <div class="metric-card card-futuristic">
                                    <div class="metric-value" id="statFalhasUltimos7Dias">0</div>
                                    <div class="metric-label"><i class="fas fa-calendar-week"></i> Últimos 7 Dias</div>
                                </div>
                                <div class="metric-card card-futuristic">
                                    <div class="metric-value" id="statTaxaErroFalhas">0%</div>
                                    <div class="metric-label"><i class="fas fa-percentage"></i> Taxa de Erro</div>
                                </div>
                            </div>
                            <div class="alert alert-info mb-4" style="background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; color: var(--text-primary); border-radius: 10px; padding: 1rem 1.25rem;">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Registro de Falhas:</strong> Esta visão resume os números com problemas nos disparos. Clique abaixo para abrir o painel completo de correções.
                            </div>
                            <div class="row g-4 mb-4">
                                <div class="col-md-6">
                                    <div class="card-futuristic p-4" style="height: 100%;">
                                        <h6 class="mb-3" style="color: var(--text-primary); font-weight: 700;"><i class="fas fa-list-check me-2"></i>Funcionalidades</h6>
                                        <ul style="list-style: none; padding: 0; color: var(--text-secondary);">
                                            <li class="mb-3"><i class="fas fa-check-circle text-success me-2"></i>Visualizar todas as falhas de disparo</li>
                                            <li class="mb-3"><i class="fas fa-check-circle text-success me-2"></i>Filtrar por período, número ou nome</li>
                                            <li class="mb-3"><i class="fas fa-check-circle text-success me-2"></i>Editar telefones diretamente</li>
                                            <li class="mb-3"><i class="fas fa-check-circle text-success me-2"></i>Estatísticas em tempo real</li>
                                            <li class="mb-3"><i class="fas fa-check-circle text-success me-2"></i>Identificar motoristas não encontrados</li>
                                            <li class="mb-0"><i class="fas fa-check-circle text-success me-2"></i>Análise detalhada por motivo da falha</li>
                                        </ul>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card-futuristic p-4" style="height: 100%;">
                                        <h6 class="mb-3" style="color: var(--text-primary); font-weight: 700;"><i class="fas fa-chart-bar me-2"></i>Análise Rápida</h6>
                                        <div class="mb-3">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span style="color: var(--text-secondary); font-size: 0.9rem;">Falhas por Motivo</span>
                                                <span class="badge" style="background: rgba(102, 126, 234, 0.2); color: var(--primary);" id="badgeMotivosFalhas">Carregando...</span>
                                            </div>
                                            <div class="progress" style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden;">
                                                <div class="progress-bar" role="progressbar" style="width: 0%; background: linear-gradient(90deg, var(--primary), var(--accent));" id="progressFalhas"></div>
                                            </div>
                                        </div>
                                        <div class="mt-4">
                                            <div class="d-flex justify-content-between align-items-center mb-2">
                                                <span style="color: var(--text-secondary); font-size: 0.9rem;">Última Atualização</span>
                                                <span style="color: var(--text-secondary); font-size: 0.85rem;" id="ultimaAtualizacaoFalhas">-</span>
                                            </div>
                                            <a href="motoristas-falhas.html" class="btn btn-futuristic w-100" target="_blank" style="margin-top: 0.5rem;">
                                                <i class="fas fa-external-link-alt me-2"></i>Abrir Página Completa
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div id="abaCadastros" style="display:none">
				<div class="dashboard-row">
					<div class="metric-card card-futuristic">
						<div class="metric-value" id="kpiTotalMot">0</div>
						<div class="metric-label"><i class="fas fa-id-card"></i> Total de Cadastros</div>
					</div>
					<div class="metric-card card-futuristic">
						<div class="metric-value" id="kpiUsuariosMot">0</div>
						<div class="metric-label"><i class="fas fa-users"></i> Usuários Cadastrando</div>
					</div>
					<div class="metric-card card-futuristic">
						<div class="metric-value" id="kpiDepartamentosMot">0</div>
						<div class="metric-label"><i class="fas fa-building"></i> Departamentos Ativos</div>
					</div>
				</div>
				<div class="filter-card">
					<div class="row">
						<div class="col-md-2 mb-2">
							<label class="form-label"><i class="fas fa-calendar"></i> Período</label>
							<select id="filtroPeriodoMot" class="form-select" onchange="atualizarVisibilidadeDatasMot(); carregarMotoristas();">
								<option value="hoje">Hoje</option>
								<option value="mes" selected>Este Mês</option>
								<option value="ano">Este Ano</option>
								<option value="todos">Todos</option>
								<option value="personalizado">Personalizado</option>
							</select>
						</div>
						<div class="col-md-2 mb-2" id="containerDataInicioMot" style="display:none;">
							<label class="form-label"><i class="fas fa-calendar-alt"></i> Data Início</label>
							<input type="date" id="filtroDataInicioMot" class="form-control" onchange="if(document.getElementById('filtroPeriodoMot').value==='personalizado') carregarMotoristas();">
						</div>
						<div class="col-md-2 mb-2" id="containerDataFimMot" style="display:none;">
							<label class="form-label"><i class="fas fa-calendar-check"></i> Data Fim</label>
							<input type="date" id="filtroDataFimMot" class="form-control" onchange="if(document.getElementById('filtroPeriodoMot').value==='personalizado') carregarMotoristas();">
						</div>
                        <div class="col-md-3 mb-2" id="containerUsuarioMot">
							<label class="form-label"><i class="fas fa-user"></i> Usuário</label>
							<select id="filtroUsuarioMot" class="form-select" onchange="carregarMotoristas()">
								<option value="">Todos os usuários</option>
							</select>
						</div>
                        <div class="col-md-3 mb-2" id="containerDepartamentoMot">
							<label class="form-label"><i class="fas fa-building"></i> Departamento</label>
							<select id="filtroDepartamentoMot" class="form-select" onchange="carregarMotoristas()">
								<option value="">Todos os departamentos</option>
							</select>
						</div>
					</div>
				</div>
				<div class="charts-row">
					<div class="card-futuristic">
						<div class="card-header-futuristic"><h5><i class="fas fa-user"></i> Cadastros por Usuário</h5></div>
						<div class="chart-container"><canvas id="chartUsuarioMot"></canvas></div>
					</div>
					<div class="card-futuristic">
						<div class="card-header-futuristic"><h5><i class="fas fa-building"></i> Cadastros por Departamento</h5></div>
						<div class="chart-container"><canvas id="chartDepartamentoMot"></canvas></div>
					</div>
				</div>
				<div class="charts-row">
					<div class="card-futuristic">
						<div class="card-header-futuristic"><h5><i class="fas fa-calendar"></i> Cadastros por Período</h5></div>
						<div class="chart-container"><canvas id="chartTemporalMot"></canvas></div>
					</div>
                    </div>
                </div>
            </div>
            
            <!-- ABA BI GESTÃO DE DADOS -->
            <div id="abaBIGestao" style="display:none">
                <div class="bi-gestao-hero">
                    <div>
                        <h2><i class="fas fa-database"></i> BI Gestão de Dados</h2>
                        <span class="bi-gestao-sub">Auditoria de lançamentos · Tipos de erro, operações e evolução temporal</span>
                    </div>
                    <div class="d-none d-md-flex align-items-center gap-2" style="color: rgba(255,255,255,0.9); position: relative; z-index: 1;">
                        <span class="bi-live-dot"></span>
                        <span style="font-size: 0.85rem;">Dados em tempo real</span>
                    </div>
                </div>
                <div class="dashboard-row" style="margin-top: 0;">
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="totalLancamentosGestao">0</div>
                        <div class="metric-label"><i class="fas fa-database"></i> Total de Lançamentos</div>
                    </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="totalEditadosGestao">0</div>
                        <div class="metric-label"><i class="fas fa-edit"></i> Lançamentos Editados</div>
                    </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="taxaEdicaoGestao">0%</div>
                        <div class="metric-label"><i class="fas fa-percentage"></i> Taxa de Edição</div>
                    </div>
                    <div class="metric-card card-futuristic">
                        <div class="metric-value" id="tempoMedioRespostaGestao">0 min</div>
                        <div class="metric-label"><i class="fas fa-clock"></i> Tempo Médio de Resposta</div>
                    </div>
                </div>
                
                <div class="filter-card">
                    <div class="row">
                        <div class="col-md-4 mb-2">
                            <label class="form-label"><i class="fas fa-calendar"></i> Período</label>
                            <select id="filtroPeriodoGestao" class="form-select" onchange="atualizarVisibilidadeDatasGestao(); carregarBIGestao();">
                                <option value="todos" selected>Todos</option>
                                <option value="hoje">Hoje</option>
                                <option value="semana">Últimos 7 dias</option>
                                <option value="mes">Últimos 30 dias</option>
                                <option value="trimestre">Últimos 90 dias</option>
                                <option value="ano">Último ano</option>
                                <option value="personalizado">Personalizado</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-2" id="containerDataInicioGestao" style="display:none;">
                            <label class="form-label"><i class="fas fa-calendar-check"></i> Data Início</label>
                            <input type="date" id="filtroDataInicioGestao" class="form-control" onchange="if(document.getElementById('filtroPeriodoGestao').value==='personalizado') carregarBIGestao();">
                        </div>
                        <div class="col-md-4 mb-2" id="containerDataFimGestao" style="display:none;">
                            <label class="form-label"><i class="fas fa-calendar-check"></i> Data Fim</label>
                            <input type="date" id="filtroDataFimGestao" class="form-control" onchange="if(document.getElementById('filtroPeriodoGestao').value==='personalizado') carregarBIGestao();">
                        </div>
                        <div class="col-md-4 mb-2">
                            <label class="form-label"><i class="fas fa-building"></i> Operação</label>
                            <select id="filtroOperacaoGestao" class="form-select" onchange="carregarBIGestao();">
                                <option value="">Todas</option>
                                <option value="Jaboatão">Jaboatão</option>
                                <option value="Usinas">Usinas</option>
                                <option value="Paraíba">Paraíba</option>
                                <option value="Alagoas">Alagoas</option>
                                <option value="Bahia">Bahia</option>
                                <option value="Ambev">Ambev</option>
                                <option value="Cabo">Cabo</option>
                                <option value="São paulo">São paulo</option>
                                <option value="Célula de documentação">Célula de documentação</option>
                                <option value="Contas a pagar">Contas a pagar</option>
                                <option value="Controladoria">Controladoria</option>
                                <option value="Price">Price</option>
                                <option value="Ti">Ti</option>
                                <option value="Célula contratação">Célula contratação</option>
                                <option value="Projetos">Projetos</option>
                                <option value="GR">GR</option>
                                <option value="Comercial">Comercial</option>
                                <option value="Customer Service">Customer Service</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <div class="charts-row">
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-exclamation-triangle"></i> Lançamentos por Tipo de Erro</h5></div>
                        <div class="chart-container"><canvas id="chartTipoErroGestao"></canvas></div>
                        <small class="text-muted d-block text-center mt-2" style="padding: 0 1rem;"><i class="fas fa-mouse-pointer"></i> Clique em um segmento para ver detalhes</small>
                    </div>
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-cogs"></i> Lançamentos por Operação</h5></div>
                        <div class="chart-container"><canvas id="chartOperacaoGestao"></canvas></div>
                        <small class="text-muted d-block text-center mt-2" style="padding: 0 1rem;"><i class="fas fa-mouse-pointer"></i> Clique em uma barra para ver detalhes</small>
                    </div>
                </div>
                
                <div class="charts-row">
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-user-tie"></i> Top 10 Responsáveis</h5></div>
                        <div class="chart-container"><canvas id="chartResponsavelGestao"></canvas></div>
                        <small class="text-muted d-block text-center mt-2" style="padding: 0 1rem;"><i class="fas fa-mouse-pointer"></i> Clique em uma barra para ver detalhes</small>
                    </div>
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-calendar"></i> Evolução Temporal</h5></div>
                        <div class="chart-container"><canvas id="chartTemporalGestao"></canvas></div>
                        <small class="text-muted d-block text-center mt-2" style="padding: 0 1rem;"><i class="fas fa-mouse-pointer"></i> Clique em um ponto para ver detalhes</small>
                    </div>
                </div>
                
                <div class="charts-row">
                    <div class="card-futuristic">
                        <div class="card-header-futuristic"><h5><i class="fas fa-sitemap"></i> Árvore de Perdas - Tipos de Erros</h5></div>
                        <div class="chart-container"><canvas id="chartUsuarioGestao"></canvas></div>
                    </div>
                </div>
            </div>
            
    <div id="loadingOverlay" class="loading-overlay" style="display: none;">
        <div class="text-center"><div class="spinner"></div><p class="loading-text">Carregando relatórios...</p></div>
        </div>
    
    <!-- Modal de Detalhes do Tipo de Erro -->
    <div class="modal fade" id="modalDetalhesTipoErro" tabindex="-1" aria-labelledby="modalDetalhesTipoErroLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content" style="background: #ffffff; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-bottom: none; padding: 1.5rem 2rem;">
                    <h5 class="modal-title" id="modalDetalhesTipoErroLabel" style="color: white; font-weight: 700; font-size: 1.25rem;">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="modalTipoErroTitulo">Detalhes do Tipo de Erro</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body" style="background: #f8f9fa; color: #212529; padding: 2rem;">
                    <div id="modalDetalhesConteudo">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="background: #ffffff; border-top: 1px solid #dee2e6; padding: 1rem 2rem;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Detalhes da Operação -->
    <div class="modal fade" id="modalDetalhesOperacao" tabindex="-1" aria-labelledby="modalDetalhesOperacaoLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content" style="background: #ffffff; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-bottom: none; padding: 1.5rem 2rem;">
                    <h5 class="modal-title" id="modalDetalhesOperacaoLabel" style="color: white; font-weight: 700; font-size: 1.25rem;">
                        <i class="fas fa-building me-2"></i>
                        <span id="modalOperacaoTitulo">Detalhes da Operação</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body" style="background: #f8f9fa; color: #212529; padding: 2rem;">
                    <div id="modalDetalhesOperacaoConteudo">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="background: #ffffff; border-top: 1px solid #dee2e6; padding: 1rem 2rem;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Detalhes do Responsável -->
    <div class="modal fade" id="modalDetalhesResponsavel" tabindex="-1" aria-labelledby="modalDetalhesResponsavelLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content" style="background: #ffffff; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                <div class="modal-header" style="background: linear-gradient(135deg, #764ba2 0%, #9b59b6 100%); border-bottom: none; padding: 1.5rem 2rem;">
                    <h5 class="modal-title" id="modalDetalhesResponsavelLabel" style="color: white; font-weight: 700; font-size: 1.25rem;">
                        <i class="fas fa-user-tie me-2"></i>
                        <span id="modalResponsavelTitulo">Detalhes do Responsável</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body" style="background: #f8f9fa; color: #212529; padding: 2rem;">
                    <div id="modalDetalhesResponsavelConteudo">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="background: #ffffff; border-top: 1px solid #dee2e6; padding: 1rem 2rem;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Modal de Detalhes da Data -->
    <div class="modal fade" id="modalDetalhesData" tabindex="-1" aria-labelledby="modalDetalhesDataLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content" style="background: #ffffff; border: none; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                <div class="modal-header" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-bottom: none; padding: 1.5rem 2rem;">
                    <h5 class="modal-title" id="modalDetalhesDataLabel" style="color: white; font-weight: 700; font-size: 1.25rem;">
                        <i class="fas fa-calendar-alt me-2"></i>
                        <span id="modalDataTitulo">Detalhes da Data</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body" style="background: #f8f9fa; color: #212529; padding: 2rem;">
                    <div id="modalDetalhesDataConteudo">
                        <div class="text-center py-5">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Carregando...</span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="background: #ffffff; border-top: 1px solid #dee2e6; padding: 1rem 2rem;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
	<script src="../js/permissions.js"></script>
    <script>
    // Função global para mostrar abas
    window.mostrarAba = function(aba) {
        document.getElementById('tabColetas').classList.toggle('active', aba==='coletas');
        document.getElementById('tabBI').classList.toggle('active', aba==='bi');
		const tabCad = document.getElementById('tabCadastros');
		if(tabCad) tabCad.classList.toggle('active', aba==='cadastros');
        const tabBIGestao = document.getElementById('tabBIGestao');
        if(tabBIGestao) tabBIGestao.classList.toggle('active', aba==='bi-gestao');
        
        // Ocultar todas as abas primeiro para evitar espaçamento
        const abaColetas = document.getElementById('abaColetas');
        const abaBI = document.getElementById('abaBI');
		const abaCad = document.getElementById('abaCadastros');
        const abaBIGestao = document.getElementById('abaBIGestao');
        
        if(abaColetas) abaColetas.style.display = 'none';
        if(abaBI) abaBI.style.display = 'none';
        if(abaCad) abaCad.style.display = 'none';
        if(abaBIGestao) abaBIGestao.style.display = 'none';
        
        // Mostrar apenas a aba selecionada
        if(aba==='coletas' && abaColetas) {
            abaColetas.style.display = '';
            if(typeof atualizarVisibilidadeDatasColetas === 'function') atualizarVisibilidadeDatasColetas();
            // Carregar filtros e dados quando a aba for aberta
            if(typeof carregarFiltrosColetas === 'function') {
                carregarFiltrosColetas().then(() => {
                    if(typeof carregarColetasBI === 'function') carregarColetasBI();
                });
            } else if(typeof carregarColetasBI === 'function') {
                carregarColetasBI();
            }
        }
        if(aba==='bi' && abaBI) abaBI.style.display = '';
        if(aba==='cadastros' && abaCad) abaCad.style.display = '';
        if(aba==='bi-gestao' && abaBIGestao) {
            abaBIGestao.style.display = '';
            if(typeof carregarBIGestao === 'function') {
                if(typeof atualizarVisibilidadeDatasGestao === 'function') atualizarVisibilidadeDatasGestao();
                carregarBIGestao();
            }
        }
        const navTabs = document.getElementById('tabsRelatorios');
        if (navTabs) {
            navTabs.style.marginBottom = '';
        }
        if(aba==='bi' && typeof carregarDisparos==='function' && typeof carregarFiltrosDisparos==='function') {
            // Sempre recarregar filtros e dados para refletir novos logs
            if(typeof atualizarVisibilidadeDatasDisp==='function') atualizarVisibilidadeDatasDisp();
            carregarFiltrosDisparos().then(async () => {
                await carregarDisparos();
                await carregarEstatisticasFalhas().catch(err => console.error('Erro estatísticas falhas:', err));
            });
        }
		if(aba==='cadastros'){
			(async ()=>{
				try{
					const st = await fetch('/api/auth/status', { credentials:'include' });
					if(handleUnauthorized(st)) return;
                    // Sempre recarregar filtros e dados de motoristas
					if(typeof atualizarVisibilidadeDatasMot==='function') atualizarVisibilidadeDatasMot();
                    await carregarFiltrosMotoristas();
                    await carregarMotoristas();
				}catch(e){ console.error('Erro ao carregar Motoristas:', e); }
			})();
		}
    };
    
    // ====== FUNÇÃO AUXILIAR PARA PERÍODOS ======
    function periodoToRange(periodo){
        const now = new Date();
        let inicio = null;
        if(periodo==='hoje'){
            inicio = new Date(now.getFullYear(), now.getMonth(), now.getDate());
        }else if(periodo==='mes'){
            inicio = new Date(now.getFullYear(), now.getMonth(), 1);
        }else if(periodo==='ano'){
            inicio = new Date(now.getFullYear(), 0, 1);
        }
        return { inicio, fim: now };
    }
    
    // ====== ESTATÍSTICAS DE FALHAS ======
    async function carregarEstatisticasFalhas() {
        try {
            const sb = await getSupabaseClientRel();
            if (!sb) {
                document.getElementById('statTotalFalhas').textContent = '0';
                document.getElementById('statMotoristasUnicos').textContent = '0';
                document.getElementById('statFalhasUltimos7Dias').textContent = '0';
                document.getElementById('statTaxaErroFalhas').textContent = '0%';
                return;
            }

            // Obter os mesmos filtros aplicados nos disparos
            const periodo = document.getElementById('filtroPeriodoDisp')?.value || 'mes';
            const usuarioId = document.getElementById('filtroUsuarioDisp')?.value || '';
            const departamento = document.getElementById('filtroDepartamentoDisp')?.value || '';
            
            let range;
            if(periodo === 'personalizado'){
                const dataInicio = document.getElementById('filtroDataInicioDisp')?.value;
                const dataFim = document.getElementById('filtroDataFimDisp')?.value;
                range = {
                    inicio: dataInicio ? new Date(dataInicio + 'T00:00:00') : null,
                    fim: dataFim ? new Date(dataFim + 'T23:59:59') : null
                };
            } else {
                range = periodoToRange(periodo);
            }

            // Construir query com filtros
            let query = sb
                .from('disparos_log')
                .select('numero, created_at, user_id, departamento')
                .eq('status', 'error');
            
            // Aplicar filtro de data
            if (range.inicio) {
                query = query.gte('created_at', range.inicio.toISOString());
            }
            if (range.fim) {
                query = query.lte('created_at', range.fim.toISOString());
            }
            
            // Aplicar filtro de usuário
            if (usuarioId) {
                query = query.eq('user_id', usuarioId);
            }
            
            // Aplicar filtro de departamento
            if (departamento) {
                query = query.eq('departamento', departamento);
            }
            
            const { data: falhas, error } = await query.order('created_at', { ascending: false }).limit(10000);

            if (error) throw error;

            const totalFalhas = falhas ? falhas.length : 0;
            const numerosUnicos = new Set(falhas ? falhas.map(f => f.numero).filter(Boolean) : []);
            const motoristasUnicos = numerosUnicos.size;

            // Falhas dos últimos 7 dias (dentro do período filtrado)
            const seteDiasAtras = new Date();
            seteDiasAtras.setDate(seteDiasAtras.getDate() - 7);
            // Se o período filtrado começar antes de 7 dias atrás, usar o início do período
            const dataLimite = range.inicio && range.inicio > seteDiasAtras ? range.inicio : seteDiasAtras;
            const falhasUltimos7Dias = falhas ? falhas.filter(f => {
                const dataFalha = new Date(f.created_at);
                return dataFalha >= dataLimite;
            }).length : 0;

            // Calcular taxa de erro baseada no período filtrado
            // Buscar total de disparos no período para calcular taxa real
            let totalDisparosPeriodo = totalFalhas; // Por padrão, usar apenas falhas se não conseguir buscar total
            try {
                // Tentar buscar total de disparos no período via API
                const params = new URLSearchParams();
                if (range && range.inicio) {
                    params.append('inicio', range.inicio.toISOString());
                }
                if (range && range.fim) {
                    params.append('fim', range.fim.toISOString());
                }
                if (usuarioId) {
                    params.append('usuarioId', usuarioId);
                }
                if (departamento) {
                    params.append('departamento', departamento);
                }
                
                const totalResp = await fetch(`/api/relatorios/disparos/kpis?${params}`, { credentials:'include' });
                if (totalResp.ok) {
                    const totalData = await totalResp.json();
                    totalDisparosPeriodo = totalData.total || totalFalhas;
                }
            } catch (e) {
                console.warn('Não foi possível buscar total de disparos para calcular taxa:', e);
            }
            
            const taxaErro = totalDisparosPeriodo > 0 ? ((totalFalhas / totalDisparosPeriodo) * 100).toFixed(1) : 0;

            // Agrupar por motivo (simplificado)
            const motivosMap = new Map();
            if (falhas && falhas.length > 0) {
                falhas.forEach(f => {
                    // Análise básica do número
                    const numeroLimpo = (f.numero || '').replace(/\D/g, '');
                    let motivo = 'outro';
                    if (!numeroLimpo || numeroLimpo.length < 10) motivo = 'numero_invalido';
                    else if (!numeroLimpo.startsWith('55')) motivo = 'sem_ddi';
                    else if (numeroLimpo.length > 15) motivo = 'numero_longo';
                    else motivo = 'outro';
                    
                    motivosMap.set(motivo, (motivosMap.get(motivo) || 0) + 1);
                });
            }
            const totalMotivos = Array.from(motivosMap.values()).reduce((a, b) => a + b, 0);
            const maiorMotivo = Array.from(motivosMap.entries()).sort((a, b) => b[1] - a[1])[0];
            const percentualMaiorMotivo = maiorMotivo && totalMotivos > 0 ? ((maiorMotivo[1] / totalMotivos) * 100).toFixed(0) : 0;

            // Atualizar elementos
            document.getElementById('statTotalFalhas').textContent = totalFalhas.toLocaleString('pt-BR');
            document.getElementById('statMotoristasUnicos').textContent = motoristasUnicos.toLocaleString('pt-BR');
            document.getElementById('statFalhasUltimos7Dias').textContent = falhasUltimos7Dias.toLocaleString('pt-BR');
            document.getElementById('statTaxaErroFalhas').textContent = taxaErro + '%';

            // Atualizar badge e progress bar
            const badgeMotivos = document.getElementById('badgeMotivosFalhas');
            const progressFalhas = document.getElementById('progressFalhas');
            if (badgeMotivos && maiorMotivo) {
                const motivoNome = {
                    'numero_invalido': 'Número Inválido',
                    'sem_ddi': 'Sem DDI',
                    'numero_longo': 'Número Longo',
                    'outro': 'Outros'
                }[maiorMotivo[0]] || 'Outros';
                badgeMotivos.textContent = `${motivoNome}: ${percentualMaiorMotivo}%`;
            }
            if (progressFalhas) {
                progressFalhas.style.width = percentualMaiorMotivo + '%';
            }

            // Atualizar última atualização
            const ultimaAtualizacao = document.getElementById('ultimaAtualizacaoFalhas');
            if (ultimaAtualizacao) {
                ultimaAtualizacao.textContent = new Date().toLocaleString('pt-BR', { 
                    day: '2-digit', 
                    month: '2-digit', 
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }

        } catch (error) {
            console.error('Erro ao carregar estatísticas de falhas:', error);
            document.getElementById('statTotalFalhas').textContent = 'Erro';
            document.getElementById('statMotoristasUnicos').textContent = 'Erro';
            document.getElementById('statFalhasUltimos7Dias').textContent = 'Erro';
            document.getElementById('statTaxaErroFalhas').textContent = 'Erro';
        }
    }
    
    function toggleTheme(){
        const body = document.body;
        const themeIcon = document.querySelector('#themeToggle i');
        if(body.classList.contains('light-mode')){
            body.classList.remove('light-mode');
            if(themeIcon) themeIcon.className = 'fas fa-moon';
            localStorage.setItem('theme','dark');
                } else {
            body.classList.add('light-mode');
            if(themeIcon) themeIcon.className = 'fas fa-sun';
            localStorage.setItem('theme','light');
        }
        // Recarregar gráficos para atualizar cores
        const abaAtiva = document.getElementById('abaBI')?.style.display !== 'none' ? 'bi' : 
                         document.getElementById('abaCadastros')?.style.display !== 'none' ? 'cadastros' :
                         document.getElementById('abaBIGestao')?.style.display !== 'none' ? 'bi-gestao' : 'coletas';
        if(abaAtiva === 'bi' && typeof carregarDisparos === 'function') {
            carregarDisparos();
        } else if(abaAtiva === 'cadastros' && typeof carregarMotoristas === 'function') {
            carregarMotoristas();
        } else if(abaAtiva === 'bi-gestao' && typeof carregarBIGestao === 'function') {
            carregarBIGestao();
        }
    }
    document.addEventListener('DOMContentLoaded', ()=>{
        const savedTheme = localStorage.getItem('theme') || 'dark';
        if(savedTheme==='light'){
            document.body.classList.add('light-mode');
            const themeIcon = document.querySelector('#themeToggle i');
            if(themeIcon) themeIcon.className = 'fas fa-sun';
        }
			(async ()=>{
				try{
					if(typeof verificarEAplicarPermissao==='function'){
						const ok = await verificarEAplicarPermissao('relatorios');
						if(!ok) return; // será redirecionado pelo permissions.js
					}
					mostrarAba('coletas');
				}catch(e){
					console.error('Erro ao verificar permissão para relatórios:', e);
					// fallback: ainda mostra aba coletas (não exige chamadas protegidas imediatamente)
        mostrarAba('coletas');
				}
			})();
		});

	// ====== SUPABASE (reutiliza endpoint backend para config) ======
	let _sbClient = null;
	async function getSupabaseClientRel(){
		if(_sbClient) return _sbClient;
		const resp = await fetch('/api/supabase-config');
		if(!resp.ok) return null;
		const cfg = await resp.json();
		if(typeof window.supabase==='undefined') return null;
		_sbClient = window.supabase.createClient(cfg.supabaseUrl, cfg.supabaseAnonKey);
		return _sbClient;
	}

	function handleUnauthorized(resp){
		if(resp && resp.status===401){
			alert('Sessão expirada ou não autenticada. Faça login para acessar os relatórios.');
			return true;
		}
		return false;
	}

	// ====== BI DE COLETAS ======
	let chartStatus = null, chartMensal = null, chartUsuarios = null, chartPrioridade = null;
	let chartFilial = null, chartClientes = null, chartEtapas = null, chartTiposVeiculo = null;
	let chartTiposCarroceria = null, chartResultadoFinal = null, chartRotas = null, chartValoresMensal = null;
	let chartTempoPorEtapa = null;
	let ultimasColetasBI = []; // dados atuais do relatório (para exportar CSV)

	// Função para converter período em range de datas (BI Coletas)
	function periodoToRangeColetas(periodo){
		const now = new Date();
		let inicio = null;
		let fim = now;
		if (periodo === 'todos') {
			return { inicio: null, fim: null };
		}
		if(periodo==='hoje'){
			inicio = new Date(now.getFullYear(), now.getMonth(), now.getDate());
			fim = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59, 999);
		}else if(periodo==='semana'){
			inicio = new Date(now);
			inicio.setDate(inicio.getDate() - 7);
			inicio.setHours(0, 0, 0, 0);
		}else if(periodo==='mes'){
			inicio = new Date(now);
			inicio.setDate(inicio.getDate() - 30);
			inicio.setHours(0, 0, 0, 0);
		}else if(periodo==='trimestre'){
			inicio = new Date(now);
			inicio.setDate(inicio.getDate() - 90);
			inicio.setHours(0, 0, 0, 0);
		}else if(periodo==='ano'){
			inicio = new Date(now.getFullYear(), 0, 1);
			inicio.setHours(0, 0, 0, 0);
		}
		return { inicio, fim };
	}

	// Exibir/ocultar campos de data quando período = personalizado (BI Coletas)
	function atualizarVisibilidadeDatasColetas(){
		const periodo = document.getElementById('filtroPeriodo')?.value;
		const containerInicio = document.getElementById('containerDataInicioColetas');
		const containerFim = document.getElementById('containerDataFimColetas');
		if (periodo === 'personalizado') {
			if(containerInicio) containerInicio.style.display = '';
			if(containerFim) containerFim.style.display = '';
		} else {
			if(containerInicio) containerInicio.style.display = 'none';
			if(containerFim) containerFim.style.display = 'none';
		}
	}

	// Função para carregar filtros de usuários
	async function carregarFiltrosColetas(){
		try {
			const sb = await getSupabaseClientRel();
			if (!sb) return;

			// Buscar dados únicos para todos os filtros
			const { data: coletas, error } = await sb
				.from('coletas')
				.select('created_by, filial, cliente, tipos_veiculo, tipos_carroceria')
				.limit(5000);

			if (error) {
				console.error('Erro ao carregar filtros:', error);
				return;
			}

			// Extrair valores únicos para cada filtro
			const filiais = new Set();
			const clientes = new Set();
			const tiposVeiculo = new Set();
			const tiposCarroceria = new Set();
			const userIds = new Set();

			(coletas || []).forEach(coleta => {
				if (coleta.created_by) userIds.add(coleta.created_by);
				if (coleta.filial) filiais.add(coleta.filial);
				if (coleta.cliente) clientes.add(coleta.cliente);
				if (coleta.tipos_veiculo && Array.isArray(coleta.tipos_veiculo)) {
					coleta.tipos_veiculo.forEach(tipo => tiposVeiculo.add(tipo));
				}
				if (coleta.tipos_carroceria && Array.isArray(coleta.tipos_carroceria)) {
					coleta.tipos_carroceria.forEach(tipo => tiposCarroceria.add(tipo));
				}
			});

			// Buscar perfis dos usuários
			const usuariosMap = new Map();
			if (userIds.size > 0) {
				const { data: profiles } = await sb
					.from('user_profiles')
					.select('id, nome, email')
					.in('id', Array.from(userIds));

				if (profiles) {
					profiles.forEach(profile => {
						usuariosMap.set(profile.id, profile.nome || profile.email || profile.id);
					});
				}

				// Adicionar IDs que não foram encontrados
				userIds.forEach(id => {
					if (!usuariosMap.has(id)) {
						usuariosMap.set(id, id);
					}
				});
			}

			// Preencher select de usuários
			const selectUsuario = document.getElementById('filtroUsuario');
			if (selectUsuario) {
				selectUsuario.innerHTML = '<option value="">Todos os usuários</option>' +
					Array.from(usuariosMap.entries()).map(([id, nome]) => 
						`<option value="${id}">${nome}</option>`
					).join('');
			}

			// Preencher select de filiais
			const selectFilial = document.getElementById('filtroFilial');
			if (selectFilial) {
				selectFilial.innerHTML = '<option value="">Todas as filiais</option>' +
					Array.from(filiais).sort().map(filial => 
						`<option value="${filial}">${filial}</option>`
					).join('');
			}

			// Preencher select de clientes
			const selectCliente = document.getElementById('filtroCliente');
			if (selectCliente) {
				selectCliente.innerHTML = '<option value="">Todos os clientes</option>' +
					Array.from(clientes).sort().map(cliente => 
						`<option value="${cliente}">${cliente}</option>`
					).join('');
			}

			// Preencher select de tipos de veículo
			const selectTipoVeiculo = document.getElementById('filtroTipoVeiculo');
			if (selectTipoVeiculo) {
				selectTipoVeiculo.innerHTML = '<option value="">Todos os tipos</option>' +
					Array.from(tiposVeiculo).sort().map(tipo => 
						`<option value="${tipo}">${tipo}</option>`
					).join('');
			}

			// Preencher select de tipos de carroceria
			const selectTipoCarroceria = document.getElementById('filtroTipoCarroceria');
			if (selectTipoCarroceria) {
				selectTipoCarroceria.innerHTML = '<option value="">Todos os tipos</option>' +
					Array.from(tiposCarroceria).sort().map(tipo => 
						`<option value="${tipo}">${tipo}</option>`
					).join('');
			}
		} catch (error) {
			console.error('Erro ao carregar filtros de coletas:', error);
		}
	}

	// Função principal para carregar dados do BI de Coletas
	async function carregarColetasBI(){
		try {
			const sb = await getSupabaseClientRel();
			if (!sb) {
				console.error('Supabase não inicializado');
				return;
			}

			// Obter filtros
			const periodo = document.getElementById('filtroPeriodo')?.value || 'todos';
			const usuarioId = document.getElementById('filtroUsuario')?.value || '';
			const filial = document.getElementById('filtroFilial')?.value || '';
			const cliente = document.getElementById('filtroCliente')?.value || '';
			const tipoVeiculo = document.getElementById('filtroTipoVeiculo')?.value || '';
			const tipoCarroceria = document.getElementById('filtroTipoCarroceria')?.value || '';
			const coletaEspecifica = (document.getElementById('filtroColetaEspecifica')?.value || '').trim();
			
			let range;
			if (periodo === 'personalizado') {
				const dataInicio = document.getElementById('filtroDataInicioColetas')?.value;
				const dataFim = document.getElementById('filtroDataFimColetas')?.value;
				range = {
					inicio: dataInicio ? new Date(dataInicio + 'T00:00:00') : null,
					fim: dataFim ? new Date(dataFim + 'T23:59:59') : null
				};
			} else {
				range = periodoToRangeColetas(periodo);
			}
			
			// Construir query
			let query = sb.from('coletas').select('*');
			
			// Aplicar filtro de data (só quando há range)
			if (range && range.inicio) {
				query = query.gte('created_at', range.inicio.toISOString());
			}
			if (range && range.fim) {
				query = query.lte('created_at', range.fim.toISOString());
			}
			
			// Aplicar filtro de usuário
			if (usuarioId) {
				query = query.eq('created_by', usuarioId);
			}
			
			// Aplicar filtro de filial
			if (filial) {
				query = query.eq('filial', filial);
			}
			
			// Aplicar filtro de cliente
			if (cliente) {
				query = query.eq('cliente', cliente);
			}

			const { data: coletas, error } = await query;

			// Filtrar tipos de veículo e carroceria no JavaScript (arrays)
			let coletasFiltradas = coletas || [];
			
			if (tipoVeiculo) {
				coletasFiltradas = coletasFiltradas.filter(coleta => 
					coleta.tipos_veiculo && Array.isArray(coleta.tipos_veiculo) && 
					coleta.tipos_veiculo.includes(tipoVeiculo)
				);
			}
			
			if (tipoCarroceria) {
				coletasFiltradas = coletasFiltradas.filter(coleta => 
					coleta.tipos_carroceria && Array.isArray(coleta.tipos_carroceria) && 
					coleta.tipos_carroceria.includes(tipoCarroceria)
				);
			}

			// Filtro por coleta específica (identificação Filial #Número, cliente, número ou ID)
			if (coletaEspecifica) {
				const termo = coletaEspecifica.toLowerCase();
				const termoNorm = termo.replace(/\s/g, '').replace(/#/g, '');
				coletasFiltradas = coletasFiltradas.filter(coleta => {
					const ident = ((coleta.filial || '') + '#' + (coleta.numero_coleta ?? '')).toLowerCase().replace(/\s/g, '');
					const identSemCerquilha = ident.replace(/#/g, '');
					const clienteStr = (coleta.cliente || '').toLowerCase();
					const numStr = String(coleta.numero_coleta ?? '').toLowerCase();
					const idStr = (coleta.id || '').toLowerCase();
					return ident.includes(termo) || identSemCerquilha.includes(termoNorm) ||
						clienteStr.includes(termo) || numStr.includes(termo) || idStr.includes(termo);
				});
			}

			if (error) {
				console.error('Erro ao carregar coletas:', error);
				processarDadosColetas([]);
				return;
			}

			console.log('Coletas carregadas:', coletasFiltradas?.length || 0);
			processarDadosColetas(coletasFiltradas);

		} catch (error) {
			console.error('Erro ao carregar BI de coletas:', error);
		}
	}

	// Função para processar dados e atualizar KPIs e gráficos
	function processarDadosColetas(coletas){
		ultimasColetasBI = coletas || [];
		console.log('Processando dados de coletas:', coletas.length);
		
		// ========== KPIs BÁSICOS ==========
		const total = coletas.length;
		const emAndamento = coletas.filter(c => c.status === 'em_andamento' || (c.status !== 'concluida' && c.status !== 'cancelada')).length;
		const concluidas = coletas.filter(c => c.status === 'concluida').length;
		const canceladas = coletas.filter(c => c.status === 'cancelada').length;

		const setKpi = (id, val) => { const e = document.getElementById(id); if (e) e.textContent = val; };
		setKpi('totalColetas', total);
		setKpi('emAndamento', emAndamento);
		setKpi('concluidas', concluidas);
		setKpi('canceladas', canceladas);

		// ========== KPIs FINANCEIROS ==========
		const coletasComValor = coletas.filter(c => c.valor && parseFloat(c.valor) > 0);
		const valorTotal = coletasComValor.reduce((acc, c) => acc + parseFloat(c.valor || 0), 0);
		const valorMedio = coletasComValor.length > 0 ? valorTotal / coletasComValor.length : 0;
		
		setKpi('valorTotal', `R$ ${valorTotal.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`);
		setKpi('valorMedio', `R$ ${valorMedio.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`);

		// ========== KPIs OPERACIONAIS ==========
		const coletasComKM = coletas.filter(c => c.km && parseInt(c.km) > 0);
		const kmTotal = coletasComKM.reduce((acc, c) => acc + parseInt(c.km || 0), 0);
		const kmMedio = coletasComKM.length > 0 ? Math.round(kmTotal / coletasComKM.length) : 0;
		
		setKpi('kmTotal', `${kmTotal.toLocaleString('pt-BR')} km`);
		setKpi('kmMedio', `${kmMedio.toLocaleString('pt-BR')} km`);

		// ========== KPIs DE RESULTADO ==========
		const ganhou = coletas.filter(c => c.resultado_final === 'ganhou').length;
		const perdeu = coletas.filter(c => c.resultado_final === 'perdeu').length;
		const comMotorista = coletas.filter(c => c.motorista_id).length;
		const semMotorista = total - comMotorista;
		
		setKpi('ganhou', ganhou);
		setKpi('perdeu', perdeu);
		setKpi('comMotorista', comMotorista);
		setKpi('semMotorista', semMotorista);

		// ========== KPIs DE TEMPO ==========
		const coletasConcluidas = coletas.filter(c => c.status === 'concluida' && c.data_recebimento && c.data_atualizacao);
		let tempoMedio = 0;
		if (coletasConcluidas.length > 0) {
			const temposTotais = coletasConcluidas.reduce((acc, c) => {
				const inicio = new Date(c.data_recebimento);
				const fim = new Date(c.data_atualizacao);
				return acc + (fim - inicio);
			}, 0);
			tempoMedio = Math.round(temposTotais / coletasConcluidas.length / (1000 * 60 * 60 * 24)); // dias
		}

		// Tempo de ciclo (data_recebimento até data_entrega)
		const coletasComCiclo = coletas.filter(c => c.data_recebimento && c.data_entrega);
		let tempoCicloMedio = 0;
		if (coletasComCiclo.length > 0) {
			const ciclosTotais = coletasComCiclo.reduce((acc, c) => {
				const inicio = new Date(c.data_recebimento);
				const fim = new Date(c.data_entrega);
				return acc + (fim - inicio);
			}, 0);
			tempoCicloMedio = Math.round(ciclosTotais / coletasComCiclo.length / (1000 * 60 * 60 * 24)); // dias
		}

		const taxaSucesso = total > 0 ? Math.round((concluidas / total) * 100) : 0;
		const totalComResultado = ganhou + perdeu;
		const taxaConversao = totalComResultado > 0 ? Math.round((ganhou / totalComResultado) * 100) : 0;

		const el = (id) => document.getElementById(id);
		if (el('tempoMedio')) el('tempoMedio').textContent = tempoMedio > 0 ? `${tempoMedio} dias` : '0';
		if (el('taxaSucesso')) el('taxaSucesso').textContent = `${taxaSucesso}%`;
		if (el('tempoCicloMedio')) el('tempoCicloMedio').textContent = tempoCicloMedio > 0 ? `${tempoCicloMedio} dias` : '0 dias';
		if (el('taxaConversao')) el('taxaConversao').textContent = `${taxaConversao}%`;

		// ========== PROCESSAR DADOS PARA GRÁFICOS ==========
		const porStatus = {};
		const porMes = {};
		const porUsuario = {};
		const porPrioridade = {};
		const porFilial = {};
		const porCliente = {};
		const porEtapa = {};
		const porTiposVeiculo = {};
		const porTiposCarroceria = {};
		const porResultadoFinal = {};
		const porRotas = {};
		const valoresPorMes = {};

		coletas.forEach(coleta => {
			// Por Status
			const status = coleta.status || 'pendente';
			porStatus[status] = (porStatus[status] || 0) + 1;

			// Por Mês
			if (coleta.created_at) {
				const data = new Date(coleta.created_at);
				const mesAno = `${data.toLocaleString('pt-BR', { month: 'short' })}/${data.getFullYear()}`;
				porMes[mesAno] = (porMes[mesAno] || 0) + 1;
				
				// Valores por mês
				if (coleta.valor && parseFloat(coleta.valor) > 0) {
					if (!valoresPorMes[mesAno]) valoresPorMes[mesAno] = 0;
					valoresPorMes[mesAno] += parseFloat(coleta.valor);
				}
			}

			// Por Usuário
			const usuario = coleta.created_by || 'Sem usuário';
			porUsuario[usuario] = (porUsuario[usuario] || 0) + 1;

			// Por Prioridade
			const prioridade = coleta.prioridade || 'normal';
			porPrioridade[prioridade] = (porPrioridade[prioridade] || 0) + 1;

			// Por Filial
			const filial = coleta.filial || 'Não informada';
			porFilial[filial] = (porFilial[filial] || 0) + 1;

			// Por Cliente
			const cliente = coleta.cliente || 'Não informado';
			porCliente[cliente] = (porCliente[cliente] || 0) + 1;

			// Por Etapa
			const etapa = coleta.etapa_atual || 'Não informada';
			porEtapa[etapa] = (porEtapa[etapa] || 0) + 1;

			// Por Tipos de Veículo
			if (coleta.tipos_veiculo && Array.isArray(coleta.tipos_veiculo)) {
				coleta.tipos_veiculo.forEach(tipo => {
					porTiposVeiculo[tipo] = (porTiposVeiculo[tipo] || 0) + 1;
				});
			}

			// Por Tipos de Carroceria
			if (coleta.tipos_carroceria && Array.isArray(coleta.tipos_carroceria)) {
				coleta.tipos_carroceria.forEach(tipo => {
					porTiposCarroceria[tipo] = (porTiposCarroceria[tipo] || 0) + 1;
				});
			}

			// Por Resultado Final
			if (coleta.resultado_final) {
				porResultadoFinal[coleta.resultado_final] = (porResultadoFinal[coleta.resultado_final] || 0) + 1;
			}

			// Por Rotas (Origem → Destino)
			if (coleta.origem && coleta.destino) {
				const rota = `${coleta.origem} → ${coleta.destino}`;
				porRotas[rota] = (porRotas[rota] || 0) + 1;
			}
		});

		// ========== TEMPO MÉDIO POR ETAPA (onde as coletas estão ficando mais tempo) ==========
		const tempoPorEtapa = {}; // { etapa: { totalMinutos, count } }
		const agora = Date.now();
		coletas.forEach(coleta => {
			const etapa = coleta.etapa_atual || null;
			if (!etapa) return;
			let minutos = 0;
			if (coleta.tempo_acumulado_etapa != null && !isNaN(coleta.tempo_acumulado_etapa) && coleta.tempo_acumulado_etapa >= 0) {
				minutos = Math.floor(coleta.tempo_acumulado_etapa);
			} else {
				const ref = coleta.data_entrada_etapa || coleta.updated_at || coleta.created_at;
				if (ref) {
					const ent = new Date(ref).getTime();
					minutos = Math.max(0, Math.floor((agora - ent) / 60000));
				}
			}
			if (!tempoPorEtapa[etapa]) tempoPorEtapa[etapa] = { totalMinutos: 0, count: 0 };
			tempoPorEtapa[etapa].totalMinutos += minutos;
			tempoPorEtapa[etapa].count += 1;
		});
		const porTempoEtapa = {}; // { etapa: mediaMinutos }
		Object.entries(tempoPorEtapa).forEach(([et, v]) => {
			if (v.count > 0) porTempoEtapa[et] = Math.round(v.totalMinutos / v.count);
		});

		// ========== CRIAR TODOS OS GRÁFICOS ==========
		setTimeout(() => {
			console.log('Criando gráficos...', {
				porStatus: Object.keys(porStatus).length,
				porMes: Object.keys(porMes).length,
				porFilial: Object.keys(porFilial).length,
				porCliente: Object.keys(porCliente).length
			});
			
			if (Object.keys(porStatus).length > 0) criarGraficoStatus(porStatus);
			if (Object.keys(porMes).length > 0) criarGraficoMensal(porMes);
			if (Object.keys(porPrioridade).length > 0) criarGraficoPrioridade(porPrioridade);
			if (Object.keys(porFilial).length > 0) criarGraficoFilial(porFilial);
			if (Object.keys(porCliente).length > 0) criarGraficoClientes(porCliente);
			if (Object.keys(porEtapa).length > 0) criarGraficoEtapas(porEtapa);
			if (Object.keys(porTiposVeiculo).length > 0) criarGraficoTiposVeiculo(porTiposVeiculo);
			if (Object.keys(porTiposCarroceria).length > 0) criarGraficoTiposCarroceria(porTiposCarroceria);
			if (Object.keys(porResultadoFinal).length > 0) criarGraficoResultadoFinal(porResultadoFinal);
			if (Object.keys(porRotas).length > 0) criarGraficoRotas(porRotas);
			if (Object.keys(valoresPorMes).length > 0) criarGraficoValoresMensal(valoresPorMes);
			if (Object.keys(porTempoEtapa).length > 0) criarGraficoTempoPorEtapa(porTempoEtapa);
			// Criar gráfico de usuários (assíncrono)
			if (Object.keys(porUsuario).length > 0) {
				criarGraficoUsuarios(porUsuario).catch(err => console.error('Erro ao criar gráfico de usuários:', err));
			}
		}, 300);

		// Atualizar tabela
		atualizarTabelaColetas(coletas);
	}

	// Função para criar gráfico de Status
	function criarGraficoStatus(dados){
		try {
			const ctx = document.getElementById('chartStatus');
			if (!ctx) {
				console.error('Elemento chartStatus não encontrado');
				return;
			}

			// Verificar se Chart está disponível
			if (typeof Chart === 'undefined') {
				console.error('Chart.js não está carregado');
				return;
			}

			const colors = getChartColors();
			const labels = Object.keys(dados);
			const values = Object.values(dados);
			
			if (labels.length === 0) {
				console.log('Nenhum dado para gráfico de Status');
				return;
			}
			
			const cores = ['#667eea', '#22c55e', '#ef4444', '#f59e0b', '#8b5cf6'];

			if (chartStatus) chartStatus.destroy();

			const total = values.reduce((a, b) => a + b, 0);
			chartStatus = ensureChart('chartStatus', 'pie', {
				labels: labels.map(s => s.charAt(0).toUpperCase() + s.slice(1).replace('_', ' ')),
				datasets: [{
					data: values,
					backgroundColor: TECH_CHART_PALETTE.slice(0, labels.length),
					borderWidth: 2,
					borderColor: 'rgba(15,23,42,0.4)',
					hoverBorderWidth: 4,
					hoverOffset: 10,
					hoverShadowBlur: 12,
					hoverShadowColor: 'rgba(6,182,212,0.35)'
				}]
			}, {
				responsive: true,
				maintainAspectRatio: false,
				onClick: (event, elements) => {
					if (elements.length > 0) {
						const element = elements[0];
						const index = element.index;
						const status = labels[index];
						const valor = values[index];
						const porcentagem = total > 0 ? ((valor / total) * 100).toFixed(1) : 0;
						mostrarDetalhesColetas('Status', status, valor, porcentagem, dados);
					}
				},
				onHover: (event, elements) => {
					event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
				},
				animation: {
					animateRotate: true,
					animateScale: true,
					duration: 1500,
					easing: 'easeOutQuart'
				},
				plugins: {
					legend: {
						position: 'bottom',
						labels: { 
							color: colors.legendColor, 
							font: { size: 12, weight: '600' },
							padding: 15,
							usePointStyle: true,
							pointStyle: 'circle'
						}
					},
					tooltip: {
						enabled: true,
						backgroundColor: 'rgba(15, 15, 35, 0.95)',
						titleColor: '#ffffff',
						bodyColor: '#ffffff',
						borderColor: '#667eea',
						borderWidth: 2,
						padding: 12,
						displayColors: true,
						callbacks: {
							label: function(context) {
								const label = context.label || '';
								const value = context.parsed || 0;
								const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
								return `${label}: ${value} (${percentage}%)`;
							}
						}
					}
				}
			});
			
			console.log('Gráfico de Status criado com sucesso');
		} catch (error) {
			console.error('Erro ao criar gráfico de Status:', error);
		}
	}

	// Função para criar gráfico Mensal
	function criarGraficoMensal(dados){
		try {
			const ctx = document.getElementById('chartMensal');
			if (!ctx) {
				console.error('Elemento chartMensal não encontrado');
				return;
			}

			if (typeof Chart === 'undefined') {
				console.error('Chart.js não está carregado');
				return;
			}
			
			if (Object.keys(dados).length === 0) {
				console.log('Nenhum dado para gráfico Mensal');
				return;
			}

			const colors = getChartColors();
			const entries = Object.entries(dados).sort((a, b) => {
				// Ordenar por data
				const [mesA, anoA] = a[0].split('/');
				const [mesB, anoB] = b[0].split('/');
				if (anoA !== anoB) return anoA.localeCompare(anoB);
				const meses = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
				return meses.indexOf(mesA) - meses.indexOf(mesB);
			});

			if (chartMensal) chartMensal.destroy();

			const totalMensal = entries.reduce((s, e) => s + e[1], 0);
			chartMensal = ensureChart('chartMensal', 'bar', {
				labels: entries.map(e => e[0]),
				datasets: [{
					label: 'Coletas',
					data: entries.map(e => e[1]),
					backgroundColor: techBarBackground('#06b6d4', '#6366f1'),
					borderColor: 'rgba(99,102,241,0.6)',
					borderWidth: 1,
					hoverBackgroundColor: 'rgba(6,182,212,0.9)'
				}]
			}, {
				plugins: { legend: { display: false } },
				onClick: (event, elements) => {
					if (elements.length > 0) {
						const idx = elements[0].index;
						const mesAno = entries[idx][0];
						const valor = entries[idx][1];
						const pct = totalMensal > 0 ? ((valor / totalMensal) * 100).toFixed(1) : 0;
						mostrarDetalhesColetas('Mês', mesAno, valor, pct, dados);
					}
				},
				onHover: (event, elements) => {
					event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
				},
				scales: {
					y: { beginAtZero: true, ticks: { color: colors.textColor }, grid: { color: colors.gridColor } },
					x: { ticks: { color: colors.textColor }, grid: { color: colors.gridColor } }
				}
			});
			
			console.log('Gráfico Mensal criado com sucesso');
		} catch (error) {
			console.error('Erro ao criar gráfico Mensal:', error);
		}
	}

	// Função para criar gráfico de Usuários
	async function criarGraficoUsuarios(dados){
		const ctx = document.getElementById('chartUsuarios');
		if (!ctx) {
			console.error('Elemento chartUsuarios não encontrado');
			return;
		}

		if (typeof Chart === 'undefined') {
			console.error('Chart.js não está carregado');
			return;
		}
		
		if (Object.keys(dados).length === 0) {
			console.log('Nenhum dado para gráfico de Usuários');
			return;
		}

		// Buscar nomes dos usuários
		const sb = await getSupabaseClientRel();
		const usuariosMap = new Map();
		if (sb) {
			const userIds = Object.keys(dados);
			for (const userId of userIds) {
				try {
					const { data: profile } = await sb
						.from('user_profiles')
						.select('nome, email')
						.eq('id', userId)
						.single();
					
					if (profile) {
						usuariosMap.set(userId, profile.nome || profile.email || userId);
					} else {
						usuariosMap.set(userId, userId);
					}
				} catch (e) {
					usuariosMap.set(userId, userId);
				}
			}
		}

		const colors = getChartColors();
		const entries = Object.entries(dados)
			.sort((a, b) => b[1] - a[1])
			.slice(0, 10); // Top 10

		if (chartUsuarios) chartUsuarios.destroy();

		const totalUsuarios = entries.reduce((s, e) => s + e[1], 0);
		chartUsuarios = ensureChart('chartUsuarios', 'bar', {
			labels: entries.map(e => usuariosMap.get(e[0]) || e[0]),
			datasets: [{
				label: 'Coletas Criadas',
				data: entries.map(e => e[1]),
				backgroundColor: techBarBackground('#10b981', '#14b8a6'),
				borderColor: 'rgba(16, 185, 129, 0.5)',
				borderWidth: 1,
				borderRadius: 8,
				hoverBackgroundColor: 'rgba(20, 184, 166, 0.9)'
			}]
		}, {
			responsive: true,
			maintainAspectRatio: false,
			plugins: { legend: { display: false } },
			onClick: (event, elements) => {
				if (elements.length > 0) {
					const idx = elements[0].index;
					const userId = entries[idx][0];
					const valor = entries[idx][1];
					const pct = totalUsuarios > 0 ? ((valor / totalUsuarios) * 100).toFixed(1) : 0;
					mostrarDetalhesColetas('Usuário', userId, valor, pct, dados);
				}
			},
			onHover: (event, elements) => {
				event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
			},
			scales: {
				y: { beginAtZero: true, ticks: { color: colors.textColor }, grid: { color: colors.gridColor } },
				x: { ticks: { color: colors.textColor, maxRotation: 45, minRotation: 45 }, grid: { color: colors.gridColor } }
			}
		});
	}

	// Função para criar gráfico de Prioridade
	function criarGraficoPrioridade(dados){
		try {
			const ctx = document.getElementById('chartPrioridade');
			if (!ctx) {
				console.error('Elemento chartPrioridade não encontrado');
				return;
			}

			if (typeof Chart === 'undefined') {
				console.error('Chart.js não está carregado');
				return;
			}
			
			if (Object.keys(dados).length === 0) {
				console.log('Nenhum dado para gráfico de Prioridade');
				return;
			}

			const colors = getChartColors();
			const ordem = ['urgente', 'alta', 'normal', 'baixa'];
			const coresMap = {
				urgente: '#ef4444',
				alta: '#f59e0b',
				normal: '#667eea',
				baixa: '#22c55e'
			};

			const labels = ordem.filter(p => dados[p]);
			const values = labels.map(p => dados[p]);
			const cores = labels.map(p => coresMap[p] || '#667eea');

			if (chartPrioridade) chartPrioridade.destroy();

			const totalPrioridade = values.reduce((a, b) => a + b, 0);
			
			chartPrioridade = ensureChart('chartPrioridade', 'doughnut', {
				labels: labels.map(p => p.charAt(0).toUpperCase() + p.slice(1)),
				datasets: [{
					data: values,
					backgroundColor: cores,
					borderWidth: 3,
					borderColor: '#ffffff',
					hoverBorderWidth: 5,
					hoverOffset: 8,
					cutout: '60%'
				}]
			}, {
				responsive: true,
				maintainAspectRatio: false,
				onClick: (event, elements) => {
					if (elements.length > 0) {
						const element = elements[0];
						const index = element.index;
						const prioridade = labels[index];
						const valor = values[index];
						const porcentagem = totalPrioridade > 0 ? ((valor / totalPrioridade) * 100).toFixed(1) : 0;
						mostrarDetalhesColetas('Prioridade', prioridade, valor, porcentagem, dados);
					}
				},
				onHover: (event, elements) => {
					event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
				},
				animation: {
					animateRotate: true,
					animateScale: true,
					duration: 1500,
					easing: 'easeOutQuart'
				},
				plugins: {
					legend: {
						position: 'bottom',
						labels: { 
							color: colors.legendColor, 
							font: { size: 12, weight: '600' },
							padding: 15,
							usePointStyle: true,
							pointStyle: 'circle'
						}
					},
					tooltip: {
						enabled: true,
						backgroundColor: 'rgba(15, 15, 35, 0.95)',
						titleColor: '#ffffff',
						bodyColor: '#ffffff',
						borderColor: '#667eea',
						borderWidth: 2,
						padding: 12,
						displayColors: true,
						callbacks: {
							label: function(context) {
								const label = context.label || '';
								const value = context.parsed || 0;
								const percentage = totalPrioridade > 0 ? ((value / totalPrioridade) * 100).toFixed(1) : 0;
								return `${label}: ${value} (${percentage}%)`;
							}
						}
					}
				}
			});
			console.log('Gráfico de Prioridade criado com sucesso');
		} catch (error) {
			console.error('Erro ao criar gráfico de Prioridade:', error);
		}
	}

	// Função para criar gráfico de Filial
	function criarGraficoFilial(dados){
		try {
			const ctx = document.getElementById('chartFilial');
			if (!ctx || typeof Chart === 'undefined' || Object.keys(dados).length === 0) return;
			
			const colors = getChartColors();
			const entries = Object.entries(dados).sort((a, b) => b[1] - a[1]);
			
			if (chartFilial) chartFilial.destroy();
			
			const totalFilial = entries.reduce((sum, e) => sum + e[1], 0);
			chartFilial = ensureChart('chartFilial', 'doughnut', {
				labels: entries.map(e => e[0]),
				datasets: [{
					data: entries.map(e => e[1]),
					backgroundColor: TECH_CHART_PALETTE.slice(0, entries.length),
					borderWidth: 2,
					borderColor: '#ffffff',
					hoverBorderWidth: 5,
					hoverOffset: 8,
					cutout: '60%'
				}]
			}, {
				responsive: true,
				maintainAspectRatio: false,
				onClick: (event, elements) => {
					if (elements.length > 0) {
						const element = elements[0];
						const index = element.index;
						const filial = entries[index][0];
						const valor = entries[index][1];
						const porcentagem = totalFilial > 0 ? ((valor / totalFilial) * 100).toFixed(1) : 0;
						mostrarDetalhesColetas('Filial', filial, valor, porcentagem, dados);
					}
				},
				onHover: (event, elements) => {
					event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
				},
				animation: {
					animateRotate: true,
					animateScale: true,
					duration: 1500,
					easing: 'easeOutQuart'
				},
				plugins: {
					legend: { 
						position: 'bottom', 
						labels: { 
							color: colors.legendColor, 
							font: { size: 12, weight: '600' },
							padding: 15,
							usePointStyle: true,
							pointStyle: 'circle'
						} 
					},
					tooltip: {
						enabled: true,
						backgroundColor: 'rgba(15, 15, 35, 0.95)',
						titleColor: '#ffffff',
						bodyColor: '#ffffff',
						borderColor: '#667eea',
						borderWidth: 2,
						padding: 12,
						displayColors: true,
						callbacks: {
							label: function(context) {
								const label = context.label || '';
								const value = context.parsed || 0;
								const percentage = totalFilial > 0 ? ((value / totalFilial) * 100).toFixed(1) : 0;
								return `${label}: ${value} (${percentage}%)`;
							}
						}
					}
				}
			});
			console.log('Gráfico de Filial criado com sucesso');
		} catch (error) {
			console.error('Erro ao criar gráfico de Filial:', error);
		}
	}

	// Função para criar gráfico de Clientes
	function criarGraficoClientes(dados){
		try {
			const ctx = document.getElementById('chartClientes');
			if (!ctx || typeof Chart === 'undefined' || Object.keys(dados).length === 0) return;
		
			const colors = getChartColors();
			const entries = Object.entries(dados).sort((a, b) => b[1] - a[1]).slice(0, 10);
			
			if (chartClientes) chartClientes.destroy();
			
			const totalClientes = entries.reduce((s, e) => s + e[1], 0);
			chartClientes = ensureChart('chartClientes', 'bar', {
				labels: entries.map(e => e[0].length > 30 ? e[0].substring(0, 30) + '...' : e[0]),
				datasets: [{
					label: 'Coletas',
					data: entries.map(e => e[1]),
					backgroundColor: techBarBackground('#10b981', '#14b8a6'),
					borderColor: 'rgba(16, 185, 129, 0.5)',
					borderWidth: 1,
					borderRadius: 8
				}]
			}, {
				responsive: true,
				maintainAspectRatio: false,
				plugins: { legend: { display: false } },
				onClick: (event, elements) => {
					if (elements.length > 0) {
						const idx = elements[0].index;
						const cliente = entries[idx][0];
						const valor = entries[idx][1];
						const pct = totalClientes > 0 ? ((valor / totalClientes) * 100).toFixed(1) : 0;
						mostrarDetalhesColetas('Cliente', cliente, valor, pct, dados);
					}
				},
				onHover: (event, elements) => {
					event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
				},
				scales: {
					y: { beginAtZero: true, ticks: { color: colors.textColor }, grid: { color: colors.gridColor } },
					x: { ticks: { color: colors.textColor, maxRotation: 45, minRotation: 45 }, grid: { color: colors.gridColor } }
				}
			});
			
			console.log('Gráfico de Clientes criado com sucesso');
		} catch (error) {
			console.error('Erro ao criar gráfico de Clientes:', error);
		}
	}

	// Função para criar gráfico de Etapas
	function criarGraficoEtapas(dados){
		try {
			const ctx = document.getElementById('chartEtapas');
			if (!ctx || typeof Chart === 'undefined' || Object.keys(dados).length === 0) return;
			
			const colors = getChartColors();
			const entries = Object.entries(dados).sort((a, b) => b[1] - a[1]);
			
			if (chartEtapas) chartEtapas.destroy();
			
			const totalEtapas = entries.reduce((s, e) => s + e[1], 0);
			chartEtapas = ensureChart('chartEtapas', 'bar', {
				labels: entries.map(e => e[0].charAt(0).toUpperCase() + e[0].slice(1).replace(/_/g, ' ')),
				datasets: [{
					label: 'Coletas',
					data: entries.map(e => e[1]),
					backgroundColor: techBarBackground('#6366f1', '#8b5cf6'),
					borderColor: 'rgba(99, 102, 241, 0.5)',
					borderWidth: 1,
					borderRadius: 8
				}]
			}, {
				responsive: true,
				maintainAspectRatio: false,
				plugins: { legend: { display: false } },
				onClick: (event, elements) => {
					if (elements.length > 0) {
						const idx = elements[0].index;
						const etapa = entries[idx][0];
						const valor = entries[idx][1];
						const pct = totalEtapas > 0 ? ((valor / totalEtapas) * 100).toFixed(1) : 0;
						mostrarDetalhesColetas('Etapa', etapa, valor, pct, dados);
					}
				},
				onHover: (event, elements) => {
					event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
				},
				scales: {
					y: { beginAtZero: true, ticks: { color: colors.textColor }, grid: { color: colors.gridColor } },
					x: { ticks: { color: colors.textColor, maxRotation: 45, minRotation: 45 }, grid: { color: colors.gridColor } }
				}
			});
			console.log('Gráfico de Etapas criado com sucesso');
		} catch (error) {
			console.error('Erro ao criar gráfico de Etapas:', error);
		}
	}

	// Função para criar gráfico de Tipos de Veículo
	function criarGraficoTiposVeiculo(dados){
		try {
			const ctx = document.getElementById('chartTiposVeiculo');
			if (!ctx || typeof Chart === 'undefined' || Object.keys(dados).length === 0) return;
			
			const colors = getChartColors();
			const entries = Object.entries(dados).sort((a, b) => b[1] - a[1]);
			
			if (chartTiposVeiculo) chartTiposVeiculo.destroy();
			
			const totalVeiculo = entries.reduce((sum, e) => sum + e[1], 0);
			chartTiposVeiculo = ensureChart('chartTiposVeiculo', 'pie', {
				labels: entries.map(e => e[0]),
				datasets: [{
					data: entries.map(e => e[1]),
					backgroundColor: TECH_CHART_PALETTE.slice(0, entries.length),
					borderWidth: 2,
					borderColor: 'rgba(15, 23, 42, 0.4)',
					hoverBorderWidth: 5,
					hoverOffset: 8
				}]
			}, {
				responsive: true,
				maintainAspectRatio: false,
				onClick: (event, elements) => {
					if (elements.length > 0) {
						const element = elements[0];
						const index = element.index;
						const tipo = entries[index][0];
						const valor = entries[index][1];
						const porcentagem = totalVeiculo > 0 ? ((valor / totalVeiculo) * 100).toFixed(1) : 0;
						mostrarDetalhesColetas('Tipo de Veículo', tipo, valor, porcentagem, dados);
					}
				},
				onHover: (event, elements) => {
					event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
				},
				animation: {
					animateRotate: true,
					animateScale: true,
					duration: 1500,
					easing: 'easeOutQuart'
				},
				plugins: {
					legend: { 
						position: 'bottom', 
						labels: { 
							color: colors.legendColor, 
							font: { size: 12, weight: '600' },
							padding: 15,
							usePointStyle: true,
							pointStyle: 'circle'
						} 
					},
					tooltip: {
						enabled: true,
						backgroundColor: 'rgba(15, 15, 35, 0.95)',
						titleColor: '#ffffff',
						bodyColor: '#ffffff',
						borderColor: '#667eea',
						borderWidth: 2,
						padding: 12,
						displayColors: true,
						callbacks: {
							label: function(context) {
								const label = context.label || '';
								const value = context.parsed || 0;
								const percentage = totalVeiculo > 0 ? ((value / totalVeiculo) * 100).toFixed(1) : 0;
								return `${label}: ${value} (${percentage}%)`;
							}
						}
					}
				}
			});
			console.log('Gráfico de Tipos de Veículo criado com sucesso');
		} catch (error) {
			console.error('Erro ao criar gráfico de Tipos de Veículo:', error);
		}
	}

	// Função para criar gráfico de Tipos de Carroceria
	function criarGraficoTiposCarroceria(dados){
		try {
			const ctx = document.getElementById('chartTiposCarroceria');
			if (!ctx || typeof Chart === 'undefined' || Object.keys(dados).length === 0) return;
			
			const colors = getChartColors();
			const entries = Object.entries(dados).sort((a, b) => b[1] - a[1]);
			
			if (chartTiposCarroceria) chartTiposCarroceria.destroy();
			
			const totalCarroceria = entries.reduce((sum, e) => sum + e[1], 0);
			chartTiposCarroceria = ensureChart('chartTiposCarroceria', 'doughnut', {
				labels: entries.map(e => e[0]),
				datasets: [{
					data: entries.map(e => e[1]),
					backgroundColor: TECH_CHART_PALETTE.slice(0, entries.length),
					borderWidth: 2,
					borderColor: 'rgba(15, 23, 42, 0.4)',
					hoverBorderWidth: 5,
					hoverOffset: 8,
					cutout: '60%'
				}]
			}, {
				responsive: true,
				maintainAspectRatio: false,
				onClick: (event, elements) => {
					if (elements.length > 0) {
						const element = elements[0];
						const index = element.index;
						const tipo = entries[index][0];
						const valor = entries[index][1];
						const porcentagem = totalCarroceria > 0 ? ((valor / totalCarroceria) * 100).toFixed(1) : 0;
						mostrarDetalhesColetas('Tipo de Carroceria', tipo, valor, porcentagem, dados);
					}
				},
				onHover: (event, elements) => {
					event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
				},
				animation: {
					animateRotate: true,
					animateScale: true,
					duration: 1500,
					easing: 'easeOutQuart'
				},
				plugins: {
					legend: { 
						position: 'bottom', 
						labels: { 
							color: colors.legendColor, 
							font: { size: 12, weight: '600' },
							padding: 15,
							usePointStyle: true,
							pointStyle: 'circle'
						} 
					},
					tooltip: {
						enabled: true,
						backgroundColor: 'rgba(15, 15, 35, 0.95)',
						titleColor: '#ffffff',
						bodyColor: '#ffffff',
						borderColor: '#667eea',
						borderWidth: 2,
						padding: 12,
						displayColors: true,
						callbacks: {
							label: function(context) {
								const label = context.label || '';
								const value = context.parsed || 0;
								const percentage = totalCarroceria > 0 ? ((value / totalCarroceria) * 100).toFixed(1) : 0;
								return `${label}: ${value} (${percentage}%)`;
							}
						}
					}
				}
			});
			console.log('Gráfico de Tipos de Carroceria criado com sucesso');
		} catch (error) {
			console.error('Erro ao criar gráfico de Tipos de Carroceria:', error);
		}
	}

	// Função para criar gráfico de Resultado Final
	function criarGraficoResultadoFinal(dados){
		try {
			const ctx = document.getElementById('chartResultadoFinal');
			if (!ctx || typeof Chart === 'undefined' || Object.keys(dados).length === 0) return;
			
			const colors = getChartColors();
			const coresMap = { ganhou: '#22c55e', perdeu: '#ef4444' };
			const entries = Object.entries(dados);
			
			if (chartResultadoFinal) chartResultadoFinal.destroy();
			
			const totalResultado = entries.reduce((sum, e) => sum + e[1], 0);
			
			chartResultadoFinal = ensureChart('chartResultadoFinal', 'pie', {
				labels: entries.map(e => e[0].charAt(0).toUpperCase() + e[0].slice(1)),
				datasets: [{
					data: entries.map(e => e[1]),
					backgroundColor: entries.map((e, i) => coresMap[e[0]] || TECH_CHART_PALETTE[i % TECH_CHART_PALETTE.length]),
					borderWidth: 2,
					borderColor: 'rgba(15, 23, 42, 0.4)',
					hoverBorderWidth: 4,
					hoverOffset: 10
				}]
			}, {
				responsive: true,
				maintainAspectRatio: false,
				onClick: (event, elements) => {
					if (elements.length > 0) {
						const element = elements[0];
						const index = element.index;
						const resultado = entries[index][0];
						const valor = entries[index][1];
						const porcentagem = totalResultado > 0 ? ((valor / totalResultado) * 100).toFixed(1) : 0;
						mostrarDetalhesColetas('Resultado Final', resultado, valor, porcentagem, dados);
					}
				},
				onHover: (event, elements) => {
					event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
				},
				animation: {
					animateRotate: true,
					animateScale: true,
					duration: 1500,
					easing: 'easeOutQuart'
				},
				plugins: {
					legend: { 
						position: 'bottom', 
						labels: { 
							color: colors.legendColor, 
							font: { size: 12, weight: '600' },
							padding: 15,
							usePointStyle: true,
							pointStyle: 'circle'
						} 
					},
					tooltip: {
						enabled: true,
						backgroundColor: 'rgba(15, 15, 35, 0.95)',
						titleColor: '#ffffff',
						bodyColor: '#ffffff',
						borderColor: '#667eea',
						borderWidth: 2,
						padding: 12,
						displayColors: true,
						callbacks: {
							label: function(context) {
								const label = context.label || '';
								const value = context.parsed || 0;
								const percentage = totalResultado > 0 ? ((value / totalResultado) * 100).toFixed(1) : 0;
								return `${label}: ${value} (${percentage}%)`;
							}
						}
					}
				}
			});
			console.log('Gráfico de Resultado Final criado com sucesso');
		} catch (error) {
			console.error('Erro ao criar gráfico de Resultado Final:', error);
		}
	}

	// Função para criar gráfico de Rotas
	function criarGraficoRotas(dados){
		try {
			const ctx = document.getElementById('chartRotas');
			if (!ctx || typeof Chart === 'undefined' || Object.keys(dados).length === 0) return;
			
			const colors = getChartColors();
			const entries = Object.entries(dados).sort((a, b) => b[1] - a[1]).slice(0, 10);
			
			if (chartRotas) chartRotas.destroy();
			
			const totalRotas = entries.reduce((s, e) => s + e[1], 0);
			chartRotas = ensureChart('chartRotas', 'bar', {
				labels: entries.map(e => e[0].length > 40 ? e[0].substring(0, 40) + '...' : e[0]),
				datasets: [{
					label: 'Coletas',
					data: entries.map(e => e[1]),
					backgroundColor: techBarBackground('#8b5cf6', '#a855f7'),
					borderColor: 'rgba(139, 92, 246, 0.5)',
					borderWidth: 1,
					borderRadius: 8
				}]
			}, {
				responsive: true,
				maintainAspectRatio: false,
				plugins: { legend: { display: false } },
				onClick: (event, elements) => {
					if (elements.length > 0) {
						const idx = elements[0].index;
						const rota = entries[idx][0];
						const valor = entries[idx][1];
						const pct = totalRotas > 0 ? ((valor / totalRotas) * 100).toFixed(1) : 0;
						mostrarDetalhesColetas('Rota', rota, valor, pct, dados);
					}
				},
				onHover: (event, elements) => {
					event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
				},
				scales: {
					y: { beginAtZero: true, ticks: { color: colors.textColor }, grid: { color: colors.gridColor } },
					x: { ticks: { color: colors.textColor, maxRotation: 45, minRotation: 45 }, grid: { color: colors.gridColor } }
				}
			});
			console.log('Gráfico de Rotas criado com sucesso');
		} catch (error) {
			console.error('Erro ao criar gráfico de Rotas:', error);
		}
	}

	// Função para criar gráfico Tempo médio por etapa (onde as coletas estão ficando mais tempo)
	function criarGraficoTempoPorEtapa(dados){
		try {
			const ctx = document.getElementById('chartTempoPorEtapa');
			if (!ctx || typeof Chart === 'undefined' || Object.keys(dados).length === 0) return;
			const colors = getChartColors();
			const entries = Object.entries(dados).sort((a, b) => b[1] - a[1]); // [ [etapaRaw, mediaMin], ... ]
			const labelsDisplay = entries.map(([et]) => et.charAt(0).toUpperCase() + et.slice(1).replace(/_/g, ' '));
			const formatTempo = (min) => {
				if (min < 60) return min + ' min';
				const h = Math.floor(min / 60);
				const m = min % 60;
				return (h + 'h ' + (m > 0 ? m + 'min' : '')).trim();
			};
			if (chartTempoPorEtapa) chartTempoPorEtapa.destroy();
			chartTempoPorEtapa = ensureChart('chartTempoPorEtapa', 'bar', {
				labels: labelsDisplay,
				datasets: [{
					label: 'Tempo médio (min)',
					data: entries.map(e => e[1]),
					backgroundColor: entries.map((_, i) => {
						const r = 245 - Math.min(i * 12, 100);
						const g = 158 - Math.min(i * 8, 80);
						const b = 11;
						return `rgba(${r},${g},${b},0.85)`;
					}),
					borderColor: '#f59e0b',
					borderWidth: 2
				}]
			}, {
				indexAxis: 'y',
				responsive: true,
				maintainAspectRatio: false,
				plugins: {
					legend: { display: false },
					tooltip: {
						callbacks: {
							label: function(context) {
								const min = context.parsed.x;
								return ' Média: ' + formatTempo(min);
							}
						}
					}
				},
				onClick: (event, elements) => {
					if (elements.length > 0) {
						const idx = elements[0].index;
						const etapa = entries[idx][0];
						const valor = entries[idx][1];
						const totalEtapas = Object.values(dados).reduce((s, v) => s + v, 0);
						const pct = totalEtapas > 0 ? ((valor / totalEtapas) * 100).toFixed(1) : 0;
						mostrarDetalhesColetas('Etapa', etapa, valor, pct, dados);
					}
				},
				onHover: (event, elements) => {
					event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
				},
				scales: {
					x: {
						beginAtZero: true,
						ticks: {
							color: colors.textColor,
							callback: function(v) { return formatTempo(v); }
						},
						grid: { color: colors.gridColor }
					},
					y: {
						ticks: { color: colors.textColor },
						grid: { color: colors.gridColor }
					}
				}
			});
			console.log('Gráfico Tempo por Etapa criado com sucesso');
		} catch (error) {
			console.error('Erro ao criar gráfico Tempo por Etapa:', error);
		}
	}

	// Função para criar gráfico de Valores Mensal
	function criarGraficoValoresMensal(dados){
		try {
			const ctx = document.getElementById('chartValoresMensal');
			if (!ctx || typeof Chart === 'undefined' || Object.keys(dados).length === 0) return;
			
			const colors = getChartColors();
			const entries = Object.entries(dados).sort((a, b) => {
				const [mesA, anoA] = a[0].split('/');
				const [mesB, anoB] = b[0].split('/');
				if (anoA !== anoB) return anoA.localeCompare(anoB);
				const meses = ['jan', 'fev', 'mar', 'abr', 'mai', 'jun', 'jul', 'ago', 'set', 'out', 'nov', 'dez'];
				return meses.indexOf(mesA) - meses.indexOf(mesB);
			});
			
			if (chartValoresMensal) chartValoresMensal.destroy();
			
			chartValoresMensal = ensureChart('chartValoresMensal', 'line', {
				labels: entries.map(e => e[0]),
				datasets: [{
					label: 'Valor Total (R$)',
					data: entries.map(e => parseFloat(e[1])),
					borderColor: '#22c55e',
					backgroundColor: 'rgba(34, 197, 94, 0.1)',
					borderWidth: 3,
					fill: true,
					tension: 0.4,
					pointRadius: 6,
					pointHoverRadius: 10
				}]
			}, {
				responsive: true,
				maintainAspectRatio: false,
				plugins: {
					legend: { display: true, labels: { color: colors.legendColor } },
					tooltip: {
						callbacks: {
							label: function(context) {
								return `R$ ${context.parsed.y.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
							}
						}
					}
				},
				onClick: (event, elements) => {
					if (elements.length > 0) {
						const idx = elements[0].index;
						const mesAno = entries[idx][0];
						const valorR = entries[idx][1];
						mostrarDetalhesColetas('Mês', mesAno, 0, 0, dados);
					}
				},
				onHover: (event, elements) => {
					event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
				},
				scales: {
					y: {
						beginAtZero: true,
						ticks: { color: colors.textColor, callback: function(v) { return 'R$ ' + v.toLocaleString('pt-BR'); } },
						grid: { color: colors.gridColor }
					},
					x: { ticks: { color: colors.textColor }, grid: { color: colors.gridColor } }
				}
			});
		console.log('Gráfico de Valores Mensal criado com sucesso');
		} catch (error) {
			console.error('Erro ao criar gráfico de Valores Mensal:', error);
		}
	}

	// Função para atualizar tabela de coletas (relatório detalhado)
	function atualizarTabelaColetas(coletas){
		const tbody = document.getElementById('tabelaRelatorio');
		if (!tbody) return;

		if (coletas.length === 0) {
			tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-4">Nenhuma coleta encontrada</td></tr>';
			return;
		}

		// Ordenar por data mais recente e limitar a 200 registros
		const coletasOrdenadas = [...coletas].sort((a, b) => {
			const dataA = new Date(a.created_at || 0);
			const dataB = new Date(b.created_at || 0);
			return dataB - dataA;
		}).slice(0, 200);

		const fmtValor = (v) => (v != null && parseFloat(v) > 0) 
			? 'R$ ' + parseFloat(v).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) 
			: '-';
		const resultadoBadge = (r) => {
			if (!r) return '<span class="text-muted">-</span>';
			if (r === 'ganhou') return '<span class="badge bg-success">Ganhou</span>';
			if (r === 'perdeu') return '<span class="badge bg-danger">Perdeu</span>';
			return '<span class="badge bg-secondary">' + r + '</span>';
		};

		tbody.innerHTML = coletasOrdenadas.map(coleta => {
			const data = coleta.created_at ? new Date(coleta.created_at).toLocaleDateString('pt-BR') : '-';
			const statusBadge = {
				pendente: '<span class="badge bg-warning">Pendente</span>',
				em_andamento: '<span class="badge bg-info">Em Andamento</span>',
				concluida: '<span class="badge bg-success">Concluída</span>',
				cancelada: '<span class="badge bg-danger">Cancelada</span>'
			}[coleta.status] || '<span class="badge bg-secondary">' + (coleta.status || 'N/A') + '</span>';
			const etapa = coleta.etapa_atual ? coleta.etapa_atual.charAt(0).toUpperCase() + coleta.etapa_atual.slice(1).replace(/_/g, ' ') : '-';
			const identificacao = coleta.filial && coleta.numero_coleta 
				? coleta.filial + ' #' + coleta.numero_coleta 
				: (coleta.id ? coleta.id.substring(0, 8) : '-');

			return '<tr><td>' + identificacao + '</td><td>' + (coleta.cliente || '-') + '</td><td>' + (coleta.origem || '-') + ' → ' + (coleta.destino || '-') + '</td><td>' + statusBadge + '</td><td>' + etapa + '</td><td>' + fmtValor(coleta.valor) + '</td><td>' + resultadoBadge(coleta.resultado_final) + '</td><td>' + data + '</td></tr>';
		}).join('');
	}

	// Função para aplicar filtros (chamada pelo botão)
	function aplicarFiltros(){
		carregarColetasBI();
	}

	// Exportar relatório de coletas em CSV
	function exportarColetasCSV(){
		if (!ultimasColetasBI || ultimasColetasBI.length === 0) {
			alert('Nenhum dado para exportar. Aplique os filtros e aguarde o carregamento.');
			return;
		}
		const v = (x) => (x == null || x === undefined) ? '' : String(x).replace(/;/g, ',').replace(/\n/g, ' ');
		const header = 'Filial;Nº Coleta;Cliente;Origem;Destino;Status;Etapa;Valor;Resultado;Data\n';
		const csv = header + ultimasColetasBI.map(c => 
			[ v(c.filial), v(c.numero_coleta), v(c.cliente), v(c.origem), v(c.destino), v(c.status), v(c.etapa_atual), v(c.valor), v(c.resultado_final), c.created_at ? new Date(c.created_at).toLocaleDateString('pt-BR') : '' ].join(';')
		).join('\n');
		const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8' });
		const a = document.createElement('a');
		a.href = URL.createObjectURL(blob);
		a.download = 'relatorio_coletas_' + new Date().toISOString().slice(0,10) + '.csv';
		a.click();
		URL.revokeObjectURL(a.href);
	}

	// Limpar todos os filtros do BI de Coletas e recarregar
	function limparFiltrosColetas(){
		const el = (id) => document.getElementById(id);
		if (el('filtroPeriodo')) el('filtroPeriodo').value = 'todos';
		if (el('filtroUsuario')) el('filtroUsuario').value = '';
		if (el('filtroFilial')) el('filtroFilial').value = '';
		if (el('filtroCliente')) el('filtroCliente').value = '';
		if (el('filtroTipoVeiculo')) el('filtroTipoVeiculo').value = '';
		if (el('filtroTipoCarroceria')) el('filtroTipoCarroceria').value = '';
		if (el('filtroColetaEspecifica')) el('filtroColetaEspecifica').value = '';
		if (el('filtroDataInicioColetas')) el('filtroDataInicioColetas').value = '';
		if (el('filtroDataFimColetas')) el('filtroDataFimColetas').value = '';
		atualizarVisibilidadeDatasColetas();
		carregarColetasBI();
	}

	// Variável global para armazenar dados das coletas
	let coletasDetalhes = [];

	// Função para mostrar detalhes ao clicar no gráfico
	async function mostrarDetalhesColetas(tipo, valor, quantidade, porcentagem, dadosCompletos) {
		try {
			const modal = new bootstrap.Modal(document.getElementById('modalDetalhesColetas'));
			const titulo = document.getElementById('modalColetasTitulo');
			const conteudo = document.getElementById('modalColetasConteudo');
			
			// Atualizar título
			titulo.textContent = `Detalhes - ${tipo}: ${valor}`;
			
			// Mostrar loading
			conteudo.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">Carregando detalhes...</p></div>';
			modal.show();
			
			// Buscar coletas filtradas
			const sb = await getSupabaseClientRel();
			if (!sb) {
				conteudo.innerHTML = '<p class="text-danger">Erro ao conectar com o banco de dados.</p>';
				return;
			}

			// Obter filtros atuais
			const periodo = document.getElementById('filtroPeriodo')?.value || 'todos';
			const usuarioId = document.getElementById('filtroUsuario')?.value || '';
			const filial = document.getElementById('filtroFilial')?.value || '';
			const cliente = document.getElementById('filtroCliente')?.value || '';
			const tipoVeiculo = document.getElementById('filtroTipoVeiculo')?.value || '';
			const tipoCarroceria = document.getElementById('filtroTipoCarroceria')?.value || '';
			
			const range = periodoToRangeColetas(periodo);
			
			// Construir query
			let query = sb.from('coletas').select('*');
			
			// Aplicar filtros
			if (range.inicio) {
				query = query.gte('created_at', range.inicio.toISOString());
			}
			if (range.fim) {
				query = query.lte('created_at', range.fim.toISOString());
			}
			if (usuarioId) {
				query = query.eq('created_by', usuarioId);
			}
			if (filial) {
				query = query.eq('filial', filial);
			}
			if (cliente) {
				query = query.eq('cliente', cliente);
			}

			const { data: coletas, error } = await query;

			if (error) {
				conteudo.innerHTML = `<p class="text-danger">Erro ao carregar dados: ${error.message}</p>`;
				return;
			}

			// Filtrar por tipo específico
			let coletasFiltradas = coletas || [];
			
			if (tipoVeiculo) {
				coletasFiltradas = coletasFiltradas.filter(c => 
					c.tipos_veiculo && Array.isArray(c.tipos_veiculo) && c.tipos_veiculo.includes(tipoVeiculo)
				);
			}
			
			if (tipoCarroceria) {
				coletasFiltradas = coletasFiltradas.filter(c => 
					c.tipos_carroceria && Array.isArray(c.tipos_carroceria) && c.tipos_carroceria.includes(tipoCarroceria)
				);
			}

			// Filtrar pelo valor específico do gráfico
			let coletasSelecionadas = [];
			switch(tipo) {
				case 'Status':
					coletasSelecionadas = coletasFiltradas.filter(c => c.status === valor);
					break;
				case 'Prioridade':
					coletasSelecionadas = coletasFiltradas.filter(c => c.prioridade === valor);
					break;
				case 'Filial':
					coletasSelecionadas = coletasFiltradas.filter(c => c.filial === valor);
					break;
				case 'Tipo de Veículo':
					coletasSelecionadas = coletasFiltradas.filter(c => 
						c.tipos_veiculo && Array.isArray(c.tipos_veiculo) && c.tipos_veiculo.includes(valor)
					);
					break;
				case 'Tipo de Carroceria':
					coletasSelecionadas = coletasFiltradas.filter(c => 
						c.tipos_carroceria && Array.isArray(c.tipos_carroceria) && c.tipos_carroceria.includes(valor)
					);
					break;
				case 'Resultado Final':
					coletasSelecionadas = coletasFiltradas.filter(c => c.resultado_final === valor);
					break;
				case 'Mês':
					// valor é "jan/2024" ou similar — filtrar por created_at no mês/ano
					{
						const mesesPt = ['jan','fev','mar','abr','mai','jun','jul','ago','set','out','nov','dez'];
						const partes = String(valor).split('/');
						const mesIdx = mesesPt.indexOf((partes[0] || '').toLowerCase());
						const ano = parseInt(partes[1], 10) || new Date().getFullYear();
						if (mesIdx >= 0) {
							const mesInicio = new Date(ano, mesIdx, 1);
							const mesFim = new Date(ano, mesIdx + 1, 0, 23, 59, 59, 999);
							coletasSelecionadas = coletasFiltradas.filter(c => {
								const d = c.created_at ? new Date(c.created_at) : null;
								return d && d >= mesInicio && d <= mesFim;
							});
						} else {
							coletasSelecionadas = coletasFiltradas;
						}
					}
					break;
				case 'Usuário':
					coletasSelecionadas = coletasFiltradas.filter(c => String(c.created_by || '') === String(valor));
					break;
				case 'Cliente':
					coletasSelecionadas = coletasFiltradas.filter(c => (c.cliente || 'Não informado') === valor);
					break;
				case 'Etapa':
					coletasSelecionadas = coletasFiltradas.filter(c => (c.etapa_atual || 'Não informada') === valor);
					break;
				case 'Rota':
					coletasSelecionadas = coletasFiltradas.filter(c => 
						((c.origem || '-') + ' → ' + (c.destino || '-')) === valor
					);
					break;
				default:
					coletasSelecionadas = coletasFiltradas;
			}

			// Ordenar por data mais recente
			coletasSelecionadas.sort((a, b) => {
				const dataA = new Date(a.created_at || 0);
				const dataB = new Date(b.created_at || 0);
				return dataB - dataA;
			});

			const totalFiltrado = coletasFiltradas.length;
			const qtdExibir = coletasSelecionadas.length;
			const pctExibir = totalFiltrado > 0 ? ((qtdExibir / totalFiltrado) * 100).toFixed(1) : (porcentagem || 0);
			// Gerar HTML do conteúdo (usa sempre os counts reais do resultado)
			let html = `
				<div class="mb-4">
					<div class="row g-3">
						<div class="col-md-4">
							<div class="card-futuristic p-3 text-center">
								<div class="metric-value" style="font-size: 2rem;">${qtdExibir}</div>
								<div class="metric-label">Total de Coletas</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="card-futuristic p-3 text-center">
								<div class="metric-value" style="font-size: 2rem;">${pctExibir}%</div>
								<div class="metric-label">Percentual</div>
							</div>
						</div>
						<div class="col-md-4">
							<div class="card-futuristic p-3 text-center">
								<div class="metric-value" style="font-size: 2rem;">${qtdExibir}</div>
								<div class="metric-label">Registros Encontrados</div>
							</div>
						</div>
					</div>
				</div>
				<div class="table-responsive">
					<table class="table table-tech">
						<thead>
							<tr>
								<th>ID</th>
								<th>Cliente</th>
								<th>Filial</th>
								<th>Origem → Destino</th>
								<th>Status</th>
								<th>Etapa</th>
								<th>Data</th>
							</tr>
						</thead>
						<tbody>
			`;

			if (coletasSelecionadas.length === 0) {
				html += '<tr><td colspan="7" class="text-center py-4">Nenhuma coleta encontrada</td></tr>';
			} else {
				coletasSelecionadas.slice(0, 50).forEach(coleta => {
					const data = coleta.created_at ? new Date(coleta.created_at).toLocaleDateString('pt-BR') : '-';
					const statusBadge = {
						pendente: '<span class="badge bg-warning">Pendente</span>',
						em_andamento: '<span class="badge bg-info">Em Andamento</span>',
						concluida: '<span class="badge bg-success">Concluída</span>',
						cancelada: '<span class="badge bg-danger">Cancelada</span>'
					}[coleta.status] || `<span class="badge bg-secondary">${coleta.status || 'N/A'}</span>`;

					const etapa = coleta.etapa_atual ? coleta.etapa_atual.charAt(0).toUpperCase() + coleta.etapa_atual.slice(1).replace('_', ' ') : '-';
					const identificacao = coleta.filial && coleta.numero_coleta 
						? `${coleta.filial} #${coleta.numero_coleta}` 
						: coleta.id?.substring(0, 8) || '-';

					html += `
						<tr>
							<td>${identificacao}</td>
							<td>${coleta.cliente || '-'}</td>
							<td>${coleta.filial || '-'}</td>
							<td>${coleta.origem || '-'} → ${coleta.destino || '-'}</td>
							<td>${statusBadge}</td>
							<td>${etapa}</td>
							<td>${data}</td>
						</tr>
					`;
				});

				if (coletasSelecionadas.length > 50) {
					html += `<tr><td colspan="7" class="text-center py-2 text-muted">Mostrando 50 de ${coletasSelecionadas.length} registros</td></tr>`;
				}
			}

			html += `
						</tbody>
					</table>
				</div>
			`;

			conteudo.innerHTML = html;
			coletasDetalhes = coletasSelecionadas;
		} catch (error) {
			console.error('Erro ao mostrar detalhes:', error);
			const conteudo = document.getElementById('modalColetasConteudo');
			conteudo.innerHTML = `<p class="text-danger">Erro ao carregar detalhes: ${error.message}</p>`;
		}
	}

	// Tornar funções acessíveis globalmente
	window.mostrarDetalhesColetas = mostrarDetalhesColetas;

	// Tornar funções acessíveis globalmente (BI Coletas)
	window.aplicarFiltros = aplicarFiltros;
	window.carregarColetasBI = carregarColetasBI;
	window.atualizarVisibilidadeDatasColetas = atualizarVisibilidadeDatasColetas;
	window.exportarColetasCSV = exportarColetasCSV;
	window.limparFiltrosColetas = limparFiltrosColetas;

	// ====== MOTORISTAS - FILTROS E CARGA ======
	let chartUsuarioMot = null, chartDepartamentoMot = null, chartTemporalMot = null;

	// Função periodoToRange já está definida acima (linha 1525)

	function atualizarVisibilidadeDatasMot(){
		const periodo = document.getElementById('filtroPeriodoMot')?.value;
		const containerInicio = document.getElementById('containerDataInicioMot');
		const containerFim = document.getElementById('containerDataFimMot');
		if(periodo === 'personalizado'){
			if(containerInicio) containerInicio.style.display = '';
			if(containerFim) containerFim.style.display = '';
		} else {
			if(containerInicio) containerInicio.style.display = 'none';
			if(containerFim) containerFim.style.display = 'none';
		}
	}

	async function carregarFiltrosMotoristas(){
		const resp = await fetch('/api/relatorios/motoristas/filtros', { credentials: 'include' });
		if(handleUnauthorized(resp)) return;
		if(!resp.ok) return;
		const json = await resp.json();
		const usuarios = json.usuarios || [];
		const departamentos = json.departamentos || [];
		const selUsuario = document.getElementById('filtroUsuarioMot');
		const selDept = document.getElementById('filtroDepartamentoMot');
		if(selUsuario){
			selUsuario.innerHTML = '<option value="">Todos os usuários</option>' +
			usuarios.map(u=>`<option value="${u.id}">${u.nome||u.id}</option>`).join('');
		}
		if(selDept){
			selDept.innerHTML = '<option value="">Todos os departamentos</option>' +
			departamentos.map(d=>`<option value="${d}">${d}</option>`).join('');
		}
	}

	// Função para obter cores dos gráficos baseado no tema
	function getChartColors(){
		const isLight = document.body.classList.contains('light-mode');
		return {
			textColor: isLight ? 'rgba(15,23,42,0.8)' : 'rgba(255,255,255,0.7)',
			gridColor: isLight ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)',
			dataLabelColor: isLight ? '#0f172a' : '#fff',
			legendColor: isLight ? 'rgba(15,23,42,0.9)' : 'rgba(255,255,255,0.9)'
		};
	}

	// ========== TEMA TECNOLÓGICO PARA GRÁFICOS ==========
	const TECH_CHART_PALETTE = [
		'#06b6d4', '#8b5cf6', '#ec4899', '#10b981', '#f59e0b',
		'#6366f1', '#14b8a6', '#f43f5e', '#0ea5e9', '#a855f7'
	];

	function createBarGradient(ctx, chartArea, color1, color2) {
		if (!chartArea) return color1;
		const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
		gradient.addColorStop(0, color2 || color1);
		gradient.addColorStop(1, color1);
		return gradient;
	}

	function techBarBackground(color1, color2) {
		return function(context) {
			const chart = context.chart;
			const { ctx, chartArea } = chart;
			return createBarGradient(ctx, chartArea, color1 || '#06b6d4', color2 || '#6366f1');
		};
	}

	function getTechChartDefaults(type) {
		const colors = getChartColors();
		const base = {
			responsive: true,
			maintainAspectRatio: false,
			animation: { duration: 800 },
			layout: {
				padding: { left: 5, right: 15, top: 15, bottom: 5 }
			},
			plugins: {
				legend: {
					labels: {
						color: colors.legendColor,
						font: { size: 12, weight: '600', family: '"Inter", "Segoe UI", sans-serif' },
						padding: 16,
						usePointStyle: true
					}
				},
				tooltip: {
					backgroundColor: 'rgba(15, 23, 42, 0.92)',
					titleColor: '#fff',
					bodyColor: '#e2e8f0',
					borderColor: 'rgba(6, 182, 212, 0.5)',
					borderWidth: 1,
					padding: 12,
					cornerRadius: 8,
					titleFont: { size: 13, weight: '600' },
					bodyFont: { size: 12 }
				}
			},
			scales: type === 'bar' || type === 'line' ? {
				x: {
					grid: { color: 'rgba(255,255,255,0.06)', drawBorder: false },
					ticks: { color: colors.textColor, font: { size: 11 }, maxRotation: 45 }
				},
				y: {
					beginAtZero: true,
					grid: { color: 'rgba(255,255,255,0.06)', drawBorder: false },
					ticks: { color: colors.textColor, font: { size: 11 } }
				}
			} : undefined
		};
		if (type === 'bar') {
			base.datasets = base.datasets || {};
			base.datasets.bar = {
				borderRadius: 6,
				borderSkipped: false,
				barPercentage: 0.8,
				categoryPercentage: 0.7,
				barThickness: 'flex',
				maxBarThickness: 50
			};
		}
		if (type === 'line') {
			base.datasets = base.datasets || {};
			base.datasets.line = {
				tension: 0.4,
				pointRadius: 5,
				pointHoverRadius: 8,
				pointBackgroundColor: '#fff',
				pointBorderWidth: 2
			};
		}
		return base;
	}

	// Plugin para exibir os valores nos gráficos (pie, doughnut, bar, line) — legível e elegante
	function formatarValorGrafico(value) {
		if (value === null || value === undefined) return '';
		if (typeof value !== 'number') return String(value);
		if (value >= 1000000) return (value / 1000000).toFixed(1).replace('.', ',') + 'M';
		if (value >= 1000) return (value / 1000).toFixed(1).replace('.', ',') + 'k';
		if (Number.isInteger(value)) return value.toLocaleString('pt-BR');
		return value.toLocaleString('pt-BR', { minimumFractionDigits: 1, maximumFractionDigits: 1 });
	}

	function desenharLabelComFundo(ctx, text, x, y, opts) {
		opts = opts || {};
		const padding = opts.padding !== undefined ? opts.padding : 6;
		const radius = opts.radius !== undefined ? opts.radius : 4;
		const font = opts.font || '600 11px "Segoe UI", Tahoma, sans-serif';
		const fillStyle = opts.fillStyle || 'rgba(255,255,255,0.95)';
		const strokeStyle = opts.strokeStyle || 'rgba(0,0,0,0.15)';
		const textStyle = opts.textStyle || '#1e293b';
		ctx.save();
		ctx.font = font;
		const m = ctx.measureText(text);
		const w = m.width + padding * 2;
		const h = 20;
		const tx = x;
		const ty = y - (opts.offsetY || 0);
		const left = tx - w/2, top = ty - h/2;
		ctx.beginPath();
		ctx.moveTo(left + radius, top);
		ctx.lineTo(left + w - radius, top);
		ctx.quadraticCurveTo(left + w, top, left + w, top + radius);
		ctx.lineTo(left + w, top + h - radius);
		ctx.quadraticCurveTo(left + w, top + h, left + w - radius, top + h);
		ctx.lineTo(left + radius, top + h);
		ctx.quadraticCurveTo(left, top + h, left, top + h - radius);
		ctx.lineTo(left, top + radius);
		ctx.quadraticCurveTo(left, top, left + radius, top);
		ctx.closePath();
		ctx.fillStyle = fillStyle;
		ctx.fill();
		ctx.strokeStyle = strokeStyle;
		ctx.lineWidth = 1;
		ctx.stroke();
		ctx.fillStyle = textStyle;
		ctx.textAlign = 'center';
		ctx.textBaseline = 'middle';
		ctx.fillText(text, tx, ty);
		ctx.restore();
	}

	const pluginDatalabelsValores = {
		id: 'datalabelsValores',
		afterDatasetsDraw(chart) {
			const ctx = chart.ctx;
			const type = chart.config.type;

			ctx.save();
			chart.data.datasets.forEach((dataset, datasetIndex) => {
				const meta = chart.getDatasetMeta(datasetIndex);
				if (!meta.data || meta.hidden) return;
				meta.data.forEach((element, index) => {
					const value = dataset.data[index];
					if (value === null || value === undefined) return;
					const text = formatarValorGrafico(value);

					if (type === 'pie' || type === 'doughnut') {
						const arc = element;
						const sweep = arc.endAngle - arc.startAngle;
						if (sweep < 0.25) return; // fatia muito pequena: não desenhar para não sobrepor
						const midAngle = (arc.startAngle + arc.endAngle) / 2;
						const midR = (arc.outerRadius + arc.innerRadius) / 2;
						const tx = arc.x + Math.cos(midAngle) * midR;
						const ty = arc.y + Math.sin(midAngle) * midR;
						ctx.font = type === 'doughnut' ? '600 10px "Segoe UI", Tahoma, sans-serif' : '600 11px "Segoe UI", Tahoma, sans-serif';
						ctx.fillStyle = '#fff';
						ctx.strokeStyle = 'rgba(0,0,0,0.2)';
						ctx.lineWidth = 2;
						ctx.textAlign = 'center';
						ctx.textBaseline = 'middle';
						ctx.strokeText(text, tx, ty);
						ctx.fillText(text, tx, ty);
					} else if (type === 'bar') {
						const isVertical = element.base !== undefined;
						const x = element.x;
						const y = element.y;
						const base = element.base ?? y;
						// Valores DENTRO da barra para o clique ainda acionar o elemento (abrir modal)
						const barTop = Math.min(y, base);
						const barBottom = Math.max(y, base);
						const labelY = isVertical ? barTop + 12 : y;
						const labelX = isVertical ? x : barBottom + 14;
						const isLight = document.body.classList.contains('light-mode');
						desenharLabelComFundo(ctx, text, labelX, labelY, {
							offsetY: 0,
							fillStyle: isLight ? 'rgba(255,255,255,0.98)' : 'rgba(30,41,59,0.95)',
							strokeStyle: isLight ? 'rgba(0,0,0,0.08)' : 'rgba(255,255,255,0.2)',
							textStyle: isLight ? '#1e293b' : '#f1f5f9',
							font: '600 11px "Segoe UI", Tahoma, sans-serif'
						});
					} else if (type === 'line') {
						const isLight = document.body.classList.contains('light-mode');
						// Label mais próximo do ponto para não “roubar” o clique
						desenharLabelComFundo(ctx, text, element.x, element.y - 12, {
							offsetY: 0,
							fillStyle: isLight ? 'rgba(255,255,255,0.98)' : 'rgba(30,41,59,0.95)',
							strokeStyle: isLight ? 'rgba(0,0,0,0.08)' : 'rgba(255,255,255,0.2)',
							textStyle: isLight ? '#1e293b' : '#f1f5f9',
							font: '600 10px "Segoe UI", Tahoma, sans-serif'
						});
					}
				});
			});
			ctx.restore();
		}
	};

	function ensureChart(ctxId, type, data, options){
		const ctx = document.getElementById(ctxId);
		if(!ctx) return null;
		if(ctx._chart){ ctx._chart.destroy(); }
		const opts = options || {};
		const techDefaults = getTechChartDefaults(type);
		const plugins = { ...(techDefaults.plugins || {}), ...(opts.plugins || {}), pluginDatalabelsValores };
		const merged = {
			...techDefaults,
			...opts,
			plugins,
			scales: opts.scales || techDefaults.scales,
			datasets: { ...(techDefaults.datasets || {}), ...(opts.datasets || {}) }
		};
		ctx._chart = new Chart(ctx, { type, data, ...merged });
		return ctx._chart;
	}

	async function carregarMotoristas(){
		const overlay = document.getElementById('loadingOverlay');
		if(overlay) overlay.style.display = 'flex';
		try{
			const periodo = document.getElementById('filtroPeriodoMot')?.value || 'mes';
			const usuarioId = document.getElementById('filtroUsuarioMot')?.value || '';
			const departamento = document.getElementById('filtroDepartamentoMot')?.value || '';
			let range;
			if(periodo === 'personalizado'){
				const dataInicio = document.getElementById('filtroDataInicioMot')?.value;
				const dataFim = document.getElementById('filtroDataFimMot')?.value;
				range = {
					inicio: dataInicio ? new Date(dataInicio + 'T00:00:00') : null,
					fim: dataFim ? new Date(dataFim + 'T23:59:59') : null
				};
			} else {
				range = periodoToRange(periodo);
			}
			const params = new URLSearchParams({
				inicio: range.inicio ? range.inicio.toISOString() : '',
				fim: range.fim ? range.fim.toISOString() : '',
				usuarioId,
				departamento
			});
			const [kpiResp, seriesResp] = await Promise.all([
				fetch(`/api/relatorios/motoristas/kpis?${params}`, { credentials:'include' }),
				fetch(`/api/relatorios/motoristas/series?${params}`, { credentials:'include' })
			]);
			if(handleUnauthorized(kpiResp) || handleUnauthorized(seriesResp)) return;
			if(kpiResp.ok){
				const k = await kpiResp.json();
				document.getElementById('kpiTotalMot').innerText = (k.total||0).toString();
				document.getElementById('kpiUsuariosMot').innerText = (k.usuarios||0).toString();
				document.getElementById('kpiDepartamentosMot').innerText = (k.departamentos||0).toString();
			}
			if(seriesResp.ok){
				const s = await seriesResp.json();
				const ctxUserMot = document.getElementById('chartUsuarioMot');
				const ctxDeptMot = document.getElementById('chartDepartamentoMot');
				const ctxDayMot = document.getElementById('chartTemporalMot');
				
				if(ctxUserMot){
					if(ctxUserMot._chart) ctxUserMot._chart.destroy();
					const colors = getChartColors();
					ctxUserMot._chart = new Chart(ctxUserMot, {
						type:'bar',
						data:{ 
							labels: (s.byUser||[]).map(u=>u.nome),
							datasets:[{ label:'Motoristas', data: (s.byUser||[]).map(u=>u.count), backgroundColor:'#667eea' }]
						},
						options:{ 
							responsive:true, 
							maintainAspectRatio:false,
							plugins:{ legend:{ display:false }},
							scales: {
								y: {
									beginAtZero: true,
									ticks: { color: colors.textColor },
									grid: { color: colors.gridColor }
								},
								x: {
									ticks: { color: colors.textColor },
									grid: { color: colors.gridColor }
								}
							}
						},
						plugins: [{
							id: 'datalabels',
							afterDatasetsDraw: (chart) => {
								const ctx = chart.ctx;
								chart.data.datasets.forEach((dataset, i) => {
									const meta = chart.getDatasetMeta(i);
									meta.data.forEach((element, index) => {
										const value = dataset.data[index];
										if (value !== null && value !== undefined && value !== 0) {
											ctx.save();
											ctx.fillStyle = colors.dataLabelColor;
											ctx.font = 'bold 12px Arial';
											ctx.textAlign = 'center';
											ctx.textBaseline = 'bottom';
											const position = element.tooltipPosition();
											const valueStr = String(value);
											ctx.fillText(valueStr, position.x, position.y - 5);
											ctx.restore();
										}
									});
								});
							}
						}]
					});
				}
				
				if(ctxDeptMot){
					if(ctxDeptMot._chart) ctxDeptMot._chart.destroy();
					const colors = getChartColors();
					ctxDeptMot._chart = new Chart(ctxDeptMot, {
						type:'bar',
						data:{ 
							labels: (s.byDepartment||[]).map(d=>d.departamento),
							datasets:[{ label:'Motoristas', data: (s.byDepartment||[]).map(d=>d.count), backgroundColor:'#22c55e' }]
						},
						options:{ 
							responsive:true, 
							maintainAspectRatio:false,
							plugins:{ legend:{ display:false }},
							scales: {
								y: {
									beginAtZero: true,
									ticks: { color: colors.textColor },
									grid: { color: colors.gridColor }
								},
								x: {
									ticks: { color: colors.textColor },
									grid: { color: colors.gridColor }
								}
							}
						},
						plugins: [{
							id: 'datalabels',
							afterDatasetsDraw: (chart) => {
								const ctx = chart.ctx;
								chart.data.datasets.forEach((dataset, i) => {
									const meta = chart.getDatasetMeta(i);
									meta.data.forEach((element, index) => {
										const value = dataset.data[index];
										if (value !== null && value !== undefined && value !== 0) {
											ctx.save();
											ctx.fillStyle = colors.dataLabelColor;
											ctx.font = 'bold 12px Arial';
											ctx.textAlign = 'center';
											ctx.textBaseline = 'bottom';
											const position = element.tooltipPosition();
											const valueStr = String(value);
											ctx.fillText(valueStr, position.x, position.y - 5);
											ctx.restore();
										}
									});
								});
							}
						}]
					});
				}
				
				if(ctxDayMot){
					if(ctxDayMot._chart) ctxDayMot._chart.destroy();
					const colors = getChartColors();
					ctxDayMot._chart = new Chart(ctxDayMot, {
						type:'line',
						data:{ 
							labels: (s.byDay||[]).map(d=>d.date),
							datasets:[{ label:'Cadastros', data: (s.byDay||[]).map(d=>d.count), borderColor:'#f59e0b', backgroundColor:'rgba(245,158,11,0.25)', fill:true, tension:0.3, pointRadius: 5, pointHoverRadius: 7 }]
						},
						options:{ 
							responsive:true,
							maintainAspectRatio:false,
							plugins: {
								legend: { display: true, labels: { color: colors.legendColor } }
							},
							scales: {
								y: {
									beginAtZero: true,
									ticks: { color: colors.textColor },
									grid: { color: colors.gridColor }
								},
								x: {
									ticks: { color: colors.textColor },
									grid: { color: colors.gridColor }
								}
							}
						},
						plugins: [{
							id: 'datalabels',
							afterDatasetsDraw: (chart) => {
								const ctx = chart.ctx;
								chart.data.datasets.forEach((dataset, i) => {
									const meta = chart.getDatasetMeta(i);
									meta.data.forEach((element, index) => {
										const value = dataset.data[index];
										if (value !== null && value !== undefined && value !== 0) {
											ctx.save();
											ctx.fillStyle = colors.dataLabelColor;
											ctx.font = 'bold 11px Arial';
											ctx.textAlign = 'center';
											ctx.textBaseline = 'bottom';
											const position = element.tooltipPosition();
											const valueStr = String(value);
											ctx.fillText(valueStr, position.x, position.y - 8);
											ctx.restore();
										}
									});
								});
							}
						}]
					});
				}
			}
		} finally {
			if(overlay) overlay.style.display = 'none';
		}
	}

    // ====== DISPAROS - FILTROS E CARGA ======
    function atualizarVisibilidadeDatasDisp(){
        const periodo = document.getElementById('filtroPeriodoDisp')?.value;
        const containerInicio = document.getElementById('containerDataInicioDisp');
        const containerFim = document.getElementById('containerDataFimDisp');
        if(periodo === 'personalizado'){
            if(containerInicio) containerInicio.style.display = '';
            if(containerFim) containerFim.style.display = '';
        } else {
            if(containerInicio) containerInicio.style.display = 'none';
            if(containerFim) containerFim.style.display = 'none';
        }
    }

    async function carregarFiltrosDisparos(){
        const resp = await fetch('/api/relatorios/disparos/filtros', { credentials:'include' });
        if(handleUnauthorized(resp)) return;
        if(!resp.ok) return;
        const json = await resp.json();
        const usuarios = json.usuarios || [];
        const departamentos = json.departamentos || [];
        const selUsuario = document.getElementById('filtroUsuarioDisp');
        const selDept = document.getElementById('filtroDepartamentoDisp');
        if(selUsuario){
            selUsuario.innerHTML = '<option value="">Todos os usuários</option>' +
                usuarios.map(u=>`<option value="${u.id}">${u.nome||u.id}</option>`).join('');
        }
        if(selDept){
            selDept.innerHTML = '<option value="">Todos os departamentos</option>' +
                departamentos.map(d=>`<option value="${d}">${d}</option>`).join('');
        }
    }

    async function carregarDisparos(){
        const overlay = document.getElementById('loadingOverlay');
        if(overlay) overlay.style.display = 'flex';
        try {
            const periodo = document.getElementById('filtroPeriodoDisp')?.value || 'mes';
            const usuarioId = document.getElementById('filtroUsuarioDisp')?.value || '';
            const departamento = document.getElementById('filtroDepartamentoDisp')?.value || '';
            let range;
            if(periodo === 'personalizado'){
                const dataInicio = document.getElementById('filtroDataInicioDisp')?.value;
                const dataFim = document.getElementById('filtroDataFimDisp')?.value;
                range = {
                    inicio: dataInicio ? new Date(dataInicio + 'T00:00:00') : null,
                    fim: dataFim ? new Date(dataFim + 'T23:59:59') : null
                };
            } else {
                range = periodoToRange(periodo);
            }
            const params = new URLSearchParams({
                inicio: range.inicio ? range.inicio.toISOString() : '',
                fim: range.fim ? range.fim.toISOString() : '',
                usuarioId,
                departamento
            });
            const [kpiResp, seriesResp] = await Promise.all([
                fetch(`/api/relatorios/disparos/kpis?${params}`, { credentials:'include' }),
                fetch(`/api/relatorios/disparos/series?${params}`, { credentials:'include' })
            ]);
            if(handleUnauthorized(kpiResp) || handleUnauthorized(seriesResp)) return;
            if(kpiResp.ok){
                const k = await kpiResp.json();
                document.getElementById('kpiTotalDisp').innerText = (k.total||0).toString();
                document.getElementById('kpiUsuariosDisp').innerText = (k.usuarios||0).toString();
                document.getElementById('kpiDepartamentosDisp').innerText = (k.departamentos||0).toString();
                if((k.total||0)===0){ console.warn('BI Disparos: nenhum registro no período/filtros atuais'); }
            } else {
                console.error('Erro KPIs disparos:', await kpiResp.text());
            }
            if(seriesResp.ok){
                const s = await seriesResp.json();
                const ctxUser = document.getElementById('chartUsuarioDisp');
                const ctxDept = document.getElementById('chartDepartamentoDisp');
                const ctxDay = document.getElementById('chartTemporalDisp');
                if(ctxUser){
                    if(ctxUser._chart) ctxUser._chart.destroy();
                    const colors = getChartColors();
                    ctxUser._chart = new Chart(ctxUser, {
                        type:'bar',
                        data:{ labels:(s.byUser||[]).map(u=>u.nome), datasets:[{ label:'Disparos', data:(s.byUser||[]).map(u=>u.count), backgroundColor:'#4f46e5' }] },
                        options:{ 
                            responsive:true, 
                            maintainAspectRatio:false,
                            plugins:{ 
                                legend:{ display:false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: colors.textColor },
                                    grid: { color: colors.gridColor }
                                },
                                x: {
                                    ticks: { color: colors.textColor },
                                    grid: { color: colors.gridColor }
                                }
                            }
                        },
                        plugins: [{
                            id: 'datalabels',
                            afterDatasetsDraw: (chart) => {
                                const ctx = chart.ctx;
                                chart.data.datasets.forEach((dataset, i) => {
                                    const meta = chart.getDatasetMeta(i);
                                    meta.data.forEach((element, index) => {
                                        const value = dataset.data[index];
                                        if (value !== null && value !== undefined && value !== 0) {
                                            ctx.save();
                                            ctx.fillStyle = colors.dataLabelColor;
                                            ctx.font = 'bold 12px Arial';
                                            ctx.textAlign = 'center';
                                            ctx.textBaseline = 'bottom';
                                            const position = element.tooltipPosition();
                                            const valueStr = String(value);
                                            ctx.fillText(valueStr, position.x, position.y - 5);
                                            ctx.restore();
                                        }
                                    });
                                });
                            }
                        }]
                    });
                }
                if(ctxDept){
                    if(ctxDept._chart) ctxDept._chart.destroy();
                    const colors = getChartColors();
                    ctxDept._chart = new Chart(ctxDept, {
                        type:'bar',
                        data:{ labels:(s.byDepartment||[]).map(d=>d.departamento), datasets:[{ label:'Disparos', data:(s.byDepartment||[]).map(d=>d.count), backgroundColor:'#10b981' }] },
                        options:{ 
                            responsive:true, 
                            maintainAspectRatio:false,
                            plugins:{ 
                                legend:{ display:false }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: colors.textColor },
                                    grid: { color: colors.gridColor }
                                },
                                x: {
                                    ticks: { color: colors.textColor },
                                    grid: { color: colors.gridColor }
                                }
                            }
                        },
                        plugins: [{
                            id: 'datalabels',
                            afterDatasetsDraw: (chart) => {
                                const ctx = chart.ctx;
                                chart.data.datasets.forEach((dataset, i) => {
                                    const meta = chart.getDatasetMeta(i);
                                    meta.data.forEach((element, index) => {
                                        const value = dataset.data[index];
                                        if (value !== null && value !== undefined && value !== 0) {
                                            ctx.save();
                                            ctx.fillStyle = colors.dataLabelColor;
                                            ctx.font = 'bold 12px Arial';
                                            ctx.textAlign = 'center';
                                            ctx.textBaseline = 'bottom';
                                            const position = element.tooltipPosition();
                                            const valueStr = String(value);
                                            ctx.fillText(valueStr, position.x, position.y - 5);
                                            ctx.restore();
                                        }
                                    });
                                });
                            }
                        }]
                    });
                }
                if(ctxDay){
                    if(ctxDay._chart) ctxDay._chart.destroy();
                    const colors = getChartColors();
                    ctxDay._chart = new Chart(ctxDay, {
                        type:'line',
                        data:{ labels:(s.byDay||[]).map(d=>d.date), datasets:[{ label:'Disparos', data:(s.byDay||[]).map(d=>d.count), borderColor:'#f59e0b', backgroundColor:'rgba(245,158,11,0.25)', fill:true, tension:0.3, pointRadius: 5, pointHoverRadius: 7 }] },
                        options:{ 
                            responsive:true,
                            maintainAspectRatio:false,
                            plugins: {
                                legend: { display: true, labels: { color: colors.legendColor } }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { color: colors.textColor },
                                    grid: { color: colors.gridColor }
                                },
                                x: {
                                    ticks: { color: colors.textColor },
                                    grid: { color: colors.gridColor }
                                }
                            }
                        },
                        plugins: [{
                            id: 'datalabels',
                            afterDatasetsDraw: (chart) => {
                                const ctx = chart.ctx;
                                chart.data.datasets.forEach((dataset, i) => {
                                    const meta = chart.getDatasetMeta(i);
                                    meta.data.forEach((element, index) => {
                                        const value = dataset.data[index];
                                        if (value !== null && value !== undefined && value !== 0) {
                                            ctx.save();
                                            ctx.fillStyle = colors.dataLabelColor;
                                            ctx.font = 'bold 11px Arial';
                                            ctx.textAlign = 'center';
                                            ctx.textBaseline = 'bottom';
                                            const position = element.tooltipPosition();
                                            const valueStr = String(value);
                                            ctx.fillText(valueStr, position.x, position.y - 8);
                                            ctx.restore();
                                        }
                                    });
                                });
                            }
                        }]
                    });
                }
            } else {
                console.error('Erro séries disparos:', await seriesResp.text());
            }
            // Carregar estatísticas de falhas com os mesmos filtros
            await carregarEstatisticasFalhas().catch(err => console.error('Erro ao carregar estatísticas de falhas:', err));
        } catch (error) {
            console.error('Erro ao carregar disparos:', error);
        } finally {
            if(overlay) overlay.style.display = 'none';
        }
    }
    
    // ========== BI GESTÃO DE DADOS ==========
    let chartTipoErroGestao = null, chartOperacaoGestao = null, chartResponsavelGestao = null;
    let chartTemporalGestao = null, chartUsuarioGestao = null;
    
    function atualizarVisibilidadeDatasGestao() {
        const periodo = document.getElementById('filtroPeriodoGestao').value;
        const containerInicio = document.getElementById('containerDataInicioGestao');
        const containerFim = document.getElementById('containerDataFimGestao');
        
        if (containerInicio && containerFim) {
            if (periodo === 'personalizado') {
                containerInicio.style.display = 'block';
                containerFim.style.display = 'block';
            } else {
                containerInicio.style.display = 'none';
                containerFim.style.display = 'none';
            }
        }
    }
    
    function calcularPeriodoGestao() {
        const periodoSelect = document.getElementById('filtroPeriodoGestao');
        const periodo = periodoSelect ? periodoSelect.value : 'todos';
        const hoje = new Date();
        hoje.setHours(23, 59, 59, 999);
        let inicio = null;
        let fim = new Date(hoje);
        
        switch(periodo) {
            case 'hoje':
                inicio = new Date(hoje);
                inicio.setHours(0, 0, 0, 0);
                break;
            case 'semana':
                inicio = new Date(hoje);
                inicio.setDate(inicio.getDate() - 7);
                break;
            case 'mes':
                inicio = new Date(hoje);
                inicio.setDate(inicio.getDate() - 30);
                break;
            case 'trimestre':
                inicio = new Date(hoje);
                inicio.setDate(inicio.getDate() - 90);
                break;
            case 'ano':
                inicio = new Date(hoje);
                inicio.setFullYear(inicio.getFullYear() - 1);
                break;
            case 'personalizado':
                const dataInicio = document.getElementById('filtroDataInicioGestao')?.value;
                const dataFim = document.getElementById('filtroDataFimGestao')?.value;
                if (dataInicio) inicio = new Date(dataInicio);
                if (dataFim) {
                    fim = new Date(dataFim);
                    fim.setHours(23, 59, 59, 999);
                }
                break;
            case 'todos':
            default:
                inicio = null;
                fim = null;
        }
        
        return {
            inicio: inicio ? inicio.toISOString().split('T')[0] : '',
            fim: fim ? fim.toISOString().split('T')[0] : ''
        };
    }
    
    async function carregarBIGestao() {
        const overlay = document.getElementById('loadingOverlay');
        if(overlay) overlay.style.display = 'flex';
        
        try {
            const periodo = calcularPeriodoGestao();
            const operacaoSelect = document.getElementById('filtroOperacaoGestao');
            const operacao = operacaoSelect ? operacaoSelect.value : '';
            
            const params = new URLSearchParams({
                inicio: periodo.inicio || '',
                fim: periodo.fim || ''
            });
            
            if (operacao && operacao.trim() !== '') {
                params.append('operacao', operacao.trim());
            }
            
            console.log('🔍 Carregando BI Gestão - Parâmetros:', { inicio: periodo.inicio, fim: periodo.fim });
            
            // Carregar KPIs
            const kpisResp = await fetch(`/api/relatorios/gestao-dados/kpis?${params}`, { credentials: 'include' });
            
            if (!kpisResp.ok) {
                console.error('❌ Erro ao buscar KPIs:', kpisResp.status, await kpisResp.text());
                throw new Error(`Erro ao buscar KPIs: ${kpisResp.status}`);
            }
            
            let kpisData = null;
            kpisData = await kpisResp.json();
            console.log('📊 KPIs recebidos:', kpisData);
            
            // Atualizar cards de métricas
            document.getElementById('totalLancamentosGestao').textContent = (kpisData.total || 0).toLocaleString('pt-BR');
            document.getElementById('totalEditadosGestao').textContent = (kpisData.totalEditados || 0).toLocaleString('pt-BR');
            document.getElementById('taxaEdicaoGestao').textContent = (kpisData.taxaEdicao || 0) + '%';
            
            const tempoMedio = kpisData.tempoMedioResposta || 0;
            const horas = Math.floor(tempoMedio / 60);
            const minutos = tempoMedio % 60;
            let tempoFormatado = '';
            if (horas > 0) {
                tempoFormatado = `${horas}h ${minutos}min`;
            } else {
                tempoFormatado = `${minutos}min`;
            }
            document.getElementById('tempoMedioRespostaGestao').textContent = tempoFormatado;
            
            // Carregar séries
            const seriesResp = await fetch(`/api/relatorios/gestao-dados/series?${params}`, { credentials: 'include' });
            
            if (!seriesResp.ok) {
                console.error('❌ Erro ao buscar séries:', seriesResp.status, await seriesResp.text());
                throw new Error(`Erro ao buscar séries: ${seriesResp.status}`);
            }
            
            const s = await seriesResp.json();
            console.log('📈 Séries recebidas:', s);
            const colors = getChartColors();
            
            // Gráfico de Tipo de Erro (Doughnut Melhorado)
            const ctxTipoErro = document.getElementById('chartTipoErroGestao');
            if (ctxTipoErro) {
                if (ctxTipoErro._chart) ctxTipoErro._chart.destroy();
                
                const tiposErroData = (s.byTipoErro || []).filter(d => d && d.tipo && d.count > 0).slice(0, 10);
                const totalTipos = tiposErroData.reduce((sum, d) => sum + (d.count || 0), 0);
                
                if (tiposErroData.length > 0) {
                    ctxTipoErro._chart = new Chart(ctxTipoErro, {
                        type: 'doughnut',
                        data: {
                            labels: tiposErroData.map(d => d.tipo.length > 20 ? d.tipo.substring(0, 20) + '...' : d.tipo),
                            datasets: [{
                                data: tiposErroData.map(d => d.count),
                                backgroundColor: [
                                    '#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe',
                                    '#43e97b', '#fa709a', '#fee140', '#30cfd0', '#a8edea'
                                ],
                                borderWidth: 2,
                                borderColor: colors.gridColor
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '60%',
                            layout: {
                                padding: 10
                            },
                            onClick: (event, elements) => {
                                if (elements.length > 0) {
                                    const element = elements[0];
                                    const index = element.index;
                                    const tipoErro = tiposErroData[index].tipo;
                                    mostrarDetalhesTipoErro(tipoErro);
                                }
                            },
                            onHover: (event, elements) => {
                                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                            },
                            plugins: {
                                legend: { 
                                    display: true, 
                                    position: 'right',
                                    labels: { 
                                        color: colors.legendColor, 
                                        font: { size: 11, weight: '500' },
                                        padding: 12,
                                        usePointStyle: true,
                                        pointStyle: 'circle'
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.85)',
                                    padding: 12,
                                    titleFont: { size: 13, weight: 'bold' },
                                    bodyFont: { size: 12 },
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed;
                                            const percentage = totalTipos > 0 ? ((value / totalTipos) * 100).toFixed(1) : 0;
                                            return `${value} lançamentos (${percentage}%)`;
                                        }
                                    },
                                    cornerRadius: 8
                                }
                            }
                        },
                        plugins: [{
                            id: 'datalabels',
                            afterDatasetsDraw: (chart) => {
                                const ctx = chart.ctx;
                                chart.data.datasets.forEach((dataset, i) => {
                                    const meta = chart.getDatasetMeta(i);
                                    meta.data.forEach((element, index) => {
                                        const value = dataset.data[index];
                                        if (value !== null && value !== undefined && value !== 0) {
                                            ctx.save();
                                            
                                            // Calcular percentual
                                            const percentage = totalTipos > 0 ? ((value / totalTipos) * 100).toFixed(1) : 0;
                                            
                                            // Texto com quantidade e percentual
                                            const text = `${value}\n${percentage}%`;
                                            const lines = text.split('\n');
                                            
                                            ctx.textAlign = 'center';
                                            ctx.textBaseline = 'middle';
                                            const position = element.tooltipPosition();
                                            
                                            // Desenhar quantidade (linha superior)
                                            ctx.fillStyle = colors.dataLabelColor;
                                            ctx.font = 'bold 13px Arial';
                                            ctx.textBaseline = 'bottom';
                                            ctx.fillText(lines[0], position.x, position.y - 3);
                                            
                                            // Desenhar percentual (linha inferior)
                                            ctx.fillStyle = colors.dataLabelColor;
                                            ctx.font = '600 11px Arial';
                                            ctx.textBaseline = 'top';
                                            ctx.fillText(lines[1], position.x, position.y + 3);
                                            
                                            ctx.restore();
                                        }
                                    });
                                });
                            }
                        }]
                    });
                }
            }
            
            // Gráfico de Operação (Barra Vertical Melhorado)
            const ctxOperacao = document.getElementById('chartOperacaoGestao');
            if (ctxOperacao) {
                if (ctxOperacao._chart) ctxOperacao._chart.destroy();
                
                const operacoesData = (s.byOperacao || []).filter(d => d && d.operacao && d.count > 0).slice(0, 12);
                const totalOperacoes = operacoesData.reduce((sum, d) => sum + (d.count || 0), 0);
                
                if (operacoesData.length > 0) {
                
                // Criar gradiente de cores harmonioso
                const gradientColors = [
                    '#667eea', '#764ba2', '#f093fb', '#4facfe', '#00f2fe',
                    '#43e97b', '#fa709a', '#fee140', '#30cfd0', '#a8edea',
                    '#ff6b6b', '#48dbfb'
                ];
                
                ctxOperacao._chart = new Chart(ctxOperacao, {
                    type: 'bar',
                    data: {
                        labels: operacoesData.map(d => d.operacao.length > 15 ? d.operacao.substring(0, 15) + '...' : d.operacao),
                        datasets: [{
                            label: 'Lançamentos',
                            data: operacoesData.map(d => d.count),
                            backgroundColor: (context) => {
                                const index = context.dataIndex;
                                return gradientColors[index % gradientColors.length];
                            },
                            borderColor: (context) => {
                                const index = context.dataIndex;
                                return gradientColors[index % gradientColors.length];
                            },
                            borderWidth: 2,
                            borderRadius: {
                                topLeft: 6,
                                topRight: 6,
                                bottomLeft: 0,
                                bottomRight: 0
                            },
                            barThickness: 'flex',
                            maxBarThickness: 50,
                            categoryPercentage: 0.7,
                            barPercentage: 0.8
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        onClick: (event, elements) => {
                            if (elements.length > 0) {
                                const element = elements[0];
                                const index = element.index;
                                const operacao = operacoesData[index].operacao;
                                mostrarDetalhesOperacao(operacao);
                            }
                        },
                        onHover: (event, elements) => {
                            event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                        },
                        layout: {
                            padding: {
                                left: 5,
                                right: 15,
                                top: 15,
                                bottom: 5
                            }
                        },
                        plugins: {
                            legend: { 
                                display: false 
                            },
                            tooltip: {
                                backgroundColor: 'rgba(0, 0, 0, 0.85)',
                                padding: 12,
                                titleFont: {
                                    size: 13,
                                    weight: 'bold'
                                },
                                bodyFont: {
                                    size: 12
                                },
                                displayColors: true,
                                callbacks: {
                                    title: function(context) {
                                        const index = context[0].dataIndex;
                                        return operacoesData[index].operacao;
                                    },
                                    label: function(context) {
                                        const value = context.parsed.y;
                                        const percentage = totalOperacoes > 0 ? ((value / totalOperacoes) * 100).toFixed(1) : 0;
                                        return `${value} lançamentos (${percentage}% do total)`;
                                    }
                                },
                                cornerRadius: 8,
                                borderColor: 'rgba(255, 255, 255, 0.1)',
                                borderWidth: 1
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                ticks: { 
                                    color: colors.textColor,
                                    font: {
                                        size: 11,
                                        weight: '500'
                                    },
                                    stepSize: 1,
                                    padding: 8,
                                    callback: function(value) {
                                        return Number.isInteger(value) ? value : '';
                                    }
                                },
                                grid: { 
                                    color: colors.gridColor,
                                    drawBorder: false,
                                    lineWidth: 1
                                }
                                },
                                x: {
                                ticks: { 
                                    color: colors.textColor,
                                    font: {
                                        size: 10,
                                        weight: '500'
                                    },
                                    maxRotation: 45,
                                    minRotation: 45,
                                    padding: 8
                                },
                                grid: { 
                                    display: false,
                                    drawBorder: false
                                }
                                }
                        },
                        animation: {
                            duration: 1200,
                            easing: 'easeOutQuart'
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                            }
                        },
                        plugins: [{
                            id: 'datalabels',
                            afterDatasetsDraw: (chart) => {
                                const ctx = chart.ctx;
                                const chartArea = chart.chartArea;
                            
                                chart.data.datasets.forEach((dataset, i) => {
                                    const meta = chart.getDatasetMeta(i);
                                    meta.data.forEach((element, index) => {
                                        const value = dataset.data[index];
                                    if (value !== null && value !== undefined && value !== 0) {
                                            ctx.save();
                                        
                                        // Calcular posição do topo da barra
                                            const barTop = element.y;
                                        const barBottom = barTop + element.height;
                                        
                                        // Posicionar label sempre no topo da barra
                                        let labelY = barTop - 8; // 8px acima do topo da barra
                                        
                                        // Se o label estiver muito próximo do topo do chartArea, colocar dentro da barra
                                        if (labelY < chartArea.top + 20) {
                                            // Colocar dentro da barra, próximo ao topo
                                            labelY = barTop + 18;
                                        }
                                        
                                        // Garantir que o label esteja sempre visível
                                        const minY = chartArea.top + 5;
                                        const maxY = chartArea.bottom - 5;
                                        labelY = Math.max(minY, Math.min(maxY, labelY));
                                        
                                        const text = String(value);
                                        ctx.font = 'bold 13px Arial';
                                            ctx.textAlign = 'center';
                                            ctx.textBaseline = 'middle';
                                            
                                        const textMetrics = ctx.measureText(text);
                                        const textWidth = textMetrics.width;
                                        const textHeight = 16;
                                        const padding = 6;
                                        
                                        // Calcular posição X centralizada na barra
                                        const labelX = element.x;
                                        
                                        // Desenhar fundo do label
                                        const bgX = labelX - textWidth / 2 - padding;
                                        const bgY = labelY - textHeight / 2;
                                        
                                        // Fundo escuro semi-transparente
                                        ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                                        ctx.fillRect(bgX, bgY, textWidth + padding * 2, textHeight);
                                            
                                        // Borda branca sutil
                                        ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
                                        ctx.lineWidth = 1;
                                        ctx.strokeRect(bgX, bgY, textWidth + padding * 2, textHeight);
                                        
                                        // Desenhar texto branco
                                        ctx.fillStyle = '#ffffff';
                                        ctx.fillText(text, labelX, labelY);
                                        
                                        ctx.restore();
                                    }
                                });
                            });
                        }
                    }]
                });
                }
            }
            
            // Gráfico de Responsáveis (Barra Horizontal Melhorado)
            const ctxResponsavel = document.getElementById('chartResponsavelGestao');
            if (ctxResponsavel && kpisData) {
                if (ctxResponsavel._chart) ctxResponsavel._chart.destroy();
                
                const responsaveisData = (kpisData.topResponsaveis || []).filter(d => d && d.responsavel && d.count > 0).slice(0, 10);
                const totalResponsaveis = responsaveisData.reduce((sum, d) => sum + (d.count || 0), 0);
                
                if (responsaveisData.length > 0) {
                    ctxResponsavel._chart = new Chart(ctxResponsavel, {
                        type: 'bar',
                        data: {
                            labels: responsaveisData.map(d => d.responsavel),
                            datasets: [{
                                label: 'Lançamentos',
                                data: responsaveisData.map(d => d.count),
                                backgroundColor: '#f093fb',
                                borderColor: '#764ba2',
                                borderWidth: 2,
                                borderRadius: {
                                    topRight: 6,
                                    bottomRight: 6,
                                    topLeft: 0,
                                    bottomLeft: 0
                                }
                            }]
                        },
                        options: {
                            indexAxis: 'y',
                            responsive: true,
                            maintainAspectRatio: false,
                            onClick: (event, elements) => {
                                if (elements.length > 0) {
                                    const element = elements[0];
                                    const index = element.index;
                                    const responsavel = responsaveisData[index].responsavel;
                                    mostrarDetalhesResponsavel(responsavel);
                                }
                            },
                            onHover: (event, elements) => {
                                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                            },
                            layout: {
                                padding: {
                                    left: 5,
                                    right: 15,
                                    top: 10,
                                    bottom: 10
                                }
                            },
                            plugins: {
                                legend: { display: false },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.85)',
                                    padding: 12,
                                    titleFont: { size: 13, weight: 'bold' },
                                    bodyFont: { size: 12 },
                                    callbacks: {
                                        label: function(context) {
                                            const value = context.parsed.x;
                                            const percentage = totalResponsaveis > 0 ? ((value / totalResponsaveis) * 100).toFixed(1) : 0;
                                            return `${value} lançamentos (${percentage}%)`;
                                        }
                                    },
                                    cornerRadius: 8
                                }
                            },
                            scales: {
                                x: {
                                    beginAtZero: true,
                                    ticks: { 
                                        color: colors.textColor,
                                        font: { size: 11, weight: '500' },
                                        stepSize: 1,
                                        padding: 8,
                                        callback: function(value) {
                                            return Number.isInteger(value) ? value : '';
                                        }
                                    },
                                    grid: { 
                                        color: colors.gridColor,
                                        drawBorder: false,
                                        lineWidth: 1
                                    }
                                },
                                y: {
                                    ticks: { 
                                        color: colors.textColor,
                                        font: { size: 11, weight: '500' },
                                        padding: 8
                                    },
                                    grid: { 
                                        display: false,
                                        drawBorder: false
                                    }
                                }
                            },
                            animation: {
                                duration: 1000,
                                easing: 'easeOutQuart'
                            }
                        },
                        plugins: [{
                            id: 'datalabels',
                            afterDatasetsDraw: (chart) => {
                                const ctx = chart.ctx;
                                const chartArea = chart.chartArea;
                                
                                chart.data.datasets.forEach((dataset, i) => {
                                    const meta = chart.getDatasetMeta(i);
                                    meta.data.forEach((element, index) => {
                                        const value = dataset.data[index];
                                        if (value !== null && value !== undefined && value !== 0) {
                                            ctx.save();
                                            
                                            // Posição da barra horizontal
                                            const barX = element.x;
                                            const barY = element.y;
                                            const barWidth = element.width;
                                            
                                            // Calcular posição do label (dentro ou fora da barra)
                                            let labelX = barX + barWidth + 10; // Tentar fora da barra primeiro
                                            
                                            // Se a barra for muito larga e o label sair do canvas, colocar dentro
                                            if (labelX > chartArea.right - 30) {
                                                labelX = barX + barWidth - 8; // Colocar dentro da barra, próximo ao final
                                            }
                                            
                                            // Garantir que o label esteja sempre visível
                                            const minX = chartArea.left + 5;
                                            const maxX = chartArea.right - 5;
                                            labelX = Math.max(minX, Math.min(maxX, labelX));
                                            
                                            const text = String(value);
                                            ctx.font = 'bold 12px Arial';
                                            ctx.textAlign = labelX > barX + barWidth ? 'left' : 'right';
                                            ctx.textBaseline = 'middle';
                                            
                                            const textMetrics = ctx.measureText(text);
                                            const textWidth = textMetrics.width;
                                            const textHeight = 14;
                                            const padding = 5;
                                            
                                            // Calcular posição do fundo do label
                                            let bgX, bgY;
                                            if (labelX > barX + barWidth) {
                                                // Label fora da barra (à direita)
                                                bgX = labelX;
                                                bgY = barY - textHeight / 2;
                                            } else {
                                                // Label dentro da barra
                                                bgX = labelX - textWidth - padding;
                                                bgY = barY - textHeight / 2;
                                            }
                                            
                                            // Desenhar fundo do label
                                            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                                            ctx.fillRect(bgX - padding, bgY, textWidth + padding * 2, textHeight);
                                            
                                            // Borda branca sutil
                                            ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
                                            ctx.lineWidth = 1;
                                            ctx.strokeRect(bgX - padding, bgY, textWidth + padding * 2, textHeight);
                                            
                                            // Desenhar texto branco
                                            ctx.fillStyle = '#ffffff';
                                            ctx.fillText(text, labelX, barY);
                                            
                                            ctx.restore();
                                        }
                                    });
                                });
                            }
                        }]
                    });
                }
            }
            
            // Gráfico Temporal (Linha Melhorado)
            const ctxTemporal = document.getElementById('chartTemporalGestao');
            if (ctxTemporal) {
                if (ctxTemporal._chart) ctxTemporal._chart.destroy();
                
                const temporalData = (s.byDay || []).filter(d => d && d.date && d.count !== undefined).sort((a, b) => a.date.localeCompare(b.date));
                
                if (temporalData.length > 0) {
                    ctxTemporal._chart = new Chart(ctxTemporal, {
                        type: 'line',
                        data: {
                            labels: temporalData.map(d => {
                                try {
                                    const date = new Date(d.date);
                                    if (isNaN(date.getTime())) return d.date;
                                    return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                                } catch (e) {
                                    return d.date;
                                }
                            }),
                            datasets: [{
                                label: 'Lançamentos',
                                data: temporalData.map(d => d.count || 0),
                                borderColor: '#4facfe',
                                backgroundColor: 'rgba(79, 172, 254, 0.2)',
                                fill: true,
                                tension: 0.4,
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                pointBackgroundColor: '#4facfe',
                                pointBorderColor: '#ffffff',
                                pointBorderWidth: 2,
                                pointHoverBackgroundColor: '#00f2fe',
                                pointHoverBorderColor: '#ffffff',
                                pointHoverBorderWidth: 3
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            onClick: (event, elements) => {
                                if (elements.length > 0) {
                                    const element = elements[0];
                                    const index = element.index;
                                    const data = temporalData[index];
                                    mostrarDetalhesData(data.date);
                                }
                            },
                            onHover: (event, elements) => {
                                event.native.target.style.cursor = elements.length > 0 ? 'pointer' : 'default';
                            },
                            layout: {
                                padding: {
                                    left: 5,
                                    right: 10,
                                    top: 5,
                                    bottom: 5
                                }
                            },
                            plugins: {
                                legend: { 
                                    display: true, 
                                    labels: { 
                                        color: colors.legendColor,
                                        font: { size: 12, weight: '500' },
                                        usePointStyle: true
                                    }
                                },
                                tooltip: {
                                    backgroundColor: 'rgba(0, 0, 0, 0.85)',
                                    padding: 12,
                                    titleFont: { size: 13, weight: 'bold' },
                                    bodyFont: { size: 12 },
                                    callbacks: {
                                        title: function(context) {
                                            const index = context[0].dataIndex;
                                            try {
                                                const date = new Date(temporalData[index].date);
                                                if (!isNaN(date.getTime())) {
                                                    return date.toLocaleDateString('pt-BR', { 
                                                        weekday: 'long',
                                                        day: '2-digit', 
                                                        month: 'long', 
                                                        year: 'numeric' 
                                                    });
                                                }
                                            } catch (e) {}
                                            return temporalData[index].date;
                                        },
                                        label: function(context) {
                                            return `${context.parsed.y} lançamentos`;
                                        }
                                    },
                                    cornerRadius: 8,
                                    displayColors: true
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: { 
                                        color: colors.textColor,
                                        font: { size: 11, weight: '500' },
                                        stepSize: 1,
                                        padding: 8,
                                        callback: function(value) {
                                            return Number.isInteger(value) ? value : '';
                                        }
                                    },
                                    grid: { 
                                        color: colors.gridColor,
                                        drawBorder: false,
                                        lineWidth: 1
                                    }
                                },
                                x: {
                                    ticks: { 
                                        color: colors.textColor,
                                        font: { size: 10, weight: '500' },
                                        padding: 8,
                                        maxRotation: 45,
                                        minRotation: 45
                                    },
                                    grid: { 
                                        color: colors.gridColor,
                                        drawBorder: false,
                                        lineWidth: 1
                                    }
                                }
                            },
                            animation: {
                                duration: 1200,
                                easing: 'easeOutQuart'
                            },
                            interaction: {
                                intersect: false,
                                mode: 'index'
                            }
                        },
                        plugins: [{
                            id: 'datalabels',
                            afterDatasetsDraw: (chart) => {
                                const ctx = chart.ctx;
                                const chartArea = chart.chartArea;
                                
                                chart.data.datasets.forEach((dataset, i) => {
                                    const meta = chart.getDatasetMeta(i);
                                    meta.data.forEach((element, index) => {
                                        const value = dataset.data[index];
                                        if (value !== null && value !== undefined && value !== 0) {
                                            ctx.save();
                                            
                                            // Posição do ponto no gráfico
                                            const pointX = element.x;
                                            const pointY = element.y;
                                            
                                            // Calcular posição do label (acima ou abaixo conforme necessário)
                                            let labelY = pointY - 18; // Tentar acima primeiro
                                            
                                            // Se estiver muito próximo do topo, colocar abaixo
                                            if (labelY < chartArea.top + 25) {
                                                labelY = pointY + 18; // Colocar abaixo do ponto
                                            }
                                            
                                            // Garantir que o label esteja sempre visível
                                            const minY = chartArea.top + 10;
                                            const maxY = chartArea.bottom - 10;
                                            labelY = Math.max(minY, Math.min(maxY, labelY));
                                            
                                            // Verificar se o label está dentro dos limites horizontais
                                            const text = String(value);
                                            ctx.font = 'bold 12px Arial';
                                            ctx.textAlign = 'center';
                                            ctx.textBaseline = 'middle';
                                            
                                            const textMetrics = ctx.measureText(text);
                                            const textWidth = textMetrics.width;
                                            const textHeight = 14;
                                            const padding = 6;
                                            
                                            // Ajustar posição X se estiver muito próximo das bordas
                                            let labelX = pointX;
                                            const minX = chartArea.left + textWidth / 2 + padding;
                                            const maxX = chartArea.right - textWidth / 2 - padding;
                                            
                                            if (labelX < minX) {
                                                labelX = minX;
                                            } else if (labelX > maxX) {
                                                labelX = maxX;
                                            }
                                            
                                            // Desenhar fundo do label
                                            const bgX = labelX - textWidth / 2 - padding;
                                            const bgY = labelY - textHeight / 2;
                                            
                                            // Fundo escuro semi-transparente
                                            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
                                            ctx.fillRect(bgX, bgY, textWidth + padding * 2, textHeight);
                                            
                                            // Borda branca sutil
                                            ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
                                            ctx.lineWidth = 1;
                                            ctx.strokeRect(bgX, bgY, textWidth + padding * 2, textHeight);
                                            
                                            // Desenhar texto branco
                                            ctx.fillStyle = '#ffffff';
                                            ctx.fillText(text, labelX, labelY);
                                            
                                            ctx.restore();
                                        }
                                    });
                                });
                            }
                        }]
                    });
                }
            }
            
            // Árvore de Perdas - Tipos de Erros Agrupados por Data
            const ctxUsuario = document.getElementById('chartUsuarioGestao');
            if (ctxUsuario && s) {
                if (ctxUsuario._chart) ctxUsuario._chart.destroy();
                
                // Usar dados já disponíveis de byDataETipoErro
                const dadosAgrupados = s.byDataETipoErro || [];
                
                if (dadosAgrupados.length > 0) {
                    // Agrupar por data e tipo de erro
                    const dadosPorData = new Map();
                    
                    dadosAgrupados.forEach(record => {
                        if (!record.data || !record.tipoErro) return;
                        
                        const data = record.data;
                        const tipoErro = record.tipoErro;
                        const count = record.count || 0;
                        
                        if (!dadosPorData.has(data)) {
                            dadosPorData.set(data, new Map());
                        }
                        
                        const tiposPorData = dadosPorData.get(data);
                        tiposPorData.set(tipoErro, (tiposPorData.get(tipoErro) || 0) + count);
                    });
                        
                        // Obter todas as datas e tipos de erros únicos
                        const datas = Array.from(dadosPorData.keys()).sort();
                        const todosTiposErro = Array.from(new Set(
                            Array.from(dadosPorData.values())
                                .flatMap(map => Array.from(map.keys()))
                        ));
                        
                        // Pegar os top 8 tipos de erros mais frequentes
                        const tiposFrequencia = new Map();
                        todosTiposErro.forEach(tipo => {
                            let total = 0;
                            dadosPorData.forEach((tiposMap) => {
                                total += tiposMap.get(tipo) || 0;
                            });
                            tiposFrequencia.set(tipo, total);
                        });
                        
                        const topTipos = Array.from(tiposFrequencia.entries())
                            .sort((a, b) => b[1] - a[1])
                            .slice(0, 8)
                            .map(([tipo]) => tipo);
                        
                        // Limitar a 15 datas mais recentes
                        const datasLimitadas = datas.slice(-15);
                        
                        // Cores distintas e contrastantes para cada tipo de erro
                        const coresTipos = {
                            'Erro operacional': '#e74c3c', // Vermelho vibrante
                            'Falta de Documentação / Anexo Ausente': '#3498db', // Azul
                            'Informações Incompletas ou Incorretas': '#f39c12', // Laranja
                            'Erro de Nomeclatura de Arquivos': '#9b59b6', // Roxo
                            'Erro de Tabela': '#e67e22', // Laranja escuro
                            'Divergência Financeira': '#1abc9c', // Turquesa
                            'Erro em Documentos Fiscais e Regulatórios': '#f1c40f', // Amarelo
                            'Problema Operacional / Autorização / Procedimento': '#34495e', // Cinza escuro
                            'Erro de Sistema / Integração / Processamento': '#e91e63', // Rosa/Magenta
                            'Erro de Peso / Quantidade / Medidas': '#27ae60', // Verde
                            'Erro de Classificação e produto': '#16a085' // Verde água
                        };
                        
                        // Paleta de cores padrão com alto contraste
                        const coresPadrao = [
                            '#e74c3c', // Vermelho
                            '#3498db', // Azul
                            '#f39c12', // Laranja
                            '#9b59b6', // Roxo
                            '#1abc9c', // Turquesa
                            '#e67e22', // Laranja escuro
                            '#f1c40f', // Amarelo
                            '#34495e'  // Cinza escuro
                        ];
                        
                        // Criar datasets para cada tipo de erro com estilo limpo e elegante
                        const datasets = topTipos.map((tipo, index) => {
                            const cor = coresTipos[tipo] || coresPadrao[index % coresPadrao.length];
                            
                            return {
                                label: tipo.length > 30 ? tipo.substring(0, 30) + '...' : tipo,
                                data: datasLimitadas.map(data => {
                                    const tiposMap = dadosPorData.get(data);
                                    return tiposMap ? (tiposMap.get(tipo) || 0) : 0;
                                }),
                                backgroundColor: cor,
                                borderColor: 'rgba(255, 255, 255, 0.3)',
                                borderWidth: 1,
                                borderRadius: {
                                    topLeft: 5,
                                    topRight: 5,
                                    bottomLeft: 0,
                                    bottomRight: 0
                                },
                                barThickness: 'flex',
                                maxBarThickness: 55,
                                categoryPercentage: 0.75,
                                barPercentage: 0.85
                            };
                        });
                        
                        // Formatar labels de data
                        const labels = datasLimitadas.map(data => {
                            try {
                                const date = new Date(data);
                                if (!isNaN(date.getTime())) {
                                    return date.toLocaleDateString('pt-BR', { day: '2-digit', month: '2-digit' });
                                }
                            } catch (e) {}
                            return data;
                        });
                        
                    if (datasets.length > 0 && labels.length > 0) {
                        ctxUsuario._chart = new Chart(ctxUsuario, {
                                type: 'bar',
                                data: {
                                    labels: labels,
                                    datasets: datasets
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    layout: {
                                        padding: {
                                            left: 10,
                                            right: 20,
                                            top: 20,
                                            bottom: 10
                                        }
                                    },
                                    plugins: {
                                        legend: {
                                            display: true,
                                            position: 'right',
                                            align: 'start',
                                            labels: {
                                                color: colors.legendColor,
                                                font: { 
                                                    size: 11, 
                                                    weight: '500',
                                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                                },
                                                padding: 10,
                                                usePointStyle: true,
                                                pointStyle: 'circle',
                                                boxWidth: 12,
                                                boxHeight: 12
                                            }
                                        },
                                        tooltip: {
                                            enabled: true,
                                            backgroundColor: 'rgba(0, 0, 0, 0.88)',
                                            padding: 20,
                                            titleFont: { 
                                                size: 16, 
                                                weight: 'bold',
                                                family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                            },
                                            bodyFont: { 
                                                size: 14,
                                                weight: '500',
                                                family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                            },
                                            footerFont: {
                                                size: 14,
                                                weight: 'bold',
                                                family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                            },
                                            mode: 'index',
                                            intersect: false,
                                            axis: 'x',
                                            maxWidth: 400,
                                            callbacks: {
                                                title: function(context) {
                                                    if (!context || context.length === 0) return '';
                                                    const index = context[0].dataIndex;
                                                    try {
                                                        const date = new Date(datasLimitadas[index]);
                                                        if (!isNaN(date.getTime())) {
                                                            return date.toLocaleDateString('pt-BR', { 
                                                                weekday: 'long',
                                                                day: '2-digit', 
                                                                month: 'long', 
                                                                year: 'numeric' 
                                                            });
                                                        }
                                                    } catch (e) {}
                                                    return datasLimitadas[index] || '';
                                                },
                                                label: function(context) {
                                                    if (!context) return '';
                                                    const datasetLabel = context.dataset.label || '';
                                                    const value = context.parsed.y || 0;
                                                    const allContexts = context.chart.tooltip.dataPoints || [];
                                                    const total = allContexts.reduce((sum, item) => sum + (item.parsed.y || 0), 0);
                                                    const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                                    return `${datasetLabel}: ${value} (${percentage}%)`;
                                                },
                                                footer: function(context) {
                                                    if (!context || context.length === 0) return '';
                                                    const total = context.reduce((sum, item) => sum + (item.parsed.y || 0), 0);
                                                    return `Total: ${total} ocorrências`;
                                                }
                                            },
                                            cornerRadius: 10,
                                            displayColors: true,
                                            boxPadding: 8,
                                            borderColor: 'rgba(255, 255, 255, 0.15)',
                                            borderWidth: 1.5,
                                            titleSpacing: 12,
                                            bodySpacing: 8,
                                            footerSpacing: 12
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            stacked: true,
                                            ticks: { 
                                                color: colors.textColor,
                                                font: { 
                                                    size: 11, 
                                                    weight: '500',
                                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                                },
                                                stepSize: 1,
                                                padding: 10,
                                                callback: function(value) {
                                                    return Number.isInteger(value) ? value : '';
                                                }
                                            },
                                            grid: { 
                                                color: colors.gridColor,
                                                drawBorder: false,
                                                lineWidth: 1,
                                                drawTicks: false
                                            },
                                            title: {
                                                display: true,
                                                text: 'Quantidade de Ocorrências',
                                                color: colors.textColor,
                                                font: {
                                                    size: 12,
                                                    weight: 'bold',
                                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                                },
                                                padding: {
                                                    top: 5,
                                                    bottom: 15
                                                }
                                            }
                                        },
                                        x: {
                                            stacked: true,
                                            ticks: { 
                                                color: colors.textColor,
                                                font: { 
                                                    size: 11, 
                                                    weight: '500',
                                                    family: "'Segoe UI', Tahoma, Geneva, Verdana, sans-serif"
                                                },
                                                padding: 10,
                                                maxRotation: 45,
                                                minRotation: 45
                                            },
                                            grid: { 
                                                display: false,
                                                drawBorder: false
                                            }
                                        }
                                    },
                                    animation: {
                                        duration: 1500,
                                        easing: 'easeOutCubic'
                                    },
                                    interaction: {
                                        mode: 'index',
                                        intersect: false
                                    }
                                }
                            });
            } else {
                        console.warn('⚠️ Nenhum dado disponível para árvore de perdas agrupada por data');
                    }
                } else {
                    console.warn('⚠️ Nenhum dado de byDataETipoErro disponível');
                }
            } else {
                console.warn('⚠️ Elemento chartUsuarioGestao não encontrado ou dados de séries não disponíveis');
            }
        } catch (error) {
            console.error('❌ Erro ao carregar BI Gestão de Dados:', error);
            alert('Erro ao carregar dados do BI Gestão de Dados. Verifique o console para mais detalhes.');
        } finally {
            if(overlay) overlay.style.display = 'none';
        }
    }
    
    // Função para mostrar detalhes do tipo de erro
    async function mostrarDetalhesTipoErro(tipoErro) {
        const modal = new bootstrap.Modal(document.getElementById('modalDetalhesTipoErro'));
        const conteudo = document.getElementById('modalDetalhesConteudo');
        const titulo = document.getElementById('modalTipoErroTitulo');
        
        titulo.textContent = tipoErro;
        conteudo.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">Carregando detalhes...</p></div>';
        modal.show();
        
        try {
            const periodo = calcularPeriodoGestao();
            const operacaoSelect = document.getElementById('filtroOperacaoGestao');
            const operacao = operacaoSelect ? operacaoSelect.value : '';
            
            const params = new URLSearchParams({
                inicio: periodo.inicio || '',
                fim: periodo.fim || '',
                tipo_erro: tipoErro
            });
            
            if (operacao && operacao.trim() !== '') {
                params.append('operacao', operacao.trim());
            }
            
            const response = await fetch(`/api/relatorios/gestao-dados/detalhes?${params}`, { credentials: 'include' });
            
            if (!response.ok) {
                throw new Error('Erro ao buscar detalhes');
            }
            
            const dados = await response.json();
            
            // Agrupar dados
            const porOperacao = {};
            const porResponsavel = {};
            const porData = {};
            const porUsuario = {};
            const motivosDevolucao = [];
            
            (dados.registros || []).forEach(reg => {
                // Por operação
                const op = reg.operacao || 'Não informado';
                porOperacao[op] = (porOperacao[op] || 0) + 1;
                
                // Por responsável
                const resp = reg.responsavel || 'Não informado';
                porResponsavel[resp] = (porResponsavel[resp] || 0) + 1;
                
                // Por data
                const data = reg.data || 'Não informado';
                porData[data] = (porData[data] || 0) + 1;
                
                // Por usuário que criou
                const usuario = reg.usuario_nome || reg.criado_por_nome || 'Não informado';
                porUsuario[usuario] = (porUsuario[usuario] || 0) + 1;
                
                // Motivos de devolução
                if (reg.motivo_devolucao) {
                    motivosDevolucao.push({
                        motivo: reg.motivo_devolucao,
                        data: reg.data,
                        operacao: reg.operacao,
                        responsavel: reg.responsavel,
                        oc: reg.oc
                    });
                }
            });
            
            // Ordenar por quantidade
            const ordenarPorQuantidade = (obj) => {
                return Object.entries(obj)
                    .sort((a, b) => b[1] - a[1])
                    .map(([nome, qtd]) => ({ nome, qtd }));
            };
            
            let html = `
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card shadow-sm" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px;">
                            <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-bottom: none; color: white; border-radius: 12px 12px 0 0; padding: 1rem 1.25rem;">
                                <h6 class="mb-0" style="color: white; font-weight: 600;"><i class="fas fa-building me-2"></i>Por Operação</h6>
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto; padding: 1rem;">
                                ${ordenarPorQuantidade(porOperacao).map(item => `
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                                        <span style="color: #212529; font-weight: 500;">${item.nome}</span>
                                        <span class="badge" style="background: #667eea; color: white; font-size: 0.875rem; padding: 0.4rem 0.7rem;">${item.qtd}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-sm" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px;">
                            <div class="card-header" style="background: linear-gradient(135deg, #764ba2 0%, #9b59b6 100%); border-bottom: none; color: white; border-radius: 12px 12px 0 0; padding: 1rem 1.25rem;">
                                <h6 class="mb-0" style="color: white; font-weight: 600;"><i class="fas fa-user-tie me-2"></i>Por Responsável</h6>
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto; padding: 1rem;">
                                ${ordenarPorQuantidade(porResponsavel).map(item => `
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                                        <span style="color: #212529; font-weight: 500;">${item.nome}</span>
                                        <span class="badge" style="background: #17a2b8; color: white; font-size: 0.875rem; padding: 0.4rem 0.7rem;">${item.qtd}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-sm" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px;">
                            <div class="card-header" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-bottom: none; color: white; border-radius: 12px 12px 0 0; padding: 1rem 1.25rem;">
                                <h6 class="mb-0" style="color: white; font-weight: 600;"><i class="fas fa-calendar-alt me-2"></i>Por Data</h6>
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto; padding: 1rem;">
                                ${ordenarPorQuantidade(porData).map(item => `
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                                        <span style="color: #212529; font-weight: 500;">${new Date(item.nome).toLocaleDateString('pt-BR')}</span>
                                        <span class="badge" style="background: #28a745; color: white; font-size: 0.875rem; padding: 0.4rem 0.7rem;">${item.qtd}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-sm" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px;">
                            <div class="card-header" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); border-bottom: none; color: white; border-radius: 12px 12px 0 0; padding: 1rem 1.25rem;">
                                <h6 class="mb-0" style="color: white; font-weight: 600;"><i class="fas fa-user me-2"></i>Por Usuário que Criou</h6>
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto; padding: 1rem;">
                                ${ordenarPorQuantidade(porUsuario).map(item => `
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                                        <span style="color: #212529; font-weight: 500;">${item.nome}</span>
                                        <span class="badge" style="background: #ffc107; color: #212529; font-size: 0.875rem; padding: 0.4rem 0.7rem; font-weight: 600;">${item.qtd}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card shadow-sm" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px;">
                            <div class="card-header" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-bottom: none; color: white; border-radius: 12px 12px 0 0; padding: 1rem 1.25rem;">
                                <h6 class="mb-0" style="color: white; font-weight: 600;"><i class="fas fa-comment-dots me-2"></i>Motivos de Devolução</h6>
                            </div>
                            <div class="card-body" style="max-height: 400px; overflow-y: auto; padding: 1rem;">
                                ${motivosDevolucao.length > 0 ? motivosDevolucao.map((item, idx) => `
                                    <div class="mb-3 p-3" style="background: #f8f9fa; border-radius: 10px; border-left: 4px solid #fa709a; border: 1px solid #e9ecef;">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <strong style="color: #fa709a; font-size: 1rem;">OC: ${item.oc || 'N/A'}</strong>
                                                <span class="ms-2" style="color: #6c757d; font-size: 0.9rem;">${item.data ? new Date(item.data).toLocaleDateString('pt-BR') : 'N/A'}</span>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <small style="color: #6c757d; font-weight: 500;">Operação: ${item.operacao || 'N/A'}</small> | 
                                            <small style="color: #6c757d; font-weight: 500;">Responsável: ${item.responsavel || 'N/A'}</small>
                                        </div>
                                        <p class="mb-0" style="color: #212529; line-height: 1.6; font-size: 0.95rem;">${item.motivo}</p>
                                    </div>
                                `).join('') : '<p class="text-muted text-center py-4" style="color: #6c757d;">Nenhum motivo de devolução encontrado</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            conteudo.innerHTML = html;
        } catch (error) {
            console.error('❌ Erro ao carregar detalhes:', error);
            conteudo.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Erro ao carregar detalhes: ${error.message}
                </div>
            `;
        }
    }
    
    // Função para mostrar detalhes da operação
    async function mostrarDetalhesOperacao(operacao) {
        const modal = new bootstrap.Modal(document.getElementById('modalDetalhesOperacao'));
        const conteudo = document.getElementById('modalDetalhesOperacaoConteudo');
        const titulo = document.getElementById('modalOperacaoTitulo');
        
        titulo.textContent = operacao;
        conteudo.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">Carregando detalhes...</p></div>';
        modal.show();
        
        try {
            const periodo = calcularPeriodoGestao();
            const params = new URLSearchParams({
                inicio: periodo.inicio || '',
                fim: periodo.fim || ''
            });
            
            if (operacao && operacao.trim() !== '') {
                params.append('operacao', operacao.trim());
            }
            
            const response = await fetch(`/api/relatorios/gestao-dados/detalhes?${params}`, { credentials: 'include' });
            
            if (!response.ok) {
                throw new Error('Erro ao buscar detalhes');
            }
            
            const dados = await response.json();
            
            // Agrupar dados
            const porTipoErro = {};
            const porResponsavel = {};
            const porData = {};
            const porUsuario = {};
            const motivosDevolucao = [];
            
            (dados.registros || []).forEach(reg => {
                // Por tipo de erro
                const tipo = reg.tipo_erro || 'Não informado';
                porTipoErro[tipo] = (porTipoErro[tipo] || 0) + 1;
                
                // Por responsável
                const resp = reg.responsavel || 'Não informado';
                porResponsavel[resp] = (porResponsavel[resp] || 0) + 1;
                
                // Por data
                const data = reg.data || 'Não informado';
                porData[data] = (porData[data] || 0) + 1;
                
                // Por usuário que criou
                const usuario = reg.usuario_nome || reg.criado_por_nome || 'Não informado';
                porUsuario[usuario] = (porUsuario[usuario] || 0) + 1;
                
                // Motivos de devolução
                if (reg.motivo_devolucao) {
                    motivosDevolucao.push({
                        motivo: reg.motivo_devolucao,
                        data: reg.data,
                        tipo_erro: reg.tipo_erro,
                        responsavel: reg.responsavel,
                        oc: reg.oc
                    });
                }
            });
            
            const ordenarPorQuantidade = (obj) => {
                return Object.entries(obj)
                    .sort((a, b) => b[1] - a[1])
                    .map(([nome, qtd]) => ({ nome, qtd }));
            };
            
            let html = `
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card shadow-sm" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px;">
                            <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-bottom: none; color: white; border-radius: 12px 12px 0 0; padding: 1rem 1.25rem;">
                                <h6 class="mb-0" style="color: white; font-weight: 600;"><i class="fas fa-exclamation-triangle me-2"></i>Por Tipo de Erro</h6>
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto; padding: 1rem;">
                                ${ordenarPorQuantidade(porTipoErro).map(item => `
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                                        <span style="color: #212529; font-weight: 500;">${item.nome}</span>
                                        <span class="badge" style="background: #667eea; color: white; font-size: 0.875rem; padding: 0.4rem 0.7rem;">${item.qtd}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-sm" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px;">
                            <div class="card-header" style="background: linear-gradient(135deg, #764ba2 0%, #9b59b6 100%); border-bottom: none; color: white; border-radius: 12px 12px 0 0; padding: 1rem 1.25rem;">
                                <h6 class="mb-0" style="color: white; font-weight: 600;"><i class="fas fa-user-tie me-2"></i>Por Responsável</h6>
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto; padding: 1rem;">
                                ${ordenarPorQuantidade(porResponsavel).map(item => `
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                                        <span style="color: #212529; font-weight: 500;">${item.nome}</span>
                                        <span class="badge" style="background: #17a2b8; color: white; font-size: 0.875rem; padding: 0.4rem 0.7rem;">${item.qtd}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-sm" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px;">
                            <div class="card-header" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-bottom: none; color: white; border-radius: 12px 12px 0 0; padding: 1rem 1.25rem;">
                                <h6 class="mb-0" style="color: white; font-weight: 600;"><i class="fas fa-calendar-alt me-2"></i>Por Data</h6>
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto; padding: 1rem;">
                                ${ordenarPorQuantidade(porData).map(item => `
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                                        <span style="color: #212529; font-weight: 500;">${new Date(item.nome).toLocaleDateString('pt-BR')}</span>
                                        <span class="badge" style="background: #28a745; color: white; font-size: 0.875rem; padding: 0.4rem 0.7rem;">${item.qtd}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-sm" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px;">
                            <div class="card-header" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); border-bottom: none; color: white; border-radius: 12px 12px 0 0; padding: 1rem 1.25rem;">
                                <h6 class="mb-0" style="color: white; font-weight: 600;"><i class="fas fa-user me-2"></i>Por Usuário que Criou</h6>
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto; padding: 1rem;">
                                ${ordenarPorQuantidade(porUsuario).map(item => `
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                                        <span style="color: #212529; font-weight: 500;">${item.nome}</span>
                                        <span class="badge" style="background: #ffc107; color: #212529; font-size: 0.875rem; padding: 0.4rem 0.7rem; font-weight: 600;">${item.qtd}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card shadow-sm" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px;">
                            <div class="card-header" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-bottom: none; color: white; border-radius: 12px 12px 0 0; padding: 1rem 1.25rem;">
                                <h6 class="mb-0" style="color: white; font-weight: 600;"><i class="fas fa-comment-dots me-2"></i>Motivos de Devolução</h6>
                            </div>
                            <div class="card-body" style="max-height: 400px; overflow-y: auto; padding: 1rem;">
                                ${motivosDevolucao.length > 0 ? motivosDevolucao.map((item, idx) => `
                                    <div class="mb-3 p-3" style="background: #f8f9fa; border-radius: 10px; border-left: 4px solid #fa709a; border: 1px solid #e9ecef;">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <strong style="color: #fa709a; font-size: 1rem;">OC: ${item.oc || 'N/A'}</strong>
                                                <span class="ms-2" style="color: #6c757d; font-size: 0.9rem;">${item.data ? new Date(item.data).toLocaleDateString('pt-BR') : 'N/A'}</span>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <small style="color: #6c757d; font-weight: 500;">Tipo de Erro: ${item.tipo_erro || 'N/A'}</small> | 
                                            <small style="color: #6c757d; font-weight: 500;">Responsável: ${item.responsavel || 'N/A'}</small>
                                        </div>
                                        <p class="mb-0" style="color: #212529; line-height: 1.6; font-size: 0.95rem;">${item.motivo}</p>
                                    </div>
                                `).join('') : '<p class="text-muted text-center py-4" style="color: #6c757d;">Nenhum motivo de devolução encontrado</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            conteudo.innerHTML = html;
        } catch (error) {
            console.error('❌ Erro ao carregar detalhes:', error);
            conteudo.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Erro ao carregar detalhes: ${error.message}
                </div>
            `;
        }
    }
    
    // Função para mostrar detalhes do responsável
    async function mostrarDetalhesResponsavel(responsavel) {
        const modal = new bootstrap.Modal(document.getElementById('modalDetalhesResponsavel'));
        const conteudo = document.getElementById('modalDetalhesResponsavelConteudo');
        const titulo = document.getElementById('modalResponsavelTitulo');
        
        titulo.textContent = responsavel;
        conteudo.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">Carregando detalhes...</p></div>';
        modal.show();
        
        try {
            const periodo = calcularPeriodoGestao();
            const operacaoSelect = document.getElementById('filtroOperacaoGestao');
            const operacao = operacaoSelect ? operacaoSelect.value : '';
            
            const params = new URLSearchParams({
                inicio: periodo.inicio || '',
                fim: periodo.fim || '',
                responsavel: responsavel
            });
            
            if (operacao && operacao.trim() !== '') {
                params.append('operacao', operacao.trim());
            }
            
            const response = await fetch(`/api/relatorios/gestao-dados/detalhes?${params}`, { credentials: 'include' });
            
            if (!response.ok) {
                throw new Error('Erro ao buscar detalhes');
            }
            
            const dados = await response.json();
            
            // Agrupar dados
            const porTipoErro = {};
            const porOperacao = {};
            const porData = {};
            const porUsuario = {};
            const motivosDevolucao = [];
            
            (dados.registros || []).forEach(reg => {
                // Por tipo de erro
                const tipo = reg.tipo_erro || 'Não informado';
                porTipoErro[tipo] = (porTipoErro[tipo] || 0) + 1;
                
                // Por operação
                const op = reg.operacao || 'Não informado';
                porOperacao[op] = (porOperacao[op] || 0) + 1;
                
                // Por data
                const data = reg.data || 'Não informado';
                porData[data] = (porData[data] || 0) + 1;
                
                // Por usuário que criou
                const usuario = reg.usuario_nome || reg.criado_por_nome || 'Não informado';
                porUsuario[usuario] = (porUsuario[usuario] || 0) + 1;
                
                // Motivos de devolução
                if (reg.motivo_devolucao) {
                    motivosDevolucao.push({
                        motivo: reg.motivo_devolucao,
                        data: reg.data,
                        tipo_erro: reg.tipo_erro,
                        operacao: reg.operacao,
                        oc: reg.oc
                    });
                }
            });
            
            const ordenarPorQuantidade = (obj) => {
                return Object.entries(obj)
                    .sort((a, b) => b[1] - a[1])
                    .map(([nome, qtd]) => ({ nome, qtd }));
            };
            
            let html = `
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card shadow-sm" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px;">
                            <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-bottom: none; color: white; border-radius: 12px 12px 0 0; padding: 1rem 1.25rem;">
                                <h6 class="mb-0" style="color: white; font-weight: 600;"><i class="fas fa-exclamation-triangle me-2"></i>Por Tipo de Erro</h6>
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto; padding: 1rem;">
                                ${ordenarPorQuantidade(porTipoErro).map(item => `
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                                        <span style="color: #212529; font-weight: 500;">${item.nome}</span>
                                        <span class="badge" style="background: #667eea; color: white; font-size: 0.875rem; padding: 0.4rem 0.7rem;">${item.qtd}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-sm" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px;">
                            <div class="card-header" style="background: linear-gradient(135deg, #764ba2 0%, #9b59b6 100%); border-bottom: none; color: white; border-radius: 12px 12px 0 0; padding: 1rem 1.25rem;">
                                <h6 class="mb-0" style="color: white; font-weight: 600;"><i class="fas fa-building me-2"></i>Por Operação</h6>
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto; padding: 1rem;">
                                ${ordenarPorQuantidade(porOperacao).map(item => `
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                                        <span style="color: #212529; font-weight: 500;">${item.nome}</span>
                                        <span class="badge" style="background: #17a2b8; color: white; font-size: 0.875rem; padding: 0.4rem 0.7rem;">${item.qtd}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-sm" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px;">
                            <div class="card-header" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-bottom: none; color: white; border-radius: 12px 12px 0 0; padding: 1rem 1.25rem;">
                                <h6 class="mb-0" style="color: white; font-weight: 600;"><i class="fas fa-calendar-alt me-2"></i>Por Data</h6>
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto; padding: 1rem;">
                                ${ordenarPorQuantidade(porData).map(item => `
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                                        <span style="color: #212529; font-weight: 500;">${new Date(item.nome).toLocaleDateString('pt-BR')}</span>
                                        <span class="badge" style="background: #28a745; color: white; font-size: 0.875rem; padding: 0.4rem 0.7rem;">${item.qtd}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-sm" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px;">
                            <div class="card-header" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); border-bottom: none; color: white; border-radius: 12px 12px 0 0; padding: 1rem 1.25rem;">
                                <h6 class="mb-0" style="color: white; font-weight: 600;"><i class="fas fa-user me-2"></i>Por Usuário que Criou</h6>
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto; padding: 1rem;">
                                ${ordenarPorQuantidade(porUsuario).map(item => `
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                                        <span style="color: #212529; font-weight: 500;">${item.nome}</span>
                                        <span class="badge" style="background: #ffc107; color: #212529; font-size: 0.875rem; padding: 0.4rem 0.7rem; font-weight: 600;">${item.qtd}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card shadow-sm" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px;">
                            <div class="card-header" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-bottom: none; color: white; border-radius: 12px 12px 0 0; padding: 1rem 1.25rem;">
                                <h6 class="mb-0" style="color: white; font-weight: 600;"><i class="fas fa-comment-dots me-2"></i>Motivos de Devolução</h6>
                            </div>
                            <div class="card-body" style="max-height: 400px; overflow-y: auto; padding: 1rem;">
                                ${motivosDevolucao.length > 0 ? motivosDevolucao.map((item, idx) => `
                                    <div class="mb-3 p-3" style="background: #f8f9fa; border-radius: 10px; border-left: 4px solid #fa709a; border: 1px solid #e9ecef;">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <strong style="color: #fa709a; font-size: 1rem;">OC: ${item.oc || 'N/A'}</strong>
                                                <span class="ms-2" style="color: #6c757d; font-size: 0.9rem;">${item.data ? new Date(item.data).toLocaleDateString('pt-BR') : 'N/A'}</span>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <small style="color: #6c757d; font-weight: 500;">Tipo de Erro: ${item.tipo_erro || 'N/A'}</small> | 
                                            <small style="color: #6c757d; font-weight: 500;">Operação: ${item.operacao || 'N/A'}</small>
                                        </div>
                                        <p class="mb-0" style="color: #212529; line-height: 1.6; font-size: 0.95rem;">${item.motivo}</p>
                                    </div>
                                `).join('') : '<p class="text-muted text-center py-4" style="color: #6c757d;">Nenhum motivo de devolução encontrado</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            conteudo.innerHTML = html;
        } catch (error) {
            console.error('❌ Erro ao carregar detalhes:', error);
            conteudo.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Erro ao carregar detalhes: ${error.message}
                </div>
            `;
        }
    }
    
    // Função para mostrar detalhes da data
    async function mostrarDetalhesData(data) {
        const modal = new bootstrap.Modal(document.getElementById('modalDetalhesData'));
        const conteudo = document.getElementById('modalDetalhesDataConteudo');
        const titulo = document.getElementById('modalDataTitulo');
        
        const dataFormatada = new Date(data).toLocaleDateString('pt-BR', { 
            weekday: 'long',
            day: '2-digit', 
            month: 'long', 
            year: 'numeric' 
        });
        
        titulo.textContent = dataFormatada;
        conteudo.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary" role="status"></div><p class="mt-3">Carregando detalhes...</p></div>';
        modal.show();
        
        try {
            const periodo = calcularPeriodoGestao();
            const operacaoSelect = document.getElementById('filtroOperacaoGestao');
            const operacao = operacaoSelect ? operacaoSelect.value : '';
            
            const params = new URLSearchParams({
                data: data
            });
            
            if (operacao && operacao.trim() !== '') {
                params.append('operacao', operacao.trim());
            }
            
            const response = await fetch(`/api/relatorios/gestao-dados/detalhes?${params}`, { credentials: 'include' });
            
            if (!response.ok) {
                throw new Error('Erro ao buscar detalhes');
            }
            
            const dados = await response.json();
            
            // Agrupar dados
            const porTipoErro = {};
            const porOperacao = {};
            const porResponsavel = {};
            const porUsuario = {};
            const motivosDevolucao = [];
            
            (dados.registros || []).forEach(reg => {
                // Por tipo de erro
                const tipo = reg.tipo_erro || 'Não informado';
                porTipoErro[tipo] = (porTipoErro[tipo] || 0) + 1;
                
                // Por operação
                const op = reg.operacao || 'Não informado';
                porOperacao[op] = (porOperacao[op] || 0) + 1;
                
                // Por responsável
                const resp = reg.responsavel || 'Não informado';
                porResponsavel[resp] = (porResponsavel[resp] || 0) + 1;
                
                // Por usuário que criou
                const usuario = reg.usuario_nome || reg.criado_por_nome || 'Não informado';
                porUsuario[usuario] = (porUsuario[usuario] || 0) + 1;
                
                // Motivos de devolução
                if (reg.motivo_devolucao) {
                    motivosDevolucao.push({
                        motivo: reg.motivo_devolucao,
                        tipo_erro: reg.tipo_erro,
                        operacao: reg.operacao,
                        responsavel: reg.responsavel,
                        oc: reg.oc,
                        hora_envio: reg.hora_envio,
                        hora_retorno: reg.hora_retorno
                    });
                }
            });
            
            const ordenarPorQuantidade = (obj) => {
                return Object.entries(obj)
                    .sort((a, b) => b[1] - a[1])
                    .map(([nome, qtd]) => ({ nome, qtd }));
            };
            
            let html = `
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="card shadow-sm" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px;">
                            <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-bottom: none; color: white; border-radius: 12px 12px 0 0; padding: 1rem 1.25rem;">
                                <h6 class="mb-0" style="color: white; font-weight: 600;"><i class="fas fa-exclamation-triangle me-2"></i>Por Tipo de Erro</h6>
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto; padding: 1rem;">
                                ${ordenarPorQuantidade(porTipoErro).map(item => `
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                                        <span style="color: #212529; font-weight: 500;">${item.nome}</span>
                                        <span class="badge" style="background: #667eea; color: white; font-size: 0.875rem; padding: 0.4rem 0.7rem;">${item.qtd}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-sm" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px;">
                            <div class="card-header" style="background: linear-gradient(135deg, #764ba2 0%, #9b59b6 100%); border-bottom: none; color: white; border-radius: 12px 12px 0 0; padding: 1rem 1.25rem;">
                                <h6 class="mb-0" style="color: white; font-weight: 600;"><i class="fas fa-building me-2"></i>Por Operação</h6>
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto; padding: 1rem;">
                                ${ordenarPorQuantidade(porOperacao).map(item => `
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                                        <span style="color: #212529; font-weight: 500;">${item.nome}</span>
                                        <span class="badge" style="background: #17a2b8; color: white; font-size: 0.875rem; padding: 0.4rem 0.7rem;">${item.qtd}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-sm" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px;">
                            <div class="card-header" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-bottom: none; color: white; border-radius: 12px 12px 0 0; padding: 1rem 1.25rem;">
                                <h6 class="mb-0" style="color: white; font-weight: 600;"><i class="fas fa-user-tie me-2"></i>Por Responsável</h6>
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto; padding: 1rem;">
                                ${ordenarPorQuantidade(porResponsavel).map(item => `
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                                        <span style="color: #212529; font-weight: 500;">${item.nome}</span>
                                        <span class="badge" style="background: #fa709a; color: white; font-size: 0.875rem; padding: 0.4rem 0.7rem;">${item.qtd}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card shadow-sm" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px;">
                            <div class="card-header" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); border-bottom: none; color: white; border-radius: 12px 12px 0 0; padding: 1rem 1.25rem;">
                                <h6 class="mb-0" style="color: white; font-weight: 600;"><i class="fas fa-user me-2"></i>Por Usuário que Criou</h6>
                            </div>
                            <div class="card-body" style="max-height: 300px; overflow-y: auto; padding: 1rem;">
                                ${ordenarPorQuantidade(porUsuario).map(item => `
                                    <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                                        <span style="color: #212529; font-weight: 500;">${item.nome}</span>
                                        <span class="badge" style="background: #ffc107; color: #212529; font-size: 0.875rem; padding: 0.4rem 0.7rem; font-weight: 600;">${item.qtd}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                    <div class="col-12">
                        <div class="card shadow-sm" style="background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px;">
                            <div class="card-header" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-bottom: none; color: white; border-radius: 12px 12px 0 0; padding: 1rem 1.25rem;">
                                <h6 class="mb-0" style="color: white; font-weight: 600;"><i class="fas fa-comment-dots me-2"></i>Motivos de Devolução</h6>
                            </div>
                            <div class="card-body" style="max-height: 400px; overflow-y: auto; padding: 1rem;">
                                ${motivosDevolucao.length > 0 ? motivosDevolucao.map((item, idx) => `
                                    <div class="mb-3 p-3" style="background: #f8f9fa; border-radius: 10px; border-left: 4px solid #fa709a; border: 1px solid #e9ecef;">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <div>
                                                <strong style="color: #fa709a; font-size: 1rem;">OC: ${item.oc || 'N/A'}</strong>
                                            </div>
                                        </div>
                                        <div class="mb-2">
                                            <small style="color: #6c757d; font-weight: 500;">Tipo de Erro: ${item.tipo_erro || 'N/A'}</small> | 
                                            <small style="color: #6c757d; font-weight: 500;">Operação: ${item.operacao || 'N/A'}</small> | 
                                            <small style="color: #6c757d; font-weight: 500;">Responsável: ${item.responsavel || 'N/A'}</small>
                                        </div>
                                        ${item.hora_envio && item.hora_retorno ? `
                                            <div class="mb-2">
                                                <small style="color: #6c757d; font-weight: 500;">
                                                    <i class="fas fa-clock me-1"></i>Envio: ${item.hora_envio} | Retorno: ${item.hora_retorno}
                                                </small>
                                            </div>
                                        ` : ''}
                                        <p class="mb-0" style="color: #212529; line-height: 1.6; font-size: 0.95rem;">${item.motivo}</p>
                                    </div>
                                `).join('') : '<p class="text-muted text-center py-4" style="color: #6c757d;">Nenhum motivo de devolução encontrado</p>'}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            conteudo.innerHTML = html;
        } catch (error) {
            console.error('❌ Erro ao carregar detalhes:', error);
            conteudo.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Erro ao carregar detalhes: ${error.message}
                </div>
            `;
        }
    }
    </script>
    
    <!-- Modal de Detalhes de Gráfico - Coletas -->
    <div class="modal fade" id="modalDetalhesColetas" tabindex="-1" aria-labelledby="modalDetalhesColetasLabel" aria-hidden="true">
        <div class="modal-dialog modal-xl modal-dialog-scrollable">
            <div class="modal-content" style="background: var(--glass); border: 1px solid var(--glass-border); backdrop-filter: blur(20px);">
                <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%); border-bottom: none; padding: 1.5rem 2rem;">
                    <h5 class="modal-title" id="modalDetalhesColetasLabel" style="color: white; font-weight: 700; font-size: 1.25rem;">
                        <i class="fas fa-info-circle me-2"></i>
                        <span id="modalColetasTitulo">Detalhes</span>
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body" style="background: transparent; color: var(--text-primary); padding: 2rem;">
                    <div id="modalColetasConteudo">
                        <p>Carregando detalhes...</p>
                    </div>
                </div>
                <div class="modal-footer" style="background: transparent; border-top: 1px solid var(--glass-border);">
                    <button type="button" class="btn btn-futuristic" data-bs-dismiss="modal">Fechar</button>
                </div>
            </div>
        </div>
    </div>
    
<!-- Chat IA -->
<link rel="stylesheet" href="../css/chat-ia.css">
<script src="../js/chat-ia.js"></script>
</body>
</html>