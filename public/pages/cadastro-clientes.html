<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro de Clientes - Multimodal Logística</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/permissions.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding-bottom: 2rem;
        }
        
        .header-section {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 2.5rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .header-section h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
        }
        
        .header-section p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .container-custom {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }
        
        .card-modern {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid #e5e7eb;
        }
        
        .btn-primary-custom {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .btn-back {
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }
        
        .btn-back:hover {
            background: #4b5563;
            color: white;
            transform: translateY(-2px);
        }
        
        .cliente-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .cliente-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .cliente-card.inativo {
            opacity: 0.6;
            background: #f9fafb;
        }
        
        .cliente-info {
            flex: 1;
        }
        
        .cliente-nome {
            font-weight: 600;
            font-size: 1.1rem;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        
        .cliente-meta {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        .badge-filial {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            background: #e0e7ff;
            color: var(--primary);
        }
        
        .badge-status {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .badge-ativo {
            background: #d1fae5;
            color: #065f46;
        }
        
        .badge-inativo {
            background: #fee2e2;
            color: #991b1b;
        }
        
        .cliente-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-edit {
            background: #dbeafe;
            color: #3b82f6;
        }
        
        .btn-edit:hover {
            background: #3b82f6;
            color: white;
        }
        
        .btn-delete {
            background: #fee2e2;
            color: var(--danger);
        }
        
        .btn-delete:hover {
            background: var(--danger);
            color: white;
        }
        
        .form-control, .form-select {
            border-radius: 10px;
            border: 1px solid #e5e7eb;
            padding: 0.75rem 1rem;
            transition: all 0.3s;
        }
        
        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .field-error {
            color: var(--danger);
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }
        
        .field-error.show {
            display: block;
        }
        
        .field-input-error {
            border-color: var(--danger) !important;
        }
        
        .filters-section {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }
        
        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }
        
        .alert-custom {
            border-radius: 12px;
            border: none;
            padding: 1rem 1.5rem;
        }
        
        .pagination {
            margin-top: 1.5rem;
        }
        
        .page-link {
            color: var(--primary);
            border-color: #e5e7eb;
        }
        
        .page-link:hover {
            color: var(--secondary);
            background-color: #f3f4f6;
            border-color: #e5e7eb;
        }
        
        .page-item.active .page-link {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-color: var(--primary);
        }
        
        .page-item.disabled .page-link {
            color: #9ca3af;
            cursor: not-allowed;
            background-color: #f9fafb;
        }
        
        .filters-section {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 1.5rem;
            margin-bottom: 2rem;
            border: 1px solid #e5e7eb;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header-section">
        <div class="container-custom">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-users me-3"></i>Cadastro de Clientes</h1>
                    <p>Gerencie o cadastro de clientes por filial</p>
                </div>
                <a href="portal.html" class="btn-back">
                    <i class="fas fa-arrow-left"></i> Voltar
                </a>
            </div>
        </div>
    </div>

    <div class="container-custom">
        <!-- Alertas -->
        <div id="alertContainer"></div>

        <!-- Filtros -->
        <div class="filters-section">
            <div class="row g-3">
                <div class="col-md-3">
                    <label for="filtroFilial" class="form-label fw-bold">Filtrar por Filial</label>
                    <select id="filtroFilial" class="form-select">
                        <option value="">Todas as Filiais</option>
                        <option value="JBO">JBO</option>
                        <option value="CABO">CABO</option>
                        <option value="AL">AL</option>
                        <option value="SP">SP</option>
                        <option value="BA">BA</option>
                        <option value="CE">CE</option>
                        <option value="SE">SE</option>
                        <option value="PB">PB</option>
                        <option value="PE">PE</option>
                        <option value="AMBEV">AMBEV</option>
                        <option value="US">US</option>
                        <option value="PARATIBE">PARATIBE</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filtroOperacao" class="form-label fw-bold">Filtrar por Operação</label>
                    <select id="filtroOperacao" class="form-select">
                        <option value="">Todas as Operações</option>
                        <optgroup label="Operações por Filial">
                            <option value="operacoes_jbo">Operações - Jaboatão (JBO)</option>
                            <option value="operacoes_cabo">Operações - Cabo (CABO)</option>
                            <option value="operacoes_sp">Operações - São Paulo (SP)</option>
                            <option value="operacoes_ba">Operações - Simões Filho (BA)</option>
                            <option value="operacoes_se">Operações - Aracaju (SE)</option>
                            <option value="operacoes_al">Operações - Maceió (AL)</option>
                            <option value="operacoes_pe">Operações - Recife (PE)</option>
                            <option value="operacoes_pb">Operações - João Pessoa (PB)</option>
                            <option value="operacoes_ce">Operações - Fortaleza (CE)</option>
                            <option value="operacoes_ambev">Operações - Ambev (AMBEV)</option>
                            <option value="operacoes_us">Operações - Usinas (US)</option>
                            <option value="operacoes_paratibe">Operações - Paratibe (PARATIBE)</option>
                        </optgroup>
                        <optgroup label="Outras Áreas">
                            <option value="qualidade">Qualidade</option>
                            <option value="price">Price</option>
                            <option value="comercial">Comercial</option>
                            <option value="rh">Recursos Humanos</option>
                            <option value="contas_pagar">Contas a Pagar</option>
                            <option value="contas_receber">Contas a Receber</option>
                            <option value="ti">Tecnologia da Informação</option>
                            <option value="seguranca">Segurança do Trabalho</option>
                            <option value="manutencao">Manutenção</option>
                            <option value="estoque">Estoque</option>
                            <option value="compras">Compras</option>
                            <option value="cs">CS</option>
                            <option value="frota">Frota</option>
                            <option value="documentacao">Documentação</option>
                            <option value="administrativo">Administrativo</option>
                            <option value="outros">Outros</option>
                        </optgroup>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filtroStatus" class="form-label fw-bold">Filtrar por Status</label>
                    <select id="filtroStatus" class="form-select">
                        <option value="">Todos</option>
                        <option value="ativo">Ativos</option>
                        <option value="inativo">Inativos</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filtroBusca" class="form-label fw-bold">Buscar (Razão Social/CNPJ)</label>
                    <input type="text" id="filtroBusca" class="form-control" placeholder="Digite nome ou CNPJ...">
                </div>
            </div>
            <div class="row g-3 mt-2">
                <div class="col-md-3">
                    <label for="filtroCidadeOrigem" class="form-label fw-bold">Cidade Origem</label>
                    <input type="text" id="filtroCidadeOrigem" class="form-control" placeholder="Digite a cidade...">
                </div>
                <div class="col-md-2">
                    <label for="filtroUFOrigem" class="form-label fw-bold">UF Origem</label>
                    <select id="filtroUFOrigem" class="form-select">
                        <option value="">Todas</option>
                        <option value="AC">AC</option>
                        <option value="AL">AL</option>
                        <option value="AP">AP</option>
                        <option value="AM">AM</option>
                        <option value="BA">BA</option>
                        <option value="CE">CE</option>
                        <option value="DF">DF</option>
                        <option value="ES">ES</option>
                        <option value="GO">GO</option>
                        <option value="MA">MA</option>
                        <option value="MT">MT</option>
                        <option value="MS">MS</option>
                        <option value="MG">MG</option>
                        <option value="PA">PA</option>
                        <option value="PB">PB</option>
                        <option value="PR">PR</option>
                        <option value="PE">PE</option>
                        <option value="PI">PI</option>
                        <option value="RJ">RJ</option>
                        <option value="RN">RN</option>
                        <option value="RS">RS</option>
                        <option value="RO">RO</option>
                        <option value="RR">RR</option>
                        <option value="SC">SC</option>
                        <option value="SP">SP</option>
                        <option value="SE">SE</option>
                        <option value="TO">TO</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label for="filtroCidadeDestino" class="form-label fw-bold">Cidade Destino</label>
                    <input type="text" id="filtroCidadeDestino" class="form-control" placeholder="Digite a cidade...">
                </div>
                <div class="col-md-2">
                    <label for="filtroUFDestino" class="form-label fw-bold">UF Destino</label>
                    <select id="filtroUFDestino" class="form-select">
                        <option value="">Todas</option>
                        <option value="AC">AC</option>
                        <option value="AL">AL</option>
                        <option value="AP">AP</option>
                        <option value="AM">AM</option>
                        <option value="BA">BA</option>
                        <option value="CE">CE</option>
                        <option value="DF">DF</option>
                        <option value="ES">ES</option>
                        <option value="GO">GO</option>
                        <option value="MA">MA</option>
                        <option value="MT">MT</option>
                        <option value="MS">MS</option>
                        <option value="MG">MG</option>
                        <option value="PA">PA</option>
                        <option value="PB">PB</option>
                        <option value="PR">PR</option>
                        <option value="PE">PE</option>
                        <option value="PI">PI</option>
                        <option value="RJ">RJ</option>
                        <option value="RN">RN</option>
                        <option value="RS">RS</option>
                        <option value="RO">RO</option>
                        <option value="RR">RR</option>
                        <option value="SC">SC</option>
                        <option value="SP">SP</option>
                        <option value="SE">SE</option>
                        <option value="TO">TO</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="filtroTipoVeiculo" class="form-label fw-bold">Tipo Veículo</label>
                    <select id="filtroTipoVeiculo" class="form-select">
                        <option value="">Todos</option>
                        <option value="3/4">3/4</option>
                        <option value="Fiorino">Fiorino</option>
                        <option value="Toco">Toco</option>
                        <option value="VLC">VLC</option>
                        <option value="Bitruck">Bitruck</option>
                        <option value="Truck">Truck</option>
                        <option value="Carreta">Carreta</option>
                        <option value="Rodotrem">Rodotrem</option>
                        <option value="Cavalo Mecânico">Cavalo Mecânico</option>
                        <option value="Outro">Outro</option>
                    </select>
                </div>
            </div>
            <div class="row g-3 mt-2">
                <div class="col-md-3">
                    <label for="filtroTipoProduto" class="form-label fw-bold">Tipo Produto</label>
                    <input type="text" id="filtroTipoProduto" class="form-control" placeholder="Digite o tipo de produto...">
                </div>
                <div class="col-md-3 d-flex align-items-end">
                    <button type="button" class="btn btn-secondary me-2" onclick="limparFiltros()">
                        <i class="fas fa-times me-2"></i>Limpar Filtros
                    </button>
                    <button type="button" class="btn btn-primary-custom" onclick="aplicarFiltros()">
                        <i class="fas fa-search me-2"></i>Filtrar
                    </button>
                </div>
            </div>
        </div>

        <!-- Botões de Ação (apenas para admins) -->
        <div id="adminActions" style="display: none;" class="mb-3 d-flex gap-2 flex-wrap">
            <button class="btn btn-primary-custom" onclick="abrirFormulario()">
                <i class="fas fa-plus me-2"></i>Novo Cliente
            </button>
            <button class="btn btn-primary-custom" onclick="abrirFormularioMassa()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <i class="fas fa-upload me-2"></i>Cadastro em Massa
            </button>
            <button class="btn btn-primary-custom" onclick="baixarModeloCSV()" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                <i class="fas fa-download me-2"></i>Baixar Modelo CSV
            </button>
            <button class="btn btn-primary-custom" onclick="abrirImportacaoCSV()" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                <i class="fas fa-file-import me-2"></i>Importar CSV
            </button>
            <button class="btn btn-primary-custom" onclick="exportarExcel()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                <i class="fas fa-file-excel me-2"></i>Exportar Excel
            </button>
        </div>

        <!-- Lista de Clientes -->
        <div class="card-modern">
            <h3 class="mb-4"><i class="fas fa-list me-2"></i>Clientes Cadastrados</h3>
            <div id="clientesList">
                <div class="empty-state">
                    <i class="fas fa-spinner fa-spin"></i>
                    <p>Carregando clientes...</p>
                </div>
            </div>
            <!-- Paginação -->
            <div id="paginacaoContainer" class="mt-4">
                <!-- Paginação será renderizada aqui -->
            </div>
        </div>

        <!-- Modal Formulário -->
        <div class="modal fade" id="clienteModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content" style="border-radius: 16px; border: none;">
                    <div class="modal-header" style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%); color: white; border-radius: 16px 16px 0 0;">
                        <h5 class="modal-title" id="modalTitle">
                            <i class="fas fa-user-plus me-2"></i>Novo Cliente
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <form id="clienteForm">
                            <input type="hidden" id="clienteId">
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="clienteCNPJ" class="form-label fw-bold">CNPJ <span class="text-danger">*</span></label>
                                    <input type="text" id="clienteCNPJ" class="form-control" required 
                                           placeholder="00.000.000/0000-00"
                                           maxlength="18"
                                           aria-describedby="clienteCNPJError">
                                    <div class="field-error" id="clienteCNPJError"></div>
                                </div>
                                
                                <div class="col-md-6 mb-3">
                                <label for="clienteNome" class="form-label fw-bold">Razão Social <span class="text-danger">*</span></label>
                                <input type="text" id="clienteNome" class="form-control" required 
                                       placeholder="Ex: ARRUDA E MELO COMERCIO E DISTRIBUICAO DE ALIMENTOS"
                                       aria-describedby="clienteNomeError">
                                <div class="field-error" id="clienteNomeError"></div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="clienteCidadeOrigem" class="form-label fw-bold">Cidade de Origem <span class="text-danger">*</span></label>
                                    <input type="text" id="clienteCidadeOrigem" class="form-control" required 
                                           placeholder="Ex: Recife"
                                           aria-describedby="clienteCidadeOrigemError">
                                    <div class="field-error" id="clienteCidadeOrigemError"></div>
                                </div>
                                
                                <div class="col-md-2 mb-3">
                                    <label for="clienteUFOrigem" class="form-label fw-bold">UF Origem <span class="text-danger">*</span></label>
                                    <select id="clienteUFOrigem" class="form-select" required aria-describedby="clienteUFOrigemError">
                                        <option value="">UF</option>
                                        <option value="AC">AC</option>
                                        <option value="AL">AL</option>
                                        <option value="AP">AP</option>
                                        <option value="AM">AM</option>
                                        <option value="BA">BA</option>
                                        <option value="CE">CE</option>
                                        <option value="DF">DF</option>
                                        <option value="ES">ES</option>
                                        <option value="GO">GO</option>
                                        <option value="MA">MA</option>
                                        <option value="MT">MT</option>
                                        <option value="MS">MS</option>
                                        <option value="MG">MG</option>
                                        <option value="PA">PA</option>
                                        <option value="PB">PB</option>
                                        <option value="PR">PR</option>
                                        <option value="PE">PE</option>
                                        <option value="PI">PI</option>
                                        <option value="RJ">RJ</option>
                                        <option value="RN">RN</option>
                                        <option value="RS">RS</option>
                                        <option value="RO">RO</option>
                                        <option value="RR">RR</option>
                                        <option value="SC">SC</option>
                                        <option value="SP">SP</option>
                                        <option value="SE">SE</option>
                                        <option value="TO">TO</option>
                                    </select>
                                    <div class="field-error" id="clienteUFOrigemError"></div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="clienteCidadeDestino" class="form-label fw-bold">Cidade de Destino <span class="text-danger">*</span></label>
                                    <input type="text" id="clienteCidadeDestino" class="form-control" required 
                                           placeholder="Ex: São Paulo"
                                           aria-describedby="clienteCidadeDestinoError">
                                    <div class="field-error" id="clienteCidadeDestinoError"></div>
                                </div>
                                
                                <div class="col-md-2 mb-3">
                                    <label for="clienteUFDestino" class="form-label fw-bold">UF Destino <span class="text-danger">*</span></label>
                                    <select id="clienteUFDestino" class="form-select" required aria-describedby="clienteUFDestinoError">
                                        <option value="">UF</option>
                                        <option value="AC">AC</option>
                                        <option value="AL">AL</option>
                                        <option value="AP">AP</option>
                                        <option value="AM">AM</option>
                                        <option value="BA">BA</option>
                                        <option value="CE">CE</option>
                                        <option value="DF">DF</option>
                                        <option value="ES">ES</option>
                                        <option value="GO">GO</option>
                                        <option value="MA">MA</option>
                                        <option value="MT">MT</option>
                                        <option value="MS">MS</option>
                                        <option value="MG">MG</option>
                                        <option value="PA">PA</option>
                                        <option value="PB">PB</option>
                                        <option value="PR">PR</option>
                                        <option value="PE">PE</option>
                                        <option value="PI">PI</option>
                                        <option value="RJ">RJ</option>
                                        <option value="RN">RN</option>
                                        <option value="RS">RS</option>
                                        <option value="RO">RO</option>
                                        <option value="RR">RR</option>
                                        <option value="SC">SC</option>
                                        <option value="SP">SP</option>
                                        <option value="SE">SE</option>
                                        <option value="TO">TO</option>
                                    </select>
                                    <div class="field-error" id="clienteUFDestinoError"></div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <label for="clienteTipoProduto" class="form-label fw-bold">Tipo de Produto <span class="text-danger">*</span></label>
                                    <input type="text" id="clienteTipoProduto" class="form-control" required 
                                           placeholder="Ex: Cimento, Areia, etc."
                                           aria-describedby="clienteTipoProdutoError">
                                    <div class="field-error" id="clienteTipoProdutoError"></div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="clienteCodigoTabela" class="form-label fw-bold">Código da Tabela <span class="text-danger">*</span></label>
                                    <input type="text" id="clienteCodigoTabela" class="form-control" required 
                                           placeholder="Ex: TAB001"
                                           aria-describedby="clienteCodigoTabelaError">
                                    <div class="field-error" id="clienteCodigoTabelaError"></div>
                                </div>
                                
                                <div class="col-md-4 mb-3">
                                    <label for="clienteTipoVeiculo" class="form-label fw-bold">Tipo Veículo <span class="text-danger">*</span></label>
                                    <select id="clienteTipoVeiculo" class="form-select" required aria-describedby="clienteTipoVeiculoError">
                                        <option value="">Selecione o tipo de veículo</option>
                                        <option value="3/4">3/4</option>
                                        <option value="Fiorino">Fiorino</option>
                                        <option value="Toco">Toco</option>
                                        <option value="VLC">VLC</option>
                                        <option value="Bitruck">Bitruck</option>
                                        <option value="Truck">Truck</option>
                                        <option value="Carreta">Carreta</option>
                                        <option value="Rodotrem">Rodotrem</option>
                                        <option value="Cavalo Mecânico">Cavalo Mecânico</option>
                                        <option value="Outro">Outro</option>
                                    </select>
                                    <div class="field-error" id="clienteTipoVeiculoError"></div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                <label for="clienteFilial" class="form-label fw-bold">Filial <span class="text-danger">*</span></label>
                                <select id="clienteFilial" class="form-select" required aria-describedby="clienteFilialError">
                                    <option value="">Selecione a filial</option>
                                    <option value="JBO">JBO</option>
                                    <option value="CABO">CABO</option>
                                    <option value="AL">AL</option>
                                    <option value="SP">SP</option>
                                    <option value="BA">BA</option>
                                    <option value="CE">CE</option>
                                    <option value="SE">SE</option>
                                    <option value="PB">PB</option>
                                    <option value="PE">PE</option>
                                    <option value="AMBEV">AMBEV</option>
                                    <option value="US">US</option>
                                    <option value="PARATIBE">PARATIBE</option>
                                </select>
                                <div class="field-error" id="clienteFilialError"></div>
                            </div>
                            
                                <div class="col-md-8 mb-3">
                                <label for="clienteOperacao" class="form-label fw-bold">Operação</label>
                                <select id="clienteOperacao" class="form-select" aria-describedby="clienteOperacaoError">
                                    <option value="">Sem operação específica</option>
                                    <optgroup label="Operações por Filial">
                                        <option value="operacoes_jbo">Operações - Jaboatão (JBO)</option>
                                        <option value="operacoes_cabo">Operações - Cabo (CABO)</option>
                                        <option value="operacoes_sp">Operações - São Paulo (SP)</option>
                                        <option value="operacoes_ba">Operações - Simões Filho (BA)</option>
                                        <option value="operacoes_se">Operações - Aracaju (SE)</option>
                                        <option value="operacoes_al">Operações - Maceió (AL)</option>
                                        <option value="operacoes_pe">Operações - Recife (PE)</option>
                                        <option value="operacoes_pb">Operações - João Pessoa (PB)</option>
                                        <option value="operacoes_ce">Operações - Fortaleza (CE)</option>
                                        <option value="operacoes_ambev">Operações - Ambev (AMBEV)</option>
                                        <option value="operacoes_us">Operações - Usinas (US)</option>
                                        <option value="operacoes_paratibe">Operações - Paratibe (PARATIBE)</option>
                                    </optgroup>
                                    <optgroup label="Outras Áreas">
                                        <option value="qualidade">Qualidade</option>
                                        <option value="price">Price</option>
                                        <option value="comercial">Comercial</option>
                                        <option value="rh">Recursos Humanos</option>
                                        <option value="contas_pagar">Contas a Pagar</option>
                                        <option value="contas_receber">Contas a Receber</option>
                                        <option value="ti">Tecnologia da Informação</option>
                                        <option value="seguranca">Segurança do Trabalho</option>
                                        <option value="manutencao">Manutenção</option>
                                        <option value="estoque">Estoque</option>
                                        <option value="compras">Compras</option>
                                        <option value="cs">CS</option>
                                        <option value="frota">Frota</option>
                                        <option value="documentacao">Documentação</option>
                                        <option value="administrativo">Administrativo</option>
                                        <option value="outros">Outros</option>
                                    </optgroup>
                                </select>
                                <small class="form-text text-muted">Opcional: vincule o cliente a uma operação específica</small>
                                <div class="field-error" id="clienteOperacaoError"></div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="clienteAtivo" checked>
                                    <label class="form-check-label fw-bold" for="clienteAtivo">
                                        Cliente Ativo
                                    </label>
                                </div>
                            </div>
                            
                            <div class="d-flex gap-2 justify-content-end mt-4">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-primary-custom">
                                    <i class="fas fa-save me-2"></i>Salvar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Cadastro em Massa -->
        <div class="modal fade" id="clienteMassaModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content" style="border-radius: 16px; border: none;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border-radius: 16px 16px 0 0;">
                        <h5 class="modal-title">
                            <i class="fas fa-upload me-2"></i>Cadastro de Clientes em Massa
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Formato:</strong> Uma linha por cliente. Formato: <code>CNPJ | Nome | Cidade Origem | UF Origem | Cidade Destino | UF Destino | Tipo Produto | Código Tabela | Filial | Operação</code>
                            <br><small>Exemplo: 12.345.678/0001-90 | VIVIX / OWENS - JAZIDA | Recife | PE | São Paulo | SP | Cimento | TAB001 | JBO | operacoes_jbo</small>
                            <br><small><strong>Operação é opcional.</strong> Se não informar, deixe em branco ou omita.</small>
                        </div>
                        
                        <div class="mb-3">
                            <label for="clientesMassa" class="form-label fw-bold">Lista de Clientes <span class="text-danger">*</span></label>
                            <textarea id="clientesMassa" class="form-control" rows="15" 
                                      placeholder="12.345.678/0001-90 | VIVIX / OWENS - JAZIDA | Recife | PE | São Paulo | SP | Cimento | TAB001 | JBO | operacoes_jbo&#10;23.456.789/0001-01 | CLIENTE 2 | Maceió | AL | Recife | PE | Areia | TAB002 | CABO | operacoes_cabo"
                                      style="font-family: monospace; font-size: 0.9rem;"></textarea>
                            <small class="form-text text-muted">Separe cada campo com <code>|</code> (pipe). Uma linha por cliente.</small>
                        </div>

                        <div id="previewMassa" class="mb-3" style="display: none;">
                            <h6>Preview (serão processados):</h6>
                            <div class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto;">
                                <div id="previewContent"></div>
                            </div>
                        </div>
                        
                        <div class="d-flex gap-2 justify-content-end mt-4">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                            <button type="button" class="btn btn-success" onclick="previewMassa()">
                                <i class="fas fa-eye me-2"></i>Preview
                            </button>
                            <button type="button" class="btn btn-primary-custom" onclick="salvarClientesMassa()">
                                <i class="fas fa-save me-2"></i>Salvar Todos
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Importação CSV -->
        <div class="modal fade" id="importacaoCSVModal" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content" style="border-radius: 16px; border: none;">
                    <div class="modal-header" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; border-radius: 16px 16px 0 0;">
                        <h5 class="modal-title">
                            <i class="fas fa-file-import me-2"></i>Importar Clientes via CSV
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body p-4">
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Formato do CSV:</strong> CNPJ, Nome, Cidade Origem, UF Origem, Cidade Destino, UF Destino, Tipo Produto, Código Tabela, Filial, Operação (opcional)
                            <br><small>Baixe o modelo CSV para ver o formato correto.</small>
                        </div>
                        
                        <form id="formImportacaoCSV" enctype="multipart/form-data">
                            <div class="mb-3">
                                <label for="arquivoCSV" class="form-label fw-bold">Selecionar arquivo CSV <span class="text-danger">*</span></label>
                                <input type="file" id="arquivoCSV" class="form-control" accept=".csv" required>
                                <small class="form-text text-muted">Apenas arquivos .csv são aceitos</small>
                            </div>

                            <div id="resultadoImportacao" class="mt-3" style="display: none;">
                                <h6>Resultado da Importação:</h6>
                                <div id="resultadoImportacaoConteudo" class="bg-light p-3 rounded" style="max-height: 200px; overflow-y: auto;"></div>
                            </div>
                            
                            <div class="d-flex gap-2 justify-content-end mt-4">
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                <button type="submit" class="btn btn-primary-custom" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                                    <i class="fas fa-upload me-2"></i>Importar
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // ========== SISTEMA DE TRATAMENTO DE ERROS ==========
        class ErrorHandler {
            static errorMessages = {
                'PGRST301': 'Sessão expirada. Faça login novamente.',
                'PGRST116': 'Registro não encontrado.',
                '23505': 'Este registro já existe no sistema.',
                '23503': 'Não é possível excluir. Existem registros relacionados.',
                '23502': 'Campo obrigatório não preenchido.',
                'NetworkError': 'Erro de conexão. Verifique sua internet.',
                'TimeoutError': 'Tempo de espera esgotado. Tente novamente.',
                'default': 'Ocorreu um erro inesperado. Tente novamente.'
            };

            static handle(error, context = 'Sistema') {
                console.error(`❌ [${context}]`, error);
                
                const userMessage = this.getUserFriendlyMessage(error);
                mostrarAlerta(userMessage, 'danger');
                
                return { message: userMessage, code: error.code, originalError: error, context };
            }

            static getUserFriendlyMessage(error) {
                if (error.code && this.errorMessages[error.code]) {
                    return this.errorMessages[error.code];
                }

                if (error.message) {
                    const message = error.message.toLowerCase();
                    if (message.includes('network') || message.includes('fetch')) {
                        return this.errorMessages['NetworkError'];
                    }
                    if (message.includes('timeout')) {
                        return this.errorMessages['TimeoutError'];
                    }
                    if (message.includes('session') || message.includes('token') || message.includes('unauthorized')) {
                        return this.errorMessages['PGRST301'];
                    }
                    if (message.includes('not found') || message.includes('não encontrado')) {
                        return this.errorMessages['PGRST116'];
                    }
                }

                return error.message || this.errorMessages['default'];
            }
        }

        // ========== SISTEMA DE VALIDAÇÃO ==========
        class Validator {
            constructor(schema) {
                this.schema = schema;
            }

            validate(data) {
                const errors = [];
                
                for (const [field, rules] of Object.entries(this.schema)) {
                    const value = data[field];
                    const fieldErrors = [];

                    // Verificar obrigatoriedade
                    if (rules.required && (value === undefined || value === null || value === '')) {
                        fieldErrors.push(rules.message || `${field} é obrigatório`);
                    }

                    // Se o campo tem valor, validar
                    if (value !== undefined && value !== null && value !== '') {
                        // Validar tamanho mínimo
                        if (rules.minLength && value.length < rules.minLength) {
                            fieldErrors.push(rules.message || `${field} deve ter no mínimo ${rules.minLength} caracteres`);
                        }

                        // Validar tamanho máximo
                        if (rules.maxLength && value.length > rules.maxLength) {
                            fieldErrors.push(rules.message || `${field} deve ter no máximo ${rules.maxLength} caracteres`);
                        }

                        // Validar padrão (regex)
                        if (rules.pattern && !rules.pattern.test(value)) {
                            fieldErrors.push(rules.message || `${field} tem formato inválido`);
                        }

                        // Validar valores permitidos
                        if (rules.oneOf && !rules.oneOf.includes(value)) {
                            fieldErrors.push(rules.message || `${field} deve ser um dos valores permitidos`);
                        }
                    }

                    if (fieldErrors.length > 0) {
                        errors.push({ field, message: fieldErrors[0] });
                    }
                }

                return errors;
            }
        }

        // ✅ Função para normalizar CNPJ (aceita com ou sem máscara)
        function normalizarCNPJ(cnpjInput) {
            if (!cnpjInput || typeof cnpjInput !== 'string') return null;
            
            // Remover todos os caracteres não numéricos
            const apenasNumeros = cnpjInput.trim().replace(/\D/g, '');
            
            // Verificar se tem 14 dígitos
            if (apenasNumeros.length !== 14) {
                return null;
            }
            
            // Aplicar máscara: 00.000.000/0000-00
            return `${apenasNumeros.substring(0, 2)}.${apenasNumeros.substring(2, 5)}.${apenasNumeros.substring(5, 8)}/${apenasNumeros.substring(8, 12)}-${apenasNumeros.substring(12, 14)}`;
        }

        // Schema de validação
        const clienteSchema = {
            cnpj: {
                required: true,
                // Aceita CNPJ com ou sem máscara (14 dígitos)
                pattern: /^(\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}|\d{14})$/,
                message: 'CNPJ inválido. Deve ter 14 dígitos. Formatos aceitos: 00.000.000/0000-00 ou 00000000000000'
            },
            nome: {
                required: true,
                minLength: 2,
                maxLength: 200,
                pattern: /^[a-zA-ZÀ-ÿ0-9\s\/\-\.]+$/,
                message: 'Razão Social deve ter entre 2 e 200 caracteres e conter apenas letras (com acentos), números, espaços, barras, hífens e pontos'
            },
            cidade_origem: {
                required: true,
                minLength: 2,
                maxLength: 100,
                message: 'Cidade de origem deve ter entre 2 e 100 caracteres'
            },
            uf_origem: {
                required: true,
                oneOf: ['AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA', 'MT', 'MS', 'MG', 'PA', 'PB', 'PR', 'PE', 'PI', 'RJ', 'RN', 'RS', 'RO', 'RR', 'SC', 'SP', 'SE', 'TO'],
                message: 'Selecione uma UF de origem válida'
            },
            cidade_destino: {
                required: true,
                minLength: 2,
                maxLength: 100,
                message: 'Cidade de destino deve ter entre 2 e 100 caracteres'
            },
            uf_destino: {
                required: true,
                oneOf: ['AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA', 'MT', 'MS', 'MG', 'PA', 'PB', 'PR', 'PE', 'PI', 'RJ', 'RN', 'RS', 'RO', 'RR', 'SC', 'SP', 'SE', 'TO'],
                message: 'Selecione uma UF de destino válida'
            },
            tipo_produto: {
                required: true,
                minLength: 2,
                maxLength: 100,
                message: 'Tipo de produto deve ter entre 2 e 100 caracteres'
            },
            codigo_tabela: {
                required: true,
                minLength: 1,
                maxLength: 50,
                message: 'Código da tabela deve ter entre 1 e 50 caracteres'
            },
            filial: {
                required: true,
                oneOf: ['JBO', 'CABO', 'AL', 'SP', 'BA', 'CE', 'SE', 'PB', 'PE', 'AMBEV', 'US', 'PARATIBE'],
                message: 'Selecione uma filial válida'
            }
        };
        
        // Função para aplicar máscara de CNPJ
        function aplicarMascaraCNPJ(input) {
            let value = input.value.replace(/\D/g, '');
            if (value.length <= 14) {
                value = value.replace(/^(\d{2})(\d)/, '$1.$2');
                value = value.replace(/^(\d{2})\.(\d{3})(\d)/, '$1.$2.$3');
                value = value.replace(/\.(\d{3})(\d)/, '.$1/$2');
                value = value.replace(/(\d{4})(\d)/, '$1-$2');
            }
            input.value = value;
        }

        let clientes = [];
        let clientesFiltrados = [];
        let isAdmin = false;
        let clienteModal = null;
        let importacaoCSVModal = null;
        
        // Paginação
        let paginaAtual = 1;
        const itensPorPagina = 20;
        let totalPaginas = 1;
        let totalClientes = 0;

        // Inicialização
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // Verificar se é admin (sem redirecionar se falhar)
                isAdmin = await verificarAdmin();
                if (isAdmin) {
                    document.getElementById('adminActions').style.display = 'block';
                }

                // Inicializar modais
                clienteModal = new bootstrap.Modal(document.getElementById('clienteModal'));
                importacaoCSVModal = new bootstrap.Modal(document.getElementById('importacaoCSVModal'));

                // Carregar clientes
                await carregarClientes();

                // Event listeners para filtros
                // Event listeners para filtros (agora com debounce para busca)
                document.getElementById('filtroBusca').addEventListener('input', debounce(aplicarFiltros, 500));
                document.getElementById('filtroCidadeOrigem').addEventListener('input', debounce(aplicarFiltros, 500));
                document.getElementById('filtroCidadeDestino').addEventListener('input', debounce(aplicarFiltros, 500));
                document.getElementById('filtroTipoProduto').addEventListener('input', debounce(aplicarFiltros, 500));
                
                document.getElementById('filtroFilial').addEventListener('change', aplicarFiltros);
                document.getElementById('filtroOperacao').addEventListener('change', aplicarFiltros);
                document.getElementById('filtroStatus').addEventListener('change', aplicarFiltros);
                document.getElementById('filtroUFOrigem').addEventListener('change', aplicarFiltros);
                document.getElementById('filtroUFDestino').addEventListener('change', aplicarFiltros);
                document.getElementById('filtroTipoVeiculo').addEventListener('change', aplicarFiltros);

                // Event listener para formulário
                document.getElementById('clienteForm').addEventListener('submit', salvarCliente);
                
                // Event listener para máscara de CNPJ
                const cnpjInput = document.getElementById('clienteCNPJ');
                if (cnpjInput) {
                    cnpjInput.addEventListener('input', function() {
                        aplicarMascaraCNPJ(this);
                    });
                }

                // Event listener para formulário de importação CSV
                const formImportacao = document.getElementById('formImportacaoCSV');
                if (formImportacao) {
                    formImportacao.addEventListener('submit', async (e) => {
                        e.preventDefault();

                        if (!isAdmin) {
                            mostrarAlerta('Você não tem permissão para importar clientes', 'danger');
                            return;
                        }

                        const arquivo = document.getElementById('arquivoCSV').files[0];
                        if (!arquivo) {
                            mostrarAlerta('Selecione um arquivo CSV', 'warning');
                            return;
                        }

                        const formData = new FormData();
                        formData.append('csv', arquivo);

                        try {
                            const btn = e.target.querySelector('button[type="submit"]');
                            btn.disabled = true;
                            btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Importando...';

                            const response = await fetch('/api/clientes/importar-csv', {
                                method: 'POST',
                                body: formData
                            });

                            const data = await response.json();

                            const resultadoDiv = document.getElementById('resultadoImportacao');
                            const resultadoConteudo = document.getElementById('resultadoImportacaoConteudo');

                            if (data.success) {
                                let html = `<div class="alert alert-success mb-2">`;
                                html += `<strong>✅ Importação concluída!</strong><br>`;
                                html += `Total processado: ${data.total}<br>`;
                                html += `✅ Sucessos: ${data.sucessos}<br>`;
                                html += `❌ Falhas: ${data.falhas}`;
                                html += `</div>`;

                                if (data.detalhesSucessos && data.detalhesSucessos.length > 0) {
                                    html += `<h6>Sucessos (primeiros 10):</h6><ul class="list-unstyled">`;
                                    data.detalhesSucessos.forEach(detalhe => {
                                        html += `<li>✅ ${detalhe}</li>`;
                                    });
                                    html += `</ul>`;
                                }

                                if (data.detalhesFalhas && data.detalhesFalhas.length > 0) {
                                    html += `<h6>Falhas (primeiros 10):</h6><ul class="list-unstyled">`;
                                    data.detalhesFalhas.forEach(detalhe => {
                                        html += `<li>❌ ${detalhe}</li>`;
                                    });
                                    html += `</ul>`;
                                }

                                resultadoConteudo.innerHTML = html;
                                resultadoDiv.style.display = 'block';

                                if (data.sucessos > 0) {
                                    await carregarClientes();
                                }
                            } else {
                                resultadoConteudo.innerHTML = `<div class="alert alert-danger">${data.error || 'Erro ao importar'}</div>`;
                                resultadoDiv.style.display = 'block';
                            }

                        } catch (error) {
                            ErrorHandler.handle(error, 'Erro ao importar CSV');
                        } finally {
                            const btn = e.target.querySelector('button[type="submit"]');
                            btn.disabled = false;
                            btn.innerHTML = '<i class="fas fa-upload me-2"></i>Importar';
                        }
                    });
                }
            } catch (error) {
                console.error('Erro ao inicializar página:', error);
                // Não redirecionar, apenas mostrar erro
                ErrorHandler.handle(error, 'Erro ao inicializar');
            }
        });

        // Verificar se é admin
        async function verificarAdmin() {
            try {
                const response = await fetch('/api/auth/user');
                if (!response.ok) {
                    return false;
                }
                const data = await response.json();
                return data.user?.isAdmin === true || data.user?.role === 'admin';
            } catch (error) {
                console.error('Erro ao verificar admin:', error);
                return false;
            }
        }

        // Função debounce para otimizar buscas
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Carregar clientes (agora usa filtros e paginação)
        async function carregarClientes() {
            try {
                await aplicarFiltros();
            } catch (error) {
                ErrorHandler.handle(error, 'Erro ao carregar clientes');
                document.getElementById('clientesList').innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Erro ao carregar clientes. Tente novamente.</p>
                    </div>
                `;
            }
        }

        async function aplicarFiltros() {
            try {
                // Resetar para primeira página ao aplicar filtros
                paginaAtual = 1;
                
                // Coletar filtros
                const params = new URLSearchParams();
                
                const filial = document.getElementById('filtroFilial').value;
                const operacao = document.getElementById('filtroOperacao').value;
                const status = document.getElementById('filtroStatus').value;
                const busca = document.getElementById('filtroBusca').value.trim();
                const cidadeOrigem = document.getElementById('filtroCidadeOrigem').value.trim();
                const cidadeDestino = document.getElementById('filtroCidadeDestino').value.trim();
                const ufOrigem = document.getElementById('filtroUFOrigem').value;
                const ufDestino = document.getElementById('filtroUFDestino').value;
                const tipoVeiculo = document.getElementById('filtroTipoVeiculo').value;
                const tipoProduto = document.getElementById('filtroTipoProduto').value.trim();

                if (filial) params.append('filial', filial);
                if (operacao) params.append('operacao', operacao);
                if (status) params.append('status', status);
                if (busca) params.append('busca', busca);
                if (cidadeOrigem) params.append('cidade_origem', cidadeOrigem);
                if (cidadeDestino) params.append('cidade_destino', cidadeDestino);
                if (ufOrigem) params.append('uf_origem', ufOrigem);
                if (ufDestino) params.append('uf_destino', ufDestino);
                if (tipoVeiculo) params.append('tipo_veiculo', tipoVeiculo);
                if (tipoProduto) params.append('tipo_produto', tipoProduto);
                
                // Parâmetros de paginação
                params.append('page', paginaAtual);
                params.append('limit', itensPorPagina);

                const response = await fetch(`/api/clientes?${params.toString()}`);
                const data = await response.json();
                
                if (data.success) {
                    clientesFiltrados = data.clientes || [];
                    totalClientes = data.pagination?.total || 0;
                    totalPaginas = data.pagination?.totalPages || 1;
                    paginaAtual = data.pagination?.page || 1;
                    
                    renderizarClientes(clientesFiltrados);
                    renderizarPaginacao();
                } else {
                    throw new Error(data.error || 'Erro ao carregar clientes');
                }
            } catch (error) {
                ErrorHandler.handle(error, 'Erro ao aplicar filtros');
            }
        }

        function limparFiltros() {
            document.getElementById('filtroFilial').value = '';
            document.getElementById('filtroOperacao').value = '';
            document.getElementById('filtroStatus').value = '';
            document.getElementById('filtroBusca').value = '';
            document.getElementById('filtroCidadeOrigem').value = '';
            document.getElementById('filtroCidadeDestino').value = '';
            document.getElementById('filtroUFOrigem').value = '';
            document.getElementById('filtroUFDestino').value = '';
            document.getElementById('filtroTipoVeiculo').value = '';
            document.getElementById('filtroTipoProduto').value = '';
            aplicarFiltros();
        }

        function renderizarPaginacao() {
            const paginacaoContainer = document.getElementById('paginacaoContainer');
            if (!paginacaoContainer) return;

            if (totalPaginas <= 1) {
                paginacaoContainer.innerHTML = '';
                return;
            }

            let html = '<nav aria-label="Paginação de clientes"><ul class="pagination justify-content-center">';
            
            // Botão Anterior
            html += `<li class="page-item ${paginaAtual === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="event.preventDefault(); irParaPagina(${paginaAtual - 1})" aria-label="Anterior">
                    <span aria-hidden="true">&laquo;</span>
                </a>
            </li>`;

            // Números das páginas
            const maxPagesToShow = 5;
            let startPage = Math.max(1, paginaAtual - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPaginas, startPage + maxPagesToShow - 1);
            
            if (endPage - startPage < maxPagesToShow - 1) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }

            if (startPage > 1) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); irParaPagina(1)">1</a></li>`;
                if (startPage > 2) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                html += `<li class="page-item ${i === paginaAtual ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="event.preventDefault(); irParaPagina(${i})">${i}</a>
                </li>`;
            }

            if (endPage < totalPaginas) {
                if (endPage < totalPaginas - 1) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                html += `<li class="page-item"><a class="page-link" href="#" onclick="event.preventDefault(); irParaPagina(${totalPaginas})">${totalPaginas}</a></li>`;
            }

            // Botão Próximo
            html += `<li class="page-item ${paginaAtual === totalPaginas ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="event.preventDefault(); irParaPagina(${paginaAtual + 1})" aria-label="Próximo">
                    <span aria-hidden="true">&raquo;</span>
                </a>
            </li>`;

            html += '</ul></nav>';
            
            // Informações de paginação
            html += `<div class="text-center mt-2 text-muted">
                Mostrando ${((paginaAtual - 1) * itensPorPagina) + 1} a ${Math.min(paginaAtual * itensPorPagina, totalClientes)} de ${totalClientes} clientes
            </div>`;

            paginacaoContainer.innerHTML = html;
        }

        // Tornar função acessível globalmente
        window.irParaPagina = async function(pagina) {
            if (pagina < 1 || pagina > totalPaginas) return;
            paginaAtual = pagina;
            await aplicarFiltros();
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        
        // Tornar função acessível globalmente
        window.limparFiltros = limparFiltros;
        window.aplicarFiltros = aplicarFiltros;

        // Renderizar clientes
        function renderizarClientes(clientesParaRenderizar) {
            const container = document.getElementById('clientesList');
            
            if (clientesParaRenderizar.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-users"></i>
                        <p>Nenhum cliente encontrado</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = clientesParaRenderizar.map(cliente => {
                const statusBadge = cliente.ativo 
                    ? '<span class="badge-status badge-ativo">Ativo</span>'
                    : '<span class="badge-status badge-inativo">Inativo</span>';
                
                const actions = isAdmin ? `
                    <div class="cliente-actions">
                        <button class="btn-icon btn-edit" onclick="editarCliente('${cliente.id}')" 
                                title="Editar cliente" aria-label="Editar cliente">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn-icon btn-delete" onclick="confirmarExclusao('${cliente.id}', '${escapeHtml(cliente.razao_social || cliente.nome)}')" 
                                title="Excluir cliente" aria-label="Excluir cliente">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                ` : '';

                // Mapear operação para nome legível
                const operacoesMap = {
                    'operacoes_jbo': 'Operações - JBO',
                    'operacoes_cabo': 'Operações - CABO',
                    'operacoes_sp': 'Operações - SP',
                    'operacoes_ba': 'Operações - BA',
                    'operacoes_se': 'Operações - SE',
                    'operacoes_al': 'Operações - AL',
                    'operacoes_pe': 'Operações - PE',
                    'operacoes_pb': 'Operações - PB',
                    'operacoes_ce': 'Operações - CE',
                    'operacoes_ambev': 'Operações - AMBEV',
                    'operacoes_us': 'Operações - US',
                    'operacoes_paratibe': 'Operações - PARATIBE',
                    'qualidade': 'Qualidade',
                    'price': 'Price',
                    'comercial': 'Comercial',
                    'rh': 'Recursos Humanos',
                    'contas_pagar': 'Contas a Pagar',
                    'contas_receber': 'Contas a Receber',
                    'ti': 'Tecnologia da Informação',
                    'seguranca': 'Segurança do Trabalho',
                    'manutencao': 'Manutenção',
                    'estoque': 'Estoque',
                    'compras': 'Compras',
                    'cs': 'CS',
                    'frota': 'Frota',
                    'documentacao': 'Documentação',
                    'administrativo': 'Administrativo',
                    'outros': 'Outros'
                };
                
                const operacaoNome = cliente.operacao ? operacoesMap[cliente.operacao] || cliente.operacao : null;
                const operacaoBadge = operacaoNome 
                    ? `<span class="badge-operacao" style="background: #8b5cf6; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.75rem; font-weight: 600;"><i class="fas fa-building me-1"></i>${escapeHtml(operacaoNome)}</span>`
                    : '';

                const cnpjInfo = cliente.cnpj ? `<span><i class="fas fa-id-card me-1"></i>CNPJ: ${escapeHtml(cliente.cnpj)}</span>` : '';
                const origemInfo = cliente.cidade_origem && cliente.uf_origem ? `<span><i class="fas fa-map-marker-alt me-1"></i>Origem: ${escapeHtml(cliente.cidade_origem)}/${escapeHtml(cliente.uf_origem)}</span>` : '';
                const destinoInfo = cliente.cidade_destino && cliente.uf_destino ? `<span><i class="fas fa-map-marker-alt me-1"></i>Destino: ${escapeHtml(cliente.cidade_destino)}/${escapeHtml(cliente.uf_destino)}</span>` : '';
                const produtoInfo = cliente.tipo_produto ? `<span><i class="fas fa-box me-1"></i>Produto: ${escapeHtml(cliente.tipo_produto)}</span>` : '';
                const tabelaInfo = cliente.codigo_tabela ? `<span><i class="fas fa-code me-1"></i>Tabela: ${escapeHtml(cliente.codigo_tabela)}</span>` : '';

                return `
                    <div class="cliente-card ${!cliente.ativo ? 'inativo' : ''}">
                        <div class="cliente-info">
                            <div class="cliente-nome">${escapeHtml(cliente.razao_social || cliente.nome)}</div>
                            <div class="cliente-meta">
                                <span class="badge-filial">${escapeHtml(cliente.filial)}</span>
                                ${operacaoBadge}
                                ${statusBadge}
                                ${cnpjInfo}
                                ${origemInfo}
                                ${destinoInfo}
                                ${produtoInfo}
                                ${tabelaInfo}
                                <span><i class="fas fa-calendar me-1"></i>Criado em: ${new Date(cliente.created_at).toLocaleDateString('pt-BR')}</span>
                            </div>
                        </div>
                        ${actions}
                    </div>
                `;
            }).join('');
        }

        // Função antiga mantida para compatibilidade (não usada mais)
        function filtrarClientes() {
            aplicarFiltros();
        }

        // Abrir formulário (novo)
        function abrirFormulario() {
            if (!isAdmin) {
                mostrarAlerta('Você não tem permissão para adicionar clientes', 'danger');
                return;
            }

            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-user-plus me-2"></i>Novo Cliente';
            document.getElementById('clienteForm').reset();
            document.getElementById('clienteId').value = '';
            document.getElementById('clienteAtivo').checked = true;
            // Limpar erros ao abrir formulário
            document.querySelectorAll('.field-error').forEach(el => {
                el.classList.remove('show');
                el.textContent = '';
            });
            document.querySelectorAll('.field-input-error').forEach(el => {
                el.classList.remove('field-input-error');
            });
            clienteModal.show();
        }

        // Editar cliente
        async function editarCliente(id) {
            if (!isAdmin) {
                mostrarAlerta('Você não tem permissão para editar clientes', 'danger');
                return;
            }

            const cliente = clientes.find(c => c.id === id);
            if (!cliente) {
                mostrarAlerta('Cliente não encontrado', 'danger');
                return;
            }

            document.getElementById('modalTitle').innerHTML = '<i class="fas fa-edit me-2"></i>Editar Cliente';
            document.getElementById('clienteId').value = cliente.id;
            document.getElementById('clienteCNPJ').value = cliente.cnpj || '';
            document.getElementById('clienteNome').value = cliente.razao_social || cliente.nome || '';
            document.getElementById('clienteCidadeOrigem').value = cliente.cidade_origem || '';
            document.getElementById('clienteUFOrigem').value = cliente.uf_origem || '';
            document.getElementById('clienteCidadeDestino').value = cliente.cidade_destino || '';
            document.getElementById('clienteUFDestino').value = cliente.uf_destino || '';
            document.getElementById('clienteTipoProduto').value = cliente.tipo_produto || '';
            document.getElementById('clienteCodigoTabela').value = cliente.codigo_tabela || '';
            document.getElementById('clienteTipoVeiculo').value = cliente.tipo_veiculo || '';
            document.getElementById('clienteFilial').value = cliente.filial || '';
            document.getElementById('clienteOperacao').value = cliente.operacao || '';
            document.getElementById('clienteAtivo').checked = cliente.ativo !== false;

            clienteModal.show();
        }

        // Salvar cliente
        async function salvarCliente(e) {
            e.preventDefault();

            if (!isAdmin) {
                mostrarAlerta('Você não tem permissão para salvar clientes', 'danger');
                return;
            }

            const id = document.getElementById('clienteId').value;
            let cnpj = document.getElementById('clienteCNPJ').value.trim();
            const razaoSocial = document.getElementById('clienteNome').value.trim();
            const nome = razaoSocial; // Manter nome para compatibilidade
            const cidadeOrigem = document.getElementById('clienteCidadeOrigem').value.trim();
            const ufOrigem = document.getElementById('clienteUFOrigem').value;
            const cidadeDestino = document.getElementById('clienteCidadeDestino').value.trim();
            const ufDestino = document.getElementById('clienteUFDestino').value;
            const tipoProduto = document.getElementById('clienteTipoProduto').value.trim();
            const codigoTabela = document.getElementById('clienteCodigoTabela').value.trim();
            const tipoVeiculo = document.getElementById('clienteTipoVeiculo').value;
            const filial = document.getElementById('clienteFilial').value;
            const operacao = document.getElementById('clienteOperacao').value || null;
            const ativo = document.getElementById('clienteAtivo').checked;

            // ✅ Normalizar CNPJ antes de validar (aceita com ou sem máscara)
            const cnpjNormalizado = normalizarCNPJ(cnpj);
            if (!cnpjNormalizado) {
                mostrarAlerta('CNPJ inválido. Deve ter 14 dígitos. Formatos aceitos: 00.000.000/0000-00 ou 00000000000000', 'danger');
                const cnpjField = document.getElementById('clienteCNPJ');
                const cnpjError = document.getElementById('clienteCNPJError');
                if (cnpjField && cnpjError) {
                    cnpjField.classList.add('field-input-error');
                    cnpjError.textContent = 'CNPJ inválido. Deve ter 14 dígitos.';
                    cnpjError.classList.add('show');
                }
                return;
            }
            cnpj = cnpjNormalizado;
            
            // Atualizar o campo com o CNPJ normalizado (com máscara)
            document.getElementById('clienteCNPJ').value = cnpj;

            // Validar
            const validator = new Validator(clienteSchema);
            const errors = validator.validate({ 
                cnpj, 
                nome, 
                cidade_origem: cidadeOrigem,
                uf_origem: ufOrigem,
                cidade_destino: cidadeDestino,
                uf_destino: ufDestino,
                tipo_produto: tipoProduto,
                codigo_tabela: codigoTabela,
                tipo_veiculo: tipoVeiculo,
                filial 
            });

            if (errors.length > 0) {
                errors.forEach(error => {
                    // Mapear nomes de campos do schema para IDs dos inputs
                    const fieldMap = {
                        'cnpj': 'clienteCNPJ',
                        'nome': 'clienteNome',
                        'cidade_origem': 'clienteCidadeOrigem',
                        'uf_origem': 'clienteUFOrigem',
                        'cidade_destino': 'clienteCidadeDestino',
                        'uf_destino': 'clienteUFDestino',
                        'tipo_produto': 'clienteTipoProduto',
                        'codigo_tabela': 'clienteCodigoTabela',
                        'tipo_veiculo': 'clienteTipoVeiculo',
                        'filial': 'clienteFilial'
                    };
                    
                    const fieldId = fieldMap[error.field] || `cliente${error.field.charAt(0).toUpperCase() + error.field.slice(1)}`;
                    const field = document.getElementById(fieldId);
                    const errorDiv = document.getElementById(`${fieldId}Error`);
                    if (field && errorDiv) {
                        field.classList.add('field-input-error');
                        errorDiv.textContent = error.message;
                        errorDiv.classList.add('show');
                    }
                });
                return;
            }

            // Limpar erros
            document.querySelectorAll('.field-error').forEach(el => {
                el.classList.remove('show');
                el.textContent = '';
            });
            document.querySelectorAll('.field-input-error').forEach(el => {
                el.classList.remove('field-input-error');
            });

            try {
                const url = id ? `/api/clientes/${id}` : '/api/clientes';
                const method = id ? 'PUT' : 'POST';

                const response = await fetch(url, {
                    method,
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ 
                        cnpj,
                        nome: nome, // Manter para compatibilidade
                        razao_social: razaoSocial,
                        cidade_origem: cidadeOrigem,
                        uf_origem: ufOrigem,
                        cidade_destino: cidadeDestino,
                        uf_destino: ufDestino,
                        tipo_produto: tipoProduto,
                        codigo_tabela: codigoTabela,
                        tipo_veiculo: tipoVeiculo,
                        filial,
                        operacao,
                        ativo
                    })
                });

                const data = await response.json();

                if (data.success) {
                    mostrarAlerta(
                        id ? 'Cliente atualizado com sucesso!' : 'Cliente cadastrado com sucesso!',
                        'success'
                    );
                    clienteModal.hide();
                    await carregarClientes();
                } else {
                    throw new Error(data.error || 'Erro ao salvar cliente');
                }
            } catch (error) {
                ErrorHandler.handle(error, 'Erro ao salvar cliente');
            }
        }

        // Confirmar exclusão
        function confirmarExclusao(id, nome) {
            if (!isAdmin) {
                mostrarAlerta('Você não tem permissão para excluir clientes', 'danger');
                return;
            }

            if (confirm(`Tem certeza que deseja excluir o cliente "${nome}"?\n\nEsta ação não pode ser desfeita.`)) {
                excluirCliente(id);
            }
        }

        // Excluir cliente
        async function excluirCliente(id) {
            try {
                const response = await fetch(`/api/clientes/${id}`, {
                    method: 'DELETE'
                });

                const data = await response.json();

                if (data.success) {
                    mostrarAlerta('Cliente excluído com sucesso!', 'success');
                    await carregarClientes();
                } else {
                    throw new Error(data.error || 'Erro ao excluir cliente');
                }
            } catch (error) {
                ErrorHandler.handle(error, 'Erro ao excluir cliente');
            }
        }

        // Mostrar alerta
        function mostrarAlerta(mensagem, tipo = 'info') {
            const container = document.getElementById('alertContainer');
            const alertId = 'alert-' + Date.now();
            const alert = document.createElement('div');
            alert.id = alertId;
            alert.className = `alert alert-${tipo} alert-dismissible fade show alert-custom`;
            alert.innerHTML = `
                ${mensagem}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            container.appendChild(alert);

            setTimeout(() => {
                const alertEl = document.getElementById(alertId);
                if (alertEl) {
                    const bsAlert = new bootstrap.Alert(alertEl);
                    bsAlert.close();
                }
            }, 5000);
        }

        // Escapar HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Abrir formulário de cadastro em massa
        function abrirFormularioMassa() {
            if (!isAdmin) {
                mostrarAlerta('Você não tem permissão para cadastrar clientes em massa', 'danger');
                return;
            }

            const modal = new bootstrap.Modal(document.getElementById('clienteMassaModal'));
            document.getElementById('clientesMassa').value = '';
            document.getElementById('previewMassa').style.display = 'none';
            modal.show();
        }

        // Preview do cadastro em massa
        function previewMassa() {
            const texto = document.getElementById('clientesMassa').value.trim();
            if (!texto) {
                mostrarAlerta('Digite pelo menos um cliente', 'warning');
                return;
            }

            const linhas = texto.split('\n').filter(l => l.trim());
            const preview = document.getElementById('previewContent');
            const previewDiv = document.getElementById('previewMassa');

            let html = '<table class="table table-sm table-bordered">';
            html += '<thead><tr><th>#</th><th>CNPJ</th><th>Nome</th><th>Origem</th><th>Destino</th><th>Produto</th><th>Tabela</th><th>Filial</th><th>Status</th></tr></thead><tbody>';

            const filiaisValidas = ['JBO', 'CABO', 'AL', 'SP', 'BA', 'CE', 'SE', 'PB', 'PE', 'AMBEV', 'US', 'PARATIBE'];
            const ufsValidas = ['AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA', 'MT', 'MS', 'MG', 'PA', 'PB', 'PR', 'PE', 'PI', 'RJ', 'RN', 'RS', 'RO', 'RR', 'SC', 'SP', 'SE', 'TO'];

            linhas.forEach((linha, index) => {
                const partes = linha.split('|').map(p => p.trim());
                const cnpj = partes[0] || '';
                const nome = partes[1] || '';
                const cidadeOrigem = partes[2] || '';
                const ufOrigem = partes[3] || '';
                const cidadeDestino = partes[4] || '';
                const ufDestino = partes[5] || '';
                const tipoProduto = partes[6] || '';
                const codigoTabela = partes[7] || '';
                const filial = partes[8] || '';
                const operacao = partes[9] || '';

                const cnpjValido = /^\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}$/.test(cnpj);
                const nomeValido = nome.length >= 2 && nome.length <= 200;
                const origemValida = cidadeOrigem.length >= 2 && ufsValidas.includes(ufOrigem);
                const destinoValido = cidadeDestino.length >= 2 && ufsValidas.includes(ufDestino);
                const produtoValido = tipoProduto.length >= 2;
                const tabelaValida = codigoTabela.length >= 1;
                const filialValida = filiaisValidas.includes(filial);
                
                const valido = cnpjValido && nomeValido && origemValida && destinoValido && produtoValido && tabelaValida && filialValida;

                html += `<tr class="${valido ? '' : 'table-warning'}">`;
                html += `<td>${index + 1}</td>`;
                html += `<td>${escapeHtml(cnpj)}</td>`;
                html += `<td>${escapeHtml(nome)}</td>`;
                html += `<td>${escapeHtml(cidadeOrigem)}/${escapeHtml(ufOrigem)}</td>`;
                html += `<td>${escapeHtml(cidadeDestino)}/${escapeHtml(ufDestino)}</td>`;
                html += `<td>${escapeHtml(tipoProduto)}</td>`;
                html += `<td>${escapeHtml(codigoTabela)}</td>`;
                html += `<td>${escapeHtml(filial)}</td>`;
                html += `<td>${valido ? '<span class="badge bg-success">OK</span>' : '<span class="badge bg-danger">Inválido</span>'}</td>`;
                html += '</tr>';
            });

            html += '</tbody></table>';
            preview.innerHTML = html;
            previewDiv.style.display = 'block';
        }

        // Salvar clientes em massa
        async function salvarClientesMassa() {
            if (!isAdmin) {
                mostrarAlerta('Você não tem permissão para cadastrar clientes em massa', 'danger');
                return;
            }

            const texto = document.getElementById('clientesMassa').value.trim();
            if (!texto) {
                mostrarAlerta('Digite pelo menos um cliente', 'warning');
                return;
            }

            const linhas = texto.split('\n').filter(l => l.trim());
            const clientesParaSalvar = [];
            const erros = [];

            const filiaisValidas = ['JBO', 'CABO', 'AL', 'SP', 'BA', 'CE', 'SE', 'PB', 'PE', 'AMBEV', 'US', 'PARATIBE'];
            const ufsValidas = ['AC', 'AL', 'AP', 'AM', 'BA', 'CE', 'DF', 'ES', 'GO', 'MA', 'MT', 'MS', 'MG', 'PA', 'PB', 'PR', 'PE', 'PI', 'RJ', 'RN', 'RS', 'RO', 'RR', 'SC', 'SP', 'SE', 'TO'];
            const operacoesValidas = [
                'operacoes_jbo', 'operacoes_cabo', 'operacoes_sp', 'operacoes_ba', 'operacoes_se',
                'operacoes_al', 'operacoes_pe', 'operacoes_pb', 'operacoes_ce', 'operacoes_ambev',
                'operacoes_us', 'operacoes_paratibe', 'qualidade', 'price', 'comercial', 'rh',
                'contas_pagar', 'contas_receber', 'ti', 'seguranca', 'manutencao', 'estoque',
                'compras', 'cs', 'frota', 'documentacao', 'administrativo', 'outros'
            ];

            linhas.forEach((linha, index) => {
                const partes = linha.split('|').map(p => p.trim());
                let cnpj = partes[0] || '';
                const nome = partes[1] || '';
                const cidadeOrigem = partes[2] || '';
                const ufOrigem = partes[3] || '';
                const cidadeDestino = partes[4] || '';
                const ufDestino = partes[5] || '';
                const tipoProduto = partes[6] || '';
                const codigoTabela = partes[7] || '';
                const filial = partes[8] || '';
                const operacao = partes[9] || '';

                // ✅ Normalizar CNPJ (aceita com ou sem máscara)
                const cnpjNormalizado = normalizarCNPJ(cnpj);
                if (!cnpjNormalizado) {
                    erros.push(`Linha ${index + 1}: CNPJ inválido (deve ter 14 dígitos. Formatos aceitos: 00.000.000/0000-00 ou 00000000000000)`);
                    return;
                }
                cnpj = cnpjNormalizado;

                if (!nome || nome.length < 2) {
                    erros.push(`Linha ${index + 1}: Nome inválido`);
                    return;
                }

                if (!cidadeOrigem || cidadeOrigem.length < 2) {
                    erros.push(`Linha ${index + 1}: Cidade de origem inválida`);
                    return;
                }

                if (!ufOrigem || !ufsValidas.includes(ufOrigem)) {
                    erros.push(`Linha ${index + 1}: UF de origem inválida (${ufOrigem})`);
                    return;
                }

                if (!cidadeDestino || cidadeDestino.length < 2) {
                    erros.push(`Linha ${index + 1}: Cidade de destino inválida`);
                    return;
                }

                if (!ufDestino || !ufsValidas.includes(ufDestino)) {
                    erros.push(`Linha ${index + 1}: UF de destino inválida (${ufDestino})`);
                    return;
                }

                if (!tipoProduto || tipoProduto.length < 2) {
                    erros.push(`Linha ${index + 1}: Tipo de produto inválido`);
                    return;
                }

                if (!codigoTabela || codigoTabela.length < 1) {
                    erros.push(`Linha ${index + 1}: Código da tabela inválido`);
                    return;
                }

                if (!filial || !filiaisValidas.includes(filial)) {
                    erros.push(`Linha ${index + 1}: Filial inválida (${filial})`);
                    return;
                }

                if (operacao && !operacoesValidas.includes(operacao)) {
                    erros.push(`Linha ${index + 1}: Operação inválida (${operacao})`);
                    return;
                }

                clientesParaSalvar.push({
                    cnpj: cnpj,
                    nome: nome,
                    cidade_origem: cidadeOrigem,
                    uf_origem: ufOrigem,
                    cidade_destino: cidadeDestino,
                    uf_destino: ufDestino,
                    tipo_produto: tipoProduto,
                    codigo_tabela: codigoTabela,
                    filial: filial,
                    operacao: operacao || null,
                    ativo: true
                });
            });

            if (erros.length > 0) {
                mostrarAlerta('Erros encontrados:\n' + erros.join('\n'), 'danger');
                return;
            }

            if (clientesParaSalvar.length === 0) {
                mostrarAlerta('Nenhum cliente válido para salvar', 'warning');
                return;
            }

            // Confirmar
            if (!confirm(`Deseja salvar ${clientesParaSalvar.length} cliente(s)?`)) {
                return;
            }

            try {
                const btn = event.target;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Salvando...';

                let sucessos = 0;
                let falhas = 0;
                const detalhesFalhas = [];

                // Salvar cada cliente
                for (const cliente of clientesParaSalvar) {
                    try {
                        const response = await fetch('/api/clientes', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(cliente)
                        });

                        const data = await response.json();

                        if (data.success) {
                            sucessos++;
                        } else {
                            falhas++;
                            detalhesFalhas.push(`${cliente.nome} (${cliente.filial}): ${data.error || 'Erro desconhecido'}`);
                        }
                    } catch (error) {
                        falhas++;
                        detalhesFalhas.push(`${cliente.nome} (${cliente.filial}): ${error.message}`);
                    }
                }

                // Mostrar resultado
                let mensagem = `Processamento concluído!\n\n`;
                mensagem += `✅ Sucessos: ${sucessos}\n`;
                mensagem += `❌ Falhas: ${falhas}`;

                if (falhas > 0 && detalhesFalhas.length > 0) {
                    mensagem += `\n\nDetalhes das falhas:\n${detalhesFalhas.slice(0, 5).join('\n')}`;
                    if (detalhesFalhas.length > 5) {
                        mensagem += `\n... e mais ${detalhesFalhas.length - 5} falha(s)`;
                    }
                }

                mostrarAlerta(mensagem, sucessos > 0 ? 'success' : 'danger');

                // Fechar modal e recarregar lista
                if (sucessos > 0) {
                    bootstrap.Modal.getInstance(document.getElementById('clienteMassaModal')).hide();
                    await carregarClientes();
                }

            } catch (error) {
                ErrorHandler.handle(error, 'Erro ao salvar clientes em massa');
            } finally {
                const btn = event.target;
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save me-2"></i>Salvar Todos';
            }
        }

        // Exportar clientes para Excel
        async function exportarExcel() {
            try {
                const response = await fetch('/api/clientes/exportar-excel');
                
                if (!response.ok) {
                    throw new Error('Erro ao gerar arquivo');
                }

                // Obter o conteúdo do arquivo
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                
                // Criar link de download
                const a = document.createElement('a');
                a.href = url;
                a.download = `clientes-por-filial-${new Date().toISOString().split('T')[0]}.xlsx`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                mostrarAlerta('Arquivo Excel gerado com sucesso!', 'success');
            } catch (error) {
                ErrorHandler.handle(error, 'Erro ao exportar Excel');
            }
        }

        // Baixar modelo CSV
        async function baixarModeloCSV() {
            try {
                const response = await fetch('/api/clientes/modelo-csv');
                
                if (!response.ok) {
                    throw new Error('Erro ao gerar modelo');
                }

                // Obter o conteúdo do arquivo
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                
                // Criar link de download
                const a = document.createElement('a');
                a.href = url;
                a.download = `modelo-importacao-clientes-${new Date().toISOString().split('T')[0]}.csv`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);

                mostrarAlerta('Modelo CSV baixado com sucesso!', 'success');
            } catch (error) {
                ErrorHandler.handle(error, 'Erro ao baixar modelo CSV');
            }
        }

        // Abrir modal de importação CSV
        function abrirImportacaoCSV() {
            if (!isAdmin) {
                mostrarAlerta('Você não tem permissão para importar clientes', 'danger');
                return;
            }

            if (!importacaoCSVModal) {
                const modalElement = document.getElementById('importacaoCSVModal');
                if (!modalElement) {
                    mostrarAlerta('Erro: Modal de importação não encontrado', 'danger');
                    return;
                }
                importacaoCSVModal = new bootstrap.Modal(modalElement);
            }

            const formImportacao = document.getElementById('formImportacaoCSV');
            const resultadoDiv = document.getElementById('resultadoImportacao');
            
            if (formImportacao) formImportacao.reset();
            if (resultadoDiv) resultadoDiv.style.display = 'none';
            
            importacaoCSVModal.show();
        }

    </script>
</body>
</html>

