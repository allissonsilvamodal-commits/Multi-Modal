<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Portal de ITs - Instru√ß√µes de Trabalho</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/permissions.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
        }
        
        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding-bottom: 2rem;
        }
        
        .header-section {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 2.5rem 0;
            margin-bottom: 2rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        
        .header-section h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
        }
        
        .header-section p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .container-custom {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
        }
        
        .card-modern {
            background: white;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid #e5e7eb;
        }
        
        .btn-primary-custom {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border: none;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 12px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .btn-primary-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
            color: white;
        }
        
        .btn-back {
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.3s;
        }
        
        .btn-back:hover {
            background: #4b5563;
            color: white;
            transform: translateY(-2px);
        }
        
        .it-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .it-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .it-info {
            flex: 1;
        }
        
        .it-nome {
            font-weight: 600;
            font-size: 1.1rem;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        
        .it-meta {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        .it-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-view {
            background: #e0e7ff;
            color: var(--primary);
        }
        
        .btn-view:hover {
            background: var(--primary);
            color: white;
        }
        
        .btn-download {
            background: #dbeafe;
            color: #3b82f6;
        }
        
        .btn-download:hover {
            background: #3b82f6;
            color: white;
        }
        
        .btn-delete {
            background: #fee2e2;
            color: var(--danger);
        }
        
        .btn-delete:hover {
            background: var(--danger);
            color: white;
        }
        
        .upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            background: #f8fafc;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .upload-area:hover {
            border-color: var(--primary);
            background: #f1f5f9;
        }
        
        .upload-area.dragover {
            border-color: var(--primary);
            background: #e0e7ff;
        }
        
        .file-icon {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }
        
        .filter-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }
        
        .filter-tab {
            padding: 0.75rem 1.5rem;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: #6b7280;
        }
        
        .filter-tab:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .filter-tab.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-color: transparent;
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: #6b7280;
        }
        
        .empty-state i {
            font-size: 4rem;
            color: #d1d5db;
            margin-bottom: 1rem;
        }
        
        .badge-area {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .badge-version-atual {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .badge-version-antiga {
            background: #9ca3af;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 1.5rem;
        }
        
        .search-box input {
            padding-left: 2.5rem;
            border-radius: 12px;
            border: 2px solid #e5e7eb;
        }
        
        .search-box i {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }
        
        /* Estilos para agrupamento de vers√µes */
        .it-group {
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            margin-bottom: 1rem;
            overflow: hidden;
            background: white;
        }
        
        .it-group-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 2px solid #e5e7eb;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .it-group-header:hover {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
        }
        
        .it-group-header.expanded {
            border-bottom-color: var(--primary);
        }
        
        .it-group-info {
            flex: 1;
        }
        
        .it-group-codigo {
            font-weight: 700;
            font-size: 1.2rem;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }
        
        .it-group-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            color: #6b7280;
            font-size: 0.9rem;
        }
        
        .it-group-toggle {
            font-size: 1.2rem;
            color: var(--primary);
            transition: transform 0.3s;
        }
        
        .it-group-header.expanded .it-group-toggle {
            transform: rotate(180deg);
        }
        
        .it-group-versions {
            display: none;
            padding: 0;
        }
        
        .it-group-header.expanded + .it-group-versions {
            display: block;
        }
        
        .it-version-item {
            padding: 1.5rem;
            border-bottom: 1px solid #f1f5f9;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background 0.3s;
        }
        
        .it-version-item:last-child {
            border-bottom: none;
        }
        
        .it-version-item:hover {
            background: #f8fafc;
        }
        
        .it-version-item.versao-atual {
            background: linear-gradient(90deg, rgba(16, 185, 129, 0.1) 0%, transparent 100%);
            border-left: 4px solid var(--success);
        }
        
        .it-version-info {
            flex: 1;
        }
        
        .it-version-nome {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        
        .it-version-meta {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            color: #6b7280;
            font-size: 0.85rem;
        }
        
        /* ‚úÖ MELHORIAS MODERNAS */
        
        /* Preview de arquivo */
        .file-preview {
            margin-top: 1rem;
            padding: 1rem;
            background: #f8fafc;
            border-radius: 12px;
            border: 2px dashed #cbd5e1;
        }
        
        .file-preview-img {
            max-width: 100%;
            max-height: 300px;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .file-preview-info {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: white;
            border-radius: 8px;
        }
        
        .file-preview-icon {
            font-size: 2.5rem;
            color: var(--primary);
        }
        
        /* Filtros avan√ßados */
        .filters-advanced {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #e5e7eb;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .filter-group label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #6b7280;
        }
        
        /* Controles de visualiza√ß√£o */
        .view-controls {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        
        .btn-view-toggle {
            padding: 0.5rem;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            color: #6b7280;
        }
        
        .btn-view-toggle:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .btn-view-toggle.active {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        /* Grid view */
        .its-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }
        
        .its-list {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        /* Card melhorado */
        .it-card-enhanced {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            padding: 1.5rem;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .it-card-enhanced::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
            transform: scaleY(0);
            transition: transform 0.3s;
        }
        
        .it-card-enhanced:hover {
            border-color: var(--primary);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.15);
            transform: translateY(-4px);
        }
        
        .it-card-enhanced:hover::before {
            transform: scaleY(1);
        }
        
        .it-card-enhanced.versao-atual {
            border-color: var(--success);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05) 0%, white 100%);
        }
        
        .it-card-enhanced.versao-atual::before {
            background: var(--success);
            transform: scaleY(1);
        }
        
        /* Badge de status melhorado */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .status-badge.atual {
            background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
            color: white;
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);
        }
        
        .status-badge.antiga {
            background: #9ca3af;
            color: white;
        }
        
        /* Highlight de busca */
        .search-highlight {
            background: linear-gradient(135deg, #fef08a 0%, #fde047 100%);
            padding: 0.1rem 0.3rem;
            border-radius: 4px;
            font-weight: 700;
        }
        
        /* Modal de preview */
        .preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }
        
        .preview-modal.active {
            display: flex;
        }
        
        .preview-modal-content {
            background: white;
            border-radius: 16px;
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
            position: relative;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .preview-modal-header {
            padding: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border-radius: 16px 16px 0 0;
        }
        
        .preview-modal-body {
            padding: 2rem;
            text-align: center;
        }
        
        .preview-modal-body iframe,
        .preview-modal-body img {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
        }
        
        .btn-close-modal {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.5rem;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-close-modal:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        /* Ordena√ß√£o */
        .sort-controls {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .sort-select {
            padding: 0.5rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .sort-select:focus {
            border-color: var(--primary);
            outline: none;
        }
        
        /* Quick actions */
        .quick-actions {
            display: flex;
            gap: 0.5rem;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .it-card-enhanced:hover .quick-actions {
            opacity: 1;
        }
        
        /* Loading skeleton */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
        }
        
        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        .skeleton-card {
            height: 200px;
            margin-bottom: 1rem;
        }
        
        /* Responsivo */
        @media (max-width: 768px) {
            .its-grid {
                grid-template-columns: 1fr;
            }
            
            .filters-advanced {
                grid-template-columns: 1fr;
            }
            
            .view-controls {
                width: 100%;
                justify-content: space-between;
            }
        }
        
        /* Anima√ß√µes suaves */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        /* Tooltip moderno */
        .tooltip-custom {
            position: relative;
        }
        
        .tooltip-custom::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%) translateY(-8px);
            padding: 0.5rem 0.75rem;
            background: #1f2937;
            color: white;
            border-radius: 6px;
            font-size: 0.75rem;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s, transform 0.3s;
        }
        
        .tooltip-custom:hover::after {
            opacity: 1;
            transform: translateX(-50%) translateY(-4px);
        }
        
        /* Estilos para sele√ß√£o de IT */
        .list-group-item {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            transition: all 0.3s;
        }
        
        .list-group-item:hover {
            border-color: var(--primary);
            background: #f8fafc;
            transform: translateX(4px);
        }
        
        .btn-check:checked + .btn-outline-primary {
            background: var(--primary);
            border-color: var(--primary);
            color: white;
        }
        
        .cursor-pointer {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="header-section">
        <div class="container-custom">
            <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h1><i class="fas fa-file-invoice me-2"></i>Portal de ITs</h1>
                    <p>Instru√ß√µes de Trabalho das √Åreas - Upload e Consulta</p>
                </div>
                <div class="d-flex gap-2">
                    <a href="portal.html" class="btn-back">
                        <i class="fas fa-home"></i> Portal
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container-custom">
        <!-- Filtros por √Årea -->
        <div class="card-modern">
            <h3 class="mb-3"><i class="fas fa-filter me-2"></i>Filtrar por √Årea</h3>
            <div class="filter-tabs" id="filterTabs">
                <div class="filter-tab active" data-area="todas">
                    <i class="fas fa-list me-1"></i> Todas as √Åreas
                </div>
                <!-- Os filtros ser√£o adicionados dinamicamente -->
            </div>
        </div>
        
        <!-- Card de Sele√ß√£o de IT para Atualiza√ß√£o -->
        <div class="card-modern" id="cardSelecionarIT" style="display: none;">
            <h3 class="mb-3"><i class="fas fa-sync-alt me-2"></i>Selecionar IT para Atualiza√ß√£o</h3>
            <div class="alert alert-info mb-3">
                <i class="fas fa-info-circle me-2"></i>
                Selecione a IT que deseja atualizar. Os campos do formul√°rio ser√£o preenchidos automaticamente.
            </div>
            <div class="mb-3">
                <label class="form-label">IT Atual para Atualizar *</label>
                <select id="selectITParaAtualizar" class="form-select form-select-lg" required>
                    <option value="">Selecione uma IT...</option>
                    <!-- Ser√° preenchido dinamicamente -->
                </select>
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    Apenas ITs com vers√£o atual s√£o exibidas. A vers√£o selecionada ser√° arquivada e a nova ser√° marcada como atual.
                </small>
            </div>
            <div id="infoITSelecionada" class="mt-3"></div>
        </div>
        
        <!-- √Årea de Upload -->
        <div class="card-modern" id="uploadCard">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3 class="mb-0"><i class="fas fa-cloud-upload-alt me-2"></i>Enviar IT (Instru√ß√£o de Trabalho)</h3>
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="uploadMode" id="modeNova" value="nova" checked>
                    <label class="btn btn-outline-primary" for="modeNova">
                        <i class="fas fa-plus me-1"></i>Nova IT
                    </label>
                    <input type="radio" class="btn-check" name="uploadMode" id="modeAtualizar" value="atualizar">
                    <label class="btn btn-outline-primary" for="modeAtualizar">
                        <i class="fas fa-sync-alt me-1"></i>Atualizar IT
                    </label>
                </div>
            </div>
            
            <form id="uploadForm">
                <input type="hidden" id="itSelecionadaId" value="">
                
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label class="form-label">√Årea/Departamento *</label>
                        <select id="areaSelect" class="form-select" required>
                            <option value="">Selecione a √°rea</option>
                    </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">C√≥digo da IT <span id="codigoITLabel">(opcional)</span></label>
                        <input type="text" id="codigoIT" class="form-control" placeholder="Ex: IT-001, IT-QA-2024-01">
                        <small class="text-muted" id="codigoITHint">Deixe em branco se n√£o tiver c√≥digo padronizado</small>
                    </div>
                </div>
                <div class="mb-3">
                    <label class="form-label">Nome/Descri√ß√£o da IT *</label>
                    <input type="text" id="nomeIT" class="form-control" placeholder="Ex: Instru√ß√£o de Trabalho - Processo X" required>
                </div>
                <div class="mb-3">
                    <label class="form-label">Vers√£o (opcional)</label>
                    <input type="text" id="versaoIT" class="form-control" placeholder="Ex: 1.0, 2.1, v3">
                    <small class="text-muted">Vers√£o da nova atualiza√ß√£o</small>
                </div>
                <div class="upload-area" id="uploadArea">
                    <input type="file" id="fileInput" accept=".pdf,.png,.jpg,.jpeg,.doc,.docx" style="display: none;">
                    <div class="file-icon">
                        <i class="fas fa-cloud-upload-alt"></i>
                    </div>
                    <h4>Arraste o arquivo aqui ou clique para selecionar</h4>
                    <p class="text-muted">Formatos aceitos: PDF, PNG, JPG, JPEG, DOC, DOCX</p>
                    <p class="text-muted">Tamanho m√°ximo: 10MB</p>
                </div>
                <div id="selectedFile" class="mt-3"></div>
                <div class="mt-3 text-end">
                    <button type="button" class="btn btn-secondary" id="btnCancelarUpload" style="display: none;">Cancelar</button>
                    <button type="button" class="btn btn-secondary me-2" id="btnLimparForm" style="display: none;">Limpar Formul√°rio</button>
                    <button type="submit" class="btn-primary-custom" id="btnEnviar" disabled>
                        <i class="fas fa-upload me-2"></i><span id="btnEnviarText">Enviar IT</span>
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Busca e Filtros Avan√ßados -->
        <div class="card-modern">
            <div class="search-box">
                <i class="fas fa-search"></i>
                <input type="text" id="searchInput" class="form-control" placeholder="Buscar por nome, c√≥digo, √°rea ou descri√ß√£o...">
            </div>
            <!-- Filtros Avan√ßados -->
            <div class="filters-advanced" id="filtersAdvanced">
                <div class="filter-group">
                    <label><i class="fas fa-filter me-1"></i>Tipo de Arquivo</label>
                    <select id="filterTipoArquivo" class="form-select form-select-sm">
                        <option value="">Todos os tipos</option>
                        <option value="pdf">PDF</option>
                        <option value="image">Imagens</option>
                        <option value="word">Word</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label><i class="fas fa-layer-group me-1"></i>Vers√£o</label>
                    <select id="filterVersao" class="form-select form-select-sm">
                        <option value="">Todas</option>
                        <option value="atual">Apenas Vers√£o Atual</option>
                        <option value="antiga">Vers√µes Anteriores</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label><i class="fas fa-calendar me-1"></i>Ordenar por</label>
                    <select id="sortBy" class="form-select form-select-sm">
                        <option value="data_desc">Mais Recente</option>
                        <option value="data_asc">Mais Antiga</option>
                        <option value="nome_asc">Nome (A-Z)</option>
                        <option value="nome_desc">Nome (Z-A)</option>
                        <option value="area_asc">√Årea (A-Z)</option>
                    </select>
                </div>
                <div class="filter-group d-flex align-items-end">
                    <button type="button" class="btn btn-sm btn-outline-secondary w-100" id="btnLimparFiltros">
                        <i class="fas fa-times me-1"></i>Limpar Filtros
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Lista de ITs -->
        <div class="card-modern">
            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                <div class="d-flex align-items-center gap-3">
                    <h3 class="mb-0"><i class="fas fa-folder-open me-2"></i>ITs Cadastradas</h3>
                    <span class="badge bg-primary" id="totalITs">0 ITs</span>
                </div>
                <div class="view-controls">
                    <button class="btn-view-toggle active" id="btnViewList" data-view="list" title="Visualiza√ß√£o em Lista">
                        <i class="fas fa-list"></i>
                    </button>
                    <button class="btn-view-toggle" id="btnViewGrid" data-view="grid" title="Visualiza√ß√£o em Grid">
                        <i class="fas fa-th"></i>
                    </button>
                </div>
            </div>
            <div id="itsList">
                <div class="empty-state">
                    <i class="fas fa-file-invoice"></i>
                    <h4>Nenhuma IT encontrada</h4>
                    <p>Envie uma IT usando o formul√°rio acima</p>
                </div>
            </div>
        </div>
        
        <!-- Modal de Preview -->
        <div class="preview-modal" id="previewModal">
            <div class="preview-modal-content">
                <div class="preview-modal-header">
                    <h5 class="mb-0" id="previewModalTitle">Visualizar Documento</h5>
                    <button class="btn-close-modal" id="btnClosePreview">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="preview-modal-body" id="previewModalBody">
                    <!-- Conte√∫do ser√° inserido aqui -->
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.js"></script>
    <script>
        // √Åreas/Departamentos dispon√≠veis
        // ‚úÖ ATUALIZADO: 
        // - Almoxarifado -> Estoque
        // - Expedi√ß√£o -> Compras
        // - Produ√ß√£o -> Price
        // - Log√≠stica -> Opera√ß√µes (desmembrado por filial)
        // - Recebimento -> CS
        // - Financeiro -> Contas a Pagar e Contas a Receber
        const AREAS = [
            { id: 'qualidade', nome: 'Qualidade' },
            { id: 'price', nome: 'Price' },
            { id: 'operacoes_jbo', nome: 'Opera√ß√µes - Jaboat√£o (JBO)' },
            { id: 'operacoes_cabo', nome: 'Opera√ß√µes - Cabo (CABO)' },
            { id: 'operacoes_sp', nome: 'Opera√ß√µes - S√£o Paulo (SP)' },
            { id: 'operacoes_ba', nome: 'Opera√ß√µes - Sim√µes Filho (BA)' },
            { id: 'operacoes_se', nome: 'Opera√ß√µes - Aracaju (SE)' },
            { id: 'operacoes_al', nome: 'Opera√ß√µes - Macei√≥ (AL)' },
            { id: 'operacoes_pe', nome: 'Opera√ß√µes - Recife (PE)' },
            { id: 'operacoes_pb', nome: 'Opera√ß√µes - Jo√£o Pessoa (PB)' },
            { id: 'operacoes_ce', nome: 'Opera√ß√µes - Fortaleza (CE)' },
            { id: 'operacoes_ambev', nome: 'Opera√ß√µes - Ambev (AMBEV)' },
            { id: 'operacoes_us', nome: 'Opera√ß√µes - Usinas (US)' },
            { id: 'operacoes_paratibe', nome: 'Opera√ß√µes - Paratibe (PARATIBE)' },
            { id: 'comercial', nome: 'Comercial' },
            { id: 'rh', nome: 'Recursos Humanos' },
            { id: 'contas_pagar', nome: 'Contas a Pagar' },
            { id: 'contas_receber', nome: 'Contas a Receber' },
            { id: 'ti', nome: 'Tecnologia da Informa√ß√£o' },
            { id: 'seguranca', nome: 'Seguran√ßa do Trabalho' },
            { id: 'manutencao', nome: 'Manuten√ß√£o' },
            { id: 'estoque', nome: 'Estoque' },
            { id: 'compras', nome: 'Compras' },
            { id: 'cs', nome: 'CS' },
            { id: 'frota', nome: 'Frota' },
            { id: 'documentacao', nome: 'Documenta√ß√£o' },
            { id: 'administrativo', nome: 'Administrativo' },
            { id: 'outros', nome: 'Outros' }
        ];
        
        let supabaseClient = null;
        let currentUser = null;
        let selectedFile = null;
        let filtroArea = 'todas';
        let termoBusca = '';
        let isAdmin = false; // ‚úÖ Estado de admin do usu√°rio
        let currentView = 'list'; // 'list' ou 'grid'
        let filtroTipoArquivo = '';
        let filtroVersao = '';
        let sortBy = 'data_desc';
        let permissoesITs = {
            adicionar: false,
            editar: false,
            excluir: false
        };
        
        async function inicializar() {
            // Inicializar Supabase
            try {
                const response = await fetch('/api/supabase-config');
                if (!response.ok) {
                    throw new Error('Erro ao buscar configura√ß√£o do Supabase');
                }
                const config = await response.json();
                supabaseClient = window.supabase.createClient(config.supabaseUrl, config.supabaseAnonKey);
                console.log('‚úÖ Supabase inicializado');
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Supabase:', error);
                alert('Erro ao conectar com o banco de dados');
                return;
            }
            
            // Verificar autentica√ß√£o
            try {
                const response = await fetch('/api/auth/status', { credentials: 'include' });
                if (!response.ok) {
                    window.location.href = 'index.html';
                    return;
                }
                currentUser = await response.json();
                console.log('üë§ currentUser recebido:', currentUser);
                
                // ‚úÖ Verificar se √© admin - SEMPRE buscar do banco para garantir precis√£o
                isAdmin = false;
                
                // 1. Primeiro tentar verificar nos dados da API (mais r√°pido)
                if (currentUser?.role === 'admin' || currentUser?.isAdmin === true || currentUser?.userData?.role === 'admin') {
                    isAdmin = true;
                    console.log('‚úÖ Usu√°rio √© admin (verificado nos dados da API)');
                }
                
                // 2. SEMPRE verificar no banco para garantir (mesmo se a API disser que √© admin)
                if (supabaseClient) {
                    try {
                        // Usar o ID do currentUser (pode ser usuario ou id)
                        const userId = currentUser?.id || currentUser?.usuario || currentUser?.userData?.id;
                        
                        if (userId) {
                            console.log('üîç Buscando role no banco para userId:', userId);
                            
                            const { data: profile, error: profileError } = await supabaseClient
                                .from('user_profiles')
                                .select('role, id')
                                .eq('id', userId)
                                .maybeSingle();
                            
                            if (profileError) {
                                console.warn('‚ö†Ô∏è Erro ao buscar profile:', profileError);
                                // Se der erro com maybeSingle, tentar sem maybeSingle
                                try {
                                    const { data: profileAlt, error: profileAltError } = await supabaseClient
                                        .from('user_profiles')
                                        .select('role, id')
                                        .eq('id', userId)
                                        .limit(1)
                                        .single();
                                    
                                    if (!profileAltError && profileAlt) {
                                        if (profileAlt.role === 'admin') {
                                            isAdmin = true;
                                            console.log('‚úÖ Usu√°rio √© admin (verificado no banco - m√©todo alternativo)');
                                        }
                                    }
                                } catch (altError) {
                                    console.warn('‚ö†Ô∏è Erro no m√©todo alternativo:', altError);
                                }
                            } else if (profile && profile.role === 'admin') {
                                isAdmin = true;
                                console.log('‚úÖ Usu√°rio √© admin (verificado no banco de dados)');
                            }
                            
                            console.log('üîê Profile retornado:', profile);
                        } else {
                            console.warn('‚ö†Ô∏è N√£o foi poss√≠vel obter userId para verifica√ß√£o no banco');
                        }
                    } catch (error) {
                        console.error('‚ùå Erro ao verificar role no banco:', error);
                        // Se falhar, manter o valor j√° definido (pode ser true se a API disse que √© admin)
                    }
                } else {
                    console.warn('‚ö†Ô∏è Supabase n√£o inicializado para verifica√ß√£o de admin');
                }
                
                console.log('üéØ isAdmin FINAL definido como:', isAdmin);
                
                // ‚úÖ Verificar permiss√£o (n√£o bloqueia acesso, apenas controla a√ß√µes)
                // Todos os usu√°rios autenticados podem visualizar e baixar ITs
                // Apenas usu√°rios com permiss√µes espec√≠ficas podem adicionar, editar ou excluir
                let temPermissaoQualidade = false;
                try {
                    if (typeof verificarPermissaoPagina === 'function') {
                        temPermissaoQualidade = await verificarPermissaoPagina('treinamentos-documentos');
                        // N√£o redireciona se n√£o tiver permiss√£o - apenas controla a√ß√µes
                        if (window.DEBUG || window.location.hostname === 'localhost') {
                            console.log('üìã Permiss√£o de qualidade:', temPermissaoQualidade);
                        }
                    }
                } catch (permError) {
                    console.warn('‚ö†Ô∏è Erro ao verificar permiss√£o de qualidade (continuando mesmo assim):', permError);
                    // N√£o bloqueia acesso em caso de erro na verifica√ß√£o de permiss√£o
                }
                
                // ‚úÖ Carregar permiss√µes de ITs (para a√ß√µes espec√≠ficas)
                try {
                    await verificarPermissoesITs();
                } catch (itsPermError) {
                    console.warn('‚ö†Ô∏è Erro ao carregar permiss√µes de ITs (continuando mesmo assim):', itsPermError);
                    // Define permiss√µes padr√£o (todas false) em caso de erro
                    permissoesITs = { adicionar: false, editar: false, excluir: false };
                }
            } catch (error) {
                console.error('Erro ao verificar autentica√ß√£o:', error);
                // S√≥ redireciona se for erro de autentica√ß√£o (n√£o de permiss√£o)
                if (error.message && error.message.includes('autentica√ß√£o')) {
                    window.location.href = 'index.html';
                    return;
                }
                // Se for outro tipo de erro, apenas loga e continua
                console.warn('‚ö†Ô∏è Erro n√£o cr√≠tico, continuando...');
            }
            
            // ‚úÖ Ocultar/mostrar bot√µes baseado nas permiss√µes
            const modeNova = document.getElementById('modeNova');
            const modeAtualizar = document.getElementById('modeAtualizar');
            const labelNova = document.querySelector('label[for="modeNova"]');
            const labelAtualizar = document.querySelector('label[for="modeAtualizar"]');
            const formUpload = document.querySelector('.card-modern');
            
            if (!permissoesITs.adicionar && !isAdmin) {
                if (modeNova) modeNova.style.display = 'none';
                if (labelNova) labelNova.style.display = 'none';
                if (formUpload) formUpload.style.display = 'none';
            }
            
            if (!permissoesITs.editar && !isAdmin) {
                if (modeAtualizar) modeAtualizar.style.display = 'none';
                if (labelAtualizar) labelAtualizar.style.display = 'none';
            }
            
            // Carregar √°reas no select e filtros
            carregarAreas();
            
            // ‚úÖ Garantir que isAdmin est√° definido antes de carregar ITs
            console.log('üéØ Antes de carregarITs() - isAdmin:', isAdmin);
            
            // Carregar ITs
            await carregarITs();
            
            // Configurar eventos
            configurarEventos();
        }
        
        function carregarAreas() {
            const select = document.getElementById('areaSelect');
            const filterTabs = document.getElementById('filterTabs');
            
            AREAS.forEach(area => {
                // Adicionar ao select
                const option = document.createElement('option');
                option.value = area.id;
                option.textContent = area.nome;
                select.appendChild(option);
                
                // Adicionar aos filtros
                const tab = document.createElement('div');
                tab.className = 'filter-tab';
                tab.dataset.area = area.id;
                tab.innerHTML = `<i class="fas fa-building me-1"></i> ${area.nome}`;
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    filtroArea = area.id;
                    carregarITs();
                });
                filterTabs.appendChild(tab);
            });
        }
        
        function configurarEventos() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const uploadForm = document.getElementById('uploadForm');
            const searchInput = document.getElementById('searchInput');
            
            // Clique na √°rea de upload
            uploadArea.addEventListener('click', () => fileInput.click());
            
            // Drag and drop
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });
            
            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0) {
                    handleFile(files[0]);
                }
            });
            
            // Sele√ß√£o de arquivo
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFile(e.target.files[0]);
                }
            });
            
            // Submit do formul√°rio
            uploadForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                await enviarIT();
            });
            
            // Cancelar upload
            document.getElementById('btnCancelarUpload').addEventListener('click', () => {
                selectedFile = null;
                fileInput.value = '';
                atualizarInterfaceUpload();
            });
            
            // Filtro "Todas"
            document.querySelector('.filter-tab[data-area="todas"]').addEventListener('click', (e) => {
                document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
                e.target.closest('.filter-tab').classList.add('active');
                filtroArea = 'todas';
                carregarITs();
            });
            
            // Busca
            let searchTimeout;
            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                termoBusca = e.target.value.trim().toLowerCase();
                searchTimeout = setTimeout(() => {
                    carregarITs();
                }, 300);
            });
            
            // ‚úÖ Filtros avan√ßados
            document.getElementById('filterTipoArquivo').addEventListener('change', (e) => {
                filtroTipoArquivo = e.target.value;
                carregarITs();
            });
            
            document.getElementById('filterVersao').addEventListener('change', (e) => {
                filtroVersao = e.target.value;
                carregarITs();
            });
            
            document.getElementById('sortBy').addEventListener('change', (e) => {
                sortBy = e.target.value;
                carregarITs();
            });
            
            document.getElementById('btnLimparFiltros').addEventListener('click', () => {
                filtroTipoArquivo = '';
                filtroVersao = '';
                sortBy = 'data_desc';
                document.getElementById('filterTipoArquivo').value = '';
                document.getElementById('filterVersao').value = '';
                document.getElementById('sortBy').value = 'data_desc';
                termoBusca = '';
                document.getElementById('searchInput').value = '';
                carregarITs();
            });
            
            // ‚úÖ Toggle de visualiza√ß√£o (Lista/Grid)
            document.getElementById('btnViewList').addEventListener('click', () => {
                currentView = 'list';
                document.getElementById('btnViewList').classList.add('active');
                document.getElementById('btnViewGrid').classList.remove('active');
                carregarITs();
            });
            
            document.getElementById('btnViewGrid').addEventListener('click', () => {
                currentView = 'grid';
                document.getElementById('btnViewGrid').classList.add('active');
                document.getElementById('btnViewList').classList.remove('active');
                carregarITs();
            });
            
            // ‚úÖ Modal de preview
            document.getElementById('btnClosePreview').addEventListener('click', () => {
                document.getElementById('previewModal').classList.remove('active');
            });
            
            document.getElementById('previewModal').addEventListener('click', (e) => {
                if (e.target.id === 'previewModal') {
                    document.getElementById('previewModal').classList.remove('active');
                }
            });
            
            // Fechar modal com ESC
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    document.getElementById('previewModal').classList.remove('active');
                }
            });
            
            // ‚úÖ Toggle entre Nova IT e Atualizar IT
            document.querySelectorAll('input[name="uploadMode"]').forEach(radio => {
                radio.addEventListener('change', async (e) => {
                    const modo = e.target.value;
                    const cardSelecionarIT = document.getElementById('cardSelecionarIT');
                    const codigoITLabel = document.getElementById('codigoITLabel');
                    const codigoITHint = document.getElementById('codigoITHint');
                    const btnEnviarText = document.getElementById('btnEnviarText');
                    const codigoITInput = document.getElementById('codigoIT');
                    
                    if (modo === 'atualizar') {
                        cardSelecionarIT.style.display = 'block';
                        codigoITLabel.innerHTML = '<span class="text-danger">*</span> (obrigat√≥rio para atualiza√ß√£o)';
                        codigoITHint.textContent = 'O c√≥digo √© necess√°rio para identificar a IT a ser atualizada';
                        btnEnviarText.textContent = 'Atualizar IT';
                        codigoITInput.required = true;
                        // Carregar ITs para o select
                        await carregarITsParaSelect();
                    } else {
                        cardSelecionarIT.style.display = 'none';
                        codigoITLabel.textContent = '(opcional)';
                        codigoITHint.textContent = 'Deixe em branco se n√£o tiver c√≥digo padronizado';
                        btnEnviarText.textContent = 'Enviar IT';
                        codigoITInput.required = false;
                        // Limpar sele√ß√£o
                        document.getElementById('itSelecionadaId').value = '';
                        document.getElementById('selectITParaAtualizar').value = '';
                        document.getElementById('infoITSelecionada').innerHTML = '';
                        limparFormulario();
                    }
                });
            });
            
            // ‚úÖ Select de IT para atualiza√ß√£o
            const selectIT = document.getElementById('selectITParaAtualizar');
            if (selectIT) {
                selectIT.addEventListener('change', async (e) => {
                    const itId = e.target.value;
                    if (itId) {
                        await selecionarITParaAtualizacaoPorId(itId);
                    } else {
                        document.getElementById('itSelecionadaId').value = '';
                        document.getElementById('infoITSelecionada').innerHTML = '';
                        limparCamposFormulario();
                    }
                });
            }
            
            // ‚úÖ Limpar formul√°rio
            const btnLimparForm = document.getElementById('btnLimparForm');
            if (btnLimparForm) {
                btnLimparForm.addEventListener('click', limparFormulario);
            }
        }
        
        // ‚úÖ NOVO: Fun√ß√£o para destacar termos de busca
        function highlightSearch(text, searchTerm) {
            if (!searchTerm || !text) return escapeHtml(text);
            
            const escapedText = escapeHtml(text);
            const escapedTerm = escapeHtml(searchTerm);
            const regex = new RegExp(`(${escapedTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return escapedText.replace(regex, '<span class="search-highlight">$1</span>');
        }
        
        // ‚úÖ NOVO: Carregar ITs para o select (apenas vers√µes atuais)
        async function carregarITsParaSelect() {
            const select = document.getElementById('selectITParaAtualizar');
            
            // Limpar op√ß√µes anteriores (exceto a primeira)
            select.innerHTML = '<option value="">Carregando ITs...</option>';
            select.disabled = true;
            
            try {
                // Buscar apenas ITs com vers√£o atual = true
                const { data: its, error } = await supabaseClient
                    .from('its_documentos')
                    .select('*')
                    .eq('versao_atual', true)
                    .order('nome', { ascending: true });
                
                if (error) {
                    console.error('Erro ao buscar ITs:', error);
                    throw error;
                }
                
                if (!its || its.length === 0) {
                    select.innerHTML = '<option value="">Nenhuma IT dispon√≠vel para atualiza√ß√£o</option>';
                    select.disabled = true;
                    return;
                }
                
                // Limpar e preparar select
                select.innerHTML = '<option value="">Selecione uma IT...</option>';
                
                // Agrupar por √°rea para melhor organiza√ß√£o
                const itsPorArea = {};
                its.forEach(it => {
                    if (!itsPorArea[it.area]) {
                        itsPorArea[it.area] = [];
                    }
                    itsPorArea[it.area].push(it);
                });
                
                // Ordenar √°reas
                const areasOrdenadas = Object.keys(itsPorArea).sort((a, b) => {
                    const nomeA = AREAS.find(area => area.id === a)?.nome || a;
                    const nomeB = AREAS.find(area => area.id === b)?.nome || b;
                    return nomeA.localeCompare(nomeB);
                });
                
                // Adicionar op√ß√µes agrupadas por √°rea
                areasOrdenadas.forEach(areaId => {
                    const areaNome = AREAS.find(a => a.id === areaId)?.nome || areaId;
                    const optgroup = document.createElement('optgroup');
                    optgroup.label = areaNome;
                    
                    // Ordenar ITs dentro da √°rea por c√≥digo e nome
                    itsPorArea[areaId].sort((a, b) => {
                        if (a.codigo_it && b.codigo_it) {
                            return a.codigo_it.localeCompare(b.codigo_it);
                        }
                        if (a.codigo_it) return -1;
                        if (b.codigo_it) return 1;
                        return a.nome.localeCompare(b.nome);
                    });
                    
                    itsPorArea[areaId].forEach(it => {
                        const option = document.createElement('option');
                        option.value = it.id;
                        let texto = it.nome;
                        if (it.codigo_it) {
                            texto = `${it.codigo_it} - ${texto}`;
                        }
                        if (it.versao) {
                            texto += ` (v${it.versao})`;
                        }
                        option.textContent = texto;
                        optgroup.appendChild(option);
                    });
                    
                    select.appendChild(optgroup);
                });
                
                select.disabled = false;
                
            } catch (error) {
                console.error('Erro ao carregar ITs para select:', error);
                select.innerHTML = '<option value="">Erro ao carregar ITs. Tente novamente.</option>';
                select.disabled = false;
            }
        }
        
        // ‚úÖ NOVO: Selecionar IT para atualiza√ß√£o por ID
        async function selecionarITParaAtualizacaoPorId(itId) {
            try {
                const { data: it, error } = await supabaseClient
                    .from('its_documentos')
                    .select('*')
                    .eq('id', itId)
                    .single();
                
                if (error) throw error;
                
                if (!it) {
                    alert('IT n√£o encontrada');
                    return;
                }
                
                selecionarITParaAtualizacao(it);
                
            } catch (error) {
                console.error('Erro ao buscar IT por ID:', error);
                alert('Erro ao carregar dados da IT selecionada');
            }
        }
        
        // ‚úÖ NOVO: Selecionar IT para atualiza√ß√£o
        function selecionarITParaAtualizacao(it) {
            // Armazenar ID da IT selecionada
            document.getElementById('itSelecionadaId').value = it.id;
            
            // Preencher campos do formul√°rio
            document.getElementById('areaSelect').value = it.area || '';
            document.getElementById('codigoIT').value = it.codigo_it || '';
            document.getElementById('nomeIT').value = it.nome || '';
            
            // Sugerir pr√≥xima vers√£o (se tiver vers√£o atual, incrementar)
            if (it.versao) {
                const versaoAtual = parseFloat(it.versao.replace(/[^0-9.]/g, ''));
                if (!isNaN(versaoAtual)) {
                    // Se a vers√£o for um n√∫mero inteiro (1, 2, 3), incrementar para o pr√≥ximo inteiro
                    // Se for decimal (1.1, 1.2), incrementar 0.1
                    if (versaoAtual % 1 === 0) {
                        document.getElementById('versaoIT').value = (versaoAtual + 1).toString();
                    } else {
                        document.getElementById('versaoIT').value = (versaoAtual + 0.1).toFixed(1);
                    }
                } else {
                    document.getElementById('versaoIT').value = '1.0';
                }
            } else {
                document.getElementById('versaoIT').value = '1.0';
            }
            
            // Mostrar informa√ß√µes da IT selecionada
            const areaNome = AREAS.find(a => a.id === it.area)?.nome || it.area;
            const dataUpload = new Date(it.created_at).toLocaleDateString('pt-BR');
            const horaUpload = new Date(it.created_at).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            const uploadedBy = it.uploaded_by_nome || it.uploaded_by || 'Desconhecido';
            
            document.getElementById('infoITSelecionada').innerHTML = `
                <div class="alert alert-success">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-2">
                                <i class="fas fa-check-circle me-2"></i>
                                IT Selecionada para Atualiza√ß√£o
                            </h6>
                            <div class="mb-2">
                                <strong>${it.codigo_it ? escapeHtml(it.codigo_it) + ' - ' : ''}${escapeHtml(it.nome)}</strong>
                            </div>
                            <div class="small text-muted mb-2">
                                <div><i class="fas fa-building me-1"></i><strong>√Årea:</strong> ${escapeHtml(areaNome)}</div>
                                ${it.versao ? `<div><i class="fas fa-tag me-1"></i><strong>Vers√£o Atual:</strong> v${escapeHtml(it.versao)}</div>` : ''}
                                <div><i class="fas fa-calendar me-1"></i><strong>Data de Cria√ß√£o:</strong> ${dataUpload} √†s ${horaUpload}</div>
                                <div><i class="fas fa-user me-1"></i><strong>Criado por:</strong> ${escapeHtml(uploadedBy)}</div>
                            </div>
                            <div class="mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Os campos acima foram preenchidos automaticamente. Revise e selecione o novo arquivo para criar uma nova vers√£o.
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('btnLimparForm').style.display = 'inline-block';
        }
        
        // ‚úÖ NOVO: Limpar apenas campos do formul√°rio (sem resetar tudo)
        function limparCamposFormulario() {
            document.getElementById('areaSelect').value = '';
            document.getElementById('codigoIT').value = '';
            document.getElementById('nomeIT').value = '';
            document.getElementById('versaoIT').value = '';
        }
        
        // ‚úÖ NOVO: Limpar formul√°rio
        function limparFormulario() {
            document.getElementById('uploadForm').reset();
            selectedFile = null;
            document.getElementById('fileInput').value = '';
            document.getElementById('selectedFile').innerHTML = '';
            document.getElementById('btnEnviar').disabled = true;
            document.getElementById('btnCancelarUpload').style.display = 'none';
            const btnLimparForm = document.getElementById('btnLimparForm');
            if (btnLimparForm) {
                btnLimparForm.style.display = 'none';
            }
            limparCamposFormulario();
            document.getElementById('itSelecionadaId').value = '';
            const selectIT = document.getElementById('selectITParaAtualizar');
            if (selectIT) {
                selectIT.value = '';
            }
            const infoITSelecionada = document.getElementById('infoITSelecionada');
            if (infoITSelecionada) {
                infoITSelecionada.innerHTML = '';
            }
            
            // Resetar para modo "Nova IT"
            const modeNova = document.getElementById('modeNova');
            if (modeNova) {
                modeNova.checked = true;
            }
            const cardSelecionarIT = document.getElementById('cardSelecionarIT');
            if (cardSelecionarIT) {
                cardSelecionarIT.style.display = 'none';
            }
            const codigoITLabel = document.getElementById('codigoITLabel');
            if (codigoITLabel) {
                codigoITLabel.textContent = '(opcional)';
            }
            const codigoITHint = document.getElementById('codigoITHint');
            if (codigoITHint) {
                codigoITHint.textContent = 'Deixe em branco se n√£o tiver c√≥digo padronizado';
            }
            const btnEnviarText = document.getElementById('btnEnviarText');
            if (btnEnviarText) {
                btnEnviarText.textContent = 'Enviar IT';
            }
            const codigoIT = document.getElementById('codigoIT');
            if (codigoIT) {
                codigoIT.required = false;
            }
        }
        
        // ‚úÖ NOVO: Fun√ß√£o para abrir preview
        function abrirPreview(url, nome, tipoArquivo) {
            const modal = document.getElementById('previewModal');
            const modalBody = document.getElementById('previewModalBody');
            const modalTitle = document.getElementById('previewModalTitle');
            
            modalTitle.textContent = escapeHtml(nome || 'Visualizar Documento');
            modalBody.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div><p class="mt-2">Carregando...</p></div>';
            modal.classList.add('active');
            
            // Detectar se √© arquivo Word
            const isWord = tipoArquivo && (
                tipoArquivo.includes('word') || 
                tipoArquivo.includes('document') ||
                tipoArquivo === 'application/msword' ||
                tipoArquivo === 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
            );
            
            if (tipoArquivo && tipoArquivo.startsWith('image/')) {
                // Imagens
                modalBody.innerHTML = `<img src="${escapeHtml(url)}" alt="${escapeHtml(nome)}" style="max-width: 100%; max-height: 70vh; border-radius: 8px;">`;
            } else if (tipoArquivo === 'application/pdf') {
                // PDFs - Usar iframe com fallback
                const safeUrl = escapeHtml(url);
                modalBody.innerHTML = `
                    <div style="position: relative; width: 100%; height: 70vh;">
                        <iframe 
                            src="${safeUrl}" 
                            style="width: 100%; height: 100%; border: none; border-radius: 8px;"
                            title="Visualiza√ß√£o do PDF: ${escapeHtml(nome)}"
                            onerror="this.parentElement.innerHTML='<div class=\\'text-center py-5\\'><i class=\\'fas fa-exclamation-triangle text-warning\\' style=\\'font-size: 3rem;\\'></i><h5 class=\\'mt-3\\'>Erro ao carregar PDF</h5><p class=\\'text-muted\\'>N√£o foi poss√≠vel exibir o PDF no navegador.</p><a href=\\'${safeUrl}\\' download=\\'${escapeHtml(nome)}\\' class=\\'btn btn-primary mt-3\\'><i class=\\'fas fa-download me-2\\'></i>Baixar PDF</a></div>'"
                            loading="lazy">
                        </iframe>
                        <div class="text-center py-3" style="background: #f8f9fa; border-top: 1px solid #dee2e6; margin-top: 0.5rem;">
                            <a href="${safeUrl}" download="${escapeHtml(nome)}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-download me-2"></i>Baixar PDF
                            </a>
                            <button onclick="window.open('${safeUrl}', '_blank', 'noopener,noreferrer')" class="btn btn-sm btn-outline-secondary ms-2">
                                <i class="fas fa-external-link-alt me-2"></i>Abrir em Nova Aba
                            </button>
                        </div>
                    </div>
                `;
            } else if (isWord) {
                // Arquivos Word (.doc, .docx) - Abrir em nova aba devido ao CSP
                const encodedUrl = encodeURIComponent(url);
                const viewerUrlGoogle = `https://docs.google.com/viewer?url=${encodedUrl}&embedded=true`;
                const viewerUrlOffice = `https://view.officeapps.live.com/op/embed.aspx?src=${encodedUrl}`;
                
                modalBody.innerHTML = `
                    <div class="text-center py-5">
                        <div class="mb-4">
                            <i class="fas fa-file-word" style="font-size: 4rem; color: #2b579a;"></i>
                        </div>
                        <h5 class="mb-3">${escapeHtml(nome)}</h5>
                        <p class="text-muted mb-4">Escolha como deseja visualizar o documento Word:</p>
                        <div class="d-flex flex-column gap-3 align-items-center">
                            <button 
                                onclick="window.open('${viewerUrlGoogle}', '_blank', 'noopener,noreferrer')" 
                                class="btn btn-primary btn-lg">
                                <i class="fas fa-eye me-2"></i>Visualizar no Google Docs Viewer
                            </button>
                            <button 
                                onclick="window.open('${viewerUrlOffice}', '_blank', 'noopener,noreferrer')" 
                                class="btn btn-outline-primary btn-lg">
                                <i class="fab fa-microsoft me-2"></i>Visualizar no Office Online
                            </button>
                            <a 
                                href="${escapeHtml(url)}" 
                                download="${escapeHtml(nome)}" 
                                class="btn btn-outline-secondary btn-lg">
                                <i class="fas fa-download me-2"></i>Baixar Arquivo
                            </a>
                        </div>
                        <div class="mt-4">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                O documento ser√° aberto em uma nova aba devido √†s configura√ß√µes de seguran√ßa.
                            </small>
                        </div>
                    </div>
                `;
            } else {
                // Outros tipos de arquivo
                modalBody.innerHTML = `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        Este tipo de arquivo n√£o pode ser visualizado no navegador.
                        <br><br>
                        <a href="${escapeHtml(url)}" download="${escapeHtml(nome)}" class="btn btn-primary">
                            <i class="fas fa-download me-2"></i>Baixar Arquivo
                        </a>
                    </div>
                `;
            }
        }
        
        function handleFile(file) {
                const validTypes = ['application/pdf', 'image/png', 'image/jpeg', 'image/jpg', 
                                   'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document'];
                const maxSize = 10 * 1024 * 1024; // 10MB
                
                if (!validTypes.includes(file.type)) {
                    alert(`Arquivo ${file.name} n√£o √© um formato v√°lido.`);
                return;
                }
                
                if (file.size > maxSize) {
                    alert(`Arquivo ${file.name} excede 10MB.`);
                return;
                }
                
            selectedFile = file;
            atualizarInterfaceUpload();
            mostrarPreviewArquivo(file);
        }
        
        // ‚úÖ NOVO: Mostrar preview do arquivo antes do upload
        function mostrarPreviewArquivo(file) {
            const selectedFileDiv = document.getElementById('selectedFile');
            const reader = new FileReader();
            
            if (file.type.startsWith('image/')) {
                reader.onload = function(e) {
                    selectedFileDiv.innerHTML = `
                        <div class="file-preview">
                            <h6 class="mb-2"><i class="fas fa-image me-2"></i>Preview da Imagem</h6>
                            <img src="${e.target.result}" alt="Preview" class="file-preview-img">
                            <div class="file-preview-info mt-2">
                                <div class="file-preview-icon">
                                    <i class="fas fa-file-image"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <strong>${escapeHtml(file.name)}</strong><br>
                                    <small class="text-muted">${formatFileSize(file.size)}</small>
                                </div>
                            </div>
                        </div>
                    `;
                };
                reader.readAsDataURL(file);
            } else if (file.type === 'application/pdf') {
                selectedFileDiv.innerHTML = `
                    <div class="file-preview">
                        <h6 class="mb-2"><i class="fas fa-file-pdf me-2"></i>Preview do PDF</h6>
                        <div class="file-preview-info">
                            <div class="file-preview-icon">
                                <i class="fas fa-file-pdf" style="color: #dc3545;"></i>
                            </div>
                            <div class="flex-grow-1">
                                <strong>${escapeHtml(file.name)}</strong><br>
                                <small class="text-muted">${formatFileSize(file.size)}</small><br>
                                <small class="text-muted"><i class="fas fa-info-circle me-1"></i>O PDF ser√° aberto em uma nova aba ap√≥s o upload</small>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                selectedFileDiv.innerHTML = `
                    <div class="file-preview">
                        <h6 class="mb-2"><i class="fas fa-file-word me-2"></i>Preview do Documento</h6>
                        <div class="file-preview-info">
                            <div class="file-preview-icon">
                                <i class="fas fa-file-word" style="color: #2b579a;"></i>
                            </div>
                            <div class="flex-grow-1">
                                <strong>${escapeHtml(file.name)}</strong><br>
                                <small class="text-muted">${formatFileSize(file.size)}</small>
                            </div>
                        </div>
                    </div>
                `;
            }
        }
        
        function atualizarInterfaceUpload() {
            const selectedFileDiv = document.getElementById('selectedFile');
            const btnEnviar = document.getElementById('btnEnviar');
            const btnCancelar = document.getElementById('btnCancelarUpload');
            
            if (!selectedFile) {
                selectedFileDiv.innerHTML = '';
                btnEnviar.disabled = true;
                btnCancelar.style.display = 'none';
                return;
            }
            
            btnEnviar.disabled = false;
            btnCancelar.style.display = 'inline-block';
            
            // O preview j√° foi mostrado pela fun√ß√£o mostrarPreviewArquivo quando o arquivo foi selecionado
            // Esta fun√ß√£o s√≥ atualiza o estado dos bot√µes
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }
        
        function normalizeCodigoIT(codigo) {
            if (!codigo) return null;
            return codigo.trim().toUpperCase();
        }
        
        // ‚úÖ Fun√ß√£o para verificar permiss√µes de ITs
        async function verificarPermissoesITs() {
            try {
                const loggedInUserData = localStorage.getItem('loggedInUser');
                if (!loggedInUserData) {
                    permissoesITs = { adicionar: false, editar: false, excluir: false };
                    return;
                }

                const userData = JSON.parse(loggedInUserData);
                const userId = userData.id;

                // Se for admin, tem todas as permiss√µes
                if (userData.isAdmin === true || userData.role === 'admin') {
                    permissoesITs = { adicionar: true, editar: true, excluir: true };
                    return;
                }

                // Se n√£o houver supabaseClient, n√£o pode verificar permiss√µes
                if (!supabaseClient) {
                    permissoesITs = { adicionar: false, editar: false, excluir: false };
                    return;
                }

                // Buscar permiss√µes de ITs do usu√°rio
                const { data: permissoes, error } = await supabaseClient
                    .from('permissoes_portal')
                    .select('permissao_id')
                    .eq('usuario_id', userId)
                    .in('permissao_id', ['its_adicionar', 'its_editar', 'its_excluir']);

                if (error) {
                    console.warn('‚ö†Ô∏è Erro ao buscar permiss√µes de ITs:', error);
                    permissoesITs = { adicionar: false, editar: false, excluir: false };
                    return;
                }

                permissoesITs = {
                    adicionar: permissoes?.some(p => p.permissao_id === 'its_adicionar') || false,
                    editar: permissoes?.some(p => p.permissao_id === 'its_editar') || false,
                    excluir: permissoes?.some(p => p.permissao_id === 'its_excluir') || false
                };

                if (window.DEBUG || window.location.hostname === 'localhost') {
                    console.log('üìã Permiss√µes de ITs carregadas:', permissoesITs);
                }
            } catch (error) {
                console.error('‚ùå Erro ao verificar permiss√µes de ITs:', error);
                permissoesITs = { adicionar: false, editar: false, excluir: false };
            }
        }
        
        async function enviarIT() {
            const modoAtualizar = document.getElementById('modeAtualizar').checked;
            const itSelecionadaId = document.getElementById('itSelecionadaId').value;
            const area = document.getElementById('areaSelect').value;
            const codigoIT = document.getElementById('codigoIT').value.trim();
            const nomeIT = document.getElementById('nomeIT').value.trim();
            const versaoIT = document.getElementById('versaoIT').value.trim();
            
            // ‚úÖ Valida√ß√µes espec√≠ficas para atualiza√ß√£o
            if (modoAtualizar) {
                const selectIT = document.getElementById('selectITParaAtualizar');
                // Verificar tanto o hidden input quanto o select
                let itIdSelecionada = itSelecionadaId || (selectIT ? selectIT.value : '');
                
                if (!itIdSelecionada || itIdSelecionada === '') {
                    alert('‚ö†Ô∏è Selecione uma IT existente para atualizar na lista suspensa acima');
                    if (selectIT) {
                        selectIT.focus();
                        selectIT.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                return;
            }
            
                // Atualizar o hidden input se necess√°rio
                if (!itSelecionadaId && selectIT) {
                    document.getElementById('itSelecionadaId').value = itIdSelecionada;
                }
                
                if (!codigoIT) {
                    alert('‚ö†Ô∏è O c√≥digo da IT √© obrigat√≥rio para atualiza√ß√£o');
                    document.getElementById('codigoIT').focus();
                    return;
                }
            }
            
            if (!area) {
                alert('Selecione uma √°rea');
                return;
            }
            
            if (!nomeIT) {
                alert('Informe o nome/descri√ß√£o da IT');
                return;
            }
            
            if (!selectedFile) {
                alert('Selecione um arquivo');
                return;
            }
            
            const btnEnviar = document.getElementById('btnEnviar');
            btnEnviar.disabled = true;
            btnEnviar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Enviando...';
            
            try {
                // Normalizar c√≥digo IT
                const codigoNormalizado = normalizeCodigoIT(codigoIT);
                
                // ‚úÖ VERSIONAMENTO: Declarar vari√°vel antes do bloco if
                let itsExistentes = null;
                
                // ‚úÖ VERSIONAMENTO: Se for atualiza√ß√£o ou se houver c√≥digo, verificar se j√° existe IT com mesmo c√≥digo
                if (modoAtualizar && itSelecionadaId) {
                    // Modo atualiza√ß√£o: buscar todas as vers√µes da IT selecionada
                    const { data: itSelecionada, error: itError } = await supabaseClient
                        .from('its_documentos')
                        .select('codigo_it_normalizado')
                        .eq('id', itSelecionadaId)
                        .single();
                    
                    if (!itError && itSelecionada && itSelecionada.codigo_it_normalizado) {
                        const { data: itsData, error: buscaError } = await supabaseClient
                            .from('its_documentos')
                            .select('id, versao_atual')
                            .eq('codigo_it_normalizado', itSelecionada.codigo_it_normalizado);
                        
                        if (!buscaError && itsData) {
                            itsExistentes = itsData;
                        }
                    }
                } else if (codigoNormalizado) {
                    // Modo nova IT com c√≥digo: buscar TODAS as ITs existentes com o mesmo c√≥digo
                    const { data: itsData, error: buscaError } = await supabaseClient
                        .from('its_documentos')
                        .select('id, versao_atual, versao, nome')
                        .eq('codigo_it_normalizado', codigoNormalizado);
                    
                    if (buscaError) {
                        console.warn('Aviso ao buscar ITs existentes:', buscaError);
                    } else {
                        itsExistentes = itsData || [];
                        console.log(`üîç Encontradas ${itsExistentes.length} IT(s) existente(s) com c√≥digo ${codigoNormalizado}:`, 
                            itsExistentes.map(it => ({ id: it.id, versao: it.versao, versao_atual: it.versao_atual }))
                        );
                    }
                }
                
                // ‚úÖ Se houver ITs com o mesmo c√≥digo, marcar TODAS como n√£o atuais (ANTES de inserir a nova)
                if (itsExistentes && itsExistentes.length > 0) {
                    // IMPORTANTE: Arquivar TODAS as vers√µes existentes, independente do status atual
                    // Isso garante que apenas a nova vers√£o que estamos criando ser√° marcada como atual
                    const idsParaAtualizar = itsExistentes
                        .filter(it => it.id) // Apenas IDs v√°lidos
                        .map(it => it.id);
                    
                    if (idsParaAtualizar.length > 0) {
                        console.log(`üîÑ Arquivando ${idsParaAtualizar.length} vers√£o(√µes) anterior(es)...`);
                        console.log('IDs para arquivar:', idsParaAtualizar);
                        console.log('ITs existentes encontradas:', itsExistentes.map(it => ({
                            id: it.id,
                            versao: it.versao || 'N/A',
                            versao_atual: it.versao_atual
                        })));
                        
                        const agora = new Date().toISOString();
                        const { data: updateData, error: updateError } = await supabaseClient
                            .from('its_documentos')
                            .update({ 
                                versao_atual: false,
                                updated_at: agora // Registrar quando foi arquivada
                            })
                            .in('id', idsParaAtualizar)
                            .select('id, nome, codigo_it, versao, versao_atual');
                        
                        if (updateError) {
                            console.error('‚ùå Erro ao atualizar vers√µes antigas:', updateError);
                            throw new Error('Erro ao atualizar vers√µes anteriores da IT: ' + updateError.message);
                        } else {
                            const qtdAtualizada = updateData?.length || idsParaAtualizar.length;
                            console.log(`‚úÖ ${qtdAtualizada} vers√£o(√µes) anterior(es) marcada(s) como n√£o atuais`);
                            if (updateData && updateData.length > 0) {
                                console.log('ITs arquivadas:', updateData.map(it => 
                                    `${it.nome || 'Sem nome'} (${it.codigo_it || 'sem c√≥digo'}) v${it.versao || 'N/A'}`
                                ));
                            }
                        }
                    } else {
                        console.log('‚ÑπÔ∏è Nenhuma vers√£o anterior marcada como atual encontrada para arquivar');
                    }
                }
                
                // Criar nome √∫nico para o arquivo
                const timestamp = Date.now();
                const fileExt = selectedFile.name.split('.').pop();
                const fileName = `its/${area}/${timestamp}_${sanitizeFilename(selectedFile.name)}`;
                
                // Upload para Supabase Storage
                const { data: uploadData, error: uploadError } = await supabaseClient.storage
                    .from('anexos')
                    .upload(fileName, selectedFile, {
                        cacheControl: '3600',
                        upsert: false
                    });
                
                if (uploadError) {
                    throw uploadError;
                }
                
                // Obter URL p√∫blica
                const { data: urlData } = supabaseClient.storage
                    .from('anexos')
                    .getPublicUrl(fileName);
                
                // ‚úÖ Obter dados do usu√°rio - tentar m√∫ltiplas fontes
                let userId = 'unknown';
                let userEmail = 'Usu√°rio Desconhecido';
                let userName = 'Usu√°rio Desconhecido';
                
                // 1. Tentar obter do Supabase Auth (mais confi√°vel)
                try {
                    const { data: { user: supabaseUser } } = await supabaseClient.auth.getUser();
                    if (supabaseUser) {
                        userId = supabaseUser.id;
                        userEmail = supabaseUser.email || userEmail;
                        userName = supabaseUser.email || userName;
                        console.log('üë§ Usu√°rio obtido do Supabase Auth:', { id: userId, email: userEmail });
                    }
                } catch (authError) {
                    console.warn('‚ö†Ô∏è Erro ao obter usu√°rio do Supabase Auth:', authError);
                }
                
                // 2. Tentar obter do currentUser (API)
                if (currentUser) {
                    userId = currentUser?.id || currentUser?.usuario || currentUser?.userData?.id || userId;
                    userEmail = currentUser?.email || currentUser?.userData?.email || userEmail;
                    userName = currentUser?.nome || currentUser?.username || currentUser?.userData?.nome || userEmail || userName;
                    console.log('üë§ Dados do currentUser:', { id: userId, email: userEmail, nome: userName });
                }
                
                // 3. Tentar buscar nome completo do perfil do usu√°rio no banco (PRIORIT√ÅRIO para o nome)
                if (supabaseClient && userId && userId !== 'unknown') {
                    try {
                        const { data: profile, error: profileError } = await supabaseClient
                            .from('user_profiles')
                            .select('nome, email')
                            .eq('id', userId)
                            .maybeSingle();
                        
                        if (!profileError && profile) {
                            // Priorizar nome do perfil acima de tudo
                            if (profile.nome && profile.nome.trim() !== '') {
                                userName = profile.nome.trim();
                            }
                            // Se n√£o tiver email v√°lido ainda, usar o do perfil
                            if (profile.email && (!userEmail || userEmail === 'Usu√°rio Desconhecido' || !userEmail.includes('@'))) {
                                userEmail = profile.email;
                            }
                            console.log('üë§ Perfil obtido do banco:', { nome: userName, email: userEmail });
                        } else if (profileError) {
                            console.warn('‚ö†Ô∏è Erro ao buscar perfil do usu√°rio:', profileError);
                        }
                    } catch (profileErr) {
                        console.warn('‚ö†Ô∏è Erro ao buscar perfil do usu√°rio (catch):', profileErr);
                    }
                }
                
                // 4. Se ainda n√£o tiver nome, usar email como fallback final
                if (userName === 'Usu√°rio Desconhecido' && userEmail && userEmail !== 'Usu√°rio Desconhecido') {
                    userName = userEmail.split('@')[0]; // Usar parte antes do @ como nome
                }
                
                console.log('‚úÖ Dados finais do usu√°rio:', { userId, userEmail, userName });
                
                // ‚úÖ Data e hora atual
                const agora = new Date().toISOString();
                
                // Salvar registro na tabela (nova vers√£o sempre √© marcada como atual)
                const { data: insertData, error: insertError } = await supabaseClient
                    .from('its_documentos')
                    .insert({
                        area: area,
                        codigo_it: codigoIT || null,
                        codigo_it_normalizado: codigoNormalizado,
                        nome: nomeIT,
                        versao: versaoIT || null,
                        nome_arquivo: selectedFile.name,
                        tipo_arquivo: selectedFile.type,
                        tamanho: selectedFile.size,
                        url: urlData.publicUrl,
                        caminho_storage: fileName,
                        uploaded_by: userId,
                        uploaded_by_nome: userName,
                        versao_atual: codigoNormalizado ? true : null, // S√≥ marca como atual se tiver c√≥digo
                        created_at: agora,
                        updated_at: agora
                    })
                    .select()
                    .single();
                
                if (insertError) {
                    // Se erro na inser√ß√£o, remover arquivo do storage
                    await supabaseClient.storage.from('anexos').remove([fileName]);
                    throw insertError;
                }
                
                const mensagem = modoAtualizar || (codigoNormalizado && itsExistentes && itsExistentes.length > 0)
                    ? `‚úÖ IT ${codigoNormalizado || 'selecionada'} atualizada com sucesso! Vers√£o anterior arquivada.`
                    : '‚úÖ IT enviada com sucesso!';
                
                alert(mensagem);
                
                // Limpar formul√°rio
                limparFormulario();
                await carregarITs();
                
            } catch (error) {
                console.error('Erro ao enviar IT:', error);
                alert('‚ùå Erro ao enviar IT: ' + (error.message || 'Tente novamente.'));
            } finally {
                btnEnviar.disabled = false;
                btnEnviar.innerHTML = '<i class="fas fa-upload me-2"></i>Enviar IT';
            }
        }
        
        function sanitizeFilename(filename) {
            return filename
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/[^a-zA-Z0-9.\-_]/g, '_');
        }
        
        // ‚úÖ Fun√ß√£o para escapar HTML e prevenir XSS
        function escapeHtml(text) {
            if (!text) return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return String(text).replace(/[&<>"']/g, m => map[m]);
        }
        
        // ‚úÖ Fun√ß√£o para escapar strings JavaScript (para uso em atributos)
        function escapeJs(str) {
            if (!str) return '';
            return String(str)
                .replace(/\\/g, '\\\\')
                .replace(/'/g, "\\'")
                .replace(/"/g, '\\"')
                .replace(/\n/g, '\\n')
                .replace(/\r/g, '\\r')
                .replace(/\t/g, '\\t');
        }
        
        async function carregarITs() {
            const container = document.getElementById('itsList');
            container.innerHTML = '<div class="text-center py-4"><div class="spinner-border text-primary"></div><p class="mt-2">Carregando ITs...</p></div>';
            // Resetar classes do container
            container.className = '';
            
            // ‚úÖ Garantir que isAdmin est√° definida e criar vari√°vel local para uso nos template strings
            const userIsAdmin = (typeof isAdmin !== 'undefined' && isAdmin === true) || false;
            console.log('üîç carregarITs - isAdmin:', isAdmin, 'userIsAdmin:', userIsAdmin);
            
            try {
                let query = supabaseClient
                    .from('its_documentos')
                    .select('*')
                    .order('created_at', { ascending: false });
                
                // Aplicar filtro de √°rea
                if (filtroArea !== 'todas') {
                    query = query.eq('area', filtroArea);
                }
                
                const { data: its, error } = await query;
                
                if (error) {
                    throw error;
                }
                
                // Aplicar filtros
                let itsFiltradas = its || [];
                
                // Filtro de busca
                if (termoBusca) {
                    itsFiltradas = itsFiltradas.filter(it => 
                        (it.nome && it.nome.toLowerCase().includes(termoBusca)) ||
                        (it.codigo_it && it.codigo_it.toLowerCase().includes(termoBusca)) ||
                        (it.area && it.area.toLowerCase().includes(termoBusca)) ||
                        (it.versao && it.versao.toLowerCase().includes(termoBusca))
                    );
                }
                
                // Filtro de tipo de arquivo
                if (filtroTipoArquivo) {
                    itsFiltradas = itsFiltradas.filter(it => {
                        if (filtroTipoArquivo === 'pdf') return it.tipo_arquivo && it.tipo_arquivo.includes('pdf');
                        if (filtroTipoArquivo === 'image') return it.tipo_arquivo && it.tipo_arquivo.startsWith('image/');
                        if (filtroTipoArquivo === 'word') return it.tipo_arquivo && (it.tipo_arquivo.includes('word') || it.tipo_arquivo.includes('document'));
                        return true;
                    });
                }
                
                // Filtro de vers√£o
                if (filtroVersao) {
                    if (filtroVersao === 'atual') {
                        itsFiltradas = itsFiltradas.filter(it => it.versao_atual === true);
                    } else if (filtroVersao === 'antiga') {
                        itsFiltradas = itsFiltradas.filter(it => it.versao_atual === false || it.versao_atual === null);
                    }
                }
                
                // ‚úÖ Aplicar ordena√ß√£o
                itsFiltradas.sort((a, b) => {
                    switch(sortBy) {
                        case 'data_asc':
                            return new Date(a.created_at) - new Date(b.created_at);
                        case 'data_desc':
                            return new Date(b.created_at) - new Date(a.created_at);
                        case 'nome_asc':
                            return (a.nome || '').localeCompare(b.nome || '');
                        case 'nome_desc':
                            return (b.nome || '').localeCompare(a.nome || '');
                        case 'area_asc':
                            return (a.area || '').localeCompare(b.area || '');
                        default:
                            return new Date(b.created_at) - new Date(a.created_at);
                    }
                });
                
                // ‚úÖ VERSIONAMENTO: Agrupar ITs por c√≥digo normalizado
                const itsPorCodigo = new Map();
                const itsSemCodigo = [];
                
                itsFiltradas.forEach(it => {
                    const codigo = normalizeCodigoIT(it.codigo_it);
                    if (codigo) {
                        if (!itsPorCodigo.has(codigo)) {
                            itsPorCodigo.set(codigo, []);
                        }
                        itsPorCodigo.get(codigo).push(it);
                    } else {
                        itsSemCodigo.push(it);
                    }
                });
                
                // Ordenar vers√µes dentro de cada grupo (mais recente primeiro, vers√£o atual primeiro)
                itsPorCodigo.forEach((versoes, codigo) => {
                    versoes.sort((a, b) => {
                        // Vers√£o atual primeiro
                        if (a.versao_atual && !b.versao_atual) return -1;
                        if (!a.versao_atual && b.versao_atual) return 1;
                        // Depois ordenar por data (mais recente primeiro)
                        return new Date(b.created_at) - new Date(a.created_at);
                    });
                });
                
                const totalGrupos = itsPorCodigo.size + itsSemCodigo.length;
                document.getElementById('totalITs').textContent = `${totalGrupos} ${totalGrupos === 1 ? 'IT' : 'ITs'}`;
                
                if (itsFiltradas.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-file-invoice"></i>
                            <h4>Nenhuma IT encontrada</h4>
                            <p>${filtroArea === 'todas' && !termoBusca ? 'Envie uma IT usando o formul√°rio acima' : 'Nenhuma IT encontrada com os filtros selecionados'}</p>
                        </div>
                    `;
                    return;
                }
                
                let html = '';
                
                // ‚úÖ Preparar container (grupos sempre em lista, cards individuais podem ser grid)
                container.className = 'its-list'; // Base sempre lista para grupos
                
                // ‚úÖ Capturar permiss√µes em vari√°veis que ser√£o acess√≠veis dentro dos closures
                const podeExcluir = permissoesITs.excluir || isAdmin;
                const podeEditar = permissoesITs.editar || isAdmin;
                const podeAdicionar = permissoesITs.adicionar || isAdmin;
                console.log('üîç Renderizando ITs - Permiss√µes:', { podeExcluir, podeEditar, podeAdicionar, isAdmin });
                
                // Renderizar grupos agrupados por c√≥digo
                itsPorCodigo.forEach((versoes, codigo) => {
                    const versaoAtual = versoes.find(v => v.versao_atual) || versoes[0];
                    const areaNome = AREAS.find(a => a.id === versaoAtual.area)?.nome || versaoAtual.area;
                    const totalVersoes = versoes.length;
                    
                    const codigoEscapado = escapeHtml(codigo);
                    const codigoHighlight = highlightSearch(codigo, termoBusca);
                    const areaNomeHighlight = highlightSearch(areaNome, termoBusca);
                    const versaoAtualNomeHighlight = highlightSearch(versaoAtual.nome || '', termoBusca);
                    
                    html += `
                        <div class="it-group fade-in">
                            <div class="it-group-header expanded" data-codigo="${codigoEscapado}" style="cursor: pointer;">
                                <div class="it-group-info">
                                    <div class="it-group-codigo">
                                        <i class="fas fa-folder-open me-2"></i>${codigoHighlight}
                                        ${versaoAtual.versao_atual ? `<span class="status-badge atual ms-2"><i class="fas fa-check-circle me-1"></i>Vers√£o Atual</span>` : ''}
                                    </div>
                                    <div class="it-group-meta">
                                        <span class="badge-area">
                                            <i class="fas fa-building me-1"></i> ${areaNomeHighlight}
                                        </span>
                                        <span><i class="fas fa-file-${getFileIcon(versaoAtual.tipo_arquivo)} me-1"></i> ${versaoAtualNomeHighlight}</span>
                                        <span><i class="fas fa-layer-group me-1"></i> ${totalVersoes} ${totalVersoes === 1 ? 'vers√£o' : 'vers√µes'}</span>
                                    </div>
                                </div>
                                <div class="it-group-toggle">
                                    <i class="fas fa-chevron-down"></i>
                                </div>
                            </div>
                            <div class="it-group-versions" id="versoes-${codigoEscapado.replace(/[^a-zA-Z0-9]/g, '_')}" style="display: block;">
                                ${versoes.map((it, index) => {
                                    const dataUpload = new Date(it.created_at).toLocaleDateString('pt-BR');
                                    const horaUpload = new Date(it.created_at).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                                    const isAtual = it.versao_atual === true;
                                    const urlEscapada = escapeHtml(it.url || '');
                                    const nomeArquivoEscapado = escapeHtml(it.nome_arquivo || '');
                                    const idEscapado = escapeHtml(it.id || '');
                                    const caminhoEscapado = escapeJs(it.caminho_storage || '');
                                    const codigoEscapadoJs = escapeJs(codigoEscapado);
                                    const uploadedByEscapado = escapeHtml(it.uploaded_by_nome || 'Usu√°rio');
                                    const nomeEscapado = highlightSearch(it.nome || '', termoBusca);
                                    const versaoEscapada = escapeHtml(it.versao || '');
                    
                    return `
                                        <div class="it-version-item ${isAtual ? 'versao-atual' : ''} fade-in">
                                            <div class="it-version-info">
                                                <div class="it-version-nome">
                                                    <i class="fas fa-file-${getFileIcon(it.tipo_arquivo)} me-2"></i>
                                                    ${nomeEscapado}
                                                    ${isAtual ? '<span class="status-badge atual ms-2"><i class="fas fa-star me-1"></i>Atual</span>' : '<span class="status-badge antiga ms-2">Vers√£o Anterior</span>'}
                                                    ${versaoEscapada ? `<span class="badge bg-info ms-2">v${versaoEscapada}</span>` : ''}
                                </div>
                                                <div class="it-version-meta">
                                                    <span><i class="fas fa-user me-1"></i> ${uploadedByEscapado}</span>
                                    <span><i class="fas fa-calendar me-1"></i> ${dataUpload} √†s ${horaUpload}</span>
                                                    <span><i class="fas fa-weight me-1"></i> ${formatFileSize(it.tamanho)}</span>
                                </div>
                            </div>
                                            <div class="it-actions">
                                                <button class="btn-icon btn-view tooltip-custom" data-tooltip="Visualizar" data-url="${urlEscapada}" data-nome="${nomeArquivoEscapado}" data-tipo="${escapeJs(it.tipo_arquivo || '')}">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <a href="${urlEscapada}" download="${nomeArquivoEscapado}" class="btn-icon btn-download tooltip-custom" data-tooltip="Download">
                                    <i class="fas fa-download"></i>
                                </a>
                                                ${podeExcluir ? `
                                                <button class="btn-icon btn-delete tooltip-custom" data-tooltip="Excluir" data-it-id="${idEscapado}" data-caminho="${caminhoEscapado}" data-codigo="${codigoEscapadoJs}">
                                    <i class="fas fa-trash"></i>
                                </button>
                                                ` : ''}
                            </div>
                        </div>
                    `;
                                }).join('')}
                            </div>
                        </div>
                    `;
                });
                
                // Renderizar ITs sem c√≥digo (n√£o agrupadas) - podem usar grid ou lista
                if (itsSemCodigo.length > 0) {
                    // Se for grid e n√£o h√° grupos, aplicar grid ao container
                    if (currentView === 'grid' && itsPorCodigo.size === 0) {
                        container.className = 'its-grid';
                    }
                    
                    itsSemCodigo.forEach(it => {
                        const areaNome = AREAS.find(a => a.id === it.area)?.nome || it.area;
                        const dataUpload = new Date(it.created_at).toLocaleDateString('pt-BR');
                        const horaUpload = new Date(it.created_at).toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                        const urlEscapada = escapeHtml(it.url || '');
                        const nomeArquivoEscapado = escapeHtml(it.nome_arquivo || '');
                        const idEscapado = escapeHtml(it.id || '');
                        const caminhoEscapado = escapeJs(it.caminho_storage || '');
                        const uploadedByEscapado = escapeHtml(it.uploaded_by_nome || 'Usu√°rio');
                        const nomeEscapado = highlightSearch(it.nome || '', termoBusca);
                        const versaoEscapada = escapeHtml(it.versao || '');
                        const areaNomeHighlight = highlightSearch(areaNome, termoBusca);
                        const isAtual = it.versao_atual === true;
                        
                        // Usar card melhorado
                        html += `
                            <div class="it-card-enhanced ${isAtual ? 'versao-atual' : ''} fade-in">
                                <div class="it-info">
                                    <div class="d-flex justify-content-between align-items-start mb-2">
                                        <div class="flex-grow-1">
                                            <div class="it-nome">
                                                <i class="fas fa-file-${getFileIcon(it.tipo_arquivo)} me-2" style="color: var(--primary);"></i>
                                                ${nomeEscapado}
                                                ${versaoEscapada ? `<span class="badge bg-info ms-2">v${versaoEscapada}</span>` : ''}
                                            </div>
                                            <div class="it-meta mt-2">
                                                <span class="badge-area">
                                                    <i class="fas fa-building me-1"></i> ${areaNomeHighlight}
                                                </span>
                                                <span><i class="fas fa-user me-1"></i> ${uploadedByEscapado}</span>
                                                <span><i class="fas fa-calendar me-1"></i> ${dataUpload} √†s ${horaUpload}</span>
                                                <span><i class="fas fa-weight me-1"></i> ${formatFileSize(it.tamanho)}</span>
                                            </div>
                                        </div>
                                        ${isAtual ? '<span class="status-badge atual"><i class="fas fa-check-circle me-1"></i>Atual</span>' : ''}
                                    </div>
                                </div>
                                <div class="it-actions mt-3">
                                    <button class="btn-icon btn-view tooltip-custom" data-tooltip="Visualizar" data-url="${urlEscapada}" data-nome="${nomeArquivoEscapado}" data-tipo="${escapeJs(it.tipo_arquivo || '')}">
                                        <i class="fas fa-eye"></i>
                                    </button>
                                    <a href="${urlEscapada}" download="${nomeArquivoEscapado}" class="btn-icon btn-download tooltip-custom" data-tooltip="Download">
                                        <i class="fas fa-download"></i>
                                    </a>
                                    ${podeExcluir ? `
                                    <button class="btn-icon btn-delete tooltip-custom" data-tooltip="Excluir" data-it-id="${idEscapado}" data-caminho="${caminhoEscapado}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                    ` : ''}
                                </div>
                            </div>
                        `;
                    });
                }
                
                container.innerHTML = html;
                
                // ‚úÖ Configurar event listeners ap√≥s inserir HTML (event delegation)
                container.addEventListener('click', (e) => {
                    // Toggle de vers√µes
                    const header = e.target.closest('.it-group-header');
                    if (header && header.dataset.codigo) {
                        const codigo = header.dataset.codigo;
                        toggleVersoes(codigo);
                        return;
                    }
                    
                    // Bot√£o de visualizar (preview)
                    const viewBtn = e.target.closest('.btn-view');
                    if (viewBtn && viewBtn.dataset.url) {
                        e.preventDefault();
                        const url = viewBtn.dataset.url;
                        const nome = viewBtn.dataset.nome || 'Documento';
                        const tipo = viewBtn.dataset.tipo || '';
                        abrirPreview(url, nome, tipo);
                        return;
                    }
                    
                    // Bot√£o de excluir
                    const deleteBtn = e.target.closest('.btn-delete');
                    if (deleteBtn && deleteBtn.dataset.itId) {
                        e.preventDefault();
                        const id = deleteBtn.dataset.itId;
                        const caminho = deleteBtn.dataset.caminho || '';
                        const codigo = deleteBtn.dataset.codigo || null;
                        excluirIT(id, caminho, codigo);
                        return;
                    }
                });
            } catch (error) {
                console.error('Erro ao carregar ITs:', error);
                container.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Erro ao carregar ITs. ${error.message || 'Tente novamente.'}
                    </div>
                `;
            }
        }
        
        function getFileIcon(tipoArquivo) {
            if (tipoArquivo && tipoArquivo.includes('pdf')) return 'pdf';
            if (tipoArquivo && tipoArquivo.includes('image')) return 'image';
            if (tipoArquivo && (tipoArquivo.includes('word') || tipoArquivo.includes('document'))) return 'word';
            return 'alt';
        }
        
        function toggleVersoes(codigo) {
            // Buscar pelo data attribute ao inv√©s de onclick
            const header = document.querySelector(`.it-group-header[data-codigo="${codigo}"]`);
            const versoesId = `versoes-${codigo.replace(/[^a-zA-Z0-9]/g, '_')}`;
            const versoes = document.getElementById(versoesId);
            
            if (header && versoes) {
                header.classList.toggle('expanded');
                versoes.style.display = header.classList.contains('expanded') ? 'block' : 'none';
                
                // Atualizar √≠cone de seta
                const toggleIcon = header.querySelector('.it-group-toggle i');
                if (toggleIcon) {
                    toggleIcon.style.transform = header.classList.contains('expanded') ? 'rotate(180deg)' : 'rotate(0deg)';
                }
            }
        }
        
        async function excluirIT(id, caminhoStorage, codigo = null) {
            // ‚úÖ Valida√ß√£o de par√¢metros
            if (!id) {
                console.error('‚ùå ID da IT n√£o fornecido');
                alert('‚ùå Erro: ID da IT n√£o fornecido.');
                return;
            }
            
            // ‚úÖ Verificar permiss√£o de exclus√£o
            if (!permissoesITs.excluir && !isAdmin) {
                alert('‚ùå Voc√™ n√£o tem permiss√£o para excluir ITs. Entre em contato com o administrador.');
                return;
            }
            
            // ‚úÖ Verificar se √© admin (verifica√ß√£o robusta e redundante)
            let userIsAdmin = (typeof isAdmin !== 'undefined' && isAdmin === true) || false;
            
            // Se ainda n√£o tem certeza, verificar novamente no banco
            if (!userIsAdmin && supabaseClient && currentUser) {
                try {
                    const userId = currentUser?.id || currentUser?.usuario || currentUser?.userData?.id;
                    if (userId) {
                        console.log('üîç Re-verificando admin no banco antes de excluir...');
                        const { data: profile, error } = await supabaseClient
                            .from('user_profiles')
                            .select('role')
                            .eq('id', userId)
                            .maybeSingle();
                        
                        if (!error && profile && profile.role === 'admin') {
                            userIsAdmin = true;
                            isAdmin = true; // Atualizar a vari√°vel global tamb√©m
                            console.log('‚úÖ Admin confirmado no banco antes de excluir');
                        }
                    }
                } catch (error) {
                    console.warn('‚ö†Ô∏è Erro ao re-verificar admin:', error);
                }
            }
            
            if (!userIsAdmin) {
                alert('‚ùå Apenas administradores podem excluir ITs.');
                console.warn('‚ùå Tentativa de exclus√£o negada - usu√°rio n√£o √© admin. isAdmin:', isAdmin);
                return;
            }
            
            const mensagem = codigo 
                ? `Tem certeza que deseja excluir esta vers√£o da IT ${escapeHtml(codigo)}?`
                : 'Tem certeza que deseja excluir esta IT?';
            
            if (!confirm(mensagem)) {
                return;
            }
            
            try {
                // Remover arquivo do storage (se caminho fornecido)
                if (caminhoStorage) {
                    try {
                        const { error: storageError } = await supabaseClient.storage
                            .from('anexos')
                            .remove([caminhoStorage]);
                        
                        if (storageError) {
                            console.warn('‚ö†Ô∏è Aviso: Erro ao remover arquivo do storage:', storageError);
                            // N√£o bloquear a exclus√£o se o arquivo n√£o existir no storage
                        } else {
                            console.log('‚úÖ Arquivo removido do storage:', caminhoStorage);
                        }
                    } catch (storageErr) {
                        console.warn('‚ö†Ô∏è Erro ao remover arquivo do storage:', storageErr);
                        // Continuar mesmo se falhar (o arquivo pode j√° ter sido removido)
                    }
                }
                
                // Remover registro da tabela
                const { error } = await supabaseClient
                    .from('its_documentos')
                    .delete()
                    .eq('id', id);
                
                if (error) {
                    throw error;
                }
                
                console.log('‚úÖ IT exclu√≠da com sucesso:', id);
                alert('‚úÖ IT exclu√≠da com sucesso!');
                await carregarITs();
            } catch (error) {
                console.error('‚ùå Erro ao excluir IT:', error);
                if (error.code === '42501') {
                    alert('‚ùå Voc√™ n√£o tem permiss√£o para excluir ITs. Apenas administradores podem excluir.');
                } else {
                    alert('‚ùå Erro ao excluir IT: ' + (error.message || 'Tente novamente.'));
                }
            }
        }
        
        // Inicializar quando a p√°gina carregar
        document.addEventListener('DOMContentLoaded', inicializar);
    </script>
<!-- Chat IA -->
<link rel="stylesheet" href="../css/chat-ia.css">
<script src="../js/chat-ia.js"></script>
</body>
</html>
