<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Termo de Rastreamento - Sistema Multimodal</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .container {
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            padding: 2.5rem;
            animation: slideUp 0.5s ease-out;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .header h1 {
            color: #1f2937;
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header .icon {
            font-size: 3rem;
            color: #667eea;
            margin-bottom: 1rem;
        }

        .coleta-info {
            background: #f9fafb;
            padding: 1.5rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            border-left: 4px solid #667eea;
        }

        .coleta-info h3 {
            color: #1f2937;
            margin-bottom: 1rem;
            font-size: 1.25rem;
        }

        .coleta-info p {
            color: #6b7280;
            margin: 0.5rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .coleta-info i {
            color: #667eea;
            width: 20px;
        }

        .termo-content {
            background: #f9fafb;
            padding: 2rem;
            border-radius: 12px;
            margin-bottom: 2rem;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
        }

        .termo-content h2 {
            color: #1f2937;
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .termo-content p {
            color: #4b5563;
            line-height: 1.8;
            margin-bottom: 1rem;
        }

        .termo-content ul {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .termo-content li {
            color: #4b5563;
            line-height: 1.8;
            margin-bottom: 0.5rem;
        }

        .checkbox-container {
            display: flex;
            align-items: flex-start;
            gap: 1rem;
            padding: 1.5rem;
            background: #fef3c7;
            border-radius: 12px;
            margin-bottom: 2rem;
            border: 2px solid #fbbf24;
        }

        .checkbox-container input[type="checkbox"] {
            width: 24px;
            height: 24px;
            margin-top: 2px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .checkbox-container label {
            color: #78350f;
            font-weight: 600;
            cursor: pointer;
            flex: 1;
            line-height: 1.6;
        }

        .buttons {
            display: flex;
            gap: 1rem;
            justify-content: center;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #e5e7eb;
            color: #4b5563;
        }

        .btn-secondary:hover {
            background: #d1d5db;
        }

        .loading {
            text-align: center;
            padding: 2rem;
        }

        .loading i {
            font-size: 3rem;
            color: #667eea;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .error {
            background: #fee2e2;
            color: #991b1b;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #dc2626;
        }

        .success {
            background: #d1fae5;
            color: #065f46;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid #10b981;
        }

        @media (max-width: 768px) {
            .container {
                padding: 1.5rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loadingState" class="loading">
            <i class="fas fa-spinner"></i>
            <p style="margin-top: 1rem; color: #6b7280;">Carregando informa√ß√µes...</p>
        </div>

        <div id="mainContent" style="display: none;">
            <div class="header">
                <div class="icon">
                    <i class="fas fa-shield-alt"></i>
                </div>
                <h1>Termo de Rastreamento</h1>
                <p style="color: #6b7280;">Termo Profissional de Monitoramento e Rastreamento</p>
            </div>

            <div id="coletaInfo" class="coleta-info" style="display: none;">
                <h3><i class="fas fa-truck"></i> Informa√ß√µes da Coleta</h3>
                <p id="coletaNumero"></p>
                <p id="coletaCliente"></p>
                <p id="coletaRota"></p>
            </div>

            <div id="errorMessage" class="error" style="display: none;"></div>
            <div id="successMessage" class="success" style="display: none;"></div>

            <div class="termo-content">
                <h2>Termo de Consentimento para Rastreamento GPS</h2>
                
                <p><strong>Data:</strong> <span id="termoData"></span></p>
                
                <p>
                    Eu, <strong id="motoristaNome">[Nome do Motorista]</strong>, portador da CNH 
                    <strong id="motoristaCNH">[N√∫mero da CNH]</strong>, declaro estar ciente e 
                    de acordo com os termos e condi√ß√µes abaixo estabelecidos:
                </p>

                <h3 style="margin-top: 1.5rem; margin-bottom: 1rem; color: #1f2937;">1. Objetivo do Rastreamento</h3>
                <p>
                    O rastreamento GPS tem como objetivo garantir a seguran√ßa da carga, otimizar 
                    a log√≠stica de entrega, monitorar o trajeto em tempo real e fornecer 
                    informa√ß√µes precisas sobre a localiza√ß√£o do ve√≠culo durante a execu√ß√£o do 
                    servi√ßo de transporte.
                </p>

                <h3 style="margin-top: 1.5rem; margin-bottom: 1rem; color: #1f2937;">2. Dados Coletados</h3>
                <p>Durante o rastreamento, ser√£o coletados os seguintes dados:</p>
                <ul>
                    <li>Localiza√ß√£o geogr√°fica em tempo real (coordenadas GPS)</li>
                    <li>Velocidade do ve√≠culo</li>
                    <li>Hor√°rios de partida e chegada</li>
                    <li>Trajeto percorrido</li>
                    <li>Paradas realizadas durante o trajeto</li>
                </ul>

                <h3 style="margin-top: 1.5rem; margin-bottom: 1rem; color: #1f2937;">3. Finalidade do Uso</h3>
                <p>
                    Os dados coletados ser√£o utilizados exclusivamente para:
                </p>
                <ul>
                    <li>Monitoramento da seguran√ßa da carga</li>
                    <li>Otimiza√ß√£o de rotas e prazos de entrega</li>
                    <li>Comunica√ß√£o com o cliente sobre o status da entrega</li>
                    <li>An√°lise de desempenho operacional</li>
                    <li>Cumprimento de obriga√ß√µes contratuais</li>
                </ul>

                <h3 style="margin-top: 1.5rem; margin-bottom: 1rem; color: #1f2937;">4. Confidencialidade</h3>
                <p>
                    A empresa compromete-se a manter a confidencialidade dos dados coletados, 
                    utilizando-os apenas para as finalidades descritas neste termo, em 
                    conformidade com a Lei Geral de Prote√ß√£o de Dados (LGPD).
                </p>

                <h3 style="margin-top: 1.5rem; margin-bottom: 1rem; color: #1f2937;">5. Per√≠odo de Vig√™ncia</h3>
                <p>
                    O rastreamento ser√° ativado durante toda a execu√ß√£o do servi√ßo de transporte 
                    da coleta designada, sendo desativado automaticamente ap√≥s a conclus√£o da 
                    entrega e confirma√ß√£o do recebimento.
                </p>

                <h3 style="margin-top: 1.5rem; margin-bottom: 1rem; color: #1f2937;">6. Direitos do Motorista</h3>
                <p>
                    O motorista tem direito a:
                </p>
                <ul>
                    <li>Ser informado sobre o rastreamento antes do in√≠cio do servi√ßo</li>
                    <li>Solicitar informa√ß√µes sobre os dados coletados</li>
                    <li>Ter acesso aos dados de rastreamento relacionados √† sua viagem</li>
                </ul>

                <h3 style="margin-top: 1.5rem; margin-bottom: 1rem; color: #1f2937;">7. Aceita√ß√£o</h3>
                <p>
                    Ao aceitar este termo, declaro que li, compreendi e concordo com todas as 
                    condi√ß√µes estabelecidas acima, autorizando o rastreamento GPS durante a 
                    execu√ß√£o do servi√ßo de transporte.
                </p>
            </div>

            <div class="checkbox-container">
                <input type="checkbox" id="aceitarTermo" required>
                <label for="aceitarTermo">
                    Li e compreendi todos os termos acima. Concordo e autorizo o rastreamento 
                    GPS durante a execu√ß√£o deste servi√ßo de transporte.
                </label>
            </div>

            <div class="buttons">
                <button class="btn btn-primary" id="btnAceitar" onclick="aceitarTermo()" disabled>
                    <i class="fas fa-check-circle"></i>
                    Aceitar e Iniciar Rastreamento
                </button>
                <button class="btn btn-secondary" onclick="recusarTermo()">
                    <i class="fas fa-times"></i>
                    Recusar
                </button>
            </div>

            <!-- Status do Rastreamento (aparece ap√≥s aceitar o termo) -->
            <div id="statusRastreamentoContainer" style="display: none; margin-top: 2rem; padding: 1.5rem; background: #f0fdf4; border-radius: 12px; border-left: 4px solid #10b981;">
                <h3 style="color: #065f46; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                    <i class="fas fa-map-marker-alt"></i>
                    Status do Rastreamento
                </h3>
                <div id="statusRastreamentoTexto" style="color: #047857; margin-bottom: 0.5rem;">
                    <i class="fas fa-spinner fa-spin"></i> Iniciando rastreamento GPS...
                </div>
                <div id="statusRastreamentoDetalhes" style="color: #6b7280; font-size: 0.9rem; margin-top: 0.5rem;">
                    Aguardando primeira localiza√ß√£o...
                </div>
            </div>
        </div>
    </div>

    <script>
        let supabaseClient = null;
        let coletaId = null;
        let coletaData = null;
        let motoristaData = null;
        let rastreamentoAtivo = false;
        let watchId = null;
        let intervaloRastreamento = null;
        let contadorPosicoesEnviadas = 0;

        // Inicializar Supabase
        async function inicializarSupabase() {
            try {
                const response = await fetch('/api/supabase-config');
                if (!response.ok) throw new Error('Erro ao buscar configura√ß√µes');
                
                const config = await response.json();
                supabaseClient = window.supabase.createClient(config.supabaseUrl, config.supabaseAnonKey);
                return true;
            } catch (error) {
                console.error('Erro ao inicializar Supabase:', error);
                return false;
            }
        }

        // Obter par√¢metros da URL
        function obterParametrosURL() {
            const urlParams = new URLSearchParams(window.location.search);
            coletaId = urlParams.get('coleta');
            return coletaId;
        }

        // Carregar dados da coleta
        async function carregarDadosColeta() {
            if (!coletaId) {
                mostrarErro('ID da coleta n√£o fornecido na URL.');
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                return;
            }

            try {
                // Tentar buscar via API p√∫blica primeiro
                console.log('üîç Tentando buscar coleta via API p√∫blica:', coletaId);
                const apiResponse = await fetch(`/api/coletas/public/${coletaId}`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                console.log('üì° Resposta da API p√∫blica:', apiResponse.status, apiResponse.statusText);
                
                if (apiResponse.ok) {
                    const apiData = await apiResponse.json();
                    console.log('‚úÖ Dados recebidos da API:', apiData);
                    
                    if (apiData.success && apiData.coleta) {
                        coletaData = apiData.coleta;
                        motoristaData = apiData.motorista || null;
                        preencherInformacoes();
                        
                        // Tentar verificar se termo j√° foi aceito (opcional, n√£o bloqueia)
                        verificarTermoAceito().then(termoJaAceito => {
                            if (termoJaAceito) {
                                // Se termo j√° aceito, iniciar rastreamento automaticamente
                                console.log('‚úÖ Termo j√° aceito, iniciando rastreamento automaticamente');
                            }
                        }).catch(err => {
                            console.warn('N√£o foi poss√≠vel verificar termo:', err);
                        });
                        return;
                    } else {
                        console.warn('‚ö†Ô∏è API retornou OK mas sem dados v√°lidos:', apiData);
                    }
                } else {
                    const errorData = await apiResponse.json().catch(() => ({ error: 'Erro desconhecido' }));
                    console.error(`‚ùå API p√∫blica retornou ${apiResponse.status}:`, errorData);
                    
                    // Se for 404, tentar continuar mesmo sem dados completos
                    if (apiResponse.status === 404) {
                        console.warn('‚ö†Ô∏è Coleta n√£o encontrada na API p√∫blica, tentando continuar...');
                    }
                }
                
                // Se API falhar, tentar Supabase diretamente (pode falhar por RLS, mas tentamos)
                if (supabaseClient) {
                    try {
                        const { data, error } = await supabaseClient
                            .from('coletas')
                            .select('id, numero_coleta, cliente, origem, destino, motorista_id')
                            .eq('id', coletaId)
                            .single();

                        if (!error && data) {
                            coletaData = data;
                            
                            // Tentar buscar motorista se houver motorista_id
                            if (data.motorista_id) {
                                try {
                                    const { data: motorista, error: motoristaError } = await supabaseClient
                                        .from('motoristas')
                                        .select('id, nome, cnh')
                                        .eq('id', data.motorista_id)
                                        .single();
                                    
                                    if (!motoristaError && motorista) {
                                        motoristaData = motorista;
                                    }
                                } catch (motoristaErr) {
                                    console.warn('N√£o foi poss√≠vel buscar motorista:', motoristaErr);
                                }
                            }
                            
                            preencherInformacoes();
                            return;
                        } else if (error) {
                            console.warn('‚ö†Ô∏è Erro ao buscar coleta via Supabase (pode ser RLS):', error.message);
                        }
                    } catch (supabaseErr) {
                        console.warn('‚ö†Ô∏è Erro ao tentar buscar via Supabase:', supabaseErr.message);
                    }
                }
                
                // Se tudo falhar, mostrar conte√∫do mesmo sem dados completos
                console.warn('N√£o foi poss√≠vel carregar dados completos da coleta, mas continuando...');
                coletaData = { id: coletaId, numero_coleta: coletaId };
                preencherInformacoes();
                
            } catch (error) {
                console.error('Erro ao carregar coleta:', error);
                // Mesmo com erro, mostrar a p√°gina para o usu√°rio poder aceitar o termo
                coletaData = { id: coletaId, numero_coleta: coletaId };
                preencherInformacoes();
                mostrarErro('Alguns dados n√£o puderam ser carregados, mas voc√™ pode continuar.');
            }
        }

        // Verificar se termo j√° foi aceito
        async function verificarTermoAceito() {
            if (!motoristaData || !coletaId) return false;

            try {
                // Tentar obter token de autentica√ß√£o do motorista
                let authToken = null;
                try {
                    if (supabaseClient) {
                        const { data: { session } } = await supabaseClient.auth.getSession();
                        if (session?.access_token) {
                            authToken = session.access_token;
                        }
                    }
                } catch (authError) {
                    console.warn('N√£o foi poss√≠vel obter token de autentica√ß√£o:', authError);
                }

                const headers = {
                    'Content-Type': 'application/json'
                };
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                const response = await fetch(`/api/rastreamento/verificar-termo?coletaId=${coletaId}`, {
                    method: 'GET',
                    credentials: 'include',
                    headers: headers
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.termoAceito) {
                        // Termo j√° aceito, iniciar rastreamento diretamente
                        const tokenExistente = localStorage.getItem(`rastreamento_token_${coletaId}`);
                        mostrarSucesso('‚úÖ Termo j√° aceito anteriormente. Monitoramento reiniciado.');
                        
                        // Ocultar bot√µes e mostrar status
                        document.getElementById('btnAceitar').style.display = 'none';
                        const btnRecusar = document.querySelector('.btn-secondary');
                        if (btnRecusar) btnRecusar.style.display = 'none';
                        document.getElementById('aceitarTermo').disabled = true;
                        
                        // Mostrar se√ß√£o de status do rastreamento
                        const statusContainer = document.getElementById('statusRastreamentoContainer');
                        if (statusContainer) statusContainer.style.display = 'block';
                        
                        // Iniciar rastreamento GPS diretamente
                        iniciarRastreamentoGPS(coletaId, tokenExistente);
                        return true;
                    }
                }
            } catch (error) {
                console.warn('Erro ao verificar termo:', error);
            }
            return false;
        }

        // Preencher informa√ß√µes na p√°gina
        function preencherInformacoes() {
            try {
                if (coletaData) {
                    document.getElementById('coletaNumero').innerHTML = 
                        `<i class="fas fa-hashtag"></i> <strong>Coleta:</strong> #${coletaData.numero_coleta || coletaData.id || 'N/A'}`;
                    document.getElementById('coletaCliente').innerHTML = 
                        `<i class="fas fa-building"></i> <strong>Cliente:</strong> ${coletaData.cliente || 'N/A'}`;
                    document.getElementById('coletaRota').innerHTML = 
                        `<i class="fas fa-route"></i> <strong>Rota:</strong> ${coletaData.origem || 'N/A'} ‚Üí ${coletaData.destino || 'N/A'}`;
                    document.getElementById('coletaInfo').style.display = 'block';
                } else {
                    document.getElementById('coletaInfo').style.display = 'none';
                }

                if (motoristaData) {
                    document.getElementById('motoristaNome').textContent = motoristaData.nome || '[Nome n√£o informado]';
                    document.getElementById('motoristaCNH').textContent = motoristaData.cnh || '[CNH n√£o informada]';
                } else if (coletaData && coletaData.motorista_nome) {
                    // Usar motorista_nome da coleta se dispon√≠vel
                    document.getElementById('motoristaNome').textContent = coletaData.motorista_nome;
                    document.getElementById('motoristaCNH').textContent = '[CNH n√£o informada]';
                } else {
                    document.getElementById('motoristaNome').textContent = '[Nome n√£o informado]';
                    document.getElementById('motoristaCNH').textContent = '[CNH n√£o informada]';
                }

                const dataAtual = new Date().toLocaleDateString('pt-BR');
                document.getElementById('termoData').textContent = dataAtual;

                // Mostrar conte√∫do principal
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            } catch (error) {
                console.error('Erro ao preencher informa√ß√µes:', error);
                // Mesmo com erro, mostrar a p√°gina
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
            }
        }

        // Habilitar/desabilitar bot√£o de aceitar
        document.getElementById('aceitarTermo').addEventListener('change', function() {
            document.getElementById('btnAceitar').disabled = !this.checked;
        });

        // Aceitar termo
        async function aceitarTermo() {
            if (!document.getElementById('aceitarTermo').checked) {
                mostrarErro('Voc√™ precisa aceitar o termo para continuar.');
                return;
            }

            if (!coletaId) {
                mostrarErro('ID da coleta n√£o encontrado.');
                return;
            }

            const btnAceitar = document.getElementById('btnAceitar');
            btnAceitar.disabled = true;
            btnAceitar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processando...';

            try {
                // IP ser√° obtido no servidor (req.ip) para evitar problemas de CSP
                // Tentar obter token de autentica√ß√£o (opcional - n√£o √© obrigat√≥rio para aceitar termo)
                let authToken = null;
                try {
                    if (supabaseClient) {
                        const { data: { session } } = await supabaseClient.auth.getSession();
                        if (session?.access_token) {
                            authToken = session.access_token;
                        }
                    }
                } catch (authError) {
                    console.warn('N√£o foi poss√≠vel obter token de autentica√ß√£o:', authError);
                }

                const headers = {
                    'Content-Type': 'application/json'
                };
                if (authToken) {
                    headers['Authorization'] = `Bearer ${authToken}`;
                }

                // Capturar o conte√∫do completo do termo
                const termoContent = document.querySelector('.termo-content');
                const conteudoTermo = termoContent ? termoContent.innerText || termoContent.textContent : '';
                
                // Capturar informa√ß√µes do motorista do termo
                const motoristaNomeTermo = document.getElementById('motoristaNome')?.textContent || '';
                const motoristaCNHTermo = document.getElementById('motoristaCNH')?.textContent || '';
                const termoData = document.getElementById('termoData')?.textContent || new Date().toLocaleDateString('pt-BR');
                
                // Enviar aceite do termo (n√£o requer autentica√ß√£o se tiver motorista_id na coleta)
                const response = await fetch('/api/rastreamento/aceitar-termo', {
                    method: 'POST',
                    headers: headers,
                    credentials: 'include',
                    body: JSON.stringify({
                        coletaId: coletaId,
                        termoVersao: '1.0',
                        userAgent: navigator.userAgent,
                        conteudoTermo: conteudoTermo,
                        motoristaNome: motoristaNomeTermo,
                        motoristaCNH: motoristaCNHTermo,
                        termoData: termoData
                        // IP ser√° obtido no servidor
                    })
                });

                console.log('üì° Resposta do servidor:', response.status, response.statusText);
                const result = await response.json();
                console.log('üì¶ Dados da resposta:', result);

                if (response.ok && result.success) {
                    console.log('‚úÖ Termo aceito com sucesso! Iniciando rastreamento...');
                    
                    // Armazenar token de rastreamento se fornecido
                    if (result.tokenRastreamento) {
                        localStorage.setItem(`rastreamento_token_${coletaId}`, result.tokenRastreamento);
                        console.log('‚úÖ Token de rastreamento armazenado:', result.tokenRastreamento.substring(0, 20) + '...');
                    } else {
                        console.warn('‚ö†Ô∏è Token de rastreamento n√£o recebido na resposta');
                    }
                    
                    // Mostrar mensagem de sucesso e iniciar rastreamento diretamente
                    mostrarSucesso('‚úÖ Termo aceito com sucesso! Monitoramento iniciado.');
                    
                    // Ocultar bot√µes e mostrar status do rastreamento
                    document.getElementById('btnAceitar').style.display = 'none';
                    const btnRecusar = document.querySelector('.btn-secondary');
                    if (btnRecusar) btnRecusar.style.display = 'none';
                    document.getElementById('aceitarTermo').disabled = true;
                    
                    // Mostrar se√ß√£o de status do rastreamento
                    const statusContainer = document.getElementById('statusRastreamentoContainer');
                    if (statusContainer) {
                        statusContainer.style.display = 'block';
                    }
                    
                    // Iniciar rastreamento GPS IMEDIATAMENTE - SEM DELAY
                    console.log('üöÄ Chamando iniciarRastreamentoGPS agora...');
                    iniciarRastreamentoGPS(coletaId, result.tokenRastreamento);
                    console.log('‚úÖ iniciarRastreamentoGPS chamado');
                } else if (response.status === 409) {
                    // Tratar 409 especificamente - pode ser termo j√° aceito
                    console.log('‚ö†Ô∏è Status 409 recebido, verificando se termo j√° foi aceito');
                    if (result.message && (result.message.includes('j√° aceito') || result.message.includes('j√° foi aceito'))) {
                        // Verificar se h√° token de rastreamento
                        const tokenExistente = localStorage.getItem(`rastreamento_token_${coletaId}`);
                        if (tokenExistente) {
                            mostrarSucesso('‚úÖ Termo j√° aceito. Monitoramento reiniciado.');
                            
                            // Ocultar bot√µes e mostrar status
                            document.getElementById('btnAceitar').style.display = 'none';
                            document.querySelector('.btn-secondary').style.display = 'none';
                            document.getElementById('aceitarTermo').disabled = true;
                            
                            // Mostrar se√ß√£o de status do rastreamento
                            const statusContainer = document.getElementById('statusRastreamentoContainer');
                            statusContainer.style.display = 'block';
                            
                            // Iniciar rastreamento GPS diretamente
                            iniciarRastreamentoGPS(coletaId, tokenExistente);
                            return;
                        } else {
                            // Se n√£o h√° token, tentar obter um novo
                            mostrarSucesso('Termo j√° aceito. Iniciando monitoramento...');
                            iniciarRastreamentoGPS(coletaId, null);
                            return;
                        }
                    } else {
                        // Outro tipo de conflito
                        throw new Error(result.error || 'Conflito ao aceitar termo. Tente novamente.');
                    }
                } else {
                    // Tratar diferentes tipos de erro
                    let errorMessage = result.error || 'Erro ao aceitar termo';
                    
                    if (response.status === 401) {
                        errorMessage = 'Voc√™ precisa estar autenticado como motorista para aceitar o termo. Por favor, fa√ßa login no portal do motorista primeiro.';
                    } else if (response.status === 404) {
                        errorMessage = result.error || 'Coleta ou motorista n√£o encontrado. Verifique se o link est√° correto.';
                    } else if (response.status === 409) {
                        // 409 pode ser termo j√° aceito ou outro conflito
                        if (result.message && result.message.includes('j√° aceito')) {
                            // Se o termo j√° foi aceito, iniciar rastreamento diretamente
                            const tokenExistente = localStorage.getItem(`rastreamento_token_${coletaId}`);
                            mostrarSucesso('‚úÖ Termo j√° aceito. Monitoramento reiniciado.');
                            
                            // Ocultar bot√µes e mostrar status
                            document.getElementById('btnAceitar').style.display = 'none';
                            document.querySelector('.btn-secondary').style.display = 'none';
                            document.getElementById('aceitarTermo').disabled = true;
                            
                            // Mostrar se√ß√£o de status do rastreamento
                            const statusContainer = document.getElementById('statusRastreamentoContainer');
                            statusContainer.style.display = 'block';
                            
                            // Iniciar rastreamento GPS diretamente
                            iniciarRastreamentoGPS(coletaId, tokenExistente);
                            return;
                        } else {
                            errorMessage = result.error || 'N√£o foi poss√≠vel aceitar o termo. Verifique se voc√™ √© o motorista designado para esta coleta.';
                        }
                    } else if (response.status === 400) {
                        errorMessage = result.error || 'Dados inv√°lidos. Verifique se o link est√° correto.';
                    }
                    
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error('Erro ao aceitar termo:', error);
                mostrarErro('Erro ao processar aceite do termo: ' + (error.message || 'Tente novamente.'));
                btnAceitar.disabled = false;
                btnAceitar.innerHTML = '<i class="fas fa-check-circle"></i> Aceitar e Iniciar Rastreamento';
            }
        }

        // Recusar termo
        function recusarTermo() {
            if (confirm('Tem certeza que deseja recusar o termo? Voc√™ n√£o poder√° iniciar o rastreamento sem aceitar.')) {
                mostrarErro('Voc√™ precisa aceitar o termo para iniciar o rastreamento.');
            }
        }

        // Fun√ß√£o para iniciar rastreamento GPS diretamente na p√°gina do termo
        // Contador de tentativas de reaceitar termo (para evitar loop infinito)
        let tentativasReaceitarTermo = 0;
        const MAX_TENTATIVAS_REACEITAR = 2;
        let wakeLock = null; // Para manter dispositivo acordado
        let serviceWorkerRegistration = null;
        
        // IndexedDB para armazenar posi√ß√µes GPS
        const DB_NAME = 'rastreamento-db';
        const DB_VERSION = 1;
        const STORE_NAME = 'posicoes-pendentes';
        let db = null;

        // Inicializar IndexedDB na p√°gina
        async function abrirDB() {
            if (db) return db;
            
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    let store;
                    if (!db.objectStoreNames.contains(STORE_NAME)) {
                        store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                        store.createIndex('timestamp', 'timestamp', { unique: false });
                        store.createIndex('coletaId', 'coletaId', { unique: false });
                    } else {
                        // Se o store j√° existe, verificar se o √≠ndice coletaId existe
                        const transaction = event.target.transaction;
                        store = transaction.objectStore(STORE_NAME);
                        if (!store.indexNames.contains('coletaId')) {
                            store.createIndex('coletaId', 'coletaId', { unique: false });
                        }
                    }
                };
            });
        }

        // Salvar posi√ß√£o no IndexedDB
        async function salvarPosicaoNoIndexedDB(position, coletaId, tokenRastreamento) {
            try {
                if (!db) {
                    await abrirDB();
                }
                
                const { latitude, longitude, accuracy } = position.coords;
                
                const dadosPosicao = {
                    coletaId: coletaId,
                    latitude: parseFloat(latitude.toFixed(6)),
                    longitude: parseFloat(longitude.toFixed(6)),
                    precisao: accuracy ? parseFloat(accuracy.toFixed(2)) : null,
                    velocidade: position.coords.speed ? parseFloat((position.coords.speed * 3.6).toFixed(2)) : null,
                    direcao: position.coords.heading ? parseFloat(position.coords.heading.toFixed(2)) : null,
                    tokenRastreamento: tokenRastreamento,
                    timestamp: new Date().toISOString(),
                    tentativas: 0
                };
                
                const transaction = db.transaction([STORE_NAME], 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                
                await new Promise((resolve, reject) => {
                    const request = store.add(dadosPosicao);
                    request.onsuccess = () => {
                        console.log('üíæ Posi√ß√£o salva no IndexedDB');
                        resolve();
                    };
                    request.onerror = () => reject(request.error);
                });
                
                // Notificar Service Worker que h√° nova posi√ß√£o
                if (serviceWorkerRegistration && serviceWorkerRegistration.active) {
                    serviceWorkerRegistration.active.postMessage({
                        type: 'NOVA_POSICAO_INDEXEDDB',
                        coletaId: coletaId
                    });
                }
            } catch (error) {
                console.error('‚ùå Erro ao salvar posi√ß√£o no IndexedDB:', error);
            }
        }

        // Registrar Service Worker para rastreamento em background
        async function registrarServiceWorker() {
            if ('serviceWorker' in navigator) {
                try {
                    const registration = await navigator.serviceWorker.register('/sw-rastreamento.js');
                    serviceWorkerRegistration = registration;
                    console.log('‚úÖ Service Worker registrado:', registration.scope);
                    
                    // Escutar mensagens do Service Worker
                    navigator.serviceWorker.addEventListener('message', (event) => {
                        console.log('[Cliente] Mensagem do SW:', event.data);
                        
                        if (event.data.type === 'OBTER_POSICAO_GPS') {
                            // Service Worker pediu posi√ß√£o GPS
                            obterPosicaoParaServiceWorker(event.data.coletaId);
                        }
                    });
                    
                    return registration;
                } catch (error) {
                    console.error('‚ùå Erro ao registrar Service Worker:', error);
                    return null;
                }
            }
            return null;
        }

        // Obter posi√ß√£o GPS para enviar ao Service Worker
        function obterPosicaoParaServiceWorker(coletaId) {
            if (!navigator.geolocation) return;
            
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    // Enviar posi√ß√£o para o Service Worker
                    if (serviceWorkerRegistration && serviceWorkerRegistration.active) {
                        serviceWorkerRegistration.active.postMessage({
                            type: 'POSICAO_GPS',
                            position: position,
                            coletaId: coletaId
                        });
                    }
                },
                (error) => {
                    console.error('[Cliente] Erro ao obter posi√ß√£o para SW:', error);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 60000
                }
            );
        }

        // Solicitar Wake Lock para manter dispositivo acordado
        async function solicitarWakeLock() {
            if ('wakeLock' in navigator) {
                try {
                    wakeLock = await navigator.wakeLock.request('screen');
                    console.log('‚úÖ Wake Lock ativado - dispositivo permanecer√° acordado');
                    
                    // Escutar quando Wake Lock √© liberado
                    wakeLock.addEventListener('release', () => {
                        console.log('‚ö†Ô∏è Wake Lock liberado');
                    });
                } catch (error) {
                    console.warn('‚ö†Ô∏è N√£o foi poss√≠vel ativar Wake Lock:', error);
                }
            }
        }

        // Liberar Wake Lock
        function liberarWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
                console.log('‚úÖ Wake Lock liberado');
            }
        }

        // Detectar quando p√°gina est√° em background e continuar rastreamento
        document.addEventListener('visibilitychange', async () => {
            if (document.hidden) {
                console.log('üì± P√°gina em background - salvando √∫ltima posi√ß√£o e continuando via Service Worker');
                // Salvar √∫ltima posi√ß√£o conhecida antes de ir para background
                if (navigator.geolocation && rastreamentoAtivo && coletaId) {
                    navigator.geolocation.getCurrentPosition(
                        async (position) => {
                            const token = localStorage.getItem(`rastreamento_token_${coletaId}`);
                            if (token) {
                                await salvarPosicaoNoIndexedDB(position, coletaId, token);
                            }
                        },
                        (error) => console.warn('‚ö†Ô∏è Erro ao obter posi√ß√£o antes de background:', error),
                        { enableHighAccuracy: false, timeout: 5000, maximumAge: 60000 }
                    );
                }
            } else {
                console.log('üì± P√°gina em primeiro plano - rastreamento ativo');
            }
        });

        // Salvar √∫ltima posi√ß√£o antes de fechar a p√°gina
        window.addEventListener('pagehide', async (event) => {
            if (rastreamentoAtivo && coletaId && navigator.geolocation) {
                console.log('üíæ Salvando √∫ltima posi√ß√£o antes de fechar p√°gina...');
                // Usar getCurrentPosition com timeout curto
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const token = localStorage.getItem(`rastreamento_token_${coletaId}`);
                        if (token) {
                            await salvarPosicaoNoIndexedDB(position, coletaId, token);
                            console.log('‚úÖ √öltima posi√ß√£o salva antes de fechar');
                        }
                    },
                    (error) => console.warn('‚ö†Ô∏è Erro ao salvar √∫ltima posi√ß√£o:', error),
                    { enableHighAccuracy: false, timeout: 2000, maximumAge: 300000 }
                );
            }
        });

        // Tamb√©m usar beforeunload como fallback
        window.addEventListener('beforeunload', async () => {
            if (rastreamentoAtivo && coletaId && navigator.geolocation) {
                // Tentar obter posi√ß√£o rapidamente
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const token = localStorage.getItem(`rastreamento_token_${coletaId}`);
                        if (token) {
                            // Salvar de forma s√≠ncrona se poss√≠vel
                            try {
                                if (!db) await abrirDB();
                                const { latitude, longitude, accuracy } = position.coords;
                                const dadosPosicao = {
                                    coletaId: coletaId,
                                    latitude: parseFloat(latitude.toFixed(6)),
                                    longitude: parseFloat(longitude.toFixed(6)),
                                    precisao: accuracy ? parseFloat(accuracy.toFixed(2)) : null,
                                    velocidade: position.coords.speed ? parseFloat((position.coords.speed * 3.6).toFixed(2)) : null,
                                    direcao: position.coords.heading ? parseFloat(position.coords.heading.toFixed(2)) : null,
                                    tokenRastreamento: token,
                                    timestamp: new Date().toISOString(),
                                    tentativas: 0
                                };
                                
                                const transaction = db.transaction([STORE_NAME], 'readwrite');
                                const store = transaction.objectStore(STORE_NAME);
                                store.add(dadosPosicao);
                            } catch (error) {
                                console.warn('‚ö†Ô∏è Erro ao salvar no beforeunload:', error);
                            }
                        }
                    },
                    () => {},
                    { enableHighAccuracy: false, timeout: 1000, maximumAge: 300000 }
                );
            }
        });

        function iniciarRastreamentoGPS(coletaId, tokenRastreamento) {
            console.log('üöÄ iniciarRastreamentoGPS chamado:', { coletaId, temToken: !!tokenRastreamento });
            
            if (!coletaId) {
                console.error('‚ùå ColetaId n√£o fornecido para iniciar rastreamento');
                atualizarStatusRastreamento('‚ùå Erro: ID da coleta n√£o encontrado.', 'error');
                return;
            }

            // Obter token se n√£o foi fornecido
            if (!tokenRastreamento) {
                tokenRastreamento = localStorage.getItem(`rastreamento_token_${coletaId}`);
                console.log('üîë Token obtido do localStorage:', tokenRastreamento ? 'SIM' : 'N√ÉO');
            }

            if (!tokenRastreamento) {
                console.error('‚ùå Token de rastreamento n√£o dispon√≠vel');
                atualizarStatusRastreamento('‚ö†Ô∏è Token de rastreamento n√£o encontrado. Aguardando...', 'warning');
                // Tentar novamente ap√≥s 2 segundos
                setTimeout(() => {
                    const tokenNovo = localStorage.getItem(`rastreamento_token_${coletaId}`);
                    if (tokenNovo) {
                        console.log('‚úÖ Token encontrado, reiniciando rastreamento...');
                        iniciarRastreamentoGPS(coletaId, tokenNovo);
                    } else {
                        atualizarStatusRastreamento('‚ùå Erro: Token de rastreamento n√£o dispon√≠vel. Recarregue a p√°gina.', 'error');
                    }
                }, 2000);
                return;
            }

            console.log('‚úÖ Iniciando rastreamento GPS para coleta:', coletaId);
            rastreamentoAtivo = true;

            // Inicializar IndexedDB
            abrirDB().then(() => {
                console.log('‚úÖ IndexedDB inicializado para armazenamento de posi√ß√µes');
            }).catch(error => {
                console.error('‚ùå Erro ao inicializar IndexedDB:', error);
            });

            // Registrar Service Worker para rastreamento em background
            registrarServiceWorker().then(registration => {
                if (registration) {
                    // Iniciar rastreamento no Service Worker
                    if (registration.active) {
                        registration.active.postMessage({
                            type: 'INICIAR_RASTREAMENTO',
                            coletaId: coletaId,
                            tokenRastreamento: tokenRastreamento
                        });
                    } else {
                        // Aguardar Service Worker estar ativo
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'activated' && registration.active) {
                                    registration.active.postMessage({
                                        type: 'INICIAR_RASTREAMENTO',
                                        coletaId: coletaId,
                                        tokenRastreamento: tokenRastreamento
                                    });
                                }
                            });
                        });
                    }
                }
            });

            // Solicitar Wake Lock para manter dispositivo acordado
            solicitarWakeLock();

            // Atualizar status
            atualizarStatusRastreamento('üìç Rastreamento GPS ativo! Aguardando primeira localiza√ß√£o...', 'info');

            // Verificar se geolocaliza√ß√£o est√° dispon√≠vel
            if (!navigator.geolocation) {
                atualizarStatusRastreamento('‚ùå Seu navegador n√£o suporta geolocaliza√ß√£o.', 'error');
                mostrarErro('Seu navegador n√£o suporta geolocaliza√ß√£o.');
                return;
            }

            // Verificar permiss√£o de geolocaliza√ß√£o
            navigator.permissions?.query({ name: 'geolocation' }).then(permissionStatus => {
                if (permissionStatus.state === 'denied') {
                    atualizarStatusRastreamento('‚ùå Permiss√£o de localiza√ß√£o negada. Por favor, permita o acesso √† localiza√ß√£o nas configura√ß√µes do navegador.', 'error');
                    mostrarErro('Permiss√£o de localiza√ß√£o negada. Por favor, permita o acesso √† localiza√ß√£o nas configura√ß√µes do navegador.');
                    return;
                }
            }).catch(() => {
                // Permissions API n√£o dispon√≠vel, continuar
            });

            const options = {
                enableHighAccuracy: true,
                timeout: 60000,
                maximumAge: 120000
            };

            // Capturar posi√ß√£o inicial IMEDIATAMENTE
            console.log('üìç Solicitando posi√ß√£o inicial...');
            navigator.geolocation.getCurrentPosition(
                (position) => {
                    console.log('‚úÖ Posi√ß√£o inicial obtida:', {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    });
                    atualizarStatusRastreamento('üìç Primeira localiza√ß√£o obtida! Enviando...', 'info');
                    enviarPosicaoGPS(position, coletaId, tokenRastreamento);
                },
                (error) => {
                    console.error('‚ùå Erro ao obter posi√ß√£o inicial:', error);
                    let mensagemErro = 'Erro ao obter localiza√ß√£o.';
                    if (error.code === error.PERMISSION_DENIED) {
                        mensagemErro = 'Permiss√£o de localiza√ß√£o negada. Por favor, permita o acesso √† localiza√ß√£o nas configura√ß√µes do navegador.';
                        atualizarStatusRastreamento('‚ùå Permiss√£o de localiza√ß√£o negada.', 'error');
                    } else if (error.code === error.POSITION_UNAVAILABLE) {
                        mensagemErro = 'Localiza√ß√£o n√£o dispon√≠vel. Verifique se o GPS est√° ativo.';
                        atualizarStatusRastreamento('‚ö†Ô∏è Localiza√ß√£o n√£o dispon√≠vel. Verifique o GPS.', 'warning');
                    } else if (error.code === error.TIMEOUT) {
                        mensagemErro = 'Tempo esgotado ao obter localiza√ß√£o. Tentando novamente...';
                        atualizarStatusRastreamento('‚è≥ Aguardando localiza√ß√£o...', 'info');
                        // Tentar novamente ap√≥s 5 segundos
                        setTimeout(() => {
                            if (rastreamentoAtivo) {
                                navigator.geolocation.getCurrentPosition(
                                    (pos) => enviarPosicaoGPS(pos, coletaId, tokenRastreamento),
                                    (err) => console.error('‚ùå Erro na segunda tentativa:', err),
                                    options
                                );
                            }
                        }, 5000);
                    }
                    mostrarErro(mensagemErro);
                },
                options
            );

            // Iniciar watchPosition para monitoramento cont√≠nuo
            // watchPosition continua funcionando mesmo quando a p√°gina est√° em background
            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    console.log('üìç Nova posi√ß√£o detectada:', {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    });
                    
                    // Enviar posi√ß√£o normalmente
                    enviarPosicaoGPS(position, coletaId, tokenRastreamento);
                    
                    // Salvar no IndexedDB para garantir persist√™ncia
                    salvarPosicaoNoIndexedDB(position, coletaId, tokenRastreamento);
                    
                    // Tamb√©m enviar para Service Worker para garantir envio em background
                    if (serviceWorkerRegistration && serviceWorkerRegistration.active) {
                        serviceWorkerRegistration.active.postMessage({
                            type: 'POSICAO_GPS',
                            position: position,
                            coletaId: coletaId
                        });
                    }
                },
                (error) => {
                    console.warn('‚ö†Ô∏è Erro no watchPosition:', error);
                    if (error.code === error.PERMISSION_DENIED) {
                        atualizarStatusRastreamento('‚ùå Permiss√£o de localiza√ß√£o negada.', 'error');
                        rastreamentoAtivo = false;
                    }
                },
                {
                    ...options,
                    // Configura√ß√µes otimizadas para funcionar em background
                    enableHighAccuracy: true,
                    timeout: 60000,
                    maximumAge: 120000
                }
            );

            // Enviar posi√ß√£o periodicamente (a cada 2 minutos para garantir envio frequente)
            const INTERVALO_ENVIO_MS = 2 * 60 * 1000; // 2 minutos
            
            // Enviar primeira posi√ß√£o ap√≥s 10 segundos (para garantir que a inicial j√° foi enviada)
            setTimeout(() => {
                if (rastreamentoAtivo) {
                    console.log('üìç Enviando primeira posi√ß√£o peri√≥dica...');
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            console.log('‚úÖ Primeira posi√ß√£o peri√≥dica obtida');
                            enviarPosicaoGPS(position, coletaId, tokenRastreamento);
                        },
                        (error) => {
                            console.warn('‚ö†Ô∏è Erro ao obter primeira posi√ß√£o peri√≥dica:', error);
                        },
                        options
                    );
                }
            }, 10000);

            // Configurar envio peri√≥dico
            console.log('‚è∞ Configurando envio peri√≥dico a cada', INTERVALO_ENVIO_MS / 1000, 'segundos');
            intervaloRastreamento = setInterval(() => {
                if (!rastreamentoAtivo) {
                    console.log('‚èπÔ∏è Rastreamento desativado, parando intervalo');
                    clearInterval(intervaloRastreamento);
                    intervaloRastreamento = null;
                    return;
                }

                console.log('üìç Solicitando posi√ß√£o peri√≥dica...');
                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        console.log('‚úÖ Posi√ß√£o peri√≥dica obtida, enviando...');
                        enviarPosicaoGPS(position, coletaId, tokenRastreamento);
                        // Tamb√©m salvar no IndexedDB
                        await salvarPosicaoNoIndexedDB(position, coletaId, tokenRastreamento);
                    },
                    (error) => {
                        console.warn('‚ö†Ô∏è Erro ao obter posi√ß√£o peri√≥dica:', error);
                    },
                    {
                        ...options,
                        timeout: 30000,
                        maximumAge: 300000
                    }
                );
            }, INTERVALO_ENVIO_MS);

            atualizarStatusRastreamento('‚úÖ Rastreamento GPS ativo! Sua localiza√ß√£o ser√° enviada a cada 2 minutos. O rastreamento continuar√° mesmo se voc√™ fechar a aba ou mudar de aplicativo.', 'success');
            console.log('‚úÖ Rastreamento GPS configurado e ativo!');
        }

        // Parar rastreamento quando necess√°rio
        function pararRastreamentoGPS() {
            console.log('‚èπÔ∏è Parando rastreamento GPS');
            rastreamentoAtivo = false;
            
            if (watchId !== null) {
                navigator.geolocation.clearWatch(watchId);
                watchId = null;
            }
            
            if (intervaloRastreamento !== null) {
                clearInterval(intervaloRastreamento);
                intervaloRastreamento = null;
            }
            
            // Parar Service Worker
            if (serviceWorkerRegistration && serviceWorkerRegistration.active) {
                serviceWorkerRegistration.active.postMessage({
                    type: 'PARAR_RASTREAMENTO'
                });
            }
            
            // Liberar Wake Lock
            liberarWakeLock();
        }

        // Fun√ß√£o para enviar posi√ß√£o GPS
        async function enviarPosicaoGPS(position, coletaId, tokenRastreamento) {
            console.log('üì§ enviarPosicaoGPS chamado');
            
            if (!position || !position.coords) {
                console.error('‚ùå Posi√ß√£o inv√°lida');
                return;
            }

            // Obter token se n√£o foi fornecido
            if (!tokenRastreamento) {
                tokenRastreamento = localStorage.getItem(`rastreamento_token_${coletaId}`);
                console.log('üîë Token obtido do localStorage:', tokenRastreamento ? 'SIM' : 'N√ÉO');
            }

            if (!tokenRastreamento) {
                console.error('‚ùå Token de rastreamento n√£o dispon√≠vel');
                atualizarStatusRastreamento('‚ö†Ô∏è Token de rastreamento n√£o encontrado. Verifique se o termo foi aceito corretamente.', 'warning');
                return;
            }

            const { latitude, longitude, accuracy } = position.coords;

            // Validar coordenadas
            if (isNaN(latitude) || isNaN(longitude) || latitude < -90 || latitude > 90 || longitude < -180 || longitude > 180) {
                console.error('‚ùå Coordenadas inv√°lidas:', { latitude, longitude });
                return;
            }

            const dadosPosicao = {
                coletaId: coletaId,
                latitude: parseFloat(latitude.toFixed(6)),
                longitude: parseFloat(longitude.toFixed(6)),
                precisao: accuracy ? parseFloat(accuracy.toFixed(2)) : null,
                velocidade: position.coords.speed ? parseFloat((position.coords.speed * 3.6).toFixed(2)) : null,
                direcao: position.coords.heading ? parseFloat(position.coords.heading.toFixed(2)) : null
            };

            console.log('üì§ Enviando posi√ß√£o para servidor:', {
                coletaId: coletaId,
                latitude: dadosPosicao.latitude,
                longitude: dadosPosicao.longitude,
                tokenLength: tokenRastreamento ? tokenRastreamento.length : 0,
                tokenPreview: tokenRastreamento ? tokenRastreamento.substring(0, 30) + '...' : 'N/A',
                tokenCompleto: tokenRastreamento ? tokenRastreamento : 'N/A'
            });

            try {
                const response = await fetch('/api/rastreamento/enviar-posicao', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${tokenRastreamento}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dadosPosicao)
                });

                console.log('üì° Resposta do servidor:', response.status, response.statusText);

                if (response.ok) {
                    const result = await response.json();
                    contadorPosicoesEnviadas++;
                    
                    const agora = new Date();
                    atualizarStatusRastreamento(
                        `‚úÖ Localiza√ß√£o enviada com sucesso! (${contadorPosicoesEnviadas} envio(s))`,
                        'success',
                        `√öltima atualiza√ß√£o: ${agora.toLocaleTimeString('pt-BR')} - Lat: ${latitude.toFixed(6)}, Lng: ${longitude.toFixed(6)}`
                    );
                    
                    console.log('‚úÖ Posi√ß√£o GPS enviada com sucesso:', {
                        coletaId: coletaId,
                        posicaoId: result.posicao?.id,
                        totalEnviadas: contadorPosicoesEnviadas
                    });
                } else {
                    const errorData = await response.json().catch(() => ({ error: 'Erro desconhecido' }));
                    console.error('‚ùå Erro ao enviar posi√ß√£o:', response.status, errorData);
                    
                    if (response.status === 401 || response.status === 403) {
                        const errorMsg = errorData.error || 'Erro de autentica√ß√£o';
                        console.error('‚ùå Erro de autentica√ß√£o:', errorMsg);
                        
                        // Se o erro for "Token n√£o encontrado ou inv√°lido", tentar reaceitar o termo
                        if (errorMsg.includes('Token n√£o encontrado') || errorMsg.includes('Token inv√°lido')) {
                            if (tentativasReaceitarTermo < MAX_TENTATIVAS_REACEITAR) {
                                tentativasReaceitarTermo++;
                                console.log(`üîÑ Token inv√°lido. Tentando reaceitar termo (tentativa ${tentativasReaceitarTermo}/${MAX_TENTATIVAS_REACEITAR})...`);
                                try {
                                    // Capturar conte√∫do do termo para reaceitar
                                    const termoContent = document.querySelector('.termo-content');
                                    const conteudoTermo = termoContent ? termoContent.innerText || termoContent.textContent : '';
                                    const motoristaNomeTermo = document.getElementById('motoristaNome')?.textContent || '';
                                    const motoristaCNHTermo = document.getElementById('motoristaCNH')?.textContent || '';
                                    const termoData = document.getElementById('termoData')?.textContent || new Date().toLocaleDateString('pt-BR');
                                    
                                    const reaceitarResponse = await fetch('/api/rastreamento/aceitar-termo', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        credentials: 'include',
                                        body: JSON.stringify({
                                            coletaId: coletaId,
                                            termoVersao: '1.0',
                                            userAgent: navigator.userAgent,
                                            conteudoTermo: conteudoTermo,
                                            motoristaNome: motoristaNomeTermo,
                                            motoristaCNH: motoristaCNHTermo,
                                            termoData: termoData
                                        })
                                    });
                                    
                                    if (reaceitarResponse.ok) {
                                        const reaceitarResult = await reaceitarResponse.json();
                                        if (reaceitarResult.success && reaceitarResult.tokenRastreamento) {
                                            localStorage.setItem(`rastreamento_token_${coletaId}`, reaceitarResult.tokenRastreamento);
                                            console.log('‚úÖ Novo token obtido ap√≥s reaceitar termo');
                                            tentativasReaceitarTermo = 0;
                                            atualizarStatusRastreamento('‚úÖ Token atualizado. Continuando rastreamento...', 'success');
                                            setTimeout(() => {
                                                enviarPosicaoGPS(position, coletaId, reaceitarResult.tokenRastreamento);
                                            }, 500);
                                            return;
                                        }
                                    }
                                } catch (reaceitarError) {
                                    console.warn('‚ö†Ô∏è Erro ao tentar reaceitar termo:', reaceitarError);
                                }
                            }
                        }
                        
                        atualizarStatusRastreamento('‚ö†Ô∏è Erro de autentica√ß√£o. Verifique se o termo foi aceito corretamente.', 'warning');
                    } else if (response.status === 404) {
                        const errorMsg = errorData.error || 'Recurso n√£o encontrado';
                        console.error('‚ùå Erro 404:', errorMsg);
                        if (errorMsg.includes('Motorista n√£o encontrado')) {
                            console.warn('‚ö†Ô∏è Motorista n√£o encontrado para o token. Tentando verificar se o termo ainda est√° v√°lido...');
                            
                            // Tentar reaceitar o termo para obter novo token (com limite de tentativas)
                            if (tentativasReaceitarTermo < MAX_TENTATIVAS_REACEITAR) {
                                tentativasReaceitarTermo++;
                                try {
                                    console.log(`üîÑ Tentando reaceitar o termo para obter novo token (tentativa ${tentativasReaceitarTermo}/${MAX_TENTATIVAS_REACEITAR})...`);
                                    // Capturar conte√∫do do termo para reaceitar
                                    const termoContent = document.querySelector('.termo-content');
                                    const conteudoTermo = termoContent ? termoContent.innerText || termoContent.textContent : '';
                                    const motoristaNomeTermo = document.getElementById('motoristaNome')?.textContent || '';
                                    const motoristaCNHTermo = document.getElementById('motoristaCNH')?.textContent || '';
                                    const termoData = document.getElementById('termoData')?.textContent || new Date().toLocaleDateString('pt-BR');
                                    
                                    const reaceitarResponse = await fetch('/api/rastreamento/aceitar-termo', {
                                        method: 'POST',
                                        headers: {
                                            'Content-Type': 'application/json'
                                        },
                                        credentials: 'include',
                                        body: JSON.stringify({
                                            coletaId: coletaId,
                                            termoVersao: '1.0',
                                            userAgent: navigator.userAgent,
                                            conteudoTermo: conteudoTermo,
                                            motoristaNome: motoristaNomeTermo,
                                            motoristaCNH: motoristaCNHTermo,
                                            termoData: termoData
                                        })
                                    });
                                    
                                    if (reaceitarResponse.ok) {
                                        const reaceitarResult = await reaceitarResponse.json();
                                        if (reaceitarResult.success && reaceitarResult.tokenRastreamento) {
                                            // Novo token dispon√≠vel, atualizar
                                            localStorage.setItem(`rastreamento_token_${coletaId}`, reaceitarResult.tokenRastreamento);
                                            console.log('‚úÖ Novo token obtido ap√≥s reaceitar termo');
                                            tentativasReaceitarTermo = 0; // Resetar contador em caso de sucesso
                                            atualizarStatusRastreamento('‚úÖ Token atualizado. Continuando rastreamento...', 'success');
                                            // Tentar enviar a posi√ß√£o novamente com o novo token
                                            setTimeout(() => {
                                                enviarPosicaoGPS(position, coletaId, reaceitarResult.tokenRastreamento);
                                            }, 500);
                                            return; // Retornar sem mostrar erro ao usu√°rio
                                        }
                                    } else {
                                        const reaceitarError = await reaceitarResponse.json().catch(() => ({}));
                                        console.warn('‚ö†Ô∏è N√£o foi poss√≠vel reaceitar termo:', reaceitarResponse.status, reaceitarError);
                                    }
                                } catch (reaceitarError) {
                                    console.warn('‚ö†Ô∏è Erro ao tentar reaceitar termo:', reaceitarError);
                                }
                            } else {
                                console.warn('‚ö†Ô∏è Limite de tentativas de reaceitar termo atingido. Parando tentativas.');
                            }
                            
                            atualizarStatusRastreamento('‚ö†Ô∏è Motorista n√£o encontrado. O termo pode ter sido invalidado. Por favor, recarregue a p√°gina e aceite o termo novamente se necess√°rio.', 'warning');
                        } else {
                            atualizarStatusRastreamento('‚ö†Ô∏è Recurso n√£o encontrado. Verifique se a coleta ainda est√° ativa.', 'warning');
                        }
                    } else {
                        atualizarStatusRastreamento('‚ö†Ô∏è Erro ao enviar localiza√ß√£o. Tentando novamente...', 'warning');
                    }
                }
            } catch (error) {
                console.error('‚ùå Erro ao enviar posi√ß√£o GPS:', error);
                atualizarStatusRastreamento('‚ö†Ô∏è Erro de conex√£o. Verifique sua internet.', 'warning');
            }
        }

        // Fun√ß√£o para atualizar status do rastreamento na UI
        function atualizarStatusRastreamento(mensagem, tipo = 'info', detalhes = null) {
            const statusTexto = document.getElementById('statusRastreamentoTexto');
            const statusDetalhes = document.getElementById('statusRastreamentoDetalhes');
            
            if (statusTexto) {
                let icon = 'üìç';
                if (tipo === 'success') icon = '‚úÖ';
                else if (tipo === 'error') icon = '‚ùå';
                else if (tipo === 'warning') icon = '‚ö†Ô∏è';
                
                statusTexto.innerHTML = `${icon} ${mensagem}`;
                statusTexto.style.color = tipo === 'success' ? '#065f46' : tipo === 'error' ? '#991b1b' : tipo === 'warning' ? '#92400e' : '#047857';
            }
            
            if (statusDetalhes && detalhes) {
                statusDetalhes.textContent = detalhes;
            }
        }

        // Mostrar erro
        function mostrarErro(mensagem) {
            const errorDiv = document.getElementById('errorMessage');
            errorDiv.textContent = mensagem;
            errorDiv.style.display = 'block';
            setTimeout(() => {
                errorDiv.style.display = 'none';
            }, 5000);
        }

        // Mostrar sucesso
        function mostrarSucesso(mensagem) {
            const successDiv = document.getElementById('successMessage');
            successDiv.textContent = mensagem;
            successDiv.style.display = 'block';
        }

        // Interceptar e bloquear qualquer tentativa de redirecionamento para portal-motorista
        (function() {
            const originalPushState = history.pushState;
            const originalReplaceState = history.replaceState;
            
            history.pushState = function() {
                const url = arguments[2];
                if (url && typeof url === 'string' && url.includes('portal-motorista')) {
                    console.warn('‚ö†Ô∏è Tentativa de redirecionamento para portal-motorista bloqueada via pushState');
                    return;
                }
                return originalPushState.apply(history, arguments);
            };
            
            history.replaceState = function() {
                const url = arguments[2];
                if (url && typeof url === 'string' && url.includes('portal-motorista')) {
                    console.warn('‚ö†Ô∏è Tentativa de redirecionamento para portal-motorista bloqueada via replaceState');
                    return;
                }
                return originalReplaceState.apply(history, arguments);
            };
            
            // Interceptar window.location.href (tentativa mais segura)
            try {
                let locationDescriptor = Object.getOwnPropertyDescriptor(window, 'location');
                if (!locationDescriptor) {
                    locationDescriptor = Object.getOwnPropertyDescriptor(Object.getPrototypeOf(window), 'location');
                }
                
                // Verificar se a propriedade √© configur√°vel antes de tentar redefini-la
                if (locationDescriptor && locationDescriptor.set && locationDescriptor.configurable) {
                    const originalSetter = locationDescriptor.set;
                    Object.defineProperty(window, 'location', {
                        configurable: true,
                        set: function(value) {
                            if (typeof value === 'string' && value.includes('portal-motorista')) {
                                console.warn('‚ö†Ô∏è Tentativa de redirecionamento para portal-motorista bloqueada. Permanecemos na p√°gina do termo.');
                                console.trace('Stack trace do redirecionamento bloqueado:');
                                return; // Bloquear redirecionamento
                            }
                            return originalSetter.call(window, value);
                        },
                        get: locationDescriptor.get
                    });
                } else {
                    // Se n√£o for configur√°vel, interceptar window.location.href diretamente
                    const originalLocationHref = Object.getOwnPropertyDescriptor(window.location, 'href');
                    if (originalLocationHref && originalLocationHref.set && originalLocationHref.configurable) {
                        Object.defineProperty(window.location, 'href', {
                            configurable: true,
                            set: function(value) {
                                if (typeof value === 'string' && value.includes('portal-motorista')) {
                                    console.warn('‚ö†Ô∏è Tentativa de redirecionamento para portal-motorista bloqueada via location.href. Permanecemos na p√°gina do termo.');
                                    return; // Bloquear redirecionamento
                                }
                                return originalLocationHref.set.call(window.location, value);
                            },
                            get: originalLocationHref.get
                        });
                    }
                }
            } catch (error) {
                console.warn('‚ö†Ô∏è N√£o foi poss√≠vel interceptar window.location (pode ser uma limita√ß√£o do navegador):', error);
            }
        })();

        // Inicializar
        (async function() {
            try {
                // Tentar inicializar Supabase, mas n√£o bloquear se falhar
                await inicializarSupabase();
                
                const coletaIdParam = obterParametrosURL();
                if (!coletaIdParam) {
                    mostrarErro('Link inv√°lido. ID da coleta n√£o fornecido.');
                    document.getElementById('loadingState').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    return;
                }

                await carregarDadosColeta();
            } catch (error) {
                console.error('Erro na inicializa√ß√£o:', error);
                // Mesmo com erro, mostrar a p√°gina
                document.getElementById('loadingState').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                mostrarErro('Erro ao inicializar. Voc√™ ainda pode tentar aceitar o termo.');
            }
        })();
    </script>
</body>
</html>

