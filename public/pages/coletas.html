<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Coletas - Portal de Ferramentas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/permissions.js"></script>
    <!-- SortableJS para drag and drop robusto -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --azul-escuro: #002776;/* ============================================
   PORTAL LUCID - Estilos do Portal
   ============================================ */

/* Header do Portal - Agora usado apenas para o header interno */
/* Estilos movidos para portal-sidebar.css */

.portal-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(77, 166, 255, 0.5), rgba(111, 124, 255, 0.5), rgba(77, 166, 255, 0.5), transparent);
  opacity: 0.8;
  animation: header-glow 3s ease-in-out infinite;
}

@keyframes header-glow {
  0%, 100% { opacity: 0.5; }
  50% { opacity: 1; }
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: var(--spacing-lg);
}

.portal-logo {
  display: flex;
  flex-direction: column;
  line-height: 1;
  margin: 0;
}

.logo-gradient {
  font-size: 1.8rem;
  font-weight: var(--font-weight-bold);
  background: var(--gradient-hero);
  background-size: 200% 200%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 0 10px rgba(77, 166, 255, 0.5));
  animation: gradient-shift 3s ease infinite;
  letter-spacing: 2px;
}

@keyframes gradient-shift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

.logo-subtitle {
  font-size: 0.75rem;
  color: var(--text-tertiary);
  font-weight: var(--font-weight-normal);
  margin-top: 2px;
  letter-spacing: 1px;
}

.portal-nav {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
}

.nav-link {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  padding: var(--spacing-xs) var(--spacing-sm);
  color: var(--text-secondary);
  text-decoration: none;
  border-radius: var(--border-radius-sm);
  transition: all var(--transition-base);
  position: relative;
  font-size: 0.95rem;
}

.nav-link::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  width: 0;
  height: 2px;
  background: var(--gradient-primary);
  transform: translateX(-50%);
  transition: width var(--transition-base);
}

.nav-link:hover,
.nav-link.active {
  color: var(--text-primary);
  background: rgba(77, 166, 255, 0.1);
}

.nav-link:hover::after,
.nav-link.active::after {
  width: 80%;
}

.nav-user {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding-left: var(--spacing-md);
  border-left: 1px solid rgba(77, 166, 255, 0.2);
}

.user-name {
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.btn-logout {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #ef4444;
  padding: var(--spacing-xs) var(--spacing-sm);
  border-radius: var(--border-radius-sm);
  cursor: pointer;
  transition: all var(--transition-base);
  font-size: 0.9rem;
}

.btn-logout:hover {
  background: rgba(239, 68, 68, 0.2);
  border-color: rgba(239, 68, 68, 0.5);
  transform: translateY(-2px);
}

/* Main Container */
.portal-main {
  padding: var(--spacing-2xl) 0;
  min-height: calc(100vh - 200px);
  position: relative;
  z-index: 1;
}

.portal-section {
  margin-bottom: var(--spacing-3xl);
}

.section-header {
  text-align: left;
  margin-bottom: var(--spacing-2xl);
  padding-bottom: var(--spacing-lg);
  border-bottom: 1px solid rgba(77, 166, 255, 0.1);
}

.section-title {
  font-size: 2rem;
  font-weight: var(--font-weight-bold);
  margin-bottom: var(--spacing-2);
  color: var(--text-primary);
  position: relative;
  display: inline-block;
  letter-spacing: -0.5px;
}

.section-title::after {
  content: '';
  position: absolute;
  bottom: -8px;
  left: 0;
  width: 50px;
  height: 3px;
  background: var(--gradient-primary);
  border-radius: 2px;
}

.section-subtitle {
  font-size: 1rem;
  color: var(--text-secondary);
  max-width: 700px;
  margin: 0;
  line-height: 1.6;
  opacity: 0.9;
}

/* M√©tricas */
.metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: var(--spacing-lg);
  margin-top: var(--spacing-xl);
}

.metric-card {
  background: linear-gradient(135deg, rgba(18, 23, 38, 0.8) 0%, rgba(11, 14, 20, 0.9) 100%);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(77, 166, 255, 0.2);
  border-radius: var(--border-radius-lg);
  padding: var(--spacing-lg);
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.metric-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--gradient-hero);
  background-size: 200% 100%;
  transform: scaleX(0);
  transition: transform 0.3s ease;
  animation: gradient-shift 3s ease infinite;
}

.metric-card::after {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(77, 166, 255, 0.1) 0%, transparent 70%);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.metric-card:hover {
  transform: translateY(-4px);
  border-color: rgba(77, 166, 255, 0.4);
  box-shadow: 0 12px 40px rgba(77, 166, 255, 0.3), 0 0 60px rgba(77, 166, 255, 0.1);
  background: linear-gradient(135deg, rgba(18, 23, 38, 0.95) 0%, rgba(11, 14, 20, 0.95) 100%);
}

.metric-card:hover::before {
  transform: scaleX(1);
}

.metric-card:hover::after {
  opacity: 1;
}

.metric-icon {
  width: 56px;
  height: 56px;
  border-radius: var(--border-radius-md);
  background: var(--gradient-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.4rem;
  color: white;
  flex-shrink: 0;
  box-shadow: 0 4px 15px rgba(77, 166, 255, 0.4);
  transition: transform 0.3s ease;
}

.metric-card:hover .metric-icon {
  transform: scale(1.1) rotate(5deg);
}

.metric-content {
  flex: 1;
  min-width: 0;
}

.metric-value {
  font-size: 2rem;
  font-weight: var(--font-weight-bold);
  color: var(--text-primary);
  line-height: 1.2;
  margin-bottom: var(--spacing-1);
  letter-spacing: -0.5px;
}

.metric-label {
  font-size: 0.875rem;
  color: var(--text-secondary);
  font-weight: var(--font-weight-normal);
  opacity: 0.9;
}

/* Grid de Ferramentas */
.tools-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: var(--spacing-lg);
  margin-top: var(--spacing-xl);
}

.tool-card {
  background: rgba(18, 23, 38, 0.7);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(77, 166, 255, 0.25);
  border-radius: var(--border-radius-lg);
  padding: var(--spacing-xl);
  transition: all var(--transition-base);
  position: relative;
  overflow: hidden;
  text-decoration: none;
  color: inherit;
  display: flex;
  flex-direction: column;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.05);
}

.tool-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--gradient-hero);
  background-size: 200% 100%;
  transform: scaleX(0);
  transition: transform var(--transition-base);
  animation: gradient-shift 3s ease infinite;
}

.tool-card::after {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(77, 166, 255, 0.1) 0%, transparent 70%);
  opacity: 0;
  transition: opacity var(--transition-base);
  pointer-events: none;
}

.tool-card:hover {
  transform: translateY(-8px) scale(1.03);
  border-color: rgba(77, 166, 255, 0.6);
  box-shadow: 
    0 16px 50px rgba(0, 0, 0, 0.4),
    0 0 50px rgba(77, 166, 255, 0.4),
    0 0 80px rgba(111, 124, 255, 0.2),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);
  background: rgba(18, 23, 38, 0.85);
  color: inherit;
  text-decoration: none;
}

.tool-card:hover::before {
  transform: scaleX(1);
}

.tool-card:hover::after {
  opacity: 1;
  animation: card-glow 3s ease-in-out infinite;
}

@keyframes card-glow {
  0%, 100% {
    transform: scale(1) rotate(0deg);
  }
  50% {
    transform: scale(1.1) rotate(180deg);
  }
}

.tool-icon {
  width: 70px;
  height: 70px;
  border-radius: var(--border-radius-md);
  background: var(--gradient-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  color: white;
  margin-bottom: var(--spacing-md);
  box-shadow: 0 4px 15px rgba(77, 166, 255, 0.4);
  position: relative;
  z-index: 1;
  transition: all var(--transition-base);
}

.tool-card:hover .tool-icon {
  transform: scale(1.1) rotate(5deg);
  box-shadow: 0 8px 25px rgba(77, 166, 255, 0.6);
}

.tool-name {
  font-size: 1.25rem;
  font-weight: var(--font-weight-bold);
  color: var(--text-primary);
  margin-bottom: var(--spacing-xs);
  position: relative;
  z-index: 1;
}

.tool-description {
  font-size: 0.95rem;
  color: var(--text-secondary);
  line-height: 1.6;
  flex-grow: 1;
  position: relative;
  z-index: 1;
}

.tool-badge {
  display: inline-block;
  background: rgba(245, 158, 11, 0.2);
  border: 1px solid rgba(245, 158, 11, 0.4);
  color: #f59e0b;
  padding: 4px 12px;
  border-radius: var(--border-radius-sm);
  font-size: 0.75rem;
  font-weight: var(--font-weight-semibold);
  margin-top: var(--spacing-sm);
  position: relative;
  z-index: 1;
}

/* Badge de destaque para ferramentas principais */
.featured-badge {
  position: absolute;
  top: var(--spacing-md);
  right: var(--spacing-md);
  background: var(--gradient-hero);
  color: white;
  padding: 6px 12px;
  border-radius: var(--border-radius-sm);
  font-size: 0.75rem;
  font-weight: var(--font-weight-bold);
  display: flex;
  align-items: center;
  gap: 6px;
  box-shadow: 0 2px 10px rgba(77, 166, 255, 0.4);
  z-index: 2;
  animation: pulse-badge 2s ease-in-out infinite;
}

@keyframes pulse-badge {
  0%, 100% {
    box-shadow: 0 2px 10px rgba(77, 166, 255, 0.4);
    transform: scale(1);
  }
  50% {
    box-shadow: 0 4px 20px rgba(77, 166, 255, 0.6);
    transform: scale(1.05);
  }
}

.featured-badge i {
  font-size: 0.7rem;
}

/* Destaque para ferramentas principais */
.tool-featured {
  border-color: rgba(77, 166, 255, 0.4) !important;
  background: rgba(18, 23, 38, 0.8) !important;
}

.tool-featured::before {
  opacity: 1;
  transform: scaleX(1);
}

.tool-featured:hover {
  border-color: rgba(77, 166, 255, 0.7) !important;
  box-shadow: 
    0 16px 50px rgba(0, 0, 0, 0.4),
    0 0 60px rgba(77, 166, 255, 0.5),
    0 0 90px rgba(111, 124, 255, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
}

.tool-link {
  margin-top: var(--spacing-md);
  display: inline-flex;
  align-items: center;
  gap: var(--spacing-xs);
  color: var(--color-primary);
  font-weight: var(--font-weight-semibold);
  font-size: 0.9rem;
  position: relative;
  z-index: 1;
  transition: all var(--transition-base);
}

.tool-card:hover .tool-link {
  color: var(--color-accent);
  transform: translateX(5px);
}

.tool-coming-soon {
  opacity: 0.8;
  cursor: not-allowed;
}

.tool-coming-soon:hover {
  opacity: 0.9;
}

/* Footer */
.portal-footer {
  background: var(--bg-secondary);
  border-top: 1px solid rgba(77, 166, 255, 0.2);
  padding: var(--spacing-lg) 0;
  text-align: center;
  color: var(--text-tertiary);
  font-size: 0.9rem;
  position: relative;
  z-index: 0; /* Garantir que fique atr√°s dos cards do Kanban */
}

/* Alertas */
#alertContainer {
  margin-bottom: var(--spacing-lg);
}

.alert-portal {
  background: rgba(18, 23, 38, 0.8);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(77, 166, 255, 0.3);
  border-radius: var(--border-radius-md);
  padding: var(--spacing-md);
  margin-bottom: var(--spacing-md);
  color: var(--text-primary);
  position: relative;
  overflow: hidden;
}

.alert-portal::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
  background: var(--gradient-primary);
}

.alert-portal.success::before {
  background: linear-gradient(135deg, #22c55e, #16a34a);
}

.alert-portal.error::before {
  background: linear-gradient(135deg, #ef4444, #dc2626);
}

.alert-portal.warning::before {
  background: linear-gradient(135deg, #f59e0b, #d97706);
}

/* Responsividade */
@media (max-width: 768px) {
  .header-content {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .portal-nav {
    flex-wrap: wrap;
    width: 100%;
  }
  
  .nav-user {
    border-left: none;
    border-top: 1px solid rgba(77, 166, 255, 0.2);
    padding-left: 0;
    padding-top: var(--spacing-sm);
    width: 100%;
    justify-content: space-between;
  }
  
  .metrics-grid {
    grid-template-columns: 1fr;
  }
  
  .tools-grid {
    grid-template-columns: 1fr;
  }
  
  .metric-card {
    flex-direction: column;
    text-align: center;
  }
}


            --vermelho: #C60C30;
            --branco: #FFFFFF;
            --cinza-claro: #F5F5F5;
            --cinza-escuro: #333333;
            --azul-claro: #4A7BFF;
            --verde: #28a745;
            --laranja: #fd7e14;
            --roxo: #6f42c1;
            --ciano: #20c997;
            --gradient-primary: linear-gradient(135deg, #002776 0%, #0044AA 100%);
            --gradient-danger: linear-gradient(135deg, #C60C30 0%, #E63946 100%);
            --gradient-success: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            --gradient-warning: linear-gradient(135deg, #fd7e14 0%, #ffc107 100%);
            --gradient-purple: linear-gradient(135deg, #6f42c1 0%, #8B5FBF 100%);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --card-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            --hover-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            --border-radius: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 50%, #e2e8f0 100%);
            background-attachment: fixed;
            color: var(--cinza-escuro);
            line-height: 1.6;
            min-height: 100vh;
            transition: var(--transition);
            overflow-x: hidden;
            position: relative;
        }

        /* Header Moderno */
        .main-header {
            background: linear-gradient(135deg, #002776 0%, #0044AA 100%);
            color: var(--branco);
            padding: 0.3rem 0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
            z-index: 10;
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        .header-content {
            position: relative;
            z-index: 1;
            max-width: 100%;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
            gap: 0.75rem;
        }

        .header-title {
            font-size: 1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            letter-spacing: -0.3px;
        }

        .header-title i {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.8rem;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .header-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
            margin-top: 0.5rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            padding: 0.6rem 1rem;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--branco);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--azul-escuro);
            font-weight: bold;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .user-role {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        /* Bot√µes Modernos */
        .btn-modern {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: var(--branco);
            padding: 0.8rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.7rem;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: var(--transition);
        }

        .btn-modern:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(255, 255, 255, 0.2);
        }

        .btn-modern:hover::before {
            left: 100%;
        }

        /* Container Principal */
        .main-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0.5rem 0.75rem;
            position: relative;
            z-index: 1;
        }

        /* Filtros e Controles - Otimizado */
        .controls-container {
            background: #ffffff;
            border-radius: 6px;
            padding: 0.5rem 0.65rem;
            margin-bottom: 0.4rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.02);
            border: 1px solid rgba(102, 126, 234, 0.08);
        }

        .filters-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            min-width: 140px;
        }

        .filter-group label {
            font-weight: 600;
            color: var(--azul-escuro);
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .filter-group select,
        .filter-group input {
            padding: 0.5rem 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.8rem;
            background: var(--branco);
            color: var(--cinza-escuro);
            transition: var(--transition);
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: var(--azul-escuro);
            box-shadow: 0 0 0 3px rgba(0, 39, 118, 0.1);
            transform: translateY(-2px);
        }

        /* Filtros de Data Espec√≠ficos - Compacto */
        .date-filters {
            display: grid;
            grid-template-columns: auto auto 1fr;
            gap: 0.6rem;
            align-items: end;
            padding: 0.6rem;
            background: rgba(0, 39, 118, 0.03);
            border-radius: 8px;
            margin-bottom: 0.6rem;
            border: 1px solid rgba(0, 39, 118, 0.08);
        }
        
        @media (max-width: 768px) {
            .date-filters {
                grid-template-columns: 1fr;
            }
            
            .filters-row {
                grid-template-columns: 1fr;
            }
            
            .controls-container {
                padding: 1rem;
            }
        }

        .date-filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            min-width: 140px;
        }

        .date-filter-group label {
            font-weight: 600;
            color: var(--azul-escuro);
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .date-filter-group input {
            padding: 0.5rem 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.8rem;
        }

        .quick-date-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        .quick-date-btn {
            padding: 0.4rem 0.8rem;
            border: 1px solid var(--azul-escuro);
            background: transparent;
            color: var(--azul-escuro);
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 600;
            transition: var(--transition);
        }

        .quick-date-btn:hover,
        .quick-date-btn.active {
            background: var(--azul-escuro);
            color: var(--branco);
        }

        .stats-container {
            display: flex;
            gap: 0.4rem;
            flex-wrap: nowrap;
            margin: 0 auto 0.4rem auto;
            overflow-x: auto;
            padding: 0.4rem 0.5rem;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.02) 0%, rgba(118, 75, 162, 0.02) 100%);
            border-radius: 8px;
            border: 1px solid rgba(102, 126, 234, 0.08);
            scrollbar-width: none;
            -ms-overflow-style: none;
            justify-content: center;
            max-width: fit-content;
        }

        .stats-container::-webkit-scrollbar {
            display: none;
        }

        .stat-card {
            color: var(--branco);
            padding: 0.45rem 0.7rem;
            border-radius: 8px;
            text-align: center;
            min-width: 140px;
            flex: 0 0 auto;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1), 0 1px 2px rgba(0, 0, 0, 0.05);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(10px);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.25), transparent);
            transition: left 0.6s ease;
        }

        .stat-card:hover {
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.18), 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-card > div:first-child {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.1rem;
            width: 100%;
        }
        
        .stat-card > .stat-label {
            width: 100%;
            text-align: center;
        }

        .stat-number {
            font-size: 0.95rem;
            font-weight: 700;
            line-height: 1.1;
            letter-spacing: -0.2px;
        }

        .stat-value {
            font-size: 0.7rem;
            font-weight: 600;
            opacity: 0.9;
            line-height: 1.1;
            margin-top: 0.1rem;
        }

        .stat-label {
            font-size: 0.65rem;
            opacity: 0.85;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }

        /* Grid de Cards de Coletas */
        .coletas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        /* ========== ESTILOS KANBAN ========== */

        /* Barra de rolagem customizada estilo slider - Parte inferior */
        .kanban-scrollbar-wrapper {
            position: relative;
            width: 100%;
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            display: block; /* Sempre vis√≠vel quando h√° m√∫ltiplas colunas */
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border-top: 2px solid rgba(102, 126, 234, 0.3);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1), 0 4px 12px rgba(102, 126, 234, 0.15);
            z-index: 10;
            pointer-events: auto;
            visibility: visible;
            opacity: 1;
        }

        .kanban-scrollbar-wrapper.hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }

        .kanban-scrollbar-track {
            width: 100%;
            height: 10px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s ease;
            min-height: 10px;
        }

        .kanban-scrollbar-track:hover {
            background: rgba(0, 0, 0, 0.12);
        }

        .kanban-scrollbar-thumb {
            position: absolute;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            cursor: grab;
            transition: all 0.2s ease;
            min-width: 60px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
            left: 0;
            top: 0;
            z-index: 10;
        }

        .kanban-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3f8f 100%);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
            transform: scaleY(1.2);
        }

        .kanban-scrollbar-thumb:active {
            cursor: grabbing;
            transform: scaleY(1.3);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
        }

        .kanban-scrollbar-arrows {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            justify-content: center;
            pointer-events: auto;
            position: relative;
            z-index: 20;
        }

        .kanban-scrollbar-arrow {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            position: relative;
            z-index: 20;
            pointer-events: auto;
            -webkit-user-select: none;
            user-select: none;
        }

        .kanban-scrollbar-arrow:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
        }

        .kanban-scrollbar-arrow:active {
            transform: scale(0.95);
        }

        .kanban-scrollbar-arrow:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        /* ============================================
           KANBAN BOARD - Vers√£o Refatorada e Melhorada
           ============================================ */
        .kanban-container {
            width: 100%;
            max-width: 100%;
            padding: 0;
            margin: 0 auto 0.75rem auto;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: visible;
            box-sizing: border-box;
        }
        
        /* Wrapper para o board */
        .kanban-board-wrapper {
            position: relative;
            width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            padding-bottom: 0.5rem;
            box-sizing: border-box;
            background: transparent;
        }
        
        /* Controles de navega√ß√£o do Kanban */
        .kanban-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0 1rem;
            gap: 1rem;
        }
        
        .kanban-nav-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .kanban-nav-btn {
            width: 44px;
            height: 44px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
        }
        
        .kanban-nav-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
            background: linear-gradient(135deg, #5568d3 0%, #6a3f8f 100%);
        }
        
        .kanban-nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }
        
        .kanban-nav-btn:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .kanban-stages-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .kanban-stage-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.3);
            transition: all 0.2s ease;
            cursor: pointer;
        }
        
        .kanban-stage-dot.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 24px;
            border-radius: 12px;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.4);
        }
        
        .kanban-stage-dot:hover {
            background: rgba(102, 126, 234, 0.5);
            transform: scale(1.2);
        }
        
        .kanban-stages-info {
            font-size: 0.85rem;
            color: #667eea;
            font-weight: 600;
            white-space: nowrap;
        }

        .kanban-board {
            display: flex;
            gap: 1.25rem;
            min-width: max-content;
            width: max-content;
            padding: 0 1rem;
            margin: 0;
            flex-wrap: nowrap;
            box-sizing: border-box;
        }

        .kanban-column {
            min-width: 300px;
            max-width: 300px;
            width: 300px;
            height: calc(100vh - 200px);
            min-height: 600px;
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
            border-radius: 14px;
            padding: 0.85rem;
            display: flex;
            flex-direction: column;
            gap: 0.85rem;
            border: 1px solid rgba(102, 126, 234, 0.12);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06), 0 2px 6px rgba(102, 126, 234, 0.08), inset 0 1px 0 rgba(255, 255, 255, 0.8);
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            flex-grow: 0;
            overflow: hidden;
            align-items: stretch;
            position: relative;
        }
        
        .kanban-column::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .kanban-column:hover::before {
            opacity: 1;
        }
        
        /* Garantir que as colunas n√£o sejam cortadas e sempre vis√≠veis */
        .kanban-board > .kanban-column {
            flex-shrink: 0 !important;
            flex-grow: 0 !important;
        }
        
        /* Responsividade para telas menores */
        @media (max-width: 768px) {
            .kanban-column {
                min-width: 240px;
                max-width: 240px;
                width: 240px;
                height: calc(100vh - 350px);
                max-height: calc(100vh - 350px);
            }
        }

        .kanban-column:hover {
            border-color: rgba(102, 126, 234, 0.3);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.12), 0 6px 16px rgba(102, 126, 234, 0.18), inset 0 1px 0 rgba(255, 255, 255, 1);
            transform: translateY(-4px) scale(1.015);
        }

        .kanban-column-header {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            padding: 1rem;
            background: #ffffff;
            border-radius: 12px;
            margin-bottom: 0.75rem;
            border: 1px solid rgba(102, 126, 234, 0.15);
            flex-shrink: 0;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.04);
            position: sticky;
            top: 0;
            z-index: 5;
        }

        .kanban-column-title {
            font-weight: 700;
            color: #667eea;
            font-size: 0.95rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            letter-spacing: 0.3px;
        }

        .kanban-column-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.75rem;
            width: 100%;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
        }

        .kanban-column-count {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            color: #495057;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .kanban-column-count::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #667eea;
            display: inline-block;
        }

        .kanban-column-value {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            color: #28a745;
            font-size: 0.85rem;
            font-weight: 700;
            white-space: nowrap;
        }

        .kanban-column-value::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #28a745;
            display: inline-block;
        }

        .kanban-column-cards {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            flex: 1 1 auto;
            min-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0.5rem 0.5rem 0.5rem 0;
            margin-right: -0.5rem;
            scrollbar-width: thin;
            scrollbar-color: rgba(102, 126, 234, 0.6) rgba(102, 126, 234, 0.1);
            /* Melhorar scroll quando h√° muitas coletas */
            scroll-behavior: smooth;
            overscroll-behavior: contain;
            /* Garantir que os cards n√£o sejam comprimidos */
            align-items: stretch;
        }

        .kanban-column-cards::-webkit-scrollbar {
            width: 10px;
        }

        .kanban-column-cards::-webkit-scrollbar-track {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            margin: 4px 0;
        }

        .kanban-column-cards::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.2s ease;
        }

        .kanban-column-cards::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3f8f 100%);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .kanban-card {
            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08), 0 1px 4px rgba(0, 0, 0, 0.05), inset 0 1px 0 rgba(255, 255, 255, 0.9);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid rgba(102, 126, 234, 0.1);
            border-left: 4px solid #667eea;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            flex-grow: 0;
            width: 100%;
            box-sizing: border-box;
        }
        
        .kanban-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }
        
        .kanban-card:hover::after {
            width: 6px;
        }

        .kanban-card:hover:not(.expanded) {
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.25), 0 3px 8px rgba(0, 0, 0, 0.12), inset 0 1px 0 rgba(255, 255, 255, 1);
            transform: translateY(-4px) scale(1.01);
            border-color: rgba(102, 126, 234, 0.3);
        }


        /* ========== DRAWER DO KANBAN (WORKSPACE) ========== */
        .kanban-drawer {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
            display: none;
            pointer-events: none;
        }

        .kanban-drawer.active {
            display: flex;
            pointer-events: auto;
        }

        .kanban-drawer-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(3px);
            transition: opacity 0.3s ease;
        }

        .kanban-drawer-content {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 90vw;
            max-width: 1000px;
            background: white;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.2);
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .kanban-drawer.active .kanban-drawer-content {
            transform: translateX(0);
        }

        .kanban-drawer-header {
            padding: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .kanban-drawer-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .kanban-drawer-close {
            background: #dc3545;
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
        }

        .kanban-drawer-close:hover {
            background: #c82333;
            transform: scale(1.1);
        }

        .kanban-drawer-body {
            padding: 1.5rem;
            flex: 1;
            overflow-y: auto;
        }

        .kanban-drawer-tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 1.5rem;
            overflow-x: auto;
        }

        .kanban-drawer-tab {
            padding: 0.75rem 1.5rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .kanban-drawer-tab:hover {
            color: #667eea;
        }

        .kanban-drawer-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .kanban-drawer-tab-content {
            display: none;
        }

        .kanban-drawer-tab-content.active {
            display: block;
        }

        /* Estilos para etapas clic√°veis no drawer */
        .drawer-etapa-clickable {
            position: relative;
        }

        .drawer-etapa-clickable:hover {
            background: rgba(102, 126, 234, 0.1) !important;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .drawer-etapa-clickable:active {
            transform: translateY(0);
        }

        .kanban-board {
            position: relative;
            z-index: 1;
        }

        .kanban-column {
            position: relative;
            z-index: 1;
        }
        
        /* Garantir que o scrollbar n√£o seja bloqueado */
        .kanban-board-wrapper {
            z-index: 1;
        }
        
        .kanban-board-wrapper * {
            pointer-events: auto;
        }
        
        .kanban-board-wrapper .kanban-board {
            pointer-events: auto !important;
        }

        .kanban-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
            transform: rotate(2deg);
        }

        .kanban-card.no-drag {
            opacity: 0.6;
            cursor: not-allowed;
            border-left-color: #dc3545;
        }

        .kanban-card.no-drag::after {
            content: 'üîí';
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 0.9rem;
        }

        .kanban-card-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
            font-size: 0.95rem;
        }

        .kanban-card-info {
            font-size: 0.8rem;
            color: #666;
            margin-bottom: 0.25rem;
        }

        .kanban-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            cursor: pointer;
        }

        .kanban-card-body {
            flex: 1;
            cursor: pointer;
        }

        .kanban-card-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 0.75rem 0;
            padding: 0.5rem 0;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }

        .kanban-badge {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            color: #667eea;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.7rem;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-weight: 600;
        }

        /* Anima√ß√£o de piscar para badge urgente no Kanban */
        @keyframes piscarBadgeUrgente {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
                box-shadow: 0 0 10px rgba(231, 76, 60, 0.6);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.1);
                box-shadow: 0 0 20px rgba(231, 76, 60, 1);
            }
        }

        .kanban-urgente-badge {
            background: #e74c3c;
            color: white;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            animation: piscarBadgeUrgente 1.5s ease-in-out infinite;
            display: inline-block;
            cursor: pointer;
        }

        .kanban-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.5rem;
            padding-top: 0.5rem;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }

        .kanban-card-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .kanban-card-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
        }


        .kanban-card-status {
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .kanban-card-status.pendente {
            background: #fff3cd;
            color: #856404;
        }

        .kanban-card-status.em_andamento {
            background: #d1ecf1;
            color: #0c5460;
        }

        .kanban-card-status.concluida {
            background: #d4edda;
            color: #155724;
        }

        .kanban-card-status.cancelada {
            background: #f8d7da;
            color: #721c24;
        }

        .kanban-drop-zone {
            min-height: 50px;
            border-radius: 8px;
            border: 2px dashed transparent;
            transition: all 0.2s ease;
        }

        .kanban-drop-zone.drag-over {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        @media (max-width: 768px) {
            .kanban-column {
                min-width: 280px;
                max-width: 280px;
            }
        }

        .coleta-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px) saturate(180%);
            border-radius: 20px;
            padding: 1.75rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            position: relative;
            overflow: visible;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .coleta-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            z-index: 1;
        }
        
        .coleta-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.06) 0%, transparent 60%),
                        radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.06) 0%, transparent 60%);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        
        .coleta-card:hover::after {
            opacity: 1;
        }
        
        .coleta-card.expanded {
            max-height: none;
            overflow: visible;
        }
        
        .coleta-card.expanded .card-content {
            width: 100%;
            overflow: visible;
            box-sizing: border-box;
        }
        
        .coleta-card.expanded .card-details {
            width: 100%;
            overflow: visible;
            box-sizing: border-box;
        }
        
        .coleta-card.expanded .etapas-container,
        .coleta-card.expanded .validation-actions,
        .coleta-card.expanded .etapa-validation,
        .coleta-card.expanded .anexos-section,
        .coleta-card.expanded .historico-list-card {
            width: 100%;
            box-sizing: border-box;
            max-width: 100%;
            overflow-x: auto;
            overflow-y: visible;
        }
        
        .coleta-card.expanded * {
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .coleta-card.collapsed .card-details,
        .coleta-card.collapsed .etapas-container,
        .coleta-card.collapsed .validation-actions,
        .coleta-card.collapsed .etapa-validation {
            display: none;
        }
        
        .card-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 10;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4),
                        0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .card-toggle:hover {
            transform: scale(1.15) rotate(90deg);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6),
                        0 0 0 5px rgba(102, 126, 234, 0.2);
        }
        
        .card-toggle:active {
            transform: scale(0.95) rotate(180deg);
        }
        
        .card-toggle i {
            transition: transform 0.3s;
        }
        
        .coleta-card.expanded .card-toggle i {
            transform: rotate(180deg);
        }


        .coleta-card.pendente::before { background: var(--vermelho); }
        .coleta-card.em_andamento::before { background: var(--laranja); }
        .coleta-card.concluida::before { background: var(--verde); }
        .coleta-card.cancelada::before { background: #6c757d; }

        /* Anima√ß√£o de piscar para coletas urgentes */
        @keyframes piscarUrgente {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 4px 20px rgba(231, 76, 60, 0.2);
            }
            50% {
                opacity: 0.7;
                box-shadow: 0 4px 30px rgba(231, 76, 60, 0.4);
            }
        }

        /* Design moderno para coletas urgentes com anima√ß√£o de piscar */
        .coleta-card.urgente {
            position: relative;
            background: linear-gradient(to right, rgba(231, 76, 60, 0.08) 0%, rgba(255, 255, 255, 0.98) 100%) !important;
            animation: piscarUrgente 2s ease-in-out infinite;
        }

        /* Barra superior vermelha s√≥lida */
        .coleta-card.urgente::before {
            background: #e74c3c !important;
            height: 4px !important;
        }

        /* Remover ponto indicador no canto - desabilitado */
        .coleta-card.urgente::after {
            display: none;
        }

        /* Hover elegante mantendo consist√™ncia */
        .coleta-card.urgente:hover {
            transform: translateY(-4px);
            animation: piscarUrgente 1.5s ease-in-out infinite;
        }

        .coleta-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
            background: rgba(255, 255, 255, 1);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .coleta-card .status-badge.pendente,
        .coleta-card .status-badge.em_andamento {
            animation: pulse 3s infinite;
        }

        /* Header do Card Modernizado */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }

        .card-title-section {
            flex: 1;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--cinza-escuro);
            margin-bottom: 0.5rem;
            line-height: 1.4;
            letter-spacing: -0.3px;
        }

        .card-id {
            font-size: 0.75rem;
            color: #6c757d;
            background: rgba(0, 0, 0, 0.04);
            padding: 0.35rem 0.75rem;
            border-radius: 12px;
            font-weight: 500;
            display: inline-block;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        .status-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5rem;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .status-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .status-badge:hover::before {
            left: 100%;
        }

        .status-pendente {
            background: linear-gradient(135deg, rgba(198, 12, 48, 0.15) 0%, rgba(198, 12, 48, 0.05) 100%);
            color: var(--vermelho); 
            border: 2px solid rgba(198, 12, 48, 0.3);
            box-shadow: 0 2px 10px rgba(198, 12, 48, 0.15);
        }
        
        .status-em_andamento { 
            background: linear-gradient(135deg, rgba(253, 126, 20, 0.15) 0%, rgba(253, 126, 20, 0.05) 100%);
            color: var(--laranja); 
            border: 2px solid rgba(253, 126, 20, 0.3);
            box-shadow: 0 2px 10px rgba(253, 126, 20, 0.15);
        }

        .status-concluida {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.15) 0%, rgba(40, 167, 69, 0.05) 100%);
            color: var(--verde); 
            border: 2px solid rgba(40, 167, 69, 0.3);
            box-shadow: 0 2px 10px rgba(40, 167, 69, 0.15);
        }
        
        .status-cancelada { 
            background: linear-gradient(135deg, rgba(108, 117, 125, 0.15) 0%, rgba(108, 117, 125, 0.05) 100%);
            color: #6c757d; 
            border: 2px solid rgba(108, 117, 125, 0.3);
            box-shadow: 0 2px 10px rgba(108, 117, 125, 0.15);
        }

        .valor-badge {
            background: linear-gradient(135deg, #002776 0%, #003a9f 100%);
            color: var(--branco);
            padding: 0.5rem 1rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 39, 118, 0.25),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: none;
            position: relative;
            overflow: hidden;
        }
        
        .valor-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .valor-badge:hover::before {
            left: 100%;
        }

        /* Conte√∫do do Card Modernizado */
        .card-content {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
            width: 100%;
            box-sizing: border-box;
        }
        
        .card-details {
            padding-top: 0.5rem;
            width: 100%;
            box-sizing: border-box;
            overflow: visible;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.2rem;
            width: 100%;
            box-sizing: border-box;
        }
        
        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: 1fr;
            gap: 1rem;
            }
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            width: 100%;
            box-sizing: border-box;
            min-width: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .info-label {
            font-size: 0.7rem;
            color: #6c757d;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 0.25rem;
            width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .info-value {
            font-size: 0.95rem;
            color: var(--cinza-escuro);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            line-height: 1.5;
            width: 100%;
            box-sizing: border-box;
            min-width: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .info-value > * {
            flex-shrink: 1;
            min-width: 0;
        }
        
        /* Estilo espec√≠fico para badges de tipos de ve√≠culo e carroceria */
        .info-value span[style*="display: inline-block"] {
            display: inline-block !important;
            word-wrap: break-word;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        /* Garantir que os badges quebrem linha corretamente */
        .info-value {
            flex-wrap: wrap;
        }
        
        /* Container para badges de tipos - garante que fiquem dentro do card */
        .info-value > span[style*="display: flex"] {
            max-width: 100%;
            overflow: hidden;
        }

        .info-value i {
            color: #667eea;
            width: 16px;
            opacity: 0.9;
        }

        /* Se√ß√£o de Anexos nos Cards */
        .anexos-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1rem;
            margin-top: 0.5rem;
            border: 1px solid #e9ecef;
        }

        .anexos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .anexos-title {
            font-size: 0.85rem;
            color: var(--azul-escuro);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-anexar {
            background: var(--gradient-success);
            border: none;
            color: var(--branco);
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .btn-anexar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .anexos-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 150px;
            overflow-y: auto;
        }

        .anexo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0.8rem;
            background: var(--branco);
            border-radius: 8px;
            border-left: 3px solid var(--azul-escuro);
            transition: var(--transition);
        }

        .anexo-item:hover {
            background: #f8f9fa;
            transform: translateX(2px);
        }

        .anexo-info {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            flex: 1;
        }

        .anexo-icon {
            font-size: 1rem;
            width: 20px;
            text-align: center;
        }

        .anexo-details {
            flex: 1;
            min-width: 0;
        }

        .anexo-nome {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--cinza-escuro);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .anexo-tamanho {
            font-size: 0.7rem;
            color: #6c757d;
        }

        /* ========== LOADING SKELETONS ========== */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
        }

        .skeleton-line {
            height: 16px;
            margin-bottom: 12px;
            border-radius: 4px;
        }

        .skeleton-line:last-child {
            margin-bottom: 0;
        }

        .skeleton-title {
            height: 24px;
            width: 60%;
            margin-bottom: 16px;
        }

        .skeleton-subtitle {
            height: 18px;
            width: 40%;
            margin-bottom: 12px;
        }

        .skeleton-text {
            height: 14px;
            width: 80%;
        }

        .anexo-actions {
            display: flex;
            gap: 0.3rem;
        }

        .btn-anexo-action {
            background: transparent;
            border: none;
            padding: 0.4rem;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .btn-anexo-view {
            color: var(--azul-escuro);
            border: 1px solid var(--azul-escuro);
        }

        .btn-anexo-view:hover {
            background: var(--azul-escuro);
            color: white;
        }

        .btn-anexo-download {
            color: var(--verde);
            border: 1px solid var(--verde);
        }

        .btn-anexo-download:hover {
            background: var(--verde);
            color: white;
        }

        .btn-anexo-delete {
            color: var(--vermelho);
            border: 1px solid var(--vermelho);
        }

        .btn-anexo-delete:hover {
            background: var(--vermelho);
            color: white;
        }

        /* Barra de Progresso das Etapas Modernizada */
        .etapas-container {
            margin: 1rem 0;
        }

        .etapas-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .etapas-title {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-text {
            font-size: 0.8rem;
            color: var(--azul-escuro);
            font-weight: 600;
        }

        .etapas-progress {
            display: flex;
            height: 8px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .etapa-progress {
            height: 100%;
            transition: var(--transition);
        }

        .etapa-cs { background: var(--azul-claro); }
        .etapa-contratacao { background: var(--azul-escuro); }
        .etapa-gr { background: var(--verde); }
        .etapa-documentacao { background: var(--vermelho); }
        .etapa-controladoria { background: var(--roxo); }
        .etapa-ti { background: #0ea5e9; }
        .etapa-contas_pagar { background: #480ca8; }
        .etapa-contas_receber { background: #3f37c9; }
        .etapa-monitoramento { background: #0891b2; }
        .etapa-servicos_adicionais { background: #7c3aed; }
        .etapa-finalizar_operacao { background: #059669; }
        .etapa-price { background: var(--laranja); }
        .etapa-comercial { background: var(--ciano); }

        .etapas-labels {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .etapa-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 600;
            background: var(--cinza-claro);
            color: #6c757d;
            border: 1px solid #ddd;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .etapa-badge.ativa {
            background: var(--azul-escuro);
            color: var(--branco);
            border-color: var(--azul-escuro);
        }

        .etapa-badge.concluida {
            background: var(--verde);
            color: var(--branco);
            border-color: var(--verde);
        }

        /* Footer do Card Modernizado */
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
            margin-top: auto;
        }

        .card-actions {
            display: flex;
            gap: 0.7rem;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 0.7rem 1.2rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-weight: 700;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }
        
        .action-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .action-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #002776 0%, #003a9f 100%);
            color: var(--branco);
            box-shadow: 0 4px 15px rgba(0, 39, 118, 0.3);
        }
        .action-btn.secondary {
            background: linear-gradient(135deg, #00b4d8 0%, #0096c7 100%);
            color: var(--branco);
            box-shadow: 0 4px 15px rgba(0, 150, 199, 0.3);
        }
        
        .action-btn.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: var(--branco);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .action-btn.warning {
            background: linear-gradient(135deg, #c60c30 0%, #e63946 100%);
            color: var(--branco);
            box-shadow: 0 4px 15px rgba(198, 12, 48, 0.3);
        }

        .action-btn.chat {
            background: linear-gradient(135deg, #6f42c1 0%, #8B5FBF 100%);
            color: var(--branco);
            box-shadow: 0 4px 15px rgba(111, 66, 193, 0.3);
        }

        .action-btn.danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: var(--branco);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        .action-btn:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .action-btn:active {
            transform: translateY(-2px) scale(1);
        }

        .card-date {
            font-size: 0.8rem;
            color: #6c757d;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Hist√≥rico NO CARD (NOVOS ESTILOS) */
        .historico-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
            border: 1px solid #e9ecef;
        }

        .historico-list-card {
            display: flex;
            flex-direction: column;
            gap: 0.7rem;
            max-height: 120px;
            overflow-y: auto;
        }

        .historico-item-card {
            padding: 0.6rem;
            background: white;
            border-radius: 8px;
            border-left: 3px solid var(--azul-escuro);
            font-size: 0.75rem;
        }

        .historico-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.2rem;
        }

        .historico-usuario-card {
            font-weight: 600;
            color: var(--azul-escuro);
            font-size: 0.7rem;
        }

        .historico-data-card {
            color: #6c757d;
            font-size: 0.65rem;
        }

        .historico-acao-card {
            color: var(--cinza-escuro);
            line-height: 1.3;
            font-size: 0.7rem;
        }

        .historico-acao-card small {
            color: #6c757d;
            font-style: italic;
        }

        .historico-mais-itens {
            text-align: center;
            color: var(--azul-escuro);
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.4rem;
            background: rgba(0, 39, 118, 0.1);
            border-radius: 6px;
            cursor: pointer;
        }

        .historico-mais-itens:hover {
            background: rgba(0, 39, 118, 0.2);
        }

        .historico-title {
            font-size: 0.9rem;
            color: var(--azul-escuro);
            font-weight: 600;
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Modal de Detalhes */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 2rem;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--branco);
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--hover-shadow);
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--azul-escuro);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .close-modal {
            background: var(--vermelho);
            color: var(--branco);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .close-modal:hover {
            transform: rotate(90deg) scale(1.1);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 600;
            color: var(--azul-escuro);
            font-size: 0.9rem;
        }
        
        .form-group label .required-asterisk {
            color: #dc3545;
            font-weight: 700;
            margin-left: 3px;
            font-size: 1rem;
        }
        
        .form-group label.required {
            position: relative;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.8rem 1rem;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 0.9rem;
            background: var(--branco);
            color: var(--cinza-escuro);
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--azul-escuro);
            box-shadow: 0 0 0 3px rgba(0, 39, 118, 0.1);
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        /* Submenus no Card */
        .card-submenu {
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 1rem;
            overflow: hidden;
            border: 1px solid #e9ecef;
        }

        .submenu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submenu-header:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        .submenu-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .submenu-toggle {
            transition: transform 0.3s ease;
        }

        .submenu-toggle.expanded {
            transform: rotate(180deg);
        }

        .submenu-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .submenu-content.expanded {
            max-height: 500px;
        }

        .submenu-body {
            padding: 1rem;
        }

        /* Estilos espec√≠ficos para anexos */
        .anexos-submenu .submenu-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .anexos-submenu .submenu-header:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        /* Estilos espec√≠ficos para hist√≥rico */
        .historico-submenu .submenu-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .historico-submenu .submenu-header:hover {
            background: linear-gradient(135deg, #ee82f0 0%, #f3455a 100%);
        }

        /* Valida√ß√£o de etapas */
        .etapa-validation {
            background: linear-gradient(135deg, rgba(253, 126, 20, 0.1) 0%, rgba(255, 206, 84, 0.1) 100%);
            border: 2px solid #fd7e14;
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1rem 0;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(253, 126, 20, 0.2);
            animation: slideInUp 0.3s ease;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .validation-title {
            color: #856404;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .validation-message {
            color: #856404;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .validation-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn-validation {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
            flex: 0 1 auto;
            min-width: 140px;
        }

        .btn-validation::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }

        .btn-validation:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-validation.primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }

        .btn-validation.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }

        .btn-validation.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-validation.success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .btn-validation.danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .btn-validation.danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        }

        /* Modal de Anexos */
        .modal-anexos {
            max-width: 600px;
        }

        /* Estilos para Modal de Motoristas */
        .motoristas-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .motorista-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .motorista-item:hover {
            background: #f8f9fa;
            border-color: #007bff;
            transform: translateY(-2px);
        }

        .motorista-info {
            flex: 1;
        }

        .motorista-nome {
            font-weight: 600;
            color: var(--cinza-escuro);
            margin-bottom: 0.25rem;
        }

        .motorista-detalhes {
            display: flex;
            gap: 1rem;
            font-size: 0.8rem;
            color: #6c757d;
        }

        .motorista-detalhes span {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .motorista-status {
            margin-left: 1rem;
        }

        /* Estilos para formul√°rio de motorista */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            font-weight: 600;
            color: var(--cinza-escuro);
            margin-bottom: 0.5rem;
            display: block;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .row {
            display: flex;
            gap: 1rem;
        }

        .col-md-6 {
            flex: 1;
        }

        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 1.5rem;
        }

        .upload-area:hover {
            border-color: var(--azul-escuro);
            background: #e9ecef;
        }

        .upload-area.dragover {
            border-color: var(--verde);
            background: #d4edda;
        }

        .upload-icon {
            font-size: 3rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }

        .upload-text h5 {
            color: var(--azul-escuro);
            margin-bottom: 0.5rem;
        }

        .upload-text p {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .file-types {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .file-type-badge {
            padding: 0.3rem 0.6rem;
            background: var(--azul-escuro);
            color: var(--branco);
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .selected-files {
            margin-top: 1.5rem;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem;
            background: var(--branco);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid #e9ecef;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            flex: 1;
        }

        .file-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: var(--cinza-escuro);
            font-size: 0.9rem;
        }

        .file-size {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .file-remove {
            background: var(--vermelho);
            color: var(--branco);
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .file-remove:hover {
            transform: scale(1.1);
        }

        .upload-progress {
            margin-top: 1rem;
            display: none;
        }

        .progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-success);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.8rem;
            color: #6c757d;
            text-align: center;
        }

        /* Modal de Chat */
        .modal-chat {
            max-width: 800px;
            height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: var(--gradient-primary);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .chat-info {
            display: flex;
            flex-direction: column;
        }

        .chat-coleta-id {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .chat-cliente {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .chat-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .chat-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
        }

        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            max-width: 80%;
            padding: 1rem;
            border-radius: 18px;
            position: relative;
            animation: messageAppear 0.3s ease;
        }

        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            align-self: flex-end;
            background: var(--gradient-primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.received {
            align-self: flex-start;
            background: white;
            color: var(--cinza-escuro);
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
        }

        .message-sender {
            font-weight: 600;
        }

        .message-time {
            opacity: 0.7;
        }

        .message-content {
            line-height: 1.4;
        }

        .chat-input-container {
            padding: 1.5rem;
            background: white;
            border-top: 1px solid #e9ecef;
            border-radius: 0 0 12px 12px;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 1rem;
            align-items: end;
        }

        .chat-input {
            flex: 1;
            padding: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 24px;
            resize: none;
            font-family: inherit;
            font-size: 0.9rem;
            transition: var(--transition);
            max-height: 120px;
            min-height: 50px;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--azul-escuro);
            box-shadow: 0 0 0 3px rgba(0, 39, 118, 0.1);
        }

        .chat-send {
            background: var(--gradient-primary);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .chat-send:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 39, 118, 0.3);
        }

        .chat-send:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Bot√µes Flutuantes */
        .floating-action-buttons {
            position: fixed;
            bottom: 2.5rem;
            right: 2.5rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .fab-main {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: var(--gradient-primary);
            border: none;
            color: var(--branco);
            font-size: 1.8rem;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(0, 39, 118, 0.4);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab-main:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 12px 35px rgba(0, 39, 118, 0.6);
        }

        .fab-secondary {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-danger);
            border: none;
            color: var(--branco);
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(198, 12, 48, 0.4);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab-secondary:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(198, 12, 48, 0.6);
        }

        /* Footer */
        .main-footer {
            text-align: center;
            padding: 3rem 2rem;
            margin-top: 4rem;
            background: var(--azul-escuro);
            color: var(--branco);
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
            position: relative;
            overflow: hidden;
            z-index: 0; /* Garantir que fique atr√°s dos cards do Kanban */
        }

        .main-footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23ffffff" fill-opacity="0.05" d="M0,96L48,112C96,128,192,160,288,186.7C384,213,480,235,576,213.3C672,192,768,128,864,128C960,128,1056,192,1152,197.3C1248,203,1344,149,1392,122.7L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>');
            background-size: cover;
        }

        .footer-content {
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            z-index: 1; /* Manter z-index para ficar acima do ::before */
        }

        .footer-logo {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
        }

        /* Notifica√ß√µes */
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1.2rem 1.8rem;
            border-radius: 12px;
            color: var(--branco);
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: var(--transition);
            max-width: 400px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success { 
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.9) 0%, rgba(33, 136, 56, 0.9) 100%);
        }
        .notification.error { 
            background: linear-gradient(135deg, rgba(198, 12, 48, 0.9) 0%, rgba(166, 10, 40, 0.9) 100%);
        }
        .notification.info { 
            background: linear-gradient(135deg, rgba(0, 39, 118, 0.9) 0%, rgba(0, 29, 87, 0.9) 100%);
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }

            .coletas-grid {
                grid-template-columns: 1fr;
            }

            .filters-row {
                flex-direction: column;
            }

            .filter-group {
                min-width: auto;
            }

            .date-filters {
                flex-direction: column;
            }

            .date-filter-group {
                min-width: auto;
            }

            .stats-container {
                justify-content: center;
            }

            .modal-content {
                margin: 1rem;
                padding: 1.5rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .floating-action-buttons {
                bottom: 1.5rem;
                right: 1.5rem;
            }

            .fab-main {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }

            .fab-secondary {
                width: 50px;
                height: 50px;
                font-size: 1.3rem;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .status-section {
                flex-direction: row;
                align-items: center;
                width: 100%;
                justify-content: space-between;
                margin-top: 0.5rem;
            }

            .message {
                max-width: 90%;
            }
            
            .validation-actions {
                flex-direction: column;
            }
            
            .btn-validation {
                width: 100%;
                justify-content: center;
            }
        }

        /* ========== ESTILOS DE VALIDA√á√ÉO ========== */
        .field-input-error {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        }

        .field-error {
            color: #dc3545;
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            position: relative;
        }

        .form-group .field-error {
            position: absolute;
            bottom: -1.25rem;
            left: 0;
            z-index: 10;
        }

        /* ========== ESTILOS DE MULTI-SELECT - Otimizado ========== */
        .multi-select-wrapper {
            position: relative;
            width: 100%;
        }

        .multi-select-button {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            align-items: center;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--cinza-escuro);
            transition: all 0.2s ease;
        }

        .multi-select-button:hover {
            border-color: var(--azul-escuro);
            box-shadow: 0 2px 8px rgba(0, 39, 118, 0.1);
            transform: translateY(-1px);
        }
        
        .multi-select-wrapper.active .multi-select-button {
            border-color: var(--azul-escuro);
            box-shadow: 0 0 0 3px rgba(0, 39, 118, 0.1);
        }

        .multi-select-button i {
            transition: transform 0.3s;
        }

        .multi-select-wrapper.active .multi-select-button i {
            transform: rotate(180deg);
        }

        .multi-select-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--azul-escuro);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 39, 118, 0.05);
            z-index: 1000;
            max-height: 280px;
            overflow-y: auto;
            display: none;
            margin-top: 2px;
        }

        .multi-select-wrapper.active .multi-select-dropdown {
            display: block;
        }

        .multi-select-search {
            padding: 0.5rem;
            font-size: 0.8rem;
            border-bottom: 1px solid #e9ecef;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .multi-select-search input {
            width: 100%;
            padding: 0.5rem 0.8rem;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }
        
        .multi-select-search input:focus {
            outline: none;
            border-color: var(--azul-escuro);
            box-shadow: 0 0 0 3px rgba(0, 39, 118, 0.1);
        }

        .multi-select-options {
            padding: 0.4rem 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .multi-select-option {
            display: flex;
            align-items: center;
            padding: 0.4rem 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .multi-select-option:hover {
            background: rgba(0, 39, 118, 0.05);
        }
        
        .multi-select-option input[type="checkbox"]:checked + span {
            font-weight: 600;
            color: var(--azul-escuro);
        }

        .multi-select-option.hidden {
            display: none;
        }

        .multi-select-option input[type="checkbox"] {
            margin-right: 0.5rem;
            cursor: pointer;
        }

        .multi-select-option span {
            flex: 1;
            font-size: 0.8rem;
        }

        /* ========== ESTILOS DE ACESSIBILIDADE ========== */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Foco vis√≠vel para navega√ß√£o por teclado */
        *:focus-visible {
            outline: 3px solid #667eea;
            outline-offset: 2px;
            border-radius: 4px;
        }

        /* Indicador de foco para elementos interativos */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible,
        a:focus-visible {
            outline: 3px solid #667eea;
            outline-offset: 2px;
        }

        /* Melhorar contraste para leitores de tela */
        [aria-invalid="true"] {
            border-color: #dc3545 !important;
        }

        [aria-invalid="true"]:focus {
            outline-color: #dc3545;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="main-header">
        <div class="header-content">
            <div>
                <h1 class="header-title">
                    <i class="fas fa-truck-loading"></i> Sistema de Coletas
                </h1>
                <p class="header-subtitle">Gest√£o completa de opera√ß√µes log√≠sticas</p>
            </div>
            <div class="header-actions">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">US</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Carregando...</div>
                        <div class="user-role" id="userRole">Usu√°rio</div>
        </div>
                </div>
                <a href="historico_coletas.html" class="btn-modern" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="fas fa-history"></i> Hist√≥rico
                </a>
                <a href="portal.html" class="btn-modern">
                    <i class="fas fa-home"></i> Voltar ao Portal
                </a>
            </div>
                </div>
    </header>

    <!-- Conte√∫do Principal -->
    <div class="main-container">
        <!-- Controles e Filtros -->
        <div class="controls-container">
            <!-- Filtros de Data -->
            <div class="date-filters">
                <div class="date-filter-group">
                    <label for="dataInicio"><i class="fas fa-calendar-alt"></i> Data In√≠cio</label>
                    <input type="date" id="dataInicio" onchange="filterColetas()">
            </div>
                <div class="date-filter-group">
                    <label for="dataFim"><i class="fas fa-calendar-alt"></i> Data Fim</label>
                    <input type="date" id="dataFim" onchange="filterColetas()">
                </div>
                <div class="date-filter-group">
                    <label><i class="fas fa-bolt"></i> Per√≠odo R√°pido</label>
                    <div class="quick-date-buttons">
                        <button class="quick-date-btn" onclick="setQuickDate('hoje')">Hoje</button>
                        <button class="quick-date-btn" onclick="setQuickDate('semana')">Esta Semana</button>
                        <button class="quick-date-btn" onclick="setQuickDate('mes')">Este M√™s</button>
                        <button class="quick-date-btn" onclick="setQuickDate('trimestre')">Este Trimestre</button>
                        <button class="quick-date-btn" onclick="clearDateFilters()">Limpar</button>
                </div>
            </div>
        </div>

            <div class="filters-row">
                <div class="filter-group">
                    <label><i class="fas fa-filter"></i> Status</label>
                    <div class="multi-select-wrapper">
                        <button type="button" class="multi-select-button" id="statusFilterButton" onclick="toggleMultiSelect('statusFilter')">
                            <span id="statusFilterText">Todos os Status</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="multi-select-dropdown" id="statusFilterDropdown">
                            <div class="multi-select-search">
                                <input type="text" placeholder="Buscar status..." onkeyup="filterMultiSelectOptions(this, 'statusFilterOptions')">
                            </div>
                            <div class="multi-select-options" id="statusFilterOptions">
                                <label class="multi-select-option">
                                    <input type="checkbox" value="" onchange="updateMultiSelect('statusFilterOptions', this)" checked>
                                    <span>Todos os Status</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="pendente" onchange="updateMultiSelect('statusFilterOptions', this)">
                                    <span>Pendente</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="em_andamento" onchange="updateMultiSelect('statusFilterOptions', this)">
                                    <span>Em Andamento</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="concluida" onchange="updateMultiSelect('statusFilterOptions', this)">
                                    <span>Conclu√≠da</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="cancelada" onchange="updateMultiSelect('statusFilterOptions', this)">
                                    <span>Cancelada</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-group">
                    <label><i class="fas fa-layer-group"></i> Etapa</label>
                    <div class="multi-select-wrapper">
                        <button type="button" class="multi-select-button" id="etapaFilterButton" onclick="toggleMultiSelect('etapaFilter')">
                            <span id="etapaFilterText">Todas as Etapas</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="multi-select-dropdown" id="etapaFilterDropdown">
                            <div class="multi-select-search">
                                <input type="text" placeholder="Buscar etapa..." onkeyup="filterMultiSelectOptions(this, 'etapaFilterOptions')">
                            </div>
                            <div class="multi-select-options" id="etapaFilterOptions">
                                <label class="multi-select-option">
                                    <input type="checkbox" value="" onchange="updateMultiSelect('etapaFilterOptions', this)" checked>
                                    <span>Todas as Etapas</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="comercial" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>Comercial</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="price" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>Price</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="cs" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>CS</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="contratacao" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>Contrata√ß√£o</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="gr" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>GR</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="documentacao" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>Documenta√ß√£o</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="controladoria" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>Controladoria</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="ti" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>TI</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="contas_pagar" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>Contas a Pagar</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="contas_receber" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>Contas a Receber</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="monitoramento" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>Monitoramento</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="servicos_adicionais" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>Servi√ßos Adicionais</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="finalizar_operacao" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>Finalizar Opera√ß√£o</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-group">
                    <label><i class="fas fa-building"></i> Filial</label>
                    <div class="multi-select-wrapper">
                        <button type="button" class="multi-select-button" id="filialFilterButton" onclick="toggleMultiSelect('filialFilter')">
                            <span id="filialFilterText">Todas as Filiais</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="multi-select-dropdown" id="filialFilterDropdown">
                            <div class="multi-select-search">
                                <input type="text" placeholder="Buscar filial..." onkeyup="filterMultiSelectOptions(this, 'filialFilterOptions')">
                            </div>
                            <div class="multi-select-options" id="filialFilterOptions">
                                <label class="multi-select-option">
                                    <input type="checkbox" value="" onchange="updateMultiSelect('filialFilterOptions', this)" checked>
                                    <span>Todas as Filiais</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="JBO" onchange="updateMultiSelect('filialFilterOptions', this)">
                                    <span>Jaboat√£o</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="CABO" onchange="updateMultiSelect('filialFilterOptions', this)">
                                    <span>CABO</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="AL" onchange="updateMultiSelect('filialFilterOptions', this)">
                                    <span>Alagoas</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="SP" onchange="updateMultiSelect('filialFilterOptions', this)">
                                    <span>S√£o Paulo</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="BA" onchange="updateMultiSelect('filialFilterOptions', this)">
                                    <span>Bahia</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="CE" onchange="updateMultiSelect('filialFilterOptions', this)">
                                    <span>Cear√°</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="SE" onchange="updateMultiSelect('filialFilterOptions', this)">
                                    <span>Sergipe</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="PB" onchange="updateMultiSelect('filialFilterOptions', this)">
                                    <span>Para√≠ba</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="PE" onchange="updateMultiSelect('filialFilterOptions', this)">
                                    <span>Recife</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="AMBEV" onchange="updateMultiSelect('filialFilterOptions', this)">
                                    <span>Ambev</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="US" onchange="updateMultiSelect('filialFilterOptions', this)">
                                    <span>Usinas</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="PARATIBE" onchange="updateMultiSelect('filialFilterOptions', this)">
                                    <span>Paratibe</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-group">
                    <label for="searchFilter"><i class="fas fa-search"></i> Buscar</label>
                    <input type="text" id="searchFilter" placeholder="Cliente, origem, destino, n¬∫ da coleta, filial..." onkeyup="filterColetas()">
                </div>
                </div>
            
            <div class="stats-container">
                <div class="stat-card" style="background: var(--gradient-primary);">
                    <div>
                        <div class="stat-number" id="totalColetas">0</div>
                        <div class="stat-value" id="totalColetasValor">R$ 0,00</div>
                    </div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-card" style="background: var(--gradient-danger);">
                    <div>
                        <div class="stat-number" id="pendentesCount">0</div>
                        <div class="stat-value" id="pendentesValor">R$ 0,00</div>
                    </div>
                    <div class="stat-label">Pendentes</div>
                </div>
                <div class="stat-card" style="background: var(--gradient-warning);">
                    <div>
                        <div class="stat-number" id="andamentoCount">0</div>
                        <div class="stat-value" id="andamentoValor">R$ 0,00</div>
                    </div>
                    <div class="stat-label">Em Andamento</div>
                </div>
                <div class="stat-card" style="background: var(--gradient-success);">
                    <div>
                        <div class="stat-number" id="concluidasCount">0</div>
                        <div class="stat-value" id="concluidasValor">R$ 0,00</div>
                    </div>
                    <div class="stat-label">Conclu√≠das</div>
                </div>
                <div class="stat-card" style="background: var(--gradient-purple);">
                    <div>
                        <div class="stat-number" id="canceladasCount">0</div>
                        <div class="stat-value" id="canceladasValor">R$ 0,00</div>
                    </div>
                    <div class="stat-label">Canceladas</div>
                </div>
            </div>
        </div>

        <!-- Controles de Visualiza√ß√£o -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin: 0.3rem 0; padding: 0 0.4rem;">
            <h2 style="margin: 0; color: #667eea; font-size: 0.9rem; font-weight: 700; letter-spacing: -0.3px;">
                <i class="fas fa-tasks" style="margin-right: 0.4rem;"></i> Coletas
            </h2>
            <div style="display: flex; gap: 0.4rem; background: rgba(102, 126, 234, 0.1); padding: 0.2rem; border-radius: 8px;">
                <button id="btnViewGrid" onclick="alternarVisualizacao('grid')" 
                        style="padding: 0.4rem 0.75rem; border: none; border-radius: 6px; background: transparent; color: #667eea; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: all 0.3s;">
                    <i class="fas fa-th"></i> Grid
                </button>
                <button id="btnViewKanban" onclick="alternarVisualizacao('kanban')" 
                        style="padding: 0.4rem 0.75rem; border: none; border-radius: 6px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: all 0.3s;">
                    <i class="fas fa-columns"></i> Kanban
                </button>
        </div>
        </div>

        <!-- Grid de Coletas -->
        <div class="coletas-grid" id="coletasGrid" style="display: none;">
            <!-- Cards ser√£o gerados dinamicamente via JavaScript -->
        </div>

        <!-- Kanban de Coletas -->
        <div class="kanban-container" id="kanbanContainer" style="display: block;">
            <!-- Controles de Navega√ß√£o -->
            <div class="kanban-navigation" id="kanbanNavigation">
                <div class="kanban-nav-buttons">
                    <button class="kanban-nav-btn" id="kanbanNavPrev" title="Etapa anterior">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="kanban-nav-btn" id="kanbanNavNext" title="Pr√≥xima etapa">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="kanban-stages-indicator" id="kanbanStagesIndicator">
                    <!-- Indicadores de etapas ser√£o gerados dinamicamente -->
                </div>
                <div class="kanban-stages-info" id="kanbanStagesInfo">
                    <!-- Informa√ß√£o de etapas ser√° gerada dinamicamente -->
                </div>
            </div>
            <div class="kanban-board-wrapper">
                <div class="kanban-board" id="kanbanBoard">
                    <!-- Colunas ser√£o geradas dinamicamente via JavaScript -->
                </div>
            </div>
        </div>

        <!-- Drawer do Kanban (Workspace) -->
        <div class="kanban-drawer" id="kanbanDrawer">
            <div class="kanban-drawer-overlay" onclick="fecharKanbanDrawer()"></div>
            <div class="kanban-drawer-content" id="kanbanDrawerContent">
                <!-- Conte√∫do ser√° carregado dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Modal de Detalhes da Coleta -->
    <div class="modal-overlay" id="coletaModal" 
         role="dialog" 
         aria-modal="true" 
         aria-labelledby="modalTitle"
         aria-describedby="modalDescription"
         tabindex="-1">
            <div class="modal-content" role="document">
                <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">
                    <i class="fas fa-truck-loading" aria-hidden="true"></i>
                    <span>Nova Coleta</span>
                </h2>
                <div id="modalDescription" class="sr-only">Formul√°rio para criar ou editar uma coleta</div>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button type="button" id="toggleModoLote" class="action-btn secondary" onclick="alternarModoCriacao()" 
                            aria-label="Alternar modo de cria√ß√£o" 
                            aria-pressed="false"
                            style="font-size: 0.85rem; padding: 0.4rem 0.8rem;"
                            tabindex="0">
                        <i class="fas fa-layer-group" aria-hidden="true"></i> <span id="modoTexto">Criar M√∫ltiplas</span>
                    </button>
                <button class="close-modal" onclick="closeModal()" 
                        aria-label="Fechar modal" 
                        aria-controls="coletaModal"
                        tabindex="0">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
                </div>
                </div>
            
            <form id="coletaForm" role="form" aria-label="Formul√°rio de coleta" novalidate>
                <div class="form-grid">
                    <div class="form-group full-width" style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-bottom: 0;">
                            <input type="checkbox" id="diaria" name="diaria" style="width: 20px; height: 20px; cursor: pointer;" onchange="toggleCamposObrigatorios()">
                            <span style="font-weight: 600; color: #0ea5e9; font-size: 1rem;">
                                <i class="fas fa-calendar-day"></i> Di√°ria
                            </span>
                        </label>
                        <small style="display: block; margin-top: 0.5rem; color: #6c757d; font-size: 0.85rem; margin-left: 28px;">
                            Marque esta op√ß√£o se a coleta for do tipo di√°ria. O card ficar√° destacado em azul no Kanban. <strong>Quando marcado, nenhum campo ser√° obrigat√≥rio.</strong>
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="filial">Filial *</label>
                        <select id="filial" name="filial" required 
                                onchange="filtrarClientesPorFilial()"
                                aria-required="true"
                                aria-describedby="filial-error">
                            <option value="">Selecione a filial</option>
                            <option value="JBO">Jaboat√£o (JBO)</option>
                            <option value="CABO">Cabo (CABO)</option>
                            <option value="SP">S√£o Paulo (SP)</option>
                            <option value="BA">Sim√µes Filho (BA)</option>
                            <option value="SE">Aracaju (SE)</option>
                            <option value="AL">Macei√≥ (AL)</option>
                            <option value="PE">Recife (PE)</option>
                            <option value="PB">Jo√£o Pessoa (PB)</option>
                            <option value="CE">Fortaleza (CE)</option>
                            <option value="AMBEV">Ambev (AMBEV)</option>
                            <option value="US">Usinas (US)</option>
                            <option value="PARATIBE">Paratibe (PARATIBE)</option>
                        </select>
                    </div>
                    <div class="form-group" id="grupoNumeroColeta">
                        <label for="numeroColeta">N¬∫ da Coleta *</label>
                        <input type="text" id="numeroColeta" name="numeroColeta" 
                               placeholder="Ex: 5565" 
                               required 
                               pattern="[1-9][0-9]*" 
                               title="Digite apenas n√∫meros, sem zeros √† esquerda (ex: 5565)" 
                               oninput="this.value = this.value.replace(/^0+/, '').replace(/[^0-9]/g, '')"
                               aria-required="true"
                               aria-describedby="numeroColeta-error numeroColeta-help"
                               aria-invalid="false">
                        <div id="numeroColeta-help" class="sr-only">Digite apenas n√∫meros, sem zeros √† esquerda. Exemplo: 5565</div>
                                </div>
                    <div class="form-group" id="grupoMultiplosNumeros" style="display: none;">
                        <label for="multiplosNumeros">
                            <i class="fas fa-list-ol"></i> N√∫meros das Coletas *
                            <span style="font-size: 0.75rem; color: #6c757d; font-weight: normal; display: block; margin-top: 0.2rem;">
                                Separe por v√≠rgula ou use intervalo (ex: 5565,5566,5567 ou 5565-5569)
                            </span>
                        </label>
                        <textarea id="multiplosNumeros" name="multiplosNumeros" rows="3" placeholder="Ex: 5565,5566,5567,5568,5569&#10;Ou: 5565-5569" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-family: inherit; resize: vertical;" oninput="processarMultiplosNumeros()"></textarea>
                        <div id="previewNumeros" style="margin-top: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 6px; font-size: 0.85rem; color: #495057; display: none;">
                            <strong>Ser√£o criadas <span id="totalColetas">0</span> coleta(s):</strong>
                            <div id="listaNumeros" style="margin-top: 0.3rem; max-height: 100px; overflow-y: auto;"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="cliente">Cliente *</label>
                        <select id="cliente" name="cliente" required disabled>
                            <option value="">Selecione primeiro a filial</option>
                        </select>
                            </div>
                    <div class="form-group">
                        <label for="dataRecebimento">Data de Coleta *</label>
                        <input type="date" id="dataRecebimento" name="dataRecebimento" required>
                                </div>
                    <div class="form-group">
                        <label for="dataEntrega">Data de Entrega *</label>
                        <input type="date" id="dataEntrega" name="dataEntrega" required>
                                </div>
                    <div class="form-group">
                        <label for="origem">Origem *</label>
                        <input type="text" id="origem" name="origem" placeholder="Cidade - UF" required>
                            </div>
                    <div class="form-group">
                        <label for="destino">Destino *</label>
                        <input type="text" id="destino" name="destino" placeholder="Cidade - UF" required>
                        </div>
                    <div class="form-group">
                        <label for="valor">Valor CTE (R$) *</label>
                        <input type="number" id="valor" name="valor" step="0.01" min="0" placeholder="0,00" required>
                                </div>
                    <div class="form-group">
                        <label for="freteMotorista">Frete Motorista (R$) *</label>
                        <input type="number" id="freteMotorista" name="freteMotorista" step="0.01" min="0" placeholder="0,00" required>
                            </div>
                    <div class="form-group">
                        <label for="km">KM *</label>
                        <input type="number" id="km" name="km" step="0.1" min="0" placeholder="0" required>
                            </div>
                    <div class="form-group">
                        <label for="classeVeiculo">
                            <i class="fas fa-layer-group" aria-hidden="true"></i> Classe do Ve√≠culo *
                        </label>
                        <select id="classeVeiculo" name="classeVeiculo" 
                                required 
                                onchange="atualizarTiposVeiculoECarroceria()"
                                aria-required="true"
                                aria-describedby="classeVeiculo-error classeVeiculo-help"
                                aria-controls="tiposVeiculoContainer tiposCarroceriaContainer">
                            <option value="">Selecione a classe</option>
                            <option value="leve">Leve</option>
                            <option value="medio">M√©dio</option>
                            <option value="pesado">Pesado</option>
                        </select>
                        <div id="classeVeiculo-help" class="sr-only">Selecione a classe do ve√≠culo para filtrar os tipos dispon√≠veis</div>
                            <option value="">Selecione a classe</option>
                            <option value="leve">Leve</option>
                            <option value="medio">M√©dio</option>
                            <option value="pesado">Pesado</option>
                        </select>
                            </div>
                    <div class="form-group full-width">
                        <label style="margin-bottom: 0.8rem; display: block; font-weight: 600;">
                            <i class="fas fa-truck"></i> Tipos de Ve√≠culo *
                        </label>
                        <div id="tiposVeiculoContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.8rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                            <p style="grid-column: 1 / -1; text-align: center; color: #6c757d; margin: 0;">Selecione primeiro a classe do ve√≠culo</p>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label style="margin-bottom: 0.8rem; display: block; font-weight: 600;">
                            <i class="fas fa-box"></i> Tipos de Carroceria *
                        </label>
                        <div id="tiposCarroceriaContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.8rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                            <p style="grid-column: 1 / -1; text-align: center; color: #6c757d; margin: 0;">Selecione primeiro a classe do ve√≠culo</p>
                        </div>
                                </div>
                    <div class="form-group">
                        <label for="status"><i class="fas fa-flag me-2"></i>Status</label>
                        <select id="status" name="status">
                            <option value="pendente">Pendente</option>
                            <option value="em_andamento">Em Andamento</option>
                            <option value="concluida">Conclu√≠da</option>
                            <option value="cancelada">Cancelada</option>
                        </select>
                            </div>
                    <div class="form-group">
                        <label for="prioridade"><i class="fas fa-exclamation-triangle me-2" style="color: #f59e0b;"></i>Prioridade</label>
                        <select id="prioridade" name="prioridade" style="border-left: 3px solid #f59e0b;">
                            <option value="baixa">Baixa</option>
                            <option value="normal" selected>Normal</option>
                            <option value="alta">Alta</option>
                            <option value="urgente">Urgente</option>
                        </select>
                            </div>
                    <div class="form-group">
                        <label for="etapaAtual"><i class="fas fa-layer-group me-2"></i>Etapa Atual</label>
                        <select id="etapaAtual" name="etapaAtual">
                            <option value="comercial">Comercial</option>
                            <option value="price">Price</option>
                            <option value="cs">CS</option>
                            <option value="contratacao">Contrata√ß√£o</option>
                            <option value="gr">GR</option>
                            <option value="documentacao">Documenta√ß√£o</option>
                            <option value="controladoria">Controladoria</option>
                            <option value="ti">TI</option>
                            <option value="contas_pagar">Contas a Pagar</option>
                            <option value="contas_receber">Contas a Receber</option>
                            <option value="monitoramento">Monitoramento</option>
                            <option value="finalizar_operacao">Finalizar Opera√ß√£o</option>
                        </select>
                        </div>
                    <div class="form-group full-width">
                        <label for="observacoes">Observa√ß√µes</label>
                        <textarea id="observacoes" name="observacoes" rows="3" placeholder="Informa√ß√µes adicionais sobre a coleta..."></textarea>
                        </div>
                        </div>
                
                <div class="modal-actions">
                    <button type="button" class="action-btn warning" onclick="closeModal()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="action-btn success">
                        <i class="fas fa-save"></i> Salvar Coleta
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Anexos -->
    <div class="modal-overlay" id="anexosModal">
        <div class="modal-content modal-anexos">
                <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-paperclip"></i>
                    <span id="modalAnexosTitle">Anexos da Coleta</span>
                </h2>
                <button class="close-modal" onclick="closeAnexosModal()">
                    <i class="fas fa-times"></i>
                </button>
                </div>
            
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                <div class="upload-text">
                    <h5>Arraste arquivos aqui ou clique para selecionar</h5>
                    <p>PDF, imagens, Excel, Word (M√°x. 10MB por arquivo)</p>
                                        </div>
                <div class="file-types">
                    <span class="file-type-badge">PDF</span>
                    <span class="file-type-badge">XLS/XLSX</span>
                    <span class="file-type-badge">JPG/PNG</span>
                    <span class="file-type-badge">DOC/DOCX</span>
                                        </div>
                                    </div>
            
            <input type="file" id="fileInput" multiple style="display: none;" 
                   accept=".pdf,.jpg,.jpeg,.png,.xls,.xlsx,.doc,.docx" onchange="handleFileSelect(this.files)">
            
            <!-- Sele√ß√£o de Categoria -->
            <div class="form-group" style="margin: 1.5rem 0;">
                <label for="anexoCategoriaSelect" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">
                    <i class="fas fa-folder"></i> Categoria do Anexo:
                </label>
                <select id="anexoCategoriaSelect" style="width: 100%; padding: 0.8rem; border: 2px solid #e9ecef; border-radius: 10px; font-size: 1rem; background: white;" onchange="toggleTituloContratoModal(this.value)">
                    <option value="">Selecione a categoria</option>
                    <option value="documentos_motorista">üìÑ Documentos do Motorista</option>
                    <option value="documentos_proprietario">üìã Documentos do Propriet√°rio</option>
                    <option value="documentos_veiculo">üöõ Documentos do Ve√≠culo</option>
                    <option value="evidencias">üì∏ Evid√™ncias</option>
                    <option value="faturamento">üí∞ Faturamento</option>
                    <option value="notas_fiscais">üßæ Notas Fiscais</option>
                    <option value="contratos">üìù Contratos</option>
                    <option value="outros">üìÅ Outros</option>
                </select>
                <small style="color: #6c757d; font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                    Organize os documentos por categoria para facilitar a busca
                </small>
                <!-- Campo de t√≠tulo do contrato (aparece apenas quando categoria for contratos) -->
                <div id="tituloContratoContainerModal" style="display: none; margin-top: 1.5rem;">
                    <label for="tituloContratoInputModal" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">
                        <i class="fas fa-file-contract"></i> T√≠tulo do Contrato:
                    </label>
                    <input type="text" 
                           id="tituloContratoInputModal" 
                           placeholder="Ex: Contrato de Presta√ß√£o de Servi√ßos - Cliente XYZ"
                           style="width: 100%; padding: 0.8rem; border: 2px solid #e9ecef; border-radius: 10px; font-size: 1rem; background: white;">
                    <small style="color: #6c757d; font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                        O t√≠tulo ser√° exibido no card principal da coleta
                    </small>
                </div>
            </div>
            
            <div class="selected-files" id="selectedFiles" style="display: none;">
                <h6>Arquivos selecionados:</h6>
                <div id="filesList" class="mt-2"></div>
                                    </div>
            
            <div class="upload-progress" id="uploadProgress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                                    </div>
                <div class="progress-text" id="progressText">0%</div>
                            </div>

            <div class="anexos-list-modal" id="anexosListModal">
                <!-- Lista de anexos ser√° preenchida aqui -->
                                </div>
            
            <div class="modal-actions">
                <button type="button" class="action-btn warning" onclick="closeAnexosModal()">
                    <i class="fas fa-times"></i> Fechar
                </button>
                <button type="button" class="action-btn success" id="btnUpload" onclick="fazerUpload()" disabled>
                    <i class="fas fa-upload"></i> Enviar Arquivos
                                            </button>
                                </div>
                            </div>
                        </div>
                        
    <!-- Modal de Chat -->
    <div class="modal-overlay" id="chatModal">
        <div class="modal-content modal-chat">
            <div class="chat-header">
                <div class="chat-info">
                    <div class="chat-coleta-id" id="chatColetaId">COL-001</div>
                    <div class="chat-cliente" id="chatCliente">Cliente A Ltda</div>
                                </div>
                <button class="chat-close" onclick="closeChatModal()">
                    <i class="fas fa-times"></i>
                                        </button>
                                    </div>
            
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <!-- Mensagens ser√£o carregadas aqui -->
                            </div>

                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea class="chat-input" id="chatInput" placeholder="Digite sua mensagem..." rows="1"></textarea>
                        <button class="chat-send" id="chatSend" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                                </div>
                                    </div>
                                    </div>
                                </div>
                            </div>

    <!-- Modal de Mudan√ßa de Etapa -->
    <div class="modal-overlay" id="moverEtapaModal">
        <div class="modal-content" style="max-width: 480px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-arrows-alt"></i>
                    Mover Etapa da Coleta
                </h2>
                <button class="close-modal" onclick="fecharMoverEtapaModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 0 1.5rem 1.5rem;">
                <p style="font-weight:600; margin-bottom:0.5rem;">Etapa atual: <span id="moverEtapaAtual" style="color:#5a67d8;"></span></p>
                <div class="form-group">
                    <label for="novaEtapaSelect">Escolha a nova etapa</label>
                    <select id="novaEtapaSelect">
                        <option value="">Selecione a etapa</option>
                    </select>
                </div>
                <p style="font-size:0.85rem; color:#6c757d; margin-top:0.5rem;">
                    Apenas usu√°rios com permiss√£o na etapa atual podem mover a oportunidade. A mudan√ßa √© registrada automaticamente no hist√≥rico.
                </p>
            </div>
            <div class="modal-actions">
                <button type="button" class="action-btn warning" onclick="fecharMoverEtapaModal()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="action-btn secondary" onclick="confirmarMoverEtapa()">
                    <i class="fas fa-check"></i> Confirmar
                </button>
                                    </div>
                                </div>
                            </div>

    <!-- Modal de Tipo de Pagamento para Contas a Pagar -->
    <div class="modal-overlay" id="modalTipoPagamento" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-money-bill-wave"></i>
                    Tipo de Pagamento
                </h2>
                <button class="close-modal" onclick="fecharModalTipoPagamento()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <p style="color: #6c757d; margin-bottom: 1.5rem;">
                    √â obrigat√≥rio informar o tipo de pagamento ao mover para a etapa <strong>Contas a Pagar</strong>.
                </p>
                <div class="form-group">
                    <label for="tipoPagamentoSelect"><i class="fas fa-list"></i> Selecione o tipo de pagamento:</label>
                    <select id="tipoPagamentoSelect" style="width: 100%; padding: 0.8rem; border: 2px solid #e9ecef; border-radius: 10px; font-size: 1rem;">
                        <option value="">Selecione o tipo de pagamento</option>
                        <option value="GNRE">GNRE</option>
                        <option value="PED√ÅGIO">PED√ÅGIO</option>
                        <option value="GNRE + PED√ÅGIO">GNRE + PED√ÅGIO</option>
                        <option value="ADIANTAMENTO">ADIANTAMENTO</option>
                        <option value="SALDO">SALDO</option>
                        <option value="PAGAMENTO DE FRETE TOTAL">PAGAMENTO DE FRETE TOTAL</option>
                    </select>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="action-btn warning" onclick="fecharModalTipoPagamento()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="action-btn secondary" onclick="confirmarTipoPagamento()">
                    <i class="fas fa-check"></i> Confirmar
                </button>
                                    </div>
                                </div>
                            </div>

    <!-- Modal de Hist√≥rico Completo -->
    <div class="modal-overlay" id="modalHistoricoCompleto" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto; background: white; border-radius: 20px; padding: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 2px solid #e9ecef; padding-bottom: 1rem;">
                <h2 style="color: #667eea; margin: 0;">
                    <i class="fas fa-history"></i> Hist√≥rico Completo de Movimenta√ß√µes
                </h2>
                <button onclick="fecharModalHistoricoCompleto()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; padding: 0.5rem;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="conteudoHistoricoCompleto"></div>
                                </div>
                            </div>

    <!-- Bot√µes Flutuantes -->
    <div class="floating-action-buttons">
        <button class="fab-secondary" onclick="window.location.href='relatorios.html'" title="Relat√≥rios">
            <i class="fas fa-chart-bar"></i>
        </button>
        <button class="fab-main" onclick="openNewColetaModal()" title="Nova Coleta">
            <i class="fas fa-plus"></i>
        </button>
                        </div>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="footer-content">
            <div class="footer-logo">
                <i class="fas fa-truck-moving"></i> Multi Modal
                    </div>
            <p>Sistema de Gest√£o de Opera√ß√µes Log√≠sticas</p>
            <p>¬© 2025 - Todos os direitos reservados</p>
                </div>
    </footer>

    <!-- Notifica√ß√£o -->
    <div id="notification" class="notification"></div>

    <script>
        // ========== FUN√á√ïES GLOBAIS (DEVEM ESTAR PRIMEIRO) ==========
        // Fun√ß√µes chamadas do HTML precisam estar dispon√≠veis antes do HTML ser renderizado
        
        // Fun√ß√£o global para limpar filtros de data
        function clearDateFilters() {
            if (document.getElementById('dataInicio')) {
                document.getElementById('dataInicio').value = '';
                document.getElementById('dataFim').value = '';
                document.querySelectorAll('.quick-date-btn').forEach(btn => btn.classList.remove('active'));
                if (typeof filterColetas === 'function') {
                    filterColetas();
                }
            }
        }
        window.clearDateFilters = clearDateFilters;
        
        // Fun√ß√£o global para abrir modal de nova coleta
        // Fun√ß√£o stub tempor√°ria - ser√° redefinida mais abaixo com implementa√ß√£o completa
        // Esta fun√ß√£o precisa existir antes do HTML ser renderizado
        function openNewColetaModal() {
            // Se a implementa√ß√£o completa j√° foi carregada, usar ela
            if (window._openNewColetaModalImpl) {
                window._openNewColetaModalImpl();
            } else {
                // Aguardar um pouco e tentar novamente
                setTimeout(() => {
                    if (window._openNewColetaModalImpl) {
                        window._openNewColetaModalImpl();
                    } else {
                        console.error('openNewColetaModal: implementa√ß√£o n√£o encontrada');
                    }
                }, 100);
            }
        }
        window.openNewColetaModal = openNewColetaModal;
        
        // ========== CONFIGURA√á√ÉO SUPABASE ==========
        // IMPORTANTE: window.supabase √© a biblioteca do CDN (@supabase/supabase-js@2)
        // N√ÉO declarar 'supabase' como vari√°vel - usar window.supabase para a biblioteca
        // Usar vari√°vel local para evitar conflitos com scripts externos
        let supabaseClient = null; // Renomeado para evitar conflito com poss√≠vel vari√°vel global do Supabase
        
        async function inicializarSupabase() {
            try {
                console.log('üîß Inicializando Supabase...');
                
                // Se j√° foi inicializado por permissions.js, usar o existente
                if (window.supabaseClient && typeof window.supabaseClient.from === 'function') {
                    console.log('‚úÖ Usando Supabase j√° inicializado por permissions.js');
                    supabaseClient = window.supabaseClient;
                    return true;
                }
                
                // Buscar configura√ß√£o do servidor
                const response = await fetch('/api/supabase-config');
                if (!response.ok) {
                    throw new Error('Erro ao buscar configura√ß√£o do Supabase');
                }
                
                const config = await response.json();
                
                // ‚úÖ SEGURAN√áA: N√£o logar informa√ß√µes sens√≠veis em produ√ß√£o
                // A anon key √© p√∫blica por design, mas √© melhor n√£o expor no console
                if (window.DEBUG || window.location.hostname === 'localhost') {
                    // Em desenvolvimento, logar apenas informa√ß√µes n√£o sens√≠veis
                    console.log('üìã Configura√ß√£o Supabase:', {
                        supabaseUrl: config.supabaseUrl,
                        baseUrl: config.baseUrl,
                        supabaseAnonKey: config.supabaseAnonKey ? 
                            `${config.supabaseAnonKey.substring(0, 20)}...${config.supabaseAnonKey.substring(config.supabaseAnonKey.length - 10)}` : 
                            'n√£o configurada'
                    });
                }
                
                // Verificar se a biblioteca Supabase est√° carregada
                if (typeof window.supabase === 'undefined') {
                    console.error('‚ùå Biblioteca @supabase/supabase-js n√£o carregada');
                    return false;
                }
                
                // Inicializar cliente Supabase
                // IMPORTANTE: window.supabase √© a biblioteca do CDN, n√£o um cliente
                // Usar window.supabase.createClient() para criar o cliente
                if (typeof window.supabase === 'undefined' || typeof window.supabase.createClient !== 'function') {
                    console.error('‚ùå Biblioteca @supabase/supabase-js n√£o carregada corretamente');
                    return false;
                }
                
                supabaseClient = window.supabase.createClient(config.supabaseUrl, config.supabaseAnonKey);
                // Criar alias global para compatibilidade (usar window.supabaseClient para evitar conflitos)
                window.supabaseClient = supabaseClient;
                // N√ÉO sobrescrever window.supabase - ele √© a biblioteca do CDN
                // Criar alias apenas se necess√°rio para c√≥digo legado
                if (typeof window.supabaseClientInstance === 'undefined') {
                    window.supabaseClientInstance = supabaseClient;
                }
                
                if (window.DEBUG || window.location.hostname === 'localhost') {
                console.log('‚úÖ Supabase inicializado com sucesso!');
                }
                
                // Configurar listener de autentica√ß√£o para detectar sess√µes expiradas
                supabaseClient.auth.onAuthStateChange((event, session) => {
                    // ‚úÖ SEGURAN√áA: N√£o logar eventos de autentica√ß√£o em produ√ß√£o
                    if (window.DEBUG || window.location.hostname === 'localhost') {
                    console.log('üîê Mudan√ßa de autentica√ß√£o detectada:', event);
                    }
                    
                    if (event === 'SIGNED_OUT' || event === 'TOKEN_REFRESHED') {
                        // Limpar cache de token quando sess√£o expira ou √© atualizada
                        supabaseAccessToken = null;
                        supabaseTokenExpiry = 0;
                        
                        if (event === 'SIGNED_OUT') {
                            if (window.DEBUG || window.location.hostname === 'localhost') {
                            console.log('üö™ Sess√£o expirada, redirecionando para login...');
                            }
                            localStorage.removeItem('loggedInUser');
                            window.location.href = 'login.html';
                        } else if (event === 'TOKEN_REFRESHED' && session?.access_token) {
                            // Atualizar token em cache quando for atualizado
                            supabaseAccessToken = session.access_token;
                            supabaseTokenExpiry = session.expires_at ? session.expires_at * 1000 : Date.now() + (60 * 60 * 1000);
                            if (window.DEBUG || window.location.hostname === 'localhost') {
                            console.log('‚úÖ Token atualizado com sucesso');
                            }
                        }
                    }
                });
                
                // Inicializar chat IA ap√≥s Supabase estar pronto
                if (window.inicializarChatIA) {
                    window.inicializarChatIA();
                }
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Erro ao inicializar Supabase:', error);
                mostrarErro('Erro ao conectar com o banco de dados');
                return false;
            }
        }

        // ========== VARI√ÅVEIS GLOBAIS ==========
        let currentUser = null;
        let coletasData = [];
        let currentEditingId = null;
        let currentAnexosColetaId = null;
        let selectedFiles = [];
        let currentChatColetaId = null;
        let supabaseAccessToken = null;
        let supabaseTokenExpiry = 0;
        
        // ========== VARI√ÅVEIS DE PAGINA√á√ÉO ==========
        let paginaAtual = 1;
        const itensPorPagina = 50;
        let coletasFiltradas = [];
        let moverEtapaColetaId = null;

        // ========== UTILIT√ÅRIOS DE SEGURAN√áA E SANITIZA√á√ÉO ==========
        /**
         * Sanitiza strings para prevenir XSS
         * @param {string} str - String a ser sanitizada
         * @returns {string} - String sanitizada
         */
        function sanitizeHTML(str) {
            if (typeof str !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        /**
         * Sanitiza e retorna HTML seguro para inser√ß√£o
         * Para HTML confi√°vel (templates internos), use com cuidado
         * @param {string} html - HTML a ser sanitizado
         * @param {boolean} allowHTML - Se true, permite HTML b√°sico (perigoso se usado com dados do usu√°rio)
         * @returns {string} - HTML sanitizado
         */
        function safeHTML(html, allowHTML = false) {
            if (typeof html !== 'string') return '';
            if (!allowHTML) {
                return sanitizeHTML(html);
            }
            // Para templates internos confi√°veis, apenas remover scripts e eventos
            const temp = document.createElement('div');
            temp.innerHTML = html;
            // Remover scripts e event handlers
            const scripts = temp.querySelectorAll('script');
            scripts.forEach(s => s.remove());
            // Remover atributos de eventos
            const allElements = temp.querySelectorAll('*');
            allElements.forEach(el => {
                Array.from(el.attributes).forEach(attr => {
                    if (attr.name.startsWith('on')) {
                        el.removeAttribute(attr.name);
                    }
                });
            });
            return temp.innerHTML;
        }

        /**
         * Escapa caracteres especiais para uso em atributos HTML
         * @param {string} str - String a ser escapada
         * @returns {string} - String escapada
         */
        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return str.replace(/[&<>"']/g, m => map[m]);
        }

        // ========== SISTEMA CENTRALIZADO DE TRATAMENTO DE ERROS ==========
        class ErrorHandler {
            /**
             * Mapeamento de c√≥digos de erro do Supabase para mensagens amig√°veis
             */
            static errorMessages = {
                // Erros de autentica√ß√£o
                'PGRST301': 'Sess√£o expirada. Fa√ßa login novamente.',
                'PGRST116': 'Registro n√£o encontrado.',
                '23505': 'Este registro j√° existe no sistema.',
                '23503': 'N√£o √© poss√≠vel excluir. Existem registros relacionados.',
                '23502': 'Campo obrigat√≥rio n√£o preenchido.',
                '42703': 'Erro no banco de dados. Coluna n√£o encontrada.',
                '42P01': 'Tabela n√£o encontrada.',
                // Erros de rede
                'NetworkError': 'Erro de conex√£o. Verifique sua internet.',
                'TimeoutError': 'Tempo de espera esgotado. Tente novamente.',
                // Erros gen√©ricos
                'default': 'Ocorreu um erro inesperado. Tente novamente.'
            };

            /**
             * Trata erros de forma centralizada
             * @param {Error} error - Objeto de erro
             * @param {string} context - Contexto onde o erro ocorreu
             * @param {Object} options - Op√ß√µes adicionais
             * @returns {Object} - Informa√ß√µes do erro tratado
             */
            static handle(error, context = 'Sistema', options = {}) {
                const {
                    showNotification: showNotif = true,
                    logToConsole: logConsole = true,
                    retry: shouldRetry = false,
                    retryCallback = null
                } = options;

                // Log estruturado
                if (logConsole) {
                    console.error(`‚ùå [${context}]`, error);
                    
                    // Log detalhado em desenvolvimento
                    if (window.DEBUG || window.location.hostname === 'localhost') {
                        console.error('Detalhes do erro:', {
                            message: error.message,
                            code: error.code,
                            details: error.details,
                            hint: error.hint,
                            stack: error.stack
                        });
                    }
                }

                // Obter mensagem amig√°vel
                const userMessage = this.getUserFriendlyMessage(error);
                
                // Notificar usu√°rio
                if (showNotif) {
                    showNotification(userMessage, 'error', 5000);
                }

                // Retry autom√°tico se configurado
                if (shouldRetry && retryCallback && typeof retryCallback === 'function') {
                    setTimeout(() => {
                        console.log(`üîÑ Tentando novamente ap√≥s erro em ${context}...`);
                        retryCallback();
                    }, 2000);
                }

                // Reportar para servi√ßo de monitoramento (se dispon√≠vel)
                if (window.Sentry) {
                    Sentry.captureException(error, {
                        contexts: { context },
                        tags: { context }
                    });
                }

                return {
                    message: userMessage,
                    code: error.code,
                    originalError: error,
                    context
                };
            }

            /**
             * Obt√©m mensagem amig√°vel para o usu√°rio
             * @param {Error} error - Objeto de erro
             * @returns {string} - Mensagem amig√°vel
             */
            static getUserFriendlyMessage(error) {
                // Verificar c√≥digo de erro espec√≠fico
                if (error.code && this.errorMessages[error.code]) {
                    return this.errorMessages[error.code];
                }

                // Verificar mensagem de erro
                if (error.message) {
                    const message = error.message.toLowerCase();
                    
                    // Erros de rede
                    if (message.includes('network') || message.includes('fetch')) {
                        return this.errorMessages['NetworkError'];
                    }
                    
                    if (message.includes('timeout')) {
                        return this.errorMessages['TimeoutError'];
                    }

                    // Erros de autentica√ß√£o
                    if (message.includes('session') || message.includes('token') || message.includes('unauthorized')) {
                        return this.errorMessages['PGRST301'];
                    }

                    // Erros de n√£o encontrado
                    if (message.includes('not found') || message.includes('n√£o encontrado')) {
                        return this.errorMessages['PGRST116'];
                    }
                }

                // Mensagem padr√£o
                return this.errorMessages['default'];
            }

            /**
             * Wrapper para fun√ß√µes ass√≠ncronas com tratamento de erro autom√°tico
             * @param {Function} asyncFn - Fun√ß√£o ass√≠ncrona
             * @param {string} context - Contexto da opera√ß√£o
             * @param {Object} options - Op√ß√µes de tratamento
             * @returns {Promise} - Promise com tratamento de erro
             */
            static async wrap(asyncFn, context, options = {}) {
                try {
                    return await asyncFn();
                } catch (error) {
                    return this.handle(error, context, options);
                }
            }
        }

        // ========== SISTEMA DE VALIDA√á√ÉO CENTRALIZADO ==========
        class Validator {
            /**
             * Schema de valida√ß√£o para coletas
             */
            static coletaSchema = {
                filial: {
                    required: true,
                    type: 'string',
                    validate: (val) => val && val.trim().length > 0,
                    message: 'Filial √© obrigat√≥ria'
                },
                numero_coleta: {
                    required: true,
                    type: 'string',
                    validate: (val) => {
                        if (!val) return false;
                        const num = parseInt(val, 10);
                        return !isNaN(num) && num > 0 && /^[1-9][0-9]*$/.test(val);
                    },
                    message: 'N√∫mero da coleta deve ser um n√∫mero positivo sem zeros √† esquerda'
                },
                cliente: {
                    required: true,
                    type: 'string',
                    validate: (val) => val && val.trim().length > 0,
                    message: 'Cliente √© obrigat√≥rio'
                },
                data_recebimento: {
                    required: true,
                    type: 'string',
                    validate: (val) => {
                        if (!val) return false;
                        const date = new Date(val);
                        return !isNaN(date.getTime());
                    },
                    message: 'Data de recebimento √© obrigat√≥ria e deve ser v√°lida'
                },
                origem: {
                    required: true,
                    type: 'string',
                    validate: (val) => val && val.trim().length > 0,
                    message: 'Origem √© obrigat√≥ria'
                },
                destino: {
                    required: true,
                    type: 'string',
                    validate: (val) => val && val.trim().length > 0,
                    message: 'Destino √© obrigat√≥rio'
                },
                data_entrega: {
                    required: true,
                    type: 'string',
                    validate: (val) => {
                        if (!val) return false;
                        const date = new Date(val);
                        return !isNaN(date.getTime());
                    },
                    message: 'Data de entrega √© obrigat√≥ria e deve ser v√°lida'
                },
                valor: {
                    required: true,
                    type: 'number',
                    validate: (val) => {
                        const num = parseFloat(val);
                        return !isNaN(num) && num > 0;
                    },
                    message: 'Valor CTE √© obrigat√≥rio e deve ser maior que zero'
                },
                frete_motorista: {
                    required: true,
                    type: 'number',
                    validate: (val) => {
                        const num = parseFloat(val);
                        return !isNaN(num) && num > 0;
                    },
                    message: 'Frete Motorista √© obrigat√≥rio e deve ser maior que zero'
                },
                km: {
                    required: true,
                    type: 'number',
                    validate: (val) => {
                        const num = parseFloat(val);
                        return !isNaN(num) && num > 0;
                    },
                    message: 'KM √© obrigat√≥rio e deve ser maior que zero'
                },
                classeVeiculo: {
                    required: true,
                    type: 'string',
                    validate: (val) => ['leve', 'medio', 'pesado'].includes(val),
                    message: 'Classe do ve√≠culo √© obrigat√≥ria (leve, m√©dio ou pesado)'
                },
                tiposVeiculo: {
                    required: true,
                    type: 'array',
                    validate: (val) => Array.isArray(val) && val.length > 0,
                    message: 'Selecione pelo menos um tipo de ve√≠culo'
                },
                tiposCarroceria: {
                    required: true,
                    type: 'array',
                    validate: (val) => Array.isArray(val) && val.length > 0,
                    message: 'Selecione pelo menos um tipo de carroceria'
                }
            };

            /**
             * Valida dados de coleta
             * @param {Object} data - Dados a serem validados
             * @param {Object} schema - Schema de valida√ß√£o (opcional, usa coletaSchema por padr√£o)
             * @returns {Object} - { valid: boolean, errors: Array }
             */
            static validate(data, schema = this.coletaSchema) {
                const errors = [];

                Object.entries(schema).forEach(([key, rules]) => {
                    const value = data[key];

                    // Verificar obrigatoriedade
                    // Para arrays, verificar se est√° vazio
                    if (rules.required) {
                        let isEmpty = false;
                        if (Array.isArray(value)) {
                            isEmpty = value.length === 0;
                        } else if (rules.type === 'number') {
                            // Para n√∫meros obrigat√≥rios, 0 tamb√©m √© considerado vazio
                            const numValue = parseFloat(value);
                            isEmpty = (value === undefined || value === null || value === '' || isNaN(numValue) || numValue === 0);
                        } else {
                            isEmpty = (value === undefined || value === null || value === '');
                        }
                        
                        if (isEmpty) {
                            errors.push({
                                field: key,
                                message: rules.message || `${key} √© obrigat√≥rio`
                            });
                            return;
                        }
                    }

                    // Se n√£o √© obrigat√≥rio e est√° vazio, pular valida√ß√£o
                    if (!rules.required && (value === undefined || value === null || value === '')) {
                        return;
                    }

                    // Verificar tipo
                    if (rules.type) {
                        const actualType = Array.isArray(value) ? 'array' : typeof value;
                        if (actualType !== rules.type) {
                            errors.push({
                                field: key,
                                message: `${key} deve ser do tipo ${rules.type}`
                            });
                            return;
                        }
                    }

                    // Validar com fun√ß√£o customizada
                    if (rules.validate && typeof rules.validate === 'function') {
                        if (!rules.validate(value)) {
                            errors.push({
                                field: key,
                                message: rules.message || `${key} √© inv√°lido`
                            });
                        }
                    }
                });

                return {
                    valid: errors.length === 0,
                    errors
                };
            }

            /**
             * Valida e mostra erros inline no formul√°rio
             * @param {Object} data - Dados a serem validados
             * @param {string} formId - ID do formul√°rio
             * @returns {boolean} - true se v√°lido
             */
            static validateAndShowErrors(data, formId = 'coletaForm') {
                const validation = this.validate(data);
                
                if (!validation.valid) {
                    // Limpar erros anteriores
                    document.querySelectorAll('.field-error').forEach(el => el.remove());
                    document.querySelectorAll('.field-input-error').forEach(el => {
                        el.classList.remove('field-input-error');
                        el.setAttribute('aria-invalid', 'false');
                        if (typeof AccessibilityManager !== 'undefined') {
                            AccessibilityManager.clearFieldError(el);
                        }
                    });

                    // Mapeamento de campos do schema para IDs/names do formul√°rio
                    const fieldMapping = {
                        'filial': 'filial',
                        'numero_coleta': 'numeroColeta',
                        'cliente': 'cliente',
                        'data_recebimento': 'dataRecebimento',
                        'data_entrega': 'dataEntrega',
                        'origem': 'origem',
                        'destino': 'destino',
                        'valor': 'valor',
                        'frete_motorista': 'freteMotorista',
                        'km': 'km',
                        'classeVeiculo': 'classeVeiculo',
                        'tiposVeiculo': 'tiposVeiculo',
                        'tiposCarroceria': 'tiposCarroceria'
                    };
                    
                    // Mostrar erros
                    validation.errors.forEach(error => {
                        const fieldName = fieldMapping[error.field] || error.field;
                        // Tentar encontrar o campo por name ou id
                        let field = document.querySelector(`[name="${fieldName}"], #${fieldName}`);
                        
                        // Se n√£o encontrou, tentar pelo nome original do schema
                        if (!field) {
                            field = document.querySelector(`[name="${error.field}"], #${error.field}`);
                        }
                        
                        if (field) {
                            field.classList.add('field-input-error');
                            // Usar AccessibilityManager para atualizar ARIA
                            if (typeof AccessibilityManager !== 'undefined') {
                                AccessibilityManager.setFieldError(field, error.message);
                            } else {
                                // Fallback se AccessibilityManager n√£o estiver dispon√≠vel
                                // Remover erro anterior se existir
                                const existingError = document.getElementById(`${field.id || fieldName}-error`);
                                if (existingError) {
                                    existingError.remove();
                                }
                                
                                const errorDiv = document.createElement('div');
                                errorDiv.id = `${field.id || fieldName}-error`;
                                errorDiv.className = 'field-error';
                                errorDiv.setAttribute('role', 'alert');
                                errorDiv.setAttribute('aria-live', 'polite');
                                errorDiv.style.cssText = 'color: #dc3545; font-size: 0.75rem; margin-top: 0.25rem; font-weight: 600;';
                                errorDiv.textContent = error.message;
                                
                                // Inserir ap√≥s o campo ou no parent
                                const formGroup = field.closest('.form-group');
                                if (formGroup) {
                                    formGroup.appendChild(errorDiv);
                                } else {
                                    field.parentElement.appendChild(errorDiv);
                                }
                            }
                            field.setAttribute('aria-invalid', 'true');
                        } else {
                            // Se n√£o encontrou o campo, mostrar notifica√ß√£o
                            console.warn(`Campo n√£o encontrado para erro: ${error.field} (tentou: ${fieldName})`);
                        }
                    });

                    // Mostrar notifica√ß√£o geral
                    showNotification(
                        `Por favor, corrija ${validation.errors.length} erro(s) no formul√°rio`,
                        'error'
                    );
                }

                return validation.valid;
            }
        }

        // ========== SISTEMA DE NAVEGA√á√ÉO POR TECLADO E ACESSIBILIDADE ==========
        /**
         * Gerencia navega√ß√£o por teclado e acessibilidade
         */
        class AccessibilityManager {
            /**
             * Inicializa eventos de teclado para acessibilidade
             */
            static init() {
                // Fechar modal com ESC
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        const modal = document.querySelector('.modal-overlay.active, .modal-overlay[style*="display: flex"]');
                        if (modal) {
                            const closeBtn = modal.querySelector('.close-modal');
                            if (closeBtn) {
                                closeBtn.click();
                            } else {
                                closeModal();
                            }
                        }
                    }
                });

                // Navega√ß√£o por teclado em modais (trap focus)
                document.addEventListener('keydown', (e) => {
                    const modal = document.querySelector('.modal-overlay.active, .modal-overlay[style*="display: flex"]');
                    if (!modal) return;

                    if (e.key === 'Tab') {
                        const focusableElements = modal.querySelectorAll(
                            'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                        );
                        const firstElement = focusableElements[0];
                        const lastElement = focusableElements[focusableElements.length - 1];

                        if (e.shiftKey) {
                            // Shift + Tab
                            if (document.activeElement === firstElement) {
                                e.preventDefault();
                                lastElement.focus();
                            }
                        } else {
                            // Tab
                            if (document.activeElement === lastElement) {
                                e.preventDefault();
                                firstElement.focus();
                            }
                        }
                    }
                });

                // Atualizar aria-invalid nos campos quando h√° erro
                document.addEventListener('input', (e) => {
                    const field = e.target;
                    if (field.hasAttribute('aria-invalid')) {
                        // Remover erro se o campo foi corrigido
                        if (field.value && !field.classList.contains('field-input-error')) {
                            field.setAttribute('aria-invalid', 'false');
                        }
                    }
                });
            }

            /**
             * Atualiza atributos ARIA de erro em um campo
             * @param {HTMLElement} field - Campo do formul√°rio
             * @param {string} errorMessage - Mensagem de erro
             */
            static setFieldError(field, errorMessage) {
                field.setAttribute('aria-invalid', 'true');
                field.setAttribute('aria-describedby', `${field.id}-error`);
                
                // Criar ou atualizar elemento de erro
                let errorElement = document.getElementById(`${field.id}-error`);
                if (!errorElement) {
                    errorElement = document.createElement('div');
                    errorElement.id = `${field.id}-error`;
                    errorElement.className = 'field-error';
                    errorElement.setAttribute('role', 'alert');
                    errorElement.setAttribute('aria-live', 'polite');
                    field.parentElement.appendChild(errorElement);
                }
                errorElement.textContent = errorMessage;
            }

            /**
             * Remove atributos ARIA de erro de um campo
             * @param {HTMLElement} field - Campo do formul√°rio
             */
            static clearFieldError(field) {
                field.setAttribute('aria-invalid', 'false');
                const errorElement = document.getElementById(`${field.id}-error`);
                if (errorElement) {
                    errorElement.remove();
                }
            }

            /**
             * Anuncia mudan√ßa para leitores de tela
             * @param {string} message - Mensagem a ser anunciada
             */
            static announce(message) {
                const announcement = document.createElement('div');
                announcement.setAttribute('role', 'status');
                announcement.setAttribute('aria-live', 'polite');
                announcement.setAttribute('aria-atomic', 'true');
                announcement.className = 'sr-only';
                announcement.textContent = message;
                document.body.appendChild(announcement);
                
                setTimeout(() => {
                    announcement.remove();
                }, 1000);
            }
        }

        // Inicializar acessibilidade quando o DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => AccessibilityManager.init());
        } else {
            AccessibilityManager.init();
        }

        // ========== MAPEAMENTOS INTELIGENTES DE TIPOS DE VE√çCULO E CARROCERIA ==========
        const tiposVeiculo = {
            leve: ['3/4', 'Fiorino', 'Toco', 'VLC'],
            medio: ['Bitruck', 'Truck'],
            pesado: ['Bitrem', 'Carreta', 'Carreta LS', 'Rodotrem', 'Vanderleia']
        };

        const bodyworkByClass = {
            leve: ['bau', 'bau_frigorifico', 'bau_refrigerado', 'cacamba', 'prancha'],
            medio: ['bau', 'bau_frigorifico', 'sider', 'graneleiro', 'plataforma', 'basculante', 'cacamba'],
            pesado: ['bau', 'sider', 'graneleiro', 'grade_baixa', 'apenas_cavalo', 'cegonheiro', 'gaiola', 'tanque', 'porta_container_20', 'porta_container_40', 'basculante', 'cacamba']
        };

        const tiposCarroceriaMap = {
            bau: 'Ba√∫',
            bau_frigorifico: 'Ba√∫ Frigor√≠fico',
            bau_refrigerado: 'Ba√∫ Refrigerado',
            sider: 'Sider',
            cacamba: 'Ca√ßamba',
            caamba: 'Ca√ßamba', // Varia√ß√£o quando o √ß foi removido incorretamente
            graneleiro: 'Graneleiro',
            plataforma: 'Plataforma',
            prancha: 'Prancha',
            apenas_cavalo: 'Apenas Cavalo',
            cegonheiro: 'Cegonheiro',
            gaiola: 'Gaiola',
            tanque: 'Tanque',
            grade_baixa: 'GRADE BAIXA',
            basculante: 'BASCULANTE',
            porta_container_20: 'PORTA CONTAINER 20',
            porta_container_40: 'PORTA CONTAINER 40'
        };

        // ========== FUN√á√ïES DE ATUALIZA√á√ÉO DE TIPOS DE VE√çCULO E CARROCERIA ==========
        function atualizarTiposVeiculoECarroceria() {
            const classe = document.getElementById('classeVeiculo')?.value;
            atualizarTiposVeiculo(classe);
            atualizarTiposCarroceria(classe);
        }
        // Tornar fun√ß√£o acess√≠vel globalmente
        window.atualizarTiposVeiculoECarroceria = atualizarTiposVeiculoECarroceria;

        function atualizarTiposVeiculo(classe) {
            const container = document.getElementById('tiposVeiculoContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!classe || !tiposVeiculo[classe]) {
                container.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #6c757d; margin: 0;">Selecione primeiro a classe do ve√≠culo</p>';
                return;
            }
            
            tiposVeiculo[classe].forEach(tipo => {
                const label = document.createElement('label');
                label.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: normal;';
                
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.name = 'tiposVeiculo';
                input.value = tipo;
                input.className = 'checkbox-veiculo';
                
                const span = document.createElement('span');
                span.textContent = tipo;
                
                label.appendChild(input);
                label.appendChild(span);
                container.appendChild(label);
            });
        }

        function atualizarTiposCarroceria(classe) {
            const container = document.getElementById('tiposCarroceriaContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!classe || !bodyworkByClass[classe]) {
                container.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #6c757d; margin: 0;">Selecione primeiro a classe do ve√≠culo</p>';
                return;
            }
            
            // Tipos de ve√≠culo que N√ÉO devem aparecer como carroceria
            const tiposVeiculoExcluidos = ['rodotrem', 'Rodotrem', 'RODOTREM', 'bitrem', 'Bitrem', 'BITREM', 'carreta', 'Carreta', 'CARRETA', 'carreta_ls', 'Carreta LS', 'Carreta_LS', 'vanderleia', 'Vanderleia', 'VANDERLEIA'];
            
            bodyworkByClass[classe].forEach(tipo => {
                // Garantir que rodotrem nunca apare√ßa como carroceria
                if (tiposVeiculoExcluidos.includes(tipo)) {
                    return; // Pular rodotrem
                }
                
                if (tiposCarroceriaMap[tipo]) {
                    const label = document.createElement('label');
                    label.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: normal;';
                    
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.name = 'tiposCarroceria';
                    input.value = tipo;
                    input.className = 'checkbox-carroceria';
                    
                    const span = document.createElement('span');
                    span.textContent = tiposCarroceriaMap[tipo];
                    
                    label.appendChild(input);
                    label.appendChild(span);
                    container.appendChild(label);
                }
            });
        }

        // ========== FUN√á√ïES HELPER - FORMATADORES ==========
        const formatters = {
            data: (data) => {
                if (!data) return '';
                try {
                    return new Date(data).toLocaleDateString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                } catch (e) {
                    return data;
                }
            },
            dataHora: (data) => {
                if (!data) return '';
                try {
                    return new Date(data).toLocaleString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return data;
                }
            },
            moeda: (valor) => {
                if (valor === null || valor === undefined || valor === '') return 'R$ 0,00';
                return `R$ ${parseFloat(valor || 0).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`;
            },
            telefone: (tel) => {
                if (!tel) return '';
                const numeros = tel.replace(/\D/g, '');
                if (numeros.length === 11) {
                    return numeros.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                } else if (numeros.length === 10) {
                    return numeros.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                }
                return tel;
            },
            numero: (num) => {
                if (num === null || num === undefined || num === '') return '';
                return parseFloat(num || 0).toLocaleString('pt-BR');
            }
        };

        // ========== FUN√á√ÉO HELPER - DEBOUNCE ==========
        // Fun√ß√£o clearDateFilters j√° est√° definida acima (no in√≠cio do script)
        
        // Fun√ß√£o setQuickDate tamb√©m deve ser global
        function setQuickDate(periodo) {
            const hoje = new Date();
            let dataInicio, dataFim;

            switch(periodo) {
                case 'hoje':
                    dataInicio = new Date(hoje);
                    dataFim = new Date(hoje);
                    break;
                case 'semana':
                    dataInicio = new Date(hoje.getTime() - 6 * 24 * 60 * 60 * 1000);
                    dataFim = new Date(hoje);
                    break;
                case 'mes':
                    dataInicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                    dataFim = new Date(hoje);
                    break;
                case 'trimestre':
                    const trimestreAtual = Math.floor(hoje.getMonth() / 3);
                    dataInicio = new Date(hoje.getFullYear(), trimestreAtual * 3, 1);
                    dataFim = new Date(hoje);
                    break;
            }

            // Verificar se formatarDataParaInput existe
            if (typeof formatarDataParaInput === 'function') {
                document.getElementById('dataInicio').value = formatarDataParaInput(dataInicio);
                document.getElementById('dataFim').value = formatarDataParaInput(dataFim);
            } else {
                // Fallback se formatarDataParaInput n√£o existir
                const formatar = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };
                document.getElementById('dataInicio').value = formatar(dataInicio);
                document.getElementById('dataFim').value = formatar(dataFim);
            }
            
            // Ativar bot√£o visualmente
            document.querySelectorAll('.quick-date-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = event?.target || document.querySelector(`[onclick*="setQuickDate('${periodo}')"]`);
            if (activeBtn) activeBtn.classList.add('active');
            
            // Aplicar filtro se existir
            if (typeof filterColetas === 'function') {
                filterColetas();
            }
        }
        
        // Tornar fun√ß√£o acess√≠vel globalmente
        window.setQuickDate = setQuickDate;
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ========== FUN√á√ÉO HELPER - TRATAMENTO DE ERROS ==========
        // Fun√ß√£o mantida para compatibilidade - agora usa ErrorHandler
        async function handleError(error, context) {
            return ErrorHandler.handle(error, context);
        }
        
        // Fun√ß√£o antiga (mantida para refer√™ncia)
        async function handleErrorOld(error, context) {
            console.error(`‚ùå Erro em ${context}:`, error);
            
            // Log detalhado em desenvolvimento
            if (window.DEBUG || window.location.hostname === 'localhost') {
                console.error('Detalhes do erro:', {
                    message: error.message,
                    code: error.code,
                    details: error.details,
                    hint: error.hint
                });
            }
            
            // Mensagem amig√°vel para o usu√°rio
            let mensagem = 'Ocorreu um erro. Tente novamente.';
            if (error.message) {
                mensagem = error.message;
            } else if (error.code === 'PGRST301') {
                mensagem = 'Erro ao acessar o banco de dados. Verifique sua conex√£o.';
            } else if (error.code === '42501') {
                mensagem = 'Voc√™ n√£o tem permiss√£o para realizar esta a√ß√£o.';
            } else if (error.code === '23505') {
                mensagem = 'J√° existe um registro com essas informa√ß√µes.';
            }
            
            showNotification(mensagem, 'error');
            
            // Retornar para monitoramento futuro (Sentry, etc.)
            if (window.errorReporter) {
                window.errorReporter.captureException(error, { context });
            }
        }

        // ========== FUN√á√ÉO HELPER - LOADING SKELETONS ==========
        function criarSkeletonCard() {
            return `
                <div class="coleta-card skeleton-card">
                    <div class="skeleton-line skeleton-title"></div>
                    <div class="skeleton-line skeleton-subtitle"></div>
                    <div class="skeleton-line skeleton-text"></div>
                    <div class="skeleton-line skeleton-text" style="width: 60%;"></div>
                </div>
            `;
        }

        function mostrarSkeletons(containerId, quantidade = 6) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = Array(quantidade).fill(0).map(() => criarSkeletonCard()).join('');
            }
        }

        // ========== FUN√á√ÉO HELPER - CRIA√á√ÉO DE MODAIS REUTILIZ√ÅVEIS ==========
        function criarModal({ titulo, conteudo, acoes, id, tamanho = 'medio', fecharAoClickFora = true }) {
            const modalId = id || `modal-${Date.now()}`;
            const tamanhoClass = {
                pequeno: 'modal-sm',
                medio: '',
                grande: 'modal-lg',
                extraGrande: 'modal-xl'
            }[tamanho] || '';

            const modal = document.createElement('div');
            modal.className = `modal-overlay ${modalId}`;
            modal.id = modalId;
            modal.innerHTML = `
                <div class="modal ${tamanhoClass}" style="max-width: ${tamanho === 'pequeno' ? '400px' : tamanho === 'grande' ? '800px' : tamanho === 'extraGrande' ? '1200px' : '600px'};">
                    <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 1.3rem; font-weight: 600;">${titulo}</h3>
                        <button class="close-modal" onclick="fecharModalHelper('${modalId}')" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body" style="padding: 1.5rem; max-height: 70vh; overflow-y: auto;">
                        ${conteudo}
                    </div>
                    ${acoes ? `
                    <div class="modal-footer" style="padding: 1rem 1.5rem; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 0.5rem; border-radius: 0 0 12px 12px;">
                        ${acoes}
                    </div>
                    ` : ''}
                </div>
            `;

            // Fechar ao clicar fora do modal
            if (fecharAoClickFora) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        fecharModalHelper(modalId);
                    }
                });
            }

            document.body.appendChild(modal);
            setTimeout(() => modal.classList.add('active'), 10);
            
            return modalId;
        }

        function fecharModalHelper(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        // ========== FUN√á√ÉO HELPER - CONFIRMA√á√ÉO PARA A√á√ïES DESTRUTIVAS ==========
        async function confirmarAcaoDestrutiva({ titulo, mensagem, detalhes, textoConfirmar = 'Confirmar', textoCancelar = 'Cancelar', corConfirmar = '#dc3545' }) {
            return new Promise((resolve) => {
                const modalId = criarModal({
                    titulo: `‚ö†Ô∏è ${titulo}`,
                    tamanho: 'pequeno',
                    conteudo: `
                        <div style="text-align: center;">
                            <div style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <p style="font-size: 1.1rem; margin-bottom: 1rem; color: #333;">${mensagem}</p>
                            ${detalhes ? `
                            <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: left; border-left: 4px solid #ffc107;">
                                <strong style="color: #856404;">Detalhes:</strong>
                                <div style="margin-top: 0.5rem; color: #856404;">${detalhes}</div>
                            </div>
                            ` : ''}
                            <p style="color: #dc3545; font-weight: 600; margin-top: 1.5rem; padding: 1rem; background: #f8d7da; border-radius: 8px;">
                                <i class="fas fa-info-circle"></i> Esta a√ß√£o n√£o pode ser desfeita.
                            </p>
                        </div>
                    `,
                    acoes: `
                        <button class="btn btn-secondary" onclick="cancelarAcaoDestrutiva('${modalId}')" style="padding: 0.6rem 1.5rem; border-radius: 8px; border: 1px solid #6c757d; background: white; color: #6c757d; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                            <i class="fas fa-times"></i> ${textoCancelar}
                        </button>
                        <button class="btn btn-danger" onclick="executarAcaoDestrutiva('${modalId}')" style="padding: 0.6rem 1.5rem; border-radius: 8px; border: none; background: ${corConfirmar}; color: white; cursor: pointer; font-weight: 600; transition: all 0.3s; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);">
                            <i class="fas fa-check"></i> ${textoConfirmar}
                        </button>
                    `
                });

                // Armazenar resolve na vari√°vel global tempor√°ria
                window._acaoDestrutivaResolve = resolve;
                window._acaoDestrutivaModalId = modalId;
            });
        }

        function cancelarAcaoDestrutiva(modalId) {
            if (window._acaoDestrutivaResolve) {
                window._acaoDestrutivaResolve(false);
                window._acaoDestrutivaResolve = null;
            }
            fecharModalHelper(modalId);
        }

        function executarAcaoDestrutiva(modalId) {
            if (window._acaoDestrutivaResolve) {
                window._acaoDestrutivaResolve(true);
                window._acaoDestrutivaResolve = null;
            }
            fecharModalHelper(modalId);
        }

        // Etapas do processo
        const ETAPAS = [
            { id: 'comercial', nome: 'Comercial', ordem: 1 },
            { id: 'price', nome: 'Price', ordem: 2 },
            { id: 'cs', nome: 'CS', ordem: 3 },
            { id: 'contratacao', nome: 'Contrata√ß√£o', ordem: 4 },
            { id: 'gr', nome: 'GR', ordem: 5 },
            { id: 'documentacao', nome: 'Documenta√ß√£o', ordem: 6 },
            { id: 'controladoria', nome: 'Controladoria', ordem: 7 },
            { id: 'ti', nome: 'TI', ordem: 8 },
            { id: 'contas_pagar', nome: 'Contas a Pagar', ordem: 9 },
            { id: 'contas_receber', nome: 'Contas a Receber', ordem: 10 },
            { id: 'monitoramento', nome: 'Monitoramento', ordem: 11 },
            { id: 'servicos_adicionais', nome: 'Servi√ßos Adicionais', ordem: 12 },
            { id: 'finalizar_operacao', nome: 'Finalizar Opera√ß√£o', ordem: 13 }
        ];

        // Mapeamento de tipos de carroceria j√° declarado acima (linha 3413)

        // Fun√ß√£o para obter nome amig√°vel da carroceria
        function obterNomeCarroceria(chave) {
            return tiposCarroceriaMap[chave] || chave;
        }

        function obterNomeEtapa(etapaId) {
            return ETAPAS.find(e => e.id === etapaId)?.nome || etapaId;
        }

        // ========== MAPEAMENTO DE CLIENTES POR FILIAL ==========
        const clientesPorFilial = {
            'JBO': [
                'VIVIX / OWENS - JAZIDA',
                'VIVIX / NACIONAL - AREAL',
                'VIVIX / OWENS - FELDSPATO',
                'VIVIX / OWENS - AREAL',
                'VIVIX / MURO ALTO - AREIA',
                'VIVIX / TENNIS PACK',
                'VIVIX / PRAINHA ZN',
                'VIVIX / POLIPISO',
                'VIVIX NAVIO',
                'CONTINENTAL NAVIO',
                'OWENS - BARRILHA (PARATIBE)',
                'OWENS - GARRAFAS MG',
                'OWENS - IMPORTA√á√ÉO',
                'OWENS-PE / CENTROAIDAR-GO',
                'OWENS - MOV. INTERNA',
                'OWENS - TESTE CALC√ÅRIO',
                'OWENS - TESTE FELDSPATO',
                'VIVIX / MANUCHAR',
                'OWENS / ACQUA EMBALAGENS BH',
                'NAVIO VIVIX',
                'POLIPISO',
                'HNK MALTE PACATUBA CE',
                'HNK GARRAFAS - BENEVIDES PA',
                'HNK MALTE - CABEDELO PB',
                'HNK MALTE - CAXIAS',
                'HNK GARRAFAS - RECIFE / IGARASSU',
                'HNK CARRAFAS - IGARASSU PE',
                'HNK GARRAFAS - ALAGOINHAS BA',
                'YARA BIG BAGS',
                'MOHAWKBR - PB x BA',
                'GRUPO MOURA',
                'COLSUGAR',
                'NAVIO SOLVAY / VIVIX',
                'NAVIO MV K BEREKET / VIVIX',
                'NAVIO MV K BEREKET / CONTINENTAL-PB',
                'GERDAU'
            ],
            'US': [
                'NAVIO - USINA OLHO D\'AGUA',
                'NAVIO SINDA√á√öCAR',
                'USINA MIRIRI',
                'USINA GIASA-PB x SINDA√á√öCAR-PE',
                'USINA S√ÉO JOS√â X MARILAN',
                'USINA IPOJUCA x BONGI',
                'USINA IPOJUCA x PETROLINA',
                'USINA IPOJUCA X CABO',
                'USINA IPOJUCA x M.DIAS BRANCO',
                'USINA PETRIBU VHP',
                'USINA UNI√ÉO',
                'NAVIO BARRILHA OWENS',
                'NAVIO BARRILHA CONTINENTAL',
                'NAVIO JB (ST THERESA)',
                'HNK GARRAFAS RECIFE',
                'HNK RETORNO ATG',
                'ENERGIZER IMPORTA√á√ÉO',
                'BEEVA_USINAS'
            ],
            'AMBEV': [
                'AMBEV A√á√öCAR',
                'AMBEV GARRAFAS OWENS',
                'AMBEV GARRAFAS JACUTINGA',
                'AMBEV PREFORMA',
                'AMBEV MALTE',
                'NAVIO AMBEV MALTE (PARATIBE)',
                'AMBEV ATG',
                'NAVIO AMBEV'
            ],
            'BA': [
                'HNK GARRAFAS',
                'IVN X HNK ALAGOINHAS',
                'INOVA PISOS CNTR',
                'HNK X IVN RETORNO',
                'NATIVILLE INSUMOS',
                'MERCOSUL SSA',
                'AMBEV CDR - BA / PE',
                'AMBEV - JACARE√ç SP',
                'COSTA BRASIL CNTR',
                'MAERSK SAFRA',
                'INDAI√Å',
                'JMAC√äDO - SSA',
                'JMAC√äDO - SIF',
                'ENGEPACK'
            ],
            'SE': [
                'HNK GARRAFAS',
                'IVN X HNK ALAGOINHAS',
                'INOVA PISOS CNTR',
                'HNK X IVN RETORNO',
                'NATIVILLE INSUMOS',
                'MERCOSUL SSA',
                'AMBEV CDR - BA / PE',
                'AMBEV - JACARE√ç SP',
                'COSTA BRASIL CNTR',
                'MAERSK SAFRA',
                'INDAI√Å',
                'JMAC√äDO - SSA',
                'JMAC√äDO - SIF',
                'ENGEPACK'
            ],
            'CE': [
                'HNK GARRAFAS',
                'IVN X HNK ALAGOINHAS',
                'INOVA PISOS CNTR',
                'HNK X IVN RETORNO',
                'NATIVILLE INSUMOS',
                'MERCOSUL SSA',
                'AMBEV CDR - BA / PE',
                'AMBEV - JACARE√ç SP',
                'COSTA BRASIL CNTR',
                'MAERSK SAFRA',
                'INDAI√Å',
                'JMAC√äDO - SSA',
                'JMAC√äDO - SIF',
                'ENGEPACK'
            ],
            'PARATIBE': [
                'ADESBRA'
            ],
            'AL': [
                'SERRA GRANDE-AL x MDB SALVADOR-BA',
                'USINA CORURIPE',
                'NATVILLE',
                'USINA CAET√â - SALVADOR',
                'USINA CAET√â - MARACANA√ö',
                'BEEVA',
                'NAVIO SERRA GRANDE',
                'NAVIO YARA  MCZ',
                'YARA TRANSF. - PORTO ALEGRE',
                'YARA OUTBOUND'
            ],
            'SP': [
                'AMBEV GARRAFAS - VIRALLIA-MG / JACARE√ç-SP',
                'AMBEV A√á√öCAR  "SP"'
            ],
            'CABO': [
                'ENERGIZER EXPORTA√á√ÉO',
                'ENERGIZER IMPORTA√á√ÉO "CABO"',
                'ALIAN√áA CNTR',
                'CBMC',
                'UNIVAR SOLUTIONS',
                'COSTA BRASIL',
                'IQUINE',
                'USINA SERRA GRANDE',
                'NATURALLY',
                'CIMENTO NACIONAL',
                'GUARAVES',
                'ACTION',
                'INOVA PISOS',
                'MERCOSUL SUA',
                'GERDAU CNTR',
                'GRUPO JB',
                'NORCOAST'
            ]
        };

        // Fun√ß√£o para filtrar clientes baseado na filial selecionada
        function filtrarClientesPorFilial() {
            const filialSelect = document.getElementById('filial');
            const clienteSelect = document.getElementById('cliente');
            const filialSelecionada = filialSelect.value;

            // Limpar op√ß√µes atuais
            clienteSelect.innerHTML = '';

            if (!filialSelecionada) {
                clienteSelect.innerHTML = '<option value="">Selecione primeiro a filial</option>';
                clienteSelect.disabled = true;
                return;
            }

            // Habilitar o select de clientes
            clienteSelect.disabled = false;

            // Adicionar op√ß√£o padr√£o
            const optionPadrao = document.createElement('option');
            optionPadrao.value = '';
            optionPadrao.textContent = 'Selecione o cliente';
            clienteSelect.appendChild(optionPadrao);

            // Buscar clientes da filial selecionada
            const clientes = clientesPorFilial[filialSelecionada] || [];

            if (clientes.length === 0) {
                const optionSemCliente = document.createElement('option');
                optionSemCliente.value = '';
                optionSemCliente.textContent = 'Nenhum cliente cadastrado para esta filial';
                clienteSelect.appendChild(optionSemCliente);
                clienteSelect.disabled = true;
                return;
            }

            // Ordenar clientes alfabeticamente
            const clientesOrdenados = [...clientes].sort();

            // Adicionar op√ß√µes de clientes
            clientesOrdenados.forEach(cliente => {
                const option = document.createElement('option');
                option.value = cliente;
                option.textContent = cliente;
                clienteSelect.appendChild(option);
            });
        }

        // Tornar fun√ß√£o acess√≠vel globalmente
        window.filtrarClientesPorFilial = filtrarClientesPorFilial;

        // ========== SISTEMA DE CRIA√á√ÉO EM LOTE ==========
        let modoCriacaoLote = false; // false = √∫nica, true = m√∫ltiplas

        // Fun√ß√£o para alternar entre modo √∫nico e m√∫ltiplo
        function alternarModoCriacao() {
            modoCriacaoLote = !modoCriacaoLote;
            const grupoNumero = document.getElementById('grupoNumeroColeta');
            const grupoMultiplos = document.getElementById('grupoMultiplosNumeros');
            const inputNumero = document.getElementById('numeroColeta');
            const textareaMultiplos = document.getElementById('multiplosNumeros');
            const modoTexto = document.getElementById('modoTexto');
            const previewNumeros = document.getElementById('previewNumeros');

            if (modoCriacaoLote) {
                // Modo m√∫ltiplas coletas
                grupoNumero.style.display = 'none';
                grupoMultiplos.style.display = 'block';
                inputNumero.removeAttribute('required');
                textareaMultiplos.setAttribute('required', 'required');
                modoTexto.innerHTML = '<i class="fas fa-layer-group"></i> Criar Uma';
                previewNumeros.style.display = 'none';
                textareaMultiplos.value = '';
            } else {
                // Modo √∫nica coleta
                grupoNumero.style.display = 'block';
                grupoMultiplos.style.display = 'none';
                inputNumero.setAttribute('required', 'required');
                textareaMultiplos.removeAttribute('required');
                modoTexto.innerHTML = '<i class="fas fa-layer-group"></i> Criar M√∫ltiplas';
                previewNumeros.style.display = 'none';
                textareaMultiplos.value = '';
            }
        }

        // Fun√ß√£o para processar m√∫ltiplos n√∫meros e mostrar preview
        function processarMultiplosNumeros() {
            const textarea = document.getElementById('multiplosNumeros');
            const preview = document.getElementById('previewNumeros');
            const totalSpan = document.getElementById('totalColetas');
            const listaSpan = document.getElementById('listaNumeros');
            const valor = textarea.value.trim();

            if (!valor) {
                preview.style.display = 'none';
                return;
            }

            const numeros = parsearMultiplosNumeros(valor);
            
            if (numeros.length === 0) {
                preview.style.display = 'none';
                return;
            }

            totalSpan.textContent = numeros.length;
            listaSpan.innerHTML = numeros.slice(0, 10).map(n => `<span style="display: inline-block; background: #667eea; color: white; padding: 0.2rem 0.5rem; margin: 0.2rem; border-radius: 4px; font-size: 0.75rem;">${n}</span>`).join('');
            
            if (numeros.length > 10) {
                listaSpan.innerHTML += `<span style="display: block; margin-top: 0.3rem; color: #6c757d;">... e mais ${numeros.length - 10} coleta(s)</span>`;
            }

            preview.style.display = 'block';
        }

        // Fun√ß√£o para parsear m√∫ltiplos n√∫meros (suporta v√≠rgula e intervalos)
        function parsearMultiplosNumeros(input) {
            const numeros = new Set();
            const partes = input.split(/[,\n]/).map(p => p.trim()).filter(p => p);

            partes.forEach(parte => {
                // Verificar se √© um intervalo (ex: 5565-5569)
                if (parte.includes('-')) {
                    const [inicio, fim] = parte.split('-').map(n => parseInt(n.trim(), 10));
                    if (!isNaN(inicio) && !isNaN(fim) && inicio > 0 && fim > 0) {
                        const menor = Math.min(inicio, fim);
                        const maior = Math.max(inicio, fim);
                        for (let i = menor; i <= maior; i++) {
                            numeros.add(String(i));
                        }
                    }
                } else {
                    // N√∫mero √∫nico
                    const num = parte.replace(/[^0-9]/g, '');
                    if (num && parseInt(num, 10) > 0) {
                        numeros.add(String(parseInt(num, 10)));
                    }
                }
            });

            // Converter para array e ordenar
            return Array.from(numeros).sort((a, b) => parseInt(a, 10) - parseInt(b, 10));
        }

        // Fun√ß√£o para criar m√∫ltiplas coletas
        async function criarMultiplasColetas(rawData, numerosColetas) {
            console.log('üöÄ Iniciando cria√ß√£o de m√∫ltiplas coletas:', { 
                quantidade: numerosColetas.length, 
                numeros: numerosColetas,
                filial: rawData.filial,
                cliente: rawData.cliente
            });
            
            if (!supabaseClient) {
                console.error('‚ùå Supabase n√£o inicializado');
                showNotification('Erro: Supabase n√£o inicializado', 'error');
                return;
            }

            if (!numerosColetas || numerosColetas.length === 0) {
                console.error('‚ùå Nenhum n√∫mero de coleta fornecido');
                showNotification('‚ö†Ô∏è Nenhum n√∫mero de coleta v√°lido fornecido', 'warning');
                return;
            }

            showNotification(`üîÑ Criando ${numerosColetas.length} coleta(s)...`, 'info');
            
            // Converter datas
            let dataRecebimento = rawData.dataRecebimento;
            if (dataRecebimento && dataRecebimento.length === 10) {
                dataRecebimento = dataRecebimento + 'T12:00:00.000Z';
            }
            
            let dataEntrega = rawData.dataEntrega;
            if (dataEntrega && dataEntrega.length === 10) {
                dataEntrega = dataEntrega + 'T12:00:00.000Z';
            }
            
            // Coletar tipos de ve√≠culo e carroceria
            const tiposVeiculoSelecionados = Array.from(document.querySelectorAll('input[name="tiposVeiculo"]:checked'))
                .map(checkbox => checkbox.value);
            
            const tiposCarroceriaSelecionados = Array.from(document.querySelectorAll('input[name="tiposCarroceria"]:checked'))
                .map(checkbox => checkbox.value);
            
            // Buscar usu√°rio atual
            const loggedInUserData = localStorage.getItem('loggedInUser');
            const userData = loggedInUserData ? JSON.parse(loggedInUserData) : null;
            
            // Verificar se √© di√°ria
            const isDiaria = document.getElementById('diaria')?.checked || false;
            
            // Preparar dados base para todas as coletas
            const dadosBase = {
                filial: rawData.filial,
                cliente: rawData.cliente,
                data_recebimento: dataRecebimento,
                data_entrega: dataEntrega || null,
                origem: rawData.origem,
                destino: rawData.destino,
                valor: parseFloat(rawData.valor) || 0,
                frete_motorista: parseFloat(rawData.freteMotorista) || 0,
                km: parseFloat(rawData.km) || 0,
                tipos_veiculo: tiposVeiculoSelecionados,
                tipos_carroceria: tiposCarroceriaSelecionados,
                status: rawData.status || 'pendente',
                etapa_atual: rawData.etapaAtual || 'comercial',
                observacoes: rawData.observacoes || null,
                prioridade: rawData.prioridade || 'normal',
                diaria: isDiaria,
                created_by: userData?.id || null,
                updated_by: userData?.id || null,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString(),
                data_atualizacao: new Date().toISOString()
            };
            
            // Verificar duplicatas antes de criar
            const { data: coletasExistentes } = await supabaseClient
                .from('coletas')
                .select('filial, numero_coleta')
                .eq('filial', rawData.filial)
                .in('numero_coleta', numerosColetas);
            
            const numerosExistentes = new Set((coletasExistentes || []).map(c => c.numero_coleta));
            const numerosParaCriar = numerosColetas.filter(n => !numerosExistentes.has(n));
            const numerosDuplicados = numerosColetas.filter(n => numerosExistentes.has(n));
            
            if (numerosDuplicados.length > 0) {
                showNotification(
                    `‚ö†Ô∏è ${numerosDuplicados.length} n√∫mero(s) j√° existem: ${numerosDuplicados.join(', ')}. Ser√£o ignorados.`,
                    'warning',
                    5000
                );
            }
            
            if (numerosParaCriar.length === 0) {
                showNotification('‚ö†Ô∏è Todas as coletas j√° existem!', 'warning');
                return;
            }
            
            // Preparar array de coletas para inser√ß√£o
            const coletasParaInserir = numerosParaCriar.map(numero => ({
                ...dadosBase,
                numero_coleta: numero
            }));
            
            // Inserir todas as coletas de uma vez
            const { data: coletasCriadas, error } = await supabaseClient
                .from('coletas')
                .insert(coletasParaInserir)
                .select();
            
            if (error) {
                console.error('‚ùå Erro ao criar m√∫ltiplas coletas:', error);
                showNotification(`‚ùå Erro ao criar coletas: ${error.message}`, 'error');
                return;
            }
            
            // Registrar no hist√≥rico para cada coleta criada
            if (coletasCriadas && coletasCriadas.length > 0) {
                for (const coleta of coletasCriadas) {
                    try {
                        await salvarNoHistorico(coleta.id, 'coleta_criada', `Nova coleta criada em lote - ${rawData.filial} #${coleta.numero_coleta}`);
                    } catch (histError) {
                        console.warn('‚ö†Ô∏è Erro ao salvar hist√≥rico:', histError);
                    }
                }
            }
            
            // Fechar modal e recarregar
            closeModal();
            showNotification(
                `‚úÖ ${coletasCriadas.length} coleta(s) criada(s) com sucesso!${numerosDuplicados.length > 0 ? ` (${numerosDuplicados.length} ignorada(s))` : ''}`,
                'success',
                5000
            );
            
            // Recarregar coletas ap√≥s um pequeno delay
            setTimeout(() => {
                carregarColetas();
            }, 500);
        }

        // Tornar fun√ß√µes acess√≠veis globalmente
        window.alternarModoCriacao = alternarModoCriacao;
        window.processarMultiplosNumeros = processarMultiplosNumeros;
        window.parsearMultiplosNumeros = parsearMultiplosNumeros;
        window.criarMultiplasColetas = criarMultiplasColetas;

        // Vari√°vel global para permiss√µes de etapas
        let permissoesEtapasColetas = [];

        // Buscar permiss√µes de etapas do usu√°rio logado
        async function carregarPermissoesEtapasColetas() {
            try {
                const loggedInUserData = localStorage.getItem('loggedInUser');
                if (!loggedInUserData) return [];

                const userData = JSON.parse(loggedInUserData);
                // ‚úÖ SEGURAN√áA: N√£o logar emails em produ√ß√£o
                if (window.DEBUG || window.location.hostname === 'localhost') {
                console.log('üîê Carregando permiss√µes de etapas para:', userData.email);
                }

                const { data, error } = await supabaseClient
                    .from('permissoes_coletas')
                    .select('etapa_id')
                    .eq('usuario_id', userData.id);

                if (error) {
                    console.error('‚ùå Erro ao buscar permiss√µes:', error);
                    return [];
                }

                const permissoes = (data || []).map(p => p.etapa_id);
                console.log('‚úÖ Permiss√µes de etapas carregadas:', permissoes);
                return permissoes;
            } catch (error) {
                console.error('‚ùå Erro ao carregar permiss√µes:', error);
                return [];
            }
        }

        async function getSupabaseAuthHeaders() {
            try {
                if (!supabaseClient) {
                    console.warn('‚ö†Ô∏è Supabase n√£o inicializado ao obter headers');
                    // Tentar obter token do localStorage como fallback
                    const userData = localStorage.getItem('loggedInUser');
                    if (userData) {
                        try {
                            const user = JSON.parse(userData);
                            // Se houver token no localStorage, usar
                            if (user.token) {
                                return {
                                    Authorization: `Bearer ${user.token}`
                                };
                            }
                        } catch (e) {
                            console.warn('‚ö†Ô∏è Erro ao parsear userData:', e);
                        }
                    }
                    return {};
                }

                const now = Date.now();
                // Verificar se o token em cache ainda √© v√°lido (com margem de 5 minutos)
                if (supabaseAccessToken && supabaseTokenExpiry && supabaseTokenExpiry - now > 300000) {
                    return {
                        Authorization: `Bearer ${supabaseAccessToken}`
                    };
                }

                // Tentar obter a sess√£o atual
                const { data, error } = await supabaseClient.auth.getSession();

                if (error) {
                    console.error('‚ùå Erro ao obter sess√£o do Supabase:', error);
                    
                    // Se o erro indica sess√£o expirada, limpar cache e tentar refresh
                    if (error.message && (error.message.includes('session') || error.message.includes('expired') || error.message.includes('invalid'))) {
                        console.warn('‚ö†Ô∏è Sess√£o expirada ou inv√°lida, tentando refresh...');
                        supabaseAccessToken = null;
                        supabaseTokenExpiry = 0;
                        
                        try {
                            const { data: refreshData, error: refreshError } = await supabaseClient.auth.refreshSession();
                            if (!refreshError && refreshData?.session?.access_token) {
                                supabaseAccessToken = refreshData.session.access_token;
                                supabaseTokenExpiry = refreshData.session.expires_at ? refreshData.session.expires_at * 1000 : now + (60 * 60 * 1000);
                                console.log('‚úÖ Sess√£o atualizada com sucesso via refresh');
                                return {
                                    Authorization: `Bearer ${supabaseAccessToken}`
                                };
                            } else {
                                console.error('‚ùå Erro ao fazer refresh da sess√£o:', refreshError);
                                // Tentar fallback com localStorage
                                const userData = localStorage.getItem('loggedInUser');
                                if (userData) {
                                    try {
                                        const user = JSON.parse(userData);
                                        if (user.token) {
                                            return {
                                                Authorization: `Bearer ${user.token}`
                                            };
                                        }
                                    } catch (e) {
                                        console.warn('‚ö†Ô∏è Erro ao parsear userData no fallback:', e);
                                    }
                                }
                            }
                        } catch (refreshErr) {
                            console.error('‚ùå Erro ao tentar refresh da sess√£o:', refreshErr);
                        }
                    }
                    
                    // √öltimo fallback: tentar localStorage
                    const userData = localStorage.getItem('loggedInUser');
                    if (userData) {
                        try {
                            const user = JSON.parse(userData);
                            if (user.token) {
                                return {
                                    Authorization: `Bearer ${user.token}`
                                };
                            }
                        } catch (e) {
                            console.warn('‚ö†Ô∏è Erro ao parsear userData no √∫ltimo fallback:', e);
                        }
                    }
                    
                    return {};
                }

                const session = data?.session;
                if (session?.access_token) {
                    supabaseAccessToken = session.access_token;
                    supabaseTokenExpiry = session.expires_at ? session.expires_at * 1000 : now + (60 * 60 * 1000);
                    return {
                        Authorization: `Bearer ${supabaseAccessToken}`
                    };
                }

                console.warn('‚ö†Ô∏è Sess√£o n√£o encontrada ao obter headers');
                // Tentar fallback com localStorage
                const userData = localStorage.getItem('loggedInUser');
                if (userData) {
                    try {
                        const user = JSON.parse(userData);
                        if (user.token) {
                            return {
                                Authorization: `Bearer ${user.token}`
                            };
                        }
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Erro ao parsear userData:', e);
                    }
                }
                return {};
            } catch (error) {
                console.error('‚ùå Erro ao construir headers de autentica√ß√£o:', error);
                return {};
            }
        }

        // Verificar se o usu√°rio tem permiss√£o para a etapa
        function temPermissaoEtapa(etapaId) {
            // Todos os usu√°rios t√™m acesso √† etapa finalizar_operacao
            if (etapaId === 'finalizar_operacao') {
                console.log('‚úÖ Etapa finalizar_operacao: acesso liberado para todos');
                return true;
            }

            // Se for admin, tem permiss√£o para tudo
            const loggedInUserData = localStorage.getItem('loggedInUser');
            if (loggedInUserData) {
                const userData = JSON.parse(loggedInUserData);
                if (userData.isAdmin === true || userData.role === 'admin') {
                    // ‚úÖ SEGURAN√áA: Logs condicionais apenas em desenvolvimento
                    if (window.DEBUG || window.location.hostname === 'localhost') {
                    console.log('‚úÖ Usu√°rio √© admin, permiss√£o concedida para etapa:', etapaId);
                    }
                    return true;
                }
            }

            // Verificar se a etapa est√° nas permiss√µes
            const temPermissao = permissoesEtapasColetas.includes(etapaId);
            // ‚úÖ SEGURAN√áA: Logs condicionais apenas em desenvolvimento
            if (window.DEBUG || window.location.hostname === 'localhost') {
            console.log(`üîç Verificando permiss√£o para etapa ${etapaId}:`, temPermissao);
            }
            return temPermissao;
        }

        // ========== KANBAN FUNCTIONS ==========
        let visualizacaoAtual = 'kanban'; // 'grid' ou 'kanban' - Kanban √© o modo principal

        async function alternarVisualizacao(tipo) {
            visualizacaoAtual = tipo;
            const gridContainer = document.getElementById('coletasGrid');
            const kanbanContainer = document.getElementById('kanbanContainer');
            const btnGrid = document.getElementById('btnViewGrid');
            const btnKanban = document.getElementById('btnViewKanban');

            if (!gridContainer || !kanbanContainer || !btnGrid || !btnKanban) {
                console.error('‚ùå Elementos de visualiza√ß√£o n√£o encontrados');
                return;
            }

            if (tipo === 'grid') {
                // Mostrar grid e ocultar kanban
                gridContainer.style.display = 'grid';
                kanbanContainer.style.display = 'none';
                
                // Atualizar estilos dos bot√µes
                btnGrid.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                btnGrid.style.color = 'white';
                btnKanban.style.background = 'transparent';
                btnKanban.style.color = '#667eea';
                
                // Re-renderizar grid
                console.log('üîÑ Alternando para Grid');
                await renderColetasWrapper();
            } else {
                // Mostrar kanban e ocultar grid
                gridContainer.style.display = 'none';
                kanbanContainer.style.display = 'block';
                
                // Atualizar estilos dos bot√µes
                btnKanban.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                btnKanban.style.color = 'white';
                btnGrid.style.background = 'transparent';
                btnGrid.style.color = '#667eea';
                
                // Re-renderizar kanban
                console.log('üîÑ Alternando para Kanban');
                await renderColetasKanban();
            }
        }

        async function renderColetasKanban(filteredData = null) {
            const kanbanBoard = document.getElementById('kanbanBoard');
            if (!kanbanBoard) return;

            let dataToRender = filteredData || window.coletasAtivas || coletasData.filter(c => !c.arquivado);

            // Remover duplicatas
            const coletasUnicas = [];
            const idsVistos = new Set();
            for (const coleta of dataToRender) {
                if (coleta && coleta.id && !idsVistos.has(coleta.id)) {
                    idsVistos.add(coleta.id);
                    coletasUnicas.push(coleta);
                }
            }
            dataToRender = coletasUnicas;

            // ‚úÖ PERFORMANCE: N√ÉO carregar dados pesados aqui - apenas dados b√°sicos
            // Os dados completos ser√£o carregados sob demanda quando o drawer abrir

            // Agrupar coletas por etapa
            const coletasPorEtapa = {};
            ETAPAS.forEach(etapa => {
                coletasPorEtapa[etapa.id] = dataToRender.filter(c => c.etapa_atual === etapa.id);
            });

            // Fun√ß√£o para calcular valor total de coletas
            const calcularValorTotal = (coletas) => {
                return coletas.reduce((total, coleta) => {
                    const valor = parseFloat(coleta.valor) || 0;
                    return total + valor;
                }, 0);
            };

            // Fun√ß√£o para formatar valor em moeda brasileira
            const formatarMoeda = (valor) => {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(valor);
            };

            // Renderizar colunas
            kanbanBoard.innerHTML = ETAPAS.map(etapa => {
                const coletas = coletasPorEtapa[etapa.id] || [];
                const valorTotal = calcularValorTotal(coletas);
                const valorFormatado = formatarMoeda(valorTotal);
                
                return `
                    <div class="kanban-column" data-etapa-id="${etapa.id}">
                        <div class="kanban-column-header">
                            <div class="kanban-column-title">
                                <i class="fas fa-layer-group"></i>
                                ${etapa.nome}
                            </div>
                            <div class="kanban-column-info">
                                <div class="kanban-column-count">${coletas.length}</div>
                                <div class="kanban-column-value">${valorFormatado}</div>
                            </div>
                        </div>
                        <div class="kanban-column-cards" 
                             ondrop="handleKanbanDrop(event, '${etapa.id}')" 
                             ondragover="handleKanbanDragOver(event)"
                             ondragleave="handleKanbanDragLeave(event)">
                            ${coletas.map(coleta => createKanbanCard(coleta)).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            // Adicionar event listeners de drag
            setTimeout(() => {
                document.querySelectorAll('.kanban-card').forEach(card => {
                    card.addEventListener('dragstart', handleKanbanDragStart);
                    card.addEventListener('dragend', handleKanbanDragEnd);
                });
            }, 100);
            
            // Configurar navega√ß√£o do Kanban
            setTimeout(() => {
                configurarNavegacaoKanban();
            }, 200);
        }
        
        // Fun√ß√£o para configurar navega√ß√£o do Kanban
        function configurarNavegacaoKanban() {
            const kanbanBoard = document.getElementById('kanbanBoard');
            const kanbanWrapper = kanbanBoard?.parentElement;
            const navPrev = document.getElementById('kanbanNavPrev');
            const navNext = document.getElementById('kanbanNavNext');
            const stagesIndicator = document.getElementById('kanbanStagesIndicator');
            const stagesInfo = document.getElementById('kanbanStagesInfo');
            
            if (!kanbanBoard || !kanbanWrapper || !navPrev || !navNext) return;
            
            const columns = kanbanBoard.querySelectorAll('.kanban-column');
            const totalColumns = columns.length;
            let currentIndex = 0;
            
            // Criar indicadores de etapas
            if (stagesIndicator && totalColumns > 0) {
                stagesIndicator.innerHTML = '';
                columns.forEach((col, index) => {
                    const dot = document.createElement('div');
                    dot.className = 'kanban-stage-dot' + (index === 0 ? ' active' : '');
                    dot.title = col.querySelector('.kanban-column-title')?.textContent?.trim() || `Etapa ${index + 1}`;
                    dot.addEventListener('click', () => {
                        scrollToStage(index);
                    });
                    stagesIndicator.appendChild(dot);
                });
            }
            
            // Fun√ß√£o para rolar para uma etapa espec√≠fica
            function scrollToStage(index) {
                if (index < 0 || index >= totalColumns) return;
                
                const targetColumn = columns[index];
                if (!targetColumn) return;
                
                // Usar o wrapper para scroll
                const wrapper = kanbanWrapper;
                const wrapperRect = wrapper.getBoundingClientRect();
                const columnRect = targetColumn.getBoundingClientRect();
                
                // Calcular posi√ß√£o para centralizar a coluna
                const columnCenter = columnRect.left - wrapperRect.left + wrapper.scrollLeft + (columnRect.width / 2);
                const targetScroll = columnCenter - (wrapperRect.width / 2);
                
                // Scroll suave no wrapper
                wrapper.scrollTo({
                    left: targetScroll,
                    behavior: 'smooth'
                });
                
                currentIndex = index;
                
                // Atualizar ap√≥s scroll
                setTimeout(() => {
                    updateNavigation();
                }, 300);
            }
            
            // Fun√ß√£o para atualizar estado dos bot√µes e indicadores
            function updateNavigation() {
                // Atualizar bot√µes
                navPrev.disabled = currentIndex <= 0;
                navNext.disabled = currentIndex >= totalColumns - 1;
                
                // Atualizar indicadores
                if (stagesIndicator) {
                    stagesIndicator.querySelectorAll('.kanban-stage-dot').forEach((dot, index) => {
                        dot.classList.toggle('active', index === currentIndex);
                    });
                }
                
                // Atualizar informa√ß√£o
                if (stagesInfo && totalColumns > 0) {
                    const etapaNome = columns[currentIndex]?.querySelector('.kanban-column-title')?.textContent?.trim() || '';
                    stagesInfo.textContent = `${currentIndex + 1} de ${totalColumns}${etapaNome ? ` - ${etapaNome}` : ''}`;
                }
            }
            
            // Event listeners dos bot√µes
            navPrev.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (currentIndex > 0) {
                    scrollToStage(currentIndex - 1);
                }
            });
            
            navNext.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (currentIndex < totalColumns - 1) {
                    scrollToStage(currentIndex + 1);
                }
            });
            
            // Atualizar √≠ndice baseado no scroll do wrapper
            const wrapperForScroll = kanbanBoard.parentElement;
            if (wrapperForScroll) {
                wrapperForScroll.addEventListener('scroll', () => {
                    const scrollLeft = wrapperForScroll.scrollLeft;
                    const wrapperWidth = wrapperForScroll.clientWidth;
                    const centerX = scrollLeft + (wrapperWidth / 2);
                
                    let closestIndex = 0;
                    let closestDistance = Infinity;
                    
                    columns.forEach((col, index) => {
                        const colRect = col.getBoundingClientRect();
                        const wrapperRect = wrapperForScroll.getBoundingClientRect();
                        const colCenterX = colRect.left - wrapperRect.left + (colRect.width / 2) + scrollLeft;
                        const distance = Math.abs(colCenterX - centerX);
                        
                        if (distance < closestDistance) {
                            closestDistance = distance;
                            closestIndex = index;
                        }
                    });
                    
                    if (closestIndex !== currentIndex) {
                        currentIndex = closestIndex;
                        updateNavigation();
                    }
                });
            }
            
            // Inicializar
            updateNavigation();
            
            // Atualizar quando redimensionar
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    updateNavigation();
                }, 200);
            });
        }
        
        // Fun√ß√£o para sincronizar a barra de rolagem customizada com o kanban-board
        function sincronizarScrollbarKanban() {
            // Scroll nativo do navegador com visual melhorado funciona perfeitamente
            // N√£o precisamos de scrollbar customizada complexa
            return;
            
            // Limpar intervalos e listeners anteriores
            if (window.kanbanScrollInterval) {
                clearInterval(window.kanbanScrollInterval);
            }
            if (window.handleKanbanBoardScroll) {
                kanbanBoard.removeEventListener('scroll', window.handleKanbanBoardScroll);
            }
            if (window.handleKanbanResize) {
                window.removeEventListener('resize', window.handleKanbanResize);
            }
            
            // Throttle para limitar atualiza√ß√µes
            let lastUpdateTime = 0;
            const UPDATE_THROTTLE = 50; // ms
            
            // Fun√ß√£o para atualizar a barra de rolagem customizada
            const updateCustomScrollbar = () => {
                const now = Date.now();
                if (now - lastUpdateTime < UPDATE_THROTTLE) {
                    return;
                }
                lastUpdateTime = now;
                
                if (!kanbanBoard || !scrollbarWrapper || !scrollbarTrack || !scrollbarThumb) {
                    return;
                }
                
                // For√ßar c√°lculo do scrollWidth
                const boardScrollWidth = kanbanBoard.scrollWidth;
                const boardClientWidth = kanbanBoard.clientWidth;
                const boardScrollLeft = kanbanBoard.scrollLeft;
                
                // Calcular a largura total das colunas manualmente
                const columns = kanbanBoard.querySelectorAll('.kanban-column');
                let totalColumnsWidth = 0;
                columns.forEach(col => {
                    const colWidth = col.offsetWidth || col.getBoundingClientRect().width || 260;
                    totalColumnsWidth += colWidth;
                });
                // Adicionar gaps entre colunas (1rem = 16px por gap)
                totalColumnsWidth += (columns.length - 1) * 16;
                // Adicionar padding do board (1rem de cada lado = 32px)
                totalColumnsWidth += 32;
                
                // Verificar se precisa de scroll (comparar largura total com largura vis√≠vel)
                // Usar uma margem menor para detectar melhor quando precisa de scroll
                const needsScroll = totalColumnsWidth > boardClientWidth + 1 || boardScrollWidth > boardClientWidth + 1;
                
                // SEMPRE mostrar a scrollbar se houver mais de uma coluna
                // Isso garante que o usu√°rio possa navegar entre todas as etapas
                if (columns.length === 0) {
                    scrollbarWrapper.classList.add('hidden');
                    scrollbarWrapper.classList.remove('visible');
                    return;
                }
                
                // Sempre mostrar quando h√° m√∫ltiplas colunas
                if (columns.length > 1) {
                    scrollbarWrapper.classList.remove('hidden');
                    scrollbarWrapper.classList.add('visible');
                    scrollbarWrapper.style.display = 'block';
                    scrollbarWrapper.style.visibility = 'visible';
                    scrollbarWrapper.style.opacity = '1';
                    scrollbarWrapper.style.width = '100%';
                } else {
                    scrollbarWrapper.classList.add('hidden');
                    scrollbarWrapper.classList.remove('visible');
                    return;
                }
                
                // Aguardar um frame para garantir que o track tenha largura
                requestAnimationFrame(() => {
                    const trackWidth = scrollbarTrack.offsetWidth || scrollbarTrack.clientWidth || scrollbarTrack.getBoundingClientRect().width;
                    
                    if (trackWidth === 0 || !trackWidth) {
                        // Se ainda n√£o tem largura, tentar novamente
                        setTimeout(() => updateCustomScrollbar(), 50);
                        return;
                    }
                    
                    // Usar a largura total calculada para melhor precis√£o
                    const effectiveScrollWidth = Math.max(boardScrollWidth, totalColumnsWidth);
                    
                    // Calcular propor√ß√£o do thumb
                    const thumbRatio = boardClientWidth / effectiveScrollWidth;
                    const thumbWidth = Math.max(60, Math.min(trackWidth * 0.9, trackWidth * thumbRatio));
                    scrollbarThumb.style.width = `${thumbWidth}px`;
                    
                    // Calcular posi√ß√£o do thumb baseado no scroll atual do board
                    const maxThumbLeft = trackWidth - thumbWidth;
                    const maxScroll = Math.max(1, effectiveScrollWidth - boardClientWidth);
                    const currentScroll = kanbanBoard.scrollLeft || 0;
                    const scrollRatio = maxScroll > 0 ? currentScroll / maxScroll : 0;
                    const thumbLeft = Math.max(0, Math.min(maxThumbLeft, scrollRatio * maxThumbLeft));
                    scrollbarThumb.style.left = `${thumbLeft}px`;
                    
                    // Atualizar estado dos bot√µes
                    if (scrollLeftBtn && scrollRightBtn) {
                        scrollLeftBtn.disabled = boardScrollLeft <= 1;
                        scrollRightBtn.disabled = boardScrollLeft >= (maxScroll - 1);
                    }
                });
            };
            
            // Flag para evitar loop infinito
            let isUpdatingScrollbar = false;
            
            // Handler de scroll do board
            window.handleKanbanBoardScroll = () => {
                if (!isUpdatingScrollbar && !isDraggingThumb) {
                    updateCustomScrollbar();
                }
            };
            kanbanBoard.addEventListener('scroll', window.handleKanbanBoardScroll, { passive: true });
            
            // Permitir scroll horizontal com shift + wheel no board
            kanbanBoard.addEventListener('wheel', (e) => {
                if (e.shiftKey || Math.abs(e.deltaX) > Math.abs(e.deltaY)) {
                    e.preventDefault();
                    kanbanBoard.scrollLeft += e.deltaX || e.deltaY;
                    updateCustomScrollbar();
                }
            }, { passive: false });
            
            // Bot√µes de seta
            if (scrollLeftBtn) {
                scrollLeftBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const currentScroll = kanbanBoard.scrollLeft;
                    const newScroll = Math.max(0, currentScroll - 300);
                    isUpdatingScrollbar = true;
                    kanbanBoard.scrollTo({ left: newScroll, behavior: 'smooth' });
                    setTimeout(() => {
                        isUpdatingScrollbar = false;
                        updateCustomScrollbar();
                    }, 300);
                });
            }
            
            if (scrollRightBtn) {
                scrollRightBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const currentScroll = kanbanBoard.scrollLeft;
                    const maxScroll = kanbanBoard.scrollWidth - kanbanBoard.clientWidth;
                    const newScroll = Math.min(maxScroll, currentScroll + 300);
                    isUpdatingScrollbar = true;
                    kanbanBoard.scrollTo({ left: newScroll, behavior: 'smooth' });
                    setTimeout(() => {
                        isUpdatingScrollbar = false;
                        updateCustomScrollbar();
                    }, 300);
                });
            }
            
            // Arrastar o thumb
            let isDraggingThumb = false;
            let dragStartX = 0;
            let dragStartLeft = 0;
            
            scrollbarThumb.addEventListener('mousedown', (e) => {
                isDraggingThumb = true;
                dragStartX = e.clientX;
                dragStartLeft = parseFloat(scrollbarThumb.style.left) || 0;
                e.preventDefault();
                e.stopPropagation();
            });
            
            const handleThumbMouseMove = (e) => {
                if (!isDraggingThumb) return;
                e.preventDefault();
                
                const trackWidth = scrollbarTrack.offsetWidth || scrollbarTrack.getBoundingClientRect().width;
                const thumbWidth = scrollbarThumb.offsetWidth || scrollbarThumb.getBoundingClientRect().width;
                const maxThumbLeft = trackWidth - thumbWidth;
                
                const deltaX = e.clientX - dragStartX;
                let newThumbLeft = dragStartLeft + deltaX;
                newThumbLeft = Math.max(0, Math.min(maxThumbLeft, newThumbLeft));
                
                scrollbarThumb.style.left = `${newThumbLeft}px`;
                
                // Calcular scroll do board
                const boardScrollWidth = kanbanBoard.scrollWidth;
                const boardClientWidth = kanbanBoard.clientWidth;
                const columns = kanbanBoard.querySelectorAll('.kanban-column');
                let totalColumnsWidth = 0;
                columns.forEach(col => {
                    totalColumnsWidth += (col.offsetWidth || col.getBoundingClientRect().width || 260);
                });
                totalColumnsWidth += (columns.length - 1) * 16 + 32;
                const effectiveScrollWidth = Math.max(boardScrollWidth, totalColumnsWidth);
                const maxScroll = Math.max(1, effectiveScrollWidth - boardClientWidth);
                const scrollRatio = maxThumbLeft > 0 ? newThumbLeft / maxThumbLeft : 0;
                const newScrollLeft = scrollRatio * maxScroll;
                
                // For√ßar atualiza√ß√£o do scroll - usar scrollLeft diretamente para resposta imediata
                isUpdatingScrollbar = true;
                const finalScroll = Math.max(0, Math.min(newScrollLeft, maxScroll));
                kanbanBoard.scrollLeft = finalScroll;
                // For√ßar atualiza√ß√£o visual imediata
                kanbanBoard.style.scrollBehavior = 'auto';
                // Atualizar a scrollbar ap√≥s o scroll
                requestAnimationFrame(() => {
                    isUpdatingScrollbar = false;
                    kanbanBoard.style.scrollBehavior = 'smooth';
                    // Garantir que a posi√ß√£o do thumb esteja sincronizada
                    updateCustomScrollbar();
                });
            };
            
            const handleThumbMouseUp = () => {
                isDraggingThumb = false;
            };
            
            document.addEventListener('mousemove', handleThumbMouseMove);
            document.addEventListener('mouseup', handleThumbMouseUp);
            
            // Clicar na track para mover
            scrollbarTrack.addEventListener('click', (e) => {
                if (e.target === scrollbarThumb) return;
                
                const trackRect = scrollbarTrack.getBoundingClientRect();
                const clickX = e.clientX - trackRect.left;
                const trackWidth = scrollbarTrack.offsetWidth || scrollbarTrack.getBoundingClientRect().width;
                const thumbWidth = scrollbarThumb.offsetWidth || scrollbarThumb.getBoundingClientRect().width;
                const thumbCenter = thumbWidth / 2;
                
                let newThumbLeft = clickX - thumbCenter;
                const maxThumbLeft = trackWidth - thumbWidth;
                newThumbLeft = Math.max(0, Math.min(maxThumbLeft, newThumbLeft));
                
                scrollbarThumb.style.left = `${newThumbLeft}px`;
                
                // Calcular scroll do board
                const boardScrollWidth = kanbanBoard.scrollWidth;
                const boardClientWidth = kanbanBoard.clientWidth;
                const columns = kanbanBoard.querySelectorAll('.kanban-column');
                let totalColumnsWidth = 0;
                columns.forEach(col => {
                    totalColumnsWidth += (col.offsetWidth || col.getBoundingClientRect().width || 260);
                });
                totalColumnsWidth += (columns.length - 1) * 16 + 32;
                const effectiveScrollWidth = Math.max(boardScrollWidth, totalColumnsWidth);
                const maxScroll = Math.max(1, effectiveScrollWidth - boardClientWidth);
                const scrollRatio = maxThumbLeft > 0 ? newThumbLeft / maxThumbLeft : 0;
                const newScrollLeft = scrollRatio * maxScroll;
                
                // For√ßar atualiza√ß√£o do scroll
                isUpdatingScrollbar = true;
                kanbanBoard.scrollTo({ left: newScrollLeft, behavior: 'smooth' });
                // For√ßar reflow para garantir que o scroll seja aplicado
                kanbanBoard.offsetHeight;
                setTimeout(() => {
                    isUpdatingScrollbar = false;
                    updateCustomScrollbar();
                }, 300);
            });
            
            // Atualizar quando redimensionar (com debounce)
            let resizeTimeout;
            window.handleKanbanResize = () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(updateCustomScrollbar, 200);
            };
            window.addEventListener('resize', window.handleKanbanResize);
            
            // Atualizar inicialmente ap√≥s renderiza√ß√£o
            setTimeout(updateCustomScrollbar, 100);
            requestAnimationFrame(() => {
                setTimeout(updateCustomScrollbar, 200);
            });
            
            // Observar mudan√ßas no tamanho do kanban-board (com throttle)
            if (window.kanbanResizeObserver) {
                window.kanbanResizeObserver.disconnect();
            }
            let resizeObserverTimeout;
            window.kanbanResizeObserver = new ResizeObserver(() => {
                clearTimeout(resizeObserverTimeout);
                resizeObserverTimeout = setTimeout(updateCustomScrollbar, 100);
            });
            window.kanbanResizeObserver.observe(kanbanBoard);
            
            // Observar mudan√ßas no conte√∫do tamb√©m (com throttle)
            if (window.kanbanMutationObserver) {
                window.kanbanMutationObserver.disconnect();
            }
            let mutationObserverTimeout;
            window.kanbanMutationObserver = new MutationObserver(() => {
                clearTimeout(mutationObserverTimeout);
                mutationObserverTimeout = setTimeout(updateCustomScrollbar, 300);
            });
            window.kanbanMutationObserver.observe(kanbanBoard, {
                childList: true,
                subtree: true,
                attributes: false
            });
        }

        function createKanbanCard(coleta) {
            const podeMover = temPermissaoEtapa(coleta.etapa_atual);
            const statusClass = coleta.status || 'pendente';
            const isDiaria = coleta.diaria === true || coleta.diaria === 'true' || coleta.diaria === 1;
            const isUrgente = coleta.prioridade === 'urgente';
            
            // Estilo do card baseado se √© di√°ria ou urgente
            // Prioridade: Se for di√°ria E urgente, fica azul (di√°ria tem prioridade)
            // Se for apenas urgente (sem di√°ria), fica vermelho
            let cardStyle = '';
            let textColor = '';
            
            if (isDiaria) {
                // Di√°ria sempre azul, mesmo se for urgente
                cardStyle = 'background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: white; border: 2px solid #0ea5e9; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);';
                textColor = 'color: white;';
            } else if (isUrgente) {
                // Urgente sem di√°ria fica vermelho
                cardStyle = 'background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: 2px solid #dc3545; box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);';
                textColor = 'color: white;';
            }
            
            // ‚úÖ CARD LEVE: Apenas dados essenciais para performance
            return `
                <div class="kanban-card ${!podeMover ? 'no-drag' : ''}" 
                     draggable="${podeMover}"
                     data-coleta-id="${coleta.id}"
                     data-etapa-atual="${coleta.etapa_atual}"
                     onclick="abrirKanbanDrawer('${coleta.id}')"
                     style="${cardStyle}">
                    <div class="kanban-card-header">
                        <div class="kanban-card-title" style="${textColor}; display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                            <span style="flex: 1; min-width: 0;">${escapeHtml(coleta.cliente || 'Sem cliente')}</span>
                            ${isDiaria ? '<span style="background: rgba(255, 255, 255, 0.3); color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; flex-shrink: 0;"><i class="fas fa-calendar-day"></i> DI√ÅRIA</span>' : ''}
                            ${isUrgente ? '<span style="background: rgba(255, 255, 255, 0.3); color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; flex-shrink: 0; animation: piscarBadgeUrgente 1.5s ease-in-out infinite;"><i class="fas fa-exclamation-triangle"></i> URGENTE</span>' : ''}
                        </div>
                    </div>
                    
                    <div class="kanban-card-body">
                        ${coleta.filial && coleta.numero_coleta ? `
                            <div class="kanban-card-info" style="${isDiaria || isUrgente ? 'color: rgba(255, 255, 255, 0.9);' : ''}">
                                <i class="fas fa-building"></i> ${coleta.filial} | 
                                <i class="fas fa-hashtag"></i> ${coleta.numero_coleta}
                            </div>
                        ` : ''}
                        <div class="kanban-card-info" style="${isDiaria || isUrgente ? 'color: rgba(255, 255, 255, 0.9);' : ''}">
                            <i class="fas fa-map-marker-alt"></i> ${escapeHtml(coleta.origem || 'N/A')} ‚Üí ${escapeHtml(coleta.destino || 'N/A')}
                        </div>
                        ${coleta.valor ? `
                            <div class="kanban-card-info" style="font-weight: 600; ${isDiaria || isUrgente ? 'color: white;' : 'color: #667eea;'}">
                                <i class="fas fa-dollar-sign"></i> R$ ${(coleta.valor || 0).toFixed(2)}
                            </div>
                        ` : ''}
                        ${coleta.etapa_atual === 'contas_pagar' && coleta.contas_pagar_tipo ? `
                            <div class="kanban-card-info" style="background: ${isUrgente || isDiaria ? 'rgba(255, 255, 255, 0.2);' : 'rgba(72, 12, 168, 0.1);'}; padding: 0.4rem 0.6rem; border-radius: 6px; margin-top: 0.5rem; border-left: 3px solid ${isUrgente || isDiaria ? 'white;' : '#480ca8;'}">
                                <i class="fas fa-money-bill-wave" style="color: ${isUrgente || isDiaria ? 'white;' : '#480ca8;'}"></i> 
                                <span style="color: ${isUrgente || isDiaria ? 'white;' : '#480ca8;'}; font-weight: 600; font-size: 0.85rem;">${escapeHtml(coleta.contas_pagar_tipo)}</span>
                                ${coleta.contas_pagar_pago ? `
                                    <span style="color: ${isUrgente || isDiaria ? 'rgba(255, 255, 255, 0.9);' : '#28a745;'}; font-size: 0.75rem; margin-left: 0.5rem;">
                                        <i class="fas fa-check-circle"></i> Pago
                                    </span>
                                ` : `
                                    <span style="color: ${isUrgente || isDiaria ? 'rgba(255, 255, 255, 0.8);' : '#ffc107;'}; font-size: 0.75rem; margin-left: 0.5rem;">
                                        <i class="fas fa-clock"></i> Pendente
                                    </span>
                                `}
                            </div>
                        ` : ''}
                        ${coleta.titulo_contrato ? `
                            <div class="kanban-card-info" style="background: ${isUrgente || isDiaria ? 'rgba(255, 255, 255, 0.2);' : 'rgba(253, 126, 20, 0.1);'}; padding: 0.4rem 0.6rem; border-radius: 6px; margin-top: 0.5rem; border-left: 3px solid ${isUrgente || isDiaria ? 'white;' : '#fd7e14;'}">
                                <i class="fas fa-file-contract" style="color: ${isUrgente || isDiaria ? 'white;' : '#fd7e14;'}"></i> 
                                <span style="color: ${isUrgente || isDiaria ? 'white;' : '#fd7e14;'}; font-weight: 600; font-size: 0.85rem; word-break: break-word;">${escapeHtml(coleta.titulo_contrato)}</span>
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="kanban-card-footer">
                        <span class="kanban-card-status ${statusClass}">${getStatusText(coleta.status)}</span>
                        <button class="kanban-card-btn" onclick="event.stopPropagation(); abrirKanbanDrawer('${coleta.id}')" title="Ver detalhes">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                    </div>
                </div>
            `;
        }

        function createKanbanExpandedContent(coleta, progresso) {
            const temPermissao = temPermissaoEtapa(coleta.etapa_atual);
            
            return `
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid rgba(102, 126, 234, 0.2);">
                    <!-- Informa√ß√µes Detalhadas -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <strong><i class="fas fa-truck"></i> Tipos de Ve√≠culo:</strong>
                            <div style="margin-top: 0.25rem;">
                                ${coleta.tipos_veiculo && coleta.tipos_veiculo.length > 0 
                                    ? coleta.tipos_veiculo.map(v => `<span style="background: #667eea; color: white; padding: 0.2rem 0.5rem; border-radius: 6px; font-size: 0.75rem; margin-right: 0.25rem; display: inline-block;">${v}</span>`).join('')
                                    : '<span style="color: #999;">-</span>'}
                            </div>
                        </div>
                        <div>
                            <strong><i class="fas fa-box"></i> Tipos de Carroceria:</strong>
                            <div style="margin-top: 0.25rem;">
                                ${coleta.tipos_carroceria && coleta.tipos_carroceria.length > 0 
                                    ? coleta.tipos_carroceria.map(c => {
                                        const nomeAmigavel = tiposCarroceriaMap[c] || c;
                                        return `<span style="background: #f5576c; color: white; padding: 0.2rem 0.5rem; border-radius: 6px; font-size: 0.75rem; margin-right: 0.25rem; display: inline-block;">${nomeAmigavel}</span>`;
                                    }).join('')
                                    : '<span style="color: #999;">-</span>'}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Etiquetas -->
                    ${coleta.etiquetas && coleta.etiquetas.length > 0 ? `
                        <div style="margin-bottom: 1rem;">
                            <strong><i class="fas fa-tags"></i> Etiquetas:</strong>
                            <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${coleta.etiquetas.map(et => `
                                    <span style="background: ${et.cor || '#667eea'}; color: white; padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.75rem;">
                                        <i class="fas fa-tag"></i> ${et.nome}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Motorista -->
                    ${coleta.motorista_id ? `
                        <div style="background: rgba(40, 167, 69, 0.1); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #28a745;">
                            <strong><i class="fas fa-user-check"></i> Motorista:</strong>
                            <div id="kanban-motorista-info-${coleta.id}" style="margin-top: 0.5rem;">
                                <i class="fas fa-spinner fa-spin"></i> Carregando...
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Anexos -->
                    ${coleta.anexos && coleta.anexos.length > 0 ? `
                        <div style="margin-bottom: 1rem;">
                            <strong><i class="fas fa-paperclip"></i> Anexos (${coleta.anexos.length}):</strong>
                            <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${coleta.anexos.slice(0, 5).map(anexo => `
                                    <a href="${anexo.url}" target="_blank" 
                                       style="background: #667eea; color: white; padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.75rem; text-decoration: none; display: inline-flex; align-items: center; gap: 0.3rem;"
                                       onclick="event.stopPropagation();">
                                        <i class="fas fa-file"></i> ${anexo.nome || 'Anexo'}
                                    </a>
                                `).join('')}
                                ${coleta.anexos.length > 5 ? `<span style="color: #999; font-size: 0.75rem;">+${coleta.anexos.length - 5} mais</span>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Progresso das Etapas -->
                    <div style="margin-bottom: 1rem;">
                        <strong><i class="fas fa-project-diagram"></i> Progresso: ${progresso.concluidas}/${progresso.total} etapas</strong>
                        <div style="margin-top: 0.5rem; background: rgba(0,0,0,0.1); border-radius: 8px; height: 8px; overflow: hidden;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: ${(progresso.concluidas / progresso.total) * 100}%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    
                    <!-- ITs Relacionadas -->
                    ${coleta.cliente ? `
                        <div id="kanban-its-${coleta.id}" style="margin-bottom: 1rem;">
                            <strong><i class="fas fa-file-alt"></i> ITs Relacionadas:</strong>
                            <div style="margin-top: 0.5rem; color: #999; font-size: 0.85rem;">
                                <i class="fas fa-spinner fa-spin"></i> Carregando...
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Hist√≥rico -->
                    <div id="kanban-historico-${coleta.id}" style="margin-bottom: 1rem;">
                        <strong><i class="fas fa-history"></i> √öltimas Movimenta√ß√µes:</strong>
                        <div style="margin-top: 0.5rem; color: #999; font-size: 0.85rem;">
                            <i class="fas fa-spinner fa-spin"></i> Carregando...
                        </div>
                    </div>
                    
                    <!-- Bot√µes de A√ß√£o -->
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(0,0,0,0.1);">
                        <button onclick="event.stopPropagation(); openChatModal('${coleta.id}')" 
                                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600;">
                            <i class="fas fa-comment"></i> Chat
                        </button>
                        ${temPermissao ? `
                            <button onclick="event.stopPropagation(); avancarEtapa('${coleta.id}')" 
                                    style="background: #28a745; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600;">
                                <i class="fas fa-arrow-right"></i> Avan√ßar
                            </button>
                            <button onclick="event.stopPropagation(); openEditColetaModal('${coleta.id}')" 
                                    style="background: #667eea; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600;">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // ========== DRAWER DO KANBAN (WORKSPACE) ==========
        async function abrirKanbanDrawer(coletaId) {
            const drawer = document.getElementById('kanbanDrawer');
            const drawerContent = document.getElementById('kanbanDrawerContent');
            
            if (!drawer || !drawerContent) return;
            
            // Mostrar drawer
            drawer.classList.add('active');
            
            // Mostrar loading
            drawerContent.innerHTML = `
                <div class="kanban-drawer-header">
                    <div class="kanban-drawer-title">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Carregando...</span>
                    </div>
                    <button class="kanban-drawer-close" onclick="fecharKanbanDrawer()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="kanban-drawer-body">
                    <div style="text-align: center; padding: 3rem;">
                        <i class="fas fa-spinner fa-spin fa-3x" style="color: #667eea; margin-bottom: 1rem;"></i>
                        <p>Carregando dados da coleta...</p>
                    </div>
                </div>
            `;
            
            // Carregar dados completos sob demanda
            await carregarConteudoDrawer(coletaId);
        }

        function fecharKanbanDrawer() {
            const drawer = document.getElementById('kanbanDrawer');
            if (drawer) {
                drawer.classList.remove('active');
            }
        }

        async function carregarConteudoDrawer(coletaId) {
            const drawerContent = document.getElementById('kanbanDrawerContent');
            const coleta = coletasData.find(c => c.id === coletaId);
            
            if (!coleta || !drawerContent) return;
            
            const temPermissao = temPermissaoEtapa(coleta.etapa_atual);
            const progresso = calcularProgressoEtapas(coleta);
            
            // Carregar dados pesados sob demanda
            const [anexos, motorista, historico, its] = await Promise.all([
                carregarAnexos(coletaId),
                coleta.motorista_id ? buscarMotoristaPorId(coleta.motorista_id).catch(() => null) : Promise.resolve(null),
                carregarHistorico(coletaId),
                coleta.cliente ? carregarITsRelacionadasParaDrawer(coleta.cliente, coleta.filial) : Promise.resolve([])
            ]);
            
            // Verificar se motorista est√° reprovado ESPECIFICAMENTE PARA ESTA COLETA
            const reprovacaoInfo = verificarReprovacaoPorColeta(motorista, coleta.id);
            const motoristaReprovado = reprovacaoInfo.reprovado;
            
            // Log para debug
            if (coleta.etapa_atual === 'contratacao' && coleta.motorista_id) {
                console.log('üîç Verificando motorista reprovado:', {
                    coletaId: coletaId,
                    motoristaId: coleta.motorista_id,
                    motorista: motorista ? {
                        nome: motorista.nome,
                        reprovado: motorista.reprovado,
                        motivo: motorista.motivo_reprovacao
                    } : null,
                    motoristaReprovado: motoristaReprovado
                });
            }
            
            // Renderizar conte√∫do completo
            drawerContent.innerHTML = `
                <div class="kanban-drawer-header">
                    <div class="kanban-drawer-title">
                        <i class="fas fa-file-invoice"></i>
                        <div>
                            <div>${escapeHtml(coleta.cliente || 'Sem cliente')}</div>
                            ${coleta.filial && coleta.numero_coleta ? `
                                <div style="font-size: 0.85rem; color: #6c757d; font-weight: normal;">
                                    ${coleta.filial} | Coleta #${coleta.numero_coleta}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <button class="kanban-drawer-close" onclick="fecharKanbanDrawer()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="kanban-drawer-body">
                    <!-- Tabs de Navega√ß√£o -->
                    <div class="kanban-drawer-tabs">
                        <button class="kanban-drawer-tab active" onclick="trocarTabDrawer('geral')">
                            <i class="fas fa-info-circle"></i> Geral
                        </button>
                        <button class="kanban-drawer-tab" onclick="trocarTabDrawer('anexos')">
                            <i class="fas fa-paperclip"></i> Anexos (${anexos?.length || 0})
                        </button>
                        <button class="kanban-drawer-tab" onclick="trocarTabDrawer('motorista')">
                            <i class="fas fa-user"></i> Motorista
                        </button>
                        <button class="kanban-drawer-tab" onclick="trocarTabDrawer('its')">
                            <i class="fas fa-file-alt"></i> ITs Relacionadas
                        </button>
                        <button class="kanban-drawer-tab" onclick="trocarTabDrawer('historico')">
                            <i class="fas fa-history"></i> Hist√≥rico
                        </button>
                        <button class="kanban-drawer-tab" onclick="trocarTabDrawer('chat')">
                            <i class="fas fa-comment"></i> Chat
                        </button>
                    </div>
                    
                    <!-- Tab: Geral -->
                    <div class="kanban-drawer-tab-content active" id="tab-geral">
                        ${renderTabGeral(coleta, progresso, temPermissao)}
                    </div>
                    
                    <!-- Tab: Anexos -->
                    <div class="kanban-drawer-tab-content" id="tab-anexos">
                        ${renderTabAnexos(anexos, coletaId, temPermissao)}
                    </div>
                    
                    <!-- Tab: Motorista -->
                    <div class="kanban-drawer-tab-content" id="tab-motorista">
                        ${renderTabMotorista(motorista, coleta, temPermissao)}
                    </div>
                    
                    <!-- Tab: ITs -->
                    <div class="kanban-drawer-tab-content" id="tab-its">
                        ${renderTabITs(its)}
                    </div>
                    
                    <!-- Tab: Hist√≥rico -->
                    <div class="kanban-drawer-tab-content" id="tab-historico">
                        ${renderTabHistorico(historico)}
                    </div>
                    
                    <!-- Tab: Chat -->
                    <div class="kanban-drawer-tab-content" id="tab-chat">
                        ${renderTabChat(coletaId)}
                    </div>
                </div>
            `;
            
            // Configurar event listener do input file ap√≥s renderizar
            setTimeout(async () => {
                const fileInput = document.getElementById(`drawer-upload-anexo-${coletaId}`);
                if (fileInput) {
                    // Remover listeners antigos clonando o elemento
                    const newInput = fileInput.cloneNode(true);
                    fileInput.parentNode.replaceChild(newInput, fileInput);
                    
                    // Adicionar novo listener
                    newInput.addEventListener('change', function(e) {
                        console.log('üìé Input file change detectado:', e.target.files?.length || 0);
                        const files = e.target.files;
                        if (files && files.length > 0) {
                            // Criar c√≥pia do FileList antes de resetar
                            const filesArray = Array.from(files);
                            console.log('üìé Arquivos capturados antes do reset:', filesArray.map(f => f.name));
                            
                            // Resetar input apenas ap√≥s capturar os arquivos
                            e.target.value = '';
                            
                            // Chamar fun√ß√£o de upload com o array
                            handleDrawerUploadAnexo(coletaId, filesArray);
                        }
                    });
                }
                
                // Verificar e mostrar alerta de motorista reprovado
                // Verificar novamente o status do motorista para garantir que est√° atualizado
                if (coleta.etapa_atual === 'contratacao' && coleta.motorista_id) {
                    let isReprovado = false;
                    let motivoReprovacao = null;
                    
                    if (motorista) {
                        const reprovacaoInfo = verificarReprovacaoPorColeta(motorista, coleta.id);
                        isReprovado = reprovacaoInfo.reprovado;
                        motivoReprovacao = reprovacaoInfo.motivo;
                    } else {
                        // Se o motorista n√£o foi carregado, tentar buscar novamente
                        try {
                            const motoristaRecarregado = await buscarMotoristaPorId(coleta.motorista_id);
                            if (motoristaRecarregado) {
                                const reprovacaoInfo = verificarReprovacaoPorColeta(motoristaRecarregado, coleta.id);
                                isReprovado = reprovacaoInfo.reprovado;
                                motivoReprovacao = reprovacaoInfo.motivo;
                            }
                        } catch (err) {
                            console.warn('‚ö†Ô∏è Erro ao recarregar motorista:', err);
                        }
                    }
                    
                    const alertaDiv = document.getElementById(`alerta-motorista-reprovado-${coletaId}`);
                    if (alertaDiv) {
                        if (isReprovado) {
                            alertaDiv.style.display = 'block';
                            
                            // Atualizar motivo se existir
                            if (motivoReprovacao) {
                                const motivoDiv = document.getElementById(`motivo-reprovacao-${coletaId}`);
                                const motivoTexto = document.getElementById(`motivo-texto-${coletaId}`);
                                if (motivoDiv && motivoTexto) {
                                    motivoTexto.textContent = motivoReprovacao;
                                    motivoDiv.style.display = 'block';
                                }
                            }
                            
                            console.log('‚úÖ Alerta de motorista reprovado exibido para coleta:', coletaId, { motivo: motivoReprovacao });
                        } else {
                            alertaDiv.style.display = 'none';
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Elemento de alerta n√£o encontrado:', `alerta-motorista-reprovado-${coletaId}`);
                    }
                }
            }, 100);
        }

        function trocarTabDrawer(tabId) {
            // Remover active de todas as tabs
            document.querySelectorAll('.kanban-drawer-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.kanban-drawer-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Ativar tab selecionada
            const tab = document.querySelector(`.kanban-drawer-tab[onclick*="${tabId}"]`);
            const content = document.getElementById(`tab-${tabId}`);
            
            if (tab) tab.classList.add('active');
            if (content) content.classList.add('active');
        }

        function renderTabGeral(coleta, progresso, temPermissao) {
            return `
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div>
                        <strong><i class="fas fa-map-marker-alt"></i> Origem:</strong>
                        <div style="margin-top: 0.5rem; color: #666;">${escapeHtml(coleta.origem || 'N/A')}</div>
                    </div>
                    <div>
                        <strong><i class="fas fa-flag-checkered"></i> Destino:</strong>
                        <div style="margin-top: 0.5rem; color: #666;">${escapeHtml(coleta.destino || 'N/A')}</div>
                    </div>
                    <div>
                        <strong><i class="fas fa-dollar-sign"></i> Valor:</strong>
                        <div style="margin-top: 0.5rem; color: #667eea; font-weight: 600; font-size: 1.1rem;">
                            R$ ${(coleta.valor || 0).toFixed(2)}
                        </div>
                    </div>
                    <div>
                        <strong><i class="fas fa-route"></i> KM:</strong>
                        <div style="margin-top: 0.5rem; color: #666;">${coleta.km || '0'} km</div>
                    </div>
                    <div>
                        <strong><i class="fas fa-truck"></i> Tipos de Ve√≠culo:</strong>
                        <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${coleta.tipos_veiculo && coleta.tipos_veiculo.length > 0 
                                ? coleta.tipos_veiculo.map(v => `<span style="background: #667eea; color: white; padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.85rem;">${v}</span>`).join('')
                                : '<span style="color: #999;">-</span>'}
                        </div>
                    </div>
                    <div>
                        <strong><i class="fas fa-box"></i> Tipos de Carroceria:</strong>
                        <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${coleta.tipos_carroceria && coleta.tipos_carroceria.length > 0 
                                ? coleta.tipos_carroceria.map(c => {
                                    const nomeAmigavel = tiposCarroceriaMap[c] || c;
                                    return `<span style="background: #f5576c; color: white; padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.85rem;">${nomeAmigavel}</span>`;
                                }).join('')
                                : '<span style="color: #999;">-</span>'}
                        </div>
                    </div>
                </div>
                
                <!-- Visualiza√ß√£o Completa das Etapas -->
                <div style="margin-bottom: 1.5rem; padding: 1.5rem; background: rgba(102, 126, 234, 0.05); border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <strong style="font-size: 1.1rem;"><i class="fas fa-project-diagram"></i> Etapas do Processo</strong>
                        <span style="color: #667eea; font-weight: 600;">${progresso.concluidas}/${progresso.total} etapas</span>
                    </div>
                    <div style="display: flex; gap: 0.25rem; margin-bottom: 1rem; background: rgba(0,0,0,0.05); border-radius: 8px; padding: 0.25rem; overflow: hidden;">
                        ${ETAPAS.map(etapa => {
                            const isAtiva = coleta.etapa_atual === etapa.id;
                            const passouPorEla = coleta.etapas_concluidas?.includes(etapa.id) || false;
                            const jaPassouMasNaoEAtual = passouPorEla && !isAtiva;
                            const bgColor = isAtiva ? '#28a745' : (jaPassouMasNaoEAtual ? '#667eea' : 'rgba(0,0,0,0.1)');
                            return `<div style="flex: 1; height: 8px; background: ${bgColor}; border-radius: 4px; transition: all 0.3s;"></div>`;
                        }).join('')}
                    </div>
                    <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; justify-content: space-between;">
                        ${ETAPAS.map(etapa => {
                            const isAtiva = coleta.etapa_atual === etapa.id;
                            const passouPorEla = coleta.etapas_concluidas?.includes(etapa.id) || false;
                            const jaPassouMasNaoEAtual = passouPorEla && !isAtiva;
                            const classe = isAtiva ? 'concluida' : (jaPassouMasNaoEAtual ? 'ativa' : '');
                            const icon = isAtiva ? 'fa-check-circle' : (jaPassouMasNaoEAtual ? 'fa-check-circle' : 'fa-clock');
                            const color = isAtiva ? '#28a745' : (jaPassouMasNaoEAtual ? '#667eea' : '#999');
                            
                            // ‚úÖ Valida√ß√µes para determinar se pode clicar
                            let podeClicar = temPermissao && !isAtiva;
                            let motivoBloqueio = '';
                            
                            if (podeClicar) {
                                // Valida√ß√£o: N√£o pode sair de contrata√ß√£o sem motorista
                                if (coleta.etapa_atual === 'contratacao' && !coleta.motorista_id) {
                                    podeClicar = false;
                                    motivoBloqueio = 'Vincule um motorista primeiro';
                                }
                                // Valida√ß√£o: N√£o pode sair de GR sem aprova√ß√£o
                                else if (coleta.etapa_atual === 'gr') {
                                    const etapaAtualIndex = ETAPAS.findIndex(e => e.id === coleta.etapa_atual);
                                    const novaEtapaIndex = ETAPAS.findIndex(e => e.id === etapa.id);
                                    
                                    if (novaEtapaIndex > etapaAtualIndex) {
                                        // Tentando avan√ßar de GR
                                        if (coleta.gr_aprovado === null || coleta.gr_aprovado === undefined) {
                                            podeClicar = false;
                                            motivoBloqueio = 'Aprove ou reprove o GR primeiro';
                                        } else if (coleta.gr_aprovado === false) {
                                            podeClicar = false;
                                            motivoBloqueio = 'GR reprovado - deve voltar para Contrata√ß√£o';
                                        }
                                    }
                                }
                            }
                            
                            return `
                                <span 
                                    class="drawer-etapa-item ${podeClicar ? 'drawer-etapa-clickable' : ''}"
                                    data-etapa-id="${etapa.id}"
                                    data-coleta-id="${coleta.id}"
                                    onclick="${podeClicar ? `moverParaEtapaDrawer('${coleta.id}', '${etapa.id}')` : ''}"
                                    style="
                                        display: flex; 
                                        align-items: center; 
                                        gap: 0.4rem; 
                                        font-size: 0.85rem; 
                                        color: ${podeClicar ? color : '#ccc'};
                                        font-weight: ${isAtiva ? '600' : 'normal'};
                                        ${podeClicar ? 'cursor: pointer; padding: 0.5rem 0.75rem; border-radius: 6px; transition: all 0.2s;' : 'cursor: not-allowed; padding: 0.5rem 0.75rem; border-radius: 6px; opacity: 0.6;'}
                                    "
                                    onmouseover="${podeClicar ? `this.style.background='rgba(102, 126, 234, 0.1)'; this.style.transform='translateY(-2px)';` : ''}"
                                    onmouseout="${podeClicar ? `this.style.background='transparent'; this.style.transform='translateY(0)';` : ''}"
                                    title="${isAtiva ? 'Etapa atual' : podeClicar ? `Clique para mover para ${etapa.nome}` : motivoBloqueio || 'Sem permiss√£o para mover'}">
                                    <i class="fas ${icon}"></i>
                                    ${etapa.nome}
                                    ${podeClicar ? '<i class="fas fa-hand-pointer" style="font-size: 0.7rem; margin-left: 0.25rem; opacity: 0.6;"></i>' : ''}
                                    ${!podeClicar && !isAtiva && motivoBloqueio ? '<i class="fas fa-lock" style="font-size: 0.7rem; margin-left: 0.25rem; opacity: 0.6;"></i>' : ''}
                                </span>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <!-- Valida√ß√µes de Etapa -->
                ${coleta.etapa_atual === 'contratacao' && !coleta.motorista_id ? `
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 152, 0, 0.1) 100%); border: 2px solid #ffc107; border-radius: 8px;">
                        <div style="color: #f57c00; font-weight: 600; margin-bottom: 0.5rem;">
                            <i class="fas fa-exclamation-triangle"></i> Valida√ß√£o Necess√°ria
                        </div>
                        <div style="color: #333; margin-bottom: 1rem; font-size: 0.9rem;">
                            Para avan√ßar da etapa Contrata√ß√£o, √© necess√°rio vincular um motorista √† coleta.
                        </div>
                        ${temPermissao ? `
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button onclick="vincularMotorista('${coleta.id}')" 
                                        style="background: #28a745; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem;">
                                    <i class="fas fa-user-plus"></i> Vincular Motorista
                                </button>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
                ${coleta.etapa_atual === 'contratacao' && coleta.motorista_id ? `
                    <div id="alerta-motorista-reprovado-${coleta.id}" style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, rgba(220, 53, 69, 0.1) 0%, rgba(200, 35, 51, 0.1) 100%); border: 2px solid #dc3545; border-radius: 8px; display: none;">
                        <div style="color: #dc3545; font-weight: 600; margin-bottom: 0.5rem;">
                            <i class="fas fa-exclamation-triangle"></i> Motorista Reprovado
                        </div>
                        <div style="color: #333; margin-bottom: 1rem; font-size: 0.9rem;">
                            O motorista vinculado est√° reprovado. √â <strong>obrigat√≥rio</strong> trocar o motorista ou solicitar uma nova an√°lise antes de avan√ßar para outra etapa.
                        </div>
                        <div id="motivo-reprovacao-${coleta.id}" style="color: #721c24; font-size: 0.85rem; margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(220, 53, 69, 0.1); border-left: 3px solid #dc3545; border-radius: 4px; display: none;">
                            <strong>Motivo:</strong> <span id="motivo-texto-${coleta.id}"></span>
                        </div>
                        ${temPermissao ? `
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button onclick="trocarMotorista('${coleta.id}')" 
                                        style="background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem;">
                                    <i class="fas fa-exchange-alt"></i> Trocar Motorista
                                </button>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
                ${coleta.etapa_atual === 'finalizar_operacao' ? `
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 152, 0, 0.1) 100%); border: 2px solid #ffc107; border-radius: 8px;">
                        <div style="color: #f57c00; font-weight: 600; margin-bottom: 0.5rem;">
                            <i class="fas fa-check-circle"></i> Canhoto Anexado - Aguardando Valida√ß√£o
                        </div>
                        <div style="color: #333; margin-bottom: 1rem; font-size: 0.9rem;">
                            O motorista anexou o canhoto da entrega. Verifique o documento nos anexos e finalize a opera√ß√£o quando estiver tudo correto.
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button onclick="trocarTabDrawer('anexos')" 
                                    style="background: #ffc107; color: #333; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem;">
                                <i class="fas fa-paperclip"></i> Ver Anexos
                            </button>
                        </div>
                    </div>
                ` : ''}
                ${coleta.etapa_atual === 'gr' && (coleta.gr_aprovado === null || coleta.gr_aprovado === undefined || coleta.gr_aprovado === false) ? `
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border: 2px solid #667eea; border-radius: 8px;">
                        <div style="color: #667eea; font-weight: 600; margin-bottom: 0.5rem;">
                            <i class="fas fa-clipboard-check"></i> Aprova√ß√£o GR Necess√°ria
                        </div>
                        <div style="color: #333; margin-bottom: 1rem; font-size: 0.9rem;">
                            Usu√°rio com fun√ß√£o GR deve aprovar ou reprovar esta coleta para continuar.
                        </div>
                        ${temPermissao ? `
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button onclick="aprovarGR('${coleta.id}')" 
                                        style="background: #28a745; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem;">
                                    <i class="fas fa-check"></i> Aprovar
                                </button>
                                <button onclick="reprovarGR('${coleta.id}')" 
                                        style="background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem;">
                                    <i class="fas fa-times"></i> Reprovar
                                </button>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
                ${coleta.etapa_atual === 'contas_pagar' && coleta.contas_pagar_tipo ? `
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, rgba(72, 12, 168, 0.1) 0%, rgba(102, 126, 234, 0.1) 100%); border: 2px solid #480ca8; border-radius: 8px;">
                        <div style="color: #480ca8; font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-money-bill-wave"></i> Tipo de Pagamento Solicitado
                        </div>
                        <div style="color: #333; font-size: 1rem; font-weight: 600; padding: 0.75rem; background: rgba(72, 12, 168, 0.05); border-radius: 6px; margin-top: 0.5rem;">
                            ${escapeHtml(coleta.contas_pagar_tipo)}
                        </div>
                        ${coleta.contas_pagar_pago ? `
                            <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(40, 167, 69, 0.1); border-radius: 6px; border: 1px solid #28a745;">
                                <div style="color: #28a745; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-check-circle"></i> Pagamento Realizado
                                </div>
                                ${coleta.contas_pagar_pago_por ? `
                                    <div style="color: #666; font-size: 0.85rem; margin-top: 0.25rem;">
                                        Pago por: ${escapeHtml(coleta.contas_pagar_pago_por)}
                                    </div>
                                ` : ''}
                                ${coleta.contas_pagar_data ? `
                                    <div style="color: #666; font-size: 0.85rem; margin-top: 0.25rem;">
                                        Data: ${formatarDataHora(coleta.contas_pagar_data)}
                                    </div>
                                ` : ''}
                            </div>
                        ` : `
                            <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(255, 193, 7, 0.1); border-radius: 6px; border: 1px solid #ffc107;">
                                <div style="color: #f57c00; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; margin-bottom: 0.75rem;">
                                    <i class="fas fa-clock"></i> Aguardando Pagamento
                                </div>
                                ${temPermissao ? `
                                    <button onclick="confirmarPagamento('${coleta.id}')" 
                                            style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; width: 100%; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); transition: all 0.3s;"
                                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(40, 167, 69, 0.4)';"
                                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(40, 167, 69, 0.3)';">
                                        <i class="fas fa-check-circle"></i> Confirmar Pagamento
                                    </button>
                                ` : ''}
                            </div>
                        `}
                    </div>
                ` : ''}
                
                <!-- Etiquetas -->
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <strong><i class="fas fa-tags"></i> Etiquetas:</strong>
                        ${temPermissao ? `
                            <button onclick="abrirModalEtiquetas('${coleta.id}')" 
                                    style="background: transparent; color: #667eea; border: 1px solid #667eea; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;">
                                <i class="fas fa-edit"></i> Gerenciar
                            </button>
                        ` : ''}
                    </div>
                    ${coleta.etiquetas && coleta.etiquetas.length > 0 ? `
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${coleta.etiquetas.map(et => `
                                <span style="background: ${et.cor || '#667eea'}; color: white; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.85rem;">
                                    <i class="fas fa-tag"></i> ${et.nome}
                                </span>
                            `).join('')}
                        </div>
                    ` : `
                        <div style="color: #999; font-size: 0.85rem; font-style: italic;">Nenhuma etiqueta adicionada</div>
                    `}
                </div>
                
                <!-- Datas -->
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(0,0,0,0.02); border-radius: 8px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; font-size: 0.85rem;">
                    ${coleta.created_at ? `
                        <div>
                            <strong style="color: #666;"><i class="fas fa-calendar-plus"></i> Criado em:</strong>
                            <div style="color: #999; margin-top: 0.25rem;">${formatarDataHora(coleta.created_at)}</div>
                        </div>
                    ` : ''}
                    ${coleta.updated_at ? `
                        <div>
                            <strong style="color: #666;"><i class="fas fa-calendar-edit"></i> Atualizado em:</strong>
                            <div style="color: #999; margin-top: 0.25rem;">${formatarDataHora(coleta.updated_at)}</div>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Observa√ß√µes -->
                ${coleta.observacoes ? `
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(102, 126, 234, 0.05); border-radius: 8px;">
                        <strong><i class="fas fa-sticky-note"></i> Observa√ß√µes:</strong>
                        <div style="margin-top: 0.5rem; color: #666; white-space: pre-wrap;">${escapeHtml(coleta.observacoes)}</div>
                    </div>
                ` : ''}
                
                <!-- Bot√µes de A√ß√£o -->
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid #e5e7eb;">
                    ${temPermissao ? `
                        <button onclick="avancarEtapa('${coleta.id}')" 
                                style="background: #28a745; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-arrow-right"></i> Avan√ßar Etapa
                        </button>
                        ${(() => {
                            const etapaAtualIndex = ETAPAS.findIndex(e => e.id === coleta.etapa_atual);
                            const etapaAnterior = etapaAtualIndex > 0 ? ETAPAS[etapaAtualIndex - 1] : null;
                            return etapaAnterior ? `
                                <button onclick="voltarEtapa('${coleta.id}', '${etapaAnterior.id}')" 
                                        style="background: #ffc107; color: #333; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-arrow-left"></i> Voltar para ${etapaAnterior.nome}
                                </button>
                            ` : '';
                        })()}
                        <button onclick="openEditColetaModal('${coleta.id}')" 
                                style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        ${currentUser && (currentUser.isAdmin || currentUser.role === 'admin') ? `
                        <button onclick="if(confirm('Tem certeza que deseja excluir esta coleta?')) { excluirColeta('${coleta.id}'); fecharKanbanDrawer(); }" 
                                style="background: #dc3545; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                        ` : ''}
                    ` : ''}
                    <button onclick="openChatModal('${coleta.id}')" 
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-comment"></i> Chat
                    </button>
                </div>
            `;
        }

        function renderTabAnexos(anexos, coletaId, temPermissao) {
            // Agrupar anexos por categoria
            const anexosPorCategoria = {};
            const anexosSemCategoria = [];
            
            if (anexos && anexos.length > 0) {
                anexos.forEach(anexo => {
                    const categoria = anexo.categoria || anexo.area || 'outros';
                    if (!anexosPorCategoria[categoria]) {
                        anexosPorCategoria[categoria] = [];
                    }
                    anexosPorCategoria[categoria].push(anexo);
                });
            }
            
            const categoriasOrdenadas = [
                'documentos_motorista',
                'documentos_proprietario',
                'documentos_veiculo',
                'evidencias',
                'faturamento',
                'notas_fiscais',
                'contratos',
                'outros'
            ];
            
            return `
                ${temPermissao ? `
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(102, 126, 234, 0.05); border-radius: 8px; border: 2px dashed #667eea;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <i class="fas fa-upload" style="color: #667eea; font-size: 1.2rem;"></i>
                            <strong style="color: #667eea;">Adicionar Anexo</strong>
                        </div>
                        <input type="file" 
                               id="drawer-upload-anexo-${coletaId}" 
                               multiple 
                               style="display: none;">
                        <button onclick="const input = document.getElementById('drawer-upload-anexo-${coletaId}'); if(input) { input.click(); }" 
                                style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-plus"></i> Selecionar Arquivo(s)
                        </button>
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">
                            Voc√™ pode selecionar m√∫ltiplos arquivos. A categoria ser√° solicitada antes do envio.
                        </div>
                    </div>
                ` : ''}
                
                ${!anexos || anexos.length === 0 ? `
                    <div style="text-align: center; padding: 3rem; color: #999;">
                        <i class="fas fa-paperclip fa-3x" style="margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>Nenhum anexo encontrado</p>
                    </div>
                ` : `
                    <div style="display: flex; flex-direction: column; gap: 2rem;">
                        ${categoriasOrdenadas.map(categoria => {
                            const anexosCategoria = anexosPorCategoria[categoria] || [];
                            if (anexosCategoria.length === 0) return '';
                            
                            const corCategoria = obterCorCategoria(categoria);
                            const iconeCategoria = obterIconeCategoria(categoria);
                            const nomeCategoria = obterNomeCategoria(categoria);
                            
                            return `
                                <div style="border: 2px solid ${corCategoria}20; border-radius: 12px; padding: 1.5rem; background: ${corCategoria}08;">
                                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid ${corCategoria}30;">
                                        <i class="fas ${iconeCategoria}" style="color: ${corCategoria}; font-size: 1.5rem;"></i>
                                        <h3 style="margin: 0; color: ${corCategoria}; font-size: 1.1rem; font-weight: 700;">
                                            ${nomeCategoria}
                                        </h3>
                                        <span style="background: ${corCategoria}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
                                            ${anexosCategoria.length} arquivo(s)
                                        </span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                                        ${anexosCategoria.map(anexo => `
                                            <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; text-align: center; transition: all 0.2s; background: white; border-left: 3px solid ${corCategoria};">
                                                <i class="fas fa-file fa-2x" style="color: ${corCategoria}; margin-bottom: 0.5rem;"></i>
                                                <div style="font-weight: 600; margin-bottom: 0.5rem; word-break: break-word; font-size: 0.9rem;">${escapeHtml(anexo.nome_arquivo || anexo.nome || 'Anexo')}</div>
                                                ${anexo.created_at ? `
                                                    <div style="font-size: 0.75rem; color: #999; margin-bottom: 0.5rem;">
                                                        ${formatarDataHora(anexo.created_at)}
                                                    </div>
                                                ` : ''}
                                                <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                                                    <button onclick="visualizarAnexo('${anexo.id}')" 
                                                            style="background: ${corCategoria}; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;">
                                                        <i class="fas fa-eye"></i> Ver
                                                    </button>
                                                    <button onclick="downloadAnexoDireto('${anexo.id}')" 
                                                            style="background: transparent; color: ${corCategoria}; border: 1px solid ${corCategoria}; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;">
                                                        <i class="fas fa-download"></i> Baixar
                                                    </button>
                                                    ${currentUser && (currentUser.isAdmin || currentUser.role === 'admin') ? `
                                                    <button onclick="excluirAnexo('${anexo.id}')" 
                                                            style="background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;">
                                                        <i class="fas fa-trash"></i> Excluir
                                                    </button>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }).filter(html => html !== '').join('')}
                    </div>
                `}
            `;
        }
        
        async function handleDrawerUploadAnexo(coletaId, files) {
            console.log('üìé handleDrawerUploadAnexo chamado:', { 
                coletaId, 
                filesCount: files?.length || 0,
                filesType: Array.isArray(files) ? 'Array' : (files instanceof FileList ? 'FileList' : typeof files)
            });
            
            if (!files || files.length === 0) {
                console.warn('‚ö†Ô∏è Nenhum arquivo selecionado');
                showNotification('Nenhum arquivo selecionado', 'warning');
                return;
            }
            
            // Converter FileList para Array se necess√°rio (pode j√° ser Array)
            const filesArray = Array.isArray(files) ? files : Array.from(files);
            console.log('üìé Arquivos para upload:', filesArray.map(f => f.name));
            
            if (filesArray.length === 0) {
                console.error('‚ùå Nenhum arquivo v√°lido ap√≥s convers√£o');
                showNotification('Erro: Nenhum arquivo v√°lido selecionado', 'error');
                return;
            }
            
            // Criar modal para sele√ß√£o de categoria
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.id = 'modalCategoriaAnexo';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; z-index: 10001; padding: 2rem;';
            modal.innerHTML = `
                <div class="modal-dialog" style="background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); max-width: 500px; width: 100%;">
                    <div class="modal-content" style="padding: 0;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px 20px 0 0; padding: 1.5rem 2rem;">
                            <h5 class="modal-title" style="margin: 0; font-size: 1.3rem; font-weight: 600;">
                                <i class="fas fa-folder"></i> Selecionar Categoria
                            </h5>
                            <button type="button" class="btn-close" style="filter: invert(1); opacity: 0.9; font-size: 1.5rem; background: none; border: none; color: white; cursor: pointer;" onclick="this.closest('.modal').remove();"></button>
                        </div>
                        <div class="modal-body" style="padding: 2rem;">
                            <p style="margin-bottom: 1.5rem; color: #333;">
                                Selecione a categoria para os <strong>${files.length}</strong> arquivo(s) selecionado(s):
                            </p>
                            <select id="drawerCategoriaSelect" style="width: 100%; padding: 0.8rem; border: 2px solid #e9ecef; border-radius: 10px; font-size: 1rem; background: white;">
                                <option value="">Selecione a categoria</option>
                                <option value="documentos_motorista">üìÑ Documentos do Motorista</option>
                                <option value="documentos_proprietario">üìã Documentos do Propriet√°rio</option>
                                <option value="documentos_veiculo">üöõ Documentos do Ve√≠culo</option>
                                <option value="evidencias">üì∏ Evid√™ncias</option>
                                <option value="faturamento">üí∞ Faturamento</option>
                                <option value="notas_fiscais">üßæ Notas Fiscais</option>
                                <option value="contratos">üìù Contratos</option>
                                <option value="outros">üìÅ Outros</option>
                            </select>
                        </div>
                        <div class="modal-footer" style="padding: 1.5rem 2rem; border-top: 1px solid #e9ecef; display: flex; justify-content: flex-end; gap: 1rem; border-radius: 0 0 20px 20px;">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove();" style="padding: 0.75rem 2rem; border-radius: 10px; border: none; font-weight: 600; background: #6c757d; color: white; cursor: pointer;">Cancelar</button>
                            <button type="button" class="btn btn-primary" id="btnConfirmarCategoria" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 0.75rem 2rem; border-radius: 10px; font-weight: 600; color: white; cursor: pointer;">
                                <i class="fas fa-check"></i> Confirmar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Fechar modal ao clicar no backdrop
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            // Event listener para mudan√ßa de categoria (mostrar campo de t√≠tulo se for contratos)
            const categoriaSelect = modal.querySelector('#drawerCategoriaSelect');
            categoriaSelect.addEventListener('change', function() {
                const categoria = this.value;
                const tituloContainer = document.getElementById('tituloContratoContainer');
                
                if (categoria === 'contratos') {
                    if (!tituloContainer) {
                        const tituloDiv = document.createElement('div');
                        tituloDiv.id = 'tituloContratoContainer';
                        tituloDiv.style.marginTop = '1.5rem';
                        tituloDiv.innerHTML = `
                            <label for="tituloContratoInput" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">
                                <i class="fas fa-file-contract"></i> T√≠tulo do Contrato:
                            </label>
                            <input type="text" 
                                   id="tituloContratoInput" 
                                   placeholder="Ex: Contrato de Presta√ß√£o de Servi√ßos - Cliente XYZ"
                                   style="width: 100%; padding: 0.8rem; border: 2px solid #e9ecef; border-radius: 10px; font-size: 1rem; background: white;">
                            <small style="color: #6c757d; font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                                O t√≠tulo ser√° exibido no card principal da coleta
                            </small>
                        `;
                        categoriaSelect.closest('.modal-body').appendChild(tituloDiv);
                    } else {
                        tituloContainer.style.display = 'block';
                    }
                } else {
                    if (tituloContainer) {
                        tituloContainer.style.display = 'none';
                    }
                }
            });
            
            // Event listener para o bot√£o confirmar
            const confirmBtn = modal.querySelector('#btnConfirmarCategoria');
            confirmBtn.onclick = () => {
                const categoria = document.getElementById('drawerCategoriaSelect').value;
                if (!categoria) {
                    showNotification('Por favor, selecione uma categoria', 'warning');
                    return;
                }
                
                // Validar t√≠tulo se for contrato
                let tituloContrato = null;
                if (categoria === 'contratos') {
                    const tituloInput = document.getElementById('tituloContratoInput');
                    if (tituloInput) {
                        tituloContrato = tituloInput.value.trim();
                        if (!tituloContrato) {
                            showNotification('‚ö†Ô∏è Por favor, informe o t√≠tulo do contrato', 'warning');
                            return;
                        }
                    }
                }
                
                modal.remove();
                // Converter FileList para Array se necess√°rio
                const filesArray = Array.from(files);
                processarUploadComCategoria(coletaId, filesArray, categoria, tituloContrato);
            };
        }
        
        async function processarUploadComCategoria(coletaId, files, categoria, tituloContrato = null) {
            const drawerContent = document.getElementById('kanbanDrawerContent');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'drawer-upload-loading';
            loadingDiv.innerHTML = `
                <div style="text-align: center; padding: 1rem; background: rgba(102, 126, 234, 0.1); border-radius: 8px; margin-bottom: 1rem;">
                    <i class="fas fa-spinner fa-spin"></i> Enviando ${files.length} arquivo(s) para ${obterNomeCategoria(categoria)}...
                </div>
            `;
            const anexosTab = document.getElementById('tab-anexos');
            if (anexosTab) {
                anexosTab.insertBefore(loadingDiv, anexosTab.firstChild);
            }
            
            try {
                for (const file of files) {
                    await uploadAnexo(coletaId, file, categoria, tituloContrato);
                }
                
                showNotification(`${files.length} arquivo(s) enviado(s) com sucesso na categoria ${obterNomeCategoria(categoria)}!`, 'success');
                
                // Recarregar anexos
                invalidarCacheAnexos(coletaId);
                const novosAnexos = await carregarAnexos(coletaId);
                
                // Atualizar tab de anexos
                const anexosTabContent = document.getElementById('tab-anexos');
                if (anexosTabContent) {
                    const temPermissao = temPermissaoEtapa(coletasData.find(c => c.id === coletaId)?.etapa_atual);
                    anexosTabContent.innerHTML = renderTabAnexos(novosAnexos, coletaId, temPermissao);
                    
                    // Reconfigurar event listener do input file ap√≥s renderizar
                    const fileInput = document.getElementById(`drawer-upload-anexo-${coletaId}`);
                    if (fileInput) {
                        // Remover listeners antigos
                        const newInput = fileInput.cloneNode(true);
                        fileInput.parentNode.replaceChild(newInput, fileInput);
                        
                        // Adicionar novo listener
                        newInput.addEventListener('change', function(e) {
                            if (e.target.files && e.target.files.length > 0) {
                                handleDrawerUploadAnexo(coletaId, e.target.files);
                                e.target.value = ''; // Resetar input
                            }
                        });
                    }
                }
                
                // Atualizar contador na tab
                const anexosTabBtn = document.querySelector('.kanban-drawer-tab[onclick*="anexos"]');
                if (anexosTabBtn) {
                    anexosTabBtn.innerHTML = `<i class="fas fa-paperclip"></i> Anexos (${novosAnexos.length})`;
                }
            } catch (error) {
                console.error('Erro ao enviar anexos:', error);
                showNotification('Erro ao enviar arquivo(s): ' + error.message, 'error');
            } finally {
                const loading = document.getElementById('drawer-upload-loading');
                if (loading) loading.remove();
            }
        }

        function renderTabMotorista(motorista, coleta, temPermissao) {
            if (!motorista) {
                return `
                    <div style="text-align: center; padding: 3rem;">
                        <div style="background: linear-gradient(135deg, rgba(156, 163, 175, 0.1) 0%, rgba(107, 114, 128, 0.1) 100%); border-radius: 50%; width: 100px; height: 100px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                            <i class="fas fa-user-slash fa-3x" style="color: #9ca3af;"></i>
                        </div>
                        <h3 style="color: #6b7280; margin-bottom: 0.5rem; font-size: 1.25rem;">Nenhum motorista vinculado</h3>
                        <p style="color: #9ca3af; margin-bottom: 1.5rem; font-size: 0.9rem;">Vincule um motorista para continuar com a coleta</p>
                        ${temPermissao ? `
                            <button onclick="vincularMotorista('${coleta.id}')" 
                                    style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 0.75rem 2rem; border-radius: 10px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); transition: all 0.3s;"
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(40, 167, 69, 0.4)';"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(40, 167, 69, 0.3)';">
                                <i class="fas fa-plus"></i> Vincular Motorista
                            </button>
                        ` : ''}
                    </div>
                `;
            }
            
            // ‚úÖ IMPORTANTE: Verificar status do motorista ESPEC√çFICO PARA ESTA COLETA
            // O motorista s√≥ pode estar aprovado ou reprovado DEPOIS de passar pela etapa GR
            // Antes disso, o status √© NEUTRO (pendente de an√°lise GR)
            
            const quantidadeReprovacoes = parseInt(motorista.quantidade_reprovacoes) || 0;
            const historicoReprovacoes = motorista.historico_reprovacoes || [];
            
            // Verificar status completo do motorista para esta coleta
            const statusInfo = verificarStatusMotoristaPorColeta(motorista, coleta);
            const statusMotorista = statusInfo.status; // 'neutro', 'aprovado', 'reprovado'
            
            // Extrair informa√ß√µes
            const isReprovado = statusMotorista === 'reprovado';
            const isAprovado = statusMotorista === 'aprovado';
            const isNeutro = statusMotorista === 'neutro';
            const motivoReprovacaoEstaColeta = statusInfo.motivo;
            const reprovadoPorEstaColeta = statusInfo.reprovado_por;
            const dataReprovacaoEstaColeta = statusInfo.data_reprovacao;
            const aprovadoPorEstaColeta = statusInfo.aprovado_por;
            const dataAprovacaoEstaColeta = statusInfo.data_aprovacao;
            
            // Log para debug - SEMPRE exibir para identificar o problema
            console.log('üîç Verificando status do motorista (POR COLETA):', {
                coleta_id: coleta.id,
                etapa_atual: coleta.etapa_atual,
                gr_aprovado: coleta.gr_aprovado,
                motorista_id: motorista.id,
                nome: motorista.nome,
                status: statusMotorista,
                motivo_reprovacao: motivoReprovacaoEstaColeta,
                quantidade_reprovacoes_total: quantidadeReprovacoes,
                historico_length: Array.isArray(historicoReprovacoes) ? historicoReprovacoes.length : 'N/A'
            });
            
            // Determinar cores baseado no status
            let bgColor, borderColor, iconColor, iconClass;
            
            if (statusMotorista === 'reprovado') {
                bgColor = 'linear-gradient(135deg, rgba(220, 53, 69, 0.2) 0%, rgba(200, 35, 51, 0.25) 100%)';
                borderColor = '#dc3545';
                iconColor = '#dc3545';
                iconClass = 'fa-user-times';
            } else if (statusMotorista === 'aprovado') {
                bgColor = 'linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(32, 201, 151, 0.1) 100%)';
                borderColor = '#28a745';
                iconColor = '#28a745';
                iconClass = 'fa-user-check';
            } else {
                // Status neutro (pendente de an√°lise GR)
                bgColor = 'linear-gradient(135deg, rgba(108, 117, 125, 0.1) 0%, rgba(134, 142, 150, 0.1) 100%)';
                borderColor = '#6c757d';
                iconColor = '#6c757d';
                iconClass = 'fa-user-clock';
            }
            
            return `
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <!-- Card Principal do Motorista -->
                    <div style="padding: 1.5rem; background: ${bgColor}; border-radius: 12px; border: 2px solid ${borderColor}; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);">
                        <!-- Header com Nome e Status -->
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
                            <div style="flex: 1;">
                                <h3 style="color: ${iconColor}; margin: 0 0 0.5rem 0; font-size: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas ${iconClass}"></i> ${escapeHtml(motorista.nome || 'N/A')}
                                </h3>
                                ${statusMotorista === 'reprovado' ? `
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                                        <span style="background: #dc3545; color: white; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4); animation: piscarBadgeUrgente 1.5s ease-in-out infinite;">
                                            <i class="fas fa-times-circle"></i> ${coleta.etapa_atual === 'contratacao' ? 'REPROVADO NO GR' : 'MOTORISTA REPROVADO'}
                                        </span>
                                        ${quantidadeReprovacoes > 0 ? `
                                            <span style="background: rgba(220, 53, 69, 0.2); color: #dc3545; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; border: 1px solid rgba(220, 53, 69, 0.3);">
                                                ${quantidadeReprovacoes} reprova√ß√£o(√µes)
                                            </span>
                                        ` : ''}
                                    </div>
                                ` : statusMotorista === 'aprovado' ? `
                                    <span style="background: #28a745; color: white; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; margin-top: 0.5rem;">
                                        <i class="fas fa-check-circle"></i> APROVADO NO GR
                                    </span>
                                ` : `
                                    <span style="background: #6c757d; color: white; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; margin-top: 0.5rem;">
                                        <i class="fas fa-clock"></i> PENDENTE DE AN√ÅLISE GR
                                    </span>
                                `}
                            </div>
                        </div>
                        
                        ${isReprovado && motivoReprovacaoEstaColeta ? `
                            <div style="background: rgba(220, 53, 69, 0.15); border-left: 4px solid #dc3545; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
                                <div style="color: #dc3545; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                    <i class="fas fa-info-circle"></i> Motivo da Reprova√ß√£o (Esta Coleta)
                                </div>
                                <div style="color: #721c24; font-size: 0.9rem; line-height: 1.5;">
                                    ${escapeHtml(motivoReprovacaoEstaColeta)}
                                </div>
                                ${reprovadoPorEstaColeta && dataReprovacaoEstaColeta ? `
                                    <div style="color: #6c757d; font-size: 0.8rem; margin-top: 0.5rem; font-style: italic;">
                                        Por ${escapeHtml(reprovadoPorEstaColeta)} em ${new Date(dataReprovacaoEstaColeta).toLocaleDateString('pt-BR')} √†s ${new Date(dataReprovacaoEstaColeta).toLocaleTimeString('pt-BR')}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        ${isAprovado && aprovadoPorEstaColeta && dataAprovacaoEstaColeta ? `
                            <div style="background: rgba(40, 167, 69, 0.1); border-left: 4px solid #28a745; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
                                <div style="color: #28a745; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                    <i class="fas fa-check-circle"></i> Aprovado no GR
                                </div>
                                <div style="color: #155724; font-size: 0.85rem; line-height: 1.5;">
                                    Motorista aprovado por ${escapeHtml(aprovadoPorEstaColeta)} em ${new Date(dataAprovacaoEstaColeta).toLocaleDateString('pt-BR')} √†s ${new Date(dataAprovacaoEstaColeta).toLocaleTimeString('pt-BR')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${isNeutro ? `
                            <div style="background: rgba(108, 117, 125, 0.1); border-left: 4px solid #6c757d; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
                                <div style="color: #6c757d; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                    <i class="fas fa-clock"></i> Pendente de An√°lise GR
                                </div>
                                <div style="color: #495057; font-size: 0.85rem; line-height: 1.5;">
                                    Este motorista ainda n√£o passou pela etapa GR. O status ser√° definido ap√≥s a an√°lise do GR.
                                </div>
                            </div>
                        ` : ''}
                        
                        ${quantidadeReprovacoes > 0 && !isReprovado ? `
                            <div style="background: rgba(255, 193, 7, 0.1); border-left: 4px solid #ffc107; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
                                <div style="color: #856404; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                    <i class="fas fa-info-circle"></i> Hist√≥rico de Reprova√ß√µes
                                </div>
                                <div style="color: #856404; font-size: 0.85rem; line-height: 1.5;">
                                    Este motorista possui <strong>${quantidadeReprovacoes}</strong> reprova√ß√£o(√µes) em outras coletas, mas est√° <strong>${isAprovado ? 'aprovado' : 'pendente de an√°lise'}</strong> para esta coleta.
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Informa√ß√µes do Motorista em Grid -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            ${motorista.cnh ? `
                                <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.1);">
                                    <div style="color: #6b7280; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.5px;">
                                        <i class="fas fa-id-card" style="color: #667eea;"></i> CNH
                                    </div>
                                    <div style="color: #1f2937; font-size: 1.1rem; font-weight: 600;">${escapeHtml(motorista.cnh)}</div>
                                    ${motorista.categoria_cnh ? `
                                        <div style="color: #6b7280; font-size: 0.85rem; margin-top: 0.25rem;">Categoria: ${escapeHtml(motorista.categoria_cnh)}</div>
                                    ` : ''}
                                </div>
                            ` : ''}
                            
                            ${motorista.telefone1 ? `
                                <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.1);">
                                    <div style="color: #6b7280; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.5px;">
                                        <i class="fas fa-phone" style="color: #10b981;"></i> Telefone 1
                                    </div>
                                    <div style="color: #1f2937; font-size: 1.1rem; font-weight: 600;">
                                        <a href="tel:${motorista.telefone1}" style="color: #1f2937; text-decoration: none;">${escapeHtml(motorista.telefone1)}</a>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${motorista.telefone2 ? `
                                <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.1);">
                                    <div style="color: #6b7280; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.5px;">
                                        <i class="fas fa-phone" style="color: #10b981;"></i> Telefone 2
                                    </div>
                                    <div style="color: #1f2937; font-size: 1.1rem; font-weight: 600;">
                                        <a href="tel:${motorista.telefone2}" style="color: #1f2937; text-decoration: none;">${escapeHtml(motorista.telefone2)}</a>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${motorista.estado ? `
                                <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.1);">
                                    <div style="color: #6b7280; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.5px;">
                                        <i class="fas fa-map-marker-alt" style="color: #f59e0b;"></i> Estado
                                    </div>
                                    <div style="color: #1f2937; font-size: 1.1rem; font-weight: 600;">${escapeHtml(motorista.estado)}</div>
                                </div>
                            ` : ''}
                            
                            ${motorista.classe_veiculo ? `
                                <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.1);">
                                    <div style="color: #6b7280; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.5px;">
                                        <i class="fas fa-truck" style="color: #8b5cf6;"></i> Classe Ve√≠culo
                                    </div>
                                    <div style="color: #1f2937; font-size: 1.1rem; font-weight: 600;">${escapeHtml(motorista.classe_veiculo)}</div>
                                </div>
                            ` : ''}
                            
                            ${motorista.placa_cavalo ? `
                                <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.1);">
                                    <div style="color: #6b7280; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.5px;">
                                        <i class="fas fa-car" style="color: #ec4899;"></i> Placa Cavalo
                                    </div>
                                    <div style="color: #1f2937; font-size: 1.1rem; font-weight: 600;">${escapeHtml(motorista.placa_cavalo)}</div>
                                </div>
                            ` : ''}
                            
                            ${motorista.tipo_veiculo ? `
                                <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.1);">
                                    <div style="color: #6b7280; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.5px;">
                                        <i class="fas fa-truck-pickup" style="color: #06b6d4;"></i> Tipo Ve√≠culo
                                    </div>
                                    <div style="color: #1f2937; font-size: 1.1rem; font-weight: 600;">${escapeHtml(motorista.tipo_veiculo)}</div>
                                </div>
                            ` : ''}
                            
                            ${motorista.tipo_carroceria ? `
                                <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.1);">
                                    <div style="color: #6b7280; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.5px;">
                                        <i class="fas fa-box" style="color: #f97316;"></i> Tipo Carroceria
                                    </div>
                                    <div style="color: #1f2937; font-size: 1.1rem; font-weight: 600;">${escapeHtml(motorista.tipo_carroceria)}</div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Hist√≥rico de Reprova√ß√µes -->
                        ${historicoReprovacoes && historicoReprovacoes.length > 0 ? `
                            <div style="background: rgba(220, 53, 69, 0.05); border: 1px solid rgba(220, 53, 69, 0.2); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                                <div style="color: #dc3545; font-weight: 600; margin-bottom: 1rem; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-history"></i> Hist√≥rico de Reprova√ß√µes (${historicoReprovacoes.length})
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 200px; overflow-y: auto;">
                                    ${historicoReprovacoes.map((reprovacao, index) => `
                                        <div style="background: white; padding: 0.75rem; border-radius: 6px; border-left: 3px solid #dc3545;">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.25rem;">
                                                <div style="color: #dc3545; font-weight: 600; font-size: 0.85rem;">
                                                    Reprova√ß√£o #${index + 1}
                                                </div>
                                                ${reprovacao.data_reprovacao ? `
                                                    <div style="color: #6b7280; font-size: 0.75rem;">
                                                        ${new Date(reprovacao.data_reprovacao).toLocaleDateString('pt-BR')}
                                                    </div>
                                                ` : ''}
                                            </div>
                                            ${reprovacao.motivo ? `
                                                <div style="color: #374151; font-size: 0.85rem; margin-bottom: 0.25rem;">
                                                    ${escapeHtml(reprovacao.motivo)}
                                                </div>
                                            ` : ''}
                                            ${reprovacao.reprovado_por ? `
                                                <div style="color: #6b7280; font-size: 0.75rem; font-style: italic;">
                                                    Por: ${escapeHtml(reprovacao.reprovado_por)}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Bot√µes de A√ß√£o -->
                        ${temPermissao ? `
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap; padding-top: 1.5rem; border-top: 2px solid ${borderColor};">
                                <button onclick="trocarMotorista('${coleta.id}')" 
                                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); transition: all 0.3s; flex: 1; min-width: 150px;"
                                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(102, 126, 234, 0.4)';"
                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)';">
                                    <i class="fas fa-exchange-alt"></i> Trocar Motorista
                                </button>
                                <button onclick="verDetalhesMotorista('${coleta.id}')" 
                                        style="background: white; color: #667eea; border: 2px solid #667eea; padding: 0.75rem 1.5rem; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; flex: 1; min-width: 150px;"
                                        onmouseover="this.style.background='#667eea'; this.style.color='white';"
                                        onmouseout="this.style.background='white'; this.style.color='#667eea';">
                                    <i class="fas fa-info-circle"></i> Ver Detalhes
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderTabITs(its) {
            if (!its || its.length === 0) {
                return `
                    <div style="text-align: center; padding: 3rem; color: #999;">
                        <i class="fas fa-file-alt fa-3x" style="margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>Nenhuma IT relacionada encontrada</p>
                    </div>
                `;
            }
            
            return `
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    ${its.map(it => `
                        <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; border-left: 4px solid #667eea;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div>
                                    ${it.codigo_it ? `<span style="background: #667eea; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-right: 0.5rem;">${it.codigo_it}</span>` : ''}
                                    <strong>${escapeHtml(it.nome)}</strong>
                                </div>
                            </div>
                            ${it.area ? `<div style="color: #666; font-size: 0.85rem; margin-bottom: 0.5rem;"><i class="fas fa-building"></i> ${escapeHtml(it.area)}</div>` : ''}
                            <div style="display: flex; gap: 0.5rem;">
                                <a href="${it.url}" target="_blank" 
                                   style="background: #667eea; color: white; padding: 0.5rem 1rem; border-radius: 6px; text-decoration: none; font-size: 0.85rem;">
                                    <i class="fas fa-eye"></i> Visualizar
                                </a>
                                <a href="${it.url}" download="${it.nome_arquivo || 'it.pdf'}"
                                   style="background: transparent; color: #667eea; border: 1px solid #667eea; padding: 0.5rem 1rem; border-radius: 6px; text-decoration: none; font-size: 0.85rem;">
                                    <i class="fas fa-download"></i> Baixar
                                </a>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderTabHistorico(historico) {
            if (!historico || historico.length === 0) {
                return `
                    <div style="text-align: center; padding: 3rem; color: #999;">
                        <i class="fas fa-history fa-3x" style="margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>Nenhuma movimenta√ß√£o registrada</p>
                    </div>
                `;
            }
            
            return `
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    ${historico.map(item => `
                        <div style="border-left: 3px solid #667eea; padding-left: 1rem; padding: 1rem; background: rgba(102, 126, 234, 0.05); border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div style="font-weight: 600; color: #667eea;">${getTextoAcao(item.acao)}</div>
                                <div style="color: #999; font-size: 0.85rem;">${formatarDataHora(item.created_at)}</div>
                            </div>
                            <div style="color: #666; font-size: 0.9rem;">${escapeHtml(item.detalhes || 'Sem detalhes')}</div>
                            ${item.usuario || item.usuario_nome ? `
                                <div style="color: #999; font-size: 0.8rem; margin-top: 0.5rem;">
                                    <i class="fas fa-user"></i> ${item.usuario || item.usuario_nome || 'Sistema'}
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderTabChat(coletaId) {
            return `
                <div id="kanban-chat-container-${coletaId}" style="min-height: 400px;">
                    <div style="text-align: center; padding: 2rem; color: #999;">
                        <i class="fas fa-comment fa-2x" style="margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>Chat ser√° carregado aqui</p>
                        <button onclick="openChatModal('${coletaId}')" 
                                style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 1rem;">
                            <i class="fas fa-external-link-alt"></i> Abrir Chat Completo
                        </button>
                    </div>
                </div>
            `;
        }

        async function carregarITsRelacionadasParaDrawer(nomeCliente, filial) {
            try {
                const response = await fetch(`/api/clientes/nome/${encodeURIComponent(nomeCliente)}/its${filial ? `?filial=${encodeURIComponent(filial)}` : ''}`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    return result.success && result.its ? result.its : [];
                }
                return [];
            } catch (e) {
                console.error('Erro ao carregar ITs:', e);
                return [];
            }
        }

        // ========== MOVER PARA ETAPA NO DRAWER ==========
        async function moverParaEtapaDrawer(coletaId, novaEtapaId) {
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta) {
                showNotification('Coleta n√£o encontrada', 'error');
                return;
            }

            // Verificar se √© a mesma etapa
            if (coleta.etapa_atual === novaEtapaId) {
                showNotification('Esta j√° √© a etapa atual', 'info');
                return;
            }

            // ‚úÖ VALIDA√á√ÉO: N√£o pode sair de contrata√ß√£o sem motorista
            if (coleta.etapa_atual === 'contratacao' && !coleta.motorista_id) {
                showNotification('‚ö†Ô∏è Para mover uma coleta da etapa Contrata√ß√£o, √© necess√°rio vincular um motorista √† coleta.', 'warning');
                return;
            }

            // ‚úÖ VALIDA√á√ÉO: N√£o pode sair de contrata√ß√£o se o motorista estiver reprovado
            if (coleta.etapa_atual === 'contratacao' && coleta.motorista_id) {
                try {
                    const motorista = await buscarMotoristaPorId(coleta.motorista_id);
                    const reprovacaoInfo = verificarReprovacaoPorColeta(motorista, coleta.id);
                    if (reprovacaoInfo.reprovado) {
                        showNotification('‚ö†Ô∏è O motorista vinculado est√° reprovado para esta coleta. √â obrigat√≥rio trocar o motorista ou solicitar uma nova an√°lise antes de avan√ßar.', 'warning');
                        return;
                    }
                } catch (err) {
                    console.warn('‚ö†Ô∏è Erro ao verificar status do motorista:', err);
                    // Continuar mesmo se houver erro na verifica√ß√£o
                }
            }

            // ‚úÖ VALIDA√á√ÉO: N√£o pode sair de GR sem aprova√ß√£o ou reprova√ß√£o
            if (coleta.etapa_atual === 'gr') {
                // Verificar se GR foi aprovado ou reprovado
                if (coleta.gr_aprovado === null || coleta.gr_aprovado === undefined) {
                    showNotification('‚ö†Ô∏è Para mover uma coleta da etapa GR, √© necess√°rio aprovar ou reprovar a coleta primeiro.\n\nUse os bot√µes "Aprovar GR" ou "Reprovar GR" no card da coleta.', 'warning');
                    return;
                }
                
                const etapaAtualIndex = ETAPAS.findIndex(e => e.id === coleta.etapa_atual);
                const novaEtapaIndex = ETAPAS.findIndex(e => e.id === novaEtapaId);
                
                // Se foi reprovado, n√£o pode avan√ßar (deve estar em contrata√ß√£o)
                if (coleta.gr_aprovado === false) {
                    if (novaEtapaIndex > etapaAtualIndex) {
                        showNotification('‚ö†Ô∏è Esta coleta foi reprovada pelo GR e n√£o pode avan√ßar. Ela deve voltar para a etapa de Contrata√ß√£o.', 'warning');
                        return;
                    }
                }
                
                // Se foi aprovado, s√≥ pode avan√ßar para documenta√ß√£o
                if (coleta.gr_aprovado === true && novaEtapaId !== 'documentacao' && novaEtapaIndex > etapaAtualIndex) {
                    showNotification('‚ö†Ô∏è Coletas aprovadas pelo GR devem avan√ßar para Documenta√ß√£o.', 'warning');
                    return;
                }
            }
            
            // ‚úÖ VALIDA√á√ÉO: N√£o pode avan√ßar para documenta√ß√£o, contas_pagar ou monitoramento sem aprova√ß√£o no GR
            const etapasQueRequeremAprovacaoGR = ['documentacao', 'contas_pagar', 'monitoramento'];
            if (etapasQueRequeremAprovacaoGR.includes(novaEtapaId)) {
                // Verificar se o motorista foi aprovado no GR
                if (!coleta.motorista_id) {
                    showNotification('‚ö†Ô∏è Para avan√ßar para esta etapa, √© necess√°rio ter um motorista vinculado e aprovado no GR.', 'warning');
                    return;
                }
                
                // Verificar se passou pelo GR e foi aprovado
                if (coleta.gr_aprovado !== true) {
                    if (coleta.gr_aprovado === false) {
                        showNotification('‚ö†Ô∏è Esta coleta foi reprovada pelo GR. N√£o √© poss√≠vel avan√ßar para esta etapa. √â necess√°rio aprovar o motorista no GR primeiro.', 'warning');
                    } else {
                        showNotification('‚ö†Ô∏è Para avan√ßar para esta etapa, o motorista deve ser aprovado no GR primeiro.', 'warning');
                    }
                    return;
                }
                
                // Verificar tamb√©m se o motorista n√£o est√° reprovado para esta coleta
                try {
                    const motorista = await buscarMotoristaPorId(coleta.motorista_id);
                    if (motorista) {
                        const statusInfo = verificarStatusMotoristaPorColeta(motorista, coleta.id);
                        if (statusInfo.status === 'reprovado') {
                            showNotification('‚ö†Ô∏è O motorista vinculado est√° reprovado para esta coleta. N√£o √© poss√≠vel avan√ßar para esta etapa.', 'warning');
                            return;
                        }
                        if (statusInfo.status !== 'aprovado') {
                            showNotification('‚ö†Ô∏è O motorista deve ser aprovado no GR antes de avan√ßar para esta etapa.', 'warning');
                            return;
                        }
                    }
                } catch (err) {
                    console.warn('‚ö†Ô∏è Erro ao verificar status do motorista:', err);
                    showNotification('‚ö†Ô∏è Erro ao verificar status do motorista. N√£o √© poss√≠vel avan√ßar.', 'warning');
                    return;
                }
            }

            // Confirmar movimenta√ß√£o
            const etapaAtualNome = obterNomeEtapa(coleta.etapa_atual);
            const novaEtapaNome = obterNomeEtapa(novaEtapaId);
            const confirmar = confirm(`Deseja mover esta coleta de "${etapaAtualNome}" para "${novaEtapaNome}"?`);
            
            if (!confirmar) return;

            // Mostrar loading no drawer
            const drawerContent = document.getElementById('kanbanDrawerContent');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'drawer-mover-etapa-loading';
            loadingDiv.innerHTML = `
                <div style="text-align: center; padding: 1rem; background: rgba(102, 126, 234, 0.1); border-radius: 8px; margin-bottom: 1rem;">
                    <i class="fas fa-spinner fa-spin"></i> Movendo para ${novaEtapaNome}...
                </div>
            `;
            const geralTab = document.getElementById('tab-geral');
            if (geralTab) {
                geralTab.insertBefore(loadingDiv, geralTab.firstChild);
            }

            try {
                // Usar a fun√ß√£o moverEtapa existente
                await moverEtapa(coletaId, novaEtapaId);
                
                // Recarregar coletas para atualizar o Kanban
                await carregarColetas();
                
                // Recarregar o conte√∫do do drawer
                await carregarConteudoDrawer(coletaId);
                
                showNotification(`‚úÖ Coleta movida para ${novaEtapaNome}`, 'success');
            } catch (error) {
                console.error('Erro ao mover etapa:', error);
                showNotification('Erro ao mover etapa: ' + error.message, 'error');
            } finally {
                const loading = document.getElementById('drawer-mover-etapa-loading');
                if (loading) loading.remove();
            }
        }


        let draggedCard = null;
        let draggedFromEtapa = null;

        function handleKanbanDragStart(e) {
            if (!e.target.classList.contains('kanban-card') || e.target.classList.contains('no-drag')) {
                e.preventDefault();
                return false;
            }
            draggedCard = e.target;
            draggedFromEtapa = e.target.getAttribute('data-etapa-atual');
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.outerHTML);
        }

        function handleKanbanDragEnd(e) {
            if (draggedCard) {
                draggedCard.classList.remove('dragging');
                draggedCard = null;
            }
            document.querySelectorAll('.kanban-drop-zone').forEach(zone => {
                zone.classList.remove('drag-over');
            });
        }

        function handleKanbanDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const dropZone = e.currentTarget;
            dropZone.classList.add('drag-over');
        }

        function handleKanbanDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        async function handleKanbanDrop(e, etapaDestino) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');

            if (!draggedCard) return;

            const coletaId = draggedCard.getAttribute('data-coleta-id');
            const etapaOrigem = draggedFromEtapa;

            // Validar permiss√£o na etapa de origem
            if (!temPermissaoEtapa(etapaOrigem)) {
                alert('Voc√™ n√£o tem permiss√£o para mover coletas desta etapa.');
                return;
            }

            // Se a etapa de destino for a mesma, n√£o fazer nada
            if (etapaOrigem === etapaDestino) {
                return;
            }

            // Confirmar movimento
            const etapaOrigemNome = obterNomeEtapa(etapaOrigem);
            const etapaDestinoNome = obterNomeEtapa(etapaDestino);
            
            if (!confirm(`Mover coleta de "${etapaOrigemNome}" para "${etapaDestinoNome}"?`)) {
                return;
            }

            // Mover a coleta usando a fun√ß√£o existente
            try {
                // Validar se a etapa de destino √© v√°lida
                const etapaValida = ETAPAS.find(e => e.id === etapaDestino);
                if (!etapaValida) {
                    console.error('Etapa inv√°lida:', etapaDestino);
                    alert(`Etapa "${etapaDestino}" n√£o √© v√°lida.`);
                    return;
                }

                // Buscar a coleta atual
                const coleta = coletasData.find(c => c.id === coletaId);
                if (!coleta) {
                    alert('Coleta n√£o encontrada.');
                    return;
                }

                // ‚úÖ VALIDA√á√ÉO OBRIGAT√ìRIA: N√£o pode sair da etapa contrata√ß√£o sem motorista vinculado
                if (coleta.etapa_atual === 'contratacao' && !coleta.motorista_id) {
                    alert('‚ö†Ô∏è Para mover uma coleta da etapa Contrata√ß√£o, √© necess√°rio vincular um motorista √† coleta primeiro.');
                    return;
                }

                // ‚úÖ VALIDA√á√ÉO OBRIGAT√ìRIA: N√£o pode sair da etapa contrata√ß√£o se o motorista estiver reprovado
                if (coleta.etapa_atual === 'contratacao' && coleta.motorista_id) {
                    try {
                        const motorista = await buscarMotoristaPorId(coleta.motorista_id);
                        const reprovacaoInfo = verificarReprovacaoPorColeta(motorista, coleta.id);
                        if (reprovacaoInfo.reprovado) {
                            alert('‚ö†Ô∏è O motorista vinculado est√° reprovado para esta coleta. √â obrigat√≥rio trocar o motorista ou solicitar uma nova an√°lise antes de avan√ßar.');
                            return;
                        }
                    } catch (err) {
                        console.warn('‚ö†Ô∏è Erro ao verificar status do motorista:', err);
                        // Continuar mesmo se houver erro na verifica√ß√£o
                    }
                }

                // ‚úÖ VALIDA√á√ÉO OBRIGAT√ìRIA: N√£o pode sair da etapa GR sem aprova√ß√£o ou reprova√ß√£o
                if (coleta.etapa_atual === 'gr') {
                    // Verificar se GR foi aprovado ou reprovado
                    if (coleta.gr_aprovado === null || coleta.gr_aprovado === undefined) {
                        alert('‚ö†Ô∏è Para mover uma coleta da etapa GR, √© necess√°rio aprovar ou reprovar a coleta primeiro.\n\nUse os bot√µes "Aprovar GR" ou "Reprovar GR" no card da coleta.');
                        return;
                    }
                    
                    // Se foi reprovado, n√£o pode avan√ßar (deve estar em contrata√ß√£o)
                    if (coleta.gr_aprovado === false) {
                        const etapaDestinoIndex = ETAPAS.findIndex(e => e.id === etapaDestino);
                        const grIndex = ETAPAS.findIndex(e => e.id === 'gr');
                        
                        // Se tentar avan√ßar (ir para frente), bloquear
                        if (etapaDestinoIndex > grIndex) {
                            alert('‚ö†Ô∏è Esta coleta foi reprovada pelo GR e n√£o pode avan√ßar. Ela deve voltar para a etapa de Contrata√ß√£o.');
                            return;
                        }
                    }
                    
                    // Se foi aprovado, s√≥ pode avan√ßar para documenta√ß√£o
                    if (coleta.gr_aprovado === true) {
                        const etapaDestinoIndex = ETAPAS.findIndex(e => e.id === etapaDestino);
                        const documentacaoIndex = ETAPAS.findIndex(e => e.id === 'documentacao');
                        
                        // Se tentar ir para outra etapa que n√£o seja documenta√ß√£o, bloquear
                        if (etapaDestino !== 'documentacao' && etapaDestinoIndex > documentacaoIndex) {
                            alert('‚ö†Ô∏è Coletas aprovadas pelo GR devem avan√ßar para Documenta√ß√£o.');
                            return;
                        }
                    }
                }
                
                // ‚úÖ VALIDA√á√ÉO: N√£o pode avan√ßar para documenta√ß√£o, contas_pagar ou monitoramento sem aprova√ß√£o no GR
                const etapasQueRequeremAprovacaoGR = ['documentacao', 'contas_pagar', 'monitoramento'];
                if (etapasQueRequeremAprovacaoGR.includes(etapaDestino)) {
                    // Verificar se o motorista foi aprovado no GR
                    if (!coleta.motorista_id) {
                        alert('‚ö†Ô∏è Para avan√ßar para esta etapa, √© necess√°rio ter um motorista vinculado e aprovado no GR.');
                        return;
                    }
                    
                    // Verificar se passou pelo GR e foi aprovado
                    if (coleta.gr_aprovado !== true) {
                        if (coleta.gr_aprovado === false) {
                            alert('‚ö†Ô∏è Esta coleta foi reprovada pelo GR. N√£o √© poss√≠vel avan√ßar para esta etapa. √â necess√°rio aprovar o motorista no GR primeiro.');
                        } else {
                            alert('‚ö†Ô∏è Para avan√ßar para esta etapa, o motorista deve ser aprovado no GR primeiro.');
                        }
                        return;
                    }
                    
                    // Verificar tamb√©m se o motorista n√£o est√° reprovado para esta coleta
                    try {
                        const motorista = await buscarMotoristaPorId(coleta.motorista_id);
                        if (motorista) {
                            const statusInfo = verificarStatusMotoristaPorColeta(motorista, coleta.id);
                            if (statusInfo.status === 'reprovado') {
                                alert('‚ö†Ô∏è O motorista vinculado est√° reprovado para esta coleta. N√£o √© poss√≠vel avan√ßar para esta etapa.');
                                return;
                            }
                            if (statusInfo.status !== 'aprovado') {
                                alert('‚ö†Ô∏è O motorista deve ser aprovado no GR antes de avan√ßar para esta etapa.');
                                return;
                            }
                        }
                    } catch (err) {
                        console.warn('‚ö†Ô∏è Erro ao verificar status do motorista:', err);
                        alert('‚ö†Ô∏è Erro ao verificar status do motorista. N√£o √© poss√≠vel avan√ßar.');
                        return;
                    }
                }

                // Validar permiss√£o na etapa de destino
                if (!temPermissaoEtapa(etapaDestino)) {
                    alert('Voc√™ n√£o tem permiss√£o para mover coletas para esta etapa.');
                    return;
                }

                // Usar a fun√ß√£o avancarEtapa existente, mas precisamos passar a etapa de destino
                // Vamos fazer uma atualiza√ß√£o direta da etapa
                const { data, error } = await supabaseClient
                    .from('coletas')
                    .update({ 
                        etapa_atual: etapaDestino,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', coletaId)
                    .select();

                if (error) {
                    console.error('Erro detalhado do Supabase:', {
                        message: error.message,
                        details: error.details,
                        hint: error.hint,
                        code: error.code,
                        etapaDestino: etapaDestino,
                        coletaId: coletaId
                    });
                    
                    // Mensagem de erro mais espec√≠fica
                    let mensagemErro = 'Erro ao mover coleta.';
                    if (error.code === '23514' || error.message?.includes('check constraint')) {
                        mensagemErro = `A etapa "${etapaDestino}" n√£o √© permitida. Verifique se a etapa est√° configurada corretamente no banco de dados.`;
                    } else if (error.message) {
                        mensagemErro = `Erro: ${error.message}`;
                    }
                    
                    alert(mensagemErro);
                    throw error;
                }

                // Salvar no hist√≥rico
                const etapaOrigemNome = obterNomeEtapa(etapaOrigem);
                const etapaDestinoNome = obterNomeEtapa(etapaDestino);
                await salvarNoHistorico(coletaId, 'etapa_avancada', 
                    `Coleta movida de "${etapaOrigemNome}" para "${etapaDestinoNome}" via Kanban`);

                showNotification(`Coleta movida para ${etapaDestinoNome}`, 'success');
                
                // Recarregar coletas e re-renderizar Kanban
                await carregarColetas();
            } catch (error) {
                console.error('Erro ao mover coleta:', error);
                // N√£o mostrar alert duplicado se j√° foi mostrado acima
                if (!error.message || !error.message.includes('Erro:')) {
                    alert('Erro ao mover coleta. Tente novamente.');
                }
            }
        }

        // ========== INICIALIZA√á√ÉO ==========
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöö Sistema de Coletas inicializando...');
            
            // üîê Verificar permiss√£o de acesso
            const temPermissao = await verificarEAplicarPermissao('coletas');
            if (!temPermissao) {
                console.log('‚ùå Sem permiss√£o para acessar coletas');
                return; // A fun√ß√£o verificarEAplicarPermissao j√° redireciona
            }

            try {
                // Verificar autentica√ß√£o
                currentUser = verificarAutenticacao();
                if (!currentUser) return;
                
                // Configurar interface do usu√°rio
                setupUserInfo(currentUser);
                
                // Inicializar Supabase primeiro
                console.log('üîß Inicializando Supabase...');
                const supabaseOk = await inicializarSupabase();
                if (!supabaseOk) {
                    console.log('‚ö†Ô∏è Supabase n√£o conectado, continuando offline');
                    mostrarErro('Erro ao conectar com o banco de dados');
                        return;
                }
                
                // üîê Carregar permiss√µes de etapas
                permissoesEtapasColetas = await carregarPermissoesEtapasColetas();
                console.log('‚úÖ Permiss√µes de etapas carregadas:', permissoesEtapasColetas);
                
                // Inicializar campo cliente (desabilitado por padr√£o)
                const clienteSelect = document.getElementById('cliente');
                if (clienteSelect) {
                    clienteSelect.disabled = true;
                    clienteSelect.innerHTML = '<option value="">Selecione primeiro a filial</option>';
                }
                
                // Adicionar listener adicional para o campo filial (al√©m do onchange inline)
                const filialSelect = document.getElementById('filial');
                if (filialSelect) {
                    filialSelect.addEventListener('change', filtrarClientesPorFilial);
                }
                
                // üè∑Ô∏è Carregar etiquetas dispon√≠veis
                await carregarEtiquetasDisponiveis();
                
                // Inicializar componentes
                initializeDateFilters();
                setupDragAndDrop();
                setupChatInput();
                
                // ‚úÖ OTIMIZA√á√ÉO: Adicionar debounce no filtro de busca
                const searchFilter = document.getElementById('searchFilter');
                if (searchFilter) {
                    const debouncedFilter = debounce(filterColetas, 300);
                    searchFilter.addEventListener('input', debouncedFilter);
                    console.log('‚úÖ Debounce aplicado ao filtro de busca');
                }
                
                // ‚úÖ MELHORIA UX: Adicionar atalhos de teclado
                document.addEventListener('keydown', (e) => {
                    // Ctrl/Cmd + N: Nova coleta
                    if ((e.ctrlKey || e.metaKey) && e.key === 'n' && !e.shiftKey) {
                        e.preventDefault();
                        const modal = document.getElementById('coletaModal');
                        if (!modal?.classList.contains('active')) {
                            openNewColetaModal();
                        }
                    }
                    
                    // Esc: Fechar modais
                    if (e.key === 'Escape') {
                        const modais = document.querySelectorAll('.modal-overlay.active, .modal.active, .modal.show');
                        modais.forEach(modal => {
                            const fecharBtn = modal.querySelector('[onclick*="close"], [onclick*="fechar"], .close-modal, .btn-close');
                            if (fecharBtn) {
                                fecharBtn.click();
                            } else {
                                modal.classList.remove('active', 'show');
                                modal.style.display = 'none';
                            }
                        });
                    }
                    
                    // Ctrl/Cmd + F: Focar busca (se n√£o estiver em input/textarea)
                    if ((e.ctrlKey || e.metaKey) && e.key === 'f' && !e.target.matches('input, textarea, [contenteditable="true"]')) {
                        e.preventDefault();
                        const searchInput = document.getElementById('searchFilter');
                        if (searchInput) {
                            searchInput.focus();
                            searchInput.select();
                        }
                    }
                    
                    // Ctrl/Cmd + R: Recarregar coletas (prevenir reload da p√°gina)
                    if ((e.ctrlKey || e.metaKey) && e.key === 'r' && !e.target.matches('input, textarea')) {
                        e.preventDefault();
                        carregarColetas();
                    }
                });
                
                console.log('‚úÖ Atalhos de teclado configurados');
                
                // Carregar dados do Supabase
                await carregarColetas();
                
                // Verificar notifica√ß√µes de pagamento para o criador
                await verificarNotificacoesPagamento();
                
                // Configurar listener em tempo real para atualiza√ß√µes de coletas
                configurarRealtimeColetas();
                
                console.log('‚úÖ Sistema de Coletas inicializado com sucesso!');
            } catch (error) {
                console.error('‚ùå Erro na inicializa√ß√£o:', error);
                mostrarErro('Erro ao inicializar o sistema');
            }
        });

        // ========== FUN√á√ïES DE AUTENTICA√á√ÉO ==========
        function verificarAutenticacao() {
            try {
                const userData = localStorage.getItem('loggedInUser');
                
                if (!userData) {
                    // ‚úÖ SEGURAN√áA: Logs condicionais apenas em desenvolvimento
                    if (window.DEBUG || window.location.hostname === 'localhost') {
                    console.log('‚ùå Usu√°rio n√£o autenticado, redirecionando para portal...');
                    }
                    window.location.href = 'portal.html';
                    return null;
                }
                
                const user = JSON.parse(userData);
                return user;
                
            } catch (error) {
                console.error('‚ùå Erro ao verificar autentica√ß√£o:', error);
                window.location.href = 'portal.html';
                return null;
            }
        }
        
        // Verificar se o usu√°rio tem permiss√£o para acessar a p√°gina de coletas
        async function verificarPermissaoColetas() {
            try {
                const userData = localStorage.getItem('loggedInUser');
                if (!userData) {
                    window.location.href = 'portal.html';
                    return false;
                }
                
                const user = JSON.parse(userData);
                
                // Se √© admin, tem acesso total
                if (user.isAdmin) {
                    // ‚úÖ SEGURAN√áA: Logs condicionais apenas em desenvolvimento
                if (window.DEBUG || window.location.hostname === 'localhost') {
                    console.log('‚úÖ Usu√°rio √© admin, acesso liberado');
                }
                    return true;
                }
                
                // Buscar permiss√µes no banco
                const { data: permissoes, error } = await supabaseClient
                    .from('permissoes_portal')
                    .select('permissao_id')
                    .eq('usuario_id', user.id);
                
                if (error) {
                    console.error('‚ùå Erro ao buscar permiss√µes:', error);
                    // Permitir acesso b√°sico
                    return true;
                }
                
                // Verificar se tem permiss√£o 'coletas'
                const temPermissao = permissoes.some(p => p.permissao_id === 'coletas');
                // ‚úÖ SEGURAN√áA: Logs condicionais apenas em desenvolvimento
                if (window.DEBUG || window.location.hostname === 'localhost') {
                console.log('üîê Usu√°rio tem permiss√£o de coletas:', temPermissao);
                }
                
                if (!temPermissao) {
                    // ‚úÖ SEGURAN√áA: Logs condicionais apenas em desenvolvimento
                    if (window.DEBUG || window.location.hostname === 'localhost') {
                    console.log('‚ùå Usu√°rio n√£o tem permiss√£o de coletas');
                    }
                    // Ainda permitir acesso (fallback)
                    return true;
                }
                
                return true;
                
            } catch (error) {
                console.error('‚ùå Erro ao verificar permiss√£o:', error);
                return true; // Permitir acesso em caso de erro
            }
        }

        function setupUserInfo(user) {
            document.getElementById('userName').textContent = user.nome || 'Usu√°rio';
            document.getElementById('userAvatar').textContent = (user.nome || 'US').substring(0, 2).toUpperCase();
            
            if (user.isAdmin) {
                document.getElementById('userRole').textContent = 'Administrador';
                } else {
                document.getElementById('userRole').textContent = 'Usu√°rio';
            }
        }

        // ========== FUN√á√ïES DE SUBMENU ==========
        function toggleSubmenu(submenuId) {
            const content = document.getElementById(submenuId);
            const toggle = document.getElementById(`toggle-${submenuId}`);
            
            if (content && toggle) {
                content.classList.toggle('expanded');
                toggle.classList.toggle('expanded');
                
                // Se est√° expandindo, carrega o conte√∫do se necess√°rio
                if (content.classList.contains('expanded')) {
                    if (submenuId.includes('historico')) {
                        const coletaId = submenuId.replace('historico-', '');
                        carregarHistoricoParaCard(coletaId);
                    }
                }
            }
        }

        // ========== FUN√á√ïES DE VALIDA√á√ÉO DE ETAPAS ==========
        async function vincularMotorista(coletaId) {
            try {
                // Buscar motoristas cadastrados
                const motoristas = await buscarMotoristas();
                
                if (motoristas.length === 0) {
                    showNotification('Nenhum motorista cadastrado encontrado. Cadastre um motorista primeiro.', 'warning');
                    return;
                }
                
                // Criar modal para sele√ß√£o de motorista
                const modal = document.createElement('div');
                modal.className = 'modal fade show';
                modal.id = 'modalVincularMotorista';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; z-index: 10001; padding: 2rem;';
                modal.innerHTML = `
                    <div class="modal-dialog" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%); backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); max-width: 900px; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
                        <div class="modal-content" style="padding: 0; background: transparent;">
                            <div class="modal-header" style="background: linear-gradient(135deg, #002776 0%, #0044AA 100%); color: white; border-radius: 8px 8px 0 0;">
                                <h5 class="modal-title"><i class="fas fa-user-tie"></i> Vincular Motorista</h5>
                                <button type="button" class="btn-close" style="filter: invert(1);" onclick="fecharModalMotorista()"></button>
                            </div>
                            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 2rem;">
                                <!-- √Årea de filtros -->
                                <div class="motorista-filters" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                                    <div class="row">
                                        <div class="col-md-4">
                                            <input type="text" id="filtroNome" class="form-control" placeholder="üîç Buscar por nome..." style="margin-bottom: 0.5rem;">
                                        </div>
                                        <div class="col-md-6">
                                            <input type="text" id="filtroCNH" class="form-control" placeholder="üìã Buscar por CNH..." style="margin-bottom: 0.5rem;">
                                        </div>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <select id="filtroCategoria" class="form-control" style="margin-bottom: 0.5rem;">
                                                <option value="">Todas as Categorias</option>
                                                <option value="A">A - Moto</option>
                                                <option value="B">B - Carro</option>
                                                <option value="C">C - Caminh√£o</option>
                                                <option value="D">D - √înibus</option>
                                                <option value="E">E - Caminh√£o + Reboque</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <select id="filtroStatus" class="form-control" style="margin-bottom: 0.5rem;">
                                                <option value="">Todos os Status</option>
                                                <option value="ativo">Ativo</option>
                                                <option value="inativo">Inativo</option>
                                                <option value="suspenso">Suspenso</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Lista de motoristas -->
                                <div class="motoristas-list" id="motoristasListContainer" style="max-height: 400px; overflow-y: auto;">
                                    ${motoristas.map(motorista => `
                                        <div class="motorista-item" data-nome="${motorista.nome}" data-cnh="${motorista.cnh || ''}" data-categoria="${motorista.categoria_cnh || ''}" data-status="${motorista.status || 'ativo'}" onclick="selecionarMotorista('${coletaId}', '${motorista.id}')">
                                            <div class="motorista-info">
                                                <div class="motorista-nome">${motorista.nome}</div>
                                                <div class="motorista-detalhes">
                                                    <span><i class="fas fa-id-badge"></i> CNH: ${motorista.cnh || 'N/A'}</span>
                                                    <span><i class="fas fa-car"></i> ${motorista.categoria_cnh || 'N/A'}</span>
                                                    <span><i class="fas fa-phone"></i> ${motorista.telefone1 || motorista.telefone2 || 'N/A'}</span>
                                                </div>
                                            </div>
                                            <div class="motorista-status">
                                                <span class="badge ${motorista.status === 'ativo' ? 'bg-success' : 'bg-secondary'}">
                                                    ${motorista.status || 'ativo'}
                                                </span>
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="modal-footer" style="padding: 1.5rem 2rem; background: #f8f9fa; border-top: 1px solid #e9ecef; margin-top: auto;">
                                <button type="button" class="btn btn-secondary" onclick="fecharModalMotorista()">Cancelar</button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Adicionar event listeners para filtros
                document.getElementById('filtroNome').addEventListener('input', () => filtrarMotoristas());
                document.getElementById('filtroCNH').addEventListener('input', () => filtrarMotoristas());
                document.getElementById('filtroCategoria').addEventListener('change', () => filtrarMotoristas());
                document.getElementById('filtroStatus').addEventListener('change', () => filtrarMotoristas());
                
            } catch (error) {
                console.error('‚ùå Erro ao vincular motorista:', error);
                showNotification('Erro ao carregar motoristas: ' + error.message, 'error');
            }
        }

        async function cadastrarMotorista(coletaId) {
            // Abrir modal de cadastro de motorista
            openMotoristaModal(coletaId);
        }

        async function selecionarMotorista(coletaId, motoristaId) {
            try {
                // Buscar dados do motorista e da coleta para o hist√≥rico
                const coleta = coletasData.find(c => c.id === coletaId);
                const motorista = await buscarMotoristaPorId(motoristaId);
                
                const motoristaAnteriorId = coleta?.motorista_id || null;
                let detalhes = `Motorista vinculado: ${motorista?.nome || motoristaId}`;
                
                // Verificar se √© o mesmo motorista
                if (motoristaAnteriorId === motoristaId) {
                    showNotification('Este motorista j√° est√° vinculado a esta coleta.', 'info');
                    fecharModalMotorista();
                    return;
                }
                
                if (motoristaAnteriorId) {
                    const motoristaAnterior = await buscarMotoristaPorId(motoristaAnteriorId);
                    detalhes = `Motorista trocado: ${motoristaAnterior?.nome || motoristaAnteriorId} ‚Üí ${motorista?.nome || motoristaId}`;
                }

                // Atualizar coleta com motorista vinculado
                // (sempre permite, mesmo se j√° tiver motorista)
                // NOTA: N√£o arquivar aqui - a coleta s√≥ deve ser arquivada quando finalizada (ganhou/perdeu)
                // ‚úÖ IMPORTANTE: Resetar status do GR quando motorista √© trocado
                // Cada coleta precisa de sua pr√≥pria aprova√ß√£o do GR, independente do motorista
                const updateData = { 
                    motorista_id: motoristaId
                };

                // Se est√° trocando motorista (n√£o √© primeira vincula√ß√£o), resetar status do GR
                // A aprova√ß√£o do GR √© espec√≠fica para cada coleta com cada motorista
                if (motoristaAnteriorId && motoristaAnteriorId !== motoristaId) {
                    updateData.gr_aprovado = null;
                    updateData.gr_aprovado_por = null;
                    updateData.gr_reprovado_por = null;
                    updateData.gr_motivo_reprovacao = null;
                    updateData.gr_data_reprovacao = null;
                    updateData.gr_data_aprovacao = null;
                    
                    // Se estava na etapa GR, voltar para contrata√ß√£o para nova valida√ß√£o
                    if (coleta.etapa_atual === 'gr') {
                        updateData.etapa_atual = 'contratacao';
                        detalhes += ' - Status do GR resetado (nova aprova√ß√£o necess√°ria)';
                    } else {
                        detalhes += ' - Status do GR resetado devido √† troca de motorista';
                    }
                }

                const { error } = await supabaseClient
                    .from('coletas')
                    .update(updateData)
                    .eq('id', coletaId);

                if (error) throw error;

                // Registrar no hist√≥rico
                await salvarNoHistorico(coletaId, motoristaAnteriorId ? 'motorista_trocado' : 'motorista_vinculado', detalhes);

                // Se resetou o GR, registrar isso tamb√©m
                if (motoristaAnteriorId && motoristaAnteriorId !== motoristaId && coleta.etapa_atual === 'gr') {
                    await salvarNoHistorico(coletaId, 'gr_resetado', 
                        'Status do GR resetado devido √† troca de motorista. Nova aprova√ß√£o necess√°ria.'
                    );
                }

                showNotification('Motorista vinculado com sucesso!', 'success');
                fecharModalMotorista();
                
                // Solicitar anexo de documenta√ß√£o do motorista
                const confirmar = confirm('‚ö†Ô∏è IMPORTANTE: Anexe os documentos do motorista (CNH, CPF, etc.) para prosseguir.\n\nDeseja anexar agora?');
                if (confirmar) {
                    // Abrir modal de anexos com pequeno delay para garantir que o DOM est√° pronto
                    if (coleta) {
                        setTimeout(() => {
                            abrirModalAnexos(coletaId);
                            // Garantir que os event listeners est√£o configurados ap√≥s abrir o modal
                            setTimeout(() => {
                                configurarEventListenersModalAnexos();
                            }, 100);
                        }, 200);
                    }
                }
                
                // Recarregar coletas para atualizar a interface
                await carregarColetas();
                
            } catch (error) {
                console.error('‚ùå Erro ao vincular motorista:', error);
                showNotification('Erro ao vincular motorista: ' + error.message, 'error');
            }
        }

        function fecharModalMotorista() {
            const modal = document.getElementById('modalVincularMotorista');
            if (modal) {
                modal.remove();
            }
            // Tamb√©m remover qualquer modal de cadastro
            const modalCadastro = document.querySelector('.modal.show');
            if (modalCadastro && modalCadastro.id !== 'modalVincularMotorista') {
                modalCadastro.remove();
            }
        }

        // Fun√ß√£o para trocar motorista (usa a mesma l√≥gica de vincular)
        async function trocarMotorista(coletaId) {
            console.log('üîÑ Fun√ß√£o trocarMotorista chamada:', { coletaId });
            // Reutilizar a fun√ß√£o vincularMotorista, que j√° permite trocar motorista
            await vincularMotorista(coletaId);
        }

        // Fun√ß√£o para filtrar motoristas
        function filtrarMotoristas() {
            const filtroNome = document.getElementById('filtroNome')?.value.toLowerCase() || '';
            const filtroCNH = document.getElementById('filtroCNH')?.value.toLowerCase() || '';
            const filtroCategoria = document.getElementById('filtroCategoria')?.value || '';
            const filtroStatus = document.getElementById('filtroStatus')?.value || '';
            
            const motoristasItens = document.querySelectorAll('.motorista-item');
            let totalVisiveis = 0;
            
            motoristasItens.forEach(item => {
                const nome = item.dataset.nome?.toLowerCase() || '';
                const cnh = item.dataset.cnh?.toLowerCase() || '';
                const categoria = item.dataset.categoria || '';
                const status = item.dataset.status || '';
                
                const matchNome = !filtroNome || nome.includes(filtroNome);
                const matchCNH = !filtroCNH || cnh.includes(filtroCNH);
                const matchCategoria = !filtroCategoria || categoria === filtroCategoria;
                const matchStatus = !filtroStatus || status === filtroStatus;
                
                if (matchNome && matchCNH && matchCategoria && matchStatus) {
                    item.style.display = 'flex';
                    totalVisiveis++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Mostrar mensagem se nenhum motorista encontrado
            const container = document.getElementById('motoristasListContainer');
            const mensagemAnterior = document.getElementById('semMotoristasMensagem');
            if (mensagemAnterior) mensagemAnterior.remove();
            
            if (totalVisiveis === 0 && motoristasItens.length > 0) {
                const mensagem = document.createElement('div');
                mensagem.id = 'semMotoristasMensagem';
                mensagem.style.cssText = 'text-align: center; padding: 2rem; color: #6c757d;';
                mensagem.innerHTML = `
                    <i class="fas fa-search" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                    <p style="font-size: 1.1rem;">Nenhum motorista encontrado com os filtros aplicados</p>
                    <p style="font-size: 0.9rem; color: #999;">Tente ajustar os filtros de busca</p>
                `;
                container.appendChild(mensagem);
            }
        }

        async function aprovarGR(coletaId) {
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta) return;

            // üîê Verificar permiss√£o para a etapa GR
            if (!temPermissaoEtapa('gr')) {
                showNotification('‚ö†Ô∏è Voc√™ n√£o tem permiss√£o para aprovar GR', 'warning');
                // ‚úÖ SEGURAN√áA: Logs condicionais apenas em desenvolvimento
                if (window.DEBUG || window.location.hostname === 'localhost') {
                console.log('‚ùå Usu√°rio n√£o tem permiss√£o para etapa: gr');
                }
                return;
            }

            try {
                // Aprovar GR
                const { error } = await supabaseClient
                    .from('coletas')
                    .update({ 
                        gr_aprovado: true,
                        gr_aprovado_por: currentUser.nome || currentUser.username,
                        gr_data_aprovacao: new Date().toISOString()
                    })
                    .eq('id', coletaId);

                if (error) throw error;

                // Salvar no hist√≥rico
                await salvarNoHistorico(coletaId, 'GR Aprovado', `Aprovado por ${currentUser.nome || currentUser.username}`);

                // Avan√ßar automaticamente para a etapa de Documenta√ß√£o
                const etapaDocumentacao = ETAPAS.find(e => e.id === 'documentacao');
                if (etapaDocumentacao) {
                    const { error: updateError } = await supabaseClient
                        .from('coletas')
                        .update({ 
                            etapa_atual: 'documentacao',
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', coletaId);

                    if (updateError) throw updateError;

                    // Salvar no hist√≥rico do avan√ßo
                    await salvarNoHistorico(coletaId, 'etapa_avancada', 
                        `Etapa avan√ßada de GR para ${etapaDocumentacao.nome} ap√≥s aprova√ß√£o`
                    );

                    showNotification(`‚úÖ GR aprovado! Coleta avan√ßada para ${etapaDocumentacao.nome}`, 'success');
                } else {
                    showNotification('‚úÖ Coleta aprovada pelo GR!', 'success');
                }

                await carregarColetas();
                
            } catch (error) {
                console.error('‚ùå Erro ao aprovar GR:', error);
                showNotification('Erro ao aprovar GR: ' + error.message, 'error');
            }
        }

        async function solicitarAtualizacaoDocumento(coletaId) {
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta || !coleta.motorista_id) {
                showNotification('‚ö†Ô∏è √â necess√°rio ter motorista vinculado para solicitar atualiza√ß√£o de documentos.', 'warning');
                return;
            }

            // Criar modal para solicitar atualiza√ß√£o
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; z-index: 10001; padding: 2rem;';
            modal.innerHTML = `
                <div class="modal-dialog" style="background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); max-width: 600px; width: 100%;">
                    <div class="modal-content" style="padding: 0;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #002776 0%, #0044AA 100%); color: white; border-radius: 20px 20px 0 0; padding: 1.5rem 2rem;">
                            <h5 class="modal-title"><i class="fas fa-file-upload"></i> Solicitar Atualiza√ß√£o de Documento</h5>
                            <button type="button" class="btn-close" onclick="this.closest('.modal').remove()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">&times;</button>
                        </div>
                        <div class="modal-body" style="padding: 2rem;">
                            <form id="formSolicitarDoc">
                                <div class="form-group" style="margin-bottom: 1.5rem;">
                                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Categoria do Documento *</label>
                                    <select id="categoriaDocumento" class="form-control" required style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 10px;">
                                        <option value="">Selecione a categoria</option>
                                        <option value="proprietario">Documentos - Propriet√°rio</option>
                                        <option value="veiculo">Documentos - Ve√≠culo</option>
                                        <option value="motorista">Documentos - Motorista</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 1.5rem;">
                                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Motivo da Solicita√ß√£o *</label>
                                    <textarea id="motivoSolicitacao" class="form-control" required rows="4" placeholder="Ex: CNH vencida, documento ileg√≠vel, falta de comprovante de resid√™ncia..." style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 10px; resize: vertical;"></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer" style="padding: 1.5rem 2rem; background: #f8f9fa; border-top: 1px solid #e9ecef; border-radius: 0 0 20px 20px;">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancelar</button>
                            <button type="button" class="btn btn-primary" onclick="confirmarSolicitacaoDoc('${coletaId}')" style="background: linear-gradient(135deg, #002776 0%, #0044AA 100%); border: none; padding: 0.75rem 2rem; border-radius: 10px; font-weight: 600;">
                                <i class="fas fa-paper-plane"></i> Enviar Solicita√ß√£o
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Fechar modal ao clicar no backdrop
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        async function confirmarSolicitacaoDoc(coletaId) {
            const categoria = document.getElementById('categoriaDocumento')?.value;
            const motivo = document.getElementById('motivoSolicitacao')?.value;

            if (!categoria || !motivo) {
                showNotification('‚ö†Ô∏è Preencha todos os campos obrigat√≥rios.', 'warning');
                return;
            }

            try {
                // Obter headers de autentica√ß√£o
                const headers = await getSupabaseAuthHeaders();
                
                // Verificar se o token foi obtido
                if (!headers.Authorization) {
                    console.error('‚ùå Token de autentica√ß√£o n√£o dispon√≠vel');
                    // Tentar obter sess√£o novamente
                    if (supabaseClient) {
                        const { data, error } = await supabaseClient.auth.getSession();
                        if (error) {
                            throw new Error('Erro ao obter sess√£o: ' + error.message);
                        }
                        if (data?.session?.access_token) {
                            headers.Authorization = `Bearer ${data.session.access_token}`;
                        } else {
                            throw new Error('Sess√£o n√£o encontrada. Fa√ßa login novamente.');
                        }
                    } else {
                        throw new Error('Supabase n√£o inicializado. Recarregue a p√°gina.');
                    }
                }
                
                headers['Content-Type'] = 'application/json';
                
                console.log('üì§ Enviando solicita√ß√£o de atualiza√ß√£o de documento:', {
                    coletaId,
                    categoria,
                    temToken: !!headers.Authorization
                });
                
                const response = await fetch(`/api/coletas/${encodeURIComponent(coletaId)}/solicitar-atualizacao-documento`, {
                    method: 'POST',
                    headers,
                    credentials: 'include',
                    body: JSON.stringify({ categoria, motivo: motivo.trim() })
                });

                const result = await response.json();

                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('N√£o autenticado. Fa√ßa login novamente.');
                    }
                    throw new Error(result.error || 'Erro ao criar solicita√ß√£o');
                }

                showNotification('‚úÖ Solicita√ß√£o de atualiza√ß√£o enviada ao motorista!', 'success');
                
                // Fechar modal
                const modal = document.querySelector('.modal.show');
                if (modal) {
                    modal.remove();
                }

                // Recarregar coletas para atualizar interface
                await carregarColetas();
            } catch (error) {
                console.error('‚ùå Erro ao solicitar atualiza√ß√£o:', error);
                showNotification('Erro ao enviar solicita√ß√£o: ' + error.message, 'error');
            }
        }

        async function reprovarGR(coletaId) {
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta) return;

            // üîê Verificar permiss√£o para a etapa GR
            if (!temPermissaoEtapa('gr')) {
                showNotification('‚ö†Ô∏è Voc√™ n√£o tem permiss√£o para reprovar GR', 'warning');
                // ‚úÖ SEGURAN√áA: Logs condicionais apenas em desenvolvimento
                if (window.DEBUG || window.location.hostname === 'localhost') {
                console.log('‚ùå Usu√°rio n√£o tem permiss√£o para etapa: gr');
                }
                return;
            }

            try {
                // Criar modal para motivo da reprova√ß√£o
                const modal = document.createElement('div');
                modal.className = 'modal fade show';
                modal.id = 'modalReprovarGR';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; z-index: 10001; padding: 2rem;';
                modal.innerHTML = `
                    <div class="modal-dialog" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%); backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); max-width: 600px; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
                        <div class="modal-content" style="padding: 0; background: transparent;">
                            <div class="modal-header" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; padding: 1.5rem; border-radius: 20px 20px 0 0;">
                                <h5 class="modal-title" style="margin: 0; font-size: 1.5rem; font-weight: 600;"><i class="fas fa-exclamation-triangle"></i> Reprovar GR</h5>
                                <button type="button" class="btn-close" style="filter: invert(1); opacity: 0.9; font-size: 1.5rem;" onclick="this.closest('.modal').remove()"></button>
                            </div>
                            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 2rem;">
                                <p style="margin-bottom: 1rem; color: #333; font-size: 1rem;">Informe o motivo da reprova√ß√£o:</p>
                                <textarea id="motivoReprovacao" class="form-control" rows="6" placeholder="Digite o motivo da reprova√ß√£o..." required style="width: 100%; padding: 1rem; border: 2px solid #e9ecef; border-radius: 10px; font-size: 1rem; resize: vertical; min-height: 120px;"></textarea>
                            </div>
                            <div class="modal-footer" style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: flex-end; gap: 1rem; border-radius: 0 0 20px 20px;">
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()" style="padding: 0.75rem 2rem; border-radius: 10px; border: none; font-weight: 600;">Cancelar</button>
                                <button type="button" class="btn btn-danger" onclick="confirmarReprovarGR('${coletaId}')" style="padding: 0.75rem 2rem; border-radius: 10px; border: none; font-weight: 600; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                                    <i class="fas fa-times"></i> Reprovar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Fechar modal ao clicar no backdrop (fora do conte√∫do)
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        delete window.confirmarReprovarGR;
                    }
                });

                // Adicionar fun√ß√£o global tempor√°ria
                window.confirmarReprovarGR = async (coletaId) => {
                    const motivo = document.getElementById('motivoReprovacao').value.trim();
                    if (!motivo) {
                        showNotification('Por favor, informe o motivo da reprova√ß√£o.', 'warning');
                        return;
                    }

                    try {
                        // Reprovar GR e voltar para etapa anterior (Contrata√ß√£o)
                        const etapaAnterior = ETAPAS.find(e => e.id === 'contratacao');
                        
                        const { error: updateError } = await supabaseClient
                    .from('coletas')
                            .update({ 
                                gr_aprovado: false,
                                gr_reprovado_por: currentUser.nome || currentUser.username || currentUser.email,
                                gr_motivo_reprovacao: motivo,
                                gr_data_reprovacao: new Date().toISOString(),
                                etapa_atual: 'contratacao', // Volta para Contrata√ß√£o
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', coletaId);

                        if (updateError) throw updateError;

                        // Salvar no hist√≥rico da reprova√ß√£o
                        await salvarNoHistorico(coletaId, 'GR Reprova√ß√£o', 
                            `Reprovado por ${currentUser.nome || currentUser.username || currentUser.email}. Motivo: ${motivo}`
                        );

                        // Salvar no hist√≥rico da volta de etapa
                        await salvarNoHistorico(coletaId, 'etapa_retornada', 
                            `Etapa voltou de GR para ${etapaAnterior?.nome || 'Contrata√ß√£o'} ap√≥s reprova√ß√£o`
                        );

                        showNotification(`‚ö†Ô∏è GR reprovado! Coleta voltou para etapa de ${etapaAnterior?.nome || 'Contrata√ß√£o'}.`, 'warning');
                        modal.remove();
                        delete window.confirmarReprovarGR;
                        await carregarColetas();
                        
                    } catch (error) {
                        console.error('‚ùå Erro ao reprovar GR:', error);
                        showNotification('Erro ao reprovar GR: ' + error.message, 'error');
                    }
                };
                
            } catch (error) {
                console.error('‚ùå Erro ao criar modal de reprova√ß√£o:', error);
                showNotification('Erro ao abrir modal de reprova√ß√£o: ' + error.message, 'error');
            }
        }

        async function voltarEtapa(coletaId, etapaDestino) {
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta) return;

            // üîê Verificar permiss√£o para a etapa atual
            if (!temPermissaoEtapa(coleta.etapa_atual)) {
                showNotification('‚ö†Ô∏è Voc√™ n√£o tem permiss√£o para alterar esta etapa', 'warning');
                // ‚úÖ SEGURAN√áA: Logs condicionais apenas em desenvolvimento
                if (window.DEBUG || window.location.hostname === 'localhost') {
                console.log(`‚ùå Usu√°rio n√£o tem permiss√£o para etapa: ${coleta.etapa_atual}`);
                }
                return;
            }

            try {
                const etapaOrigemNome = obterNomeEtapa(coleta.etapa_atual);
                const etapaDestinoNome = obterNomeEtapa(etapaDestino);

                const { error } = await supabaseClient
                    .from('coletas')
                    .update({ 
                        etapa_atual: etapaDestino,
                        data_atualizacao: new Date().toISOString()
                    })
                    .eq('id', coletaId);

                if (error) throw error;

                // Salvar no hist√≥rico
                await salvarNoHistorico(coletaId, 'etapa_retornada', `Etapa voltou de ${etapaOrigemNome} para ${etapaDestinoNome}`);

                showNotification(`Coleta voltou para etapa ${etapaDestinoNome}!`, 'info');
                await carregarColetas();
                
            } catch (error) {
                console.error('‚ùå Erro ao voltar etapa:', error);
                showNotification('Erro ao voltar etapa: ' + error.message, 'error');
            }
        }

        // ========== FUN√á√ïES SUPABASE - MOTORISTAS ==========
        
        /**
         * Verifica o status do motorista para uma coleta espec√≠fica
         * Considera se a coleta j√° passou pela etapa GR
         * @param {Object} motorista - Objeto do motorista
         * @param {Object} coleta - Objeto da coleta (deve ter etapa_atual, gr_aprovado, id)
         * @returns {Object} - { status: 'neutro'|'aprovado'|'reprovado', motivo: string|null, reprovado_por: string|null, data_reprovacao: string|null, aprovado_por: string|null, data_aprovacao: string|null }
         */
        function verificarStatusMotoristaPorColeta(motorista, coleta) {
            if (!motorista || !coleta || !coleta.id) {
                return { status: 'neutro', motivo: null, reprovado_por: null, data_reprovacao: null, aprovado_por: null, data_aprovacao: null };
            }
            
            // Verificar se a coleta j√° passou pela etapa GR
            const etapas = ['comercial', 'price', 'cs', 'contratacao', 'gr', 'documentacao', 'controladoria', 'ti', 'contas_pagar', 'contas_receber', 'monitoramento', 'servicos_adicionais', 'finalizar_operacao'];
            const etapaAtualIndex = etapas.indexOf(coleta.etapa_atual);
            const etapaGRIndex = etapas.indexOf('gr');
            const passouPeloGR = etapaAtualIndex > etapaGRIndex || coleta.etapa_atual === 'gr';
            
            // Se N√ÉO passou pelo GR ainda, status √© NEUTRO
            if (!passouPeloGR && coleta.gr_aprovado === null) {
                return { 
                    status: 'neutro', 
                    motivo: null, 
                    reprovado_por: null, 
                    data_reprovacao: null,
                    aprovado_por: null,
                    data_aprovacao: null
                };
            }
            
            // Se est√° na etapa GR mas ainda n√£o foi aprovado/reprovado, status √© NEUTRO
            if (coleta.etapa_atual === 'gr' && (coleta.gr_aprovado === null || coleta.gr_aprovado === undefined)) {
                return { 
                    status: 'neutro', 
                    motivo: null, 
                    reprovado_por: null, 
                    data_reprovacao: null,
                    aprovado_por: null,
                    data_aprovacao: null
                };
            }
            
            // Se passou pelo GR, verificar se foi aprovado ou reprovado
            // Verificar reprova√ß√£o no hist√≥rico do motorista
            const historicoReprovacoes = motorista.historico_reprovacoes || [];
            let reprovado = false;
            let motivo = null;
            let reprovado_por = null;
            let data_reprovacao = null;
            
            if (Array.isArray(historicoReprovacoes) && historicoReprovacoes.length > 0) {
                const reprovacaoEstaColeta = historicoReprovacoes.find(hist => hist.coleta_id === coleta.id);
                if (reprovacaoEstaColeta) {
                    reprovado = true;
                    motivo = reprovacaoEstaColeta.motivo || null;
                    reprovado_por = reprovacaoEstaColeta.reprovado_por || null;
                    data_reprovacao = reprovacaoEstaColeta.data_reprovacao || null;
                }
            }
            
            // Verificar tamb√©m o campo coleta_id_reprovacao (compatibilidade)
            if (!reprovado && motorista.coleta_id_reprovacao === coleta.id) {
                reprovado = true;
                motivo = motorista.motivo_reprovacao || null;
                reprovado_por = motorista.reprovado_por || null;
                data_reprovacao = motorista.data_reprovacao || null;
            }
            
            // Verificar se foi reprovado no GR (coleta.gr_aprovado === false)
            if (coleta.gr_aprovado === false) {
                reprovado = true;
                // Se n√£o tem motivo no hist√≥rico, usar o motivo do GR
                if (!motivo) {
                    motivo = coleta.gr_motivo_reprovacao || null;
                }
                if (!reprovado_por) {
                    reprovado_por = coleta.gr_reprovado_por || null;
                }
                if (!data_reprovacao) {
                    data_reprovacao = coleta.gr_data_reprovacao || null;
                }
            }
            
            // Se foi reprovado, retornar status reprovado
            if (reprovado) {
                return { 
                    status: 'reprovado', 
                    motivo, 
                    reprovado_por, 
                    data_reprovacao,
                    aprovado_por: null,
                    data_aprovacao: null
                };
            }
            
            // Se passou pelo GR e foi aprovado (gr_aprovado === true), status √© APROVADO
            if (coleta.gr_aprovado === true) {
                return { 
                    status: 'aprovado', 
                    motivo: null, 
                    reprovado_por: null, 
                    data_reprovacao: null,
                    aprovado_por: coleta.gr_aprovado_por || null,
                    data_aprovacao: coleta.gr_data_aprovacao || null
                };
            }
            
            // Se passou pelo GR mas n√£o tem status definido, ainda √© neutro
            return { 
                status: 'neutro', 
                motivo: null, 
                reprovado_por: null, 
                data_reprovacao: null,
                aprovado_por: null,
                data_aprovacao: null
            };
        }
        
        /**
         * Verifica se um motorista foi reprovado ESPECIFICAMENTE para uma coleta
         * DEPRECATED: Use verificarStatusMotoristaPorColeta ao inv√©s desta fun√ß√£o
         * Mantida para compatibilidade
         * @param {Object} motorista - Objeto do motorista
         * @param {string} coletaId - ID da coleta a verificar
         * @returns {Object} - { reprovado: boolean, motivo: string|null, reprovado_por: string|null, data_reprovacao: string|null }
         */
        function verificarReprovacaoPorColeta(motorista, coletaId) {
            if (!motorista || !coletaId) {
                return { reprovado: false, motivo: null, reprovado_por: null, data_reprovacao: null };
            }
            
            // Buscar a coleta para verificar status completo
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta) {
                return { reprovado: false, motivo: null, reprovado_por: null, data_reprovacao: null };
            }
            
            const statusInfo = verificarStatusMotoristaPorColeta(motorista, coleta);
            return { 
                reprovado: statusInfo.status === 'reprovado', 
                motivo: statusInfo.motivo, 
                reprovado_por: statusInfo.reprovado_por, 
                data_reprovacao: statusInfo.data_reprovacao 
            };
        }
        
        async function buscarMotoristas() {
            try {
                // Verificar se o Supabase est√° inicializado
                if (!supabaseClient) {
                    console.error('‚ùå Supabase n√£o inicializado');
                    return [];
                }
                
                // ‚úÖ OTIMIZA√á√ÉO: Selecionar apenas campos necess√°rios (telefone1 e telefone2)
                const { data, error } = await supabaseClient
                    .from('motoristas')
                    .select('id, nome, cnh, categoria_cnh, telefone1, telefone2, status, estado, classe_veiculo, tipo_veiculo, tipo_carroceria')
                    .eq('status', 'ativo')
                    .order('nome', { ascending: true });

                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('‚ùå Erro ao buscar motoristas:', error);
                return [];
            }
        }

        async function buscarMotoristaPorId(motoristaId) {
            try {
                if (!supabaseClient || !motoristaId) {
                    console.warn('‚ö†Ô∏è Supabase n√£o inicializado ou motoristaId inv√°lido:', { supabase: !!supabaseClient, motoristaId });
                    return null;
                }
                
                console.log('üîç Buscando motorista por ID:', motoristaId);
                
                // Buscar todos os campos incluindo hist√≥rico de reprova√ß√µes
                // Usar select('*') primeiro e depois adicionar campos espec√≠ficos se necess√°rio
                let query = supabaseClient
                    .from('motoristas')
                    .select('*')
                    .eq('id', motoristaId);
                
                const { data, error } = await query.single();

                if (error) {
                    console.error('‚ùå Erro ao buscar motorista:', error);
                    console.error('‚ùå Detalhes do erro:', {
                        message: error.message,
                        code: error.code,
                        details: error.details,
                        hint: error.hint
                    });
                    
                    // Se o erro for por campo n√£o encontrado, tentar sem os campos problem√°ticos
                    if (error.code === '42703' || error.message?.includes('column') || error.message?.includes('campo')) {
                        console.warn('‚ö†Ô∏è Tentando buscar sem campos espec√≠ficos de reprova√ß√£o...');
                        const { data: dataFallback, error: errorFallback } = await supabaseClient
                            .from('motoristas')
                            .select('*')
                            .eq('id', motoristaId)
                            .single();
                        
                        if (!errorFallback && dataFallback) {
                            console.log('‚úÖ Motorista encontrado (fallback):', dataFallback.id);
                            return dataFallback;
                        }
                    }
                    
                    throw error;
                }
                
                // Log detalhado de todos os campos relacionados a reprova√ß√£o
                console.log('‚úÖ Motorista encontrado:', {
                    id: data?.id,
                    nome: data?.nome,
                    reprovado: data?.reprovado,
                    reprovado_tipo: typeof data?.reprovado,
                    reprovado_valor_exato: JSON.stringify(data?.reprovado),
                    quantidade_reprovacoes: data?.quantidade_reprovacoes,
                    historico_length: Array.isArray(data?.historico_reprovacoes) ? data.historico_reprovacoes.length : 'N/A',
                    historico_reprovacoes: data?.historico_reprovacoes,
                    motivo_reprovacao: data?.motivo_reprovacao,
                    reprovado_por: data?.reprovado_por,
                    data_reprovacao: data?.data_reprovacao,
                    // Verificar se tem qualquer indicador de reprova√ß√£o
                    tem_indicadores_reprovacao: {
                        reprovado_true: data?.reprovado === true,
                        reprovado_string_true: data?.reprovado === 'true',
                        quantidade_maior_zero: (data?.quantidade_reprovacoes || 0) > 0,
                        historico_nao_vazio: Array.isArray(data?.historico_reprovacoes) && data.historico_reprovacoes.length > 0,
                        tem_motivo: !!data?.motivo_reprovacao
                    }
                });
                
                return data;
            } catch (error) {
                console.error('‚ùå Erro completo ao buscar motorista:', error);
                return null;
            }
        }

        async function carregarInfoMotorista(coletaId, motoristaId, anexos) {
            console.log('üîÑ Carregando informa√ß√µes do motorista:', { coletaId, motoristaId });
            
            const motoristaInfoDiv = document.getElementById(`motorista-info-${coletaId}`);
            
            if (!motoristaInfoDiv) {
                console.warn('‚ö†Ô∏è Elemento motorista-info n√£o encontrado para coleta:', coletaId);
                return;
            }
            
            // Limpar conte√∫do anterior antes de adicionar novo para evitar duplica√ß√£o
            motoristaInfoDiv.innerHTML = '';
            
            // Buscar informa√ß√µes da coleta para verificar a etapa atual
            const coleta = coletasData.find(c => c.id === coletaId);
            const isEtapaGR = coleta && coleta.etapa_atual === 'gr';
            
            const motorista = await buscarMotoristaPorId(motoristaId);
            
            if (!motorista) {
                console.error('‚ùå Motorista n√£o encontrado:', motoristaId);
                motoristaInfoDiv.innerHTML = '<span style="color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> Erro ao carregar motorista</span>';
                return;
            }
            
            // Verificar status completo do motorista para esta coleta
            const statusInfo = verificarStatusMotoristaPorColeta(motorista, coleta);
            const statusMotorista = statusInfo.status; // 'neutro', 'aprovado', 'reprovado'
            const isReprovado = statusMotorista === 'reprovado';
            const isAprovado = statusMotorista === 'aprovado';
            const isNeutro = statusMotorista === 'neutro';
            
            console.log('üìä Status do motorista (por coleta):', { 
                coleta_id: coletaId,
                etapa_atual: coleta?.etapa_atual,
                gr_aprovado: coleta?.gr_aprovado,
                nome: motorista.nome, 
                status: statusMotorista,
                motivo: statusInfo.motivo?.substring(0, 30)
            });
            
            // Determinar visual e tag baseado no status
            let cardBackground, cardBorder, cardBorderWidth, cardBoxShadow, tagStatus;
            
            if (isReprovado) {
                cardBackground = 'linear-gradient(135deg, rgba(220, 53, 69, 0.2) 0%, rgba(200, 35, 51, 0.25) 100%)';
                cardBorder = '#dc3545';
                cardBorderWidth = '3px';
                cardBoxShadow = '0 4px 12px rgba(220, 53, 69, 0.3), 0 0 0 1px rgba(220, 53, 69, 0.2)';
                tagStatus = coleta && coleta.etapa_atual === 'contratacao' ? 'REPROVADO NO GR' : 'MOTORISTA REPROVADO';
            } else if (isAprovado) {
                cardBackground = 'linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(32, 201, 151, 0.1) 100%)';
                cardBorder = '#28a745';
                cardBorderWidth = '2px';
                cardBoxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
                tagStatus = 'APROVADO NO GR';
            } else {
                // Status neutro (pendente de an√°lise GR)
                cardBackground = 'linear-gradient(135deg, rgba(108, 117, 125, 0.1) 0%, rgba(134, 142, 150, 0.1) 100%)';
                cardBorder = '#6c757d';
                cardBorderWidth = '2px';
                cardBoxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
                tagStatus = 'PENDENTE DE AN√ÅLISE GR';
            }
            
                motoristaInfoDiv.innerHTML = `
                    <div style="padding: 1rem; background: ${cardBackground}; border: ${cardBorderWidth} solid ${cardBorder}; border-radius: 10px; box-shadow: ${cardBoxShadow}; width: 100%;">
                        <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; width: 100%;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <strong style="color: ${isReprovado ? '#dc3545' : '#1f2937'}; font-size: 1.1rem;">${motorista.nome}</strong>
                                    ${isReprovado ? `
                                        <span style="background: #dc3545; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 2px 6px rgba(220, 53, 69, 0.4);">
                                            <i class="fas fa-times-circle"></i> ${tagReprovacao}
                                        </span>
                                    ` : `
                                        <span style="background: #28a745; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
                                            <i class="fas fa-check-circle"></i> APROVADO
                                        </span>
                                    `}
                                </div>
                                ${isReprovado && reprovacaoInfo.motivo ? `
                                    <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(220, 53, 69, 0.15); border-left: 4px solid #dc3545; border-radius: 6px;">
                                        <div style="color: #dc3545; font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <i class="fas fa-info-circle"></i> Motivo da Reprova√ß√£o
                                        </div>
                                        <div style="color: #721c24; font-size: 0.85rem; line-height: 1.5;">
                                            ${statusInfo.motivo.length > 100 ? statusInfo.motivo.substring(0, 100) + '...' : statusInfo.motivo}
                                        </div>
                                        ${statusInfo.reprovado_por && statusInfo.data_reprovacao ? `
                                            <div style="color: #6c757d; font-size: 0.75rem; margin-top: 0.5rem; font-style: italic;">
                                                Por ${escapeHtml(statusInfo.reprovado_por)} em ${new Date(statusInfo.data_reprovacao).toLocaleDateString('pt-BR')} √†s ${new Date(statusInfo.data_reprovacao).toLocaleTimeString('pt-BR')}
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : ''}
                            <div style="font-size: 0.85rem; color: #6c757d; margin-top: 0.3rem;">
                                <span><i class="fas fa-id-badge"></i> CNH: ${motorista.cnh || 'N/A'}</span>
                                ${motorista.classe_veiculo ? `<span style="margin-left: 1rem;"><i class="fas fa-car"></i> ${motorista.classe_veiculo}</span>` : ''}
                            </div>
                            <div style="font-size: 0.85rem; color: #6c757d; margin-top: 0.3rem;">
                                <span><i class="fas fa-car"></i> ${motorista.categoria_cnh || 'N/A'}</span>
                                <span style="margin-left: 1rem;"><i class="fas fa-phone"></i> ${motorista.telefone1 || 'N/A'}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                        ${anexos && anexos.length > 0 ? `
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.5rem 1rem; border-radius: 10px; font-size: 0.85rem; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
                                <i class="fas fa-paperclip"></i> ${anexos.length} Documento(s)
                            </div>
                        ` : ''}
                            ${isReprovado ? `
                                <button onclick="event.stopPropagation(); trocarMotorista('${coletaId}')" 
                                        style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: white; border: none; padding: 0.5rem 1rem; border-radius: 10px; font-size: 0.85rem; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3); transition: transform 0.2s;"
                                        onmouseover="this.style.transform='scale(1.05)'" 
                                        onmouseout="this.style.transform='scale(1)'"
                                        title="Trocar Motorista">
                                    <i class="fas fa-exchange-alt"></i> Trocar
                                </button>
                            ` : isEtapaGR ? `
                                <button onclick="event.stopPropagation(); reprovarMotorista('${coletaId}', '${motoristaId}')" 
                                        style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; padding: 0.5rem 1rem; border-radius: 10px; font-size: 0.85rem; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3); transition: transform 0.2s;"
                                        onmouseover="this.style.transform='scale(1.05)'" 
                                        onmouseout="this.style.transform='scale(1)'"
                                        title="Reprovar Motorista (Apenas na etapa GR)">
                                    <i class="fas fa-times-circle"></i> Reprovar
                                </button>
                                <button onclick="event.stopPropagation(); trocarMotorista('${coletaId}')" 
                                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.5rem 1rem; border-radius: 10px; font-size: 0.85rem; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); transition: transform 0.2s;"
                                        onmouseover="this.style.transform='scale(1.05)'" 
                                        onmouseout="this.style.transform='scale(1)'"
                                        title="Trocar Motorista">
                                    <i class="fas fa-exchange-alt"></i> Trocar
                                </button>
                            ` : `
                                <button onclick="event.stopPropagation(); trocarMotorista('${coletaId}')" 
                                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.5rem 1rem; border-radius: 10px; font-size: 0.85rem; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); transition: transform 0.2s;"
                                        onmouseover="this.style.transform='scale(1.05)'" 
                                        onmouseout="this.style.transform='scale(1)'"
                                        title="Trocar Motorista">
                                    <i class="fas fa-exchange-alt"></i> Trocar
                                </button>
                            `}
                        </div>
                    </div>
                `;
            
            // Atualizar o card do motorista com a cor correta
            const motoristaCard = document.getElementById(`motorista-card-wrapper-${coletaId}`);
            const motoristaLabel = document.getElementById(`motorista-label-${coletaId}`);
            
            if (motoristaCard) {
                motoristaCard.style.background = cardBackground;
                motoristaCard.style.borderColor = cardBorder;
                
                // Atualizar sombra e hover para motoristas reprovados
                if (isReprovado) {
                    motoristaCard.setAttribute('onmouseover', 'this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 4px 12px rgba(220, 53, 69, 0.3)\';');
                } else {
                    motoristaCard.setAttribute('onmouseover', 'this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 4px 12px rgba(40, 167, 69, 0.3)\';');
                }
            }
            
            // Atualizar o t√≠tulo do card se motorista estiver reprovado
            if (motoristaLabel) {
                if (isReprovado) {
                    motoristaLabel.style.color = '#dc3545';
                    const labelSpan = motoristaLabel.querySelector('span');
                    if (labelSpan) {
                        labelSpan.innerHTML = '<i class="fas fa-user-times"></i> Motorista Reprovado';
                    }
                } else {
                    motoristaLabel.style.color = '#28a745';
                    const labelSpan = motoristaLabel.querySelector('span');
                    if (labelSpan) {
                        labelSpan.innerHTML = '<i class="fas fa-user-check"></i> Motorista Vinculado';
                    }
                }
            }
            
            console.log('‚úÖ Informa√ß√µes do motorista carregadas com sucesso');
        }

        window.solicitarAtivacaoLocalizacao = async function(coletaId) {
            try {
                const coleta = coletasData.find(c => c.id === coletaId);
                if (!coleta || !coleta.motorista_id) {
                    showNotification('‚ö†Ô∏è √â necess√°rio ter motorista vinculado para solicitar ativa√ß√£o de localiza√ß√£o.', 'warning');
                    return;
                }

                const confirmar = confirm(
                    `üìç Solicitar Ativa√ß√£o de Localiza√ß√£o GPS\n\n` +
                    `Voc√™ est√° prestes a solicitar ao motorista que ative a localiza√ß√£o GPS para esta coleta.\n\n` +
                    `O motorista receber√° uma notifica√ß√£o e poder√° ativar a localiza√ß√£o diretamente pelo portal.\n\n` +
                    `Deseja continuar?`
                );

                if (!confirmar) {
                    return;
                }

                // Obter nome do usu√°rio atual
                const usuario = currentUser?.nome || currentUser?.email || 'Sistema';

                // Fazer solicita√ß√£o via API
                const headers = await getSupabaseAuthHeaders();
                
                const response = await fetch(`/api/coletas/${coletaId}/solicitar-ativacao-localizacao`, {
                    method: 'POST',
                    headers: {
                        ...headers,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        motivo: 'Solicita√ß√£o de ativa√ß√£o de localiza√ß√£o GPS para rastreamento em tempo real'
                    })
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Erro ao criar solicita√ß√£o');
                }

                showNotification('‚úÖ Solicita√ß√£o de ativa√ß√£o de localiza√ß√£o enviada ao motorista com sucesso!', 'success');

            } catch (error) {
                console.error('‚ùå Erro ao solicitar ativa√ß√£o de localiza√ß√£o:', error);
                showNotification('Erro ao enviar solicita√ß√£o: ' + (error.message || 'Erro desconhecido'), 'error');
            }
        }

        async function verDetalhesMotorista(coletaId) {
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta || !coleta.motorista_id) return;
            
            const motorista = await buscarMotoristaPorId(coleta.motorista_id);
            if (!motorista) return;
            
            const anexos = await carregarAnexos(coletaId);
            const isEtapaGR = coleta && coleta.etapa_atual === 'gr';
            
            // Criar modal com detalhes do motorista
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; z-index: 10001; padding: 2rem;';
            modal.innerHTML = `
                <div class="modal-dialog" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%); backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-content" style="padding: 2rem;">
                        <div class="modal-header" style="margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 2px solid #e9ecef; display: flex; justify-content: space-between; align-items: center;">
                            <h5 class="modal-title" style="font-size: 1.5rem; font-weight: 700; color: #28a745; display: flex; align-items: center; gap: 0.7rem;">
                                <i class="fas fa-user-tie"></i>
                                Detalhes do Motorista
                            </h5>
                            <button class="btn-close" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        
                        <!-- Informa√ß√µes do Motorista -->
                        <div style="background: ${motorista.reprovado ? 'linear-gradient(135deg, rgba(220, 53, 69, 0.1) 0%, rgba(200, 35, 51, 0.1) 100%)' : 'linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(32, 201, 151, 0.1) 100%)'}; padding: 1.5rem; border-radius: 15px; margin-bottom: 2rem; border: 1px solid ${motorista.reprovado ? '#dc3545' : '#28a745'};">
                            ${motorista.reprovado || (motorista.quantidade_reprovacoes && motorista.quantidade_reprovacoes > 0) ? `
                                <div style="background: rgba(220, 53, 69, 0.2); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem; border-left: 4px solid #dc3545;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; color: #dc3545; font-weight: 700; font-size: 1rem; margin-bottom: 0.5rem;">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        Motorista Reprovado
                                        ${motorista.quantidade_reprovacoes ? `
                                            <span style="background: #dc3545; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.85rem; margin-left: 0.5rem;">
                                                ${motorista.quantidade_reprovacoes} ${motorista.quantidade_reprovacoes === 1 ? 'reprova√ß√£o' : 'reprova√ß√µes'}
                                            </span>
                                        ` : ''}
                                    </div>
                                    ${motorista.motivo_reprovacao ? `
                                        <div style="color: #721c24; font-size: 0.9rem; margin-bottom: 0.5rem; font-style: italic; background: white; padding: 0.8rem; border-radius: 8px;">
                                            <strong>√öltimo Motivo:</strong> ${escapeHtml(motorista.motivo_reprovacao)}
                                        </div>
                                    ` : ''}
                                    <div style="color: #6c757d; font-size: 0.85rem;">
                                        ${motorista.reprovado_por ? `<span><i class="fas fa-user"></i> √öltima reprova√ß√£o por: ${escapeHtml(motorista.reprovado_por)}</span>` : ''}
                                        ${motorista.data_reprovacao ? `<span style="margin-left: 1rem;"><i class="fas fa-calendar"></i> ${new Date(motorista.data_reprovacao).toLocaleDateString('pt-BR')} √†s ${new Date(motorista.data_reprovacao).toLocaleTimeString('pt-BR')}</span>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div>
                                    <strong style="color: ${motorista.reprovado ? '#dc3545' : '#28a745'}; font-size: 0.9rem;">Nome Completo</strong>
                                    <div style="font-size: 1.1rem; margin-top: 0.5rem;">${motorista.nome}</div>
                                </div>
                                <div>
                                    <strong style="color: ${motorista.reprovado ? '#dc3545' : '#28a745'}; font-size: 0.9rem;">CNH</strong>
                                    <div style="font-size: 1.1rem; margin-top: 0.5rem;">${motorista.cnh || 'N/A'}</div>
                                </div>
                                ${motorista.classe_veiculo ? `
                                <div>
                                    <strong style="color: ${motorista.reprovado ? '#dc3545' : '#28a745'}; font-size: 0.9rem;">Classe Ve√≠culo</strong>
                                    <div style="font-size: 1.1rem; margin-top: 0.5rem;">${motorista.classe_veiculo}</div>
                                </div>
                                ` : ''}
                                <div>
                                    <strong style="color: ${motorista.reprovado ? '#dc3545' : '#28a745'}; font-size: 0.9rem;">Categoria</strong>
                                    <div style="font-size: 1.1rem; margin-top: 0.5rem;">${motorista.categoria_cnh || 'N/A'}</div>
                                </div>
                                <div>
                                    <strong style="color: ${motorista.reprovado ? '#dc3545' : '#28a745'}; font-size: 0.9rem;">Telefone</strong>
                                    <div style="font-size: 1.1rem; margin-top: 0.5rem;">${motorista.telefone1 || motorista.telefone2 || 'N/A'}</div>
                                </div>
                                <div>
                                    <strong style="color: ${motorista.reprovado ? '#dc3545' : '#28a745'}; font-size: 0.9rem;">Estado</strong>
                                    <div style="font-size: 1.1rem; margin-top: 0.5rem;">${motorista.estado || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Hist√≥rico de Reprova√ß√µes -->
                        ${motorista.quantidade_reprovacoes && motorista.quantidade_reprovacoes > 0 ? `
                            <div style="margin-bottom: 1.5rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h6 style="font-size: 1.1rem; font-weight: 700; color: #dc3545; display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="fas fa-history"></i>
                                        Hist√≥rico de Reprova√ß√µes (${motorista.quantidade_reprovacoes})
                                    </h6>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0.8rem; max-height: 400px; overflow-y: auto;">
                                    ${(motorista.historico_reprovacoes && Array.isArray(motorista.historico_reprovacoes) ? motorista.historico_reprovacoes : []).map((reprovacao, index) => `
                                        <div style="background: rgba(220, 53, 69, 0.1); padding: 1rem; border-radius: 10px; border-left: 4px solid #dc3545; border: 1px solid rgba(220, 53, 69, 0.3);">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                                <div style="color: #dc3545; font-weight: 600; font-size: 0.9rem;">
                                                    <i class="fas fa-times-circle"></i> Reprova√ß√£o #${index + 1}
                                                </div>
                                                <div style="color: #6c757d; font-size: 0.85rem;">
                                                    ${reprovacao.data_reprovacao ? new Date(reprovacao.data_reprovacao).toLocaleDateString('pt-BR') + ' √†s ' + new Date(reprovacao.data_reprovacao).toLocaleTimeString('pt-BR') : 'Data n√£o informada'}
                                                </div>
                                            </div>
                                            ${reprovacao.motivo ? `
                                                <div style="color: #333; font-size: 0.9rem; margin-bottom: 0.5rem; background: white; padding: 0.75rem; border-radius: 6px;">
                                                    <strong>Motivo:</strong> ${escapeHtml(reprovacao.motivo)}
                                                </div>
                                            ` : ''}
                                            <div style="display: flex; gap: 1rem; flex-wrap: wrap; color: #6c757d; font-size: 0.85rem;">
                                                ${reprovacao.reprovado_por ? `
                                                    <span><i class="fas fa-user"></i> Por: ${escapeHtml(reprovacao.reprovado_por)}</span>
                                                ` : ''}
                                                ${reprovacao.coleta_id ? `
                                                    <span><i class="fas fa-box"></i> Coleta: ${reprovacao.coleta_id.substring(0, 8)}...</span>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Documentos Anexados -->
                        <div style="margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h6 style="font-size: 1.1rem; font-weight: 700; color: #333; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-paperclip"></i>
                                    Documentos Anexados (${anexos?.length || 0})
                                </h6>
                                <button class="btn btn-primary" onclick="event.stopPropagation(); abrirModalAnexos('${coletaId}')" style="padding: 0.5rem 1rem; font-size: 0.85rem;">
                                    <i class="fas fa-plus"></i> Adicionar
                                </button>
                            </div>
                            ${anexos && anexos.length > 0 ? `
                                <div style="display: flex; flex-direction: column; gap: 0.8rem; max-height: 400px; overflow-y: auto;">
                                    ${anexos.map(anexo => `
                                        <div style="background: white; padding: 1rem; border-radius: 10px; border: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                                            <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white;">
                                                    <i class="fas ${getFileIcon(anexo.tipo_arquivo)}"></i>
                                                </div>
                                                <div>
                                                    <div style="font-weight: 600; color: #333;">${anexo.nome_arquivo}</div>
                                                    <div style="font-size: 0.85rem; color: #6c757d;">${formatFileSize(anexo.tamanho)} ‚Ä¢ ${anexo.tipo_arquivo || 'N/A'}</div>
                                                </div>
                                            </div>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button class="btn btn-sm btn-info" onclick="event.stopPropagation(); visualizarAnexo('${anexo.id}')" title="Visualizar">
                                    <i class="fas fa-eye"></i>
                                </button>
                                                <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); downloadAnexoDireto('${anexo.id}')" title="Baixar">
                                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div style="text-align: center; padding: 2rem; background: #f8f9fa; border-radius: 10px; color: #6c757d;">
                                    <i class="fas fa-file-alt" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                                    <p>Nenhum documento anexado ainda</p>
                                </div>
                            `}
                        </div>
                        
                        <div class="modal-footer" style="padding-top: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; gap: 1rem; flex-wrap: wrap;">
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="event.stopPropagation(); solicitarAtivacaoLocalizacao('${coletaId}'); this.closest('.modal').remove();" style="padding: 0.75rem 1.5rem; border-radius: 10px; border: none; font-weight: 600; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                    <i class="fas fa-map-marker-alt me-2"></i>
                                    Solicitar Localiza√ß√£o GPS
                                </button>
                                <button class="btn btn-warning" onclick="event.stopPropagation(); trocarMotorista('${coletaId}')" style="padding: 0.75rem 1.5rem; border-radius: 10px; border: none; font-weight: 600;">
                                    <i class="fas fa-exchange-alt"></i> Trocar Motorista
                                </button>
                                ${!motorista.reprovado && isEtapaGR ? `
                                    <button class="btn btn-danger" onclick="event.stopPropagation(); reprovarMotorista('${coletaId}', '${motorista.id}')" style="padding: 0.75rem 1.5rem; border-radius: 10px; border: none; font-weight: 600; margin-left: 0.5rem;">
                                        <i class="fas fa-times-circle"></i> Reprovar Motorista
                                    </button>
                                ` : ''}
                            </div>
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()" style="padding: 0.75rem 1.5rem; border-radius: 10px; border: none; font-weight: 600;">Fechar</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            
            // Fechar modal ao clicar no backdrop
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        async function reprovarMotorista(coletaId, motoristaId) {
            console.log('üîÑ Fun√ß√£o reprovarMotorista chamada:', { coletaId, motoristaId });
            
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta) {
                console.error('‚ùå Coleta n√£o encontrada:', coletaId);
                showNotification('Coleta n√£o encontrada', 'error');
                return;
            }
            
            // Verificar se est√° na etapa GR
            if (coleta.etapa_atual !== 'gr') {
                console.error('‚ùå A reprova√ß√£o do motorista s√≥ pode ser feita na etapa GR');
                showNotification('A reprova√ß√£o do motorista s√≥ pode ser feita na etapa GR', 'warning');
                return;
            }
            
            if (!motoristaId) {
                console.error('‚ùå Motorista ID n√£o fornecido');
                showNotification('ID do motorista n√£o fornecido', 'error');
                return;
            }
            
            try {
                // Criar modal para motivo da reprova√ß√£o
                const modal = document.createElement('div');
                modal.className = 'modal fade show';
                modal.id = 'modalReprovarMotorista';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; z-index: 10001; padding: 2rem;';
                modal.innerHTML = `
                    <div class="modal-dialog" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%); backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); max-width: 600px; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
                        <div class="modal-content" style="padding: 0; background: transparent;">
                            <div class="modal-header" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; padding: 1.5rem; border-radius: 20px 20px 0 0;">
                                <h5 class="modal-title" style="margin: 0; font-size: 1.5rem; font-weight: 600;"><i class="fas fa-exclamation-triangle"></i> Reprovar Motorista</h5>
                                <button type="button" class="btn-close" style="filter: invert(1); opacity: 0.9; font-size: 1.5rem;" onclick="this.closest('.modal').remove()"></button>
                            </div>
                            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 2rem;">
                                <p style="margin-bottom: 1rem; color: #333; font-size: 1rem;">Informe o motivo da reprova√ß√£o do motorista:</p>
                                <textarea id="motivoReprovacaoMotorista" class="form-control" rows="6" placeholder="Digite o motivo da reprova√ß√£o do motorista..." required style="width: 100%; padding: 1rem; border: 2px solid #e9ecef; border-radius: 10px; font-size: 1rem; resize: vertical; min-height: 120px;"></textarea>
                            </div>
                            <div class="modal-footer" style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: flex-end; gap: 1rem; border-radius: 0 0 20px 20px;">
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()" style="padding: 0.75rem 2rem; border-radius: 10px; border: none; font-weight: 600;">Cancelar</button>
                                <button type="button" class="btn btn-danger" onclick="confirmarReprovarMotorista('${coletaId}', '${motoristaId}')" style="padding: 0.75rem 2rem; border-radius: 10px; border: none; font-weight: 600; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                                    <i class="fas fa-times"></i> Reprovar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Fechar modal ao clicar no backdrop
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        delete window.confirmarReprovarMotorista;
                    }
                });

                // Adicionar fun√ß√£o global tempor√°ria
                window.confirmarReprovarMotorista = async (coletaIdParam, motoristaIdParam) => {
                    const motivo = document.getElementById('motivoReprovacaoMotorista').value.trim();
                    if (!motivo) {
                        showNotification('Por favor, informe o motivo da reprova√ß√£o.', 'warning');
                        return;
                    }

                    try {
                        const userData = JSON.parse(localStorage.getItem('loggedInUser'));
                        const usuarioNome = currentUser?.nome || currentUser?.username || userData?.email || 'Sistema';

                        console.log('üîÑ Iniciando reprova√ß√£o de motorista:', {
                            coletaId: coletaIdParam,
                            motoristaId: motoristaIdParam,
                            motivo: motivo,
                            usuarioNome: usuarioNome
                        });

                        // Usar API do servidor para reprovar motorista (usa service key, ignora RLS)
                        const response = await fetch('/api/motoristas/reprovar', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                motoristaId: motoristaIdParam,
                                coletaId: coletaIdParam,
                                motivo: motivo,
                                usuarioNome: usuarioNome
                            })
                        });

                        const result = await response.json();

                        if (!response.ok || !result.success) {
                            console.error('‚ùå Erro na resposta da API:', {
                                status: response.status,
                                statusText: response.statusText,
                                result: result
                            });
                            throw new Error(result.error || `Erro HTTP: ${response.status}`);
                        }

                        console.log('‚úÖ Motorista reprovado via API:', result);
                        console.log('‚úÖ Dados do motorista atualizado:', result.data);
                        
                        // Verificar se os dados foram realmente atualizados
                        if (result.data && result.data.length > 0) {
                            const motoristaAtualizado = result.data[0];
                            console.log('‚úÖ Confirma√ß√£o de atualiza√ß√£o:', {
                                reprovado: motoristaAtualizado.reprovado,
                                quantidade_reprovacoes: motoristaAtualizado.quantidade_reprovacoes,
                                motivo: motoristaAtualizado.motivo_reprovacao
                            });
                        } else {
                            console.warn('‚ö†Ô∏è API retornou sucesso mas sem dados do motorista atualizado');
                        }

                        // ‚úÖ IMPORTANTE: Voltar coleta para etapa de Contrata√ß√£o ap√≥s reprovar motorista
                        try {
                            const { error: updateError } = await supabaseClient
                                .from('coletas')
                                .update({
                                    etapa_atual: 'contratacao',
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', coletaIdParam);

                            if (updateError) {
                                console.error('‚ùå Erro ao voltar coleta para contrata√ß√£o:', updateError);
                            } else {
                                console.log('‚úÖ Coleta voltou para etapa de Contrata√ß√£o');
                            }
                        } catch (errorEtapa) {
                            console.error('‚ùå Erro ao atualizar etapa da coleta:', errorEtapa);
                        }

                        // Salvar no hist√≥rico da coleta
                        try {
                            await salvarNoHistorico(coletaIdParam, 'Motorista Reprovado', 
                                `Motorista ${motoristaIdParam} reprovado por ${usuarioNome}. Motivo: ${motivo}. Coleta voltou para etapa de Contrata√ß√£o.`
                            );
                            console.log('‚úÖ Hist√≥rico salvo');
                        } catch (errorHist) {
                            console.warn('‚ö†Ô∏è Erro ao salvar hist√≥rico (n√£o cr√≠tico):', errorHist);
                        }

                        showNotification('‚ö†Ô∏è Motorista reprovado! A coleta voltou para etapa de Contrata√ß√£o. √â necess√°rio trocar o motorista.', 'warning');
                        
                        // Fechar todos os modais abertos
                        document.querySelectorAll('.modal').forEach(m => m.remove());
                        delete window.confirmarReprovarMotorista;
                        
                        // ‚úÖ IMPORTANTE: Invalidar cache e for√ßar recarregamento dos dados do motorista
                        // Limpar qualquer cache do motorista completamente
                        if (window.motoristaCache) {
                            delete window.motoristaCache[coleta.motorista_id];
                            delete window.motoristaCache[motoristaIdParam];
                            console.log('üóëÔ∏è Cache do motorista limpo:', { coleta_motorista_id: coleta.motorista_id, motoristaIdParam });
                        }
                        
                        // Recarregar coletas primeiro para atualizar a interface
                        await carregarColetas();
                        
                        // Aguardar mais tempo para garantir que o Supabase processou completamente a atualiza√ß√£o
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        // Buscar motorista atualizado diretamente do Supabase SEM CACHE
                        // Usar uma query direta para garantir que pegamos os dados mais recentes
                        try {
                            console.log('üîÑ Buscando motorista diretamente do Supabase (sem cache)...');
                            const { data: motoristaDireto, error: errorDireto } = await supabaseClient
                                .from('motoristas')
                                .select('*')
                                .eq('id', motoristaIdParam)
                                .single();
                            
                            if (errorDireto) {
                                console.error('‚ùå Erro ao buscar motorista diretamente:', errorDireto);
                            } else if (motoristaDireto) {
                                console.log('‚úÖ Motorista encontrado diretamente do Supabase:', {
                                    id: motoristaDireto.id,
                                    nome: motoristaDireto.nome,
                                    reprovado: motoristaDireto.reprovado,
                                    reprovado_tipo: typeof motoristaDireto.reprovado,
                                    quantidade_reprovacoes: motoristaDireto.quantidade_reprovacoes,
                                    historico_length: Array.isArray(motoristaDireto.historico_reprovacoes) ? motoristaDireto.historico_reprovacoes.length : 'N/A',
                                    motivo_reprovacao: motoristaDireto.motivo_reprovacao
                                });
                                
                                // Atualizar cache com os dados mais recentes
                                if (window.motoristaCache) {
                                    window.motoristaCache[motoristaIdParam] = motoristaDireto;
                                }
                            }
                        } catch (err) {
                            console.error('‚ùå Erro ao buscar motorista diretamente:', err);
                        }
                        
                        // Recarregar informa√ß√µes do motorista usando a fun√ß√£o buscarMotoristaPorId
                        const coletaAtualizada = coletasData.find(c => c.id === coletaIdParam);
                        if (coletaAtualizada && coletaAtualizada.motorista_id) {
                            try {
                                // Buscar novamente usando a fun√ß√£o normal (agora deve pegar do cache atualizado ou do Supabase)
                                const motoristaRecarregado = await buscarMotoristaPorId(coletaAtualizada.motorista_id);
                                console.log('üîÑ Motorista recarregado ap√≥s reprova√ß√£o (via fun√ß√£o):', {
                                    id: motoristaRecarregado?.id,
                                    reprovado: motoristaRecarregado?.reprovado,
                                    reprovado_tipo: typeof motoristaRecarregado?.reprovado,
                                    quantidade_reprovacoes: motoristaRecarregado?.quantidade_reprovacoes,
                                    historico_length: Array.isArray(motoristaRecarregado?.historico_reprovacoes) ? motoristaRecarregado.historico_reprovacoes.length : 'N/A'
                                });
                                
                                if (motoristaRecarregado) {
                                    // Atualizar o card do motorista no Kanban
                                    await carregarInfoMotorista(coletaIdParam, coletaAtualizada.motorista_id, []);
                                }
                            } catch (err) {
                                console.error('‚ùå Erro ao recarregar motorista:', err);
                            }
                        }
                        
                        // Recarregar conte√∫do do drawer se estiver aberto - FOR√áAR RECARREGAMENTO COMPLETO
                        const drawer = document.getElementById('kanbanDrawer');
                        if (drawer && drawer.classList.contains('active')) {
                            console.log('üîÑ Recarregando drawer completo ap√≥s reprova√ß√£o...');
                            
                            // Fechar e reabrir o drawer para garantir recarregamento completo
                            drawer.classList.remove('active');
                            await new Promise(resolve => setTimeout(resolve, 300));
                            
                            // Reabrir o drawer com os dados atualizados
                            await abrirKanbanDrawer(coletaIdParam);
                            
                            // Aguardar um pouco e atualizar novamente o card do motorista
                            setTimeout(async () => {
                                const coletaAtualizada2 = coletasData.find(c => c.id === coletaIdParam);
                                if (coletaAtualizada2 && coletaAtualizada2.motorista_id) {
                                    console.log('üîÑ Atualizando card do motorista ap√≥s recarregar drawer...');
                                    await carregarInfoMotorista(coletaIdParam, coletaAtualizada2.motorista_id, []);
                                }
                            }, 500);
                        } else {
                            // Se o drawer n√£o estiver aberto, apenas atualizar o card do motorista no Kanban
                            const coletaAtualizada2 = coletasData.find(c => c.id === coletaIdParam);
                            if (coletaAtualizada2 && coletaAtualizada2.motorista_id) {
                                console.log('üîÑ Atualizando card do motorista no Kanban...');
                                await carregarInfoMotorista(coletaIdParam, coletaAtualizada2.motorista_id, []);
                            }
                        }
                        
                    } catch (error) {
                        console.error('‚ùå Erro completo ao reprovar motorista:', error);
                        console.error('Stack trace:', error.stack);
                        showNotification('Erro ao reprovar motorista: ' + (error.message || error), 'error');
                    }
                };
                
            } catch (error) {
                console.error('‚ùå Erro ao criar modal de reprova√ß√£o:', error);
                showNotification('Erro ao abrir modal de reprova√ß√£o: ' + error.message, 'error');
            }
        }

        async function trocarMotorista(coletaId) {
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta) return;

            // Fechar modal de detalhes se estiver aberto
            const modalDetalhes = document.querySelector('.modal.show');
            if (modalDetalhes) {
                modalDetalhes.remove();
            }

            // Abrir modal de sele√ß√£o de motorista
            await vincularMotorista(coletaId);
        }

        async function salvarMotorista(motoristaData) {
            try {
                // Verificar se o Supabase est√° inicializado
                if (!supabaseClient) {
                    console.error('‚ùå Supabase n√£o inicializado');
                    showNotification('Erro: Supabase n√£o inicializado', 'error');
                    return;
                }
                
                const { data, error } = await supabaseClient
                    .from('motoristas')
                    .insert([motoristaData]);

                if (error) throw error;
                
                showNotification('Motorista cadastrado com sucesso!', 'success');
                return data;
            } catch (error) {
                console.error('‚ùå Erro ao salvar motorista:', error);
                showNotification('Erro ao salvar motorista: ' + error.message, 'error');
                throw error;
            }
        }

        function openMotoristaModal(coletaId) {
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Cadastrar Novo Motorista</h5>
                            <button type="button" class="btn-close" onclick="fecharModalMotorista()"></button>
                        </div>
                        <div class="modal-body">
                            <form id="motoristaForm">
                                <div class="form-group">
                                    <label for="nome">Nome Completo *</label>
                                    <input type="text" class="form-control" id="nome" required>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="telefone">Telefone *</label>
                                            <input type="text" class="form-control" id="telefone" placeholder="Ex: (11) 99999-9999" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="cnh">CNH *</label>
                                            <input type="text" class="form-control" id="cnh" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="categoria">Categoria CNH *</label>
                                    <select class="form-control" id="categoria" required>
                                        <option value="">Selecione</option>
                                        <option value="A">A - Motocicleta</option>
                                        <option value="B">B - Carro</option>
                                        <option value="C">C - Caminh√£o</option>
                                        <option value="D">D - √înibus</option>
                                        <option value="E">E - Carreta</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="fecharModalMotorista()">Cancelar</button>
                            <button type="button" class="btn btn-primary" onclick="salvarNovoMotorista('${coletaId}')">Cadastrar</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function salvarNovoMotorista(coletaId) {
            try {
                const form = document.getElementById('motoristaForm');
                const formData = new FormData(form);
                
                const motoristaData = {
                    id: generateId(),
                    nome: document.getElementById('nome').value,
                    telefone1: document.getElementById('telefone').value,
                    cnh: document.getElementById('cnh').value,
                    categoria_cnh: document.getElementById('categoria').value,
                    status: 'ativo',
                    data_cadastro: new Date().toISOString(),
                    data_atualizacao: new Date().toISOString(),
                    usuario_id: currentUser?.id || null
                };

                // Validar campos obrigat√≥rios
                if (!motoristaData.nome || !motoristaData.telefone1 || 
                    !motoristaData.cnh || !motoristaData.categoria_cnh) {
                    showNotification('Preencha todos os campos obrigat√≥rios!', 'warning');
                    return;
                }

                await salvarMotorista(motoristaData);
                fecharModalMotorista();
                
                // Vincular automaticamente o motorista √† coleta
                await selecionarMotorista(coletaId, motoristaData.id);
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar novo motorista:', error);
            }
        }

        // ========== FUN√á√ïES SUPABASE - COLETAS ==========
        let coletasRealtimeChannel = null;
        
        function configurarRealtimeColetas() {
            if (!supabaseClient) {
                console.warn('‚ö†Ô∏è Supabase n√£o inicializado, pulando configura√ß√£o de realtime');
                return;
            }
            
            // Remover listener anterior se existir
            if (coletasRealtimeChannel) {
                supabaseClient.removeChannel(coletasRealtimeChannel);
            }
            
            // Configurar listener para mudan√ßas na tabela coletas
            coletasRealtimeChannel = supabaseClient
                .channel('coletas-changes')
                .on('postgres_changes', {
                    event: '*', // Escutar todos os eventos (INSERT, UPDATE, DELETE)
                    schema: 'public',
                    table: 'coletas'
                }, (payload) => {
                    console.log('üîÑ Mudan√ßa detectada na tabela coletas:', payload);
                    
                    // Se foi uma atualiza√ß√£o (UPDATE)
                    if (payload.eventType === 'UPDATE') {
                        const coletaAtualizada = payload.new;
                        const coletaAntiga = payload.old;
                        
                        // Verificar se o motorista_id foi alterado
                        if (coletaAtualizada.motorista_id !== coletaAntiga.motorista_id) {
                            console.log('üöó Motorista vinculado/desvinculado detectado:', {
                                coletaId: coletaAtualizada.id,
                                motoristaAntigo: coletaAntiga.motorista_id,
                                motoristaNovo: coletaAtualizada.motorista_id
                            });
                            
                            // Atualizar os dados locais
                            const index = coletasData.findIndex(c => c.id === coletaAtualizada.id);
                            if (index !== -1) {
                                // Atualizar o objeto na lista
                                coletasData[index] = { ...coletasData[index], ...coletaAtualizada };
                                
                                // Atualizar coletas ativas/arquivadas
                                if (!coletaAtualizada.arquivado) {
                                    const indexAtiva = window.coletasAtivas.findIndex(c => c.id === coletaAtualizada.id);
                                    if (indexAtiva !== -1) {
                                        window.coletasAtivas[indexAtiva] = { ...window.coletasAtivas[indexAtiva], ...coletaAtualizada };
                                    } else if (!coletaAtualizada.arquivado) {
                                        // Se n√£o estava nas ativas e n√£o est√° arquivada, adicionar
                                        window.coletasAtivas.push(coletaAtualizada);
                                    }
                                }
                                
                                // Re-renderizar apenas o card da coleta afetada
                                atualizarCardColeta(coletaAtualizada.id);
                            } else {
                                // Se n√£o encontrou, recarregar todas as coletas para evitar duplica√ß√µes
                                console.log('‚ö†Ô∏è Coleta n√£o encontrada localmente, recarregando todas...');
                                carregarColetas();
                            }
                        } else {
                            // Outra atualiza√ß√£o (n√£o relacionada a motorista)
                            // Atualizar apenas o card espec√≠fico
                            const index = coletasData.findIndex(c => c.id === coletaAtualizada.id);
                            if (index !== -1) {
                                coletasData[index] = { ...coletasData[index], ...coletaAtualizada };
                                
                                // Atualizar coletas ativas/arquivadas
                                if (!coletaAtualizada.arquivado) {
                                    const indexAtiva = window.coletasAtivas.findIndex(c => c.id === coletaAtualizada.id);
                                    if (indexAtiva !== -1) {
                                        window.coletasAtivas[indexAtiva] = { ...window.coletasAtivas[indexAtiva], ...coletaAtualizada };
                                    }
                                }
                                
                                atualizarCardColeta(coletaAtualizada.id);
                            }
                        }
                    } else if (payload.eventType === 'INSERT') {
                        // Nova coleta adicionada
                        console.log('‚ûï Nova coleta detectada, recarregando...');
                        carregarColetas();
                    } else if (payload.eventType === 'DELETE') {
                        // Coleta removida
                        console.log('‚ûñ Coleta removida, recarregando...');
                        carregarColetas();
                    }
                })
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        console.log('‚úÖ Listener de realtime configurado com sucesso');
                    } else if (status === 'CHANNEL_ERROR') {
                        console.error('‚ùå Erro no canal de realtime');
                    }
                });
        }
        
        async function atualizarCardColeta(coletaId) {
            try {
                // Buscar a coleta atualizada do banco
                const { data: coletaAtualizada, error } = await supabaseClient
                    .from('coletas')
                    .select('*')
                    .eq('id', coletaId)
                    .single();
                
                if (error) throw error;
                
                // Atualizar na lista local
                const index = coletasData.findIndex(c => c.id === coletaId);
                if (index !== -1) {
                    coletasData[index] = coletaAtualizada;
                }
                
                // Atualizar coletas ativas/arquivadas
                if (!coletaAtualizada.arquivado) {
                    const indexAtiva = window.coletasAtivas.findIndex(c => c.id === coletaId);
                    if (indexAtiva !== -1) {
                        window.coletasAtivas[indexAtiva] = coletaAtualizada;
                    }
                }
                
                // Encontrar o card existente (pode haver m√∫ltiplos se houver duplica√ß√£o)
                const grid = document.getElementById('coletasGrid');
                const cardsExistentes = grid.querySelectorAll(`[data-coleta-id="${coletaId}"]`);
                
                // Se houver m√∫ltiplos cards com o mesmo ID, remover os duplicados
                if (cardsExistentes.length > 1) {
                    console.warn('‚ö†Ô∏è Detectados m√∫ltiplos cards com o mesmo ID, removendo duplicados:', coletaId);
                    // Manter apenas o primeiro, remover os demais
                    for (let i = 1; i < cardsExistentes.length; i++) {
                        cardsExistentes[i].remove();
                    }
                }
                
                const cardExistente = cardsExistentes[0];
                
                if (cardExistente) {
                    // Se a coleta foi arquivada ou mudou de status de forma que n√£o deve mais aparecer, remover o card
                    if (coletaAtualizada.arquivado) {
                        console.log('üóëÔ∏è Coleta arquivada, removendo card:', coletaId);
                        cardExistente.remove();
                        updateStats(window.coletasAtivas || coletasData.filter(c => !c.arquivado));
                        return;
                    }
                    
                    // Verificar novamente se n√£o h√° duplicatas antes de substituir
                    const grid = document.getElementById('coletasGrid');
                    const todosCards = grid.querySelectorAll(`[data-coleta-id="${coletaId}"]`);
                    if (todosCards.length > 1) {
                        console.warn('‚ö†Ô∏è M√∫ltiplos cards detectados antes de atualizar, removendo duplicados:', coletaId);
                        // Manter apenas o primeiro, remover os demais
                        for (let i = 1; i < todosCards.length; i++) {
                            todosCards[i].remove();
                        }
                    }
                    
                    // Carregar anexos
                    coletaAtualizada.anexos = await carregarAnexos(coletaId);
                    
                    // Substituir o card
                    const novoCard = createColetaCard(coletaAtualizada);
                    novoCard.setAttribute('data-coleta-id', coletaId);
                    cardExistente.replaceWith(novoCard);
                    
                    // Verificar se n√£o foi criado um duplicado ap√≥s a substitui√ß√£o
                    const cardsAposSubstituicao = grid.querySelectorAll(`[data-coleta-id="${coletaId}"]`);
                    if (cardsAposSubstituicao.length > 1) {
                        console.warn('‚ö†Ô∏è Duplicata criada ap√≥s substitui√ß√£o, removendo:', coletaId);
                        for (let i = 1; i < cardsAposSubstituicao.length; i++) {
                            cardsAposSubstituicao[i].remove();
                        }
                    }
                    
                    // Carregar informa√ß√µes do motorista se houver vincula√ß√£o
                    if (coletaAtualizada.motorista_id) {
                        await carregarInfoMotorista(coletaId, coletaAtualizada.motorista_id, coletaAtualizada.anexos);
                    }
                } else {
                    // Se n√£o encontrou o card, verificar se n√£o est√° duplicado em outro lugar
                    const grid = document.getElementById('coletasGrid');
                    const cardsComMesmoId = grid.querySelectorAll(`[data-coleta-id="${coletaId}"]`);
                    if (cardsComMesmoId.length > 0) {
                        console.warn('‚ö†Ô∏è Card encontrado mas n√£o foi retornado pela query, recarregando todas as coletas...');
                        await carregarColetas();
                    } else {
                        // Se realmente n√£o existe, recarregar todas as coletas
                    console.log('‚ö†Ô∏è Card n√£o encontrado, recarregando todas as coletas...');
                    await carregarColetas();
                    }
                }
            } catch (error) {
                console.error('‚ùå Erro ao atualizar card da coleta:', error);
                // Em caso de erro, recarregar todas as coletas
                await carregarColetas();
            }
        }
        
        // Prote√ß√£o contra m√∫ltiplas chamadas simult√¢neas de carregarColetas
        let carregandoColetas = false;
        let timeoutCarregarColetas = null;
        
        async function carregarColetas() {
            // Limpar timeout anterior se existir
            if (timeoutCarregarColetas) {
                clearTimeout(timeoutCarregarColetas);
                timeoutCarregarColetas = null;
            }
            
            // Se j√° est√° carregando, agendar nova tentativa
            if (carregandoColetas) {
                console.log('‚è≥ Carregamento j√° em andamento, agendando nova tentativa...');
                timeoutCarregarColetas = setTimeout(() => {
                    carregarColetas();
                }, 300);
                return;
            }
            
            carregandoColetas = true;
            
            try {
                // Verificar se o Supabase est√° inicializado
                if (!supabaseClient) {
                    console.error('‚ùå Supabase n√£o inicializado');
                    showNotification('Erro: Supabase n√£o inicializado', 'error');
                    return;
                }
                
                // ‚úÖ MELHORIA UX: Mostrar skeletons durante carregamento
                const coletasGrid = document.getElementById('coletasGrid');
                if (coletasGrid && coletasGrid.children.length === 0) {
                    mostrarSkeletons('coletasGrid', 6);
                }
                
                showNotification('Carregando coletas...', 'info');
                
                // ‚úÖ OTIMIZA√á√ÉO: Selecionar apenas campos necess√°rios em vez de *
                // v2.0 - Campos corrigidos: removidos contas_pagar_adiantamento, contas_pagar_saldo, pendencia_saldo (n√£o existem na tabela)
                const { data, error } = await supabaseClient
                    .from('coletas')
                    .select('id, filial, numero_coleta, cliente, data_recebimento, data_entrega, origem, destino, valor, km, tipos_veiculo, tipos_carroceria, status, etapa_atual, observacoes, prioridade, motorista_id, etapas_concluidas, arquivado, resultado_final, data_finalizacao, created_at, updated_at, created_by, updated_by, data_atualizacao, gr_aprovado, gr_reprovado_por, gr_motivo_reprovacao, gr_data_reprovacao, contas_pagar_pago, contas_pagar_tipo, contas_pagar_data, contas_pagar_pago_por, diaria')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Remover duplicatas baseado no ID antes de atribuir
                const coletasUnicas = [];
                const idsVistos = new Set();
                (data || []).forEach(coleta => {
                    if (coleta && coleta.id && !idsVistos.has(coleta.id)) {
                        idsVistos.add(coleta.id);
                        coletasUnicas.push(coleta);
                    }
                });

                coletasData = coletasUnicas;
                console.log('üì¶ Coletas carregadas (ap√≥s remo√ß√£o de duplicatas):', coletasData.length);
                
                // Buscar contratos para cada coleta
                const headers = await getSupabaseAuthHeaders();
                for (const coleta of coletasData) {
                    try {
                        const response = await fetch(`/api/anexos/coleta/${encodeURIComponent(coleta.id)}`, {
                            credentials: 'include',
                            headers
                        });
                        if (response.ok) {
                            const result = await response.json();
                            const anexos = result?.anexos || [];
                            // Buscar primeiro contrato com t√≠tulo
                            const contrato = anexos.find(a => a.categoria === 'contratos' && a.titulo_contrato);
                            if (contrato) {
                                coleta.titulo_contrato = contrato.titulo_contrato;
                            }
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Erro ao buscar contratos para coleta:', coleta.id, error);
                    }
                }
                
                // Separar ativas e arquivadas
                window.coletasAtivas = coletasData.filter(c => !c.arquivado);
                window.coletasArquivadas = coletasData.filter(c => c.arquivado);
                
                console.log('üìä Coletas Ativas:', window.coletasAtivas.length);
                console.log('üìö Coletas Arquivadas:', window.coletasArquivadas.length);
                
                // ‚úÖ PRESERVAR FILTROS: Verificar se h√° filtros ativos e reaplic√°-los
                const temFiltrosAtivos = 
                    document.getElementById('statusFilter')?.value ||
                    document.getElementById('etapaFilter')?.value ||
                    document.getElementById('filialFilter')?.value ||
                    document.getElementById('searchFilter')?.value ||
                    document.getElementById('dataInicio')?.value ||
                    document.getElementById('dataFim')?.value;
                
                if (temFiltrosAtivos) {
                    console.log('üîç Filtros detectados, reaplicando ap√≥s carregamento...');
                    // Reaplicar filtros automaticamente
                    filterColetas();
                } else {
                    // Se n√£o h√° filtros, renderizar normalmente
                await renderColetasWrapper();
                updateStats();
                }
                
            } catch (error) {
                await handleError(error, 'carregarColetas');
            } finally {
                carregandoColetas = false;
            }
        }

        async function salvarColeta(coletaData) {
            try {
                // Verificar se o Supabase est√° inicializado
                if (!supabaseClient) {
                    console.error('‚ùå Supabase n√£o inicializado');
                    showNotification('Erro: Supabase n√£o inicializado', 'error');
                    return;
                }
                
                console.log('üì§ Dados recebidos para salvar:', coletaData);
                
                let data, error;
                
                if (currentEditingId) {
                    // ‚úÖ CAPTURAR DADOS ANTIGOS ANTES DE ATUALIZAR
                    // ‚úÖ OTIMIZA√á√ÉO: Selecionar apenas campos necess√°rios
                    const { data: dadosAntigos } = await supabaseClient
                        .from('coletas')
                        .select('id, filial, numero_coleta, cliente, data_recebimento, data_entrega, origem, destino, valor, frete_motorista, km, tipos_veiculo, tipos_carroceria, status, etapa_atual, observacoes, prioridade, motorista_id, etapas_concluidas, arquivado, contas_pagar_tipo, diaria')
                        .eq('id', currentEditingId)
                        .single();
                    
                    // ‚úÖ UPDATE - FILTRA apenas campos V√ÅLIDOS
                    const camposValidos = [
                        'filial', 'numero_coleta', 'cliente', 'data_recebimento', 'data_entrega', 'origem', 'destino',
                        'valor', 'frete_motorista', 'km', 'tipos_veiculo', 'tipos_carroceria', 'status', 'etapa_atual', 'observacoes',
                        'prioridade', 'motorista_id', 'etapas_concluidas', 'diaria'
                    ];
                    
                    const updateData = {};
                    camposValidos.forEach(campo => {
                        if (coletaData[campo] !== undefined) {
                            updateData[campo] = coletaData[campo];
                        }
                    });
                    
                    // Garante updated_at e updated_by
                    updateData.updated_at = new Date().toISOString();
                    updateData.updated_by = currentUser.id || null;
                    updateData.data_atualizacao = new Date().toISOString();
                    
                    console.log('üîÑ Dados filtrados para update:', updateData);
                    
                    ({ data, error } = await supabaseClient
                        .from('coletas')
                        .update(updateData)
                        .eq('id', currentEditingId)
                        .select());

                if (error) throw error;
                    
                    // ‚úÖ GERAR HIST√ìRICO DETALHADO DAS MUDAN√áAS
                    if (dadosAntigos) {
                        console.log('üìã Dados antigos:', dadosAntigos);
                        console.log('üìã Dados novos (updateData):', updateData);
                        const mudancas = compararDadosColeta(dadosAntigos, updateData);
                        console.log('üìã Mudan√ßas detectadas:', mudancas);
                        if (mudancas.length > 0) {
                            await salvarNoHistorico(currentEditingId, 'coleta_editada', mudancas);
                            console.log('‚úÖ Hist√≥rico detalhado salvo com sucesso');
                        } else {
                            console.log('‚ö†Ô∏è Nenhuma mudan√ßa detectada para salvar no hist√≥rico');
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Dados antigos n√£o encontrados, n√£o ser√° poss√≠vel gerar hist√≥rico detalhado');
                    }
                } else {
                    // ‚úÖ INSERT - j√° est√° funcionando
                    const novaColeta = {
                        id: generateId(),
                        ...coletaData,
                        created_by: currentUser.id || null,
                        updated_by: currentUser.id || null,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString(),
                        data_recebimento: coletaData.data_recebimento || new Date().toISOString(),
                        data_atualizacao: new Date().toISOString()
                    };
                    
                    ({ data, error } = await supabaseClient
                        .from('coletas')
                        .insert([novaColeta])
                        .select());
                }

                if (error) throw error;

                console.log('‚úÖ Sucesso:', data);
                showNotification(currentEditingId ? 'Coleta atualizada!' : 'Nova coleta criada!', 'success');
                
                // ‚úÖ HIST√ìRICO DENTRO DO TRY - DEPOIS DO SUCESSO
                // (Para updates, o hist√≥rico j√° foi salvo acima com detalhes)
                if (!currentEditingId) {
                    await salvarNoHistorico(data[0].id, 'coleta_criada', 'Nova coleta criada'); // usa o ID retornado
                }
                
                await carregarColetas();
                
                // Recarregar hist√≥rico se o card estiver expandido
                if (currentEditingId) {
                    const card = document.querySelector(`.coleta-card[data-coleta-id="${currentEditingId}"]`);
                    if (card && card.classList.contains('expanded')) {
                        setTimeout(() => {
                            carregarHistoricoParaCard(currentEditingId);
                        }, 500);
                    }
                }
                
                return data;
                
            } catch (error) {
                await handleError(error, 'salvarColeta');
                throw error;
            }
        }

        async function finalizarColeta(coletaId, resultado) {
            try {
                if (!supabaseClient) {
                    console.error('‚ùå Supabase n√£o inicializado');
                    showNotification('Erro: Supabase n√£o inicializado', 'error');
                    return;
                }

                const coleta = coletasData.find(c => c.id === coletaId);
                if (!coleta) return;

                const confirmacao = resultado === 'ganhou' 
                    ? confirm('üéâ Confirmar que esta coleta GANHOU?')
                    : confirm('‚ö†Ô∏è Confirmar que esta coleta PERDEU?');

                if (!confirmacao) return;

                // Atualizar status da coleta para arquivada
                const { error } = await supabaseClient
                    .from('coletas')
                    .update({
                        resultado_final: resultado,
                        data_finalizacao: new Date().toISOString(),
                        arquivado: true,
                        status: resultado === 'ganhou' ? 'concluida' : 'cancelada'
                    })
                    .eq('id', coletaId);

                if (error) throw error;

                // Salvar no hist√≥rico
                await salvarNoHistorico(coletaId, `Resultado: ${resultado.toUpperCase()}`, 
                    `Coleta ${resultado === 'ganhou' ? 'CONQUISTADA' : 'PERDIDA'} por ${currentUser.nome || currentUser.username}`);

                showNotification(
                    resultado === 'ganhou' 
                        ? 'üéâ Coleta Ganhou! Status arquivado com sucesso!' 
                        : '‚ö†Ô∏è Coleta Perdeu. Status arquivado com sucesso!', 
                    resultado === 'ganhou' ? 'success' : 'warning'
                );

                await carregarColetas();
                
            } catch (error) {
                console.error('‚ùå Erro ao finalizar coleta:', error);
                showNotification('Erro ao finalizar coleta: ' + error.message, 'error');
            }
        }

        async function marcarComoPago(coletaId, tipoPagamento) {
            try {
                if (!supabaseClient) {
                    console.error('‚ùå Supabase n√£o inicializado');
                    showNotification('Erro: Supabase n√£o inicializado', 'error');
                    return;
                }

                const coleta = coletasData.find(c => c.id === coletaId);
                if (!coleta) {
                    showNotification('Coleta n√£o encontrada', 'error');
                    return;
                }

                // üîê Verificar permiss√£o para a etapa contas_pagar
                if (!temPermissaoEtapa('contas_pagar')) {
                    showNotification('‚ö†Ô∏è Voc√™ n√£o tem permiss√£o para marcar como pago nesta etapa', 'warning');
                    // ‚úÖ SEGURAN√áA: Logs condicionais apenas em desenvolvimento
                    if (window.DEBUG || window.location.hostname === 'localhost') {
                    console.log('‚ùå Usu√°rio n√£o tem permiss√£o para etapa: contas_pagar');
                    }
                    return;
                }

                if (!coleta.motorista_id) {
                    showNotification('‚ö†Ô∏è √â necess√°rio ter um motorista vinculado para marcar como pago', 'warning');
                    return;
                }

                // Validar tipo de pagamento
                if (!tipoPagamento || !['adiantamento', 'saldo', 'pagamento_total'].includes(tipoPagamento)) {
                    showNotification('‚ö†Ô∏è Tipo de pagamento inv√°lido', 'warning');
                    return;
                }

                // Definir textos conforme o tipo de pagamento
                const tiposPagamento = {
                    'adiantamento': {
                        titulo: 'Adiantamento de Frete',
                        emoji: 'üíµ',
                        mensagemConfirmacao: 'üí∞ Confirmar que o ADIANTAMENTO DE FRETE foi realizado? O motorista e o criador da oportunidade ser√£o notificados.',
                        mensagemMotorista: (motorista, coleta) => `üíµ *ADIANTAMENTO DE FRETE REALIZADO*\n\nOl√° ${motorista.nome || 'Motorista'}!\n\nO adiantamento de frete da coleta *${coleta.cliente}* (${coleta.origem} ‚Üí ${coleta.destino}) foi marcado como realizado.\n\nValor: R$ ${(coleta.valor || 0).toFixed(2)}\n\nO saldo restante ser√° pago ap√≥s a conclus√£o da opera√ß√£o.\n\nObrigado pelo seu trabalho! üöö`,
                        mensagemCriador: (usuario) => `üíµ Adiantamento de frete marcado como realizado por ${usuario}`,
                        notificacaoSucesso: '‚úÖ Adiantamento de frete marcado como realizado! Motorista e criador da oportunidade foram notificados.'
                    },
                    'saldo': {
                        titulo: 'Saldo',
                        emoji: 'üí∞',
                        mensagemConfirmacao: 'üí∞ Confirmar que o SALDO foi pago? O motorista e o criador da oportunidade ser√£o notificados.',
                        mensagemMotorista: (motorista, coleta) => `üí∞ *SALDO PAGO*\n\nOl√° ${motorista.nome || 'Motorista'}!\n\nO saldo da coleta *${coleta.cliente}* (${coleta.origem} ‚Üí ${coleta.destino}) foi marcado como pago.\n\nValor: R$ ${(coleta.valor || 0).toFixed(2)}\n\nPagamento completo realizado! üéâ\n\nObrigado pelo seu trabalho! üöö`,
                        mensagemCriador: (usuario) => `üí∞ Saldo marcado como pago por ${usuario}`,
                        notificacaoSucesso: '‚úÖ Saldo marcado como pago! Motorista e criador da oportunidade foram notificados.'
                    },
                    'pagamento_total': {
                        titulo: 'Pagamento Total',
                        emoji: 'üí≥',
                        mensagemConfirmacao: 'üí≥ Confirmar que o PAGAMENTO TOTAL foi realizado? O motorista e o criador da oportunidade ser√£o notificados.',
                        mensagemMotorista: (motorista, coleta) => `üí≥ *PAGAMENTO TOTAL REALIZADO*\n\nOl√° ${motorista.nome || 'Motorista'}!\n\nO pagamento total da coleta *${coleta.cliente}* (${coleta.origem} ‚Üí ${coleta.destino}) foi marcado como realizado.\n\nValor Total: R$ ${(coleta.valor || 0).toFixed(2)}\n\nPagamento completo realizado de uma √∫nica vez! üéâ\n\nObrigado pelo seu trabalho! üöö`,
                        mensagemCriador: (usuario) => `üí≥ Pagamento total marcado como realizado por ${usuario}`,
                        notificacaoSucesso: '‚úÖ Pagamento total marcado como realizado! Motorista e criador da oportunidade foram notificados.'
                    }
                };

                const tipoInfo = tiposPagamento[tipoPagamento];

                const confirmacao = confirm(tipoInfo.mensagemConfirmacao);
                if (!confirmacao) return;

                // Buscar informa√ß√µes do motorista
                const motorista = await buscarMotoristaPorId(coleta.motorista_id);
                if (!motorista) {
                    showNotification('Erro ao buscar informa√ß√µes do motorista', 'error');
                    return;
                }

                // Buscar informa√ß√µes do criador da coleta
                let criadorNome = 'Usu√°rio';
                let criadorEmail = null;
                if (coleta.created_by) {
                    try {
                        const { data: userData, error: userError } = await supabaseClient
                            .from('user_profiles')
                            .select('nome, email')
                            .eq('id', coleta.created_by)
                            .single();
                        
                        if (!userError && userData) {
                            criadorNome = userData.nome || criadorNome;
                            criadorEmail = userData.email;
                        }
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Erro ao buscar criador da coleta:', error);
                    }
                }

                const usuarioNome = currentUser.nome || currentUser.username || currentUser.email;

                // Verificar se j√° existe um tipo de pagamento marcado anteriormente
                let tipoFinal = tipoPagamento;
                const tipoAtual = coleta.contas_pagar_tipo;
                
                // Se j√° existe um tipo e n√£o √© pagamento_total, combinar os tipos
                if (tipoAtual && tipoAtual !== tipoPagamento && tipoAtual !== 'pagamento_total' && tipoPagamento !== 'pagamento_total') {
                    // Combinar tipos: se j√° tem adiantamento e est√° marcando saldo, ou vice-versa
                    if ((tipoAtual === 'adiantamento' && tipoPagamento === 'saldo') || 
                        (tipoAtual === 'saldo' && tipoPagamento === 'adiantamento')) {
                        tipoFinal = 'ambos'; // Usar 'ambos' para indicar que adiantamento e saldo foram pagos
                    }
                }

                // Atualizar coleta como paga
                const { error: updateError } = await supabaseClient
                    .from('coletas')
                    .update({
                        contas_pagar_pago: true,
                        contas_pagar_data: new Date().toISOString(),
                        contas_pagar_pago_por: usuarioNome,
                        contas_pagar_tipo: tipoFinal,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', coletaId);

                if (updateError) throw updateError;

                // Salvar no hist√≥rico
                await salvarNoHistorico(coletaId, 'contas_pagar_pago', 
                    `${tipoInfo.titulo} marcado como realizado por ${usuarioNome}`
                );

                // Enviar mensagem para o motorista
                if (motorista.telefone1) {
                    try {
                        const mensagemMotorista = tipoInfo.mensagemMotorista(motorista, coleta);

                        const userData = localStorage.getItem('loggedInUser');
                        const user = userData ? JSON.parse(userData) : null;

                        const response = await fetch('/webhook/send-supabase', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                number: motorista.telefone1,
                                message: mensagemMotorista,
                                usuario: user?.email || currentUser?.email || 'sistema',
                                userId: user?.id || currentUser?.id || null
                            })
                        });

                        if (response.ok) {
                            console.log('‚úÖ Mensagem enviada para o motorista');
                        } else {
                            console.warn('‚ö†Ô∏è Erro ao enviar mensagem para o motorista:', await response.text());
                        }
                    } catch (error) {
                        console.error('‚ùå Erro ao enviar mensagem para o motorista:', error);
                        // N√£o bloquear o processo se falhar o envio
                    }
                }

                // Criar notifica√ß√£o para o criador da coleta (se for diferente do usu√°rio atual)
                if (coleta.created_by && coleta.created_by !== currentUser.id) {
                    try {
                        // Adicionar mensagem no chat da coleta para notificar o criador
                        await supabaseClient
                            .from('chat_mensagens')
                            .insert({
                                coleta_id: coletaId,
                                usuario: 'Sistema',
                                mensagem: tipoInfo.mensagemCriador(usuarioNome),
                                tipo: 'system',
                                tipo_mensagem: 'sistema'
                            });
                        
                        console.log('‚úÖ Notifica√ß√£o criada para o criador da coleta');
                    } catch (error) {
                        console.warn('‚ö†Ô∏è Erro ao criar notifica√ß√£o para o criador:', error);
                    }
                }

                // Mostrar notifica√ß√£o de sucesso para o usu√°rio atual
                showNotification(tipoInfo.notificacaoSucesso, 'success');

                // Recarregar coletas para atualizar a interface
                await carregarColetas();
                
            } catch (error) {
                console.error('‚ùå Erro ao marcar como pago:', error);
                showNotification('Erro ao marcar como pago: ' + error.message, 'error');
            }
        }

        // Fun√ß√£o para verificar e exibir notifica√ß√µes de pagamento para o criador
        async function verificarNotificacoesPagamento() {
            try {
                if (!supabaseClient || !currentUser) return;

                // Buscar coletas criadas pelo usu√°rio atual que foram marcadas como pagas recentemente
                const { data: coletasPagas, error } = await supabaseClient
                    .from('coletas')
                    .select('id, cliente, origem, destino, contas_pagar_pago, contas_pagar_data, contas_pagar_pago_por, contas_pagar_tipo, etapa_atual')
                    .eq('created_by', currentUser.id)
                    .eq('contas_pagar_pago', true)
                    .eq('etapa_atual', 'contas_pagar')
                    .order('contas_pagar_data', { ascending: false })
                    .limit(5);

                if (error) {
                    console.warn('‚ö†Ô∏è Erro ao verificar notifica√ß√µes de pagamento:', error);
                    return;
                }

                if (coletasPagas && coletasPagas.length > 0) {
                    // Verificar se j√° foi exibido um alerta para essas coletas
                    const ultimaNotificacao = localStorage.getItem('ultimaNotificacaoPagamento');
                    const coletasNovas = coletasPagas.filter(coleta => {
                        if (!ultimaNotificacao) return true;
                        const ultimaData = new Date(ultimaNotificacao);
                        const coletaData = new Date(coleta.contas_pagar_data);
                        return coletaData > ultimaData;
                    });

                    if (coletasNovas.length > 0) {
                        // Exibir alerta visual
                        const tipoPagamentoTexto = coletasNovas[0].contas_pagar_tipo === 'adiantamento' 
                            ? 'üíµ Adiantamento de Frete' 
                            : coletasNovas[0].contas_pagar_tipo === 'saldo' 
                            ? 'üí∞ Saldo' 
                            : coletasNovas[0].contas_pagar_tipo === 'pagamento_total'
                            ? 'üí≥ Pagamento Total'
                            : 'üí∞ Pagamento';
                        
                        const mensagem = coletasNovas.length === 1
                            ? `${tipoPagamentoTexto} realizado! A coleta "${coletasNovas[0].cliente}" (${coletasNovas[0].origem} ‚Üí ${coletasNovas[0].destino}) foi marcada como paga.`
                            : `üí∞ ${coletasNovas.length} coletas foram marcadas como pagas recentemente!`;

                        // Criar alerta visual destacado
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-success alert-dismissible fade show';
                        alertDiv.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 10001; max-width: 400px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
                        alertDiv.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <i class="fas fa-money-check-alt" style="font-size: 1.5rem; color: #28a745;"></i>
                                <div style="flex: 1;">
                                    <strong>${tipoPagamentoTexto} Realizado!</strong>
                                    <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">${mensagem}</p>
                                    ${coletasNovas.length === 1 ? `
                                        <small style="color: #6c757d;">Marcado por: ${coletasNovas[0].contas_pagar_pago_por || 'Sistema'}</small>
                                    ` : ''}
                                </div>
                                <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()" style="margin-left: 1rem;"></button>
                            </div>
                        `;
                        document.body.appendChild(alertDiv);

                        // Remover automaticamente ap√≥s 10 segundos
                        setTimeout(() => {
                            if (alertDiv.parentElement) {
                                alertDiv.remove();
                            }
                        }, 10000);

                        // Salvar √∫ltima notifica√ß√£o verificada
                        if (coletasNovas.length > 0) {
                            const maisRecente = coletasNovas.sort((a, b) => 
                                new Date(b.contas_pagar_data) - new Date(a.contas_pagar_data)
                            )[0];
                            localStorage.setItem('ultimaNotificacaoPagamento', maisRecente.contas_pagar_data);
                        }
                    }
                }
            } catch (error) {
                console.error('‚ùå Erro ao verificar notifica√ß√µes de pagamento:', error);
            }
        }

        async function excluirColeta(coletaId) {
            try {
                // üîê Verificar se o usu√°rio √© admin
                if (!currentUser || (!currentUser.isAdmin && currentUser.role !== 'admin')) {
                    showNotification('‚ö†Ô∏è Apenas administradores podem excluir oportunidades', 'warning');
                    return;
                }
                
                // Verificar se o Supabase est√° inicializado
                if (!supabaseClient) {
                    console.error('‚ùå Supabase n√£o inicializado');
                    showNotification('Erro: Supabase n√£o inicializado', 'error');
                    return;
                }

                if (!confirm('Tem certeza que deseja excluir esta coleta? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    return;
                }
                
                // Buscar dados da coleta antes de excluir para o hist√≥rico
                const coleta = coletasData.find(c => c.id === coletaId);
                let detalhesExclusao = 'Coleta exclu√≠da';
                if (coleta) {
                    detalhesExclusao = `Coleta exclu√≠da: ${coleta.filial || ''} ${coleta.numero_coleta || ''} - ${coleta.cliente || ''} (${coleta.origem || ''} ‚Üí ${coleta.destino || ''})`;
                }

                // Registrar no hist√≥rico ANTES de excluir (pois depois n√£o ter√° mais acesso aos dados)
                await salvarNoHistorico(coletaId, 'coleta_excluida', detalhesExclusao);
                
                const { error } = await supabaseClient
                    .from('coletas')
                    .delete()
                    .eq('id', coletaId);

                if (error) throw error;

                showNotification('Coleta exclu√≠da com sucesso', 'success');
                await carregarColetas();
                
            } catch (error) {
                console.error('‚ùå Erro ao excluir coleta:', error);
                showNotification('Erro ao excluir coleta: ' + error.message, 'error');
            }
        }

        // ========== FUN√á√ïES SUPABASE - ANEXOS ==========
        // Cache de anexos para evitar requisi√ß√µes duplicadas
        const anexosCache = new Map();
        const anexosCarregando = new Set();
        
        async function carregarAnexos(coletaId) {
            try {
                // Verificar cache primeiro
                if (anexosCache.has(coletaId)) {
                    return anexosCache.get(coletaId);
                }
                
                // Se j√° est√° carregando, aguardar
                if (anexosCarregando.has(coletaId)) {
                    // Aguardar at√© 5 segundos para a requisi√ß√£o anterior completar
                    let tentativas = 0;
                    while (anexosCarregando.has(coletaId) && tentativas < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        tentativas++;
                        if (anexosCache.has(coletaId)) {
                            return anexosCache.get(coletaId);
                        }
                    }
                }
                
                // Marcar como carregando
                anexosCarregando.add(coletaId);
                
                const headers = await getSupabaseAuthHeaders();
                
                // Se n√£o houver autentica√ß√£o, retornar array vazio silenciosamente
                if (!headers.Authorization) {
                    console.warn('‚ö†Ô∏è Sem autentica√ß√£o para carregar anexos, retornando vazio');
                    anexosCarregando.delete(coletaId);
                    return [];
                }
                
                const response = await fetch(`/api/anexos/coleta/${encodeURIComponent(coletaId)}`, {
                    credentials: 'include',
                    headers
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        console.warn('‚ö†Ô∏è Erro de autentica√ß√£o ao carregar anexos');
                        anexosCarregando.delete(coletaId);
                        return [];
                    }
                    const result = await response.json().catch(() => ({}));
                    throw new Error(result.error || `Erro ${response.status} ao carregar anexos.`);
                }
                
                const result = await response.json();

                const anexos = result?.anexos || [];
                
                // Armazenar no cache
                anexosCache.set(coletaId, anexos);
                
                // Remover do set de carregando
                anexosCarregando.delete(coletaId);
                
                return anexos;
            } catch (error) {
                console.error('‚ùå Erro ao carregar anexos:', error);
                // Remover do set de carregando em caso de erro
                anexosCarregando.delete(coletaId);
                return [];
            }
        }
        
        // Fun√ß√£o para invalidar cache de anexos quando necess√°rio
        function invalidarCacheAnexos(coletaId) {
            if (coletaId) {
                anexosCache.delete(coletaId);
            } else {
                anexosCache.clear();
            }
        }

        async function uploadAnexo(coletaId, file, categoria = null, tituloContrato = null) {
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('coleta_id', coletaId);
                
                // Adicionar categoria se fornecida
                if (categoria) {
                    formData.append('categoria', categoria);
                }
                
                // Adicionar t√≠tulo do contrato se fornecida e categoria for contratos
                if (categoria === 'contratos' && tituloContrato) {
                    formData.append('titulo_contrato', tituloContrato);
                }

                if (currentUser?.usuario) {
                    formData.append('usuario', currentUser.usuario);
                } else if (currentUser?.nome) {
                    formData.append('usuario', currentUser.nome);
                }

                const headers = await getSupabaseAuthHeaders();
                const response = await fetch('/api/anexos', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include',
                    headers
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Erro ao enviar arquivo.');
                }

                // Invalidar cache de anexos para esta coleta
                invalidarCacheAnexos(coletaId);

                // Registrar no hist√≥rico
                const nomeArquivo = result.anexo?.nome_arquivo || file.name || 'arquivo';
                const categoriaTexto = categoria ? ` (${obterNomeCategoria(categoria)})` : '';
                await salvarNoHistorico(coletaId, 'anexo_adicionado', `Anexo adicionado: ${nomeArquivo}${categoriaTexto}`);

                return { success: true, anexo: result.anexo };
            } catch (error) {
                console.error('‚ùå Erro no upload:', error);
                throw error;
            }
        }

        // ========== FUN√á√ïES PARA VISUALIZAR E BAIXAR ANEXOS ==========
        
        // Fun√ß√£o para buscar anexo por ID
        async function buscarAnexoPorId(anexoId) {
            try {
                const headers = await getSupabaseAuthHeaders();
                const response = await fetch(`/api/anexos/${encodeURIComponent(anexoId)}/info`, {
                    credentials: 'include',
                    headers
                });
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Erro ao carregar anexo.');
                }

                return result?.anexo || null;
            } catch (error) {
                console.error('‚ùå Erro ao buscar anexo:', error);
                showNotification('Erro ao carregar anexo', 'error');
                return null;
            }
        }

        // Fun√ß√£o para Visualizar Anexo (abre em nova aba)
        async function visualizarAnexo(anexoId) {
            try {
                const anexo = await buscarAnexoPorId(anexoId);
                if (!anexo) return;

                // Se o anexo tem URL direta (ex: Supabase Storage), usar diretamente
                if (anexo.url && !anexo.url.startsWith('/api/')) {
                    window.open(anexo.url, '_blank');
                    return;
                }

                // Para URLs da API, usar fetch com autentica√ß√£o
                const headers = await getSupabaseAuthHeaders();
                if (!headers.Authorization) {
                    showNotification('‚ö†Ô∏è Erro de autentica√ß√£o. Por favor, fa√ßa login novamente.', 'warning');
                    return;
                }

                const url = anexo.url || `/api/anexos/${encodeURIComponent(anexoId)}/download`;
                const response = await fetch(url, {
                    credentials: 'include',
                    headers
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        showNotification('‚ö†Ô∏è Erro de autentica√ß√£o. Por favor, fa√ßa login novamente.', 'warning');
                } else {
                        throw new Error(`Erro ${response.status}: ${response.statusText}`);
                    }
                    return;
                }

                const blob = await response.blob();
                const blobUrl = window.URL.createObjectURL(blob);
                window.open(blobUrl, '_blank');
                
                // Limpar URL ap√≥s um tempo
                setTimeout(() => {
                    window.URL.revokeObjectURL(blobUrl);
                }, 60000);
                
            } catch (error) {
                console.error('‚ùå Erro ao visualizar anexo:', error);
                showNotification('Erro ao visualizar arquivo: ' + error.message, 'error');
            }
        }

        // Fun√ß√£o para Download Direto
        async function downloadAnexoDireto(anexoId) {
            try {
                console.log('üîÑ For√ßando download para ID:', anexoId);
                
                const anexo = await buscarAnexoPorId(anexoId);
                if (!anexo) {
                    showNotification('Anexo n√£o encontrado', 'error');
                    return;
                }

                console.log('üìÑ For√ßando download de:', anexo.nome_arquivo);
                
                // Obter headers de autentica√ß√£o
                const headers = await getSupabaseAuthHeaders();
                if (!headers.Authorization) {
                    showNotification('‚ö†Ô∏è Erro de autentica√ß√£o. Por favor, fa√ßa login novamente.', 'warning');
                    return;
                }

                // Determinar URL para download
                let downloadUrl = anexo.url;
                if (!downloadUrl || downloadUrl.startsWith('/api/')) {
                    downloadUrl = `/api/anexos/${encodeURIComponent(anexoId)}/download`;
                }

                // Fazer fetch com autentica√ß√£o
                const response = await fetch(downloadUrl, {
                    credentials: 'include',
                    headers
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        showNotification('‚ö†Ô∏è Erro de autentica√ß√£o. Por favor, fa√ßa login novamente.', 'warning');
                    } else {
                        throw new Error(`Erro ${response.status}: ${response.statusText}`);
                    }
                    return;
                }

                const blob = await response.blob();
                const blobUrl = window.URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = blobUrl;
                link.download = anexo.nome_arquivo; // Isso que for√ßa o download
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                
                // Limpeza
                setTimeout(() => {
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(blobUrl);
                    console.log('‚úÖ Download for√ßado finalizado');
                }, 100);
                
                showNotification(`üíæ Baixando: ${anexo.nome_arquivo}`, 'success');
                
            } catch (error) {
                console.error('‚ùå Erro no download for√ßado:', error);
                showNotification('Erro ao baixar arquivo: ' + error.message, 'error');
            }
        }

        async function excluirAnexo(anexoId) {
            try {
                // üîê Verificar se o usu√°rio √© admin
                if (!currentUser || (!currentUser.isAdmin && currentUser.role !== 'admin')) {
                    showNotification('‚ö†Ô∏è Apenas administradores podem excluir anexos', 'warning');
                    return;
                }
                
                // Buscar informa√ß√µes do anexo para obter o coletaId e nome do arquivo
                let coletaId = null;
                let nomeArquivo = 'arquivo';
                try {
                    const anexoInfo = await buscarAnexoPorId(anexoId);
                    if (anexoInfo) {
                        if (anexoInfo.coleta_id) {
                        coletaId = anexoInfo.coleta_id;
                        }
                        if (anexoInfo.nome_arquivo) {
                            nomeArquivo = anexoInfo.nome_arquivo;
                        }
                    }
                } catch (err) {
                    console.warn('‚ö†Ô∏è N√£o foi poss√≠vel obter informa√ß√µes do anexo:', err);
                }
                
                const headers = await getSupabaseAuthHeaders();
                const response = await fetch(`/api/anexos/${encodeURIComponent(anexoId)}`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Erro ao excluir anexo.');
                }

                // Registrar no hist√≥rico ANTES de invalidar o cache
                if (coletaId) {
                    await salvarNoHistorico(coletaId, 'anexo_removido', `Anexo removido: ${nomeArquivo}`);
                }

                // Invalidar cache de anexos para esta coleta (ou todas se n√£o encontrou o coletaId)
                if (coletaId) {
                    invalidarCacheAnexos(coletaId);
                } else {
                    // Se n√£o encontrou o coletaId, invalidar todo o cache
                    invalidarCacheAnexos();
                }

                showNotification('Anexo exclu√≠do com sucesso', 'success');
            } catch (error) {
                console.error('‚ùå Erro ao excluir anexo:', error);
                showNotification('Erro ao excluir anexo: ' + error.message, 'error');
            }
        }

        // ========== FUN√á√ïES SUPABASE - CHAT ==========
        async function carregarMensagensChat(coletaId) {
            try {
                // Verificar se o Supabase est√° inicializado
                if (!supabaseClient) {
                    console.error('‚ùå Supabase n√£o inicializado');
                    return [];
                }
                
                const { data, error } = await supabaseClient
                    .from('chat_mensagens')
                    .select('*')
                    .eq('coleta_id', coletaId)
                    .order('created_at', { ascending: true });

                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('‚ùå Erro ao carregar mensagens:', error);
                return [];
            }
        }

        async function enviarMensagem(coletaId, mensagem, usuario) {
            try {
                // Verificar se o Supabase est√° inicializado
                if (!supabaseClient) {
                    console.error('‚ùå Supabase n√£o inicializado');
                    showNotification('Erro: Supabase n√£o inicializado', 'error');
                    return { success: false };
                }
                
                // Enviar mensagem
                const { data, error } = await supabaseClient
                    .from('chat_mensagens')
                    .insert([{
                        id: generateId(),
                        coleta_id: coletaId,
                        usuario: usuario,
                        mensagem: mensagem,
                        tipo: 'user',
                        created_at: new Date().toISOString()
                    }])
                    .select();

                if (error) throw error;

                console.log('‚úÖ Mensagem enviada:', data);
                return { success: true, data: data };
            } catch (error) {
                console.error('‚ùå Erro ao enviar mensagem:', error);
                console.error('‚ùå Detalhes:', error.message, error.details);
                showNotification('Erro ao enviar mensagem: ' + error.message, 'error');
                throw error;
            }
        }

        // ========== FUN√á√ïES PARA HIST√ìRICO ==========

        // Fun√ß√£o para carregar hist√≥rico do banco
        async function carregarHistorico(coletaId) {
            try {
                // Verificar se o Supabase est√° inicializado
                if (!supabaseClient) {
                    console.error('‚ùå Supabase n√£o inicializado');
                    return [];
                }
                
                const { data, error } = await supabaseClient
                    .from('historico_coletas')
                    .select('*')
                    .eq('coleta_id', coletaId)
                    .order('created_at', { ascending: false });

                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('‚ùå Erro ao carregar hist√≥rico:', error);
                return [];
            }
        }

        // Fun√ß√£o para comparar dados e gerar hist√≥rico detalhado
        function compararDadosColeta(dadosAntigos, dadosNovos) {
            const mudancas = [];
            const nomesCampos = {
                'filial': 'Filial',
                'numero_coleta': 'N√∫mero da Coleta',
                'cliente': 'Cliente',
                'data_recebimento': 'Data de Coleta',
                'data_entrega': 'Data de Entrega',
                'origem': 'Origem',
                'destino': 'Destino',
                'valor': 'Valor',
                'km': 'KM',
                'tipos_veiculo': 'Tipos de Ve√≠culo',
                'tipos_carroceria': 'Tipos de Carroceria',
                'status': 'Status',
                'etapa_atual': 'Etapa Atual',
                'observacoes': 'Observa√ß√µes',
                'prioridade': 'Prioridade',
                'motorista_id': 'Motorista'
            };
            
            Object.keys(dadosNovos).forEach(campo => {
                if (campo === 'updated_at' || campo === 'updated_by' || campo === 'data_atualizacao') {
                    return; // Ignorar campos de controle
                }
                
                const valorAntigo = dadosAntigos[campo];
                const valorNovo = dadosNovos[campo];
                
                // Normalizar valores para compara√ß√£o (convertendo strings para n√∫meros quando aplic√°vel)
                let valorAntigoNormalizado = valorAntigo;
                let valorNovoNormalizado = valorNovo;
                
                // Converter strings num√©ricas para n√∫meros para campos num√©ricos
                if (campo === 'valor' || campo === 'km') {
                    if (typeof valorAntigo === 'string' && valorAntigo !== '' && valorAntigo !== null) {
                        valorAntigoNormalizado = parseFloat(valorAntigo.replace(/[^\d,.-]/g, '').replace(',', '.')) || valorAntigo;
                    }
                    if (typeof valorNovo === 'string' && valorNovo !== '' && valorNovo !== null) {
                        valorNovoNormalizado = parseFloat(valorNovo.replace(/[^\d,.-]/g, '').replace(',', '.')) || valorNovo;
                    }
                    // Comparar n√∫meros arredondados para evitar problemas de precis√£o
                    if (typeof valorAntigoNormalizado === 'number' && typeof valorNovoNormalizado === 'number') {
                        if (Math.abs(valorAntigoNormalizado - valorNovoNormalizado) < 0.01) {
                            return; // Valores s√£o iguais, n√£o registrar mudan√ßa (retorna do forEach)
                        }
                    }
                }
                
                // Comparar valores (considerando arrays e objetos)
                const valorAntigoStr = JSON.stringify(valorAntigoNormalizado);
                const valorNovoStr = JSON.stringify(valorNovoNormalizado);
                
                if (valorAntigoStr !== valorNovoStr) {
                    let valorAntigoFormatado = formatarValorParaHistorico(valorAntigo, campo);
                    let valorNovoFormatado = formatarValorParaHistorico(valorNovo, campo);
                    
                    mudancas.push({
                        campo: nomesCampos[campo] || campo,
                        valorAntigo: valorAntigoFormatado,
                        valorNovo: valorNovoFormatado
                    });
                }
            });
            
            return mudancas;
        }
        
        // Fun√ß√£o para formatar valores para exibi√ß√£o no hist√≥rico
        function formatarValorParaHistorico(valor, campo) {
            if (valor === null || valor === undefined || valor === '') {
                return '(vazio)';
            }
            
            // Formatar arrays (tipos_veiculo, tipos_carroceria)
            if (Array.isArray(valor)) {
                return valor.length > 0 ? valor.join(', ') : '(nenhum)';
            }
            
            // Formatar datas
            if (campo.includes('data') || campo.includes('Data')) {
                if (valor) {
                    try {
                        return new Date(valor).toLocaleDateString('pt-BR', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } catch (e) {
                        return valor;
                    }
                }
            }
            
            // Formatar valores monet√°rios
            if (campo === 'valor') {
                return `R$ ${parseFloat(valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            }
            
            // Formatar motorista_id (buscar nome se poss√≠vel)
            if (campo === 'motorista_id') {
                // Retornar ID por enquanto, pode ser melhorado buscando o nome
                return valor || '(nenhum)';
            }
            
            return valor;
        }

        // Fun√ß√£o para salvar no hist√≥rico (salva em ambas as tabelas)
        async function salvarNoHistorico(coletaId, acao, detalhes = '') {
            try {
                // Verificar se o Supabase est√° inicializado
                if (!supabaseClient) {
                    console.error('‚ùå Supabase n√£o inicializado');
                    return;
                }
                
                const userData = JSON.parse(localStorage.getItem('loggedInUser'));
                const usuarioNome = currentUser?.nome || currentUser?.username || userData?.email || 'Sistema';
                const usuarioId = currentUser?.id || userData?.id || null;
                
                // Se detalhes √© um array de mudan√ßas, formatar para string
                let detalhesFormatado = '';
                if (Array.isArray(detalhes) && detalhes.length > 0) {
                    detalhesFormatado = detalhes.map(m => 
                        `‚Ä¢ ${m.campo}: "${m.valorAntigo}" ‚Üí "${m.valorNovo}"`
                    ).join('\n');
                } else {
                    detalhesFormatado = detalhes;
                }
                
                // Salvar na tabela historico_coletas (para compatibilidade)
                const { error: error1 } = await supabaseClient
                    .from('historico_coletas')
                    .insert([{
                        id: 'HIST-' + Date.now() + '-' + Math.random().toString(36).substr(2, 9),
                        coleta_id: coletaId,
                        usuario: usuarioNome,
                        acao: acao,
                        detalhes: detalhesFormatado,
                        created_at: new Date().toISOString()
                    }]);

                if (error1) {
                    console.warn('‚ö†Ô∏è Erro ao salvar em historico_coletas:', error1);
                }

                // Salvar na tabela historico_movimentacoes (usada pelo modal completo)
                const { error: error2 } = await supabaseClient
                    .from('historico_movimentacoes')
                    .insert([{
                        coleta_id: coletaId,
                        acao: acao,
                        detalhes: detalhesFormatado,
                        usuario_id: usuarioId,
                        usuario_nome: usuarioNome,
                        created_at: new Date().toISOString()
                    }]);

                if (error2) {
                    console.error('‚ùå Erro ao salvar em historico_movimentacoes:', error2);
                    // N√£o lan√ßar erro para n√£o bloquear outras opera√ß√µes
                } else {
                    console.log('üìù Hist√≥rico salvo em ambas as tabelas:', acao);
                }
            } catch (error) {
                console.error('‚ùå Erro ao salvar hist√≥rico:', error);
            }
        }

        // Fun√ß√£o para carregar hist√≥rico no card
        async function carregarHistoricoParaCard(coletaId) {
            try {
                // Verificar se o Supabase est√° inicializado
                if (!supabaseClient) {
                    console.error('‚ùå Supabase n√£o inicializado');
                    return [];
                }
                
                const historico = await carregarHistorico(coletaId);
                const historicoContainer = document.getElementById(`historico-content-${coletaId}`);
                
                if (!historicoContainer) return;
                
                if (historico.length === 0) {
                    historicoContainer.innerHTML = `
                        <div style="text-align: center; color: #6c757d; padding: 0.5rem; font-size: 0.8rem;">
                            <i class="fas fa-inbox"></i>
                            <div>Nenhuma movimenta√ß√£o</div>
                        </div>
                    `;
                } else {
                    // Mostra apenas as 3 √∫ltimas movimenta√ß√µes
                    const ultimasMovimentacoes = historico.slice(0, 3);
                    
                    historicoContainer.innerHTML = ultimasMovimentacoes.map(item => {
                        // Verificar se detalhes cont√©m mudan√ßas formatadas
                        let detalhesHTML = '';
                        if (item.detalhes && item.detalhes.includes('‚Üí')) {
                            detalhesHTML = item.detalhes.split('\n').map(linha => {
                                if (linha.includes('‚Üí')) {
                                    const [campo, mudanca] = linha.split(':');
                                    const [antigo, novo] = mudanca.split('‚Üí').map(s => s.trim().replace(/"/g, ''));
                                    return `
                                        <div style="margin: 0.5rem 0; padding: 0.5rem; background: rgba(102, 126, 234, 0.05); border-radius: 6px; border-left: 3px solid #667eea;">
                                            <div style="font-weight: 600; color: #667eea; font-size: 0.75rem; margin-bottom: 0.3rem;">${campo.replace('‚Ä¢', '').trim()}</div>
                                            <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; flex-wrap: wrap;">
                                                <span style="color: #6c757d; text-decoration: line-through;">${antigo}</span>
                                                <i class="fas fa-arrow-right" style="color: #667eea; font-size: 0.7rem;"></i>
                                                <span style="color: #28a745; font-weight: 600;">${novo}</span>
                                            </div>
                                        </div>
                                    `;
                                }
                                return `<div style="margin: 0.3rem 0; font-size: 0.85rem;">${linha}</div>`;
                            }).join('');
                        } else {
                            detalhesHTML = `<div style="font-size: 0.85rem; color: #6c757d; margin-top: 0.5rem;">${item.detalhes || 'Sem detalhes'}</div>`;
                        }
                        
                        return `
                        <div class="historico-item-card">
                            <div class="historico-item-header">
                                <span class="historico-usuario-card">${item.usuario || item.usuario_nome || 'Sistema'}</span>
                                <span class="historico-data-card">${formatarDataHora(item.created_at)}</span>
                            </div>
                            <div class="historico-acao-card">
                                ${getTextoAcao(item.acao)}
                            </div>
                            ${detalhesHTML}
                        </div>
                    `;
                    }).join('');
                    
                    // Se tiver mais de 3, mostra contador
                    if (historico.length > 3) {
                        historicoContainer.innerHTML += `
                            <div class="historico-mais-itens" onclick="event.stopPropagation(); openEditColetaModal('${coletaId}')">
                                +${historico.length - 3} movimenta√ß√µes anteriores
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar hist√≥rico para card:', error);
                const historicoContainer = document.getElementById(`historico-${coletaId}`);
                if (historicoContainer) {
                    historicoContainer.innerHTML = `
                        <div style="text-align: center; color: #6c757d; padding: 0.5rem; font-size: 0.8rem;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>Erro ao carregar hist√≥rico</div>
                        </div>
                    `;
                }
            }
        }

        // Fun√ß√£o auxiliar para formatar data e hora
        function formatarDataHora(dataString) {
            const data = new Date(dataString);
            return data.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit', 
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Fun√ß√£o para traduzir a√ß√µes
        function getTextoAcao(acao) {
            const acoes = {
                'coleta_criada': 'üìù Coleta criada',
                'coleta_editada': '‚úèÔ∏è Coleta editada', 
                'etapa_avancada': 'üöÄ Etapa avan√ßada',
                'etapa_retornada': '‚¨ÖÔ∏è Etapa retornada',
                'coleta_excluida': 'üóëÔ∏è Coleta exclu√≠da',
                'anexo_adicionado': 'üìé Anexo adicionado',
                'anexo_removido': 'üìé Anexo removido',
                'etiquetas_alteradas': 'üè∑Ô∏è Etiquetas alteradas',
                'motorista_vinculado': 'üë§ Motorista vinculado',
                'motorista_trocado': 'üîÑ Motorista trocado'
            };
            return acoes[acao] || acao;
        }

        // ========== RENDERIZA√á√ÉO DE COLETAS ==========
        let renderizandoColetas = false;
        let ultimaRenderizacao = 0;
        let timeoutRenderizacao = null;
        
        // Fun√ß√£o wrapper que decide qual renderiza√ß√£o usar
        async function renderColetasWrapper(filteredData = null) {
            if (visualizacaoAtual === 'kanban') {
                await renderColetasKanban(filteredData);
            } else {
                await renderColetas(filteredData);
            }
        }
        
        async function renderColetas(filteredData = null) {
            // Limpar timeout anterior se existir
            if (timeoutRenderizacao) {
                clearTimeout(timeoutRenderizacao);
                timeoutRenderizacao = null;
            }
            
            // Prote√ß√£o contra renderiza√ß√µes simult√¢neas
            if (renderizandoColetas) {
                console.warn('‚ö†Ô∏è Renderiza√ß√£o j√° em andamento, agendando nova renderiza√ß√£o...');
                // Agendar renderiza√ß√£o ap√≥s a atual terminar
                timeoutRenderizacao = setTimeout(() => {
                    renderColetas(filteredData);
                }, 200);
                return;
            }
            
            // Debounce: se foi chamada h√° menos de 150ms, aguardar
            const agora = Date.now();
            const tempoDesdeUltima = agora - ultimaRenderizacao;
            if (tempoDesdeUltima < 150 && ultimaRenderizacao > 0) {
                console.log(`‚è≥ Renderiza√ß√£o muito r√°pida (${tempoDesdeUltima}ms), aguardando...`);
                timeoutRenderizacao = setTimeout(() => {
                    renderColetas(filteredData);
                }, 150 - tempoDesdeUltima);
                return;
            }
            
            ultimaRenderizacao = agora;
            renderizandoColetas = true;
            
            try {
                const grid = document.getElementById('coletasGrid');
                if (!grid) {
                    console.error('‚ùå Grid de coletas n√£o encontrado');
                    renderizandoColetas = false;
                    return;
                }
                
                // Garantir que o grid est√° vis√≠vel antes de renderizar
                if (visualizacaoAtual === 'grid' && grid.style.display === 'none') {
                    grid.style.display = 'grid';
                }
                
                // Por padr√£o, mostrar apenas coletas ativas (n√£o arquivadas)
                let dataToRender = filteredData || window.coletasAtivas || coletasData.filter(c => !c.arquivado);

                // Remover duplicatas baseado no ID da coleta
                const coletasUnicas = [];
                const idsVistos = new Set();
                for (const coleta of dataToRender) {
                    if (coleta && coleta.id && !idsVistos.has(coleta.id)) {
                        idsVistos.add(coleta.id);
                        coletasUnicas.push(coleta);
                    }
                }
                dataToRender = coletasUnicas;
                
                // ‚úÖ PAGINA√á√ÉO: Armazenar coletas filtradas e aplicar pagina√ß√£o
                coletasFiltradas = dataToRender;
                const totalPaginas = Math.ceil(coletasFiltradas.length / itensPorPagina);
                
                // Ajustar p√°gina atual se necess√°rio
                if (paginaAtual > totalPaginas && totalPaginas > 0) {
                    paginaAtual = totalPaginas;
                }
                if (paginaAtual < 1) {
                    paginaAtual = 1;
                }
                
                // Aplicar pagina√ß√£o
                const inicio = (paginaAtual - 1) * itensPorPagina;
                const fim = inicio + itensPorPagina;
                dataToRender = coletasFiltradas.slice(inicio, fim);
                
                console.log(`üìÑ Pagina√ß√£o: P√°gina ${paginaAtual} de ${totalPaginas} (${coletasFiltradas.length} coletas total, mostrando ${dataToRender.length})`);

                // Verificar cards existentes ANTES de limpar o grid
                const cardsExistentes = grid.querySelectorAll('[data-coleta-id]');
                const idsExistentes = new Set();
                cardsExistentes.forEach(card => {
                    const id = card.getAttribute('data-coleta-id');
                    if (id) idsExistentes.add(id);
                });

                // Limpar o grid completamente antes de renderizar
            grid.innerHTML = '';

            if (dataToRender.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #6c757d;">
                        <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <h3>Nenhuma coleta encontrada</h3>
                        <p>Tente ajustar os filtros para ver mais resultados</p>
                    </div>
                `;
                    return;
                }

                // Carregar anexos para cada coleta e adicionar apenas se n√£o existir
            for (const coleta of dataToRender) {
                    // Verificar novamente se n√£o foi adicionado durante o loop
                    const cardJaExiste = grid.querySelector(`[data-coleta-id="${coleta.id}"]`);
                    if (cardJaExiste) {
                        console.warn('‚ö†Ô∏è Card j√° existe no grid, pulando:', coleta.id);
                        continue;
                    }
                    
                coleta.anexos = await carregarAnexos(coleta.id);
                const card = createColetaCard(coleta);
                    card.setAttribute('data-coleta-id', coleta.id);
                    
                    // Verificar uma √∫ltima vez antes de adicionar
                    const cardDuplicado = grid.querySelector(`[data-coleta-id="${coleta.id}"]`);
                    if (!cardDuplicado) {
                grid.appendChild(card);
                
                // Carregar informa√ß√µes do motorista se houver vincula√ß√£o
                if (coleta.motorista_id) {
                    await carregarInfoMotorista(coleta.id, coleta.motorista_id, coleta.anexos);
                        }
                
                // ‚úÖ Carregar ITs relacionadas ao cliente (filtradas por filial)
                if (coleta.cliente) {
                    await carregarITsRelacionadas(coleta.id, coleta.cliente, coleta.filial);
                        }
                    } else {
                        console.warn('‚ö†Ô∏è Card duplicado detectado no √∫ltimo momento, removendo:', coleta.id);
                        cardDuplicado.remove();
                        grid.appendChild(card);
                        
                        if (coleta.motorista_id) {
                            await carregarInfoMotorista(coleta.id, coleta.motorista_id, coleta.anexos);
                        }
                        
                        // ‚úÖ Carregar ITs relacionadas ao cliente (filtradas por filial)
                        if (coleta.cliente) {
                            await carregarITsRelacionadas(coleta.id, coleta.cliente, coleta.filial);
                        }
                    }
                }

                // Verifica√ß√£o final: remover qualquer duplicata que possa ter sido criada
                const todosCards = grid.querySelectorAll('[data-coleta-id]');
                const idsFinais = new Map();
                todosCards.forEach(card => {
                    const id = card.getAttribute('data-coleta-id');
                    if (id) {
                        if (idsFinais.has(id)) {
                            console.warn('‚ö†Ô∏è Duplicata final detectada, removendo:', id);
                            card.remove();
                        } else {
                            idsFinais.set(id, card);
                        }
                    }
                });

            updateStats(dataToRender);
                
                // ‚úÖ PAGINA√á√ÉO: Adicionar controles de pagina√ß√£o
                renderizarControlesPaginacao(totalPaginas);
                
            } finally {
                renderizandoColetas = false;
            }
        }

        // ========== FUN√á√ïES DE PAGINA√á√ÉO ==========
        function renderizarControlesPaginacao(totalPaginas) {
            // Remover controles anteriores se existirem
            const controlesAnteriores = document.getElementById('paginacaoControles');
            if (controlesAnteriores) {
                controlesAnteriores.remove();
            }
            
            // Se n√£o h√° necessidade de pagina√ß√£o, n√£o mostrar controles
            if (totalPaginas <= 1) {
                return;
            }
            
            const grid = document.getElementById('coletasGrid');
            if (!grid) return;
            
            // Criar container de pagina√ß√£o
            const paginacaoContainer = document.createElement('div');
            paginacaoContainer.id = 'paginacaoControles';
            paginacaoContainer.style.cssText = `
                grid-column: 1 / -1;
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 0.5rem;
                padding: 2rem 1rem;
                margin-top: 1rem;
                flex-wrap: wrap;
            `;
            
            // Bot√£o Primeira P√°gina
            const btnPrimeira = criarBotaoPaginacao('Primeira', () => irParaPagina(1), paginaAtual === 1);
            btnPrimeira.innerHTML = '<i class="fas fa-angle-double-left"></i> Primeira';
            
            // Bot√£o Anterior
            const btnAnterior = criarBotaoPaginacao('Anterior', () => irParaPagina(paginaAtual - 1), paginaAtual === 1);
            btnAnterior.innerHTML = '<i class="fas fa-angle-left"></i> Anterior';
            
            // Informa√ß√µes da p√°gina
            const infoPagina = document.createElement('div');
            infoPagina.style.cssText = `
                padding: 0.6rem 1.2rem;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 8px;
                font-weight: 600;
                font-size: 0.9rem;
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            `;
            const inicio = (paginaAtual - 1) * itensPorPagina + 1;
            const fim = Math.min(paginaAtual * itensPorPagina, coletasFiltradas.length);
            infoPagina.textContent = `P√°gina ${paginaAtual} de ${totalPaginas} (${inicio}-${fim} de ${coletasFiltradas.length})`;
            
            // Bot√£o Pr√≥xima
            const btnProxima = criarBotaoPaginacao('Pr√≥xima', () => irParaPagina(paginaAtual + 1), paginaAtual === totalPaginas);
            btnProxima.innerHTML = 'Pr√≥xima <i class="fas fa-angle-right"></i>';
            
            // Bot√£o √öltima P√°gina
            const btnUltima = criarBotaoPaginacao('√öltima', () => irParaPagina(totalPaginas), paginaAtual === totalPaginas);
            btnUltima.innerHTML = '√öltima <i class="fas fa-angle-double-right"></i>';
            
            // Adicionar bot√µes ao container
            paginacaoContainer.appendChild(btnPrimeira);
            paginacaoContainer.appendChild(btnAnterior);
            paginacaoContainer.appendChild(infoPagina);
            paginacaoContainer.appendChild(btnProxima);
            paginacaoContainer.appendChild(btnUltima);
            
            // Adicionar ap√≥s o grid
            grid.parentNode.insertBefore(paginacaoContainer, grid.nextSibling);
        }

        function criarBotaoPaginacao(texto, onClick, desabilitado) {
            const btn = document.createElement('button');
            btn.textContent = texto;
            btn.onclick = onClick;
            btn.disabled = desabilitado;
            btn.style.cssText = `
                padding: 0.6rem 1.2rem;
                border: 1px solid #667eea;
                background: ${desabilitado ? '#f0f0f0' : 'white'};
                color: ${desabilitado ? '#999' : '#667eea'};
                border-radius: 8px;
                cursor: ${desabilitado ? 'not-allowed' : 'pointer'};
                font-weight: 600;
                font-size: 0.9rem;
                transition: all 0.3s;
                display: flex;
                align-items: center;
                gap: 0.3rem;
            `;
            
            if (!desabilitado) {
                btn.onmouseenter = () => {
                    btn.style.background = '#667eea';
                    btn.style.color = 'white';
                    btn.style.transform = 'translateY(-2px)';
                    btn.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.3)';
                };
                btn.onmouseleave = () => {
                    btn.style.background = 'white';
                    btn.style.color = '#667eea';
                    btn.style.transform = 'translateY(0)';
                    btn.style.boxShadow = 'none';
                };
            }
            
            return btn;
        }

        function irParaPagina(novaPagina) {
            const totalPaginas = Math.ceil(coletasFiltradas.length / itensPorPagina);
            if (novaPagina < 1 || novaPagina > totalPaginas) {
                return;
            }
            
            paginaAtual = novaPagina;
            
            // Scroll suave para o topo do grid
            const grid = document.getElementById('coletasGrid');
            if (grid) {
                grid.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            // Re-renderizar com a nova p√°gina
            renderColetasWrapper();
        }

        function createColetaCard(coleta) {
            const card = document.createElement('div');
            // Adicionar classe 'urgente' se a prioridade for urgente
            const classeUrgente = (coleta.prioridade === 'urgente') ? 'urgente' : '';
            card.className = `coleta-card ${coleta.status} ${classeUrgente} collapsed`.trim();
            card.setAttribute('data-coleta-id', coleta.id);
            card.onclick = () => openEditColetaModal(coleta.id);

            const progresso = calcularProgressoEtapas(coleta);
            
            card.innerHTML = `
                <button class="card-toggle" onclick="event.stopPropagation(); toggleCardExpand(this);">
                    <i class="fas fa-chevron-down"></i>
                </button>
                
                <div class="card-header">
                    <div class="card-title-section">
                        <h3 class="card-title">${coleta.cliente}</h3>
                        ${coleta.filial && coleta.numero_coleta ? `
                            <div class="card-filial-numero" style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.3rem; font-size: 0.85rem; color: #667eea; font-weight: 600;">
                                <i class="fas fa-building"></i>
                                <span>${coleta.filial}</span>
                                <span style="color: #999;">|</span>
                                <i class="fas fa-hashtag"></i>
                                <span>Coleta: ${coleta.numero_coleta}</span>
                            </div>
                        ` : ''}
                        </div>
                    <div class="status-section">
                        ${coleta.prioridade === 'urgente' ? `
                        <div class="urgente-badge" style="background: #e74c3c; color: white; padding: 0.35rem 0.75rem; border-radius: 6px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; box-shadow: 0 2px 4px rgba(231, 76, 60, 0.25); white-space: nowrap; display: inline-flex; align-items: center; gap: 0.3rem;">
                            <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink: 0;">
                                <path d="M6 0L7.5 4.5L12 6L7.5 7.5L6 12L4.5 7.5L0 6L4.5 4.5L6 0Z" fill="currentColor"/>
                            </svg>
                            <span>URGENTE</span>
                        </div>
                        ` : ''}
                        ${coleta.etapa_atual === 'contas_pagar' && coleta.contas_pagar_tipo ? `
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.4rem 0.8rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.4rem; margin-bottom: 0.5rem; box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>Tipo: ${coleta.contas_pagar_tipo}</span>
                        </div>
                        ` : ''}
                        ${coleta.titulo_contrato ? `
                        <div style="background: linear-gradient(135deg, #fd7e14 0%, #ff9500 100%); color: white; padding: 0.4rem 0.8rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.4rem; margin-bottom: 0.5rem; box-shadow: 0 2px 6px rgba(253, 126, 20, 0.3); max-width: 100%; word-break: break-word;">
                            <i class="fas fa-file-contract"></i>
                            <span style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(coleta.titulo_contrato)}">${escapeHtml(coleta.titulo_contrato)}</span>
                        </div>
                        ` : ''}
                        <div class="status-badge status-${coleta.status}">
                            ${getStatusText(coleta.status)}
                        </div>
                        ${coleta.anexos && coleta.anexos.length > 0 ? `
                            <div class="anexos-badge" title="${coleta.anexos.length} documentos anexados" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.3rem 0.7rem; border-radius: 12px; font-size: 0.7rem; display: flex; align-items: center; gap: 0.3rem; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
                                <i class="fas fa-paperclip"></i>
                                ${coleta.anexos.length}
                            </div>
                        ` : ''}
                        <div class="valor-badge">
                            R$ ${(coleta.valor || 0).toFixed(2)}
                        </div>
                    </div>
                </div>

                <!-- Etiquetas no topo (sempre vis√≠veis) -->
                <div class="etiquetas-container-top" style="padding: 0.8rem 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-weight: 600; color: #667eea; font-size: 0.85rem;">
                            <i class="fas fa-tags"></i> Etiquetas
                        </span>
                        <button onclick="event.stopPropagation(); event.preventDefault(); abrirModalEtiquetas('${coleta.id}')" 
                                class="btn btn-sm" 
                                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.25rem 0.6rem; border-radius: 6px; border: none; font-size: 0.75rem; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
                            <i class="fas fa-plus"></i> Gerenciar
                        </button>
                    </div>
                    <div id="etiquetas-coleta-${coleta.id}" class="etiquetas-list-top" style="display: flex; flex-wrap: wrap; gap: 0.4rem; min-height: 1.5rem;">
                        ${coleta.etiquetas && coleta.etiquetas.length > 0 
                            ? coleta.etiquetas.map(et => `
                                <span class="badge" style="background: ${et.cor || '#667eea'}; color: white; padding: 0.35rem 0.75rem; border-radius: 6px; font-size: 0.75rem; box-shadow: 0 2px 6px rgba(0,0,0,0.1); display: inline-flex; align-items: center; gap: 0.3rem;">
                                    <i class="fas fa-tag"></i> ${et.nome}
                                </span>
                            `).join('')
                            : '<span style="color: #6c757d; font-size: 0.75rem; font-style: italic;"><i class="fas fa-info-circle"></i> Nenhuma etiqueta</span>'
                        }
                    </div>
                </div>

                <div class="card-details">
                    <div class="card-content">
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Origem</div>
                            <div class="info-value">
                                <i class="fas fa-map-marker-alt"></i>
                                ${coleta.origem}
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Destino</div>
                            <div class="info-value">
                                <i class="fas fa-flag-checkered"></i>
                                ${coleta.destino}
                            </div>
                        </div>
                        <div class="info-item" style="grid-column: 1 / -1;">
                            <div class="info-label">Tipos de Ve√≠culo</div>
                            <div class="info-value" style="flex-wrap: wrap; gap: 0.3rem;">
                                <i class="fas fa-truck" style="flex-shrink: 0;"></i>
                                <span style="display: flex; flex-wrap: wrap; gap: 0.3rem; flex: 1; min-width: 0; max-width: 100%; box-sizing: border-box;">
                                ${coleta.tipos_veiculo && coleta.tipos_veiculo.length > 0 
                                        ? coleta.tipos_veiculo.map(v => `<span style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem; white-space: nowrap; max-width: 100%; box-sizing: border-box;">${v}</span>`).join('')
                                    : '-'}
                                </span>
                            </div>
                        </div>
                        <div class="info-item" style="grid-column: 1 / -1;">
                            <div class="info-label">Tipos de Carroceria</div>
                            <div class="info-value" style="flex-wrap: wrap; gap: 0.3rem;">
                                <i class="fas fa-box" style="flex-shrink: 0;"></i>
                                <span style="display: flex; flex-wrap: wrap; gap: 0.3rem; flex: 1; min-width: 0; max-width: 100%; box-sizing: border-box;">
                                ${(() => {
                                    if (!coleta.tipos_carroceria || coleta.tipos_carroceria.length === 0) return '-';
                                    return coleta.tipos_carroceria.map(c => {
                                        const nomeAmigavel = tiposCarroceriaMap[c] || c;
                                            return `<span style="display: inline-block; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem; white-space: nowrap; max-width: 100%; box-sizing: border-box;">${nomeAmigavel}</span>`;
                                    }).join('');
                                })()}
                                </span>
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">KM</div>
                            <div class="info-value">
                                <i class="fas fa-road"></i>
                                ${coleta.km || '0'} km
                            </div>
                        </div>
                        ${coleta.motorista_id ? `
                        <div class="info-item motorista-card-${coleta.id}" id="motorista-card-wrapper-${coleta.id}" style="grid-column: 1 / -1; background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(32, 201, 151, 0.1) 100%); padding: 0.8rem; border-radius: 10px; border: 1px solid #28a745; transition: all 0.3s;">
                            <div class="info-label motorista-label-${coleta.id}" id="motorista-label-${coleta.id}" style="color: #28a745; font-weight: 700; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span><i class="fas fa-user-check"></i> Motorista Vinculado</span>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="event.stopPropagation(); solicitarAtivacaoLocalizacao('${coleta.id}')" 
                                            title="Solicitar ao motorista que ative a localiza√ß√£o GPS" 
                                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.4rem; box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3); transition: all 0.2s;" 
                                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 10px rgba(102, 126, 234, 0.4)';" 
                                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(102, 126, 234, 0.3)';">
                                        <i class="fas fa-map-marker-alt"></i>
                                        Solicitar Localiza√ß√£o
                                    </button>
                                    <button onclick="event.stopPropagation(); verDetalhesMotorista('${coleta.id}')" 
                                            title="Ver detalhes do motorista" 
                                            style="background: transparent; color: #28a745; border: 1px solid #28a745; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.2s;" 
                                            onmouseover="this.style.background='#28a745'; this.style.color='white';" 
                                            onmouseout="this.style.background='transparent'; this.style.color='#28a745';">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="info-value" id="motorista-info-${coleta.id}" style="color: var(--cinza-escuro); font-weight: 500; display: flex; flex-wrap: wrap; gap: 1rem;">
                                <span><i class="fas fa-spinner fa-spin"></i> Carregando...</span>
                            </div>
                        </div>
                        ` : `
                        <div class="info-item">
                            <div class="info-label">Motorista</div>
                            <div class="info-value" style="color: #6c757d;">
                                <i class="fas fa-user-times"></i>
                                N√£o vinculado
                            </div>
                        </div>
                        `}
                    </div>

                    <!-- Submenu de Anexos -->
                    <div class="card-submenu anexos-submenu">
                        <div class="submenu-header" onclick="event.stopPropagation(); toggleSubmenu('anexos-${coleta.id}')">
                            <div class="submenu-title">
                                <i class="fas fa-paperclip"></i> Anexos
                                <span class="badge" style="background: rgba(255,255,255,0.3); color: white; margin-left: 0.5rem; font-size: 0.7rem;">
                                    ${coleta.anexos?.length || 0}
                                </span>
                            </div>
                            <i class="fas fa-chevron-down submenu-toggle" id="toggle-anexos-${coleta.id}"></i>
                        </div>
                        <div class="submenu-content" id="anexos-${coleta.id}">
                            <div class="submenu-body">
                                <div class="anexos-actions" style="margin-bottom: 1rem;">
                                    <button class="btn-anexar" onclick="event.stopPropagation(); abrirModalAnexos('${coleta.id}')">
                                        <i class="fas fa-plus"></i> Adicionar Anexo
                                    </button>
                                </div>
                                <div class="anexos-list">
                                    ${(coleta.anexos && coleta.anexos.length > 0) ? 
                                        coleta.anexos.map(anexo => `
                                            <div class="anexo-item">
                                                <div class="anexo-info">
                                                    <div class="anexo-icon ${getFileIconClass(anexo.tipo_arquivo)}">
                                                        <i class="fas ${getFileIcon(anexo.tipo_arquivo)}"></i>
                                                    </div>
                                                    <div class="anexo-details">
                                                        <div class="anexo-nome">${anexo.nome_arquivo}</div>
                                                        <div class="anexo-tamanho">${formatFileSize(anexo.tamanho)}</div>
                                                    </div>
                                                </div>
                                                <div class="anexo-actions">
                                                    <button class="btn-anexo-action btn-anexo-view" onclick="event.stopPropagation(); visualizarAnexo('${anexo.id}')" title="Visualizar">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn-anexo-action btn-anexo-download" onclick="event.stopPropagation(); downloadAnexoDireto('${anexo.id}')" title="Baixar">
                                <i class="fas fa-download"></i>
                            </button>
                                                    ${currentUser && (currentUser.isAdmin || currentUser.role === 'admin') ? `
                                                    <button class="btn-anexo-action btn-anexo-delete" onclick="event.stopPropagation(); excluirAnexo('${anexo.id}')" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                            ` : ''}
                        </div>
                                            </div>
                                        `).join('') : 
                                        '<div style="text-align: center; color: #6c757d; font-size: 0.8rem; padding: 1rem;">Nenhum anexo adicionado</div>'
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submenu de Hist√≥rico -->
                    <div class="card-submenu historico-submenu">
                        <div class="submenu-header">
                            <div class="submenu-title" onclick="event.stopPropagation(); toggleSubmenu('historico-${coleta.id}')">
                                <i class="fas fa-history"></i> √öltimas Movimenta√ß√µes
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <button onclick="event.stopPropagation(); abrirModalHistoricoCompleto('${coleta.id}')" 
                                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 600; transition: transform 0.2s;" 
                                    onmouseover="this.style.transform='scale(1.05)'" 
                                    onmouseout="this.style.transform='scale(1)'">
                                    <i class="fas fa-eye"></i> Ver Tudo
                                </button>
                                <i class="fas fa-chevron-down submenu-toggle" id="toggle-historico-${coleta.id}" onclick="event.stopPropagation(); toggleSubmenu('historico-${coleta.id}')"></i>
                            </div>
                        </div>
                        <div class="submenu-content" id="historico-${coleta.id}">
                            <div class="submenu-body">
                                <div class="historico-list-card" id="historico-content-${coleta.id}">
                                    <div style="text-align: center; color: #6c757d; padding: 0.5rem; font-size: 0.8rem;">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        Carregando hist√≥rico...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                    <!-- Submenu de ITs Relacionadas -->
                    <div class="card-submenu its-submenu" id="its-submenu-${coleta.id}">
                        <div class="submenu-header">
                            <div class="submenu-title" onclick="event.stopPropagation(); toggleSubmenu('its-${coleta.id}')">
                                <i class="fas fa-file-alt"></i> ITs Relacionadas
                            </div>
                            <i class="fas fa-chevron-down submenu-toggle" id="toggle-its-${coleta.id}" onclick="event.stopPropagation(); toggleSubmenu('its-${coleta.id}')"></i>
                        </div>
                        <div class="submenu-content" id="its-${coleta.id}">
                            <div class="submenu-body">
                                <div id="its-content-${coleta.id}" style="text-align: center; color: #6c757d; padding: 0.5rem; font-size: 0.8rem;">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    Carregando ITs...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>

                <div class="etapas-container">
                    <div class="etapas-header">
                        <div class="etapas-title">
                            <i class="fas fa-project-diagram"></i> Etapas do Processo
                        </div>
                        <div class="progress-text">
                            ${progresso.concluidas}/${progresso.total} etapas
                        </div>
                    </div>
                    <div class="etapas-progress">
                        ${ETAPAS.map(etapa => `
                            <div class="etapa-progress etapa-${etapa.id}" 
                                style="width: ${100/ETAPAS.length}%"
                                title="${etapa.nome}">
                            </div>
                        `).join('')}
                    </div>
                    <div class="etapas-labels">
                        ${ETAPAS.map(etapa => {
                            const isAtiva = coleta.etapa_atual === etapa.id; // Etapa atual
                            const passouPorEla = coleta.etapas_concluidas?.includes(etapa.id) || false; // Passou por esta etapa
                            const jaPassouMasNaoEAtual = passouPorEla && !isAtiva; // Passou mas n√£o √© a atual
                            
                            // L√≥gica: apenas a etapa atual fica verde, as que passou ficam azuis
                            const classe = isAtiva ? 'concluida' : (jaPassouMasNaoEAtual ? 'ativa' : '');
                            const icon = isAtiva ? 'fa-check' : (jaPassouMasNaoEAtual ? 'fa-check' : 'fa-clock');
                            return `
                                <span class="etapa-badge ${classe}">
                                    <i class="fas ${icon}"></i>
                                    ${etapa.nome}
                                </span>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <!-- Valida√ß√£o para etapa Contrata√ß√£o -->
                ${coleta.etapa_atual === 'contratacao' && !coleta.motorista_id ? `
                    <div class="etapa-validation" id="validation-contratacao-${coleta.id}">
                        <div class="validation-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            Valida√ß√£o Necess√°ria
                        </div>
                        <div class="validation-message">
                            Para avan√ßar da etapa Contrata√ß√£o, √© necess√°rio vincular um motorista √† coleta.
                        </div>
                        <div class="validation-actions">
                            <button class="btn-validation primary" onclick="event.stopPropagation(); vincularMotorista('${coleta.id}')">
                                <i class="fas fa-user-plus"></i> Vincular Motorista
                            </button>
                            <button class="btn-validation success" onclick="event.stopPropagation(); cadastrarMotorista('${coleta.id}')">
                                <i class="fas fa-user-plus"></i> Cadastrar Novo Motorista
                            </button>
                        </div>
                    </div>
                ` : ''}
                
                <!-- Valida√ß√£o para etapa Finalizar Opera√ß√£o (Canhoto Anexado) -->
                ${coleta.etapa_atual === 'finalizar_operacao' ? `
                    <div class="etapa-validation" id="validation-finalizar-${coleta.id}" style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 152, 0, 0.1) 100%); border: 2px solid #ffc107;">
                        <div class="validation-title" style="color: #f57c00;">
                            <i class="fas fa-check-circle"></i>
                            Canhoto Anexado - Aguardando Valida√ß√£o
                        </div>
                        <div class="validation-message" style="color: #333;">
                            O motorista anexou o canhoto da entrega. Verifique o documento nos anexos e finalize a opera√ß√£o quando estiver tudo correto.
                            ${coleta.contas_pagar_tipo && coleta.contas_pagar_tipo.includes('saldo') && coleta.contas_pagar_tipo !== 'pagamento_total' && coleta.contas_pagar_tipo !== 'ambos' ? 
                                '<br><br><strong style="color: #f57c00;"><i class="fas fa-exclamation-triangle"></i> ATEN√á√ÉO: Pend√™ncia de pagamento do saldo.</strong>' : 
                                ''
                            }
                        </div>
                        <div class="validation-actions">
                            <button class="btn-validation success" onclick="event.stopPropagation(); abrirModalAnexos('${coleta.id}')">
                                <i class="fas fa-paperclip"></i> Ver Anexos
                            </button>
                            <button class="btn-validation primary" onclick="event.stopPropagation(); abrirModalHistoricoCompleto('${coleta.id}')">
                                <i class="fas fa-history"></i> Ver Hist√≥rico
                            </button>
                        </div>
                    </div>
                ` : ''}
                
                <!-- Valida√ß√£o para etapa GR -->
                ${coleta.etapa_atual === 'gr' && (coleta.gr_aprovado === null || coleta.gr_aprovado === undefined || coleta.gr_aprovado === false) ? `
                    <div class="etapa-validation" id="validation-gr-${coleta.id}">
                        <div class="validation-title">
                            <i class="fas fa-clipboard-check"></i>
                            Aprova√ß√£o GR Necess√°ria
                        </div>
                        <div class="validation-message">
                            Usu√°rio com fun√ß√£o GR deve aprovar ou reprovar esta coleta para continuar.
                        </div>
                        <div class="validation-actions">
                            <button class="btn-validation success" onclick="event.stopPropagation(); aprovarGR('${coleta.id}')">
                                <i class="fas fa-check"></i> Aprovar
                            </button>
                            <button class="btn-validation danger" onclick="event.stopPropagation(); reprovarGR('${coleta.id}')">
                                <i class="fas fa-times"></i> Reprovar
                            </button>
                            <button class="btn-validation warning" onclick="event.stopPropagation(); solicitarAtualizacaoDocumento('${coleta.id}')" ${!coleta.motorista_id ? 'disabled title="√â necess√°rio ter motorista vinculado"' : ''}>
                                <i class="fas fa-file-upload"></i> Solicitar Atualiza√ß√£o de Documento
                            </button>
                            <button class="btn-validation primary" onclick="event.stopPropagation(); voltarEtapa('${coleta.id}', 'contratacao')" ${!temPermissaoEtapa(coleta.etapa_atual) ? 'disabled title="Sem permiss√£o para esta etapa"' : ''}>
                                <i class="fas fa-arrow-left"></i> Voltar para Contrata√ß√£o
                            </button>
                        </div>
                    </div>
                ` : ''}

                <!-- Valida√ß√£o para etapa Contas a Pagar -->
                ${coleta.etapa_atual === 'contas_pagar' ? (() => {
                    // Tipo de pagamento selecionado ao mover para contas_pagar
                    const tipoPagamentoSelecionado = coleta.contas_pagar_tipo || null;
                    const tiposEspecificos = ['GNRE', 'PED√ÅGIO', 'GNRE + PED√ÅGIO', 'ADIANTAMENTO', 'SALDO', 'PAGAMENTO DE FRETE TOTAL'];
                    const tiposGenericos = ['adiantamento', 'saldo', 'pagamento_total', 'ambos'];
                    // Verificar se √© um tipo espec√≠fico (compara√ß√£o exata ou parcial para "GNRE + PED√ÅGIO")
                    const isTipoEspecifico = tipoPagamentoSelecionado && (
                        tiposEspecificos.some(t => tipoPagamentoSelecionado.trim() === t.trim()) ||
                        (tipoPagamentoSelecionado.includes('GNRE') && tipoPagamentoSelecionado.includes('PED√ÅGIO'))
                    );
                    const isTipoGenerico = tipoPagamentoSelecionado && tiposGenericos.includes(tipoPagamentoSelecionado.toLowerCase());
                    
                    // Verificar se j√° foi marcado como pago
                    const tipoPagamentoPago = coleta.contas_pagar_pago === true;
                    
                    // Verificar tipos gen√©ricos (quando foi marcado como pago usando tipos gen√©ricos)
                    const tipoPagoGenerico = isTipoGenerico ? tipoPagamentoSelecionado : null;
                    const adiantamentoPago = tipoPagoGenerico === 'adiantamento' || tipoPagoGenerico === 'pagamento_total' || tipoPagoGenerico === 'ambos';
                    const saldoPago = tipoPagoGenerico === 'saldo' || tipoPagoGenerico === 'pagamento_total' || tipoPagoGenerico === 'ambos';
                    const pagamentoTotalPago = tipoPagoGenerico === 'pagamento_total';
                    const ambosPagos = tipoPagoGenerico === 'ambos';
                    
                    // Badge com o tipo de pagamento selecionado (sempre vis√≠vel)
                    const tipoPagamentoBadge = tipoPagamentoSelecionado ? `
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.6rem 1rem; border-radius: 12px; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; font-weight: 600; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>Tipo de Pagamento: <strong>${tipoPagamentoSelecionado}</strong></span>
                        </div>
                    ` : '';
                    
                    // Se j√° foi marcado como pago, mostrar mensagem de sucesso
                    if (tipoPagamentoPago) {
                        return `
                            <div class="etapa-validation" style="background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(32, 201, 151, 0.1) 100%); border: 1px solid #28a745;">
                                ${tipoPagamentoBadge}
                                <div class="validation-title" style="color: #28a745;">
                                    <i class="fas fa-check-circle"></i>
                                    Pagamento Realizado
                                </div>
                                <div class="validation-message" style="color: #155724;">
                                    ‚úÖ ${tipoPagamentoSelecionado || 'Pagamento'} marcado como realizado em ${coleta.contas_pagar_data ? new Date(coleta.contas_pagar_data).toLocaleString('pt-BR') : 'data n√£o informada'} por ${coleta.contas_pagar_pago_por || 'Usu√°rio Desconhecido'}.
                                </div>
                            </div>
                        `;
                    }
                    
                    // Se algum pagamento gen√©rico foi realizado (mas n√£o completo), mostrar status e op√ß√µes pendentes
                    if (tipoPagoGenerico && tipoPagamentoPago && (adiantamentoPago || saldoPago) && !pagamentoTotalPago && !ambosPagos) {
                        const botoesPendentes = [];
                        
                        if (!adiantamentoPago) {
                            botoesPendentes.push(`
                                <button class="btn-validation success" onclick="event.stopPropagation(); marcarComoPago('${coleta.id}', 'adiantamento')" ${!coleta.motorista_id ? 'disabled title="√â necess√°rio ter motorista vinculado"' : !temPermissaoEtapa('contas_pagar') ? 'disabled title="Sem permiss√£o para esta etapa"' : ''} style="flex: 1; min-width: 180px;">
                                    <i class="fas fa-money-bill-wave"></i> Adiantamento de Frete
                                </button>
                            `);
                        }
                        
                        if (!saldoPago) {
                            botoesPendentes.push(`
                                <button class="btn-validation success" onclick="event.stopPropagation(); marcarComoPago('${coleta.id}', 'saldo')" ${!coleta.motorista_id ? 'disabled title="√â necess√°rio ter motorista vinculado"' : !temPermissaoEtapa('contas_pagar') ? 'disabled title="Sem permiss√£o para esta etapa"' : ''} style="flex: 1; min-width: 180px;">
                                    <i class="fas fa-wallet"></i> Saldo
                                </button>
                            `);
                        }
                        
                        if (!pagamentoTotalPago) {
                            botoesPendentes.push(`
                                <button class="btn-validation success" onclick="event.stopPropagation(); marcarComoPago('${coleta.id}', 'pagamento_total')" ${!coleta.motorista_id ? 'disabled title="√â necess√°rio ter motorista vinculado"' : !temPermissaoEtapa('contas_pagar') ? 'disabled title="Sem permiss√£o para esta etapa"' : ''} style="flex: 1; min-width: 180px;">
                                    <i class="fas fa-credit-card"></i> Pagamento Total
                                </button>
                            `);
                        }
                        
                        return `
                    <div class="etapa-validation" id="validation-contas_pagar-${coleta.id}">
                                ${tipoPagamentoBadge}
                        <div class="validation-title">
                            <i class="fas fa-money-check-alt"></i>
                                    ${tipoPagoGenerico === 'adiantamento' ? 'üíµ Adiantamento Pago - Pendente: Saldo' : tipoPagoGenerico === 'saldo' ? 'üí∞ Saldo Pago - Pendente: Adiantamento' : 'Pagamentos'}
                        </div>
                        <div class="validation-message">
                                    ${tipoPagoGenerico ? `${tipoPagoGenerico === 'adiantamento' ? 'üíµ Adiantamento' : tipoPagoGenerico === 'saldo' ? 'üí∞ Saldo' : '‚úÖ Pagamento'} marcado como realizado em ${coleta.contas_pagar_data ? new Date(coleta.contas_pagar_data).toLocaleString('pt-BR') : 'data n√£o informada'} por ${coleta.contas_pagar_pago_por || 'Usu√°rio Desconhecido'}.<br><br>` : ''}
                                    ${botoesPendentes.length > 0 ? 'Marque os pagamentos pendentes como realizados. O motorista e o criador da oportunidade ser√£o notificados.' : ''}
                        </div>
                                ${botoesPendentes.length > 0 ? `
                                    <div class="validation-actions" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 1rem;">
                                        ${botoesPendentes.join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                    
                    // Se nenhum pagamento foi realizado, mostrar APENAS o tipo selecionado
                    const botoesPagamento = [];
                    
                    // SEMPRE mostrar APENAS o tipo selecionado quando o usu√°rio moveu para contas_pagar
                    // N√£o mostrar op√ß√µes gen√©ricas se j√° foi selecionado um tipo espec√≠fico
                    if (tipoPagamentoSelecionado && !isTipoGenerico) {
                        // Mostrar APENAS o tipo espec√≠fico selecionado
                        botoesPagamento.push(`
                            <button class="btn-validation success" onclick="event.stopPropagation(); marcarTipoPagamentoEspecifico('${coleta.id}', '${String(tipoPagamentoSelecionado).replace(/'/g, "\\'").replace(/"/g, '&quot;')}')" ${!coleta.motorista_id ? 'disabled title="√â necess√°rio ter motorista vinculado"' : !temPermissaoEtapa('contas_pagar') ? 'disabled title="Sem permiss√£o para esta etapa"' : ''} style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-weight: 600; font-size: 0.95rem;">
                                <i class="${getIconeTipoPagamento(tipoPagamentoSelecionado)}"></i> 
                                Marcar ${tipoPagamentoSelecionado} como Pago
                            </button>
                        `);
                    } else if (!tipoPagamentoSelecionado || isTipoGenerico) {
                        // Se n√£o h√° tipo selecionado OU √© um tipo gen√©rico antigo, mostrar op√ß√µes gen√©ricas
                        botoesPagamento.push(`
                            <button class="btn-validation success" onclick="event.stopPropagation(); marcarComoPago('${coleta.id}', 'adiantamento')" ${!coleta.motorista_id ? 'disabled title="√â necess√°rio ter motorista vinculado"' : !temPermissaoEtapa('contas_pagar') ? 'disabled title="Sem permiss√£o para esta etapa"' : ''} style="flex: 1; min-width: 180px;">
                                <i class="fas fa-money-bill-wave"></i> Adiantamento de Frete
                            </button>
                        `);
                        botoesPagamento.push(`
                            <button class="btn-validation success" onclick="event.stopPropagation(); marcarComoPago('${coleta.id}', 'saldo')" ${!coleta.motorista_id ? 'disabled title="√â necess√°rio ter motorista vinculado"' : !temPermissaoEtapa('contas_pagar') ? 'disabled title="Sem permiss√£o para esta etapa"' : ''} style="flex: 1; min-width: 180px;">
                                <i class="fas fa-wallet"></i> Saldo
                            </button>
                        `);
                        botoesPagamento.push(`
                            <button class="btn-validation success" onclick="event.stopPropagation(); marcarComoPago('${coleta.id}', 'pagamento_total')" ${!coleta.motorista_id ? 'disabled title="√â necess√°rio ter motorista vinculado"' : !temPermissaoEtapa('contas_pagar') ? 'disabled title="Sem permiss√£o para esta etapa"' : ''} style="flex: 1; min-width: 180px;">
                                <i class="fas fa-credit-card"></i> Pagamento Total
                            </button>
                        `);
                    }
                    
                    return `
                    <div class="etapa-validation" id="validation-contas_pagar-${coleta.id}">
                        ${tipoPagamentoBadge}
                        <div class="validation-title">
                            <i class="fas fa-money-check-alt"></i>
                            Marcar como Pago
                        </div>
                        <div class="validation-message">
                            ${tipoPagamentoSelecionado 
                                ? `Tipo de pagamento selecionado: <strong>${tipoPagamentoSelecionado}</strong>. Marque como pago quando o pagamento for realizado. O motorista e o criador da oportunidade ser√£o notificados.`
                                : 'Selecione o tipo de pagamento realizado. O motorista e o criador da oportunidade ser√£o notificados.'
                            }
                    </div>
                        <div class="validation-actions" style="display: flex; gap: 10px; flex-wrap: wrap;">
                            ${botoesPagamento.join('')}
                        </div>
                        </div>
                    `;
                })() : ''}

                <div class="card-footer">
                    <div class="card-actions">
                        <button class="action-btn chat" onclick="event.stopPropagation(); openChatModal('${coleta.id}')">
                            <i class="fas fa-comment"></i> Chat
                        </button>
                        <button class="action-btn secondary" onclick="event.stopPropagation(); openMoverEtapaModal('${coleta.id}')" ${!temPermissaoEtapa(coleta.etapa_atual) ? 'disabled title="Sem permiss√£o para esta etapa"' : coleta.etapa_atual === 'contratacao' && !coleta.motorista_id ? 'disabled title="√â necess√°rio vincular um motorista para mover da etapa Contrata√ß√£o"' : ''}>
                            <i class="fas fa-arrows-alt-h"></i> Mover Etapa
                        </button>
                        <button class="action-btn primary" onclick="event.stopPropagation(); avancarEtapa('${coleta.id}')" ${coleta.etapa_atual === 'finalizar_operacao' ? 'disabled title="Use os bot√µes Ganhou/Perdeu para finalizar"' : coleta.etapa_atual === 'contratacao' && !coleta.motorista_id ? 'disabled' : coleta.etapa_atual === 'gr' && !coleta.gr_aprovado ? 'disabled' : !temPermissaoEtapa(coleta.etapa_atual) ? 'disabled title="Sem permiss√£o para esta etapa"' : ''}>
                            <i class="fas fa-arrow-right"></i> Avan√ßar
                        </button>
                        <button class="action-btn warning" onclick="event.stopPropagation(); openEditColetaModal('${coleta.id}')" ${!temPermissaoEtapa(coleta.etapa_atual) ? 'disabled title="Sem permiss√£o para esta etapa"' : ''}>
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        ${currentUser && (currentUser.isAdmin || currentUser.role === 'admin') ? `
                        <button class="action-btn danger" onclick="event.stopPropagation(); excluirColeta('${coleta.id}')">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                        ` : ''}
                        ${coleta.etapa_atual === 'finalizar_operacao' ? `
                            <button class="action-btn success" onclick="event.stopPropagation(); finalizarColeta('${coleta.id}', 'ganhou')" title="Coleta Ganhou!">
                                <i class="fas fa-trophy"></i> Ganhou
                            </button>
                            <button class="action-btn danger" onclick="event.stopPropagation(); finalizarColeta('${coleta.id}', 'perdeu')" title="Coleta Perdeu!">
                                <i class="fas fa-times-circle"></i> Perdeu
                            </button>
                        ` : ''}
                    </div>
                    <div class="card-date" style="display: flex; flex-direction: column; gap: 0.3rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-calendar"></i>
                            <span><strong>Data de Coleta:</strong> ${formatarData(coleta.data_recebimento)}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-calendar-check"></i>
                            <span><strong>Data de Entrega:</strong> ${coleta.data_entrega ? formatarData(coleta.data_entrega) : 'N√£o informada'}</span>
                        </div>
                    </div>
                </div>
            `;

            // Carrega o hist√≥rico para este card
            carregarHistoricoParaCard(coleta.id);
            
            // Atualizar cores da barra de progresso
            setTimeout(() => {
                ETAPAS.forEach((etapa, index) => {
                    const progressBar = card.querySelector(`.etapa-${etapa.id}`);
                    if (coleta.etapas_concluidas?.includes(etapa.id)) {
                        progressBar.style.opacity = '1';
                    } else if (coleta.etapa_atual === etapa.id) {
                        progressBar.style.opacity = '0.8';
                    } else {
                        progressBar.style.opacity = '0.2';
                    }
                });
            }, 100);

            return card;
        }

        // ========== MODAIS ==========
        // Fun√ß√£o global para abrir modal de nova coleta (chamada do HTML)
        // Redefinir com implementa√ß√£o completa (j√° foi definida no in√≠cio do script)
        function openNewColetaModal() {
            currentEditingId = null;
            modoCriacaoLote = false; // Resetar para modo √∫nico
            
            document.getElementById('modalTitle').textContent = 'Nova Coleta';
            document.getElementById('coletaForm').reset();
            document.getElementById('dataRecebimento').valueAsDate = new Date();
            document.getElementById('status').value = 'pendente';
            document.getElementById('prioridade').value = 'normal';
            document.getElementById('etapaAtual').value = 'comercial';
            document.getElementById('filial').value = ''; // N√£o preencher automaticamente, obrigar sele√ß√£o
            
            // Desmarcar checkbox de di√°ria
            const diariaCheckbox = document.getElementById('diaria');
            if (diariaCheckbox) {
                diariaCheckbox.checked = false;
                toggleCamposObrigatorios(); // Atualizar campos obrigat√≥rios
            }
            document.getElementById('numeroColeta').value = ''; // Limpar n√∫mero da coleta
            // Limpar classe de ve√≠culo e atualizar tipos
            const classeSelect = document.getElementById('classeVeiculo');
            if (classeSelect) {
                classeSelect.value = '';
                atualizarTiposVeiculoECarroceria();
            }
            
            // Resetar modo de cria√ß√£o (mostrar campo √∫nico, esconder m√∫ltiplos)
            const grupoNumero = document.getElementById('grupoNumeroColeta');
            const grupoMultiplos = document.getElementById('grupoMultiplosNumeros');
            const inputNumero = document.getElementById('numeroColeta');
            const textareaMultiplos = document.getElementById('multiplosNumeros');
            const previewNumeros = document.getElementById('previewNumeros');
            const modoTexto = document.getElementById('modoTexto');
            
            grupoNumero.style.display = 'block';
            grupoMultiplos.style.display = 'none';
            inputNumero.setAttribute('required', 'required');
            textareaMultiplos.removeAttribute('required');
            modoTexto.innerHTML = '<i class="fas fa-layer-group"></i> Criar M√∫ltiplas';
            previewNumeros.style.display = 'none';
            textareaMultiplos.value = '';
            
            // Mostrar bot√£o de alternar modo ao criar nova coleta
            const toggleModoLote = document.getElementById('toggleModoLote');
            if (toggleModoLote) toggleModoLote.style.display = 'block';
            
            // Limpar e desabilitar campo cliente
            const clienteSelect = document.getElementById('cliente');
            clienteSelect.innerHTML = '<option value="">Selecione primeiro a filial</option>';
            clienteSelect.disabled = true;
            
            // Limpar checkboxes de tipos de ve√≠culo e carroceria
            document.querySelectorAll('input[name="tiposVeiculo"]').forEach(checkbox => checkbox.checked = false);
            document.querySelectorAll('input[name="tiposCarroceria"]').forEach(checkbox => checkbox.checked = false);
            
            // Garantir que os campos sejam obrigat√≥rios ao abrir (se n√£o for di√°ria)
            toggleCamposObrigatorios();
            
            document.getElementById('coletaModal').classList.add('active');
        }
        
        // Salvar implementa√ß√£o completa e atualizar stub
        window._openNewColetaModalImpl = openNewColetaModal;
        window.openNewColetaModal = openNewColetaModal;

        // Fun√ß√£o para alternar campos obrigat√≥rios baseado no checkbox "Di√°ria"
        function toggleCamposObrigatorios() {
            const diariaCheckbox = document.getElementById('diaria');
            const isDiaria = diariaCheckbox?.checked || false;
            
            // Lista de campos obrigat√≥rios (ids e seus labels correspondentes)
            const camposObrigatorios = [
                { id: 'filial', labelText: 'Filial' },
                { id: 'numeroColeta', labelText: 'N¬∫ da Coleta' },
                { id: 'cliente', labelText: 'Cliente' },
                { id: 'dataRecebimento', labelText: 'Data de Coleta' },
                { id: 'dataEntrega', labelText: 'Data de Entrega' },
                { id: 'origem', labelText: 'Origem' },
                { id: 'destino', labelText: 'Destino' },
                { id: 'valor', labelText: 'Valor CTE (R$)' },
                { id: 'freteMotorista', labelText: 'Frete Motorista (R$)' },
                { id: 'km', labelText: 'KM' },
                { id: 'classeVeiculo', labelText: 'Classe do Ve√≠culo' }
            ];
            
            camposObrigatorios.forEach(campo => {
                const input = document.getElementById(campo.id);
                const label = document.querySelector(`label[for="${campo.id}"]`);
                
                if (input && label) {
                    if (isDiaria) {
                        // Remover obrigatoriedade
                        input.removeAttribute('required');
                        input.removeAttribute('aria-required');
                        // Remover asterisco e classe do label
                        label.classList.remove('required');
                        // Remover asterisco do texto (qualquer formato)
                        let labelText = label.innerHTML;
                        labelText = labelText.replace(/\s*\*\s*$/, ''); // Remove asterisco no final
                        labelText = labelText.replace(/\s*\*\s*</, ' <'); // Remove asterisco antes de tag
                        labelText = labelText.replace(/\s*\*\s*/, ' '); // Remove asterisco no meio
                        label.innerHTML = labelText;
                    } else {
                        // Adicionar obrigatoriedade
                        input.setAttribute('required', 'required');
                        input.setAttribute('aria-required', 'true');
                        // Adicionar classe required ao label
                        label.classList.add('required');
                        // Garantir que o asterisco esteja presente
                        let labelText = label.innerHTML;
                        // Verificar se j√° tem asterisco (em qualquer formato)
                        if (!labelText.includes('*') && !labelText.includes('required-asterisk')) {
                            // Adicionar asterisco no final do texto do label
                            // Se o label tem HTML (como √≠cones), adicionar ap√≥s o √∫ltimo texto
                            if (labelText.includes('<')) {
                                // Se tem HTML, adicionar antes do fechamento da tag ou no final
                                labelText = labelText.replace(/([^>])(<\/label>|$)/, '$1 <span class="required-asterisk">*</span>$2');
                            } else {
                                // Se n√£o tem HTML, adicionar no final
                                labelText = labelText + ' <span class="required-asterisk">*</span>';
                            }
                            label.innerHTML = labelText;
                        } else if (labelText.includes('*') && !labelText.includes('required-asterisk')) {
                            // Se j√° tem asterisco mas n√£o tem a classe, converter para o formato estilizado
                            // Remover asterisco simples e adicionar o estilizado
                            labelText = labelText.replace(/\s*\*\s*$/, ' <span class="required-asterisk">*</span>');
                            labelText = labelText.replace(/\s*\*\s*</, ' <span class="required-asterisk">*</span> <');
                            labelText = labelText.replace(/\s*\*\s*/, ' <span class="required-asterisk">*</span> ');
                            if (!labelText.includes('required-asterisk')) {
                                labelText = labelText + ' <span class="required-asterisk">*</span>';
                            }
                            label.innerHTML = labelText;
                        }
                    }
                }
            });
            
            // Tratar campo de m√∫ltiplos n√∫meros separadamente
            const multiplosNumeros = document.getElementById('multiplosNumeros');
            const labelMultiplos = document.querySelector('label[for="multiplosNumeros"]');
            if (multiplosNumeros && labelMultiplos) {
                if (isDiaria) {
                    multiplosNumeros.removeAttribute('required');
                    labelMultiplos.classList.remove('required');
                    let labelText = labelMultiplos.innerHTML;
                    labelText = labelText.replace(/\s*\*\s*$/, '');
                    labelText = labelText.replace(/\s*<span class="required-asterisk">\*<\/span>\s*/g, '');
                    labelMultiplos.innerHTML = labelText;
                } else {
                    // S√≥ adicionar required se estiver em modo lote
                    if (modoCriacaoLote) {
                        multiplosNumeros.setAttribute('required', 'required');
                        labelMultiplos.classList.add('required');
                        if (!labelMultiplos.innerHTML.includes('*') && !labelMultiplos.innerHTML.includes('required-asterisk')) {
                            let labelText = labelMultiplos.innerHTML;
                            // Adicionar asterisco ap√≥s "N√∫meros das Coletas"
                            labelText = labelText.replace(/(N√∫meros das Coletas)/, '$1 <span class="required-asterisk">*</span>');
                            labelMultiplos.innerHTML = labelText;
                        }
                    }
                }
            }
            
            // Tratar labels de Tipos de Ve√≠culo e Carroceria (que n√£o t√™m for attribute, mas t√™m √≠cones)
            const labelsFullWidth = document.querySelectorAll('.form-group.full-width label');
            labelsFullWidth.forEach(label => {
                const labelText = label.innerHTML;
                const isTiposVeiculo = labelText.includes('fa-truck') || labelText.includes('Tipos de Ve√≠culo');
                const isTiposCarroceria = labelText.includes('fa-box') || labelText.includes('Tipos de Carroceria');
                
                if (isTiposVeiculo || isTiposCarroceria) {
                    if (isDiaria) {
                        label.classList.remove('required');
                        let text = label.innerHTML;
                        text = text.replace(/\s*\*\s*$/, '');
                        text = text.replace(/\s*<span class="required-asterisk">\*<\/span>\s*/g, '');
                        label.innerHTML = text;
                    } else {
                        label.classList.add('required');
                        if (!label.innerHTML.includes('*') && !label.innerHTML.includes('required-asterisk')) {
                            let text = label.innerHTML;
                            text = text + ' <span class="required-asterisk">*</span>';
                            label.innerHTML = text;
                        }
                    }
                }
            });
        }
        
        // Expor fun√ß√£o globalmente
        window.toggleCamposObrigatorios = toggleCamposObrigatorios;

        async function openEditColetaModal(coletaId) {
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta) return;

            // üîê Verificar permiss√£o para a etapa atual (mas permitir visualiza√ß√£o)
            const temPermissao = temPermissaoEtapa(coleta.etapa_atual);
            
            // N√£o bloquear abertura do modal - apenas desabilitar edi√ß√£o se n√£o tiver permiss√£o
            // O modal ser√° aberto em modo "somente leitura" se n√£o tiver permiss√£o

            currentEditingId = coletaId;
            
            // Desabilitar modo lote ao editar (sempre editar uma coleta por vez)
            modoCriacaoLote = false;
            const grupoNumero = document.getElementById('grupoNumeroColeta');
            const grupoMultiplos = document.getElementById('grupoMultiplosNumeros');
            const toggleModoLote = document.getElementById('toggleModoLote');
            if (grupoNumero) grupoNumero.style.display = 'block';
            if (grupoMultiplos) grupoMultiplos.style.display = 'none';
            if (toggleModoLote) toggleModoLote.style.display = 'none'; // Esconder bot√£o de alternar modo ao editar
            
            // Definir t√≠tulo do modal de forma amig√°vel
            let tituloModal = 'Editar Coleta';
            if (coleta.filial && coleta.numero_coleta) {
                tituloModal = `Editar Coleta - ${coleta.filial} #${coleta.numero_coleta}`;
            } else if (coleta.cliente) {
                tituloModal = `Editar Coleta - ${coleta.cliente}`;
            }
            document.getElementById('modalTitle').textContent = tituloModal;
            
            // Preencher formul√°rio
            document.getElementById('filial').value = coleta.filial || '';
            document.getElementById('numeroColeta').value = coleta.numero_coleta || '';
            
            // Filtrar clientes baseado na filial e depois selecionar o cliente
            filtrarClientesPorFilial();
            // Aguardar um pouco para garantir que as op√ß√µes foram carregadas antes de selecionar
            setTimeout(() => {
            document.getElementById('cliente').value = coleta.cliente || '';
            }, 100);
            
            // Converter data_recebimento (timestamp) para formato de input date (YYYY-MM-DD)
            let dataRecebimentoValue = '';
            if (coleta.data_recebimento) {
                const data = new Date(coleta.data_recebimento);
                const ano = data.getFullYear();
                const mes = String(data.getMonth() + 1).padStart(2, '0');
                const dia = String(data.getDate()).padStart(2, '0');
                dataRecebimentoValue = `${ano}-${mes}-${dia}`;
            }
            document.getElementById('dataRecebimento').value = dataRecebimentoValue;
            
            // Converter data_entrega (timestamp) para formato de input date (YYYY-MM-DD)
            let dataEntregaValue = '';
            if (coleta.data_entrega) {
                const data = new Date(coleta.data_entrega);
                const ano = data.getFullYear();
                const mes = String(data.getMonth() + 1).padStart(2, '0');
                const dia = String(data.getDate()).padStart(2, '0');
                dataEntregaValue = `${ano}-${mes}-${dia}`;
            }
            document.getElementById('dataEntrega').value = dataEntregaValue;
            
            document.getElementById('origem').value = coleta.origem || '';
            document.getElementById('destino').value = coleta.destino || '';
            document.getElementById('valor').value = coleta.valor || '';
            document.getElementById('freteMotorista').value = coleta.frete_motorista || '';
            document.getElementById('km').value = coleta.km || '';
            
            // Preencher checkboxes de tipos de ve√≠culo
            const checkboxesVeiculo = document.querySelectorAll('input[name="tiposVeiculo"]');
            checkboxesVeiculo.forEach(checkbox => {
                checkbox.checked = coleta.tipos_veiculo && coleta.tipos_veiculo.includes(checkbox.value);
            });
            
            // Preencher checkboxes de tipos de carroceria
            const checkboxesCarroceria = document.querySelectorAll('input[name="tiposCarroceria"]');
            checkboxesCarroceria.forEach(checkbox => {
                checkbox.checked = coleta.tipos_carroceria && coleta.tipos_carroceria.includes(checkbox.value);
            });
            
            document.getElementById('status').value = coleta.status || 'pendente';
            document.getElementById('prioridade').value = coleta.prioridade || 'normal';
            document.getElementById('etapaAtual').value = coleta.etapa_atual || 'comercial';
            document.getElementById('observacoes').value = coleta.observacoes || '';
            
            // Preencher checkbox de di√°ria
            const diariaCheckbox = document.getElementById('diaria');
            if (diariaCheckbox) {
                diariaCheckbox.checked = coleta.diaria === true || coleta.diaria === 'true' || coleta.diaria === 1;
            }
            
            // üîê Desabilitar campo de etapa se n√£o tiver permiss√£o
            const etapaSelect = document.getElementById('etapaAtual');
            etapaSelect.disabled = true; // Sempre desabilitar mudan√ßa de etapa no modal (use os bot√µes Avan√ßar/Voltar)
            etapaSelect.title = 'Use os bot√µes Avan√ßar/Voltar para mudar a etapa';
            
            // üîê Desabilitar campos de edi√ß√£o se n√£o tiver permiss√£o (modo somente leitura)
            const camposEditaveis = ['filial', 'numeroColeta', 'cliente', 'dataRecebimento', 'dataEntrega', 
                                     'origem', 'destino', 'valor', 'km', 'status', 'prioridade', 'observacoes'];
            const botaoSalvar = document.querySelector('#coletaForm button[type="submit"]');
            
            if (!temPermissao) {
                // Modo somente leitura - desabilitar todos os campos
                camposEditaveis.forEach(campoId => {
                    const campo = document.getElementById(campoId);
                    if (campo) {
                        campo.disabled = true;
                        campo.readOnly = true;
                    }
                });
                
                // Desabilitar checkboxes
                document.querySelectorAll('input[name="tiposVeiculo"], input[name="tiposCarroceria"]').forEach(cb => {
                    cb.disabled = true;
                });
                
                // Desabilitar bot√£o salvar
                if (botaoSalvar) {
                    botaoSalvar.disabled = true;
                    botaoSalvar.title = 'Voc√™ n√£o tem permiss√£o para editar coletas nesta etapa';
                    botaoSalvar.style.opacity = '0.5';
                    botaoSalvar.style.cursor = 'not-allowed';
                }
                
                // Atualizar t√≠tulo do modal
                document.getElementById('modalTitle').textContent = tituloModal.replace('Editar', 'Visualizar');
            } else {
                // Modo edi√ß√£o - habilitar todos os campos
                camposEditaveis.forEach(campoId => {
                    const campo = document.getElementById(campoId);
                    if (campo) {
                        campo.disabled = false;
                        campo.readOnly = false;
                    }
                });
                
                document.querySelectorAll('input[name="tiposVeiculo"], input[name="tiposCarroceria"]').forEach(cb => {
                    cb.disabled = false;
                });
                
                if (botaoSalvar) {
                    botaoSalvar.disabled = false;
                    botaoSalvar.title = '';
                    botaoSalvar.style.opacity = '1';
                    botaoSalvar.style.cursor = 'pointer';
                }
            }
            
            document.getElementById('coletaModal').classList.add('active');
        }

        // Formul√°rio de coleta
        document.getElementById('coletaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const rawData = Object.fromEntries(formData);
            
            // ========== VALIDA√á√ÉO CENTRALIZADA ==========
            // Coletar tipos de ve√≠culo e carroceria selecionados
            const tiposVeiculoSelecionadosValidacao = Array.from(document.querySelectorAll('input[name="tiposVeiculo"]:checked')).map(cb => cb.value);
            const tiposCarroceriaSelecionadosValidacao = Array.from(document.querySelectorAll('input[name="tiposCarroceria"]:checked')).map(cb => cb.value);
            
            // Preparar dados para valida√ß√£o
            const dadosParaValidacao = {
                ...rawData,
                numero_coleta: rawData.numeroColeta || rawData.numero_coleta,
                data_recebimento: rawData.dataRecebimento || rawData.data_recebimento,
                data_entrega: rawData.dataEntrega || rawData.data_entrega,
                tiposVeiculo: tiposVeiculoSelecionadosValidacao,
                tiposCarroceria: tiposCarroceriaSelecionadosValidacao,
                classeVeiculo: rawData.classeVeiculo,
                valor: rawData.valor ? parseFloat(rawData.valor) : 0,
                frete_motorista: rawData.freteMotorista ? parseFloat(rawData.freteMotorista) : 0,
                km: rawData.km ? parseFloat(rawData.km) : 0
            };
            
            // Verificar se √© di√°ria
            const isDiaria = document.getElementById('diaria')?.checked || false;
            
            // Validar apenas se for cria√ß√£o de nova coleta (n√£o edi√ß√£o) E n√£o for di√°ria
            // Pular valida√ß√£o se estiver em modo lote (a valida√ß√£o ser√° feita dentro da fun√ß√£o criarMultiplasColetas)
            // Pular valida√ß√£o se for di√°ria (nenhum campo √© obrigat√≥rio)
            if (!currentEditingId && !modoCriacaoLote && !isDiaria) {
                if (!Validator.validateAndShowErrors(dadosParaValidacao)) {
                    // Scroll para o primeiro erro
                    const firstError = document.querySelector('.field-input-error');
                    if (firstError) {
                        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstError.focus();
                    }
                    return;
                }
            }
            
            // üîê Verificar se est√° editando e se tem permiss√£o
            if (currentEditingId) {
                const coleta = coletasData.find(c => c.id === currentEditingId);
                if (coleta && !temPermissaoEtapa(coleta.etapa_atual)) {
                    showNotification('‚ö†Ô∏è Voc√™ n√£o tem permiss√£o para editar coletas nesta etapa', 'warning');
                    return;
                }
                
                // N√£o permitir mudan√ßa de etapa atrav√©s do formul√°rio
                rawData.etapaAtual = coleta.etapa_atual;
            }
            
            // ========== MODO CRIA√á√ÉO EM LOTE ==========
            if (modoCriacaoLote && !currentEditingId) {
                console.log('üîÑ Modo cria√ß√£o em lote ativado');
                const multiplosNumerosInput = document.getElementById('multiplosNumeros');
                
                if (!multiplosNumerosInput) {
                    console.error('‚ùå Campo multiplosNumeros n√£o encontrado');
                    showNotification('‚ö†Ô∏è Erro: Campo de m√∫ltiplos n√∫meros n√£o encontrado', 'error');
                    return;
                }
                
                const multiplosNumerosValue = multiplosNumerosInput.value.trim();
                console.log('üìù N√∫meros informados:', multiplosNumerosValue);
                
                if (!multiplosNumerosValue) {
                    showNotification('‚ö†Ô∏è Por favor, informe os n√∫meros das coletas', 'warning');
                    return;
                }
                
                const numerosColetas = parsearMultiplosNumeros(multiplosNumerosValue);
                console.log('üî¢ N√∫meros processados:', numerosColetas);
                
                if (numerosColetas.length === 0) {
                    showNotification('‚ö†Ô∏è Nenhum n√∫mero v√°lido encontrado. Use v√≠rgulas ou intervalos (ex: 5565,5566 ou 5565-5569)', 'warning');
                    return;
                }
                
                // Validar campos obrigat√≥rios apenas se n√£o for di√°ria
                if (!isDiaria) {
                    if (!rawData.filial) {
                        showNotification('‚ö†Ô∏è Por favor, selecione a filial', 'warning');
                        return;
                    }
                    
                    if (!rawData.cliente) {
                        showNotification('‚ö†Ô∏è Por favor, selecione o cliente', 'warning');
                        return;
                    }
                    
                    // Validar tipos de ve√≠culo e carroceria
                    const tiposVeiculoSelecionados = Array.from(document.querySelectorAll('input[name="tiposVeiculo"]:checked'));
                    const tiposCarroceriaSelecionados = Array.from(document.querySelectorAll('input[name="tiposCarroceria"]:checked'));
                    
                    if (tiposVeiculoSelecionados.length === 0) {
                        showNotification('‚ö†Ô∏è Por favor, selecione pelo menos um tipo de ve√≠culo', 'warning');
                        return;
                    }
                    
                    if (tiposCarroceriaSelecionados.length === 0) {
                        showNotification('‚ö†Ô∏è Por favor, selecione pelo menos um tipo de carroceria', 'warning');
                        return;
                    }
                }
                
                console.log('‚úÖ Valida√ß√µes passadas, criando m√∫ltiplas coletas...');
                // Criar m√∫ltiplas coletas
                await criarMultiplasColetas(rawData, numerosColetas);
                return; // Sair da fun√ß√£o ap√≥s criar m√∫ltiplas
            }
            
            // ========== MODO CRIA√á√ÉO √öNICA ==========
            // Validar e processar n√∫mero da coleta (remover zeros √† esquerda)
            let numeroColeta = rawData.numeroColeta ? rawData.numeroColeta.trim() : '';
            if (numeroColeta) {
                // Remover zeros √† esquerda convertendo para n√∫mero e depois para string
                numeroColeta = String(parseInt(numeroColeta, 10));
                if (numeroColeta === 'NaN' || numeroColeta === '0') {
                    showNotification('‚ö†Ô∏è N√∫mero da coleta inv√°lido. Digite apenas n√∫meros (ex: 5565)', 'warning');
                    return;
                }
            }
            
            // Validar campos obrigat√≥rios para nova coleta (apenas se n√£o for di√°ria)
            if (!currentEditingId && !isDiaria) {
                if (!rawData.filial) {
                    showNotification('‚ö†Ô∏è Por favor, selecione a filial', 'warning');
                    return;
                }
                if (!numeroColeta) {
                    showNotification('‚ö†Ô∏è Por favor, informe o n√∫mero da coleta', 'warning');
                    return;
                }
                
                // Validar duplicidade (filial + n√∫mero da coleta) antes de criar
                try {
                    if (!supabaseClient) {
                        console.error('‚ùå Supabase n√£o inicializado');
                        showNotification('Erro: Supabase n√£o inicializado', 'error');
                        return;
                    }
                    
                    const { data: coletasExistentes, error: buscaError } = await supabaseClient
                        .from('coletas')
                        .select('id, filial, numero_coleta, etapa_atual, cliente, origem, destino')
                        .eq('filial', rawData.filial)
                        .eq('numero_coleta', numeroColeta);
                    
                    if (buscaError) {
                        console.error('‚ùå Erro ao verificar duplicidade:', buscaError);
                        // Continuar mesmo com erro na busca (n√£o bloquear cria√ß√£o)
                    } else if (coletasExistentes && coletasExistentes.length > 0) {
                        const coletaExistente = coletasExistentes[0];
                        const etapaNome = ETAPAS.find(e => e.id === coletaExistente.etapa_atual)?.nome || coletaExistente.etapa_atual;
                        showNotification(
                            `‚ö†Ô∏è J√° existe uma coleta com a filial ${rawData.filial} e n√∫mero ${numeroColeta}!\n\n` +
                            `üìç Localiza√ß√£o: ${coletaExistente.cliente || 'N/A'} (${coletaExistente.origem || 'N/A'} ‚Üí ${coletaExistente.destino || 'N/A'})\n` +
                            `üìä Etapa atual: ${etapaNome}\n` +
                            `üÜî ID: ${coletaExistente.id}`,
                            'warning',
                            10000 // Mostrar por 10 segundos
                        );
                        return;
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao verificar duplicidade:', error);
                    // Continuar mesmo com erro (n√£o bloquear cria√ß√£o)
                }
            }
            
            // ‚úÖ INCLUI a etapaAtual do formul√°rio
            // Converter data de recebimento para formato ISO (YYYY-MM-DD -> YYYY-MM-DDTHH:MM:SS)
            let dataRecebimento = rawData.dataRecebimento;
            if (dataRecebimento) {
                // Se tiver apenas a data, adicionar hor√°rio (meio-dia UTC)
                if (dataRecebimento.length === 10) {
                    dataRecebimento = dataRecebimento + 'T12:00:00.000Z';
                }
            }
            
            // Converter data de entrega para formato ISO (YYYY-MM-DD -> YYYY-MM-DDTHH:MM:SS)
            let dataEntrega = rawData.dataEntrega;
            if (dataEntrega) {
                // Se tiver apenas a data, adicionar hor√°rio (meio-dia UTC)
                if (dataEntrega.length === 10) {
                    dataEntrega = dataEntrega + 'T12:00:00.000Z';
                }
            }
            
            // Coletar tipos de ve√≠culo selecionados
            const tiposVeiculoSelecionados = Array.from(document.querySelectorAll('input[name="tiposVeiculo"]:checked'))
                .map(checkbox => checkbox.value);
            
            // Coletar tipos de carroceria selecionados
            const tiposCarroceriaSelecionados = Array.from(document.querySelectorAll('input[name="tiposCarroceria"]:checked'))
                .map(checkbox => checkbox.value);
            
            // Verificar se √© di√°ria (para uso no coletaData)
            const isDiariaData = document.getElementById('diaria')?.checked || false;
            
            const coletaData = {
                filial: rawData.filial,
                numero_coleta: numeroColeta || null,
                cliente: rawData.cliente,
                data_recebimento: dataRecebimento,
                data_entrega: dataEntrega || null,
                origem: rawData.origem,
                destino: rawData.destino,
                valor: parseFloat(rawData.valor) || 0,
                frete_motorista: parseFloat(rawData.freteMotorista) || 0,
                km: parseFloat(rawData.km) || 0,
                tipos_veiculo: tiposVeiculoSelecionados,
                tipos_carroceria: tiposCarroceriaSelecionados,
                status: rawData.status,
                etapa_atual: rawData.etapaAtual, 
                prioridade: rawData.prioridade || 'normal',
                observacoes: rawData.observacoes,
                diaria: isDiariaData
            };
            
            // ‚úÖ SEGURAN√áA: Logs condicionais apenas em desenvolvimento
            if (window.DEBUG || window.location.hostname === 'localhost') {
            console.log('üìù Dados do formul√°rio:', coletaData); // ‚Üê Para debug
            console.log('üîç Raw form data:', rawData);
            console.log('üîç etapaAtual value:', rawData.etapaAtual);
            }

            try {
                await salvarColeta(coletaData);
                closeModal();
            } catch (error) {
                // Erro j√° tratado
            }
        });

        // ========== SISTEMA DE ANEXOS ==========
        async function abrirModalAnexos(coletaId) {
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta) return;
            
            currentAnexosColetaId = coletaId;
            
            // Definir t√≠tulo do modal de anexos de forma amig√°vel
            let tituloAnexos = 'Anexos da Coleta';
            if (coleta.filial && coleta.numero_coleta) {
                tituloAnexos = `Anexos - ${coleta.filial} #${coleta.numero_coleta}`;
            } else if (coleta.cliente) {
                tituloAnexos = `Anexos - ${coleta.cliente}`;
            }
            document.getElementById('modalAnexosTitle').textContent = tituloAnexos;
            
            // Resetar o modal
            document.getElementById('selectedFiles').style.display = 'none';
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('btnUpload').disabled = true;
            document.getElementById('filesList').innerHTML = '';
            selectedFiles = [];
            
            // Resetar categoria e t√≠tulo do contrato
            const categoriaSelect = document.getElementById('anexoCategoriaSelect');
            if (categoriaSelect) {
                categoriaSelect.value = '';
            }
            const tituloContainer = document.getElementById('tituloContratoContainerModal');
            if (tituloContainer) {
                tituloContainer.style.display = 'none';
            }
            const tituloInput = document.getElementById('tituloContratoInputModal');
            if (tituloInput) {
                tituloInput.value = '';
            }
            
            // Carregar lista de anexos existentes
            await carregarListaAnexos(coleta);
            
            // Garantir que o input file est√° configurado corretamente
            configurarEventListenersModalAnexos();
            
            document.getElementById('anexosModal').classList.add('active');
        }

        function configurarEventListenersModalAnexos() {
            // Garantir que o input file tem o event listener correto
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                // Remover listeners antigos clonando o elemento
                const newInput = fileInput.cloneNode(true);
                fileInput.parentNode.replaceChild(newInput, fileInput);
                
                // Adicionar novo listener
                newInput.addEventListener('change', function(e) {
                    if (e.target.files && e.target.files.length > 0) {
                        handleFileSelect(e.target.files);
                    }
                });
            }
            
            // Garantir que o bot√£o de upload est√° configurado
            const btnUpload = document.getElementById('btnUpload');
            if (btnUpload) {
                // Remover listeners antigos
                const newBtn = btnUpload.cloneNode(true);
                btnUpload.parentNode.replaceChild(newBtn, btnUpload);
                
                // Adicionar novo listener
                newBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    fazerUpload();
                });
            }
            
            // Garantir que o select de categoria atualiza o bot√£o
            const categoriaSelect = document.getElementById('anexoCategoriaSelect');
            if (categoriaSelect) {
                categoriaSelect.addEventListener('change', function() {
                    // Atualizar estado do bot√£o quando categoria mudar
                    const btnUpload = document.getElementById('btnUpload');
                    if (btnUpload && selectedFiles.length > 0) {
                        btnUpload.disabled = !this.value || selectedFiles.length === 0;
                    }
                    toggleTituloContratoModal(this.value);
                });
            }
        }

        async function carregarListaAnexos(coleta) {
            const anexosList = document.getElementById('anexosListModal');
            const anexos = await carregarAnexos(coleta.id);
            
            if (!anexos || anexos.length === 0) {
                anexosList.innerHTML = `
                    <div style="text-align: center; color: #6c757d; padding: 2rem;">
                        <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>Nenhum anexo adicionado ainda</p>
                    </div>
                `;
                return;
            }
            
            // Agrupar anexos por categoria
            const anexosPorCategoria = {};
            anexos.forEach(anexo => {
                const categoria = anexo.categoria || anexo.area || 'outros';
                if (!anexosPorCategoria[categoria]) {
                    anexosPorCategoria[categoria] = [];
                }
                anexosPorCategoria[categoria].push(anexo);
            });
            
            const categoriasOrdenadas = [
                'documentos_motorista',
                'documentos_proprietario',
                'documentos_veiculo',
                'evidencias',
                'faturamento',
                'notas_fiscais',
                'contratos',
                'outros'
            ];
            
            anexosList.innerHTML = `
                <h6 style="margin-bottom: 1.5rem; color: var(--azul-escuro); font-size: 1.1rem; font-weight: 600;">
                    <i class="fas fa-paperclip"></i> Anexos organizados por categoria:
                </h6>
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    ${categoriasOrdenadas.map(categoria => {
                        const anexosCategoria = anexosPorCategoria[categoria] || [];
                        if (anexosCategoria.length === 0) return '';
                        
                        const corCategoria = obterCorCategoria(categoria);
                        const iconeCategoria = obterIconeCategoria(categoria);
                        const nomeCategoria = obterNomeCategoria(categoria);
                        
                        return `
                            <div style="border: 2px solid ${corCategoria}30; border-radius: 10px; padding: 1rem; background: ${corCategoria}08;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid ${corCategoria}30;">
                                    <i class="fas ${iconeCategoria}" style="color: ${corCategoria}; font-size: 1.3rem;"></i>
                                    <h6 style="margin: 0; color: ${corCategoria}; font-size: 1rem; font-weight: 700;">
                                        ${nomeCategoria}
                                    </h6>
                                    <span style="background: ${corCategoria}; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600; margin-left: auto;">
                                        ${anexosCategoria.length}
                                    </span>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                    ${anexosCategoria.map(anexo => `
                                        <div class="file-item" style="border-left: 3px solid ${corCategoria};">
                        <div class="file-info">
                            <div class="file-icon ${getFileIconClass(anexo.tipo_arquivo)}">
                                <i class="fas ${getFileIcon(anexo.tipo_arquivo)}"></i>
                            </div>
                            <div class="file-details">
                                <div class="file-name">${anexo.nome_arquivo}</div>
                                <div class="file-size">${formatFileSize(anexo.tamanho)}</div>
                            </div>
                        </div>
                        <div class="anexo-actions">
                            <button class="btn-anexo-action btn-anexo-view" onclick="visualizarAnexo('${anexo.id}')" title="Visualizar">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-anexo-action btn-anexo-download" onclick="downloadAnexoDireto('${anexo.id}')" title="Baixar">
                                <i class="fas fa-download"></i>
                            </button>
                                                ${currentUser && (currentUser.isAdmin || currentUser.role === 'admin') ? `
                            <button class="btn-anexo-action btn-anexo-delete" onclick="excluirAnexo('${anexo.id}')" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                                                ` : ''}
                        </div>
                    </div>
                `).join('')}
                                </div>
                            </div>
                        `;
                    }).filter(html => html !== '').join('')}
                </div>
            `;
        }

        // Fun√ß√£o para mostrar/ocultar campo de t√≠tulo do contrato
        function toggleTituloContratoModal(categoria) {
            const tituloContainer = document.getElementById('tituloContratoContainerModal');
            const tituloInput = document.getElementById('tituloContratoInputModal');
            
            if (categoria === 'contratos') {
                if (tituloContainer) {
                    tituloContainer.style.display = 'block';
                    if (tituloInput) tituloInput.required = true;
                }
            } else {
                if (tituloContainer) {
                    tituloContainer.style.display = 'none';
                    if (tituloInput) {
                        tituloInput.value = '';
                        tituloInput.required = false;
                    }
                }
            }
        }
        
        // Expor fun√ß√µes globalmente para uso em inline handlers
        window.toggleTituloContratoModal = toggleTituloContratoModal;
        window.handleFileSelect = handleFileSelect;
        window.fazerUpload = fazerUpload;
        window.removerArquivo = removerArquivo;
        window.configurarEventListenersModalAnexos = configurarEventListenersModalAnexos;

        async function fazerUpload() {
            if (!currentAnexosColetaId || selectedFiles.length === 0) return;

            // Verificar se categoria foi selecionada
            const categoriaSelect = document.getElementById('anexoCategoriaSelect');
            const categoria = categoriaSelect ? categoriaSelect.value : null;
            
            if (!categoria) {
                showNotification('‚ö†Ô∏è Selecione uma categoria antes de enviar os arquivos', 'warning');
                return;
            }
            
            // Verificar t√≠tulo do contrato se categoria for contratos
            let tituloContrato = null;
            if (categoria === 'contratos') {
                const tituloInput = document.getElementById('tituloContratoInputModal');
                if (tituloInput) {
                    tituloContrato = tituloInput.value.trim();
                    if (!tituloContrato) {
                        showNotification('‚ö†Ô∏è Por favor, informe o t√≠tulo do contrato', 'warning');
                        return;
                    }
                }
            }

            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const uploadProgress = document.getElementById('uploadProgress');
            
            uploadProgress.style.display = 'block';
            document.getElementById('btnUpload').disabled = true;
            
            try {
                for (let i = 0; i < selectedFiles.length; i++) {
                    const file = selectedFiles[i];
                    const progress = ((i + 1) / selectedFiles.length) * 100;
                    
                    progressFill.style.width = progress + '%';
                    progressText.textContent = Math.round(progress) + '%';
                    
                    await uploadAnexo(currentAnexosColetaId, file, categoria, tituloContrato);
                }
                
                showNotification('Arquivos enviados com sucesso!', 'success');
                
                // Recarregar a lista de anexos
                const coleta = coletasData.find(c => c.id === currentAnexosColetaId);
                if (coleta) {
                    await carregarListaAnexos(coleta);
                }
                
                // Resetar interface
                document.getElementById('selectedFiles').style.display = 'none';
                document.getElementById('uploadProgress').style.display = 'none';
                document.getElementById('filesList').innerHTML = '';
                if (categoriaSelect) categoriaSelect.value = '';
                const tituloInput = document.getElementById('tituloContratoInputModal');
                if (tituloInput) {
                    tituloInput.value = '';
                    tituloInput.required = false;
                }
                const tituloContainer = document.getElementById('tituloContratoContainerModal');
                if (tituloContainer) tituloContainer.style.display = 'none';
                selectedFiles = [];
                
                // Atualizar cards
                await carregarColetas();
                
            } catch (error) {
                showNotification('Erro ao fazer upload: ' + error.message, 'error');
            } finally {
                document.getElementById('btnUpload').disabled = false;
            }
        }

        // ========== SISTEMA DE CHAT ==========
        async function openChatModal(coletaId) {
            currentChatColetaId = coletaId;
            const coleta = coletasData.find(c => c.id === coletaId);
            
            if (!coleta) return;
            
            // Definir identifica√ß√£o da coleta de forma amig√°vel
            let identificacaoColeta = 'Coleta';
            if (coleta.filial && coleta.numero_coleta) {
                identificacaoColeta = `${coleta.filial} #${coleta.numero_coleta}`;
            } else if (coleta.cliente) {
                identificacaoColeta = coleta.cliente;
            }
            document.getElementById('chatColetaId').textContent = identificacaoColeta;
            document.getElementById('chatCliente').textContent = coleta.cliente;
            
            // Carregar mensagens
            await carregarMensagensChatModal(coletaId);
            
            setTimeout(() => {
                document.getElementById('chatInput').focus();
            }, 300);
            
            document.getElementById('chatModal').classList.add('active');
        }

        async function carregarMensagensChatModal(coletaId) {
            const chatMessagesContainer = document.getElementById('chatMessages');
            chatMessagesContainer.innerHTML = '';
            
            const mensagens = await carregarMensagensChat(coletaId);
            
            if (mensagens.length === 0) {
                // Mensagem inicial do sistema
                const systemMessage = {
                    id: 'msg-1',
                    usuario: 'Sistema',
                    mensagem: 'Chat iniciado para esta coleta. Use este espa√ßo para comunica√ß√£o interna sobre a opera√ß√£o.',
                    tipo: 'system',
                    created_at: new Date().toISOString()
                };
                mensagens.push(systemMessage);
            }
            
            // Renderizar mensagens
            mensagens.forEach(msg => {
                const messageElement = document.createElement('div');
                
                if (msg.tipo === 'system') {
                    messageElement.className = 'message system';
                    messageElement.innerHTML = `
                        <div class="message-content" style="text-align: center; font-style: italic; color: #6c757d;">
                            ${msg.mensagem}
                        </div>
                    `;
                } else {
                    const isSent = msg.usuario === currentUser.nome;
                    messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
                    
                    messageElement.innerHTML = `
                        <div class="message-header">
                            <span class="message-sender">${msg.usuario}</span>
                            <span class="message-time">${formatarHora(msg.created_at)}</span>
                        </div>
                        <div class="message-content">${msg.mensagem}</div>
                    `;
                }
                
                chatMessagesContainer.appendChild(messageElement);
            });
            
            // Scroll para baixo
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        async function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const messageContent = chatInput.value.trim();
            
            if (!messageContent || !currentChatColetaId) return;
            
            // Verificar se currentUser existe e obter nome do usu√°rio
            if (!currentUser) {
                showNotification('Usu√°rio n√£o autenticado', 'error');
                return;
            }
            
            const userName = currentUser.nome || currentUser.username || currentUser.email || 'Usu√°rio';
            
            try {
                await enviarMensagem(currentChatColetaId, messageContent, userName);
                
                // Recarregar mensagens
                await carregarMensagensChatModal(currentChatColetaId);
                
                // Limpar input
                chatInput.value = '';
                chatInput.style.height = 'auto';
                document.getElementById('chatSend').disabled = true;
                
            } catch (error) {
                console.error('‚ùå Erro detalhado:', error);
                showNotification('Erro ao enviar mensagem: ' + (error.message || 'Erro desconhecido'), 'error');
            }
        }

        // ========== FUN√á√ïES UTILIT√ÅRIAS ==========
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                uploadArea.classList.add('dragover');
            }
            
            function unhighlight() {
                uploadArea.classList.remove('dragover');
            }
            
            uploadArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFileSelect(files);
            }
        }

        function setupChatInput() {
            const chatInput = document.getElementById('chatInput');
            const chatSend = document.getElementById('chatSend');
            
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                chatSend.disabled = this.value.trim() === '';
            });
            
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!chatSend.disabled) {
                        sendMessage();
                    }
                }
            });
        }

        function initializeDateFilters() {
            const hoje = new Date();
            const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            
            // ‚úÖ Setar para o m√™s atual por padr√£o
            document.getElementById('dataInicio').value = formatarDataParaInput(inicioMes);
            document.getElementById('dataFim').value = formatarDataParaInput(hoje);
            
            console.log('üìÖ Filtros de data inicializados:', {
                inicio: formatarDataParaInput(inicioMes),
                fim: formatarDataParaInput(hoje)
            });
        }

        function calcularProgressoEtapas(coleta) {
            const etapaAtualIndex = ETAPAS.findIndex(e => e.id === coleta.etapa_atual);
            const etapasConcluidasCount = coleta.etapas_concluidas?.length || 0;
            const totalEtapas = ETAPAS.length;
            
            return {
                concluidas: etapasConcluidasCount,
                total: totalEtapas,
                porcentagem: (etapasConcluidasCount / totalEtapas) * 100,
                etapaAtual: ETAPAS[etapaAtualIndex]?.nome || 'N√£o definida'
            };
        }

        // FUN√á√ÉO SIMPLES - usa a API instead do Supabase direto
        async function avancarEtapa(coletaId) {
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta) return;

            // üîê Verificar permiss√£o para a etapa atual
            if (!temPermissaoEtapa(coleta.etapa_atual)) {
                showNotification('‚ö†Ô∏è Voc√™ n√£o tem permiss√£o para alterar esta etapa', 'warning');
                // ‚úÖ SEGURAN√áA: Logs condicionais apenas em desenvolvimento
                if (window.DEBUG || window.location.hostname === 'localhost') {
                console.log(`‚ùå Usu√°rio n√£o tem permiss√£o para etapa: ${coleta.etapa_atual}`);
                }
                return;
            }

            // ‚úÖ VALIDA√á√ÉO OBRIGAT√ìRIA: N√£o pode avan√ßar da etapa contrata√ß√£o sem motorista vinculado
            if (coleta.etapa_atual === 'contratacao' && !coleta.motorista_id) {
                    showNotification('‚ö†Ô∏è Para avan√ßar da etapa Contrata√ß√£o, √© necess√°rio vincular um motorista √† coleta.', 'warning');
                    return;
            }

            // ‚úÖ VALIDA√á√ÉO GR: S√≥ pode avan√ßar de GR se tiver sido aprovado
            if (coleta.etapa_atual === 'gr') {
                if (coleta.gr_aprovado === null || coleta.gr_aprovado === undefined) {
                    showNotification('‚ö†Ô∏è Para avan√ßar da etapa GR, √© necess√°rio aprovar ou reprovar a coleta primeiro.\n\nUse os bot√µes "Aprovar GR" ou "Reprovar GR" no card da coleta.', 'warning');
                    return;
                }
                if (coleta.gr_aprovado === false) {
                    showNotification('‚ö†Ô∏è Esta coleta foi reprovada pelo GR e n√£o pode avan√ßar. Ela deve voltar para a etapa de Contrata√ß√£o.', 'warning');
                    return;
                }
            }

            const etapaAtualIndex = ETAPAS.findIndex(e => e.id === coleta.etapa_atual);
            if (etapaAtualIndex < ETAPAS.length - 1) {
                const proximaEtapaId = ETAPAS[etapaAtualIndex + 1].id;
                
                // ‚úÖ VALIDA√á√ÉO: N√£o pode avan√ßar para documenta√ß√£o, contas_pagar ou monitoramento sem aprova√ß√£o no GR
                const etapasQueRequeremAprovacaoGR = ['documentacao', 'contas_pagar', 'monitoramento'];
                if (etapasQueRequeremAprovacaoGR.includes(proximaEtapaId)) {
                    // Verificar se o motorista foi aprovado no GR
                    if (!coleta.motorista_id) {
                        showNotification('‚ö†Ô∏è Para avan√ßar para esta etapa, √© necess√°rio ter um motorista vinculado e aprovado no GR.', 'warning');
                        return;
                    }
                    
                    // Verificar se passou pelo GR e foi aprovado
                    if (coleta.gr_aprovado !== true) {
                        if (coleta.gr_aprovado === false) {
                            showNotification('‚ö†Ô∏è Esta coleta foi reprovada pelo GR. N√£o √© poss√≠vel avan√ßar para esta etapa. √â necess√°rio aprovar o motorista no GR primeiro.', 'warning');
                        } else {
                            showNotification('‚ö†Ô∏è Para avan√ßar para esta etapa, o motorista deve ser aprovado no GR primeiro.', 'warning');
                        }
                        return;
                    }
                    
                    // Verificar tamb√©m se o motorista n√£o est√° reprovado para esta coleta
                    try {
                        const motorista = await buscarMotoristaPorId(coleta.motorista_id);
                        if (motorista) {
                            const statusInfo = verificarStatusMotoristaPorColeta(motorista, coleta.id);
                            if (statusInfo.status === 'reprovado') {
                                showNotification('‚ö†Ô∏è O motorista vinculado est√° reprovado para esta coleta. N√£o √© poss√≠vel avan√ßar para esta etapa.', 'warning');
                                return;
                            }
                            if (statusInfo.status !== 'aprovado') {
                                showNotification('‚ö†Ô∏è O motorista deve ser aprovado no GR antes de avan√ßar para esta etapa.', 'warning');
                                return;
                            }
                        }
                    } catch (err) {
                        console.warn('‚ö†Ô∏è Erro ao verificar status do motorista:', err);
                        showNotification('‚ö†Ô∏è Erro ao verificar status do motorista. N√£o √© poss√≠vel avan√ßar.', 'warning');
                        return;
                    }
                }
                
                // ‚úÖ VALIDA√á√ÉO: Se a pr√≥xima etapa for contas_pagar, solicitar tipo de pagamento
                if (proximaEtapaId === 'contas_pagar') {
                    etapaPendenteTipoPagamento = proximaEtapaId;
                    coletaPendenteTipoPagamento = coletaId;
                    abrirModalTipoPagamento();
                    return;
                }
                
                // Atualizar etapas_concluidas: adicionar a etapa atual se ainda n√£o estiver
                const etapasConcluidas = Array.isArray(coleta.etapas_concluidas) ? [...coleta.etapas_concluidas] : [];
                if (!etapasConcluidas.includes(coleta.etapa_atual)) {
                    etapasConcluidas.push(coleta.etapa_atual);
                }
                
                const updateData = {
                    etapa_atual: proximaEtapaId,
                    status: etapaAtualIndex + 1 === ETAPAS.length - 1 ? 'concluida' : 'em_andamento',
                    etapas_concluidas: etapasConcluidas,
                    updated_at: new Date().toISOString()
                };

                console.log('üéØ Dados para update:', updateData);

                try {
                    currentEditingId = coletaId;
                    await salvarColeta(updateData);
                    currentEditingId = null;
                    
                    // ‚úÖ HIST√ìRICO NO LUGAR CERTO - DENTRO DO TRY (sucesso)
                    await salvarNoHistorico(coletaId, 'etapa_avancada', 
                        `Etapa avan√ßada de ${coleta.etapa_atual} para ${proximaEtapaId}`
                    );
                    
                    showNotification(`‚úÖ Etapa avan√ßada para ${ETAPAS[etapaAtualIndex + 1].nome}`, 'success');
            } catch (error) {
                    console.error('‚ùå Erro:', error);
                    currentEditingId = null;
                    showNotification('Erro ao avan√ßar etapa', 'error');
                }
            } else {
                showNotification('üö´ √öltima etapa j√° alcan√ßada', 'info');
            }
        }

        function openMoverEtapaModal(coletaId) {
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta) return;

            if (!temPermissaoEtapa(coleta.etapa_atual)) {
                showNotification('‚ö†Ô∏è Voc√™ n√£o tem permiss√£o para alterar esta etapa', 'warning');
                return;
            }

            // ‚úÖ VALIDA√á√ÉO: Se est√° na etapa contrata√ß√£o sem motorista, n√£o permitir abrir o modal de mover
            if (coleta.etapa_atual === 'contratacao' && !coleta.motorista_id) {
                showNotification('‚ö†Ô∏è Para mover uma coleta da etapa Contrata√ß√£o, √© necess√°rio vincular um motorista √† coleta.', 'warning');
                return;
            }

            moverEtapaColetaId = coletaId;
            document.getElementById('moverEtapaAtual').textContent = obterNomeEtapa(coleta.etapa_atual);

            const select = document.getElementById('novaEtapaSelect');
            select.innerHTML = `<option value="">Selecione a etapa</option>` + ETAPAS.map(etapa => {
                // N√£o permitir selecionar a pr√≥pria etapa atual
                if (etapa.id === coleta.etapa_atual) {
                    return `<option value="${etapa.id}" disabled>${etapa.nome} (Atual)</option>`;
                }
                return `<option value="${etapa.id}">${etapa.nome}</option>`;
            }).join('');
            select.value = '';

            document.getElementById('moverEtapaModal').classList.add('active');
        }

        function fecharMoverEtapaModal() {
            moverEtapaColetaId = null;
            document.getElementById('novaEtapaSelect').value = '';
            document.getElementById('moverEtapaModal').classList.remove('active');
        }

        let etapaPendenteTipoPagamento = null; // Armazena a etapa que aguarda tipo de pagamento
        let coletaPendenteTipoPagamento = null; // Armazena o ID da coleta que aguarda tipo de pagamento

        async function confirmarMoverEtapa() {
            if (!moverEtapaColetaId) {
                showNotification('Nenhuma coleta selecionada para mover.', 'warning');
                return;
            }

            const coleta = coletasData.find(c => c.id === moverEtapaColetaId);
            if (!coleta) {
                showNotification('Coleta n√£o encontrada.', 'error');
                return;
            }

            // ‚úÖ VALIDA√á√ÉO OBRIGAT√ìRIA: N√£o pode sair da etapa contrata√ß√£o sem motorista vinculado
            if (coleta.etapa_atual === 'contratacao' && !coleta.motorista_id) {
                showNotification('‚ö†Ô∏è Para mover uma coleta da etapa Contrata√ß√£o, √© necess√°rio vincular um motorista √† coleta.', 'warning');
                fecharMoverEtapaModal();
                return;
            }

            const novaEtapaId = document.getElementById('novaEtapaSelect').value;
            if (!novaEtapaId) {
                showNotification('Selecione a nova etapa desejada.', 'warning');
                return;
            }

            // Se a nova etapa for "contas_pagar", solicitar tipo de pagamento
            if (novaEtapaId === 'contas_pagar') {
                etapaPendenteTipoPagamento = novaEtapaId;
                coletaPendenteTipoPagamento = moverEtapaColetaId;
                fecharMoverEtapaModal();
                abrirModalTipoPagamento();
                return;
            }

            await moverEtapa(moverEtapaColetaId, novaEtapaId);
        }

        function abrirModalTipoPagamento() {
            const modal = document.getElementById('modalTipoPagamento');
            modal.style.display = 'flex';
            document.getElementById('tipoPagamentoSelect').value = '';
        }
        
        // Event listener para fechar modal ao clicar fora (configurado uma vez)
        document.addEventListener('DOMContentLoaded', function() {
            const modalTipoPagamento = document.getElementById('modalTipoPagamento');
            if (modalTipoPagamento) {
                modalTipoPagamento.addEventListener('click', function(e) {
                    if (e.target === modalTipoPagamento) {
                        fecharModalTipoPagamento();
                    }
                });
            }
        });

        function fecharModalTipoPagamento() {
            document.getElementById('modalTipoPagamento').style.display = 'none';
            etapaPendenteTipoPagamento = null;
            coletaPendenteTipoPagamento = null;
        }

        async function confirmarPagamento(coletaId) {
            try {
                const coleta = coletasData.find(c => c.id === coletaId);
                if (!coleta) {
                    showNotification('Coleta n√£o encontrada', 'error');
                    return;
                }

                if (coleta.etapa_atual !== 'contas_pagar') {
                    showNotification('Esta coleta n√£o est√° na etapa de Contas a Pagar', 'warning');
                    return;
                }

                if (coleta.contas_pagar_pago) {
                    showNotification('Este pagamento j√° foi confirmado', 'info');
                    return;
                }

                // Confirmar a√ß√£o
                const confirmar = confirm(`Deseja confirmar o pagamento de ${coleta.contas_pagar_tipo || 'tipo n√£o informado'}?`);
                if (!confirmar) return;

                // Obter informa√ß√µes do usu√°rio atual
                const usuarioNome = currentUser?.nome || currentUser?.username || currentUser?.email || 'Sistema';
                const dataAtual = new Date().toISOString();

                // Atualizar coleta no banco
                const { error } = await supabaseClient
                    .from('coletas')
                    .update({
                        contas_pagar_pago: true,
                        contas_pagar_pago_por: usuarioNome,
                        contas_pagar_data: dataAtual,
                        updated_at: dataAtual
                    })
                    .eq('id', coletaId);

                if (error) throw error;

                // Salvar no hist√≥rico
                await salvarNoHistorico(coletaId, 'pagamento_confirmado', 
                    `Pagamento ${coleta.contas_pagar_tipo || ''} confirmado por ${usuarioNome}`
                );

                showNotification('‚úÖ Pagamento confirmado com sucesso!', 'success');

                // Recarregar coletas para atualizar a interface
                await carregarColetas();

                // Recarregar o conte√∫do do drawer se estiver aberto
                const drawer = document.getElementById('kanbanDrawer');
                if (drawer && drawer.classList.contains('active')) {
                    await carregarConteudoDrawer(coletaId);
                }

            } catch (error) {
                console.error('‚ùå Erro ao confirmar pagamento:', error);
                showNotification('Erro ao confirmar pagamento: ' + error.message, 'error');
            }
        }

        async function confirmarTipoPagamento() {
            const tipoPagamento = document.getElementById('tipoPagamentoSelect').value;
            
            if (!tipoPagamento) {
                showNotification('‚ö†Ô∏è Selecione o tipo de pagamento', 'warning');
                return;
            }

            if (!coletaPendenteTipoPagamento || !etapaPendenteTipoPagamento) {
                showNotification('Erro: Dados n√£o encontrados', 'error');
                fecharModalTipoPagamento();
                return;
            }

            const coletaId = coletaPendenteTipoPagamento;
            const novaEtapaId = etapaPendenteTipoPagamento;
            const coleta = coletasData.find(c => c.id === coletaId);
            
            if (!coleta) {
                showNotification('Coleta n√£o encontrada', 'error');
                fecharModalTipoPagamento();
                return;
            }

            // Atualizar etapas_concluidas: adicionar a etapa atual se ainda n√£o estiver
            const etapasConcluidas = Array.isArray(coleta.etapas_concluidas) ? [...coleta.etapas_concluidas] : [];
            if (!etapasConcluidas.includes(coleta.etapa_atual)) {
                etapasConcluidas.push(coleta.etapa_atual);
            }

            const updateData = {
                etapa_atual: novaEtapaId,
                status: 'em_andamento',
                etapas_concluidas: etapasConcluidas,
                contas_pagar_tipo: tipoPagamento
            };

            try {
                currentEditingId = coletaId;
                await salvarColeta(updateData);
                await salvarNoHistorico(coletaId, 'etapa_alterada', 
                    `Etapa alterada para ${obterNomeEtapa(novaEtapaId)}. Tipo de pagamento: ${tipoPagamento}`
                );
                showNotification(`‚úÖ Etapa movida para ${obterNomeEtapa(novaEtapaId)} - Tipo: ${tipoPagamento}`, 'success');
                fecharModalTipoPagamento();
            } catch (error) {
                console.error('‚ùå Erro ao mover etapa:', error);
                showNotification('Erro ao mover etapa: ' + error.message, 'error');
            } finally {
                currentEditingId = null;
                etapaPendenteTipoPagamento = null;
                coletaPendenteTipoPagamento = null;
            }
        }

        // Fun√ß√£o para marcar tipo de pagamento espec√≠fico como pago (GNRE, PED√ÅGIO, etc)
        async function marcarTipoPagamentoEspecifico(coletaId, tipoPagamento) {
            try {
                if (!supabaseClient) {
                    showNotification('Erro: Supabase n√£o inicializado', 'error');
                    return;
                }

                const coleta = coletasData.find(c => c.id === coletaId);
                if (!coleta) {
                    showNotification('Coleta n√£o encontrada', 'error');
                    return;
                }

                if (!temPermissaoEtapa('contas_pagar')) {
                    showNotification('‚ö†Ô∏è Voc√™ n√£o tem permiss√£o para marcar como pago nesta etapa', 'warning');
                    return;
                }

                if (!coleta.motorista_id) {
                    showNotification('‚ö†Ô∏è √â necess√°rio ter um motorista vinculado para marcar como pago', 'warning');
                    return;
                }

                const confirmacao = confirm(`Confirmar que ${tipoPagamento} foi pago? O motorista e o criador da oportunidade ser√£o notificados.`);
                if (!confirmacao) return;

                const userData = JSON.parse(localStorage.getItem('loggedInUser'));
                const usuarioNome = userData?.nome || userData?.email || 'Usu√°rio';

                // Buscar informa√ß√µes do motorista
                const motorista = await buscarMotoristaPorId(coleta.motorista_id);
                if (!motorista) {
                    showNotification('Erro ao buscar informa√ß√µes do motorista', 'error');
                    return;
                }

                // Atualizar coleta como paga
                const { error: updateError } = await supabaseClient
                    .from('coletas')
                    .update({
                        contas_pagar_pago: true,
                        contas_pagar_data: new Date().toISOString(),
                        contas_pagar_pago_por: usuarioNome,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', coletaId);

                if (updateError) throw updateError;

                // Salvar no hist√≥rico
                await salvarNoHistorico(coletaId, 'contas_pagar_pago', 
                    `${tipoPagamento} marcado como pago por ${usuarioNome}`
                );

                // Enviar mensagem para o motorista
                if (motorista.telefone1) {
                    try {
                        const mensagemMotorista = `‚úÖ *${tipoPagamento} PAGO*\n\nOl√° ${motorista.nome || 'Motorista'}!\n\nO pagamento ${tipoPagamento} da coleta *${coleta.cliente}* (${coleta.origem} ‚Üí ${coleta.destino}) foi marcado como realizado.\n\nObrigado pelo seu trabalho! üöö`;

                        const response = await fetch('/webhook/send-supabase', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                number: motorista.telefone1,
                                message: mensagemMotorista,
                                usuario: userData?.email || currentUser?.email || 'sistema',
                                userId: userData?.id || currentUser?.id || null
                            })
                        });

                        if (!response.ok) {
                            console.warn('‚ö†Ô∏è Erro ao enviar mensagem para motorista');
                        }
                    } catch (msgError) {
                        console.warn('‚ö†Ô∏è Erro ao enviar mensagem:', msgError);
                    }
                }

                showNotification(`‚úÖ ${tipoPagamento} marcado como pago! Motorista e criador da oportunidade foram notificados.`, 'success');

                await carregarColetas();

            } catch (error) {
                console.error('‚ùå Erro ao marcar tipo de pagamento como pago:', error);
                showNotification('Erro ao marcar como pago: ' + error.message, 'error');
            }
        }

        // Tornar fun√ß√µes globalmente acess√≠veis
        window.fecharModalTipoPagamento = fecharModalTipoPagamento;
        window.confirmarTipoPagamento = confirmarTipoPagamento;
        window.marcarTipoPagamentoEspecifico = marcarTipoPagamentoEspecifico;

        async function moverEtapa(coletaId, novaEtapaId, tipoPagamento = null) {
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta) return;

            if (!temPermissaoEtapa(coleta.etapa_atual)) {
                showNotification('‚ö†Ô∏è Voc√™ n√£o tem permiss√£o para alterar esta etapa', 'warning');
                return;
            }

            if (novaEtapaId === coleta.etapa_atual) {
                showNotification('Selecione uma etapa diferente da atual.', 'info');
                return;
            }

            // ‚úÖ VALIDA√á√ÉO: Se for mover para contas_pagar, tipo de pagamento √© obrigat√≥rio
            if (novaEtapaId === 'contas_pagar' && !tipoPagamento) {
                etapaPendenteTipoPagamento = novaEtapaId;
                coletaPendenteTipoPagamento = coletaId;
                abrirModalTipoPagamento();
                return;
            }

            const etapaAtualIndex = ETAPAS.findIndex(e => e.id === coleta.etapa_atual);
            const novaEtapaIndex = ETAPAS.findIndex(e => e.id === novaEtapaId);
            if (novaEtapaIndex === -1) {
                showNotification('Etapa selecionada inv√°lida.', 'error');
                return;
            }

            // ‚úÖ VALIDA√á√ÉO OBRIGAT√ìRIA: N√£o pode sair da etapa contrata√ß√£o sem motorista vinculado
            // Aplica para qualquer movimento (avan√ßar ou voltar) da etapa contrata√ß√£o
            if (coleta.etapa_atual === 'contratacao' && !coleta.motorista_id) {
                showNotification('‚ö†Ô∏è Para mover uma coleta da etapa Contrata√ß√£o, √© necess√°rio vincular um motorista √† coleta.', 'warning');
                return;
            }

            // ‚úÖ VALIDA√á√ÉO OBRIGAT√ìRIA: N√£o pode sair da etapa contrata√ß√£o se o motorista estiver reprovado
            if (coleta.etapa_atual === 'contratacao' && coleta.motorista_id) {
                try {
                    const motorista = await buscarMotoristaPorId(coleta.motorista_id);
                    const reprovacaoInfo = verificarReprovacaoPorColeta(motorista, coleta.id);
                    if (reprovacaoInfo.reprovado) {
                        showNotification('‚ö†Ô∏è O motorista vinculado est√° reprovado para esta coleta. √â obrigat√≥rio trocar o motorista ou solicitar uma nova an√°lise antes de avan√ßar.', 'warning');
                        return;
                    }
                } catch (err) {
                    console.warn('‚ö†Ô∏è Erro ao verificar status do motorista:', err);
                    // Continuar mesmo se houver erro na verifica√ß√£o
                }
            }
            
            // ‚úÖ VALIDA√á√ÉO: N√£o pode avan√ßar para documenta√ß√£o, contas_pagar ou monitoramento sem aprova√ß√£o no GR
            const etapasQueRequeremAprovacaoGR = ['documentacao', 'contas_pagar', 'monitoramento'];
            if (etapasQueRequeremAprovacaoGR.includes(novaEtapaId)) {
                // Verificar se o motorista foi aprovado no GR
                if (!coleta.motorista_id) {
                    showNotification('‚ö†Ô∏è Para avan√ßar para esta etapa, √© necess√°rio ter um motorista vinculado e aprovado no GR.', 'warning');
                    return;
                }
                
                // Verificar se passou pelo GR e foi aprovado
                if (coleta.gr_aprovado !== true) {
                    if (coleta.gr_aprovado === false) {
                        showNotification('‚ö†Ô∏è Esta coleta foi reprovada pelo GR. N√£o √© poss√≠vel avan√ßar para esta etapa. √â necess√°rio aprovar o motorista no GR primeiro.', 'warning');
                    } else {
                        showNotification('‚ö†Ô∏è Para avan√ßar para esta etapa, o motorista deve ser aprovado no GR primeiro.', 'warning');
                    }
                    return;
                }
                
                // Verificar tamb√©m se o motorista n√£o est√° reprovado para esta coleta
                try {
                    const motorista = await buscarMotoristaPorId(coleta.motorista_id);
                    if (motorista) {
                        const statusInfo = verificarStatusMotoristaPorColeta(motorista, coleta.id);
                        if (statusInfo.status === 'reprovado') {
                            showNotification('‚ö†Ô∏è O motorista vinculado est√° reprovado para esta coleta. N√£o √© poss√≠vel avan√ßar para esta etapa.', 'warning');
                            return;
                        }
                        if (statusInfo.status !== 'aprovado') {
                            showNotification('‚ö†Ô∏è O motorista deve ser aprovado no GR antes de avan√ßar para esta etapa.', 'warning');
                            return;
                        }
                    }
                } catch (err) {
                    console.warn('‚ö†Ô∏è Erro ao verificar status do motorista:', err);
                    showNotification('‚ö†Ô∏è Erro ao verificar status do motorista. N√£o √© poss√≠vel avan√ßar.', 'warning');
                    return;
                }
            }

            // ‚úÖ VALIDA√á√ÉO GR: N√£o pode sair de GR sem aprova√ß√£o ou reprova√ß√£o
            if (coleta.etapa_atual === 'gr') {
                // Verificar se GR foi aprovado ou reprovado
                if (coleta.gr_aprovado === null || coleta.gr_aprovado === undefined) {
                    showNotification('‚ö†Ô∏è Para mover uma coleta da etapa GR, √© necess√°rio aprovar ou reprovar a coleta primeiro.\n\nUse os bot√µes "Aprovar GR" ou "Reprovar GR" no card da coleta.', 'warning');
                    return;
                }
                
                // Se foi reprovado, n√£o pode avan√ßar (deve estar em contrata√ß√£o)
                if (coleta.gr_aprovado === false) {
                    if (novaEtapaIndex > etapaAtualIndex) {
                        showNotification('‚ö†Ô∏è Esta coleta foi reprovada pelo GR e n√£o pode avan√ßar. Ela deve voltar para a etapa de Contrata√ß√£o.', 'warning');
                    return;
                    }
                }
                
                // Se foi aprovado, s√≥ pode avan√ßar para documenta√ß√£o
                if (coleta.gr_aprovado === true) {
                    if (novaEtapaId !== 'documentacao' && novaEtapaIndex > etapaAtualIndex) {
                        showNotification('‚ö†Ô∏è Coletas aprovadas pelo GR devem avan√ßar para Documenta√ß√£o.', 'warning');
                        return;
                    }
                    // N√£o permitir voltar se foi aprovado
                    if (novaEtapaIndex < etapaAtualIndex) {
                        showNotification('‚ö†Ô∏è Coleta j√° foi aprovada no GR. N√£o √© poss√≠vel voltar.', 'warning');
                        return;
                    }
                }
            }

            // Atualizar etapas_concluidas: adicionar a etapa atual se ainda n√£o estiver
            const etapasConcluidas = Array.isArray(coleta.etapas_concluidas) ? [...coleta.etapas_concluidas] : [];
            if (!etapasConcluidas.includes(coleta.etapa_atual)) {
                etapasConcluidas.push(coleta.etapa_atual);
            }

            const updateData = {
                etapa_atual: novaEtapaId,
                status: novaEtapaId === 'finalizar_operacao' ? 'concluida' : 'em_andamento',
                etapas_concluidas: etapasConcluidas
            };

            // ‚úÖ Adicionar tipo de pagamento se for contas_pagar
            if (novaEtapaId === 'contas_pagar' && tipoPagamento) {
                updateData.contas_pagar_tipo = tipoPagamento;
            }

            try {
                currentEditingId = coletaId;
                await salvarColeta(updateData);
                const detalhesHistorico = tipoPagamento 
                    ? `Etapa alterada de ${obterNomeEtapa(coleta.etapa_atual)} para ${obterNomeEtapa(novaEtapaId)}. Tipo de pagamento: ${tipoPagamento}`
                    : `Etapa alterada de ${obterNomeEtapa(coleta.etapa_atual)} para ${obterNomeEtapa(novaEtapaId)}`;
                await salvarNoHistorico(coletaId, 'etapa_alterada', detalhesHistorico);
                showNotification(`Etapa movida para ${obterNomeEtapa(novaEtapaId)}${tipoPagamento ? ` - Tipo: ${tipoPagamento}` : ''}`, 'success');
                fecharMoverEtapaModal();
                
                // Atualizar Kanban se estiver vis√≠vel
                const kanbanContainer = document.getElementById('kanbanContainer');
                if (kanbanContainer && kanbanContainer.style.display !== 'none') {
                    await carregarColetas(); // Isso vai atualizar o Kanban automaticamente
                }
            } catch (error) {
                console.error('‚ùå Erro ao mover etapa:', error);
                showNotification('Erro ao mover etapa: ' + error.message, 'error');
            } finally {
                currentEditingId = null;
            }
        }

        // ‚úÖ Fun√ß√µes para gerenciar multi-select
        const multiSelectValues = {
            statusFilter: [],
            etapaFilter: [],
            filialFilter: []
        };

        function toggleMultiSelect(filterId) {
            // Adicionar sufixo 'Button' se n√£o tiver
            const buttonId = filterId.includes('Button') ? filterId : `${filterId}Button`;
            const button = document.getElementById(buttonId);
            if (!button) {
                console.warn(`‚ö†Ô∏è Bot√£o n√£o encontrado: ${buttonId}`);
                return;
            }
            
            const wrapper = button.closest('.multi-select-wrapper');
            if (!wrapper) {
                console.warn(`‚ö†Ô∏è Wrapper n√£o encontrado para: ${buttonId}`);
                return;
            }
            
            const isActive = wrapper.classList.contains('active');
            
            // Fechar todos os outros multi-selects
            document.querySelectorAll('.multi-select-wrapper').forEach(w => {
                if (w !== wrapper) {
                    w.classList.remove('active');
                }
            });
            
            // Toggle do atual
            wrapper.classList.toggle('active', !isActive);
        }
        
        // Expor fun√ß√£o globalmente para uso em inline handlers
        window.toggleMultiSelect = toggleMultiSelect;

        function updateMultiSelect(filterId, checkbox) {
            const value = checkbox.value;
            // Extrair o filterKey do ID do checkbox (ex: statusFilterOptions -> statusFilter)
            let filterKey = filterId;
            if (filterKey.includes('Options')) {
                filterKey = filterKey.replace('Options', '');
            } else if (filterKey.includes('Button')) {
                filterKey = filterKey.replace('Button', '');
            } else if (filterKey.includes('Dropdown')) {
                filterKey = filterKey.replace('Dropdown', '');
            }
            
            // Garantir que o filterKey existe no objeto
            if (!multiSelectValues.hasOwnProperty(filterKey)) {
                console.warn(`‚ö†Ô∏è FilterKey n√£o encontrado: ${filterKey}`);
                return;
            }
            
            if (value === '') {
                // Se "Todos" foi clicado, desmarcar todos os outros e marcar apenas "Todos"
                if (checkbox.checked) {
                    const options = document.querySelectorAll(`#${filterKey}Options input[type="checkbox"]`);
                    options.forEach(opt => {
                        if (opt !== checkbox) opt.checked = false;
                    });
                    multiSelectValues[filterKey] = [];
                } else {
                    // N√£o permitir desmarcar "Todos" se for o √∫nico selecionado
                    checkbox.checked = true;
                    return;
                }
            } else {
                // Se outro item foi clicado, desmarcar "Todos"
                const todosCheckbox = document.querySelector(`#${filterKey}Options input[value=""]`);
                if (todosCheckbox) todosCheckbox.checked = false;
                
                if (checkbox.checked) {
                    if (!multiSelectValues[filterKey].includes(value)) {
                        multiSelectValues[filterKey].push(value);
                    }
                } else {
                    multiSelectValues[filterKey] = multiSelectValues[filterKey].filter(v => v !== value);
                }
                
                // Se nenhum item espec√≠fico estiver selecionado, marcar "Todos"
                if (multiSelectValues[filterKey].length === 0) {
                    if (todosCheckbox) todosCheckbox.checked = true;
                }
            }
            
            updateMultiSelectText(filterKey);
            filterColetas();
        }
        
        // Expor fun√ß√£o globalmente para uso em inline handlers
        window.updateMultiSelect = updateMultiSelect;

        function updateMultiSelectText(filterKey) {
            const values = multiSelectValues[filterKey];
            const textElement = document.getElementById(`${filterKey}Text`);
            
            if (!textElement) return;
            
            if (values.length === 0) {
                // Mostrar texto padr√£o
                const labels = {
                    statusFilter: 'Todos os Status',
                    etapaFilter: 'Todas as Etapas',
                    filialFilter: 'Todas as Filiais'
                };
                textElement.textContent = labels[filterKey] || 'Todos';
            } else if (values.length === 1) {
                // Mostrar o nome do item selecionado
                const option = document.querySelector(`#${filterKey}Options input[value="${values[0]}"]`);
                if (option) {
                    const label = option.closest('label').querySelector('span');
                    textElement.textContent = label ? label.textContent : values[0];
                } else {
                    textElement.textContent = values[0];
                }
            } else {
                // Mostrar quantidade selecionada
                textElement.textContent = `${values.length} selecionado(s)`;
            }
        }

        function filterMultiSelectOptions(input, filterKey) {
            const searchTerm = input.value.toLowerCase();
            // Se filterKey j√° inclui 'Options', usar diretamente; caso contr√°rio, adicionar
            const optionsId = filterKey.includes('Options') ? filterKey : `${filterKey}Options`;
            const options = document.querySelectorAll(`#${optionsId} .multi-select-option`);
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    option.classList.remove('hidden');
                } else {
                    option.classList.add('hidden');
                }
            });
        }

        // Fechar multi-selects ao clicar fora
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.multi-select-wrapper')) {
                document.querySelectorAll('.multi-select-wrapper').forEach(w => {
                    w.classList.remove('active');
                });
            }
        });

        // Tornar fun√ß√µes globalmente acess√≠veis
        window.toggleMultiSelect = toggleMultiSelect;
        window.updateMultiSelect = updateMultiSelect;
        window.filterMultiSelectOptions = filterMultiSelectOptions;
        window.alternarVisualizacao = alternarVisualizacao;
        window.abrirKanbanDrawer = abrirKanbanDrawer;
        window.fecharKanbanDrawer = fecharKanbanDrawer;
        window.trocarTabDrawer = trocarTabDrawer;
        window.handleDrawerUploadAnexo = handleDrawerUploadAnexo;
        window.abrirModalEtiquetas = abrirModalEtiquetas;
        window.avancarEtapa = avancarEtapa;
        window.voltarEtapa = voltarEtapa;
        window.excluirColeta = excluirColeta;
        window.aprovarGR = aprovarGR;
        window.reprovarGR = reprovarGR;
        window.moverParaEtapaDrawer = moverParaEtapaDrawer;
        window.moverEtapa = moverEtapa;
        window.vincularMotorista = vincularMotorista;
        window.fecharModalMotorista = fecharModalMotorista;
        window.filtrarMotoristas = filtrarMotoristas;
        window.selecionarMotorista = selecionarMotorista;
        window.trocarMotorista = trocarMotorista;
        window.reprovarMotorista = reprovarMotorista;
        window.verDetalhesMotorista = verDetalhesMotorista;

        async function filterColetas() {
            // ‚úÖ PAGINA√á√ÉO: Resetar para primeira p√°gina ao filtrar
            paginaAtual = 1;
            
            // ‚úÖ Obter valores selecionados dos multi-selects
            const statusFilters = multiSelectValues.statusFilter.length > 0 ? multiSelectValues.statusFilter : null;
            const etapaFilters = multiSelectValues.etapaFilter.length > 0 ? multiSelectValues.etapaFilter : null;
            const filialFilters = multiSelectValues.filialFilter.length > 0 ? multiSelectValues.filialFilter : null;
            
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;

            if (window.DEBUG || window.location.hostname === 'localhost') {
            console.log('üîç Aplicando filtros:', {
                dataInicio,
                dataFim,
                    statusFilters,
                    etapaFilters,
                    filialFilters,
                searchFilter
            });
            }

            // ‚úÖ FILTRAR APENAS COLETAS N√ÉO ARQUIVADAS
            const coletasParaFiltrar = window.coletasAtivas || coletasData.filter(c => !c.arquivado);
            
            const filtered = coletasParaFiltrar.filter(coleta => {
                // ‚úÖ Filtro de arquivado - garantir que nunca apare√ßam coletas arquivadas
                if (coleta.arquivado) {
                    return false;
                }

                // ‚úÖ Filtro de status (m√∫ltiplas sele√ß√µes)
                if (statusFilters && statusFilters.length > 0) {
                    if (!statusFilters.includes(coleta.status)) {
                        if (window.DEBUG || window.location.hostname === 'localhost') {
                            console.log(`‚ùå Filtrado por status: ${coleta.status} n√£o est√° em [${statusFilters.join(', ')}]`);
                        }
                    return false;
                    }
                }

                // ‚úÖ Filtro de etapa (m√∫ltiplas sele√ß√µes)
                if (etapaFilters && etapaFilters.length > 0) {
                    if (!etapaFilters.includes(coleta.etapa_atual)) {
                        if (window.DEBUG || window.location.hostname === 'localhost') {
                            console.log(`‚ùå Filtrado por etapa: ${coleta.etapa_atual} n√£o est√° em [${etapaFilters.join(', ')}]`);
                        }
                    return false;
                    }
                }

                // ‚úÖ Filtro de filial (m√∫ltiplas sele√ß√µes)
                if (filialFilters && filialFilters.length > 0) {
                    if (!filialFilters.includes(coleta.filial)) {
                        if (window.DEBUG || window.location.hostname === 'localhost') {
                            console.log(`‚ùå Filtrado por filial: ${coleta.filial} n√£o est√° em [${filialFilters.join(', ')}]`);
                        }
                    return false;
                    }
                }

                // Filtro de busca
                if (searchFilter) {
                    const searchableText = `${coleta.cliente || ''} ${coleta.origem || ''} ${coleta.destino || ''} ${coleta.numero_coleta || ''} ${coleta.filial || ''}`.toLowerCase();
                    if (!searchableText.includes(searchFilter)) {
                        console.log(`‚ùå Filtrado por busca: "${searchableText}" n√£o cont√©m "${searchFilter}"`);
                        return false;
                    }
                }

                // ‚úÖ CORRE√á√ÉO: Filtro de datas - usando o campo correto
                if (dataInicio || dataFim) {
                    // Campo correto: data_recebimento (snake_case)
                    const dataColeta = coleta.data_recebimento || coleta.dataRecebimento;
                    
                    if (!dataColeta) {
                        console.log(`‚ùå Coleta sem data: ${coleta.id}`);
                        return false;
                    }

                    // Converter para Date para compara√ß√£o
                    // Se j√° √© uma string ISO, usar diretamente; se n√£o, adicionar hor√°rio
                    let dataColetaObj;
                    if (typeof dataColeta === 'string') {
                        // Se j√° tem hor√°rio (ISO format), usar diretamente
                        if (dataColeta.includes('T') || dataColeta.includes(' ')) {
                            dataColetaObj = new Date(dataColeta);
                        } else {
                            // Se √© apenas data (YYYY-MM-DD), adicionar hor√°rio
                            dataColetaObj = new Date(dataColeta + 'T00:00:00');
                        }
                    } else {
                        dataColetaObj = new Date(dataColeta);
                    }
                    
                    const inicioObj = dataInicio ? new Date(dataInicio + 'T00:00:00') : null;
                    const fimObj = dataFim ? new Date(dataFim + 'T23:59:59') : null; // Fim do dia

                    // Validar se as datas s√£o v√°lidas
                    if (isNaN(dataColetaObj.getTime())) {
                        console.log(`‚ùå Data inv√°lida na coleta: ${coleta.id}, data: ${dataColeta}`);
                        return false;
                    }

                    console.log(`üìÖ Comparando datas: Coleta=${dataColetaObj.toISOString()}, In√≠cio=${inicioObj?.toISOString()}, Fim=${fimObj?.toISOString()}`);

                    // Filtro data in√≠cio
                    if (dataInicio && inicioObj && dataColetaObj < inicioObj) {
                        console.log(`‚ùå Filtrado por data in√≠cio: ${dataColetaObj.toISOString()} < ${inicioObj.toISOString()}`);
                        return false;
                    }

                    // Filtro data fim
                    if (dataFim && fimObj && dataColetaObj > fimObj) {
                        console.log(`‚ùå Filtrado por data fim: ${dataColetaObj.toISOString()} > ${fimObj.toISOString()}`);
                        return false;
                    }
                }

                if (window.DEBUG || window.location.hostname === 'localhost') {
                console.log(`‚úÖ Coleta ${coleta.id} passou nos filtros`);
                }
                return true;
            });

            console.log(`üìä Resultado: ${filtered.length} de ${coletasData.length} coletas`);
            await renderColetasWrapper(filtered);
        }
        
        // Expor filterColetas globalmente para uso em inline handlers
        window.filterColetas = filterColetas;
        
        // Fun√ß√µes setQuickDate e clearDateFilters j√° est√£o definidas acima (linhas ~2939 e ~2926)

        function updateStats(data = coletasData) {
            // Fun√ß√£o para calcular valor total de um conjunto de coletas
            const calcularValorTotal = (coletas) => {
                return coletas.reduce((total, coleta) => {
                    const valor = parseFloat(coleta.valor) || 0;
                    return total + valor;
                }, 0);
            };

            // Fun√ß√£o para formatar valor em moeda brasileira
            const formatarMoeda = (valor) => {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL',
                    minimumFractionDigits: 2
                }).format(valor);
            };

            // Filtrar coletas por status
            const pendentes = data.filter(c => c.status === 'pendente');
            const emAndamento = data.filter(c => c.status === 'em_andamento');
            const concluidas = data.filter(c => c.status === 'concluida');
            const canceladas = data.filter(c => c.status === 'cancelada');

            // Atualizar Total
            const totalCount = data.length;
            const totalValor = calcularValorTotal(data);
            document.getElementById('totalColetas').textContent = totalCount;
            document.getElementById('totalColetasValor').textContent = formatarMoeda(totalValor);

            // Atualizar Pendentes
            const pendentesCount = pendentes.length;
            const pendentesValor = calcularValorTotal(pendentes);
            document.getElementById('pendentesCount').textContent = pendentesCount;
            document.getElementById('pendentesValor').textContent = formatarMoeda(pendentesValor);

            // Atualizar Em Andamento
            const andamentoCount = emAndamento.length;
            const andamentoValor = calcularValorTotal(emAndamento);
            document.getElementById('andamentoCount').textContent = andamentoCount;
            document.getElementById('andamentoValor').textContent = formatarMoeda(andamentoValor);

            // Atualizar Conclu√≠das
            const concluidasCount = concluidas.length;
            const concluidasValor = calcularValorTotal(concluidas);
            document.getElementById('concluidasCount').textContent = concluidasCount;
            document.getElementById('concluidasValor').textContent = formatarMoeda(concluidasValor);

            // Atualizar Canceladas
            const canceladasCount = canceladas.length;
            const canceladasValor = calcularValorTotal(canceladas);
            document.getElementById('canceladasCount').textContent = canceladasCount;
            document.getElementById('canceladasValor').textContent = formatarMoeda(canceladasValor);
        }

        // Fun√ß√µes utilit√°rias
        function generateId() {
            // Gerar UUID v4 v√°lido
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function getStatusText(status) {
            const statusMap = {
                'pendente': 'Pendente',
                'em_andamento': 'Em Andamento',
                'concluida': 'Conclu√≠da',
                'cancelada': 'Cancelada'
            };
            return statusMap[status] || status;
        }

        function formatarData(dataString) {
            const data = new Date(dataString);
            return data.toLocaleDateString('pt-BR');
        }

        function formatarHora(dataString) {
            const data = new Date(dataString);
            return data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        function formatarDataParaInput(data) {
            return data.toISOString().split('T')[0];
        }

        function toggleCardExpand(button) {
            const card = button.closest('.coleta-card');
            if (card) {
                card.classList.toggle('collapsed');
                card.classList.toggle('expanded');
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        function getFileIcon(fileType) {
            const icons = {
                'pdf': 'fa-file-pdf',
                'excel': 'fa-file-excel',
                'image': 'fa-image',
                'word': 'fa-file-word',
                'default': 'fa-file'
            };
            
            if (fileType.includes('pdf')) return icons.pdf;
            if (fileType.includes('spreadsheet') || fileType.includes('excel')) return icons.excel;
            if (fileType.includes('image')) return icons.image;
            if (fileType.includes('word') || fileType.includes('document')) return icons.word;
            return icons.default;
        }

        function getFileIconClass(fileType) {
            const classes = {
                'pdf': 'text-danger',
                'excel': 'text-success',
                'image': 'text-info',
                'word': 'text-primary',
                'default': 'text-secondary'
            };
            
            if (fileType.includes('pdf')) return classes.pdf;
            if (fileType.includes('spreadsheet') || fileType.includes('excel')) return classes.excel;
            if (fileType.includes('image')) return classes.image;
            if (fileType.includes('word') || fileType.includes('document')) return classes.word;
            return classes.default;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function handleFileSelect(files) {
            selectedFiles = Array.from(files);
            const filesList = document.getElementById('filesList');
            if (!filesList) return;
            
            filesList.innerHTML = '';
            
            // Verificar se categoria foi selecionada
            const categoriaSelect = document.getElementById('anexoCategoriaSelect');
            const categoriaSelecionada = categoriaSelect ? categoriaSelect.value : '';
            
            if (selectedFiles.length > 0 && !categoriaSelecionada) {
                showNotification('‚ö†Ô∏è Selecione uma categoria antes de enviar os arquivos', 'warning');
            }
            
            selectedFiles.forEach((file, index) => {
                const fileType = file.type;
                const fileElement = document.createElement('div');
                fileElement.className = 'file-item';
                fileElement.innerHTML = `
                    <div class="file-info">
                        <div class="file-icon ${getFileIconClass(fileType)}">
                            <i class="fas ${getFileIcon(fileType)}"></i>
                        </div>
                        <div class="file-details">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${formatFileSize(file.size)}</div>
                            ${categoriaSelecionada ? `
                                <div style="font-size: 0.75rem; color: #667eea; margin-top: 0.25rem;">
                                    <i class="fas fa-folder"></i> ${obterNomeCategoria(categoriaSelecionada)}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <button class="file-remove" onclick="removerArquivo(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                filesList.appendChild(fileElement);
            });
            
            const selectedFilesDiv = document.getElementById('selectedFiles');
            if (selectedFilesDiv) {
                selectedFilesDiv.style.display = 'block';
            }
            
            // Atualizar estado do bot√£o de upload
            const btnUpload = document.getElementById('btnUpload');
            if (btnUpload) {
                btnUpload.disabled = selectedFiles.length === 0 || !categoriaSelecionada;
            }
        }
        
        // Fun√ß√£o para obter nome amig√°vel da categoria
        function obterNomeCategoria(categoria) {
            const categorias = {
                'documentos_motorista': 'Documentos do Motorista',
                'documentos_proprietario': 'Documentos do Propriet√°rio',
                'documentos_veiculo': 'Documentos do Ve√≠culo',
                'evidencias': 'Evid√™ncias',
                'faturamento': 'Faturamento',
                'notas_fiscais': 'Notas Fiscais',
                'contratos': 'Contratos',
                'outros': 'Outros'
            };
            return categorias[categoria] || categoria;
        }
        
        // Fun√ß√£o para obter √≠cone da categoria
        function obterIconeCategoria(categoria) {
            const icones = {
                'documentos_motorista': 'fa-user',
                'documentos_proprietario': 'fa-building',
                'documentos_veiculo': 'fa-truck',
                'evidencias': 'fa-camera',
                'faturamento': 'fa-money-bill',
                'notas_fiscais': 'fa-file-invoice',
                'contratos': 'fa-file-contract',
                'outros': 'fa-folder'
            };
            return icones[categoria] || 'fa-folder';
        }
        
        // Fun√ß√£o para obter cor da categoria
        function obterCorCategoria(categoria) {
            const cores = {
                'documentos_motorista': '#28a745',
                'documentos_proprietario': '#667eea',
                'documentos_veiculo': '#ffc107',
                'evidencias': '#dc3545',
                'faturamento': '#17a2b8',
                'notas_fiscais': '#6f42c1',
                'contratos': '#fd7e14',
                'outros': '#6c757d'
            };
            return cores[categoria] || '#6c757d';
        }

        function removerArquivo(index) {
            selectedFiles.splice(index, 1);
            
            // Recriar a lista de arquivos
            const filesList = document.getElementById('filesList');
            if (filesList) {
                filesList.innerHTML = '';
                
                const categoriaSelect = document.getElementById('anexoCategoriaSelect');
                const categoriaSelecionada = categoriaSelect ? categoriaSelect.value : '';
                
                selectedFiles.forEach((file, idx) => {
                    const fileType = file.type;
                    const fileElement = document.createElement('div');
                    fileElement.className = 'file-item';
                    fileElement.innerHTML = `
                        <div class="file-info">
                            <div class="file-icon ${getFileIconClass(fileType)}">
                                <i class="fas ${getFileIcon(fileType)}"></i>
                            </div>
                            <div class="file-details">
                                <div class="file-name">${file.name}</div>
                                <div class="file-size">${formatFileSize(file.size)}</div>
                                ${categoriaSelecionada ? `
                                    <div style="font-size: 0.75rem; color: #667eea; margin-top: 0.25rem;">
                                        <i class="fas fa-folder"></i> ${obterNomeCategoria(categoriaSelecionada)}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <button class="file-remove" onclick="removerArquivo(${idx})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    filesList.appendChild(fileElement);
                });
            }
            
            if (selectedFiles.length === 0) {
                const selectedFilesDiv = document.getElementById('selectedFiles');
                if (selectedFilesDiv) {
                    selectedFilesDiv.style.display = 'none';
                }
            }
            
            // Atualizar estado do bot√£o
            const btnUpload = document.getElementById('btnUpload');
            const categoriaSelect = document.getElementById('anexoCategoriaSelect');
            const categoriaSelecionada = categoriaSelect ? categoriaSelect.value : '';
            if (btnUpload) {
                btnUpload.disabled = selectedFiles.length === 0 || !categoriaSelecionada;
            }
        }

        // ‚úÖ Fun√ß√£o auxiliar para escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ‚úÖ Fun√ß√£o para carregar ITs relacionadas ao cliente
        async function carregarITsRelacionadas(coletaId, nomeCliente, filialColeta = null) {
            try {
                // Construir URL com query parameter de filial se dispon√≠vel
                let url = `/api/clientes/nome/${encodeURIComponent(nomeCliente)}/its`;
                if (filialColeta) {
                    url += `?filial=${encodeURIComponent(filialColeta)}`;
                }
                
                const response = await fetch(url, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    console.warn('‚ö†Ô∏è Erro ao carregar ITs do cliente:', response.statusText);
                    const itsContent = document.getElementById(`its-content-${coletaId}`);
                    if (itsContent) {
                        itsContent.innerHTML = '<div style="text-align: center; color: #6c757d; font-size: 0.8rem; padding: 1rem;">Nenhuma IT relacionada encontrada</div>';
                    }
                    return;
                }
                
                const result = await response.json();
                const itsContent = document.getElementById(`its-content-${coletaId}`);
                
                if (!itsContent) return;
                
                if (!result.success || !result.its || result.its.length === 0) {
                    itsContent.innerHTML = `
                        <div style="text-align: center; color: #6c757d; font-size: 0.8rem; padding: 1rem;">
                            <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
                            Nenhuma IT relacionada encontrada para este cliente${filialColeta ? ` na filial ${filialColeta}` : ''}
                        </div>
                    `;
                    return;
                }
                
                // Renderizar ITs
                itsContent.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        ${result.its.map(it => `
                            <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); padding: 0.75rem; border-radius: 8px; border-left: 3px solid #667eea;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #667eea; margin-bottom: 0.25rem;">
                                            ${it.codigo_it ? `<span style="font-size: 0.75rem; background: #667eea; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; margin-right: 0.5rem;">${it.codigo_it}</span>` : ''}
                                            ${escapeHtml(it.nome)}
                                        </div>
                                        ${it.area ? `<div style="font-size: 0.75rem; color: #6c757d; margin-top: 0.25rem;"><i class="fas fa-building"></i> ${escapeHtml(it.area)}</div>` : ''}
                                        ${it.operacao ? `<div style="font-size: 0.75rem; color: #6c757d; margin-top: 0.25rem;"><i class="fas fa-cog"></i> ${escapeHtml(it.operacao.replace('operacoes_', 'Opera√ß√µes - ').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()))}</div>` : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                    <a href="${it.url}" target="_blank" 
                                       onclick="event.stopPropagation();"
                                       style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.4rem 0.8rem; border-radius: 6px; text-decoration: none; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.4rem; transition: transform 0.2s;"
                                       onmouseover="this.style.transform='translateY(-2px)'"
                                       onmouseout="this.style.transform='translateY(0)'">
                                        <i class="fas fa-eye"></i> Visualizar
                                    </a>
                                    <a href="${it.url}" download="${it.nome_arquivo || 'it.pdf'}"
                                       onclick="event.stopPropagation();"
                                       style="background: transparent; color: #667eea; border: 1px solid #667eea; padding: 0.4rem 0.8rem; border-radius: 6px; text-decoration: none; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.4rem; transition: all 0.2s;"
                                       onmouseover="this.style.background='#667eea'; this.style.color='white'"
                                       onmouseout="this.style.background='transparent'; this.style.color='#667eea'">
                                        <i class="fas fa-download"></i> Baixar
                                    </a>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('‚ùå Erro ao carregar ITs relacionadas:', error);
                const itsContent = document.getElementById(`its-content-${coletaId}`);
                if (itsContent) {
                    itsContent.innerHTML = '<div style="text-align: center; color: #dc3545; font-size: 0.8rem; padding: 1rem;">Erro ao carregar ITs</div>';
                }
            }
        }

        // Fun√ß√µes de fechar modais
        function closeModal() {
            document.getElementById('coletaModal').classList.remove('active');
            currentEditingId = null;
            // Limpar sele√ß√£o de classe e tipos quando fechar o modal
            const classeSelect = document.getElementById('classeVeiculo');
            if (classeSelect) {
                classeSelect.value = '';
                atualizarTiposVeiculoECarroceria();
            }
        }

        function closeAnexosModal() {
            document.getElementById('anexosModal').classList.remove('active');
            currentAnexosColetaId = null;
        }

        function closeChatModal() {
            document.getElementById('chatModal').classList.remove('active');
            currentChatColetaId = null;
            
            const chatInput = document.getElementById('chatInput');
            chatInput.value = '';
            chatInput.style.height = 'auto';
            document.getElementById('chatSend').disabled = true;
        }

        // Modal de Hist√≥rico Completo
        // Fun√ß√£o auxiliar para processar detalhes e substituir IDs de motorista por nome e telefone
        async function processarDetalhesComMotorista(detalhes) {
            if (!detalhes) return detalhes;
            
            // Regex para encontrar IDs de motorista (UUIDs)
            const motoristaIdRegex = /([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})/gi;
            const idsEncontrados = detalhes.match(motoristaIdRegex);
            
            if (!idsEncontrados) return detalhes;
            
            let detalhesProcessados = detalhes;
            
            // Processar cada ID √∫nico
            const idsUnicos = [...new Set(idsEncontrados)];
            for (const motoristaId of idsUnicos) {
                try {
                    const motorista = await buscarMotoristaPorId(motoristaId);
                    if (motorista) {
                        const nome = motorista.nome || 'Motorista desconhecido';
                        const telefone = motorista.telefone1 || motorista.telefone2 || '';
                        const infoMotorista = telefone ? `${nome} (${telefone})` : nome;
                        detalhesProcessados = detalhesProcessados.replace(new RegExp(motoristaId, 'g'), infoMotorista);
                    }
                } catch (error) {
                    console.warn(`‚ö†Ô∏è Erro ao buscar motorista ${motoristaId}:`, error);
                    // Manter o ID se n√£o conseguir buscar
                }
            }
            
            return detalhesProcessados;
        }

        async function abrirModalHistoricoCompleto(coletaId) {
            try {
                document.getElementById('modalHistoricoCompleto').style.display = 'flex';
                document.getElementById('conteudoHistoricoCompleto').innerHTML = '<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin fa-2x"></i><p style="margin-top: 1rem;">Carregando hist√≥rico...</p></div>';
                
                // Buscar dados da coleta para obter o n√∫mero da OC
                const { data: coleta, error: coletaError } = await supabaseClient
                    .from('coletas')
                    .select('id, filial, numero_coleta, cliente')
                    .eq('id', coletaId)
                    .single();
                
                const numeroOC = coleta?.numero_coleta ? `${coleta.filial || ''} #${coleta.numero_coleta}`.trim() : null;
                
                let historico = [];
                
                // Buscar hist√≥rico da tabela historico_movimentacoes (priorit√°ria)
                // ‚úÖ OTIMIZA√á√ÉO: Selecionar apenas campos necess√°rios
                const { data: dataMov, error: errorMov } = await supabaseClient
                    .from('historico_movimentacoes')
                    .select('acao, usuario_nome, detalhes, created_at')
                    .eq('coleta_id', coletaId)
                    .order('created_at', { ascending: false });

                if (errorMov) {
                    console.warn('‚ö†Ô∏è Erro ao buscar historico_movimentacoes:', errorMov);
                } else if (dataMov && dataMov.length > 0) {
                    // Processar cada item do hist√≥rico para substituir IDs de motorista
                    historico = await Promise.all(dataMov.map(async (mov) => {
                        const detalhesProcessados = await processarDetalhesComMotorista(mov.detalhes || '');
                        return {
                        acao: mov.acao || 'Movimenta√ß√£o',
                        usuario_nome: mov.usuario_nome || 'Sistema',
                            detalhes: detalhesProcessados,
                        created_at: mov.created_at
                        };
                    }));
                }

                // Se n√£o encontrou nada, buscar tamb√©m de historico_coletas (compatibilidade)
                if (historico.length === 0) {
                    // ‚úÖ OTIMIZA√á√ÉO: Selecionar apenas campos necess√°rios
                    const { data: dataColetas, error: errorColetas } = await supabaseClient
                        .from('historico_coletas')
                        .select('acao, usuario, detalhes, created_at')
                        .eq('coleta_id', coletaId)
                        .order('created_at', { ascending: false });

                    if (errorColetas) {
                        console.warn('‚ö†Ô∏è Erro ao buscar historico_coletas:', errorColetas);
                    } else if (dataColetas && dataColetas.length > 0) {
                        // Processar cada item do hist√≥rico para substituir IDs de motorista
                        historico = await Promise.all(dataColetas.map(async (h) => {
                            const detalhesProcessados = await processarDetalhesComMotorista(h.detalhes || '');
                            return {
                            acao: h.acao || 'Movimenta√ß√£o',
                            usuario_nome: h.usuario || 'Sistema',
                                detalhes: detalhesProcessados,
                            created_at: h.created_at
                            };
                        }));
                    }
                }

                const historicoDiv = document.getElementById('conteudoHistoricoCompleto');
                
                if (historico.length > 0) {
                    // Ordenar por data mais recente primeiro
                    historico.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    
                    historicoDiv.innerHTML = `
                        ${numeroOC ? `
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
                                <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem; font-weight: 600;">
                                    <i class="fas fa-hashtag"></i>
                                    <span>OC: ${numeroOC}</span>
                                </div>
                            </div>
                        ` : ''}
                        <div style="display: grid; gap: 1rem;">
                            ${historico.map(mov => `
                                <div style="padding: 1rem; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; border-left: 4px solid #667eea; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                        <div>
                                            <strong style="color: #667eea; font-size: 1rem;">${getTextoAcao(mov.acao) || mov.acao || 'Movimenta√ß√£o'}</strong>
                                        </div>
                                        <small style="color: #666;">${formatarDataHora(mov.created_at)}</small>
                                    </div>
                                    <div style="color: #333; font-size: 0.9rem; margin-bottom: 0.5rem;">
                                        <i class="fas fa-user"></i> ${mov.usuario_nome || 'Sistema'}
                                    </div>
                                    ${mov.detalhes ? `
                                        <div style="background: white; padding: 0.8rem; border-radius: 8px; margin-top: 0.5rem; font-style: italic; color: #555; border-left: 3px solid #667eea;">
                                            ${mov.detalhes}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    historicoDiv.innerHTML = `
                        ${numeroOC ? `
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
                                <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem; font-weight: 600;">
                                    <i class="fas fa-hashtag"></i>
                                    <span>OC: ${numeroOC}</span>
                                </div>
                            </div>
                        ` : ''}
                        <div style="text-align: center; padding: 3rem; color: #999;">
                            <i class="fas fa-inbox fa-3x" style="margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p style="font-size: 1.1rem;">Nenhuma movimenta√ß√£o registrada</p>
                            <p style="font-size: 0.9rem;">O hist√≥rico desta coleta aparecer√° aqui</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('‚ùå Erro ao carregar hist√≥rico completo:', error);
                document.getElementById('conteudoHistoricoCompleto').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #dc3545;">
                        <i class="fas fa-exclamation-circle fa-2x"></i>
                        <p style="margin-top: 1rem;">Erro ao carregar hist√≥rico: ${error.message}</p>
                    </div>
                `;
            }
        }

        function fecharModalHistoricoCompleto() {
            document.getElementById('modalHistoricoCompleto').style.display = 'none';
        }

        // Event listeners para fechar modais ao clicar fora
        document.getElementById('coletaModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        document.getElementById('anexosModal').addEventListener('click', function(e) {
            if (e.target === this) closeAnexosModal();
        });

        document.getElementById('chatModal').addEventListener('click', function(e) {
            if (e.target === this) closeChatModal();
        });

        document.getElementById('modalHistoricoCompleto').addEventListener('click', function(e) {
            if (e.target === this) {
                fecharModalHistoricoCompleto();
            }
        });
        
        document.getElementById('moverEtapaModal').addEventListener('click', function(e) {
            if (e.target === this) {
                fecharMoverEtapaModal();
            }
        });

        // Fun√ß√£o para mostrar erro
        function mostrarErro(mensagem) {
            showNotification(mensagem, 'error');
        }

        // ========== PART√çCULAS ANIMADAS ==========
        const canvas = document.createElement('canvas');
        canvas.id = 'particlesCanvas';
        canvas.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; opacity: 0.6;';
        document.body.insertBefore(canvas, document.body.firstChild);

        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let particles = [];
        const particleCount = 80;

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 3 + 1;
                this.speedX = Math.random() * 2 - 1;
                this.speedY = Math.random() * 2 - 1;
                this.opacity = Math.random() * 0.5 + 0.2;
            }

            update() {
                this.x += this.speedX;
                this.y += this.speedY;

                if (this.x > canvas.width) this.x = 0;
                if (this.x < 0) this.x = canvas.width;
                if (this.y > canvas.height) this.y = 0;
                if (this.y < 0) this.y = canvas.height;
            }

            draw() {
                ctx.fillStyle = `rgba(0, 39, 118, ${this.opacity})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function initParticles() {
            particles = [];
            for (let i = 0; i < particleCount; i++) {
                particles.push(new Particle());
            }
        }

        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            particles.forEach(particle => {
                particle.update();
                particle.draw();
            });

            // Conectar part√≠culas pr√≥ximas
            for (let i = 0; i < particles.length; i++) {
                for (let j = i + 1; j < particles.length; j++) {
                    const dx = particles[i].x - particles[j].x;
                    const dy = particles[i].y - particles[j].y;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < 120) {
                        ctx.strokeStyle = `rgba(0, 39, 118, ${0.2 * (1 - distance / 120)})`;
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(particles[i].x, particles[i].y);
                        ctx.lineTo(particles[j].x, particles[j].y);
                        ctx.stroke();
                    }
                }
            }

            requestAnimationFrame(animateParticles);
        }

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            initParticles();
        });

        initParticles();
        animateParticles();

        // Ajustar z-index do container principal para ficar sobre as part√≠culas
        const mainContainer = document.querySelector('.main-container');
        if (mainContainer) {
            mainContainer.style.position = 'relative';
            mainContainer.style.zIndex = '1';
        }

        // ========== SISTEMA DE ETIQUETAS ==========
        let etiquetasDisponiveis = [];
        let coletaEtiquetasModal = null;

        async function carregarEtiquetasDisponiveis() {
            try {
                const { data, error } = await supabaseClient
                    .from('etiquetas_coletas')
                    .select('*')
                    .eq('ativo', true)
                    .order('nome', { ascending: true });

                if (error) throw error;
                etiquetasDisponiveis = data || [];
                console.log('üè∑Ô∏è Etiquetas carregadas:', etiquetasDisponiveis.length);
            } catch (error) {
                console.error('‚ùå Erro ao carregar etiquetas:', error);
            }
        }

        async function abrirModalEtiquetas(coletaId) {
            if (!supabaseClient) {
                showNotification('Erro ao conectar com o banco de dados', 'error');
                return;
            }

            coletaEtiquetasModal = coletaId;
            const coleta = coletasData.find(c => c.id === coletaId);
            
            if (!coleta) {
                showNotification('Coleta n√£o encontrada', 'error');
                return;
            }

            // Carregar etiquetas atuais da coleta
            const { data: etiquetasColeta } = await supabaseClient
                .from('coleta_etiquetas')
                .select('etiqueta_id')
                .eq('coleta_id', coletaId);

            const etiquetasAtuaisIds = (etiquetasColeta || []).map(e => e.etiqueta_id);

            // Criar modal ultra moderno com glassmorphism e anima√ß√µes
            const modalHTML = `
                <div class="modal fade show" id="modalEtiquetas" style="
                    display: block; 
                    z-index: 10001; 
                    position: fixed; 
                    top: 0; 
                    left: 0; 
                    width: 100%; 
                    height: 100%; 
                    background: linear-gradient(135deg, rgba(102, 126, 234, 0.95) 0%, rgba(118, 75, 162, 0.95) 100%);
                    backdrop-filter: blur(10px);
                    animation: fadeIn 0.3s ease;
                ">
                    <style>
                        @keyframes fadeIn {
                            from { opacity: 0; }
                            to { opacity: 1; }
                        }
                        @keyframes slideUp {
                            from { 
                                transform: translate(-50%, -45%);
                                opacity: 0;
                            }
                            to { 
                                transform: translate(-50%, -50%);
                                opacity: 1;
                            }
                        }
                        @keyframes pulse {
                            0%, 100% { transform: scale(1); }
                            50% { transform: scale(1.05); }
                        }
                    </style>
                    
                    <div class="modal-dialog" style="
                        position: absolute; 
                        top: 50%; 
                        left: 50%; 
                        transform: translate(-50%, -50%);
                        max-width: 700px; 
                        width: 92%;
                        animation: slideUp 0.4s ease;
                    ">
                        <div class="modal-content" style="
                            border-radius: 25px; 
                            border: 1px solid rgba(255,255,255,0.2);
                            box-shadow: 0 25px 70px rgba(0,0,0,0.4), 0 0 100px rgba(102, 126, 234, 0.3);
                            overflow: hidden;
                            background: rgba(255,255,255,0.05);
                            backdrop-filter: blur(20px);
                        ">
                            <!-- Header futurista com glow effect -->
                            <div class="modal-header" style="
                                background: linear-gradient(135deg, rgba(102, 126, 234, 0.9) 0%, rgba(118, 75, 162, 0.9) 100%);
                                color: white; 
                                padding: 1.8rem 2rem;
                                border: none;
                                position: relative;
                                overflow: hidden;
                            ">
                                <!-- Efeito de part√≠culas -->
                                <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0.3;">
                                    <div style="position: absolute; top: 10px; left: 20px; width: 60px; height: 60px; background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, transparent 70%); border-radius: 50%;"></div>
                                    <div style="position: absolute; bottom: 15px; right: 30px; width: 80px; height: 80px; background: radial-gradient(circle, rgba(255,255,255,0.2) 0%, transparent 70%); border-radius: 50%;"></div>
                                </div>
                                
                                <div style="flex: 1; position: relative; z-index: 1;">
                                    <h5 class="modal-title" style="
                                        margin: 0 0 0.3rem 0; 
                                        font-weight: 800; 
                                        font-size: 1.5rem;
                                        text-shadow: 0 2px 10px rgba(0,0,0,0.2);
                                        letter-spacing: -0.5px;
                                    ">
                                        <i class="fas fa-tags me-2" style="
                                            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
                                            -webkit-background-clip: text;
                                            -webkit-text-fill-color: transparent;
                                        "></i>Gerenciar Etiquetas
                                    </h5>
                                    <small style="
                                        opacity: 0.95; 
                                        display: flex; 
                                        align-items: center; 
                                        gap: 0.5rem;
                                        font-size: 0.85rem;
                                    ">
                                        <i class="fas fa-fingerprint" style="font-size: 0.7rem;"></i>
                                        <span style="font-family: 'Courier New', monospace;">${coleta.id.substring(0, 8)}</span>
                                    </small>
                                </div>
                                <button type="button" class="btn-close btn-close-white" onclick="fecharModalEtiquetas()" style="
                                    filter: brightness(0) invert(1);
                                    opacity: 0.8;
                                    transition: all 0.3s;
                                    position: relative;
                                    z-index: 1;
                                " onmouseover="this.style.opacity='1'; this.style.transform='rotate(90deg) scale(1.1)';" onmouseout="this.style.opacity='0.8'; this.style.transform='rotate(0deg) scale(1)';"></button>
                            </div>
                            
                            <!-- Body com glassmorphism e grid animado -->
                            <div class="modal-body" style="
                                max-height: 480px; 
                                overflow-y: auto; 
                                padding: 2rem;
                                background: linear-gradient(135deg, rgba(248, 249, 250, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%);
                                position: relative;
                            ">
                                <p style="
                                    color: #495057; 
                                    margin-bottom: 1.5rem; 
                                    font-size: 0.95rem;
                                    font-weight: 500;
                                    display: flex;
                                    align-items: center;
                                    gap: 0.5rem;
                                ">
                                    <i class="fas fa-magic" style="color: #667eea;"></i>
                                    <span>Selecione as etiquetas que deseja vincular √† esta coleta:</span>
                                </p>
                                <div id="lista-etiquetas-modal" style="
                                    display: grid; 
                                    gap: 1rem;
                                ">
                                    ${etiquetasDisponiveis.map((et, index) => `
                                        <label class="etiqueta-checkbox-ultra-modern" for="etiqueta-${et.id}" style="
                                            display: flex;
                                            align-items: center;
                                            padding: 1.2rem 1.5rem;
                                            background: ${etiquetasAtuaisIds.includes(et.id) ? 
                                                `linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%)` : 
                                                'white'};
                                            border: 2px solid ${etiquetasAtuaisIds.includes(et.id) ? et.cor : '#e0e0e0'};
                                            border-radius: 16px;
                                            cursor: pointer;
                                            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                                            box-shadow: ${etiquetasAtuaisIds.includes(et.id) ? 
                                                `0 8px 25px ${et.cor}40` : 
                                                '0 3px 15px rgba(0,0,0,0.08)'};
                                            position: relative;
                                            overflow: hidden;
                                            opacity: 0;
                                            animation: fadeInSlide 0.5s ease ${index * 0.05}s forwards;
                                        " onmouseover="
                                            this.style.transform='translateY(-4px) scale(1.02)';
                                            this.style.boxShadow='0 12px 35px ${et.cor}50';
                                            this.style.borderColor='${et.cor}';
                                        " onmouseout="
                                            this.style.transform='translateY(0) scale(1)';
                                            this.style.boxShadow='${etiquetasAtuaisIds.includes(et.id) ? 
                                                `0 8px 25px ${et.cor}40` : 
                                                '0 3px 15px rgba(0,0,0,0.08)'}';
                                            this.style.borderColor='${etiquetasAtuaisIds.includes(et.id) ? et.cor : '#e0e0e0'}';
                                        ">
                                            <style>
                                                @keyframes fadeInSlide {
                                                    from {
                                                        opacity: 0;
                                                        transform: translateX(-20px);
                                                    }
                                                    to {
                                                        opacity: 1;
                                                        transform: translateX(0);
                                                    }
                                                }
                                            </style>
                                            
                                            <!-- Indicador de sele√ß√£o -->
                                            <input type="checkbox" 
                                                class="form-check-input" 
                                                id="etiqueta-${et.id}" 
                                                value="${et.id}"
                                                ${etiquetasAtuaisIds.includes(et.id) ? 'checked' : ''}
                                                style="
                                                    width: 24px; 
                                                    height: 24px; 
                                                    cursor: pointer; 
                                                    margin-right: 1.2rem; 
                                                    accent-color: ${et.cor};
                                                    z-index: 1;
                                                    position: relative;
                                                ">
                                            
                                            <!-- Badge com glow effect -->
                                            <span class="badge etiqueta-badge-modern" style="
                                                background: ${et.cor}; 
                                                color: white; 
                                                padding: 0.8rem 1.5rem; 
                                                border-radius: 12px; 
                                                font-size: 0.95rem;
                                                font-weight: 700;
                                                box-shadow: 0 4px 15px ${et.cor}50, inset 0 1px 0 rgba(255,255,255,0.3);
                                                display: flex;
                                                align-items: center;
                                                gap: 0.6rem;
                                                position: relative;
                                                overflow: hidden;
                                            ">
                                                <i class="fas fa-tag" style="font-size: 0.85rem;"></i> 
                                                ${et.nome}
                                                ${etiquetasAtuaisIds.includes(et.id) ? `
                                                    <span style="
                                                        background: rgba(255,255,255,0.3);
                                                        padding: 0.15rem 0.5rem;
                                                        border-radius: 10px;
                                                        font-size: 0.7rem;
                                                        margin-left: 0.3rem;
                                                    ">‚úì</span>
                                                ` : ''}
                                            </span>
                                            
                                            ${et.descricao ? `
                                                <div style="
                                                    margin-left: auto; 
                                                    color: #6c757d; 
                                                    font-size: 0.85rem;
                                                    font-style: italic;
                                                    max-width: 200px;
                                                    text-align: right;
                                                ">
                                                    <i class="fas fa-info-circle"></i> ${et.descricao}
                                                </div>
                                            ` : '<span style="margin-left: auto;"></span>'}
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Footer futurista com bot√µes 3D -->
                            <div class="modal-footer" style="
                                background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(248, 249, 250, 0.95) 100%);
                                padding: 1.5rem 2rem; 
                                border-top: 1px solid rgba(0,0,0,0.08); 
                                display: flex; 
                                justify-content: space-between; 
                                gap: 1rem;
                            ">
                                <button type="button" class="btn btn-lg btn-cancel" onclick="fecharModalEtiquetas()" style="
                                    background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%);
                                    color: #495057;
                                    border: none;
                                    padding: 0.85rem 2rem;
                                    border-radius: 12px;
                                    font-weight: 700;
                                    font-size: 0.95rem;
                                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                                    flex: 1;
                                    box-shadow: 0 3px 15px rgba(0,0,0,0.08);
                                " onmouseover="
                                    this.style.background='linear-gradient(135deg, #e0e0e0 0%, #d0d0d0 100%)';
                                    this.style.transform='translateY(-2px)';
                                    this.style.boxShadow='0 6px 20px rgba(0,0,0,0.12)';
                                " onmouseout="
                                    this.style.background='linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%)';
                                    this.style.transform='translateY(0)';
                                    this.style.boxShadow='0 3px 15px rgba(0,0,0,0.08)';
                                ">
                                    <i class="fas fa-times-circle me-2"></i>Cancelar
                                </button>
                                <button type="button" class="btn btn-lg btn-save" onclick="salvarEtiquetasColeta()" style="
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    border: none;
                                    padding: 0.85rem 2rem;
                                    border-radius: 12px;
                                    font-weight: 700;
                                    font-size: 0.95rem;
                                    flex: 1;
                                    box-shadow: 0 6px 25px rgba(102, 126, 234, 0.5);
                                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                                    position: relative;
                                    overflow: hidden;
                                " onmouseover="
                                    this.style.transform='translateY(-3px) scale(1.02)';
                                    this.style.boxShadow='0 10px 35px rgba(102, 126, 234, 0.6)';
                                " onmouseout="
                                    this.style.transform='translateY(0) scale(1)';
                                    this.style.boxShadow='0 6px 25px rgba(102, 126, 234, 0.5)';
                                " onmousedown="this.style.transform='translateY(-1px) scale(0.98)';" onmouseup="this.style.transform='translateY(-3px) scale(1.02)';">
                                    <i class="fas fa-save me-2"></i>Salvar Etiquetas
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modalHTML;
            document.body.appendChild(modalDiv);

            // Adicionar overlay
            const overlay = document.createElement('div');
            overlay.className = 'modal-backdrop fade show';
            document.body.appendChild(overlay);
        }

        function fecharModalEtiquetas() {
            const modal = document.getElementById('modalEtiquetas');
            const overlay = document.querySelector('.modal-backdrop');
            if (modal) modal.remove();
            if (overlay) overlay.remove();
            coletaEtiquetasModal = null;
        }

        async function salvarEtiquetasColeta() {
            if (!coletaEtiquetasModal) return;

            try {
                // Obter etiquetas selecionadas
                const checkboxes = document.querySelectorAll('#modalEtiquetas input[type="checkbox"]:checked');
                const etiquetasSelecionadas = Array.from(checkboxes).map(cb => cb.value);

                // Buscar etiquetas antigas para comparar
                const { data: etiquetasAntigasData } = await supabaseClient
                    .from('coleta_etiquetas')
                    .select(`
                        etiqueta_id,
                        etiquetas_coletas:etiqueta_id (
                            id,
                            nome
                        )
                    `)
                    .eq('coleta_id', coletaEtiquetasModal);

                const etiquetasAntigas = etiquetasAntigasData?.map(e => e.etiquetas_coletas?.nome).filter(Boolean) || [];

                // Buscar nomes das novas etiquetas
                const { data: etiquetasData } = await supabaseClient
                    .from('etiquetas_coletas')
                    .select('id, nome')
                    .in('id', etiquetasSelecionadas);

                const etiquetasNovas = etiquetasData?.map(e => e.nome) || [];

                // Remover todas as etiquetas da coleta
                const { error: deleteError } = await supabaseClient
                    .from('coleta_etiquetas')
                    .delete()
                    .eq('coleta_id', coletaEtiquetasModal);

                if (deleteError) throw deleteError;

                // Adicionar novas etiquetas
                if (etiquetasSelecionadas.length > 0) {
                    const novasEtiquetas = etiquetasSelecionadas.map(etId => ({
                        coleta_id: coletaEtiquetasModal,
                        etiqueta_id: etId
                    }));

                    const { error: insertError } = await supabaseClient
                        .from('coleta_etiquetas')
                        .insert(novasEtiquetas);

                    if (insertError) throw insertError;
                }

                // Registrar no hist√≥rico
                let detalhesHistorico = '';
                if (etiquetasNovas.length > 0 && etiquetasAntigas.length > 0) {
                    // Houve mudan√ßa
                    detalhesHistorico = `Etiquetas alteradas: ${etiquetasAntigas.join(', ')} ‚Üí ${etiquetasNovas.join(', ')}`;
                } else if (etiquetasNovas.length > 0) {
                    // Adicionadas novas etiquetas
                    detalhesHistorico = `Etiquetas adicionadas: ${etiquetasNovas.join(', ')}`;
                } else if (etiquetasAntigas.length > 0) {
                    // Todas as etiquetas foram removidas
                    detalhesHistorico = `Etiquetas removidas: ${etiquetasAntigas.join(', ')}`;
                } else {
                    detalhesHistorico = 'Nenhuma etiqueta vinculada';
                }

                await salvarNoHistorico(coletaEtiquetasModal, 'etiquetas_alteradas', detalhesHistorico);

                showNotification('Etiquetas salvas com sucesso!', 'success');
                fecharModalEtiquetas();
                
                // Recarregar coletas para atualizar as etiquetas
                await carregarColetas();
                
            } catch (error) {
                console.error('‚ùå Erro ao salvar etiquetas:', error);
                showNotification('Erro ao salvar etiquetas: ' + error.message, 'error');
            }
        }

        // Modificar carregarColetas para buscar etiquetas tamb√©m
        const originalCarregarColetas = carregarColetas;
        carregarColetas = async function() {
            await originalCarregarColetas();
            
            // ‚úÖ OTIMIZA√á√ÉO: Buscar todas as etiquetas de uma vez em vez de loop individual
            if (coletasData.length > 0) {
                try {
                    const coletasIds = coletasData.map(c => c.id);
                    
                    // Buscar todas as etiquetas relacionadas √†s coletas de uma vez
                    const { data: todasEtiquetas, error: etiquetasError } = await supabaseClient
                    .from('coleta_etiquetas')
                    .select(`
                            coleta_id,
                        etiqueta_id,
                        etiquetas_coletas:etiqueta_id (
                            id,
                            nome,
                            cor
                        )
                    `)
                        .in('coleta_id', coletasIds);
                    
                    if (etiquetasError) {
                        console.warn('‚ö†Ô∏è Erro ao buscar etiquetas:', etiquetasError);
                        // Continuar sem etiquetas em caso de erro
                        coletasData.forEach(coleta => {
                            coleta.etiquetas = [];
                        });
                } else {
                        // Agrupar etiquetas por coleta_id
                        const etiquetasPorColeta = {};
                        if (todasEtiquetas) {
                            todasEtiquetas.forEach(e => {
                                if (!etiquetasPorColeta[e.coleta_id]) {
                                    etiquetasPorColeta[e.coleta_id] = [];
                                }
                                if (e.etiquetas_coletas) {
                                    etiquetasPorColeta[e.coleta_id].push(e.etiquetas_coletas);
                                }
                            });
                        }
                        
                        // Atribuir etiquetas √†s coletas
                        coletasData.forEach(coleta => {
                            coleta.etiquetas = etiquetasPorColeta[coleta.id] || [];
                        });
                        
                        console.log('‚úÖ Etiquetas carregadas para', Object.keys(etiquetasPorColeta).length, 'coletas');
                    }
                } catch (error) {
                    console.error('‚ùå Erro ao carregar etiquetas:', error);
                    // Continuar sem etiquetas em caso de erro
                    coletasData.forEach(coleta => {
                    coleta.etiquetas = [];
                    });
                }
            }
            
            // N√£o precisa chamar renderColetas() novamente, pois originalCarregarColetas j√° chama
            // Apenas atualizar stats se necess√°rio
            updateStats();
        };

        // Expor fun√ß√µes globalmente para uso em inline handlers
        window.trocarMotorista = trocarMotorista;
        window.reprovarMotorista = reprovarMotorista;
        window.vincularMotorista = vincularMotorista;
        window.fecharModalMotorista = fecharModalMotorista;
        window.filtrarMotoristas = filtrarMotoristas;
        window.verDetalhesMotorista = verDetalhesMotorista;
        window.selecionarMotorista = selecionarMotorista;
        window.confirmarPagamento = confirmarPagamento;
        window.alternarVisualizacao = alternarVisualizacao;
    </script>
<!-- Chat IA -->
<link rel="stylesheet" href="../css/chat-ia.css">
<script src="../js/chat-ia.js"></script>
</body>
</html>


