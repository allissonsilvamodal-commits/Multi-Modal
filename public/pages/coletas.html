<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Coletas - Portal de Ferramentas</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/permissions.js"></script>
    <!-- SortableJS para drag and drop robusto -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --azul-escuro: #002776;/* ============================================
   PORTAL LUCID - Estilos do Portal
   ============================================ */

/* Header do Portal - Agora usado apenas para o header interno */
/* Estilos movidos para portal-sidebar.css */

.portal-header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, rgba(77, 166, 255, 0.5), rgba(111, 124, 255, 0.5), rgba(77, 166, 255, 0.5), transparent);
  opacity: 0.8;
  animation: header-glow 3s ease-in-out infinite;
}

@keyframes header-glow {
  0%, 100% { opacity: 0.5; }
  50% { opacity: 1; }
}

.header-content {
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: var(--spacing-lg);
}

.portal-logo {
  display: flex;
  flex-direction: column;
  line-height: 1;
  margin: 0;
}

.logo-gradient {
  font-size: 1.8rem;
  font-weight: var(--font-weight-bold);
  background: var(--gradient-hero);
  background-size: 200% 200%;
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  filter: drop-shadow(0 0 10px rgba(77, 166, 255, 0.5));
  animation: gradient-shift 3s ease infinite;
  letter-spacing: 2px;
}

@keyframes gradient-shift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

.logo-subtitle {
  font-size: 0.75rem;
  color: var(--text-tertiary);
  font-weight: var(--font-weight-normal);
  margin-top: 2px;
  letter-spacing: 1px;
}

.portal-nav {
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
}

.nav-link {
  display: flex;
  align-items: center;
  gap: var(--spacing-xs);
  padding: var(--spacing-xs) var(--spacing-sm);
  color: var(--text-secondary);
  text-decoration: none;
  border-radius: var(--border-radius-sm);
  transition: all var(--transition-base);
  position: relative;
  font-size: 0.95rem;
}

.nav-link::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 50%;
  width: 0;
  height: 2px;
  background: var(--gradient-primary);
  transform: translateX(-50%);
  transition: width var(--transition-base);
}

.nav-link:hover,
.nav-link.active {
  color: var(--text-primary);
  background: rgba(77, 166, 255, 0.1);
}

.nav-link:hover::after,
.nav-link.active::after {
  width: 80%;
}

.nav-user {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  padding-left: var(--spacing-md);
  border-left: 1px solid rgba(77, 166, 255, 0.2);
}

.user-name {
  color: var(--text-secondary);
  font-size: 0.9rem;
}

.btn-logout {
  background: rgba(239, 68, 68, 0.1);
  border: 1px solid rgba(239, 68, 68, 0.3);
  color: #ef4444;
  padding: var(--spacing-xs) var(--spacing-sm);
  border-radius: var(--border-radius-sm);
  cursor: pointer;
  transition: all var(--transition-base);
  font-size: 0.9rem;
}

.btn-logout:hover {
  background: rgba(239, 68, 68, 0.2);
  border-color: rgba(239, 68, 68, 0.5);
  transform: translateY(-2px);
}

/* Main Container */
.portal-main {
  padding: var(--spacing-2xl) 0;
  min-height: calc(100vh - 200px);
  position: relative;
  z-index: 1;
}

.portal-section {
  margin-bottom: var(--spacing-3xl);
}

.section-header {
  text-align: left;
  margin-bottom: var(--spacing-2xl);
  padding-bottom: var(--spacing-lg);
  border-bottom: 1px solid rgba(77, 166, 255, 0.1);
}

.section-title {
  font-size: 2rem;
  font-weight: var(--font-weight-bold);
  margin-bottom: var(--spacing-2);
  color: var(--text-primary);
  position: relative;
  display: inline-block;
  letter-spacing: -0.5px;
}

.section-title::after {
  content: '';
  position: absolute;
  bottom: -8px;
  left: 0;
  width: 50px;
  height: 3px;
  background: var(--gradient-primary);
  border-radius: 2px;
}

.section-subtitle {
  font-size: 1rem;
  color: var(--text-secondary);
  max-width: 700px;
  margin: 0;
  line-height: 1.6;
  opacity: 0.9;
}

/* Métricas */
.metrics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
  gap: var(--spacing-lg);
  margin-top: var(--spacing-xl);
}

.metric-card {
  background: linear-gradient(135deg, rgba(18, 23, 38, 0.8) 0%, rgba(11, 14, 20, 0.9) 100%);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(77, 166, 255, 0.2);
  border-radius: var(--border-radius-lg);
  padding: var(--spacing-lg);
  display: flex;
  align-items: center;
  gap: var(--spacing-md);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

.metric-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--gradient-hero);
  background-size: 200% 100%;
  transform: scaleX(0);
  transition: transform 0.3s ease;
  animation: gradient-shift 3s ease infinite;
}

.metric-card::after {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(77, 166, 255, 0.1) 0%, transparent 70%);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.metric-card:hover {
  transform: translateY(-4px);
  border-color: rgba(77, 166, 255, 0.4);
  box-shadow: 0 12px 40px rgba(77, 166, 255, 0.3), 0 0 60px rgba(77, 166, 255, 0.1);
  background: linear-gradient(135deg, rgba(18, 23, 38, 0.95) 0%, rgba(11, 14, 20, 0.95) 100%);
}

.metric-card:hover::before {
  transform: scaleX(1);
}

.metric-card:hover::after {
  opacity: 1;
}

.metric-icon {
  width: 56px;
  height: 56px;
  border-radius: var(--border-radius-md);
  background: var(--gradient-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 1.4rem;
  color: white;
  flex-shrink: 0;
  box-shadow: 0 4px 15px rgba(77, 166, 255, 0.4);
  transition: transform 0.3s ease;
}

.metric-card:hover .metric-icon {
  transform: scale(1.1) rotate(5deg);
}

.metric-content {
  flex: 1;
  min-width: 0;
}

.metric-value {
  font-size: 2rem;
  font-weight: var(--font-weight-bold);
  color: var(--text-primary);
  line-height: 1.2;
  margin-bottom: var(--spacing-1);
  letter-spacing: -0.5px;
}

.metric-label {
  font-size: 0.875rem;
  color: var(--text-secondary);
  font-weight: var(--font-weight-normal);
  opacity: 0.9;
}

/* Grid de Ferramentas */
.tools-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: var(--spacing-lg);
  margin-top: var(--spacing-xl);
}

.tool-card {
  background: rgba(18, 23, 38, 0.7);
  backdrop-filter: blur(20px) saturate(180%);
  -webkit-backdrop-filter: blur(20px) saturate(180%);
  border: 1px solid rgba(77, 166, 255, 0.25);
  border-radius: var(--border-radius-lg);
  padding: var(--spacing-xl);
  transition: all var(--transition-base);
  position: relative;
  overflow: hidden;
  text-decoration: none;
  color: inherit;
  display: flex;
  flex-direction: column;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.05);
}

.tool-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: var(--gradient-hero);
  background-size: 200% 100%;
  transform: scaleX(0);
  transition: transform var(--transition-base);
  animation: gradient-shift 3s ease infinite;
}

.tool-card::after {
  content: '';
  position: absolute;
  top: -50%;
  left: -50%;
  width: 200%;
  height: 200%;
  background: radial-gradient(circle, rgba(77, 166, 255, 0.1) 0%, transparent 70%);
  opacity: 0;
  transition: opacity var(--transition-base);
  pointer-events: none;
}

.tool-card:hover {
  transform: translateY(-8px) scale(1.03);
  border-color: rgba(77, 166, 255, 0.6);
  box-shadow: 
    0 16px 50px rgba(0, 0, 0, 0.4),
    0 0 50px rgba(77, 166, 255, 0.4),
    0 0 80px rgba(111, 124, 255, 0.2),
    inset 0 1px 0 rgba(255, 255, 255, 0.1);
  background: rgba(18, 23, 38, 0.85);
  color: inherit;
  text-decoration: none;
}

.tool-card:hover::before {
  transform: scaleX(1);
}

.tool-card:hover::after {
  opacity: 1;
  animation: card-glow 3s ease-in-out infinite;
}

@keyframes card-glow {
  0%, 100% {
    transform: scale(1) rotate(0deg);
  }
  50% {
    transform: scale(1.1) rotate(180deg);
  }
}

.tool-icon {
  width: 70px;
  height: 70px;
  border-radius: var(--border-radius-md);
  background: var(--gradient-primary);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 2rem;
  color: white;
  margin-bottom: var(--spacing-md);
  box-shadow: 0 4px 15px rgba(77, 166, 255, 0.4);
  position: relative;
  z-index: 1;
  transition: all var(--transition-base);
}

.tool-card:hover .tool-icon {
  transform: scale(1.1) rotate(5deg);
  box-shadow: 0 8px 25px rgba(77, 166, 255, 0.6);
}

.tool-name {
  font-size: 1.25rem;
  font-weight: var(--font-weight-bold);
  color: var(--text-primary);
  margin-bottom: var(--spacing-xs);
  position: relative;
  z-index: 1;
}

.tool-description {
  font-size: 0.95rem;
  color: var(--text-secondary);
  line-height: 1.6;
  flex-grow: 1;
  position: relative;
  z-index: 1;
}

.tool-badge {
  display: inline-block;
  background: rgba(245, 158, 11, 0.2);
  border: 1px solid rgba(245, 158, 11, 0.4);
  color: #f59e0b;
  padding: 4px 12px;
  border-radius: var(--border-radius-sm);
  font-size: 0.75rem;
  font-weight: var(--font-weight-semibold);
  margin-top: var(--spacing-sm);
  position: relative;
  z-index: 1;
}

/* Badge de destaque para ferramentas principais */
.featured-badge {
  position: absolute;
  top: var(--spacing-md);
  right: var(--spacing-md);
  background: var(--gradient-hero);
  color: white;
  padding: 6px 12px;
  border-radius: var(--border-radius-sm);
  font-size: 0.75rem;
  font-weight: var(--font-weight-bold);
  display: flex;
  align-items: center;
  gap: 6px;
  box-shadow: 0 2px 10px rgba(77, 166, 255, 0.4);
  z-index: 2;
  animation: pulse-badge 2s ease-in-out infinite;
}

@keyframes pulse-badge {
  0%, 100% {
    box-shadow: 0 2px 10px rgba(77, 166, 255, 0.4);
    transform: scale(1);
  }
  50% {
    box-shadow: 0 4px 20px rgba(77, 166, 255, 0.6);
    transform: scale(1.05);
  }
}

.featured-badge i {
  font-size: 0.7rem;
}

/* Destaque para ferramentas principais */
.tool-featured {
  border-color: rgba(77, 166, 255, 0.4) !important;
  background: rgba(18, 23, 38, 0.8) !important;
}

.tool-featured::before {
  opacity: 1;
  transform: scaleX(1);
}

.tool-featured:hover {
  border-color: rgba(77, 166, 255, 0.7) !important;
  box-shadow: 
    0 16px 50px rgba(0, 0, 0, 0.4),
    0 0 60px rgba(77, 166, 255, 0.5),
    0 0 90px rgba(111, 124, 255, 0.3),
    inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
}

.tool-link {
  margin-top: var(--spacing-md);
  display: inline-flex;
  align-items: center;
  gap: var(--spacing-xs);
  color: var(--color-primary);
  font-weight: var(--font-weight-semibold);
  font-size: 0.9rem;
  position: relative;
  z-index: 1;
  transition: all var(--transition-base);
}

.tool-card:hover .tool-link {
  color: var(--color-accent);
  transform: translateX(5px);
}

.tool-coming-soon {
  opacity: 0.8;
  cursor: not-allowed;
}

.tool-coming-soon:hover {
  opacity: 0.9;
}

/* Footer */
.portal-footer {
  background: var(--bg-secondary);
  border-top: 1px solid rgba(77, 166, 255, 0.2);
  padding: var(--spacing-lg) 0;
  text-align: center;
  color: var(--text-tertiary);
  font-size: 0.9rem;
  position: relative;
  z-index: 0; /* Garantir que fique atrás dos cards do Kanban */
}

/* Alertas */
#alertContainer {
  margin-bottom: var(--spacing-lg);
}

.alert-portal {
  background: rgba(18, 23, 38, 0.8);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(77, 166, 255, 0.3);
  border-radius: var(--border-radius-md);
  padding: var(--spacing-md);
  margin-bottom: var(--spacing-md);
  color: var(--text-primary);
  position: relative;
  overflow: hidden;
}

.alert-portal::before {
  content: '';
  position: absolute;
  left: 0;
  top: 0;
  bottom: 0;
  width: 4px;
  background: var(--gradient-primary);
}

.alert-portal.success::before {
  background: linear-gradient(135deg, #22c55e, #16a34a);
}

.alert-portal.error::before {
  background: linear-gradient(135deg, #ef4444, #dc2626);
}

.alert-portal.warning::before {
  background: linear-gradient(135deg, #f59e0b, #d97706);
}

/* Responsividade */
@media (max-width: 768px) {
  .header-content {
    flex-direction: column;
    align-items: flex-start;
  }
  
  .portal-nav {
    flex-wrap: wrap;
    width: 100%;
  }
  
  .nav-user {
    border-left: none;
    border-top: 1px solid rgba(77, 166, 255, 0.2);
    padding-left: 0;
    padding-top: var(--spacing-sm);
    width: 100%;
    justify-content: space-between;
  }
  
  .metrics-grid {
    grid-template-columns: 1fr;
  }
  
  .tools-grid {
    grid-template-columns: 1fr;
  }
  
  .metric-card {
    flex-direction: column;
    text-align: center;
  }
}


            --vermelho: #C60C30;
            --branco: #FFFFFF;
            --cinza-claro: #F5F5F5;
            --cinza-escuro: #333333;
            --azul-claro: #4A7BFF;
            --verde: #28a745;
            --laranja: #fd7e14;
            --roxo: #6f42c1;
            --ciano: #20c997;
            --gradient-primary: linear-gradient(135deg, #002776 0%, #0044AA 100%);
            --gradient-danger: linear-gradient(135deg, #C60C30 0%, #E63946 100%);
            --gradient-success: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            --gradient-warning: linear-gradient(135deg, #fd7e14 0%, #ffc107 100%);
            --gradient-purple: linear-gradient(135deg, #6f42c1 0%, #8B5FBF 100%);
            --shadow: 0 10px 30px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --card-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            --hover-shadow: 0 15px 40px rgba(0, 0, 0, 0.15);
            --border-radius: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 50%, #e2e8f0 100%);
            background-attachment: fixed;
            color: var(--cinza-escuro);
            line-height: 1.6;
            min-height: 100vh;
            transition: var(--transition);
            overflow-x: hidden;
            position: relative;
        }

        /* Zoom em telas menores: 100% em telas grandes fica pesado; reduzir para melhor aproveitamento */
        @media (max-width: 1600px) {
            html { zoom: 0.9; }
        }
        @media (max-width: 1400px) {
            html { zoom: 0.85; }
        }
        @media (max-width: 1200px) {
            html { zoom: 0.8; }
        }
        @media (max-width: 992px) {
            html { zoom: 0.75; }
        }

        /* Header Moderno */
        .main-header {
            background: linear-gradient(135deg, #002776 0%, #0044AA 100%);
            color: var(--branco);
            padding: 0.5rem 0;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15), 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
            z-index: 10;
            border-bottom: 2px solid rgba(255, 255, 255, 0.12);
        }
        
        .main-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.05), transparent);
            animation: headerShine 3s ease-in-out infinite;
        }
        
        @keyframes headerShine {
            0%, 100% { opacity: 0.3; }
            50% { opacity: 0.6; }
        }

        .header-content {
            position: relative;
            z-index: 1;
            max-width: 100%;
            margin: 0 auto;
            padding: 0 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: nowrap;
            gap: 0.75rem;
        }

        .header-title {
            font-size: 1rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            letter-spacing: -0.3px;
        }

        .header-title i {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.8rem;
            border-radius: 12px;
            backdrop-filter: blur(10px);
        }

        .header-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            font-weight: 300;
            margin-top: 0.5rem;
        }

        .header-actions {
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 0.9rem;
            background: rgba(255, 255, 255, 0.18);
            backdrop-filter: blur(15px);
            padding: 0.75rem 1.25rem;
            border-radius: 14px;
            border: 1.5px solid rgba(255, 255, 255, 0.25);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .user-info:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, #ffffff 0%, #f0f4ff 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--azul-escuro);
            font-weight: 700;
            font-size: 0.95rem;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
            transition: all 0.3s ease;
        }
        
        .user-info:hover .user-avatar {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.9rem;
        }

        .user-role {
            font-size: 0.75rem;
            opacity: 0.8;
        }

        /* Botões Modernos */
        .btn-modern {
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 2px solid rgba(255, 255, 255, 0.3);
            color: var(--branco);
            padding: 0.8rem 1.5rem;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.7rem;
            text-decoration: none;
            position: relative;
            overflow: hidden;
        }

        .btn-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: var(--transition);
        }

        .btn-modern:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(255, 255, 255, 0.2);
        }

        .btn-modern:hover::before {
            left: 100%;
        }

        /* Container Principal */
        .main-container {
            max-width: 100%;
            margin: 0 auto;
            padding: 0.5rem 0.75rem;
            position: relative;
            z-index: 1;
        }

        /* Filtros e Controles - Otimizado e Melhorado */
        .controls-container {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 14px;
            padding: 1.25rem 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06), 0 2px 8px rgba(102, 126, 234, 0.08);
            border: 1.5px solid rgba(102, 126, 234, 0.12);
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        .controls-container:hover {
            box-shadow: 0 6px 24px rgba(0, 0, 0, 0.1), 0 4px 12px rgba(102, 126, 234, 0.12);
        }

        .filters-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            min-width: 140px;
        }

        .filter-group label {
            font-weight: 600;
            color: var(--azul-escuro);
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .filter-group select,
        .filter-group input {
            padding: 0.65rem 0.9rem;
            border: 2px solid rgba(102, 126, 234, 0.15);
            border-radius: 10px;
            font-size: 0.85rem;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            color: #212529;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
        }
        
        .filter-group select:hover,
        .filter-group input:hover {
            border-color: rgba(102, 126, 234, 0.25);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15), 0 4px 12px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
            background: #ffffff;
        }

        /* Filtros de Data Específicos - Compacto */
        .date-filters {
            display: grid;
            grid-template-columns: auto auto 1fr;
            gap: 0.85rem;
            align-items: end;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.04) 0%, rgba(118, 75, 162, 0.04) 100%);
            border-radius: 12px;
            margin-bottom: 0.85rem;
            border: 1.5px solid rgba(102, 126, 234, 0.12);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
            transition: all 0.3s ease;
        }
        
        .date-filters:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.18);
        }
        
        @media (max-width: 768px) {
            .date-filters {
                grid-template-columns: 1fr;
            }
            
            .filters-row {
                grid-template-columns: 1fr;
            }
            
            .controls-container {
                padding: 1rem;
            }
        }

        .date-filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            min-width: 140px;
        }

        .date-filter-group label {
            font-weight: 600;
            color: var(--azul-escuro);
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .date-filter-group input {
            padding: 0.65rem 0.9rem;
            border: 2px solid rgba(102, 126, 234, 0.15);
            border-radius: 10px;
            font-size: 0.85rem;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            color: #212529;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 500;
        }
        
        .date-filter-group input:hover {
            border-color: rgba(102, 126, 234, 0.25);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);
        }
        
        .date-filter-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.15), 0 4px 12px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
            background: #ffffff;
        }

        .quick-date-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 0.5rem;
        }

        .quick-date-btn {
            padding: 0.5rem 1rem;
            border: 2px solid rgba(102, 126, 234, 0.2);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 249, 250, 0.9) 100%);
            color: #667eea;
            border-radius: 10px;
            cursor: pointer;
            font-size: 0.8rem;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .quick-date-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
        }
        
        .quick-date-btn:hover::before {
            width: 200%;
            height: 200%;
        }

        .quick-date-btn:hover {
            border-color: #667eea;
            color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.25);
        }
        
        .quick-date-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: #667eea;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4), 0 2px 8px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }
        
        .quick-date-btn.active::before {
            background: rgba(255, 255, 255, 0.2);
        }

        .stats-container {
            display: flex;
            gap: 0.4rem;
            flex-wrap: nowrap;
            margin: 0 auto 0.4rem auto;
            overflow-x: auto;
            padding: 0.4rem 0.5rem;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.02) 0%, rgba(118, 75, 162, 0.02) 100%);
            border-radius: 8px;
            border: 1px solid rgba(102, 126, 234, 0.08);
            scrollbar-width: none;
            -ms-overflow-style: none;
            justify-content: center;
            max-width: fit-content;
        }

        .stats-container::-webkit-scrollbar {
            display: none;
        }

        .stat-card {
            color: var(--branco);
            padding: 0.65rem 1rem;
            border-radius: 12px;
            text-align: center;
            min-width: 160px;
            flex: 0 0 auto;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12), 0 2px 6px rgba(0, 0, 0, 0.08);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            transition: left 0.6s ease;
        }
        
        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at top right, rgba(255, 255, 255, 0.2) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2), 0 4px 12px rgba(0, 0, 0, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .stat-card:hover::after {
            opacity: 1;
        }

        .stat-card:hover::before {
            left: 100%;
        }

        .stat-card > div:first-child {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.1rem;
            width: 100%;
        }
        
        .stat-card > .stat-label {
            width: 100%;
            text-align: center;
        }

        .stat-number {
            font-size: 0.95rem;
            font-weight: 700;
            line-height: 1.1;
            letter-spacing: -0.2px;
        }

        .stat-value {
            font-size: 0.7rem;
            font-weight: 600;
            opacity: 0.9;
            line-height: 1.1;
            margin-top: 0.1rem;
        }

        .stat-label {
            font-size: 0.65rem;
            opacity: 0.85;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }

        /* Grid de Cards de Coletas */
        .coletas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 2rem;
            margin-bottom: 3rem;
        }

        /* ========== ESTILOS FUNIL GERAL ========== */
        .funil-geral-container {
            display: none; /* Oculto por padrão, será mostrado apenas quando a aba Funil Geral estiver ativa */
            margin: 1.5rem 0;
            padding: 1.5rem;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 16px;
            border: 1px solid rgba(102, 126, 234, 0.15);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
        }

        .funil-geral-container.visible {
            display: block;
        }
        
        /* Quando o funil geral está ativo, ocultar controles do kanban */
        .kanban-container:has(+ .funil-geral-container.visible),
        .funil-geral-container.visible ~ .kanban-container {
            display: none !important;
        }

        .funil-geral-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid rgba(102, 126, 234, 0.2);
        }

        .funil-geral-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .funil-geral-title i {
            font-size: 1.5rem;
        }

        .funil-geral-stats {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            color: #6c757d;
        }

        .funil-geral-stats span {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .funil-geral-stats strong {
            color: #667eea;
            font-weight: 700;
        }

        .funil-etapas-wrapper {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            overflow-x: auto;
            padding: 0.5rem 0;
        }

        .funil-etapa-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #ffffff;
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.1);
            transition: all 0.3s ease;
            position: relative;
        }

        .funil-etapa-item:hover {
            border-color: rgba(102, 126, 234, 0.3);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }

        .funil-etapa-ordem {
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            font-weight: 700;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .funil-etapa-info {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .funil-etapa-nome {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2d3748;
        }

        .funil-etapa-detalhes {
            display: flex;
            gap: 1.5rem;
            flex-wrap: wrap;
            font-size: 0.9rem;
            color: #6c757d;
        }

        .funil-etapa-detalhe {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .funil-etapa-detalhe i {
            color: #667eea;
        }

        .funil-etapa-detalhe strong {
            color: #2d3748;
            font-weight: 600;
        }

        .funil-etapa-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .funil-etapa-badge.quantidade {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .funil-etapa-badge.valor {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .funil-etapa-badge.tempo-medio {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        @media (max-width: 768px) {
            .funil-geral-container {
                padding: 1rem;
            }

            .funil-geral-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .funil-etapa-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .funil-etapa-detalhes {
                width: 100%;
            }
        }

        /* ========== ESTILOS KANBAN ========== */

        /* Barra de rolagem customizada estilo slider - Parte inferior */
        .kanban-scrollbar-wrapper {
            position: relative;
            width: 100%;
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            display: block; /* Sempre visível quando há múltiplas colunas */
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            border-top: 2px solid rgba(102, 126, 234, 0.3);
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.1), 0 4px 12px rgba(102, 126, 234, 0.15);
            z-index: 10;
            pointer-events: auto;
            visibility: visible;
            opacity: 1;
        }

        .kanban-scrollbar-wrapper.hidden {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
        }

        .kanban-scrollbar-track {
            width: 100%;
            height: 10px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            position: relative;
            cursor: pointer;
            transition: background 0.2s ease;
            min-height: 10px;
        }

        .kanban-scrollbar-track:hover {
            background: rgba(0, 0, 0, 0.12);
        }

        .kanban-scrollbar-thumb {
            position: absolute;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            cursor: grab;
            transition: all 0.2s ease;
            min-width: 60px;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
            left: 0;
            top: 0;
            z-index: 10;
        }

        .kanban-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3f8f 100%);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
            transform: scaleY(1.2);
        }

        .kanban-scrollbar-thumb:active {
            cursor: grabbing;
            transform: scaleY(1.3);
            box-shadow: 0 6px 16px rgba(102, 126, 234, 0.6);
        }

        .kanban-scrollbar-arrows {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            justify-content: center;
            pointer-events: auto;
            position: relative;
            z-index: 20;
        }

        .kanban-scrollbar-arrow {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: all 0.2s ease;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            position: relative;
            z-index: 20;
            pointer-events: auto;
            -webkit-user-select: none;
            user-select: none;
        }

        .kanban-scrollbar-arrow:hover {
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.5);
        }

        .kanban-scrollbar-arrow:active {
            transform: scale(0.95);
        }

        .kanban-scrollbar-arrow:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }

        /* ============================================
           MENU LATERAL DE MÓDULOS (RESPONSIVO)
           ============================================ */
        .modules-sidebar {
            position: fixed;
            top: 0;
            left: 0;
            width: 280px;
            height: 100vh;
            background: linear-gradient(180deg, #1a1a2e 0%, #16213e 100%);
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.15);
            z-index: 10002;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            flex-direction: column;
            border-right: 2px solid rgba(102, 126, 234, 0.2);
            overflow: hidden;
        }

        .modules-sidebar.collapsed {
            transform: translateX(-100%);
        }

        .modules-sidebar-header {
            padding: 1.5rem;
            background: rgba(102, 126, 234, 0.15);
            border-bottom: 1px solid rgba(102, 126, 234, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
            min-height: 70px;
        }

        .modules-sidebar-header h2 {
            margin: 0;
            color: #fff;
            font-size: 1.3rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            letter-spacing: 0.5px;
        }

        .modules-sidebar-header h2 i {
            color: #667eea;
            font-size: 1.4rem;
        }

        .modules-sidebar-toggle-btn {
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid rgba(102, 126, 234, 0.3);
            color: #fff;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .modules-sidebar-toggle-btn:hover {
            background: rgba(102, 126, 234, 0.4);
            transform: rotate(180deg);
        }

        .modules-sidebar-content {
            flex: 1;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 1rem 0.75rem;
            scrollbar-width: thin;
            scrollbar-color: rgba(102, 126, 234, 0.6) transparent;
        }

        .modules-sidebar-content::-webkit-scrollbar {
            width: 6px;
        }

        .modules-sidebar-content::-webkit-scrollbar-track {
            background: transparent;
        }

        .modules-sidebar-content::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.6);
            border-radius: 3px;
        }

        .modules-sidebar-content::-webkit-scrollbar-thumb:hover {
            background: rgba(102, 126, 234, 0.8);
        }

        .module-item {
            margin-bottom: 0.5rem;
            border-radius: 12px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(102, 126, 234, 0.15);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .module-item:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.4);
            transform: translateX(4px);
        }

        .module-item.active {
            background: rgba(102, 126, 234, 0.25);
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
        }

        .module-item-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.25rem;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .module-item-header::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .module-item.active .module-item-header::before {
            opacity: 1;
        }

        .module-icon {
            width: 42px;
            height: 42px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 1.2rem;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .module-item.active .module-icon {
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
            transform: scale(1.05);
        }

        .module-info {
            flex: 1;
            min-width: 0;
        }

        .module-name {
            color: #fff;
            font-weight: 600;
            font-size: 1rem;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .module-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            background: rgba(102, 126, 234, 0.2);
            color: rgba(255, 255, 255, 0.8);
            padding: 0.25rem 0.65rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 500;
        }

        .module-expand-icon {
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.85rem;
            transition: transform 0.3s;
            flex-shrink: 0;
        }

        .module-item.expanded .module-expand-icon {
            transform: rotate(90deg);
        }

        .module-subpages {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: rgba(0, 0, 0, 0.2);
        }

        .module-item.expanded .module-subpages {
            max-height: 1000px;
        }

        .subpage-item {
            padding: 0.85rem 1.25rem 0.85rem 3.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border-top: 1px solid rgba(102, 126, 234, 0.1);
            position: relative;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .subpage-item::before {
            content: '';
            position: absolute;
            left: 2.5rem;
            top: 50%;
            transform: translateY(-50%);
            width: 6px;
            height: 6px;
            background: rgba(102, 126, 234, 0.5);
            border-radius: 50%;
            transition: all 0.2s;
        }

        .subpage-item:hover {
            background: rgba(102, 126, 234, 0.15);
            padding-left: 4rem;
        }

        .subpage-item:hover::before {
            background: #667eea;
            width: 8px;
            height: 8px;
        }

        .subpage-item.active {
            background: rgba(102, 126, 234, 0.25);
            border-left: 3px solid #667eea;
        }

        .subpage-item.active::before {
            background: #667eea;
            width: 10px;
            height: 10px;
        }

        .subpage-name {
            color: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            font-weight: 500;
            flex: 1;
        }

        .subpage-item.active .subpage-name {
            color: #fff;
            font-weight: 600;
        }

        .subpage-icon {
            color: rgba(102, 126, 234, 0.7);
            font-size: 0.85rem;
        }

        .subpage-item.active .subpage-icon {
            color: #667eea;
        }

        .modules-sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            backdrop-filter: blur(2px);
        }

        .modules-sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modules-sidebar-mobile-toggle {
            position: fixed;
            top: 1rem;
            left: 1rem;
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            color: #fff;
            font-size: 1.3rem;
            cursor: pointer;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4);
            z-index: 10003;
            display: none;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }

        .modules-sidebar-mobile-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 24px rgba(102, 126, 234, 0.6);
        }

        /* Botão flutuante para abrir menu (desktop) */
        .modules-sidebar-toggle-float {
            position: fixed;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            width: 56px;
            height: 56px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 0 12px 12px 0;
            color: #fff;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: 4px 0 16px rgba(102, 126, 234, 0.4);
            z-index: 10001;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 0;
            visibility: hidden;
        }

        .modules-sidebar-toggle-float.visible {
            opacity: 1;
            visibility: visible;
        }

        .modules-sidebar-toggle-float:hover {
            transform: translateY(-50%) translateX(4px);
            box-shadow: 6px 0 24px rgba(102, 126, 234, 0.6);
            background: linear-gradient(135deg, #764ba2 0%, #667eea 100%);
        }

        .modules-sidebar-toggle-float:active {
            transform: translateY(-50%) translateX(2px);
        }

        .modules-sidebar-toggle-float::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 0 12px 12px 0;
            padding: 2px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.3), rgba(255, 255, 255, 0.1));
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .modules-sidebar-toggle-float:hover::before {
            opacity: 1;
        }

        /* Ajustar conteúdo principal quando sidebar está visível */
        .main-content-wrapper {
            transition: margin-left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .main-content-wrapper.with-sidebar {
            margin-left: 280px;
        }

        /* Mostrar botão flutuante quando sidebar estiver colapsado */
        .modules-sidebar.collapsed + .modules-sidebar-overlay + .modules-sidebar-mobile-toggle + .modules-sidebar-toggle-float {
            opacity: 1;
            visibility: visible;
        }
        
        /* Alternativa: usar JavaScript para controlar, mas manter CSS como fallback */
        .modules-sidebar-toggle-float.visible {
            opacity: 1 !important;
            visibility: visible !important;
        }

        /* Responsividade */
        @media (max-width: 1024px) {
            .modules-sidebar {
                transform: translateX(-100%);
            }

            .modules-sidebar.mobile-open {
                transform: translateX(0);
            }

            .modules-sidebar-mobile-toggle {
                display: flex;
            }

            .modules-sidebar-toggle-float {
                display: none !important;
            }

            .main-content-wrapper.with-sidebar {
                margin-left: 0;
            }
        }

        @media (max-width: 768px) {
            .modules-sidebar {
                width: 260px;
            }
        }

        /* ✅ FAROL DE PRIORIDADES - Legenda de Cores */
        .prioridade-farol {
            margin: 1.25rem;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 16px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1), 0 2px 8px rgba(102, 126, 234, 0.1);
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            z-index: 1;
            border: 1.5px solid rgba(102, 126, 234, 0.12);
        }
        
        .prioridade-farol:hover {
            box-shadow: 0 8px 28px rgba(0, 0, 0, 0.15), 0 4px 12px rgba(102, 126, 234, 0.15);
            transform: translateY(-2px);
        }
        
        .farol-header {
            display: flex;
            align-items: center;
            gap: 0.85rem;
            padding: 1.15rem 1.5rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            user-select: none;
            font-weight: 700;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }
        
        .farol-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.5s ease;
        }
        
        .farol-header:hover::before {
            left: 100%;
        }
        
        .farol-header:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3f8f 100%);
            transform: translateY(-1px);
        }
        
        .farol-header i:first-child {
            font-size: 1.2rem;
        }
        
        .farol-chevron {
            margin-left: auto;
            transition: transform 0.3s ease;
        }
        
        .prioridade-farol.fechado .farol-chevron {
            transform: rotate(-90deg);
        }
        
        .farol-content {
            padding: 1.5rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.25rem;
            max-height: 500px;
            overflow-y: auto;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            background: linear-gradient(180deg, rgba(248, 249, 250, 0.5) 0%, rgba(255, 255, 255, 0.5) 100%);
        }
        
        .prioridade-farol.fechado .farol-content {
            display: none;
        }
        
        .farol-item {
            display: flex;
            align-items: center;
            gap: 1.25rem;
            padding: 1rem 1.25rem;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 12px;
            border-left: 5px solid transparent;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .farol-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at center, rgba(102, 126, 234, 0.05) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .farol-item:hover::before {
            opacity: 1;
        }
        
        .farol-item:hover {
            background: linear-gradient(135deg, #ffffff 0%, #f0f4ff 100%);
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.25), 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left-width: 6px;
        }
        
        .farol-item-especial {
            background: linear-gradient(135deg, rgba(14, 165, 233, 0.1) 0%, rgba(2, 132, 199, 0.1) 100%);
            border-left-color: #0ea5e9;
        }
        
        .farol-cor {
            width: 60px;
            height: 60px;
            border-radius: 8px;
            flex-shrink: 0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }
        
        .farol-info {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            flex: 1;
        }
        
        .farol-info strong {
            font-size: 1rem;
            color: #212529;
            font-weight: 600;
        }
        
        .farol-info span {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        .farol-note {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-radius: 8px;
            border-left: 4px solid #667eea;
            margin-top: 0.5rem;
        }
        
        .farol-note i {
            color: #667eea;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .farol-note span {
            color: #495057;
            font-size: 0.9rem;
            line-height: 1.5;
        }
        
        @media (max-width: 768px) {
            .farol-content {
                grid-template-columns: 1fr;
            }
            
            .farol-cor {
                width: 50px;
                height: 50px;
            }
        }

        /* ============================================
           KANBAN BOARD - Versão Refatorada e Melhorada
           ============================================ */
        .kanban-container {
            width: 100%;
            max-width: 100%;
            padding: 0;
            margin: 0 auto 0.75rem auto;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: visible;
            box-sizing: border-box;
        }
        
        /* Menu Lateral de Funis */
        .funis-sidebar {
            position: fixed;
            top: 0;
            left: -350px;
            width: 350px;
            height: 100vh;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            box-shadow: 4px 0 20px rgba(0, 0, 0, 0.3);
            z-index: 10000;
            transition: left 0.3s ease;
            display: flex;
            flex-direction: column;
            border-right: 2px solid rgba(102, 126, 234, 0.3);
        }
        
        .funis-sidebar.open {
            left: 0;
        }
        
        .funis-sidebar-header {
            padding: 1.5rem;
            background: rgba(102, 126, 234, 0.1);
            border-bottom: 1px solid rgba(102, 126, 234, 0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .funis-sidebar-header h3 {
            margin: 0;
            color: #fff;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .funis-sidebar-close {
            background: transparent;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .funis-sidebar-close:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: rotate(90deg);
        }
        
        .funis-sidebar-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
        }
        
        .funis-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            color: #fff;
            gap: 1rem;
        }
        
        .funis-loading i {
            font-size: 2rem;
            color: #667eea;
        }
        
        .funil-item-sidebar {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }
        
        .funil-item-sidebar::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.2), transparent);
            transition: left 0.5s;
        }
        
        .funil-item-sidebar:hover::before {
            left: 100%;
        }
        
        .funil-item-sidebar:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .funil-item-sidebar.active {
            background: rgba(102, 126, 234, 0.3);
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
        }
        
        .funil-item-sidebar-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.5rem;
        }
        
        .funil-item-sidebar-icon {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 1.2rem;
        }
        
        .funil-item-sidebar-title {
            flex: 1;
            color: #fff;
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .funil-item-sidebar-info {
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.9rem;
            margin-top: 0.5rem;
        }
        
        .funil-item-sidebar-etapas {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        
        .funil-etapa-badge {
            background: rgba(102, 126, 234, 0.2);
            color: #fff;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }
        
        .funis-sidebar-toggle {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50%;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            z-index: 9999;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .funis-sidebar-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 30px rgba(102, 126, 234, 0.6);
        }
        
        .funis-sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
        }
        
        .funis-sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .funis-empty-state {
            text-align: center;
            padding: 2rem;
            color: rgba(255, 255, 255, 0.7);
        }
        
        .funis-empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: rgba(102, 126, 234, 0.5);
        }

        /* Wrapper para o board */
        .kanban-board-wrapper {
            position: relative;
            width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            padding: 1.5rem 0;
            box-sizing: border-box;
            background: transparent;
            scrollbar-width: thin;
            scrollbar-color: rgba(102, 126, 234, 0.6) rgba(102, 126, 234, 0.1);
        }
        
        .kanban-board-wrapper::-webkit-scrollbar {
            height: 10px;
        }
        
        .kanban-board-wrapper::-webkit-scrollbar-track {
            background: rgba(102, 126, 234, 0.08);
            border-radius: 10px;
            margin: 0 1rem;
        }
        
        .kanban-board-wrapper::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }
        
        .kanban-board-wrapper::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3f8f 100%);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }
        
        /* Controles de navegação do Kanban */
        .kanban-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding: 0 1rem;
            gap: 1rem;
        }
        
        .kanban-nav-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .kanban-nav-btn {
            width: 48px;
            height: 48px;
            border-radius: 14px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.35), 0 2px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            overflow: hidden;
        }
        
        .kanban-nav-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
        }
        
        .kanban-nav-btn:hover::before {
            width: 200%;
            height: 200%;
        }
        
        .kanban-nav-btn:hover:not(:disabled) {
            transform: translateY(-3px) scale(1.05);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5), 0 4px 12px rgba(0, 0, 0, 0.15);
            background: linear-gradient(135deg, #5568d3 0%, #6a3f8f 100%);
        }
        
        .kanban-nav-btn:active:not(:disabled) {
            transform: translateY(-1px) scale(1.02);
        }
        
        .kanban-nav-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            transform: none;
        }
        
        .kanban-nav-btn:active:not(:disabled) {
            transform: translateY(0);
        }
        
        .kanban-stages-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex: 1;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .kanban-stage-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.25);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            cursor: pointer;
            border: 2px solid transparent;
        }
        
        .kanban-stage-dot.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 28px;
            border-radius: 14px;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.5), 0 1px 4px rgba(0, 0, 0, 0.2);
            border-color: rgba(255, 255, 255, 0.3);
        }
        
        .kanban-stage-dot:hover {
            background: rgba(102, 126, 234, 0.6);
            transform: scale(1.3);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
        }
        
        .kanban-stage-dot.active:hover {
            transform: scale(1.1);
        }
        
        .kanban-stages-info {
            font-size: 0.85rem;
            color: #667eea;
            font-weight: 600;
            white-space: nowrap;
        }

        .kanban-board {
            display: flex;
            gap: 1.25rem;
            min-width: max-content;
            width: max-content;
            padding: 0 1rem;
            margin: 0;
            flex-wrap: nowrap;
            box-sizing: border-box;
        }

        .kanban-column {
            min-width: 320px;
            max-width: 320px;
            width: 320px;
            height: calc(100vh - 200px);
            min-height: 600px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 16px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            border: 1.5px solid rgba(102, 126, 234, 0.15);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(102, 126, 234, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.9);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
            flex-grow: 0;
            overflow: hidden;
            align-items: stretch;
            position: relative;
            backdrop-filter: blur(10px);
        }
        
        .kanban-column::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            opacity: 0;
            transition: opacity 0.4s ease;
            border-radius: 16px 16px 0 0;
        }
        
        .kanban-column:hover::before {
            opacity: 1;
        }
        
        .kanban-column::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at top right, rgba(102, 126, 234, 0.05) 0%, transparent 50%);
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
        }
        
        .kanban-column:hover::after {
            opacity: 1;
        }
        
        /* Garantir que as colunas não sejam cortadas e sempre visíveis */
        .kanban-board > .kanban-column {
            flex-shrink: 0 !important;
            flex-grow: 0 !important;
        }
        
        /* Responsividade para telas menores */
        @media (max-width: 768px) {
            .kanban-column {
                min-width: 240px;
                max-width: 240px;
                width: 240px;
                height: calc(100vh - 350px);
                max-height: calc(100vh - 350px);
            }
        }

        .kanban-column:hover {
            border-color: rgba(102, 126, 234, 0.35);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.15), 0 8px 20px rgba(102, 126, 234, 0.2), inset 0 1px 0 rgba(255, 255, 255, 1);
            transform: translateY(-6px) scale(1.02);
            background: linear-gradient(135deg, #ffffff 0%, #f5f7fa 100%);
        }

        .kanban-column-header {
            display: flex;
            flex-direction: column;
            gap: 0.85rem;
            padding: 1.15rem;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 14px;
            margin-bottom: 0.85rem;
            border: 1.5px solid rgba(102, 126, 234, 0.18);
            flex-shrink: 0;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.06), inset 0 1px 0 rgba(255, 255, 255, 0.9);
            position: sticky;
            top: 0;
            z-index: 5;
            backdrop-filter: blur(10px);
        }

        .kanban-column-title {
            font-weight: 700;
            color: #667eea;
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 0.6rem;
            letter-spacing: 0.2px;
            text-transform: uppercase;
            font-size: 0.9rem;
        }
        
        .kanban-column-title i {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .kanban-column-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 0.85rem;
            width: 100%;
            padding-top: 0.75rem;
            border-top: 1.5px solid rgba(102, 126, 234, 0.12);
        }

        .kanban-column-count {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #495057;
            font-size: 0.85rem;
            font-weight: 700;
            padding: 0.4rem 0.75rem;
            background: rgba(102, 126, 234, 0.08);
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .kanban-column-count:hover {
            background: rgba(102, 126, 234, 0.12);
            transform: scale(1.05);
        }

        .kanban-column-count::before {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: inline-block;
            box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);
        }

        .kanban-column-value {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #28a745;
            font-size: 0.9rem;
            font-weight: 700;
            white-space: nowrap;
            padding: 0.4rem 0.75rem;
            background: rgba(40, 167, 69, 0.1);
            border-radius: 8px;
            transition: all 0.2s ease;
        }
        
        .kanban-column-value:hover {
            background: rgba(40, 167, 69, 0.15);
            transform: scale(1.05);
        }

        .kanban-column-value::before {
            content: '';
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            display: inline-block;
            box-shadow: 0 2px 4px rgba(40, 167, 69, 0.3);
        }

        /* Botão de ordenação do Kanban */
        .kanban-sort-btn {
            position: relative;
            background: transparent;
            border: 1px solid rgba(102, 126, 234, 0.2);
            border-radius: 6px;
            padding: 0.4rem 0.6rem;
            color: #667eea;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.75rem;
            font-weight: 600;
            transition: all 0.2s ease;
        }

        .kanban-sort-btn:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .kanban-sort-btn.active {
            background: rgba(102, 126, 234, 0.15);
            border-color: #667eea;
            color: #667eea;
        }

        .kanban-sort-menu {
            position: absolute;
            top: calc(100% + 0.5rem);
            right: 0;
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            min-width: 180px;
            z-index: 1000;
            display: none;
            overflow: hidden;
        }

        .kanban-sort-menu.show {
            display: block;
        }

        .kanban-sort-menu-item {
            padding: 0.65rem 1rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: #495057;
            transition: background 0.15s ease;
            border: none;
            background: none;
            width: 100%;
            text-align: left;
        }

        .kanban-sort-menu-item:hover {
            background: rgba(102, 126, 234, 0.1);
        }

        .kanban-sort-menu-item.active {
            background: rgba(102, 126, 234, 0.15);
            color: #667eea;
            font-weight: 600;
        }

        .kanban-sort-menu-item i {
            width: 16px;
            text-align: center;
            font-size: 0.75rem;
        }

        .kanban-column-cards {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            flex: 1 1 auto;
            min-height: 0;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0.5rem 0.5rem 0.5rem 0;
            margin-right: -0.5rem;
            scrollbar-width: thin;
            scrollbar-color: rgba(102, 126, 234, 0.6) rgba(102, 126, 234, 0.1);
            /* Melhorar scroll quando há muitas coletas */
            scroll-behavior: smooth;
            overscroll-behavior: contain;
            /* Garantir que os cards não sejam comprimidos */
            align-items: stretch;
        }

        .kanban-column-cards::-webkit-scrollbar {
            width: 10px;
        }

        .kanban-column-cards::-webkit-scrollbar-track {
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            margin: 4px 0;
        }

        .kanban-column-cards::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: all 0.2s ease;
        }

        .kanban-column-cards::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3f8f 100%);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .kanban-card {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 14px;
            padding: 1.15rem;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.08), 0 2px 6px rgba(0, 0, 0, 0.06), inset 0 1px 0 rgba(255, 255, 255, 0.95);
            cursor: pointer;
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1.5px solid rgba(102, 126, 234, 0.12);
            border-left: 5px solid #667eea;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            flex-grow: 0;
            width: 100%;
            box-sizing: border-box;
            color: #212529;
            backdrop-filter: blur(10px);
        }
        
        .kanban-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at top left, rgba(102, 126, 234, 0.05) 0%, transparent 60%);
            opacity: 0;
            transition: opacity 0.35s ease;
            pointer-events: none;
        }
        
        .kanban-card:hover::before {
            opacity: 1;
        }
        
        .kanban-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
            transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 14px 0 0 14px;
        }
        
        .kanban-card:hover::after {
            width: 7px;
            box-shadow: 0 0 12px rgba(102, 126, 234, 0.4);
        }

        .kanban-card:hover:not(.expanded) {
            box-shadow: 0 8px 28px rgba(102, 126, 234, 0.28), 0 4px 12px rgba(0, 0, 0, 0.15), inset 0 1px 0 rgba(255, 255, 255, 1);
            transform: translateY(-6px) scale(1.02);
            border-color: rgba(102, 126, 234, 0.35);
            background: linear-gradient(135deg, #ffffff 0%, #f5f7fa 100%);
        }


        /* ========== ASSISTENTE INTELIGENTE DE MOVIMENTAÇÃO ========== */
        .assistente-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10050;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
            padding: 1rem;
            animation: fadeIn 0.3s ease;
        }

        .assistente-modal.active {
            display: flex;
        }

        .assistente-content {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .assistente-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 20px 20px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .assistente-header h3 {
            margin: 0;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .assistente-body {
            padding: 2rem;
        }

        .pergunta-contexto {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            border-left: 4px solid #667eea;
            padding: 1.25rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
        }

        .pergunta-contexto h4 {
            margin: 0 0 0.5rem 0;
            color: #667eea;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .pergunta-contexto p {
            margin: 0;
            color: #666;
            font-size: 0.95rem;
        }

        .acoes-sugeridas {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .acao-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 1.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .acao-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }

        .acao-card.recomendada {
            border-color: #28a745;
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.05) 0%, rgba(40, 167, 69, 0.1) 100%);
        }

        .acao-card.recomendada::before {
            content: '⭐ Recomendado';
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            background: #28a745;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .acao-card.bloqueada {
            opacity: 0.6;
            cursor: not-allowed;
            border-color: #dc3545;
        }

        .acao-card.bloqueada:hover {
            transform: none;
            box-shadow: none;
        }

        .acao-icone {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
            margin-bottom: 0.75rem;
        }

        .acao-card.recomendada .acao-icone {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        }

        .acao-card.bloqueada .acao-icone {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
        }

        .acao-titulo {
            font-weight: 600;
            font-size: 1rem;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .acao-descricao {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.4;
        }

        .acao-bloqueio {
            font-size: 0.75rem;
            color: #dc3545;
            margin-top: 0.5rem;
            font-style: italic;
        }

        .acoes-todas {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 2px solid #e9ecef;
        }

        .acoes-todas h5 {
            color: #667eea;
            font-size: 1rem;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .info-coleta {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            font-size: 0.9rem;
        }

        .info-coleta-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .info-coleta-label {
            color: #999;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .info-coleta-valor {
            color: #333;
            font-weight: 600;
        }

        @media (max-width: 768px) {
            .assistente-content {
                max-width: 100%;
                border-radius: 0;
                max-height: 100vh;
            }

            .assistente-header {
                border-radius: 0;
            }

            .acoes-sugeridas {
                grid-template-columns: 1fr;
            }
        }

        /* ========== ESTILOS RESPONSIVOS PARA ETAPAS POR FUNIL ========== */
        .funil-etapas-card {
            transition: all 0.3s ease;
        }

        .funil-etapas-card:hover {
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2) !important;
            transform: translateY(-2px);
        }

        .funil-etapas-header {
            flex-wrap: wrap;
        }

        .funil-etapas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.5rem;
        }

        .funil-progress-bar {
            display: flex;
            gap: 0.15rem;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .funil-progress-bar::-webkit-scrollbar {
            height: 4px;
        }

        .funil-progress-bar::-webkit-scrollbar-track {
            background: transparent;
        }

        .funil-progress-bar::-webkit-scrollbar-thumb {
            background: rgba(102, 126, 234, 0.3);
            border-radius: 2px;
        }

        /* Responsivo para tablets */
        @media (max-width: 1024px) {
            .funil-etapas-grid {
                grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
                gap: 0.5rem;
            }

            .funil-etapas-card {
                padding: 1rem !important;
            }

            .funil-etapas-header {
                flex-direction: column;
                align-items: flex-start !important;
            }

            .funil-etapas-header > div:last-child {
                text-align: left !important;
                margin-top: 0.5rem;
            }
        }

        /* Responsivo para mobile */
        @media (max-width: 768px) {
            .funil-etapas-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .funil-etapas-card {
                padding: 0.875rem !important;
                margin-bottom: 1rem !important;
            }

            .funil-etapas-header {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 0.5rem !important;
            }

            .funil-etapas-header > div:first-child {
                width: 100%;
                min-width: 100% !important;
            }

            .funil-etapas-header > div:last-child {
                text-align: left !important;
                width: 100%;
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-top: 0;
            }

            .funil-progress-bar {
                gap: 0.1rem;
                padding: 0.2rem !important;
            }

            .funil-progress-bar > div {
                min-width: 3px !important;
                height: 5px !important;
            }

            /* Ajustar drawer-etapa-item para mobile */
            .drawer-etapa-item {
                width: 100%;
                padding: 0.75rem 1rem !important;
                font-size: 0.9rem !important;
            }

            .coleta-info-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }

            .etapas-processo-container {
                padding: 1rem !important;
            }

            .etapas-processo-header {
                flex-direction: column;
                align-items: flex-start !important;
            }
        }

        /* Responsivo para mobile pequeno */
        @media (max-width: 480px) {
            .funil-etapas-card {
                padding: 0.75rem !important;
            }

            .funil-etapas-header > div:first-child > div:first-child {
                width: 35px !important;
                height: 35px !important;
                font-size: 1rem !important;
            }

            .funil-etapas-header > div:first-child > div:last-child strong {
                font-size: 0.9rem !important;
            }

            .funil-etapas-grid {
                gap: 0.4rem;
            }

            .coleta-info-grid {
                grid-template-columns: 1fr !important;
                gap: 1rem !important;
            }

            .etapas-processo-container {
                padding: 1rem !important;
            }

            .etapas-processo-header {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 0.5rem !important;
            }

            .etapas-processo-header strong {
                font-size: 1rem !important;
            }
        }

        /* ========== MODAL DE MOVIMENTAÇÃO DE COLETAS ========== */
        .modal-mover-coleta {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal-mover-coleta.active {
            display: flex;
        }

        .modal-mover-coleta-content {
            background: white;
            border-radius: 16px;
            padding: 2rem;
            max-width: 500px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .modal-mover-coleta-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-mover-coleta-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .modal-mover-coleta-title i {
            color: #667eea;
        }

        .modal-mover-coleta-close {
            background: transparent;
            border: none;
            font-size: 1.5rem;
            color: #6c757d;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.3s;
        }

        .modal-mover-coleta-close:hover {
            background: #f8f9fa;
            color: #dc3545;
        }

        .modal-mover-coleta-body {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .modal-mover-coleta-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .modal-mover-coleta-label {
            font-weight: 600;
            color: #495057;
            font-size: 0.9rem;
        }

        .modal-mover-coleta-select {
            padding: 0.75rem;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s;
            background: white;
        }

        .modal-mover-coleta-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .modal-mover-coleta-preview {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .modal-mover-coleta-preview-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 0.5rem;
        }

        .modal-mover-coleta-preview-info {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .modal-mover-coleta-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .modal-mover-coleta-btn {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
        }

        .modal-mover-coleta-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .modal-mover-coleta-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .modal-mover-coleta-btn-secondary {
            background: #e9ecef;
            color: #495057;
        }

        .modal-mover-coleta-btn-secondary:hover {
            background: #dee2e6;
        }

        .modal-mover-coleta-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* ========== DRAWER DO KANBAN (WORKSPACE) ========== */
        .kanban-drawer {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 10000;
            display: none;
            pointer-events: none;
        }

        .kanban-drawer.active {
            display: flex;
            pointer-events: auto;
        }

        .kanban-drawer-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(3px);
            transition: opacity 0.3s ease;
        }

        .kanban-drawer-content {
            position: absolute;
            top: 0;
            right: 0;
            bottom: 0;
            width: 90vw;
            max-width: 1000px;
            background: linear-gradient(180deg, #ffffff 0%, #f8f9fa 100%);
            box-shadow: -8px 0 40px rgba(0, 0, 0, 0.25), -4px 0 20px rgba(102, 126, 234, 0.15);
            transform: translateX(100%);
            transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(20px);
        }

        .kanban-drawer.active .kanban-drawer-content {
            transform: translateX(0);
        }

        .kanban-drawer-header {
            padding: 1.75rem 2rem;
            border-bottom: 2px solid rgba(102, 126, 234, 0.15);
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);
            position: sticky;
            top: 0;
            z-index: 10;
            backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .kanban-drawer-title {
            font-size: 1.65rem;
            font-weight: 700;
            color: #667eea;
            display: flex;
            align-items: center;
            gap: 0.85rem;
            letter-spacing: -0.3px;
        }
        
        .kanban-drawer-title i {
            font-size: 1.5rem;
            opacity: 0.9;
        }

        .kanban-drawer-close {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
            position: relative;
            overflow: hidden;
        }
        
        .kanban-drawer-close::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.4s ease, height 0.4s ease;
        }
        
        .kanban-drawer-close:hover::before {
            width: 200%;
            height: 200%;
        }

        .kanban-drawer-close:hover {
            background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.5);
        }

        .kanban-drawer-body {
            padding: 1.5rem;
            flex: 1;
            overflow-y: auto;
        }

        .kanban-drawer-tabs {
            display: flex;
            gap: 0.5rem;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 1.5rem;
            overflow-x: auto;
        }

        .kanban-drawer-tab {
            padding: 0.85rem 1.75rem;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            position: relative;
            font-size: 0.95rem;
        }
        
        .kanban-drawer-tab::before {
            content: '';
            position: absolute;
            bottom: -3px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 2px;
        }

        .kanban-drawer-tab:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.05);
        }
        
        .kanban-drawer-tab:hover::before {
            width: 60%;
        }

        .kanban-drawer-tab.active {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .kanban-drawer-tab.active::before {
            width: 100%;
        }

        .kanban-drawer-tab-content {
            display: none;
        }

        .kanban-drawer-tab-content.active {
            display: block;
        }

        /* Estilos para etapas clicáveis no drawer */
        .drawer-etapa-clickable {
            position: relative;
        }

        .drawer-etapa-clickable:hover {
            background: rgba(102, 126, 234, 0.1) !important;
            transform: translateY(-2px);
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.2);
        }

        .drawer-etapa-clickable:active {
            transform: translateY(0);
        }

        .kanban-board {
            position: relative;
            z-index: 1;
        }

        .kanban-column {
            position: relative;
            z-index: 1;
        }
        
        /* Garantir que o scrollbar não seja bloqueado */
        .kanban-board-wrapper * {
            pointer-events: auto;
        }
        
        .kanban-board-wrapper .kanban-board {
            pointer-events: auto !important;
        }

        .kanban-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
            transform: rotate(2deg);
        }

        .kanban-card.no-drag {
            opacity: 0.6;
            cursor: not-allowed;
            border-left-color: #dc3545;
        }

        .kanban-card.no-drag::after {
            content: '🔒';
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            font-size: 0.9rem;
        }

        .kanban-card-title {
            font-weight: 700;
            color: #212529;
            margin-bottom: 0.6rem;
            font-size: 1rem;
            line-height: 1.4;
            letter-spacing: -0.2px;
        }

        .kanban-card-info {
            font-size: 0.85rem;
            color: #495057;
            margin-bottom: 0.35rem;
            line-height: 1.5;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }
        
        .kanban-card-info i {
            font-size: 0.75rem;
            opacity: 0.7;
            width: 14px;
            text-align: center;
        }
        
        /* ✅ CORREÇÃO: Garantir que elementos dentro do card herdem a cor do texto */
        .kanban-card[style*="color: white"] .kanban-card-title,
        .kanban-card[style*="color: white"] .kanban-card-info {
            color: white !important;
        }
        
        .kanban-card[style*="color: #333"] .kanban-card-title,
        .kanban-card[style*="color: #333"] .kanban-card-info,
        .kanban-card[style*="color: #212529"] .kanban-card-title,
        .kanban-card[style*="color: #212529"] .kanban-card-info {
            color: #212529 !important;
        }
        
        /* ✅ CORREÇÃO ESPECÍFICA: Cards brancos devem ter texto escuro sempre visível */
        .kanban-card[style*="background: #ffffff"],
        .kanban-card[style*="background: white"],
        .kanban-card[style*="background: #ffffff !important"] {
            color: #212529 !important;
        }
        
        .kanban-card[style*="background: #ffffff"] .kanban-card-title,
        .kanban-card[style*="background: #ffffff"] .kanban-card-info,
        .kanban-card[style*="background: white"] .kanban-card-title,
        .kanban-card[style*="background: white"] .kanban-card-info,
        .kanban-card[style*="background: #ffffff !important"] .kanban-card-title,
        .kanban-card[style*="background: #ffffff !important"] .kanban-card-info {
            color: #212529 !important;
        }
        
        .kanban-card[style*="background: #ffffff"] .kanban-card-body,
        .kanban-card[style*="background: white"] .kanban-card-body,
        .kanban-card[style*="background: #ffffff !important"] .kanban-card-body {
            color: #212529 !important;
        }
        
        /* ✅ CORREÇÃO: Ícones em cards brancos devem ter cor escura */
        .kanban-card[style*="background: #ffffff"] i,
        .kanban-card[style*="background: white"] i,
        .kanban-card[style*="background: #ffffff !important"] i {
            color: #495057 !important;
        }
        
        /* ✅ CORREÇÃO: Garantir que todos os elementos dentro de card branco tenham cor visível */
        .kanban-card[style*="background: #ffffff"] *,
        .kanban-card[style*="background: white"] *,
        .kanban-card[style*="background: #ffffff !important"] * {
            color: inherit;
        }
        
        .kanban-card[style*="background: #ffffff"] span:not([style*="color"]),
        .kanban-card[style*="background: white"] span:not([style*="color"]),
        .kanban-card[style*="background: #ffffff !important"] span:not([style*="color"]) {
            color: #212529 !important;
        }
        
        /* ✅ CORREÇÃO ADICIONAL: Classe específica para cards brancos */
        .kanban-card.card-branco {
            background: #ffffff !important;
            color: #212529 !important;
        }
        
        .kanban-card.card-branco .kanban-card-title,
        .kanban-card.card-branco .kanban-card-info,
        .kanban-card.card-branco .kanban-card-body,
        .kanban-card.card-branco span:not([style*="color"]),
        .kanban-card.card-branco i:not([style*="color"]) {
            color: #212529 !important;
        }
        
        .kanban-card.card-branco .kanban-card-info i {
            color: #495057 !important;
        }

        /* ✅ CORREÇÃO: Nome do cliente sempre visível em cards brancos (ex.: coleta em risco movida para etapa nova) */
        .kanban-card.card-branco .kanban-card-title > span:first-child,
        .kanban-card[style*="background: #ffffff"] .kanban-card-title > span:first-child,
        .kanban-card[style*="background: #ffffff !important"] .kanban-card-title > span:first-child {
            color: #212529 !important;
        }

        .kanban-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
            cursor: pointer;
        }

        .kanban-card-body {
            flex: 1;
            cursor: pointer;
        }

        .kanban-card-etiquetas {
            min-height: 0;
        }
        .kanban-etiqueta-badge {
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .kanban-card[style*="color: white"] .kanban-etiqueta-badge,
        .kanban-card[style*="color: #fff"] .kanban-etiqueta-badge {
            color: #fff !important;
            border-color: rgba(255,255,255,0.4) !important;
        }
        .kanban-card.card-branco .kanban-etiqueta-badge,
        .kanban-card[style*="background: #ffffff"] .kanban-etiqueta-badge {
            color: #fff !important;
        }
        .kanban-card-badges {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 0.75rem 0;
            padding: 0.5rem 0;
            border-top: 1px solid rgba(0, 0, 0, 0.05);
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            cursor: pointer;
        }

        .kanban-badge {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
            color: #667eea;
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.7rem;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            font-weight: 600;
        }

        /* Animação de piscar para badge urgente no Kanban */
        @keyframes piscarBadgeUrgente {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
                box-shadow: 0 0 10px rgba(231, 76, 60, 0.6);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.1);
                box-shadow: 0 0 20px rgba(231, 76, 60, 1);
            }
        }

        .kanban-urgente-badge {
            background: #e74c3c;
            color: white;
            padding: 0.2rem 0.4rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            animation: piscarBadgeUrgente 1.5s ease-in-out infinite;
            display: inline-block;
            cursor: pointer;
        }

        .kanban-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.25rem;
            padding-top: 0.25rem;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
        }
        
        /* ✅ CORREÇÃO: Footer em cards com fundo escuro */
        .kanban-card[style*="color: white"] .kanban-card-footer {
            border-top-color: rgba(255, 255, 255, 0.2) !important;
        }

        .kanban-card-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 0.45rem 0.9rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.75rem;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .kanban-card-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(102, 126, 234, 0.3);
            opacity: 0.9;
        }
        
        .kanban-card-btn:active {
            transform: translateY(0);
        }


        .kanban-card-status {
            padding: 0.25rem 0.5rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .kanban-card-status.pendente {
            background: #fff3cd;
            color: #856404;
        }

        .kanban-card-status.em_andamento {
            background: #d1ecf1;
            color: #0c5460;
        }

        .kanban-card-status.concluida {
            background: #d4edda;
            color: #155724;
        }

        .kanban-card-status.cancelada {
            background: #f8d7da;
            color: #721c24;
        }

        .kanban-drop-zone {
            min-height: 50px;
            border-radius: 8px;
            border: 2px dashed transparent;
            transition: all 0.2s ease;
        }

        .kanban-drop-zone.drag-over {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        @media (max-width: 768px) {
            .kanban-column {
                min-width: 280px;
                max-width: 280px;
            }
        }

        .coleta-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px) saturate(180%);
            border-radius: 20px;
            padding: 1.75rem;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            border: none;
            position: relative;
            overflow: visible;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            gap: 1.25rem;
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .coleta-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            z-index: 1;
        }
        
        .coleta-card::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle at 20% 50%, rgba(102, 126, 234, 0.06) 0%, transparent 60%),
                        radial-gradient(circle at 80% 80%, rgba(118, 75, 162, 0.06) 0%, transparent 60%);
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        
        .coleta-card:hover::after {
            opacity: 1;
        }
        
        .coleta-card.expanded {
            max-height: none;
            overflow: visible;
        }
        
        .coleta-card.expanded .card-content {
            width: 100%;
            overflow: visible;
            box-sizing: border-box;
        }
        
        .coleta-card.expanded .card-details {
            width: 100%;
            overflow: visible;
            box-sizing: border-box;
        }
        
        .coleta-card.expanded .etapas-container,
        .coleta-card.expanded .validation-actions,
        .coleta-card.expanded .etapa-validation,
        .coleta-card.expanded .anexos-section,
        .coleta-card.expanded .historico-list-card {
            width: 100%;
            box-sizing: border-box;
            max-width: 100%;
            overflow-x: auto;
            overflow-y: visible;
        }
        
        .coleta-card.expanded * {
            max-width: 100%;
            box-sizing: border-box;
        }
        
        .coleta-card.collapsed .card-details,
        .coleta-card.collapsed .etapas-container,
        .coleta-card.collapsed .validation-actions,
        .coleta-card.collapsed .etapa-validation {
            display: none;
        }
        
        .card-toggle {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 10;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4),
                        0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .card-toggle:hover {
            transform: scale(1.15) rotate(90deg);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.6),
                        0 0 0 5px rgba(102, 126, 234, 0.2);
        }
        
        .card-toggle:active {
            transform: scale(0.95) rotate(180deg);
        }
        
        .card-toggle i {
            transition: transform 0.3s;
        }
        
        .coleta-card.expanded .card-toggle i {
            transform: rotate(180deg);
        }


        .coleta-card.pendente::before { background: var(--vermelho); }
        .coleta-card.em_andamento::before { background: var(--laranja); }
        .coleta-card.concluida::before { background: var(--verde); }
        .coleta-card.cancelada::before { background: #6c757d; }

        /* Animação de piscar para coletas urgentes */
        @keyframes piscarUrgente {
            0%, 100% {
                opacity: 1;
                box-shadow: 0 4px 20px rgba(231, 76, 60, 0.2);
            }
            50% {
                opacity: 0.7;
                box-shadow: 0 4px 30px rgba(231, 76, 60, 0.4);
            }
        }

        /* Design moderno para coletas urgentes com animação de piscar */
        .coleta-card.urgente {
            position: relative;
            background: linear-gradient(to right, rgba(231, 76, 60, 0.08) 0%, rgba(255, 255, 255, 0.98) 100%) !important;
            animation: piscarUrgente 2s ease-in-out infinite;
        }

        /* Barra superior vermelha sólida */
        .coleta-card.urgente::before {
            background: #e74c3c !important;
            height: 4px !important;
        }

        /* Remover ponto indicador no canto - desabilitado */
        .coleta-card.urgente::after {
            display: none;
        }

        /* Hover elegante mantendo consistência */
        .coleta-card.urgente:hover {
            transform: translateY(-4px);
            animation: piscarUrgente 1.5s ease-in-out infinite;
        }

        .coleta-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.12);
            background: rgba(255, 255, 255, 1);
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        .coleta-card .status-badge.pendente,
        .coleta-card .status-badge.em_andamento {
            animation: pulse 3s infinite;
        }

        /* Header do Card Modernizado */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 1rem;
        }

        .card-title-section {
            flex: 1;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--cinza-escuro);
            margin-bottom: 0.5rem;
            line-height: 1.4;
            letter-spacing: -0.3px;
        }

        .card-id {
            font-size: 0.75rem;
            color: #6c757d;
            background: rgba(0, 0, 0, 0.04);
            padding: 0.35rem 0.75rem;
            border-radius: 12px;
            font-weight: 500;
            display: inline-block;
            border: 1px solid rgba(0, 0, 0, 0.06);
        }

        .status-section {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 0.5rem;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }
        
        .status-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s;
        }
        
        .status-badge:hover::before {
            left: 100%;
        }

        .status-pendente {
            background: linear-gradient(135deg, rgba(198, 12, 48, 0.15) 0%, rgba(198, 12, 48, 0.05) 100%);
            color: var(--vermelho); 
            border: 2px solid rgba(198, 12, 48, 0.3);
            box-shadow: 0 2px 10px rgba(198, 12, 48, 0.15);
        }
        
        .status-em_andamento { 
            background: linear-gradient(135deg, rgba(253, 126, 20, 0.15) 0%, rgba(253, 126, 20, 0.05) 100%);
            color: var(--laranja); 
            border: 2px solid rgba(253, 126, 20, 0.3);
            box-shadow: 0 2px 10px rgba(253, 126, 20, 0.15);
        }

        .status-concluida {
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.15) 0%, rgba(40, 167, 69, 0.05) 100%);
            color: var(--verde); 
            border: 2px solid rgba(40, 167, 69, 0.3);
            box-shadow: 0 2px 10px rgba(40, 167, 69, 0.15);
        }
        
        .status-cancelada { 
            background: linear-gradient(135deg, rgba(108, 117, 125, 0.15) 0%, rgba(108, 117, 125, 0.05) 100%);
            color: #6c757d; 
            border: 2px solid rgba(108, 117, 125, 0.3);
            box-shadow: 0 2px 10px rgba(108, 117, 125, 0.15);
        }

        .valor-badge {
            background: linear-gradient(135deg, #002776 0%, #003a9f 100%);
            color: var(--branco);
            padding: 0.5rem 1rem;
            border-radius: 12px;
            font-size: 0.875rem;
            font-weight: 600;
            box-shadow: 0 4px 12px rgba(0, 39, 118, 0.25),
                        inset 0 1px 0 rgba(255, 255, 255, 0.2);
            border: none;
            position: relative;
            overflow: hidden;
        }
        
        .valor-badge::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }
        
        .valor-badge:hover::before {
            left: 100%;
        }

        /* Conteúdo do Card Modernizado */
        .card-content {
            display: flex;
            flex-direction: column;
            gap: 1.2rem;
            width: 100%;
            box-sizing: border-box;
        }
        
        .card-details {
            padding-top: 0.5rem;
            width: 100%;
            box-sizing: border-box;
            overflow: visible;
        }

        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.2rem;
            width: 100%;
            box-sizing: border-box;
        }
        
        @media (max-width: 768px) {
            .info-grid {
                grid-template-columns: 1fr;
            gap: 1rem;
            }
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.4rem;
            width: 100%;
            box-sizing: border-box;
            min-width: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .info-label {
            font-size: 0.7rem;
            color: #6c757d;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 0.25rem;
            width: 100%;
            box-sizing: border-box;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .info-value {
            font-size: 0.95rem;
            color: var(--cinza-escuro);
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            line-height: 1.5;
            width: 100%;
            box-sizing: border-box;
            min-width: 0;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .info-value > * {
            flex-shrink: 1;
            min-width: 0;
        }
        
        /* Estilo específico para badges de tipos de veículo e carroceria */
        .info-value span[style*="display: inline-block"] {
            display: inline-block !important;
            word-wrap: break-word;
            max-width: 100%;
            box-sizing: border-box;
        }
        
        /* Garantir que os badges quebrem linha corretamente */
        .info-value {
            flex-wrap: wrap;
        }
        
        /* Container para badges de tipos - garante que fiquem dentro do card */
        .info-value > span[style*="display: flex"] {
            max-width: 100%;
            overflow: hidden;
        }

        .info-value i {
            color: #667eea;
            width: 16px;
            opacity: 0.9;
        }

        /* Seção de Anexos nos Cards */
        .anexos-section {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1rem;
            margin-top: 0.5rem;
            border: 1px solid #e9ecef;
        }

        .anexos-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .anexos-title {
            font-size: 0.85rem;
            color: var(--azul-escuro);
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-anexar {
            background: var(--gradient-success);
            border: none;
            color: var(--branco);
            padding: 0.4rem 0.8rem;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .btn-anexar:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .anexos-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            max-height: 150px;
            overflow-y: auto;
        }

        .anexo-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.6rem 0.8rem;
            background: var(--branco);
            border-radius: 8px;
            border-left: 3px solid var(--azul-escuro);
            transition: var(--transition);
        }

        .anexo-item:hover {
            background: #f8f9fa;
            transform: translateX(2px);
        }

        .anexo-info {
            display: flex;
            align-items: center;
            gap: 0.6rem;
            flex: 1;
        }

        .anexo-icon {
            font-size: 1rem;
            width: 20px;
            text-align: center;
        }

        .anexo-details {
            flex: 1;
            min-width: 0;
        }

        .anexo-nome {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--cinza-escuro);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .anexo-tamanho {
            font-size: 0.7rem;
            color: #6c757d;
        }

        /* ========== LOADING SKELETONS ========== */
        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .skeleton-card {
            background: white;
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
        }

        .skeleton-line {
            height: 16px;
            margin-bottom: 12px;
            border-radius: 4px;
        }

        .skeleton-line:last-child {
            margin-bottom: 0;
        }

        .skeleton-title {
            height: 24px;
            width: 60%;
            margin-bottom: 16px;
        }

        .skeleton-subtitle {
            height: 18px;
            width: 40%;
            margin-bottom: 12px;
        }

        .skeleton-text {
            height: 14px;
            width: 80%;
        }

        .anexo-actions {
            display: flex;
            gap: 0.3rem;
        }

        .btn-anexo-action {
            background: transparent;
            border: none;
            padding: 0.4rem;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
        }

        .btn-anexo-view {
            color: var(--azul-escuro);
            border: 1px solid var(--azul-escuro);
        }

        .btn-anexo-view:hover {
            background: var(--azul-escuro);
            color: white;
        }

        .btn-anexo-download {
            color: var(--verde);
            border: 1px solid var(--verde);
        }

        .btn-anexo-download:hover {
            background: var(--verde);
            color: white;
        }

        .btn-anexo-delete {
            color: var(--vermelho);
            border: 1px solid var(--vermelho);
        }

        .btn-anexo-delete:hover {
            background: var(--vermelho);
            color: white;
        }

        /* Barra de Progresso das Etapas Modernizada */
        .etapas-container {
            margin: 1rem 0;
        }

        .etapas-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.8rem;
        }

        .etapas-title {
            font-size: 0.9rem;
            color: #6c757d;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .progress-text {
            font-size: 0.8rem;
            color: var(--azul-escuro);
            font-weight: 600;
        }

        .etapas-progress {
            display: flex;
            height: 8px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 1rem;
        }

        .etapa-progress {
            height: 100%;
            transition: var(--transition);
        }

        .etapa-cs { background: var(--azul-claro); }
        .etapa-contratacao { background: var(--azul-escuro); }
        .etapa-gr { background: var(--verde); }
        .etapa-documentacao { background: var(--vermelho); }
        .etapa-controladoria { background: var(--roxo); }
        .etapa-ti { background: #0ea5e9; }
        .etapa-contas_pagar { background: #480ca8; }
        .etapa-contas_receber { background: #3f37c9; }
        .etapa-monitoramento { background: #0891b2; }
        .etapa-servicos_adicionais { background: #7c3aed; }
        .etapa-finalizar_operacao { background: #059669; }
        .etapa-price { background: var(--laranja); }
        .etapa-comercial { background: var(--ciano); }

        .etapas-labels {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .etapa-badge {
            padding: 0.4rem 0.8rem;
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 600;
            background: var(--cinza-claro);
            color: #6c757d;
            border: 1px solid #ddd;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 0.3rem;
        }

        .etapa-badge.ativa {
            background: var(--azul-escuro);
            color: var(--branco);
            border-color: var(--azul-escuro);
        }

        .etapa-badge.concluida {
            background: var(--verde);
            color: var(--branco);
            border-color: var(--verde);
        }

        /* Footer do Card Modernizado */
        .card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 1rem;
            border-top: 1px solid #e9ecef;
            margin-top: auto;
        }

        .card-actions {
            display: flex;
            gap: 0.7rem;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 0.7rem 1.2rem;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            align-items: center;
            gap: 0.6rem;
            font-weight: 700;
            white-space: nowrap;
            position: relative;
            overflow: hidden;
        }
        
        .action-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.6s, height 0.6s;
        }
        
        .action-btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .action-btn.primary {
            background: linear-gradient(135deg, #002776 0%, #003a9f 100%);
            color: var(--branco);
            box-shadow: 0 4px 15px rgba(0, 39, 118, 0.3);
        }
        .action-btn.secondary {
            background: linear-gradient(135deg, #00b4d8 0%, #0096c7 100%);
            color: var(--branco);
            box-shadow: 0 4px 15px rgba(0, 150, 199, 0.3);
        }
        
        .action-btn.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: var(--branco);
            box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
        }

        .action-btn.warning {
            background: linear-gradient(135deg, #c60c30 0%, #e63946 100%);
            color: var(--branco);
            box-shadow: 0 4px 15px rgba(198, 12, 48, 0.3);
        }

        .action-btn.chat {
            background: linear-gradient(135deg, #6f42c1 0%, #8B5FBF 100%);
            color: var(--branco);
            box-shadow: 0 4px 15px rgba(111, 66, 193, 0.3);
        }

        .action-btn.danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: var(--branco);
            box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
        }

        @keyframes pulse-success {
            0%, 100% {
                box-shadow: 0 4px 20px rgba(40, 167, 69, 0.5);
            }
            50% {
                box-shadow: 0 4px 30px rgba(40, 167, 69, 0.8), 0 0 20px rgba(40, 167, 69, 0.4);
            }
        }

        .action-btn:hover {
            transform: translateY(-4px) scale(1.05);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }
        
        .action-btn:active {
            transform: translateY(-2px) scale(1);
        }

        .card-date {
            font-size: 0.8rem;
            color: #6c757d;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Histórico NO CARD (NOVOS ESTILOS) */
        .historico-card {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
            border: 1px solid #e9ecef;
        }

        .historico-list-card {
            display: flex;
            flex-direction: column;
            gap: 0.7rem;
            max-height: 120px;
            overflow-y: auto;
        }

        .historico-item-card {
            padding: 0.6rem;
            background: white;
            border-radius: 8px;
            border-left: 3px solid var(--azul-escuro);
            font-size: 0.75rem;
        }

        .historico-item-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.2rem;
        }

        .historico-usuario-card {
            font-weight: 600;
            color: var(--azul-escuro);
            font-size: 0.7rem;
        }

        .historico-data-card {
            color: #6c757d;
            font-size: 0.65rem;
        }

        .historico-acao-card {
            color: var(--cinza-escuro);
            line-height: 1.3;
            font-size: 0.7rem;
        }

        .historico-acao-card small {
            color: #6c757d;
            font-style: italic;
        }

        .historico-mais-itens {
            text-align: center;
            color: var(--azul-escuro);
            font-size: 0.7rem;
            font-weight: 600;
            padding: 0.4rem;
            background: rgba(0, 39, 118, 0.1);
            border-radius: 6px;
            cursor: pointer;
        }

        .historico-mais-itens:hover {
            background: rgba(0, 39, 118, 0.2);
        }

        .historico-title {
            font-size: 0.9rem;
            color: var(--azul-escuro);
            font-weight: 600;
            margin-bottom: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Modal de Detalhes */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            padding: 2rem;
        }

        .modal-overlay.active {
            display: flex;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--branco);
            border-radius: var(--border-radius);
            padding: 2rem;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--hover-shadow);
            border: 1px solid rgba(0, 0, 0, 0.05);
            position: relative;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #e9ecef;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--azul-escuro);
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .close-modal {
            background: var(--vermelho);
            color: var(--branco);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .close-modal:hover {
            transform: rotate(90deg) scale(1.1);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .form-group label {
            font-weight: 600;
            color: var(--azul-escuro);
            font-size: 0.9rem;
        }
        
        .form-group label .required-asterisk {
            color: #dc3545;
            font-weight: 700;
            margin-left: 3px;
            font-size: 1rem;
        }
        
        .form-group label.required {
            position: relative;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 0.8rem 1rem;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 0.9rem;
            background: var(--branco);
            color: var(--cinza-escuro);
            transition: var(--transition);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--azul-escuro);
            box-shadow: 0 0 0 3px rgba(0, 39, 118, 0.1);
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .modal-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
        }

        /* Submenus no Card */
        .card-submenu {
            background: #f8f9fa;
            border-radius: 8px;
            margin-top: 1rem;
            overflow: hidden;
            border: 1px solid #e9ecef;
        }

        .submenu-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem 1rem;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .submenu-header:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        .submenu-title {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .submenu-toggle {
            transition: transform 0.3s ease;
        }

        .submenu-toggle.expanded {
            transform: rotate(180deg);
        }

        .submenu-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
        }

        .submenu-content.expanded {
            max-height: 500px;
        }

        .submenu-body {
            padding: 1rem;
        }

        /* Estilos específicos para anexos */
        .anexos-submenu .submenu-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .anexos-submenu .submenu-header:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
        }

        /* Estilos específicos para histórico */
        .historico-submenu .submenu-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .historico-submenu .submenu-header:hover {
            background: linear-gradient(135deg, #ee82f0 0%, #f3455a 100%);
        }

        /* Validação de etapas */
        .etapa-validation {
            background: linear-gradient(135deg, rgba(253, 126, 20, 0.1) 0%, rgba(255, 206, 84, 0.1) 100%);
            border: 2px solid #fd7e14;
            border-radius: 16px;
            padding: 1.5rem;
            margin: 1rem 0;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(253, 126, 20, 0.2);
            animation: slideInUp 0.3s ease;
        }

        @keyframes slideInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .validation-title {
            color: #856404;
            font-weight: 600;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .validation-message {
            color: #856404;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .validation-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            justify-content: center;
        }

        .btn-validation {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            position: relative;
            overflow: hidden;
            flex: 0 1 auto;
            min-width: 140px;
        }

        .btn-validation::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width 0.4s, height 0.4s;
        }

        .btn-validation:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-validation.primary {
            background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
            color: white;
        }

        .btn-validation.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 123, 255, 0.4);
        }

        .btn-validation.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-validation.success:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(40, 167, 69, 0.4);
        }

        .btn-validation.danger {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
        }

        .btn-validation.danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(220, 53, 69, 0.4);
        }

        /* Modal de Anexos */
        .modal-anexos {
            max-width: 600px;
        }

        /* Estilos para Modal de Motoristas */
        .motoristas-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .motorista-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem 1.5rem;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.95) 100%);
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            margin-bottom: 0.75rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
            position: relative;
            overflow: hidden;
        }

        .motorista-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .motorista-item:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            border-color: #667eea;
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2);
        }

        .motorista-item:hover::before {
            transform: scaleY(1);
        }

        .motorista-info {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .motorista-avatar {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 1.1rem;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .motorista-content {
            flex: 1;
            min-width: 0;
        }

        .motorista-nome {
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 0.5rem;
            font-size: 1.05rem;
            letter-spacing: -0.3px;
        }

        .motorista-detalhes {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            font-size: 0.875rem;
            color: #64748b;
        }

        .motorista-detalhes span {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: rgba(102, 126, 234, 0.08);
            padding: 0.35rem 0.75rem;
            border-radius: 8px;
            font-weight: 500;
        }

        .motorista-detalhes span i {
            color: #667eea;
            font-size: 0.8rem;
        }

        .motorista-status {
            margin-left: 1rem;
        }

        .motorista-status .badge {
            padding: 0.5rem 1rem;
            border-radius: 10px;
            font-weight: 600;
            font-size: 0.8rem;
            text-transform: capitalize;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }

        /* Modal Vincular Motorista - layout padronizado */
        #modalVincularMotorista {
            font-family: inherit;
        }
        #modalVincularMotorista .modal-vincular-dialog {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 24px 48px rgba(0,39,118,0.12), 0 0 0 1px rgba(0,0,0,0.04);
            max-width: 720px;
            width: 100%;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        #modalVincularMotorista .modal-vincular-header {
            background: linear-gradient(135deg, #002776 0%, #003d99 100%);
            color: #fff;
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        #modalVincularMotorista .modal-vincular-header h2 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #modalVincularMotorista .modal-vincular-close {
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(255,255,255,0.15);
            color: #fff;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: background 0.2s;
        }
        #modalVincularMotorista .modal-vincular-close:hover {
            background: rgba(255,255,255,0.25);
        }
        #modalVincularMotorista .modal-vincular-body {
            padding: 1.5rem;
            overflow-y: auto;
            background: #fafbfc;
            color: #1e293b;
        }
        #modalVincularMotorista .modal-vincular-filters {
            background: #fff;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            border: 1px solid #e5e7eb;
        }
        #modalVincularMotorista .modal-vincular-filters h3 {
            margin: 0 0 1rem 0;
            font-size: 0.9375rem;
            font-weight: 600;
            color: #334155;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #modalVincularMotorista .modal-vincular-filters h3 i {
            color: #002776;
            opacity: 0.9;
        }
        #modalVincularMotorista .motorista-filters-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }
        #modalVincularMotorista .modal-vincular-filters label {
            display: block;
            font-size: 0.8125rem;
            font-weight: 600;
            color: #475569;
            margin-bottom: 0.375rem;
        }
        #modalVincularMotorista .modal-vincular-filters input,
        #modalVincularMotorista .modal-vincular-filters select {
            width: 100%;
            padding: 0.625rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9375rem;
            color: #1e293b;
            background: #fff;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #modalVincularMotorista .modal-vincular-filters input:focus,
        #modalVincularMotorista .modal-vincular-filters select:focus {
            outline: none;
            border-color: #002776;
            box-shadow: 0 0 0 3px rgba(0,39,118,0.12);
        }
        #modalVincularMotorista .modal-vincular-filters input::placeholder {
            color: #94a3b8;
        }
        #modalVincularMotorista .modal-vincular-list-title {
            font-size: 0.9375rem;
            font-weight: 600;
            color: #334155;
            margin-bottom: 0.75rem;
        }
        #modalVincularMotorista .motoristas-list {
            max-height: 380px;
            overflow-y: auto;
            padding-right: 4px;
        }
        #modalVincularMotorista .motoristas-list::-webkit-scrollbar {
            width: 8px;
        }
        #modalVincularMotorista .motoristas-list::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        #modalVincularMotorista .motoristas-list::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }
        #modalVincularMotorista .motorista-item {
            background: #fff !important;
            border: 1px solid #e5e7eb !important;
            border-radius: 12px !important;
            margin-bottom: 0.5rem !important;
            padding: 1rem 1.25rem !important;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 2px rgba(0,0,0,0.04);
        }
        #modalVincularMotorista .motorista-item:hover {
            border-color: #002776 !important;
            box-shadow: 0 4px 12px rgba(0,39,118,0.12) !important;
            background: #fff !important;
        }
        #modalVincularMotorista .modal-vincular-footer {
            padding: 1rem 1.5rem;
            background: #fff;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            flex-shrink: 0;
        }
        #modalVincularMotorista .modal-vincular-footer .btn-cadastrar {
            padding: 0.625rem 1.25rem;
            background: #16a34a;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9375rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        #modalVincularMotorista .modal-vincular-footer .btn-cadastrar:hover {
            background: #15803d;
        }
        #modalVincularMotorista .modal-vincular-footer .btn-cancelar {
            padding: 0.625rem 1.25rem;
            background: #fff;
            color: #475569;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9375rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        #modalVincularMotorista .modal-vincular-footer .btn-cancelar:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }
        @media (max-width: 576px) {
            #modalVincularMotorista .motorista-filters-grid {
                grid-template-columns: 1fr !important;
            }
        }

        /* Modal Cadastrar Novo Motorista - mesmo padrão do Vincular Motorista */
        #modalCadastroMotorista {
            font-family: inherit;
        }
        #modalCadastroMotorista .modal-cadastro-dialog {
            background: #fff;
            border-radius: 16px;
            box-shadow: 0 24px 48px rgba(0,39,118,0.12), 0 0 0 1px rgba(0,0,0,0.04);
            max-width: 720px;
            width: 100%;
            max-height: 85vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        #modalCadastroMotorista .modal-cadastro-header {
            background: linear-gradient(135deg, #002776 0%, #003d99 100%);
            color: #fff;
            padding: 1.25rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        #modalCadastroMotorista .modal-cadastro-header h2 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #modalCadastroMotorista .modal-cadastro-close {
            width: 36px;
            height: 36px;
            border: none;
            background: rgba(255,255,255,0.15);
            color: #fff;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: background 0.2s;
        }
        #modalCadastroMotorista .modal-cadastro-close:hover {
            background: rgba(255,255,255,0.25);
        }
        #modalCadastroMotorista .modal-cadastro-body {
            padding: 1.5rem;
            overflow-y: auto;
            background: #fafbfc;
            color: #1e293b;
        }
        #modalCadastroMotorista .modal-cadastro-section {
            background: #fff;
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1.25rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.06);
            border: 1px solid #e5e7eb;
        }
        #modalCadastroMotorista .modal-cadastro-section h3 {
            margin: 0 0 1rem 0;
            font-size: 0.9375rem;
            font-weight: 600;
            color: #334155;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        #modalCadastroMotorista .modal-cadastro-section h3 i {
            color: #002776;
            opacity: 0.9;
        }
        #modalCadastroMotorista .modal-cadastro-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
        }
        #modalCadastroMotorista .modal-cadastro-grid.cols-2 {
            grid-template-columns: repeat(2, 1fr);
        }
        #modalCadastroMotorista .modal-cadastro-section label {
            display: block;
            font-size: 0.8125rem;
            font-weight: 600;
            color: #475569;
            margin-bottom: 0.375rem;
        }
        #modalCadastroMotorista .modal-cadastro-section input,
        #modalCadastroMotorista .modal-cadastro-section select {
            width: 100%;
            padding: 0.625rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9375rem;
            color: #1e293b;
            background: #fff;
            transition: border-color 0.2s, box-shadow 0.2s;
        }
        #modalCadastroMotorista .modal-cadastro-section input:focus,
        #modalCadastroMotorista .modal-cadastro-section select:focus {
            outline: none;
            border-color: #002776;
            box-shadow: 0 0 0 3px rgba(0,39,118,0.12);
        }
        #modalCadastroMotorista .modal-cadastro-section input::placeholder {
            color: #94a3b8;
        }
        #modalCadastroMotorista .modal-cadastro-section .field-hint {
            font-size: 0.75rem;
            color: #64748b;
            margin-top: 0.25rem;
        }
        #modalCadastroMotorista .modal-cadastro-footer {
            padding: 1rem 1.5rem;
            background: #fff;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            flex-shrink: 0;
        }
        #modalCadastroMotorista .modal-cadastro-footer .btn-cadastrar {
            padding: 0.625rem 1.25rem;
            background: #16a34a;
            color: #fff;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9375rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        #modalCadastroMotorista .modal-cadastro-footer .btn-cadastrar:hover {
            background: #15803d;
        }
        #modalCadastroMotorista .modal-cadastro-footer .btn-cancelar {
            padding: 0.625rem 1.25rem;
            background: #fff;
            color: #475569;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9375rem;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }
        #modalCadastroMotorista .modal-cadastro-footer .btn-cancelar:hover {
            background: #f8fafc;
            border-color: #cbd5e1;
        }
        @media (max-width: 768px) {
            #modalCadastroMotorista .modal-cadastro-grid {
                grid-template-columns: 1fr !important;
            }
            #modalCadastroMotorista .modal-cadastro-grid.cols-2,
            #modalCadastroMotorista .modal-cadastro-grid.modal-cadastro-grid-4 {
                grid-template-columns: 1fr !important;
            }
        }

        /* Estilos para formulário de motorista */
        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            font-weight: 600;
            color: var(--cinza-escuro);
            margin-bottom: 0.5rem;
            display: block;
        }

        .form-control {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
        }

        .row {
            display: flex;
            gap: 1rem;
        }

        .col-md-6 {
            flex: 1;
        }

        .upload-area {
            border: 2px dashed #dee2e6;
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 1.5rem;
        }

        .upload-area:hover {
            border-color: var(--azul-escuro);
            background: #e9ecef;
        }

        .upload-area.dragover {
            border-color: var(--verde);
            background: #d4edda;
        }

        .upload-icon {
            font-size: 3rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }

        .upload-text h5 {
            color: var(--azul-escuro);
            margin-bottom: 0.5rem;
        }

        .upload-text p {
            color: #6c757d;
            font-size: 0.9rem;
        }

        .file-types {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }

        .file-type-badge {
            padding: 0.3rem 0.6rem;
            background: var(--azul-escuro);
            color: var(--branco);
            border-radius: 15px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .selected-files {
            margin-top: 1.5rem;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.8rem;
            background: var(--branco);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border: 1px solid #e9ecef;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 0.8rem;
            flex: 1;
        }

        .file-icon {
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .file-details {
            flex: 1;
        }

        .file-name {
            font-weight: 600;
            color: var(--cinza-escuro);
            font-size: 0.9rem;
        }

        .file-size {
            font-size: 0.8rem;
            color: #6c757d;
        }

        .file-remove {
            background: var(--vermelho);
            color: var(--branco);
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .file-remove:hover {
            transform: scale(1.1);
        }

        .upload-progress {
            margin-top: 1rem;
            display: none;
        }

        .progress-bar {
            height: 8px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--gradient-success);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 0.8rem;
            color: #6c757d;
            text-align: center;
        }

        /* Modal de Chat */
        .modal-chat {
            max-width: 800px;
            height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: var(--gradient-primary);
            color: white;
            border-radius: 12px 12px 0 0;
        }

        .chat-info {
            display: flex;
            flex-direction: column;
        }

        .chat-coleta-id {
            font-size: 1.2rem;
            font-weight: 700;
        }

        .chat-cliente {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        .chat-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .chat-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #f8f9fa;
        }

        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .message {
            max-width: 80%;
            padding: 1rem;
            border-radius: 18px;
            position: relative;
            animation: messageAppear 0.3s ease;
        }

        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.sent {
            align-self: flex-end;
            background: var(--gradient-primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.received {
            align-self: flex-start;
            background: white;
            color: var(--cinza-escuro);
            border-bottom-left-radius: 4px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 0.5rem;
            font-size: 0.8rem;
        }

        .message-sender {
            font-weight: 600;
        }

        .message-time {
            opacity: 0.7;
        }

        .message-content {
            line-height: 1.4;
        }

        .chat-input-container {
            padding: 1.5rem;
            background: white;
            border-top: 1px solid #e9ecef;
            border-radius: 0 0 12px 12px;
        }

        .chat-input-wrapper {
            display: flex;
            gap: 1rem;
            align-items: end;
        }

        .chat-input {
            flex: 1;
            padding: 1rem;
            border: 2px solid #e9ecef;
            border-radius: 24px;
            resize: none;
            font-family: inherit;
            font-size: 0.9rem;
            transition: var(--transition);
            max-height: 120px;
            min-height: 50px;
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--azul-escuro);
            box-shadow: 0 0 0 3px rgba(0, 39, 118, 0.1);
        }

        .chat-send {
            background: var(--gradient-primary);
            border: none;
            color: white;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .chat-send:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 39, 118, 0.3);
        }

        .chat-send:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Botões Flutuantes */
        .floating-action-buttons {
            position: fixed;
            bottom: 2.5rem;
            right: 2.5rem;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .fab-main {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: var(--gradient-primary);
            border: none;
            color: var(--branco);
            font-size: 1.8rem;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(0, 39, 118, 0.4);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab-main:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 12px 35px rgba(0, 39, 118, 0.6);
        }

        .fab-secondary {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: var(--gradient-danger);
            border: none;
            color: var(--branco);
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(198, 12, 48, 0.4);
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .fab-secondary:hover {
            transform: scale(1.1);
            box-shadow: 0 12px 35px rgba(198, 12, 48, 0.6);
        }

        /* Footer */
        .main-footer {
            text-align: center;
            padding: 3rem 2rem;
            margin-top: 4rem;
            background: var(--azul-escuro);
            color: var(--branco);
            border-top-left-radius: 30px;
            border-top-right-radius: 30px;
            position: relative;
            overflow: hidden;
            z-index: 0; /* Garantir que fique atrás dos cards do Kanban */
        }

        .main-footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1440 320"><path fill="%23ffffff" fill-opacity="0.05" d="M0,96L48,112C96,128,192,160,288,186.7C384,213,480,235,576,213.3C672,192,768,128,864,128C960,128,1056,192,1152,197.3C1248,203,1344,149,1392,122.7L1440,96L1440,320L1392,320C1344,320,1248,320,1152,320C1056,320,960,320,864,320C768,320,672,320,576,320C480,320,384,320,288,320C192,320,96,320,48,320L0,320Z"></path></svg>');
            background-size: cover;
        }

        .footer-content {
            max-width: 600px;
            margin: 0 auto;
            position: relative;
            z-index: 1; /* Manter z-index para ficar acima do ::before */
        }

        .footer-logo {
            font-size: 2rem;
            font-weight: 800;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
        }

        /* Notificações */
        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            padding: 1.2rem 1.8rem;
            border-radius: 12px;
            color: var(--branco);
            font-weight: 600;
            z-index: 1000;
            opacity: 0;
            transform: translateX(100%);
            transition: var(--transition);
            max-width: 400px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success { 
            background: linear-gradient(135deg, rgba(40, 167, 69, 0.9) 0%, rgba(33, 136, 56, 0.9) 100%);
        }
        .notification.error { 
            background: linear-gradient(135deg, rgba(198, 12, 48, 0.9) 0%, rgba(166, 10, 40, 0.9) 100%);
        }
        .notification.info { 
            background: linear-gradient(135deg, rgba(0, 39, 118, 0.9) 0%, rgba(0, 29, 87, 0.9) 100%);
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }

            .coletas-grid {
                grid-template-columns: 1fr;
            }

            .filters-row {
                flex-direction: column;
            }

            .filter-group {
                min-width: auto;
            }

            .date-filters {
                flex-direction: column;
            }

            .date-filter-group {
                min-width: auto;
            }

            .stats-container {
                justify-content: center;
            }

            .modal-content {
                margin: 1rem;
                padding: 1.5rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .floating-action-buttons {
                bottom: 1.5rem;
                right: 1.5rem;
            }

            .fab-main {
                width: 60px;
                height: 60px;
                font-size: 1.5rem;
            }

            .fab-secondary {
                width: 50px;
                height: 50px;
                font-size: 1.3rem;
            }

            .info-grid {
                grid-template-columns: 1fr;
            }

            .card-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .status-section {
                flex-direction: row;
                align-items: center;
                width: 100%;
                justify-content: space-between;
                margin-top: 0.5rem;
            }

            .message {
                max-width: 90%;
            }
            
            .validation-actions {
                flex-direction: column;
            }
            
            .btn-validation {
                width: 100%;
                justify-content: center;
            }
        }

        /* ========== ESTILOS DE VALIDAÇÃO ========== */
        .field-input-error {
            border-color: #dc3545 !important;
            box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
        }

        .field-error {
            color: #dc3545;
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            position: relative;
        }

        .form-group .field-error {
            position: absolute;
            bottom: -1.25rem;
            left: 0;
            z-index: 10;
        }

        /* ========== ESTILOS DE MULTI-SELECT - Otimizado ========== */
        .multi-select-wrapper {
            position: relative;
            width: 100%;
        }

        .multi-select-button {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            align-items: center;
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--cinza-escuro);
            transition: all 0.2s ease;
        }

        .multi-select-button:hover {
            border-color: var(--azul-escuro);
            box-shadow: 0 2px 8px rgba(0, 39, 118, 0.1);
            transform: translateY(-1px);
        }
        
        .multi-select-wrapper.active .multi-select-button {
            border-color: var(--azul-escuro);
            box-shadow: 0 0 0 3px rgba(0, 39, 118, 0.1);
        }

        .multi-select-button i {
            transition: transform 0.3s;
        }

        .multi-select-wrapper.active .multi-select-button i {
            transform: rotate(180deg);
        }

        .multi-select-dropdown {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: white;
            border: 2px solid var(--azul-escuro);
            border-radius: 8px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15), 0 0 0 1px rgba(0, 39, 118, 0.05);
            z-index: 1000;
            max-height: 280px;
            overflow-y: auto;
            display: none;
            margin-top: 2px;
        }

        .multi-select-wrapper.active .multi-select-dropdown {
            display: block;
        }

        .multi-select-search {
            padding: 0.5rem;
            font-size: 0.8rem;
            border-bottom: 1px solid #e9ecef;
            position: sticky;
            top: 0;
            background: white;
            z-index: 10;
        }

        .multi-select-search input {
            width: 100%;
            padding: 0.5rem 0.8rem;
            border: 2px solid #e9ecef;
            border-radius: 6px;
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }
        
        .multi-select-search input:focus {
            outline: none;
            border-color: var(--azul-escuro);
            box-shadow: 0 0 0 3px rgba(0, 39, 118, 0.1);
        }

        .multi-select-options {
            padding: 0.4rem 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .multi-select-option {
            display: flex;
            align-items: center;
            padding: 0.4rem 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .multi-select-option:hover {
            background: rgba(0, 39, 118, 0.05);
        }
        
        .multi-select-option input[type="checkbox"]:checked + span {
            font-weight: 600;
            color: var(--azul-escuro);
        }

        .multi-select-option.hidden {
            display: none;
        }

        .multi-select-option input[type="checkbox"] {
            margin-right: 0.5rem;
            cursor: pointer;
        }

        .multi-select-option span {
            flex: 1;
            font-size: 0.8rem;
        }

        /* ========== ESTILOS DE ACESSIBILIDADE ========== */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        /* Foco visível para navegação por teclado */
        *:focus-visible {
            outline: 3px solid #667eea;
            outline-offset: 2px;
            border-radius: 4px;
        }

        /* Indicador de foco para elementos interativos */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible,
        textarea:focus-visible,
        a:focus-visible {
            outline: 3px solid #667eea;
            outline-offset: 2px;
        }

        /* Melhorar contraste para leitores de tela */
        [aria-invalid="true"] {
            border-color: #dc3545 !important;
        }

        [aria-invalid="true"]:focus {
            outline-color: #dc3545;
        }
        /* Estilos do Formulário Moderno (do cadastro.html) */
        .form-section {
            background: white;
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            border: 1px solid rgba(0,0,0,0.03);
        }
        
        .form-section .section-title {
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.2rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .form-section .section-title i {
            color: #667eea;
            font-size: 1.3rem;
        }
        
        .form-control-modern, .form-select-modern {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1rem 1.25rem;
            font-size: 1rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: white;
        }
        
        .form-control-modern:focus, .form-select-modern:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
            outline: none;
        }
        
        .form-label-modern {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.75rem;
            font-size: 0.95rem;
        }
        
        /* Botões Modernos (do cadastro.html) - Melhorados */
        .btn-modern {
            border: none;
            border-radius: 16px;
            padding: 1.1rem 2.25rem;
            font-weight: 700;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            font-size: 1rem;
            cursor: pointer;
            box-shadow: 0 4px 14px rgba(0, 0, 0, 0.15), 0 2px 6px rgba(0, 0, 0, 0.1);
            letter-spacing: 0.3px;
        }
        
        .btn-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.35), transparent);
            transition: left 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .btn-modern::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            transform: translate(-50%, -50%);
            transition: width 0.5s ease, height 0.5s ease;
        }
        
        .btn-modern:hover::before {
            left: 100%;
        }
        
        .btn-modern:hover::after {
            width: 300px;
            height: 300px;
        }
        
        .btn-modern:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.25), 0 6px 16px rgba(0, 0, 0, 0.15);
        }
        
        .btn-modern:active {
            transform: translateY(-2px) scale(1.01);
        }
        
        .btn-modern-success {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .btn-modern-success:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
        }
        
        .btn-modern-warning {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .btn-modern-warning:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
        }
        
        .btn-modern-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-modern-primary:hover {
            background: linear-gradient(135deg, #5568d3 0%, #6a3f8f 100%);
        }
        
        .btn-modern-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }
        
        .btn-modern-danger:hover {
            background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="main-header">
        <div class="header-content">
            <div>
                <h1 class="header-title">
                    <i class="fas fa-truck-loading"></i> Sistema de Coletas
                </h1>
                <p class="header-subtitle">Gestão completa de operações logísticas</p>
            </div>
            <div class="header-actions">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">US</div>
                    <div class="user-details">
                        <div class="user-name" id="userName">Carregando...</div>
                        <div class="user-role" id="userRole">Usuário</div>
        </div>
                </div>
                <a href="historico_coletas.html" class="btn-modern" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <i class="fas fa-history"></i> Histórico
                </a>
                <a href="portal.html" class="btn-modern">
                    <i class="fas fa-home"></i> Voltar ao Portal
                </a>
            </div>
                </div>
    </header>

    <!-- Conteúdo Principal -->
    <div class="main-container">
        <!-- Controles e Filtros -->
        <div class="controls-container">
            <!-- Filtros de Data -->
            <div class="date-filters">
                <div class="date-filter-group">
                    <label for="dataInicio"><i class="fas fa-calendar-alt"></i> Data Início</label>
                    <input type="date" id="dataInicio" onchange="filterColetas()">
            </div>
                <div class="date-filter-group">
                    <label for="dataFim"><i class="fas fa-calendar-alt"></i> Data Fim</label>
                    <input type="date" id="dataFim" onchange="filterColetas()">
                </div>
                <div class="date-filter-group">
                    <label><i class="fas fa-bolt"></i> Período Rápido</label>
                    <div class="quick-date-buttons">
                        <button class="quick-date-btn" onclick="setQuickDate('hoje')">Hoje</button>
                        <button class="quick-date-btn" onclick="setQuickDate('semana')">Esta Semana</button>
                        <button class="quick-date-btn" onclick="setQuickDate('mes')">Este Mês</button>
                        <button class="quick-date-btn" onclick="setQuickDate('trimestre')">Este Trimestre</button>
                        <button class="quick-date-btn" onclick="clearDateFilters()">Limpar</button>
                </div>
            </div>
        </div>

            <div class="filters-row">
                <div class="filter-group">
                    <label><i class="fas fa-filter"></i> Status</label>
                    <div class="multi-select-wrapper">
                        <button type="button" class="multi-select-button" id="statusFilterButton" onclick="toggleMultiSelect('statusFilter')">
                            <span id="statusFilterText">Todos os Status</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="multi-select-dropdown" id="statusFilterDropdown">
                            <div class="multi-select-search">
                                <input type="text" placeholder="Buscar status..." onkeyup="filterMultiSelectOptions(this, 'statusFilterOptions')">
                            </div>
                            <div class="multi-select-options" id="statusFilterOptions">
                                <label class="multi-select-option">
                                    <input type="checkbox" value="" onchange="updateMultiSelect('statusFilterOptions', this)" checked>
                                    <span>Todos os Status</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="pendente" onchange="updateMultiSelect('statusFilterOptions', this)">
                                    <span>Pendente</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="em_andamento" onchange="updateMultiSelect('statusFilterOptions', this)">
                                    <span>Em Andamento</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="concluida" onchange="updateMultiSelect('statusFilterOptions', this)">
                                    <span>Concluída</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="cancelada" onchange="updateMultiSelect('statusFilterOptions', this)">
                                    <span>Cancelada</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-group">
                    <label><i class="fas fa-layer-group"></i> Etapa</label>
                    <div class="multi-select-wrapper">
                        <button type="button" class="multi-select-button" id="etapaFilterButton" onclick="toggleMultiSelect('etapaFilter')">
                            <span id="etapaFilterText">Todas as Etapas</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="multi-select-dropdown" id="etapaFilterDropdown">
                            <div class="multi-select-search">
                                <input type="text" placeholder="Buscar etapa..." onkeyup="filterMultiSelectOptions(this, 'etapaFilterOptions')">
                            </div>
                            <div class="multi-select-options" id="etapaFilterOptions">
                                <label class="multi-select-option">
                                    <input type="checkbox" value="" onchange="updateMultiSelect('etapaFilterOptions', this)" checked>
                                    <span>Todas as Etapas</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="comercial" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>Comercial</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="price" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>Price</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="cs" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>CS</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="contratacao" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>Contratação</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="gr" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>GR</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="documentacao" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>Documentação</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="controladoria" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>Controladoria</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="ti" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>TI</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="contas_pagar" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>Contas a Pagar</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="contas_receber" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>Contas a Receber</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="monitoramento" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>Monitoramento</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="servicos_adicionais" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>Serviços Adicionais</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="finalizar_operacao" onchange="updateMultiSelect('etapaFilterOptions', this)">
                                    <span>Finalizar Operação</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-group">
                    <label><i class="fas fa-building"></i> Filial</label>
                    <div class="multi-select-wrapper">
                        <button type="button" class="multi-select-button" id="filialFilterButton" onclick="toggleMultiSelect('filialFilter')">
                            <span id="filialFilterText">Todas as Filiais</span>
                            <i class="fas fa-chevron-down"></i>
                        </button>
                        <div class="multi-select-dropdown" id="filialFilterDropdown">
                            <div class="multi-select-search">
                                <input type="text" placeholder="Buscar filial..." onkeyup="filterMultiSelectOptions(this, 'filialFilterOptions')">
                            </div>
                            <div class="multi-select-options" id="filialFilterOptions">
                                <label class="multi-select-option">
                                    <input type="checkbox" value="" onchange="updateMultiSelect('filialFilterOptions', this)" checked>
                                    <span>Todas as Filiais</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="JBO" onchange="updateMultiSelect('filialFilterOptions', this)">
                                    <span>Jaboatão</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="CABO" onchange="updateMultiSelect('filialFilterOptions', this)">
                                    <span>CABO</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="AL" onchange="updateMultiSelect('filialFilterOptions', this)">
                                    <span>Alagoas</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="SP" onchange="updateMultiSelect('filialFilterOptions', this)">
                                    <span>São Paulo</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="BA" onchange="updateMultiSelect('filialFilterOptions', this)">
                                    <span>Bahia</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="CE" onchange="updateMultiSelect('filialFilterOptions', this)">
                                    <span>Ceará</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="SE" onchange="updateMultiSelect('filialFilterOptions', this)">
                                    <span>Sergipe</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="PB" onchange="updateMultiSelect('filialFilterOptions', this)">
                                    <span>Paraíba</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="PE" onchange="updateMultiSelect('filialFilterOptions', this)">
                                    <span>Recife</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="AMBEV" onchange="updateMultiSelect('filialFilterOptions', this)">
                                    <span>Ambev</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="US" onchange="updateMultiSelect('filialFilterOptions', this)">
                                    <span>Usinas</span>
                                </label>
                                <label class="multi-select-option">
                                    <input type="checkbox" value="PARATIBE" onchange="updateMultiSelect('filialFilterOptions', this)">
                                    <span>Paratibe</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="filter-group">
                    <label for="searchFilter"><i class="fas fa-search"></i> Buscar</label>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <input type="text" id="searchFilter" placeholder="Cliente, origem, destino, nº da coleta, filial..." onkeyup="filterColetas()" style="flex: 1;" onkeypress="if(event.key === 'Enter') buscarECarregarTrajetoria()">
                        <button onclick="buscarECarregarTrajetoria()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s; white-space: nowrap;" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.4)'" onmouseout="this.style.transform=''; this.style.boxShadow=''" title="Buscar e ver trajetória completa">
                            <i class="fas fa-route"></i> Trajetória
                        </button>
                    </div>
                </div>
                </div>
            
            <div class="stats-container">
                <div class="stat-card" style="background: var(--gradient-primary);">
                    <div>
                        <div class="stat-number" id="totalColetas">0</div>
                        <div class="stat-value" id="totalColetasValor">R$ 0,00</div>
                    </div>
                    <div class="stat-label">Total</div>
                </div>
                <div class="stat-card" style="background: var(--gradient-danger);">
                    <div>
                        <div class="stat-number" id="pendentesCount">0</div>
                        <div class="stat-value" id="pendentesValor">R$ 0,00</div>
                    </div>
                    <div class="stat-label">Pendentes</div>
                </div>
                <div class="stat-card" style="background: var(--gradient-warning);">
                    <div>
                        <div class="stat-number" id="andamentoCount">0</div>
                        <div class="stat-value" id="andamentoValor">R$ 0,00</div>
                    </div>
                    <div class="stat-label">Em Andamento</div>
                </div>
                <div class="stat-card" style="background: var(--gradient-success);">
                    <div>
                        <div class="stat-number" id="concluidasCount">0</div>
                        <div class="stat-value" id="concluidasValor">R$ 0,00</div>
                    </div>
                    <div class="stat-label">Concluídas</div>
                </div>
                <div class="stat-card" style="background: var(--gradient-purple);">
                    <div>
                        <div class="stat-number" id="canceladasCount">0</div>
                        <div class="stat-value" id="canceladasValor">R$ 0,00</div>
                    </div>
                    <div class="stat-label">Canceladas</div>
                </div>
            </div>
        </div>

        <!-- Controles de Visualização -->
        <div style="display: flex; justify-content: space-between; align-items: center; margin: 0.3rem 0; padding: 0 0.4rem;">
            <h2 style="margin: 0; color: #667eea; font-size: 0.9rem; font-weight: 700; letter-spacing: -0.3px;">
                <i class="fas fa-tasks" style="margin-right: 0.4rem;"></i> Coletas
            </h2>
            <div style="display: flex; gap: 0.4rem; background: rgba(102, 126, 234, 0.1); padding: 0.2rem; border-radius: 8px;">
                <button id="btnViewGrid" onclick="alternarVisualizacao('grid')" 
                        style="padding: 0.4rem 0.75rem; border: none; border-radius: 6px; background: transparent; color: #667eea; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: all 0.3s;">
                    <i class="fas fa-th"></i> Grid
                </button>
                <button id="btnViewKanban" onclick="alternarVisualizacao('kanban')" 
                        style="padding: 0.4rem 0.75rem; border: none; border-radius: 6px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; cursor: pointer; font-weight: 600; font-size: 0.85rem; transition: all 0.3s;">
                    <i class="fas fa-columns"></i> Kanban
                </button>
        </div>
        </div>

        <!-- Funil Geral - Apenas para usuários com permissão de settings -->
        <div class="funil-geral-container" id="funilGeralContainer">
            <div class="funil-geral-header">
                <div class="funil-geral-title">
                    <i class="fas fa-filter"></i>
                    <span>Funil Geral - Todas as Etapas</span>
                </div>
                <div class="funil-geral-stats" id="funilGeralStats">
                    <span><strong id="funilTotalColetas">0</strong> coletas</span>
                    <span><strong id="funilTotalValor">R$ 0,00</strong> total</span>
                </div>
            </div>
            <div class="funil-etapas-wrapper" id="funilEtapasWrapper">
                <!-- Etapas serão renderizadas dinamicamente via JavaScript -->
            </div>
            <div class="funil-grafico-tempo-container" id="funilGraficoTempoContainer" style="margin-top: 1.5rem;">
                <h4 class="funil-grafico-tempo-titulo"><i class="fas fa-chart-bar"></i> Tempo médio por etapa</h4>
                <div id="funilGraficoTempoBarras" class="funil-grafico-tempo-barras"><!-- Barras renderizadas via criarGraficoTempoPorEtapa() --></div>
            </div>
        </div>

        <!-- Grid de Coletas -->
        <div class="coletas-grid" id="coletasGrid" style="display: none;">
            <!-- Cards serão gerados dinamicamente via JavaScript -->
        </div>

        <!-- Menu Lateral de Módulos (Responsivo) -->
        <div class="modules-sidebar" id="modulesSidebar">
            <div class="modules-sidebar-header">
                <h2>
                    <i class="fas fa-th-large"></i>
                    <span>Módulos</span>
                </h2>
                <button class="modules-sidebar-toggle-btn" onclick="toggleModulesSidebar()" title="Colapsar Menu">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            <div class="modules-sidebar-content" id="modulesSidebarContent">
                <!-- Módulos serão carregados dinamicamente via JavaScript -->
                <div style="padding: 2rem; text-align: center; color: rgba(255,255,255,0.5);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>Carregando módulos...</p>
                </div>
            </div>
        </div>

        <!-- Overlay para fechar o sidebar em mobile -->
        <div class="modules-sidebar-overlay" id="modulesSidebarOverlay" onclick="closeModulesSidebarMobile()"></div>

        <!-- Botão Mobile para Abrir Menu -->
        <button class="modules-sidebar-mobile-toggle" id="modulesSidebarMobileToggle" onclick="toggleModulesSidebarMobile()" title="Abrir Menu de Módulos">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Botão Flutuante para Abrir Menu (Desktop) -->
        <button class="modules-sidebar-toggle-float" id="modulesSidebarToggleFloat" onclick="toggleModulesSidebar()" title="Abrir Menu de Módulos">
            <i class="fas fa-bars"></i>
        </button>

        <!-- Wrapper do Conteúdo Principal -->
        <div class="main-content-wrapper with-sidebar" id="mainContentWrapper">

        <!-- Menu Lateral de Funis -->
        <div class="funis-sidebar" id="funisSidebar">
            <div class="funis-sidebar-header">
                <h3>
                    <i class="fas fa-filter"></i>
                    <span>Selecionar Funil</span>
                </h3>
                <button class="funis-sidebar-close" onclick="toggleFunisSidebar()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="funis-sidebar-content" id="funisSidebarContent">
                <div class="funis-loading">
                    <i class="fas fa-spinner fa-spin"></i>
                    <span>Carregando funis...</span>
                </div>
            </div>
        </div>
        
        <!-- Botão Flutuante para Abrir Menu de Funis -->
        <button class="funis-sidebar-toggle" id="funisSidebarToggle" onclick="toggleFunisSidebar()" title="Selecionar Funil">
            <i class="fas fa-filter"></i>
        </button>
        
        <!-- Overlay para fechar o sidebar ao clicar fora -->
        <div class="funis-sidebar-overlay" id="funisSidebarOverlay" onclick="toggleFunisSidebar()"></div>

        <!-- Kanban de Coletas -->
        <div class="kanban-container" id="kanbanContainer" style="display: block;">
            
            <!-- ✅ FAROL DE PRIORIDADES - Legenda de Cores -->
            <div class="prioridade-farol" id="prioridadeFarol">
                <div class="farol-header" onclick="toggleFarol()">
                    <i class="fas fa-traffic-light"></i>
                    <span>Farol de Prioridades</span>
                    <i class="fas fa-chevron-down farol-chevron"></i>
                </div>
                <div class="farol-content" id="farolContent">
                    <div class="farol-item">
                        <div class="farol-cor" style="background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%); border: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);"></div>
                        <div class="farol-info">
                            <strong>Baixa</strong>
                            <span>0-10 minutos na etapa</span>
                        </div>
                    </div>
                    <div class="farol-item">
                        <div class="farol-cor" style="background: linear-gradient(135deg, #ffc107 0%, #e0a800 100%); border: 2px solid #ffc107;"></div>
                        <div class="farol-info">
                            <strong>Normal</strong>
                            <span>10-20 minutos na etapa</span>
                        </div>
                    </div>
                    <div class="farol-item">
                        <div class="farol-cor" style="background: linear-gradient(135deg, #fd7e14 0%, #e8590c 100%); border: 2px solid #fd7e14;"></div>
                        <div class="farol-info">
                            <strong>Alta</strong>
                            <span>20-40 minutos na etapa</span>
                        </div>
                    </div>
                    <div class="farol-item">
                        <div class="farol-cor" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); border: 2px solid #dc3545;"></div>
                        <div class="farol-info">
                            <strong>Urgente</strong>
                            <span>Mais de 40 minutos na etapa</span>
                        </div>
                    </div>
                    <div class="farol-item">
                        <div class="farol-cor" style="background: linear-gradient(135deg, #1a1a1a 0%, #000000 100%); border: 2px solid #000000;"></div>
                        <div class="farol-info">
                            <strong>Risco de Perder Cliente</strong>
                            <span>Mais de 2h em etapa crítica ou 4h em qualquer etapa</span>
                        </div>
                    </div>
                    <div class="farol-item farol-item-especial">
                        <div class="farol-cor" style="background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); border: 2px solid #0ea5e9;"></div>
                        <div class="farol-info">
                            <strong>Diária</strong>
                            <span>Coleta diária (sempre azul, independente do tempo)</span>
                        </div>
                    </div>
                    <div class="farol-note">
                        <i class="fas fa-info-circle"></i>
                        <span>As cores são calculadas automaticamente baseadas no tempo que a coleta está na etapa atual.</span>
                    </div>
                </div>
            </div>
            
            <!-- Controles de Navegação -->
            <div class="kanban-navigation" id="kanbanNavigation">
                <div class="kanban-nav-buttons">
                    <button class="kanban-nav-btn" id="kanbanNavPrev" title="Etapa anterior">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                    <button class="kanban-nav-btn" id="kanbanNavNext" title="Próxima etapa">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                </div>
                <div class="kanban-stages-indicator" id="kanbanStagesIndicator">
                    <!-- Indicadores de etapas serão gerados dinamicamente -->
                </div>
                <div class="kanban-stages-info" id="kanbanStagesInfo">
                    <!-- Informação de etapas será gerada dinamicamente -->
                </div>
            </div>
            <div class="kanban-board-wrapper">
                <div class="kanban-board" id="kanbanBoard">
                    <!-- Colunas serão geradas dinamicamente via JavaScript -->
                </div>
            </div>
        </div>

        <!-- Drawer do Kanban (Workspace) -->
        <div class="kanban-drawer" id="kanbanDrawer">
            <div class="kanban-drawer-overlay" onclick="fecharKanbanDrawer()"></div>
            <div class="kanban-drawer-content" id="kanbanDrawerContent">
                <!-- Conteúdo será carregado dinamicamente -->
            </div>
        </div>

        <!-- Modal de Movimentação de Coletas -->
        <div class="modal-mover-coleta" id="modalMoverColeta">
            <div class="modal-mover-coleta-content">
                <div class="modal-mover-coleta-header">
                    <h3 class="modal-mover-coleta-title">
                        <i class="fas fa-exchange-alt"></i>
                        Mover Coleta
                    </h3>
                    <button class="modal-mover-coleta-close" onclick="fecharModalMoverColeta()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-mover-coleta-body">
                    <!-- Preview da Coleta -->
                    <div class="modal-mover-coleta-preview" id="modalMoverColetaPreview">
                        <div class="modal-mover-coleta-preview-title" id="modalMoverColetaPreviewTitle">
                            Carregando...
                        </div>
                        <div class="modal-mover-coleta-preview-info" id="modalMoverColetaPreviewInfo">
                            ...
        </div>
    </div>

                    <!-- Seletor de Funil -->
                    <div class="modal-mover-coleta-group">
                        <label class="modal-mover-coleta-label" for="selectFunilDestino">
                            <i class="fas fa-project-diagram"></i> Funil de Destino
                        </label>
                        <select id="selectFunilDestino" class="modal-mover-coleta-select" onchange="atualizarEtapasDoFunil()">
                            <option value="">Selecione um funil</option>
                        </select>
                    </div>

                    <!-- Seletor de Etapa -->
                    <div class="modal-mover-coleta-group">
                        <label class="modal-mover-coleta-label" for="selectEtapaDestino">
                            <i class="fas fa-list-ol"></i> Etapa de Destino
                        </label>
                        <select id="selectEtapaDestino" class="modal-mover-coleta-select" disabled>
                            <option value="">Selecione primeiro um funil</option>
                        </select>
                    </div>

                    <!-- Ações -->
                    <div class="modal-mover-coleta-actions">
                        <button class="modal-mover-coleta-btn modal-mover-coleta-btn-secondary" onclick="fecharModalMoverColeta()">
                            Cancelar
                        </button>
                        <button class="modal-mover-coleta-btn modal-mover-coleta-btn-primary" onclick="confirmarMovimentacaoColeta()" id="btnConfirmarMovimentacao" disabled>
                            <i class="fas fa-check"></i> Confirmar Movimentação
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
    <!-- Fim do Wrapper do Conteúdo Principal -->

    <!-- Modal de Detalhes da Coleta -->
    <div class="modal-overlay" id="coletaModal" 
         role="dialog" 
         aria-modal="true" 
         aria-labelledby="modalTitle"
         aria-describedby="modalDescription"
         tabindex="-1">
            <div class="modal-content" role="document">
                <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">
                    <i class="fas fa-truck-loading" aria-hidden="true"></i>
                    <span>Nova Coleta</span>
                </h2>
                <div id="modalDescription" class="sr-only">Formulário para criar ou editar uma coleta</div>
                <div style="display: flex; gap: 0.5rem; align-items: center;">
                    <button type="button" id="toggleModoLote" class="action-btn secondary" onclick="alternarModoCriacao()" 
                            aria-label="Alternar modo de criação" 
                            aria-pressed="false"
                            style="font-size: 0.85rem; padding: 0.4rem 0.8rem;"
                            tabindex="0">
                        <i class="fas fa-layer-group" aria-hidden="true"></i> <span id="modoTexto">Criar Múltiplas</span>
                    </button>
                <button class="close-modal" onclick="closeModal()" 
                        aria-label="Fechar modal" 
                        aria-controls="coletaModal"
                        tabindex="0">
                    <i class="fas fa-times" aria-hidden="true"></i>
                </button>
                </div>
                </div>
            
            <form id="coletaForm" role="form" aria-label="Formulário de coleta" novalidate>
                <div class="form-grid">
                    <div class="form-group full-width" style="margin-bottom: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; margin-bottom: 0;">
                            <input type="checkbox" id="diaria" name="diaria" style="width: 20px; height: 20px; cursor: pointer;" onchange="toggleCamposObrigatorios()">
                            <span style="font-weight: 600; color: #0ea5e9; font-size: 1rem;">
                                <i class="fas fa-calendar-day"></i> Diária
                            </span>
                        </label>
                        <small style="display: block; margin-top: 0.5rem; color: #6c757d; font-size: 0.85rem; margin-left: 28px;">
                            Marque esta opção se a coleta for do tipo diária. O card ficará destacado em azul no Kanban. <strong>Quando marcado, nenhum campo será obrigatório.</strong>
                        </small>
                    </div>
                    <div class="form-group">
                        <label for="filial">Filial *</label>
                        <select id="filial" name="filial" required 
                                onchange="filtrarClientesPorFilial()"
                                aria-required="true"
                                aria-describedby="filial-error">
                            <option value="">Selecione a filial</option>
                            <option value="JBO">Jaboatão (JBO)</option>
                            <option value="CABO">Cabo (CABO)</option>
                            <option value="SP">São Paulo (SP)</option>
                            <option value="BA">Simões Filho (BA)</option>
                            <option value="SE">Aracaju (SE)</option>
                            <option value="AL">Maceió (AL)</option>
                            <option value="PE">Recife (PE)</option>
                            <option value="PB">João Pessoa (PB)</option>
                            <option value="CE">Fortaleza (CE)</option>
                            <option value="AMBEV">Ambev (AMBEV)</option>
                            <option value="US">Usinas (US)</option>
                            <option value="PARATIBE">Paratibe (PARATIBE)</option>
                        </select>
                    </div>
                    <div class="form-group" id="grupoNumeroColeta">
                        <label for="numeroColeta">Nº da Coleta *</label>
                        <input type="text" id="numeroColeta" name="numeroColeta" 
                               placeholder="Ex: 5565" 
                               required 
                               pattern="[1-9][0-9]*" 
                               title="Digite apenas números, sem zeros à esquerda (ex: 5565)" 
                               oninput="this.value = this.value.replace(/^0+/, '').replace(/[^0-9]/g, '')"
                               aria-required="true"
                               aria-describedby="numeroColeta-error numeroColeta-help"
                               aria-invalid="false">
                        <div id="numeroColeta-help" class="sr-only">Digite apenas números, sem zeros à esquerda. Exemplo: 5565</div>
                                </div>
                    <div class="form-group" id="grupoMultiplosNumeros" style="display: none;">
                        <label for="multiplosNumeros">
                            <i class="fas fa-list-ol"></i> Números das Coletas *
                            <span style="font-size: 0.75rem; color: #6c757d; font-weight: normal; display: block; margin-top: 0.2rem;">
                                Separe por vírgula ou use intervalo (ex: 5565,5566,5567 ou 5565-5569)
                            </span>
                        </label>
                        <textarea id="multiplosNumeros" name="multiplosNumeros" rows="3" placeholder="Ex: 5565,5566,5567,5568,5569&#10;Ou: 5565-5569" style="width: 100%; padding: 0.75rem; border: 2px solid #e0e0e0; border-radius: 8px; font-family: inherit; resize: vertical;" oninput="processarMultiplosNumeros()"></textarea>
                        <div id="previewNumeros" style="margin-top: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 6px; font-size: 0.85rem; color: #495057; display: none;">
                            <strong>Serão criadas <span id="totalColetas">0</span> coleta(s):</strong>
                            <div id="listaNumeros" style="margin-top: 0.3rem; max-height: 100px; overflow-y: auto;"></div>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="cliente">Cliente *</label>
                        <select id="cliente" name="cliente" required disabled onchange="preencherOrigemDestino()">
                            <option value="">Selecione primeiro a filial</option>
                        </select>
                            </div>
                    <div class="form-group">
                        <label for="dataRecebimento">Data de Coleta *</label>
                        <input type="date" id="dataRecebimento" name="dataRecebimento" required>
                                </div>
                    <div class="form-group">
                        <label for="dataEntrega">Data de Entrega *</label>
                        <input type="date" id="dataEntrega" name="dataEntrega" required>
                                </div>
                    <div class="form-group">
                        <label for="origem">Origem *</label>
                        <select id="origem" name="origem" required disabled>
                            <option value="">Selecione primeiro o cliente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="destino">Destino *</label>
                        <select id="destino" name="destino" required disabled>
                            <option value="">Selecione primeiro o cliente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="tipoProduto">Tipo de Produto *</label>
                        <select id="tipoProduto" name="tipoProduto" required disabled onchange="atualizarCodigoTabela()">
                            <option value="">Selecione primeiro o cliente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="codigoTabela">Código da Tabela *</label>
                        <input type="text" id="codigoTabela" name="codigoTabela" readonly 
                               placeholder="Será preenchido automaticamente" 
                               style="background-color: #f8f9fa; cursor: not-allowed;">
                    </div>
                    <div class="form-group">
                        <label for="valor">Valor CTE (R$) *</label>
                        <input type="number" id="valor" name="valor" step="0.01" min="0" placeholder="0,00" required>
                                </div>
                    <div class="form-group">
                        <label for="freteMotorista">Frete Motorista (R$) *</label>
                        <input type="number" id="freteMotorista" name="freteMotorista" step="0.01" min="0" placeholder="0,00" required>
                            </div>
                    <div class="form-group">
                        <label for="km">KM *</label>
                        <input type="number" id="km" name="km" step="0.1" min="0" placeholder="0" required>
                            </div>
                    <div class="form-group">
                        <label for="classeVeiculo">
                            <i class="fas fa-layer-group" aria-hidden="true"></i> Classe do Veículo *
                        </label>
                        <select id="classeVeiculo" name="classeVeiculo" 
                                required 
                                onchange="atualizarTiposVeiculoECarroceria()"
                                aria-required="true"
                                aria-describedby="classeVeiculo-error classeVeiculo-help"
                                aria-controls="tiposVeiculoContainer tiposCarroceriaContainer">
                            <option value="">Selecione a classe</option>
                            <option value="leve">Leve</option>
                            <option value="medio">Médio</option>
                            <option value="pesado">Pesado</option>
                        </select>
                        <div id="classeVeiculo-help" class="sr-only">Selecione a classe do veículo para filtrar os tipos disponíveis</div>
                            <option value="">Selecione a classe</option>
                            <option value="leve">Leve</option>
                            <option value="medio">Médio</option>
                            <option value="pesado">Pesado</option>
                        </select>
                            </div>
                    <div class="form-group full-width">
                        <label style="margin-bottom: 0.8rem; display: block; font-weight: 600;">
                            <i class="fas fa-truck"></i> Tipos de Veículo *
                        </label>
                        <div id="tiposVeiculoContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 0.8rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                            <p style="grid-column: 1 / -1; text-align: center; color: #6c757d; margin: 0;">Selecione primeiro a classe do veículo</p>
                        </div>
                    </div>
                    <div class="form-group full-width">
                        <label style="margin-bottom: 0.8rem; display: block; font-weight: 600;">
                            <i class="fas fa-box"></i> Tipos de Carroceria *
                        </label>
                        <div id="tiposCarroceriaContainer" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 0.8rem; padding: 1rem; background: #f8f9fa; border-radius: 8px; border: 1px solid #e9ecef;">
                            <p style="grid-column: 1 / -1; text-align: center; color: #6c757d; margin: 0;">Selecione primeiro a classe do veículo</p>
                        </div>
                                </div>
                    <div class="form-group">
                        <label for="status"><i class="fas fa-flag me-2"></i>Status</label>
                        <select id="status" name="status">
                            <option value="pendente">Pendente</option>
                            <option value="em_andamento">Em Andamento</option>
                            <option value="concluida">Concluída</option>
                            <option value="cancelada">Cancelada</option>
                        </select>
                            </div>
                    <div class="form-group">
                        <label for="prioridade"><i class="fas fa-exclamation-triangle me-2" style="color: #f59e0b;"></i>Prioridade</label>
                        <select id="prioridade" name="prioridade" style="border-left: 3px solid #f59e0b;">
                            <option value="baixa">Baixa</option>
                            <option value="normal" selected>Normal</option>
                            <option value="alta">Alta</option>
                            <option value="urgente" id="prioridadeUrgenteOption">Urgente</option>
                        </select>
                            </div>
                    <div class="form-group">
                        <label for="etapaAtual"><i class="fas fa-layer-group me-2"></i>Etapa Atual</label>
                        <select id="etapaAtual" name="etapaAtual">
                            <option value="comercial">Comercial</option>
                            <option value="price">Price</option>
                            <option value="cs">CS</option>
                            <option value="contratacao">Contratação</option>
                            <option value="gr">GR</option>
                            <option value="documentacao">Documentação</option>
                            <option value="controladoria">Controladoria</option>
                            <option value="ti">TI</option>
                            <option value="contas_pagar">Contas a Pagar</option>
                            <option value="contas_receber">Contas a Receber</option>
                            <option value="monitoramento">Monitoramento</option>
                            <option value="finalizar_operacao">Finalizar Operação</option>
                        </select>
                        </div>
                    <div class="form-group full-width">
                        <label for="observacoes">Observações</label>
                        <textarea id="observacoes" name="observacoes" rows="3" placeholder="Informações adicionais sobre a coleta..."></textarea>
                        </div>
                        </div>
                
                <div class="modal-actions">
                    <button type="button" class="action-btn warning" onclick="closeModal()">
                        <i class="fas fa-times"></i> Cancelar
                    </button>
                    <button type="submit" class="action-btn success">
                        <i class="fas fa-save"></i> Salvar Coleta
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Anexos -->
    <div class="modal-overlay" id="anexosModal">
        <div class="modal-content modal-anexos">
                <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-paperclip"></i>
                    <span id="modalAnexosTitle">Anexos da Coleta</span>
                </h2>
                <button class="close-modal" onclick="closeAnexosModal()">
                    <i class="fas fa-times"></i>
                </button>
                </div>
            
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                                </div>
                <div class="upload-text">
                    <h5>Arraste arquivos aqui ou clique para selecionar</h5>
                    <p>PDF, imagens, Excel, Word (Máx. 10MB por arquivo)</p>
                                        </div>
                <div class="file-types">
                    <span class="file-type-badge">PDF</span>
                    <span class="file-type-badge">XLS/XLSX</span>
                    <span class="file-type-badge">JPG/PNG</span>
                    <span class="file-type-badge">DOC/DOCX</span>
                                        </div>
                                    </div>
            
            <input type="file" id="fileInput" multiple style="display: none;" 
                   accept=".pdf,.jpg,.jpeg,.png,.xls,.xlsx,.doc,.docx" onchange="handleFileSelect(this.files)">
            
            <!-- Seleção de Categoria -->
            <div class="form-group" style="margin: 1.5rem 0;">
                <label for="anexoCategoriaSelect" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">
                    <i class="fas fa-folder"></i> Categoria do Anexo:
                </label>
                <select id="anexoCategoriaSelect" style="width: 100%; padding: 0.8rem; border: 2px solid #e9ecef; border-radius: 10px; font-size: 1rem; background: white;" onchange="toggleTituloContratoModal(this.value)">
                    <option value="">Selecione a categoria</option>
                    <option value="canhoto">📋 Canhoto (comprovante de entrega)</option>
                    <option value="documentos_motorista">📄 Documentos do Motorista</option>
                    <option value="documentos_proprietario">📋 Documentos do Proprietário</option>
                    <option value="documentos_veiculo">🚛 Documentos do Veículo</option>
                    <option value="evidencias">📸 Evidências</option>
                    <option value="faturamento">💰 Faturamento</option>
                    <option value="notas_fiscais">🧾 Notas Fiscais</option>
                    <option value="contratos">📝 Contratos</option>
                    <option value="outros">📁 Outros</option>
                </select>
                <small style="color: #6c757d; font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                    Organize os documentos por categoria para facilitar a busca
                </small>
                <!-- Campo de título do contrato (aparece apenas quando categoria for contratos) -->
                <div id="tituloContratoContainerModal" style="display: none; margin-top: 1.5rem;">
                    <label for="tituloContratoInputModal" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">
                        <i class="fas fa-file-contract"></i> Título do Contrato:
                    </label>
                    <input type="text" 
                           id="tituloContratoInputModal" 
                           placeholder="Ex: Contrato de Prestação de Serviços - Cliente XYZ"
                           style="width: 100%; padding: 0.8rem; border: 2px solid #e9ecef; border-radius: 10px; font-size: 1rem; background: white;">
                    <small style="color: #6c757d; font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                        O título será exibido no card principal da coleta
                    </small>
                </div>
            </div>
            
            <div class="selected-files" id="selectedFiles" style="display: none;">
                <h6>Arquivos selecionados:</h6>
                <div id="filesList" class="mt-2"></div>
                                    </div>
            
            <div class="upload-progress" id="uploadProgress">
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill" style="width: 0%"></div>
                                    </div>
                <div class="progress-text" id="progressText">0%</div>
                            </div>

            <div class="anexos-list-modal" id="anexosListModal">
                <!-- Lista de anexos será preenchida aqui -->
                                </div>
            
            <div class="modal-actions">
                <button type="button" class="action-btn warning" onclick="closeAnexosModal()">
                    <i class="fas fa-times"></i> Fechar
                </button>
                <button type="button" class="action-btn success" id="btnUpload" onclick="fazerUpload()" disabled>
                    <i class="fas fa-upload"></i> Enviar Arquivos
                                            </button>
                                </div>
                            </div>
                        </div>
                        
    <!-- Modal de Chat -->
    <div class="modal-overlay" id="chatModal">
        <div class="modal-content modal-chat">
            <div class="chat-header">
                <div class="chat-info">
                    <div class="chat-coleta-id" id="chatColetaId">COL-001</div>
                    <div class="chat-cliente" id="chatCliente">Cliente A Ltda</div>
                                </div>
                <button class="chat-close" onclick="closeChatModal()">
                    <i class="fas fa-times"></i>
                                        </button>
                                    </div>
            
            <div class="chat-container">
                <div class="chat-messages" id="chatMessages">
                    <!-- Mensagens serão carregadas aqui -->
                            </div>

                <div class="chat-input-container">
                    <div class="chat-input-wrapper">
                        <textarea class="chat-input" id="chatInput" placeholder="Digite sua mensagem..." rows="1"></textarea>
                        <button class="chat-send" id="chatSend" onclick="sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                                </div>
                                    </div>
                                    </div>
                                </div>
                            </div>

    <!-- Modal de Mudança de Etapa -->
    <div class="modal-overlay" id="moverEtapaModal">
        <div class="modal-content" style="max-width: 480px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-arrows-alt"></i>
                    Mover Etapa da Coleta
                </h2>
                <button class="close-modal" onclick="fecharMoverEtapaModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 0 1.5rem 1.5rem;">
                <p style="font-weight:600; margin-bottom:0.5rem;">Etapa atual: <span id="moverEtapaAtual" style="color:#5a67d8;"></span></p>
                <div class="form-group">
                    <label for="novaEtapaSelect">Escolha a nova etapa</label>
                    <select id="novaEtapaSelect">
                        <option value="">Selecione a etapa</option>
                    </select>
                </div>
                <p style="font-size:0.85rem; color:#6c757d; margin-top:0.5rem;">
                    Apenas usuários com permissão na etapa atual podem mover a oportunidade. A mudança é registrada automaticamente no histórico.
                </p>
            </div>
            <div class="modal-actions">
                <button type="button" class="action-btn warning" onclick="fecharMoverEtapaModal()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="action-btn secondary" onclick="confirmarMoverEtapa()">
                    <i class="fas fa-check"></i> Confirmar
                </button>
                                    </div>
                                </div>
                            </div>

    <!-- Modal de Assistente Inteligente de Movimentação -->
    <div class="assistente-modal" id="assistenteMovimentacaoModal">
        <div class="assistente-content">
            <div class="assistente-header">
                <h3>
                    <i class="fas fa-robot"></i>
                    Assistente de Movimentação
                </h3>
                <button class="close-modal" onclick="fecharAssistenteMovimentacao()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer; padding: 0.5rem;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="assistente-body" id="assistenteBody">
                <!-- Conteúdo será preenchido dinamicamente -->
                                    </div>
                                </div>
                            </div>

    <!-- Modal de Tipo de Pagamento para Contas a Pagar -->
    <div class="modal-overlay" id="modalTipoPagamento" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-money-bill-wave"></i>
                    Tipo de Pagamento
                </h2>
                <button class="close-modal" onclick="fecharModalTipoPagamento()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <p style="color: #6c757d; margin-bottom: 1.5rem;">
                    É obrigatório informar o tipo de pagamento ao mover para a etapa <strong>Contas a Pagar</strong>.
                </p>
                <div class="form-group">
                    <label for="tipoPagamentoSelect"><i class="fas fa-list"></i> Selecione o tipo de pagamento:</label>
                    <select id="tipoPagamentoSelect" style="width: 100%; padding: 0.8rem; border: 2px solid #e9ecef; border-radius: 10px; font-size: 1rem;">
                        <option value="">Selecione o tipo de pagamento</option>
                        <option value="GNRE">GNRE</option>
                        <option value="PEDÁGIO">PEDÁGIO</option>
                        <option value="GNRE + PEDÁGIO">GNRE + PEDÁGIO</option>
                        <option value="ADIANTAMENTO">ADIANTAMENTO</option>
                        <option value="SALDO">SALDO</option>
                        <option value="PAGAMENTO DE FRETE TOTAL">PAGAMENTO DE FRETE TOTAL</option>
                    </select>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="action-btn warning" onclick="fecharModalTipoPagamento()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="action-btn secondary" onclick="confirmarTipoPagamento()">
                    <i class="fas fa-check"></i> Confirmar
                </button>
                                    </div>
                                </div>
                            </div>

    <!-- Modal de Histórico Completo -->
    <div class="modal-overlay" id="modalHistoricoCompleto" style="display: none;">
        <div class="modal-content" style="max-width: 900px; max-height: 90vh; overflow-y: auto; background: white; border-radius: 20px; padding: 2rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 2px solid #e9ecef; padding-bottom: 1rem;">
                <h2 style="color: #667eea; margin: 0;">
                    <i class="fas fa-history"></i> Histórico Completo de Movimentações
                </h2>
                <button onclick="fecharModalHistoricoCompleto()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #666; padding: 0.5rem;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="conteudoHistoricoCompleto"></div>
        </div>
    </div>

    <!-- Modal de Trajetória Completa da Coleta -->
    <div class="modal-overlay" id="modalTrajetoriaColeta" style="display: none; z-index: 10000; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px);">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto; background: white; border-radius: 24px; padding: 2rem; box-shadow: 0 20px 60px rgba(0,0,0,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; border-bottom: 2px solid #e9ecef; padding-bottom: 1rem;">
                <h2 style="color: #2d3748; margin: 0; display: flex; align-items: center; gap: 0.75rem; font-size: 1.5rem; font-weight: 700;">
                    <i class="fas fa-route" style="color: #667eea;"></i> 
                    <span>Trajetória Completa da Coleta</span>
                </h2>
                <button onclick="fecharModalTrajetoria()" style="background: #f8f9fa; border: none; font-size: 1.5rem; cursor: pointer; color: #666; padding: 0.75rem; border-radius: 50%; width: 2.5rem; height: 2.5rem; display: flex; align-items: center; justify-content: center; transition: all 0.3s; box-shadow: 0 2px 8px rgba(0,0,0,0.1);" onmouseover="this.style.background='#dc3545'; this.style.color='white'; this.style.transform='rotate(90deg) scale(1.1)'" onmouseout="this.style.background='#f8f9fa'; this.style.color='#666'; this.style.transform='rotate(0deg) scale(1)'">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="conteudoTrajetoriaColeta">
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #667eea;"></i>
                    <p style="margin-top: 1rem; color: #666;">Carregando trajetória...</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Confirmar Pagamento -->
    <div class="modal-overlay" id="modalConfirmarPagamento" style="display: none;">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-money-check-alt"></i>
                    Confirmar Pagamento
                </h2>
                <button class="close-modal" onclick="fecharModalConfirmarPagamento()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div id="confirmarPagamentoPreview" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <p style="margin: 0; font-weight: 600;">Carregando informações da coleta...</p>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-list"></i> Tipo de Pagamento <span class="required-asterisk">*</span>
                    </label>
                    <select id="tipoPagamentoConfirmar" class="form-control" required>
                        <option value="">Selecione o tipo de pagamento</option>
                        <option value="Adiantamento">Adiantamento</option>
                        <option value="Saldo">Saldo</option>
                        <option value="Pagamento de frete total">Pagamento de frete total</option>
                        <option value="Pagamento de ajudante">Pagamento de ajudante</option>
                        <option value="Diária">Diária</option>
                        <option value="Descarga">Descarga</option>
                        <option value="Amarração">Amarração</option>
                        <option value="Pedágio">Pedágio</option>
                        <option value="GNRE">GNRE</option>
                        <option value="Pedágio + GNRE">Pedágio + GNRE</option>
                        <option value="Reembolso">Reembolso</option>
                        <option value="Reembolso SEST/SENAT">Reembolso SEST/SENAT</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-money-bill-wave"></i> Valor (R$) <span class="required-asterisk">*</span>
                    </label>
                    <input type="text" id="valorPagamentoConfirmar" class="form-control" required placeholder="Ex: 1500,00 ou 1500.50" inputmode="decimal" title="Informe o valor referente ao tipo de pagamento (ex: 1500,00)">
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-comment"></i> Observações (opcional)
                    </label>
                    <textarea id="observacoesPagamento" class="form-control" rows="3" placeholder="Adicione observações sobre o pagamento..."></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="action-btn warning" onclick="fecharModalConfirmarPagamento()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="action-btn secondary" onclick="confirmarPagamento()">
                    <i class="fas fa-check"></i> Confirmar Pagamento
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Validar Canhoto e Finalizar -->
    <div class="modal-overlay" id="modalValidarCanhoto" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-check-circle"></i>
                    Validar Canhoto e Finalizar Operação
                </h2>
                <button class="close-modal" onclick="fecharModalValidarCanhoto()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div id="validarCanhotoPreview" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <p style="margin: 0; font-weight: 600;">Carregando informações da coleta...</p>
                </div>
                <div style="background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                    <p style="margin: 0; color: #856404; font-weight: 600;">
                        <i class="fas fa-exclamation-triangle"></i> Importante
                    </p>
                    <p style="margin: 0.5rem 0 0 0; color: #856404; font-size: 0.9rem;">
                        Antes de finalizar, verifique se o canhoto foi anexado corretamente e se todas as informações estão corretas.
                    </p>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-check-square"></i> Validação do Canhoto <span class="required-asterisk">*</span>
                    </label>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: #f8f9fa; border-radius: 6px;">
                            <input type="checkbox" id="canhotoValidado" required style="width: 18px; height: 18px; cursor: pointer;">
                            <span>Confirmo que o canhoto foi verificado e está correto</span>
                        </label>
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer; padding: 0.75rem; background: #f8f9fa; border-radius: 6px;">
                            <input type="checkbox" id="informacoesValidadas" required style="width: 18px; height: 18px; cursor: pointer;">
                            <span>Confirmo que todas as informações da coleta estão corretas</span>
                        </label>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-comment"></i> Observações (opcional)
                    </label>
                    <textarea id="observacoesFinalizacao" class="form-control" rows="3" placeholder="Adicione observações sobre a finalização..."></textarea>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="action-btn warning" onclick="fecharModalValidarCanhoto()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="action-btn secondary" onclick="confirmarFinalizarOperacao()">
                    <i class="fas fa-check-circle"></i> Finalizar e Mover para Histórico
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de Lançar Pendência -->
    <div class="modal-overlay" id="modalLancarPendencia" style="display: none;">
        <div class="modal-content" style="max-width: 700px;">
            <div class="modal-header">
                <h2 class="modal-title">
                    <i class="fas fa-exclamation-triangle"></i>
                    Lançar Pendência
                </h2>
                <button class="close-modal" onclick="fecharModalLancarPendencia()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 1.5rem;">
                <div id="lancarPendenciaPreview" style="background: #f8f9fa; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem;">
                    <p style="margin: 0; font-weight: 600;">Carregando informações da coleta...</p>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-comment-alt"></i> Motivo da Pendência <span class="required-asterisk">*</span>
                    </label>
                    <textarea id="motivoPendencia" class="form-control" rows="4" required placeholder="Descreva o motivo da pendência..."></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">
                        <i class="fas fa-paperclip"></i> Evidência (opcional)
                    </label>
                    <input type="file" id="evidenciaPendencia" class="form-control" accept="image/*,.pdf,.doc,.docx" multiple>
                    <small class="form-text text-muted">Você pode anexar imagens, PDFs ou documentos</small>
                    <div id="evidenciaPreview" style="margin-top: 1rem; display: none;">
                        <p style="font-weight: 600; margin-bottom: 0.5rem;">Arquivos selecionados:</p>
                        <div id="evidenciaList" style="display: flex; flex-wrap: wrap; gap: 0.5rem;"></div>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="action-btn warning" onclick="fecharModalLancarPendencia()">
                    <i class="fas fa-times"></i> Cancelar
                </button>
                <button type="button" class="action-btn secondary" onclick="confirmarLancarPendencia()">
                    <i class="fas fa-check"></i> Confirmar e Mover para Pendências
                </button>
            </div>
        </div>
    </div>

    <!-- Botões Flutuantes -->
    <div class="floating-action-buttons">
        <button class="fab-secondary" onclick="window.location.href='relatorios.html'" title="Relatórios">
            <i class="fas fa-chart-bar"></i>
        </button>
        <button class="fab-main" onclick="openNewColetaModal()" title="Nova Coleta">
            <i class="fas fa-plus"></i>
        </button>
                        </div>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="footer-content">
            <div class="footer-logo">
                <i class="fas fa-truck-moving"></i> Multi Modal
                    </div>
            <p>Sistema de Gestão de Operações Logísticas</p>
            <p>© 2025 - Todos os direitos reservados</p>
                </div>
    </footer>

    <!-- Notificação -->
    <div id="notification" class="notification"></div>

    <script>
        // ========== FUNÇÕES GLOBAIS (DEVEM ESTAR PRIMEIRO) ==========
        // Funções chamadas do HTML precisam estar disponíveis antes do HTML ser renderizado
        
        // Função global para limpar filtros de data
        function clearDateFilters() {
            if (document.getElementById('dataInicio')) {
                document.getElementById('dataInicio').value = '';
                document.getElementById('dataFim').value = '';
                document.querySelectorAll('.quick-date-btn').forEach(btn => btn.classList.remove('active'));
                if (typeof filterColetas === 'function') {
                    filterColetas();
                }
            }
        }
        window.clearDateFilters = clearDateFilters;

        // Função global para alternar visibilidade do farol de prioridades
        function toggleFarol() {
            const farol = document.getElementById('prioridadeFarol');
            if (farol) {
                farol.classList.toggle('fechado');
            }
        }
        window.toggleFarol = toggleFarol;

        // Função global para filtrar coletas
        function filterColetas() {
            try {
                // Obter valores dos filtros
                const searchInput = document.getElementById('searchFilter');
                const dataInicioInput = document.getElementById('dataInicio');
                const dataFimInput = document.getElementById('dataFim');
                
                const termoBusca = searchInput ? searchInput.value.trim().toLowerCase() : '';
                const dataInicio = dataInicioInput ? dataInicioInput.value : '';
                const dataFim = dataFimInput ? dataFimInput.value : '';
                
                // Obter dados base
                const dataBase = window.coletasAtivas || coletasData.filter(c => !c.arquivado);
                
                // Aplicar filtros
                let coletasFiltradas = dataBase.filter(coleta => {
                    // Filtro de busca (cliente, origem, destino, número da coleta, filial)
                    if (termoBusca) {
                        const matchBusca = 
                            (coleta.cliente && coleta.cliente.toLowerCase().includes(termoBusca)) ||
                            (coleta.origem && coleta.origem.toLowerCase().includes(termoBusca)) ||
                            (coleta.destino && coleta.destino.toLowerCase().includes(termoBusca)) ||
                            (coleta.numero_coleta && coleta.numero_coleta.toString().toLowerCase().includes(termoBusca)) ||
                            (coleta.filial && coleta.filial.toLowerCase().includes(termoBusca)) ||
                            (coleta.id && coleta.id.toString().toLowerCase().includes(termoBusca));
                        
                        if (!matchBusca) return false;
                    }
                    
                    // Filtro de data
                    if (dataInicio || dataFim) {
                        const dataColeta = coleta.data_recebimento || coleta.created_at;
                        if (!dataColeta) return false;
                        
                        const dataColetaObj = new Date(dataColeta);
                        dataColetaObj.setHours(0, 0, 0, 0);
                        
                        if (dataInicio) {
                            const inicio = new Date(dataInicio);
                            inicio.setHours(0, 0, 0, 0);
                            if (dataColetaObj < inicio) return false;
                        }
                        
                        if (dataFim) {
                            const fim = new Date(dataFim);
                            fim.setHours(23, 59, 59, 999);
                            if (dataColetaObj > fim) return false;
                        }
                    }
                    
                    return true;
                });
                
                // Renderizar com dados filtrados
                renderColetasKanban(coletasFiltradas);
            } catch (error) {
                console.error('❌ Erro ao filtrar coletas:', error);
                // Em caso de erro, renderizar todas as coletas
                renderColetasKanban();
            }
        }
        window.filterColetas = filterColetas;
        
        // Função global para abrir modal de nova coleta
        // Função stub temporária - será redefinida mais abaixo com implementação completa
        // Esta função precisa existir antes do HTML ser renderizado
        function openNewColetaModal() {
            // Se a implementação completa já foi carregada, usar ela
            if (window._openNewColetaModalImpl) {
                window._openNewColetaModalImpl();
            } else {
                // Aguardar um pouco e tentar novamente
                setTimeout(() => {
                    if (window._openNewColetaModalImpl) {
                        window._openNewColetaModalImpl();
                    } else {
                        console.error('openNewColetaModal: implementação não encontrada');
                    }
                }, 100);
            }
        }
        window.openNewColetaModal = openNewColetaModal;
        
        // ========== CONFIGURAÇÃO SUPABASE ==========
        // IMPORTANTE: window.supabase é a biblioteca do CDN (@supabase/supabase-js@2)
        // NÃO declarar 'supabase' como variável - usar window.supabase para a biblioteca
        // Usar variável local para evitar conflitos com scripts externos
        let supabaseClient = null; // Renomeado para evitar conflito com possível variável global do Supabase
        
        async function inicializarSupabase() {
            try {
                console.log('🔧 Inicializando Supabase...');
                
                // Se já foi inicializado por permissions.js, usar o existente
                if (window.supabaseClient && typeof window.supabaseClient.from === 'function') {
                    console.log('✅ Usando Supabase já inicializado por permissions.js');
                    supabaseClient = window.supabaseClient;
                    return true;
                }
                
                // Buscar configuração do servidor
                const response = await fetch('/api/supabase-config');
                if (!response.ok) {
                    throw new Error('Erro ao buscar configuração do Supabase');
                }
                
                const config = await response.json();
                
                // ✅ SEGURANÇA: Não logar informações sensíveis em produção
                // A anon key é pública por design, mas é melhor não expor no console
                if (window.DEBUG || window.location.hostname === 'localhost') {
                    // Em desenvolvimento, logar apenas informações não sensíveis
                    console.log('📋 Configuração Supabase:', {
                        supabaseUrl: config.supabaseUrl,
                        baseUrl: config.baseUrl,
                        supabaseAnonKey: config.supabaseAnonKey ? 
                            `${config.supabaseAnonKey.substring(0, 20)}...${config.supabaseAnonKey.substring(config.supabaseAnonKey.length - 10)}` : 
                            'não configurada'
                    });
                }
                
                // Verificar se a biblioteca Supabase está carregada
                if (typeof window.supabase === 'undefined') {
                    console.error('❌ Biblioteca @supabase/supabase-js não carregada');
                    return false;
                }
                
                // Inicializar cliente Supabase
                // IMPORTANTE: window.supabase é a biblioteca do CDN, não um cliente
                // Usar window.supabase.createClient() para criar o cliente
                if (typeof window.supabase === 'undefined' || typeof window.supabase.createClient !== 'function') {
                    console.error('❌ Biblioteca @supabase/supabase-js não carregada corretamente');
                    return false;
                }
                
                supabaseClient = window.supabase.createClient(config.supabaseUrl, config.supabaseAnonKey);
                // Criar alias global para compatibilidade (usar window.supabaseClient para evitar conflitos)
                window.supabaseClient = supabaseClient;
                // NÃO sobrescrever window.supabase - ele é a biblioteca do CDN
                // Criar alias apenas se necessário para código legado
                if (typeof window.supabaseClientInstance === 'undefined') {
                    window.supabaseClientInstance = supabaseClient;
                }
                
                if (window.DEBUG || window.location.hostname === 'localhost') {
                console.log('✅ Supabase inicializado com sucesso!');
                }
                
                // Configurar listener de autenticação para detectar sessões expiradas
                supabaseClient.auth.onAuthStateChange((event, session) => {
                    // ✅ SEGURANÇA: Não logar eventos de autenticação em produção
                    if (window.DEBUG || window.location.hostname === 'localhost') {
                    console.log('🔐 Mudança de autenticação detectada:', event);
                    }
                    
                    if (event === 'SIGNED_OUT' || event === 'TOKEN_REFRESHED') {
                        // Limpar cache de token quando sessão expira ou é atualizada
                        supabaseAccessToken = null;
                        supabaseTokenExpiry = 0;
                        
                        if (event === 'SIGNED_OUT') {
                            if (window.DEBUG || window.location.hostname === 'localhost') {
                            console.log('🚪 Sessão expirada, redirecionando para login...');
                            }
                            localStorage.removeItem('loggedInUser');
                            window.location.href = 'login.html';
                        } else if (event === 'TOKEN_REFRESHED' && session?.access_token) {
                            // Atualizar token em cache quando for atualizado
                            supabaseAccessToken = session.access_token;
                            supabaseTokenExpiry = session.expires_at ? session.expires_at * 1000 : Date.now() + (60 * 60 * 1000);
                            if (window.DEBUG || window.location.hostname === 'localhost') {
                            console.log('✅ Token atualizado com sucesso');
                            }
                        }
                    }
                });
                
                // Inicializar chat IA após Supabase estar pronto
                if (window.inicializarChatIA) {
                    window.inicializarChatIA();
                }
                
                return true;
                
            } catch (error) {
                console.error('❌ Erro ao inicializar Supabase:', error);
                mostrarErro('Erro ao conectar com o banco de dados');
                return false;
            }
        }

        // ========== VARIÁVEIS GLOBAIS ==========
        let currentUser = null;
        let coletasData = [];
        /** Agregado tempo por etapa (preenchido em enriquecerColetasComTempoParado) para o gráfico */
        let tempoPorEtapaAgregado = [];
        let currentEditingId = null;
        let currentAnexosColetaId = null;
        let selectedFiles = [];
        let currentChatColetaId = null;
        let supabaseAccessToken = null;
        let supabaseTokenExpiry = 0;
        
        // ========== VARIÁVEIS DE PAGINAÇÃO ==========
        let paginaAtual = 1;
        const itensPorPagina = 50;
        let coletasFiltradas = [];
        let moverEtapaColetaId = null;

        // ========== UTILITÁRIOS DE SEGURANÇA E SANITIZAÇÃO ==========
        /**
         * Sanitiza strings para prevenir XSS
         * @param {string} str - String a ser sanitizada
         * @returns {string} - String sanitizada
         */
        function sanitizeHTML(str) {
            if (typeof str !== 'string') return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        /**
         * Sanitiza e retorna HTML seguro para inserção
         * Para HTML confiável (templates internos), use com cuidado
         * @param {string} html - HTML a ser sanitizado
         * @param {boolean} allowHTML - Se true, permite HTML básico (perigoso se usado com dados do usuário)
         * @returns {string} - HTML sanitizado
         */
        function safeHTML(html, allowHTML = false) {
            if (typeof html !== 'string') return '';
            if (!allowHTML) {
                return sanitizeHTML(html);
            }
            // Para templates internos confiáveis, apenas remover scripts e eventos
            const temp = document.createElement('div');
            temp.innerHTML = html;
            // Remover scripts e event handlers
            const scripts = temp.querySelectorAll('script');
            scripts.forEach(s => s.remove());
            // Remover atributos de eventos
            const allElements = temp.querySelectorAll('*');
            allElements.forEach(el => {
                Array.from(el.attributes).forEach(attr => {
                    if (attr.name.startsWith('on')) {
                        el.removeAttribute(attr.name);
                    }
                });
            });
            return temp.innerHTML;
        }

        /**
         * Escapa caracteres especiais para uso em atributos HTML
         * @param {string} str - String a ser escapada
         * @returns {string} - String escapada
         */
        function escapeHTML(str) {
            if (typeof str !== 'string') return '';
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return str.replace(/[&<>"']/g, m => map[m]);
        }

        // ========== SISTEMA CENTRALIZADO DE TRATAMENTO DE ERROS ==========
        class ErrorHandler {
            /**
             * Mapeamento de códigos de erro do Supabase para mensagens amigáveis
             */
            static errorMessages = {
                // Erros de autenticação
                'PGRST301': 'Sessão expirada. Faça login novamente.',
                'PGRST116': 'Registro não encontrado.',
                '23505': 'Este registro já existe no sistema.',
                '23503': 'Não é possível excluir. Existem registros relacionados.',
                '23502': 'Campo obrigatório não preenchido.',
                '23514': 'Erro de validação no banco de dados. A constraint de etapa precisa ser atualizada.',
                '42703': 'Erro no banco de dados. Coluna não encontrada.',
                '42P01': 'Tabela não encontrada.',
                // Erros de rede
                'NetworkError': 'Erro de conexão. Verifique sua internet.',
                'TimeoutError': 'Tempo de espera esgotado. Tente novamente.',
                // Erros genéricos
                'default': 'Ocorreu um erro inesperado. Tente novamente.'
            };

            /**
             * Trata erros de forma centralizada
             * @param {Error} error - Objeto de erro
             * @param {string} context - Contexto onde o erro ocorreu
             * @param {Object} options - Opções adicionais
             * @returns {Object} - Informações do erro tratado
             */
            static handle(error, context = 'Sistema', options = {}) {
                const {
                    showNotification: showNotif = true,
                    logToConsole: logConsole = true,
                    retry: shouldRetry = false,
                    retryCallback = null
                } = options;

                // Log estruturado
                if (logConsole) {
                    console.error(`❌ [${context}]`, error);
                    
                    // Log detalhado em desenvolvimento
                    if (window.DEBUG || window.location.hostname === 'localhost') {
                        console.error('Detalhes do erro:', {
                            message: error.message,
                            code: error.code,
                            details: error.details,
                            hint: error.hint,
                            stack: error.stack
                        });
                    }
                }

                // Obter mensagem amigável
                const userMessage = this.getUserFriendlyMessage(error);
                
                // Notificar usuário
                if (showNotif) {
                    showNotification(userMessage, 'error', 5000);
                }

                // Retry automático se configurado
                if (shouldRetry && retryCallback && typeof retryCallback === 'function') {
                    setTimeout(() => {
                        console.log(`🔄 Tentando novamente após erro em ${context}...`);
                        retryCallback();
                    }, 2000);
                }

                // Reportar para serviço de monitoramento (se disponível)
                if (window.Sentry) {
                    Sentry.captureException(error, {
                        contexts: { context },
                        tags: { context }
                    });
                }

                return {
                    message: userMessage,
                    code: error.code,
                    originalError: error,
                    context
                };
            }

            /**
             * Obtém mensagem amigável para o usuário
             * @param {Error} error - Objeto de erro
             * @returns {string} - Mensagem amigável
             */
            static getUserFriendlyMessage(error) {
                // Tratamento especial para erro de constraint de etapa_atual
                if (error.code === '23514' && error.message && error.message.includes('coletas_etapa_atual_check')) {
                    // Tentar executar migração automaticamente se for admin
                    if (typeof currentUser !== 'undefined' && currentUser && (currentUser.isAdmin || currentUser.role === 'admin')) {
                        console.log('🔧 Detectado erro de constraint. Tentando executar migração automaticamente...');
                        if (typeof executarMigracaoConstraint === 'function') {
                            executarMigracaoConstraint().catch(err => {
                                console.error('❌ Erro ao executar migração automática:', err);
                            });
                        }
                        return 'Erro de validação detectado. Executando correção automática... Tente novamente em alguns segundos.';
                    } else {
                        return 'Erro: A constraint de etapa precisa ser atualizada. Entre em contato com um administrador.';
                    }
                }
                
                // Verificar código de erro específico
                if (error.code && this.errorMessages[error.code]) {
                    return this.errorMessages[error.code];
                }

                // Verificar mensagem de erro
                if (error.message) {
                    const message = error.message.toLowerCase();
                    
                    // Erros de rede
                    if (message.includes('network') || message.includes('fetch')) {
                        return this.errorMessages['NetworkError'];
                    }
                    
                    if (message.includes('timeout')) {
                        return this.errorMessages['TimeoutError'];
                    }

                    // Erros de autenticação
                    if (message.includes('session') || message.includes('token') || message.includes('unauthorized')) {
                        return this.errorMessages['PGRST301'];
                    }

                    // Erros de não encontrado
                    if (message.includes('not found') || message.includes('não encontrado')) {
                        return this.errorMessages['PGRST116'];
                    }
                }

                // Mensagem padrão
                return this.errorMessages['default'];
            }

            /**
             * Wrapper para funções assíncronas com tratamento de erro automático
             * @param {Function} asyncFn - Função assíncrona
             * @param {string} context - Contexto da operação
             * @param {Object} options - Opções de tratamento
             * @returns {Promise} - Promise com tratamento de erro
             */
            static async wrap(asyncFn, context, options = {}) {
                try {
                    return await asyncFn();
                } catch (error) {
                    return this.handle(error, context, options);
                }
            }
        }

        // ========== SISTEMA DE VALIDAÇÃO CENTRALIZADO ==========
        class Validator {
            /**
             * Schema de validação para coletas
             */
            static coletaSchema = {
                filial: {
                    required: true,
                    type: 'string',
                    validate: (val) => val && val.trim().length > 0,
                    message: 'Filial é obrigatória'
                },
                numero_coleta: {
                    required: false, // Será verificado dinamicamente baseado na etapa
                    type: 'string',
                    validate: (val) => {
                        if (!val) return false;
                        const num = parseInt(val, 10);
                        return !isNaN(num) && num > 0 && /^[1-9][0-9]*$/.test(val);
                    },
                    message: 'Número da coleta deve ser um número positivo sem zeros à esquerda',
                    requiredIf: (data) => {
                        // OC é obrigatório apenas a partir da etapa de documentação
                        const etapa = data.etapa_atual || data.etapaAtual || '';
                        const etapasQueExigemOC = ['documentacao', 'controladoria', 'ti', 'contas_pagar', 'contas_receber', 'monitoramento', 'finalizar_operacao'];
                        return etapasQueExigemOC.includes(etapa.toLowerCase());
                    }
                },
                cliente: {
                    required: true,
                    type: 'string',
                    validate: (val) => val && val.trim().length > 0,
                    message: 'Cliente é obrigatório'
                },
                data_recebimento: {
                    required: true,
                    type: 'string',
                    validate: (val) => {
                        if (!val) return false;
                        const date = new Date(val);
                        return !isNaN(date.getTime());
                    },
                    message: 'Data de recebimento é obrigatória e deve ser válida'
                },
                origem: {
                    required: true,
                    type: 'string',
                    validate: (val) => val && val.trim().length > 0,
                    message: 'Origem é obrigatória'
                },
                destino: {
                    required: true,
                    type: 'string',
                    validate: (val) => val && val.trim().length > 0,
                    message: 'Destino é obrigatório'
                },
                data_entrega: {
                    required: true,
                    type: 'string',
                    validate: (val) => {
                        if (!val) return false;
                        const date = new Date(val);
                        return !isNaN(date.getTime());
                    },
                    message: 'Data de entrega é obrigatória e deve ser válida'
                },
                valor: {
                    required: true,
                    type: 'number',
                    validate: (val) => {
                        const num = parseFloat(val);
                        return !isNaN(num) && num > 0;
                    },
                    message: 'Valor CTE é obrigatório e deve ser maior que zero'
                },
                frete_motorista: {
                    required: true,
                    type: 'number',
                    validate: (val) => {
                        const num = parseFloat(val);
                        return !isNaN(num) && num > 0;
                    },
                    message: 'Frete Motorista é obrigatório e deve ser maior que zero'
                },
                km: {
                    required: true,
                    type: 'number',
                    validate: (val) => {
                        const num = parseFloat(val);
                        return !isNaN(num) && num > 0;
                    },
                    message: 'KM é obrigatório e deve ser maior que zero'
                },
                classeVeiculo: {
                    required: true,
                    type: 'string',
                    validate: (val) => ['leve', 'medio', 'pesado'].includes(val),
                    message: 'Classe do veículo é obrigatória (leve, médio ou pesado)'
                },
                tiposVeiculo: {
                    required: true,
                    type: 'array',
                    validate: (val) => Array.isArray(val) && val.length > 0,
                    message: 'Selecione pelo menos um tipo de veículo'
                },
                tiposCarroceria: {
                    required: true,
                    type: 'array',
                    validate: (val) => Array.isArray(val) && val.length > 0,
                    message: 'Selecione pelo menos um tipo de carroceria'
                }
            };

            /**
             * Valida dados de coleta
             * @param {Object} data - Dados a serem validados
             * @param {Object} schema - Schema de validação (opcional, usa coletaSchema por padrão)
             * @returns {Object} - { valid: boolean, errors: Array }
             */
            static validate(data, schema = this.coletaSchema) {
                const errors = [];

                Object.entries(schema).forEach(([key, rules]) => {
                    const value = data[key];

                    // Verificar obrigatoriedade (incluindo requiredIf dinâmico)
                    let isRequired = rules.required;
                    if (rules.requiredIf && typeof rules.requiredIf === 'function') {
                        isRequired = rules.requiredIf(data);
                    }

                    // Para arrays, verificar se está vazio
                    if (isRequired) {
                        let isEmpty = false;
                        if (Array.isArray(value)) {
                            isEmpty = value.length === 0;
                        } else if (rules.type === 'number') {
                            // Para números obrigatórios, 0 também é considerado vazio
                            const numValue = parseFloat(value);
                            isEmpty = (value === undefined || value === null || value === '' || isNaN(numValue) || numValue === 0);
                        } else {
                            isEmpty = (value === undefined || value === null || value === '');
                        }
                        
                        if (isEmpty) {
                            errors.push({
                                field: key,
                                message: rules.message || `${key} é obrigatório`
                            });
                            return;
                        }
                    }

                    // Se não é obrigatório e está vazio, pular validação
                    if (!isRequired && (value === undefined || value === null || value === '')) {
                        return;
                    }

                    // Verificar tipo
                    if (rules.type) {
                        const actualType = Array.isArray(value) ? 'array' : typeof value;
                        if (actualType !== rules.type) {
                            errors.push({
                                field: key,
                                message: `${key} deve ser do tipo ${rules.type}`
                            });
                            return;
                        }
                    }

                    // Validar com função customizada
                    if (rules.validate && typeof rules.validate === 'function') {
                        if (!rules.validate(value)) {
                            errors.push({
                                field: key,
                                message: rules.message || `${key} é inválido`
                            });
                        }
                    }
                });

                return {
                    valid: errors.length === 0,
                    errors
                };
            }

            /**
             * Valida e mostra erros inline no formulário
             * @param {Object} data - Dados a serem validados
             * @param {string} formId - ID do formulário
             * @returns {boolean} - true se válido
             */
            static validateAndShowErrors(data, formId = 'coletaForm') {
                const validation = this.validate(data);
                
                if (!validation.valid) {
                    // Limpar erros anteriores
                    document.querySelectorAll('.field-error').forEach(el => el.remove());
                    document.querySelectorAll('.field-input-error').forEach(el => {
                        el.classList.remove('field-input-error');
                        el.setAttribute('aria-invalid', 'false');
                        if (typeof AccessibilityManager !== 'undefined') {
                            AccessibilityManager.clearFieldError(el);
                        }
                    });

                    // Mapeamento de campos do schema para IDs/names do formulário
                    const fieldMapping = {
                        'filial': 'filial',
                        'numero_coleta': 'numeroColeta',
                        'cliente': 'cliente',
                        'data_recebimento': 'dataRecebimento',
                        'data_entrega': 'dataEntrega',
                        'origem': 'origem',
                        'destino': 'destino',
                        'valor': 'valor',
                        'frete_motorista': 'freteMotorista',
                        'km': 'km',
                        'classeVeiculo': 'classeVeiculo',
                        'tiposVeiculo': 'tiposVeiculo',
                        'tiposCarroceria': 'tiposCarroceria'
                    };
                    
                    // Mostrar erros
                    validation.errors.forEach(error => {
                        const fieldName = fieldMapping[error.field] || error.field;
                        // Tentar encontrar o campo por name ou id
                        let field = document.querySelector(`[name="${fieldName}"], #${fieldName}`);
                        
                        // Se não encontrou, tentar pelo nome original do schema
                        if (!field) {
                            field = document.querySelector(`[name="${error.field}"], #${error.field}`);
                        }
                        
                        if (field) {
                            field.classList.add('field-input-error');
                            // Usar AccessibilityManager para atualizar ARIA
                            if (typeof AccessibilityManager !== 'undefined') {
                                AccessibilityManager.setFieldError(field, error.message);
                            } else {
                                // Fallback se AccessibilityManager não estiver disponível
                                // Remover erro anterior se existir
                                const existingError = document.getElementById(`${field.id || fieldName}-error`);
                                if (existingError) {
                                    existingError.remove();
                                }
                                
                                const errorDiv = document.createElement('div');
                                errorDiv.id = `${field.id || fieldName}-error`;
                                errorDiv.className = 'field-error';
                                errorDiv.setAttribute('role', 'alert');
                                errorDiv.setAttribute('aria-live', 'polite');
                                errorDiv.style.cssText = 'color: #dc3545; font-size: 0.75rem; margin-top: 0.25rem; font-weight: 600;';
                                errorDiv.textContent = error.message;
                                
                                // Inserir após o campo ou no parent
                                const formGroup = field.closest('.form-group');
                                if (formGroup) {
                                    formGroup.appendChild(errorDiv);
                                } else {
                                    field.parentElement.appendChild(errorDiv);
                                }
                            }
                            field.setAttribute('aria-invalid', 'true');
                        } else {
                            // Se não encontrou o campo, mostrar notificação
                            console.warn(`Campo não encontrado para erro: ${error.field} (tentou: ${fieldName})`);
                        }
                    });

                    // Mostrar notificação geral
                    showNotification(
                        `Por favor, corrija ${validation.errors.length} erro(s) no formulário`,
                        'error'
                    );
                }

                return validation.valid;
            }
        }

        // ========== SISTEMA DE NAVEGAÇÃO POR TECLADO E ACESSIBILIDADE ==========
        /**
         * Gerencia navegação por teclado e acessibilidade
         */
        class AccessibilityManager {
            /**
             * Inicializa eventos de teclado para acessibilidade
             */
            static init() {
                // Fechar modal com ESC
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        const modal = document.querySelector('.modal-overlay.active, .modal-overlay[style*="display: flex"]');
                        if (modal) {
                            const closeBtn = modal.querySelector('.close-modal');
                            if (closeBtn) {
                                closeBtn.click();
                            } else {
                                closeModal();
                            }
                        }
                    }
                });

                // Navegação por teclado em modais (trap focus)
                document.addEventListener('keydown', (e) => {
                    const modal = document.querySelector('.modal-overlay.active, .modal-overlay[style*="display: flex"]');
                    if (!modal) return;

                    if (e.key === 'Tab') {
                        const focusableElements = modal.querySelectorAll(
                            'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
                        );
                        const firstElement = focusableElements[0];
                        const lastElement = focusableElements[focusableElements.length - 1];

                        if (e.shiftKey) {
                            // Shift + Tab
                            if (document.activeElement === firstElement) {
                                e.preventDefault();
                                lastElement.focus();
                            }
                        } else {
                            // Tab
                            if (document.activeElement === lastElement) {
                                e.preventDefault();
                                firstElement.focus();
                            }
                        }
                    }
                });

                // Atualizar aria-invalid nos campos quando há erro
                document.addEventListener('input', (e) => {
                    const field = e.target;
                    if (field.hasAttribute('aria-invalid')) {
                        // Remover erro se o campo foi corrigido
                        if (field.value && !field.classList.contains('field-input-error')) {
                            field.setAttribute('aria-invalid', 'false');
                        }
                    }
                });
            }

            /**
             * Atualiza atributos ARIA de erro em um campo
             * @param {HTMLElement} field - Campo do formulário
             * @param {string} errorMessage - Mensagem de erro
             */
            static setFieldError(field, errorMessage) {
                field.setAttribute('aria-invalid', 'true');
                field.setAttribute('aria-describedby', `${field.id}-error`);
                
                // Criar ou atualizar elemento de erro
                let errorElement = document.getElementById(`${field.id}-error`);
                if (!errorElement) {
                    errorElement = document.createElement('div');
                    errorElement.id = `${field.id}-error`;
                    errorElement.className = 'field-error';
                    errorElement.setAttribute('role', 'alert');
                    errorElement.setAttribute('aria-live', 'polite');
                    field.parentElement.appendChild(errorElement);
                }
                errorElement.textContent = errorMessage;
            }

            /**
             * Remove atributos ARIA de erro de um campo
             * @param {HTMLElement} field - Campo do formulário
             */
            static clearFieldError(field) {
                field.setAttribute('aria-invalid', 'false');
                const errorElement = document.getElementById(`${field.id}-error`);
                if (errorElement) {
                    errorElement.remove();
                }
            }

            /**
             * Anuncia mudança para leitores de tela
             * @param {string} message - Mensagem a ser anunciada
             */
            static announce(message) {
                const announcement = document.createElement('div');
                announcement.setAttribute('role', 'status');
                announcement.setAttribute('aria-live', 'polite');
                announcement.setAttribute('aria-atomic', 'true');
                announcement.className = 'sr-only';
                announcement.textContent = message;
                document.body.appendChild(announcement);
                
                setTimeout(() => {
                    announcement.remove();
                }, 1000);
            }
        }

        // Inicializar acessibilidade quando o DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => AccessibilityManager.init());
        } else {
            AccessibilityManager.init();
        }

        // ========== MAPEAMENTOS INTELIGENTES DE TIPOS DE VEÍCULO E CARROCERIA ==========
        const tiposVeiculo = {
            leve: ['3/4', 'Fiorino', 'Toco', 'VLC'],
            medio: ['Bitruck', 'Truck'],
            pesado: ['Bitrem', 'Carreta', 'Carreta LS', 'Rodotrem', 'Vanderleia']
        };

        const bodyworkByClass = {
            leve: ['bau', 'bau_frigorifico', 'bau_refrigerado', 'cacamba', 'prancha'],
            medio: ['bau', 'bau_frigorifico', 'sider', 'graneleiro', 'plataforma', 'basculante', 'cacamba'],
            pesado: ['bau', 'sider', 'graneleiro', 'grade_baixa', 'apenas_cavalo', 'cegonheiro', 'gaiola', 'tanque', 'porta_container_20', 'porta_container_40', 'basculante', 'cacamba']
        };

        const tiposCarroceriaMap = {
            bau: 'Baú',
            bau_frigorifico: 'Baú Frigorífico',
            bau_refrigerado: 'Baú Refrigerado',
            sider: 'Sider',
            cacamba: 'Caçamba',
            caamba: 'Caçamba', // Variação quando o ç foi removido incorretamente
            graneleiro: 'Graneleiro',
            plataforma: 'Plataforma',
            prancha: 'Prancha',
            apenas_cavalo: 'Apenas Cavalo',
            cegonheiro: 'Cegonheiro',
            gaiola: 'Gaiola',
            tanque: 'Tanque',
            grade_baixa: 'GRADE BAIXA',
            basculante: 'BASCULANTE',
            porta_container_20: 'PORTA CONTAINER 20',
            porta_container_40: 'PORTA CONTAINER 40'
        };

        // ========== FUNÇÕES DE ATUALIZAÇÃO DE TIPOS DE VEÍCULO E CARROCERIA ==========
        function atualizarTiposVeiculoECarroceria() {
            const classe = document.getElementById('classeVeiculo')?.value;
            atualizarTiposVeiculo(classe);
            atualizarTiposCarroceria(classe);
        }
        // Tornar função acessível globalmente
        window.atualizarTiposVeiculoECarroceria = atualizarTiposVeiculoECarroceria;

        function atualizarTiposVeiculo(classe) {
            const container = document.getElementById('tiposVeiculoContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!classe || !tiposVeiculo[classe]) {
                container.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #6c757d; margin: 0;">Selecione primeiro a classe do veículo</p>';
                return;
            }
            
            tiposVeiculo[classe].forEach(tipo => {
                const label = document.createElement('label');
                label.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: normal;';
                
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.name = 'tiposVeiculo';
                input.value = tipo;
                input.className = 'checkbox-veiculo';
                
                const span = document.createElement('span');
                span.textContent = tipo;
                
                label.appendChild(input);
                label.appendChild(span);
                container.appendChild(label);
            });
        }

        function atualizarTiposCarroceria(classe) {
            const container = document.getElementById('tiposCarroceriaContainer');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (!classe || !bodyworkByClass[classe]) {
                container.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: #6c757d; margin: 0;">Selecione primeiro a classe do veículo</p>';
                return;
            }
            
            // Tipos de veículo que NÃO devem aparecer como carroceria
            const tiposVeiculoExcluidos = ['rodotrem', 'Rodotrem', 'RODOTREM', 'bitrem', 'Bitrem', 'BITREM', 'carreta', 'Carreta', 'CARRETA', 'carreta_ls', 'Carreta LS', 'Carreta_LS', 'vanderleia', 'Vanderleia', 'VANDERLEIA'];
            
            bodyworkByClass[classe].forEach(tipo => {
                // Garantir que rodotrem nunca apareça como carroceria
                if (tiposVeiculoExcluidos.includes(tipo)) {
                    return; // Pular rodotrem
                }
                
                if (tiposCarroceriaMap[tipo]) {
                    const label = document.createElement('label');
                    label.style.cssText = 'display: flex; align-items: center; gap: 0.5rem; cursor: pointer; font-weight: normal;';
                    
                    const input = document.createElement('input');
                    input.type = 'checkbox';
                    input.name = 'tiposCarroceria';
                    input.value = tipo;
                    input.className = 'checkbox-carroceria';
                    
                    const span = document.createElement('span');
                    span.textContent = tiposCarroceriaMap[tipo];
                    
                    label.appendChild(input);
                    label.appendChild(span);
                    container.appendChild(label);
                }
            });
        }

        // ========== FUNÇÕES HELPER - FORMATADORES ==========
        const formatters = {
            data: (data) => {
                if (!data) return '';
                try {
                    return new Date(data).toLocaleDateString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                } catch (e) {
                    return data;
                }
            },
            dataHora: (data) => {
                if (!data) return '';
                try {
                    return new Date(data).toLocaleString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return data;
                }
            },
            moeda: (valor) => {
                if (valor === null || valor === undefined || valor === '') return 'R$ 0,00';
                return `R$ ${parseFloat(valor || 0).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`;
            },
            telefone: (tel) => {
                if (!tel) return '';
                const numeros = tel.replace(/\D/g, '');
                if (numeros.length === 11) {
                    return numeros.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
                } else if (numeros.length === 10) {
                    return numeros.replace(/(\d{2})(\d{4})(\d{4})/, '($1) $2-$3');
                }
                return tel;
            },
            numero: (num) => {
                if (num === null || num === undefined || num === '') return '';
                return parseFloat(num || 0).toLocaleString('pt-BR');
            }
        };

        // ========== FUNÇÃO HELPER - DEBOUNCE ==========
        // Função clearDateFilters já está definida acima (no início do script)
        
        // Função setQuickDate também deve ser global
        function setQuickDate(periodo) {
            const hoje = new Date();
            let dataInicio, dataFim;

            switch(periodo) {
                case 'hoje':
                    dataInicio = new Date(hoje);
                    dataFim = new Date(hoje);
                    break;
                case 'semana':
                    dataInicio = new Date(hoje.getTime() - 6 * 24 * 60 * 60 * 1000);
                    dataFim = new Date(hoje);
                    break;
                case 'mes':
                    dataInicio = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                    dataFim = new Date(hoje);
                    break;
                case 'trimestre':
                    const trimestreAtual = Math.floor(hoje.getMonth() / 3);
                    dataInicio = new Date(hoje.getFullYear(), trimestreAtual * 3, 1);
                    dataFim = new Date(hoje);
                    break;
            }

            // Verificar se formatarDataParaInput existe
            const dataInicioEl = document.getElementById('dataInicio');
            const dataFimEl = document.getElementById('dataFim');
            
            if (dataInicioEl && dataFimEl) {
            if (typeof formatarDataParaInput === 'function') {
                    dataInicioEl.value = formatarDataParaInput(dataInicio);
                    dataFimEl.value = formatarDataParaInput(dataFim);
            } else {
                // Fallback se formatarDataParaInput não existir
                const formatar = (date) => {
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    return `${year}-${month}-${day}`;
                };
                    dataInicioEl.value = formatar(dataInicio);
                    dataFimEl.value = formatar(dataFim);
                }
            }
            
            // Ativar botão visualmente
            document.querySelectorAll('.quick-date-btn').forEach(btn => btn.classList.remove('active'));
            const activeBtn = event?.target || document.querySelector(`[onclick*="setQuickDate('${periodo}')"]`);
            if (activeBtn) activeBtn.classList.add('active');
            
            // Aplicar filtro se existir
            if (typeof filterColetas === 'function') {
                filterColetas();
            }
        }
        
        // Tornar função acessível globalmente
        window.setQuickDate = setQuickDate;
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // ========== FUNÇÃO HELPER - TRATAMENTO DE ERROS ==========
        // Função mantida para compatibilidade - agora usa ErrorHandler
        async function handleError(error, context) {
            return ErrorHandler.handle(error, context);
        }
        
        // Função antiga (mantida para referência)
        async function handleErrorOld(error, context) {
            console.error(`❌ Erro em ${context}:`, error);
            
            // Log detalhado em desenvolvimento
            if (window.DEBUG || window.location.hostname === 'localhost') {
                console.error('Detalhes do erro:', {
                    message: error.message,
                    code: error.code,
                    details: error.details,
                    hint: error.hint
                });
            }
            
            // Mensagem amigável para o usuário
            let mensagem = 'Ocorreu um erro. Tente novamente.';
            if (error.message) {
                mensagem = error.message;
            } else if (error.code === 'PGRST301') {
                mensagem = 'Erro ao acessar o banco de dados. Verifique sua conexão.';
            } else if (error.code === '42501') {
                mensagem = 'Você não tem permissão para realizar esta ação.';
            } else if (error.code === '23505') {
                mensagem = 'Já existe um registro com essas informações.';
            }
            
            showNotification(mensagem, 'error');
            
            // Retornar para monitoramento futuro (Sentry, etc.)
            if (window.errorReporter) {
                window.errorReporter.captureException(error, { context });
            }
        }

        // ========== FUNÇÃO HELPER - LOADING SKELETONS ==========
        function criarSkeletonCard() {
            return `
                <div class="coleta-card skeleton-card">
                    <div class="skeleton-line skeleton-title"></div>
                    <div class="skeleton-line skeleton-subtitle"></div>
                    <div class="skeleton-line skeleton-text"></div>
                    <div class="skeleton-line skeleton-text" style="width: 60%;"></div>
                </div>
            `;
        }

        function mostrarSkeletons(containerId, quantidade = 6) {
            const container = document.getElementById(containerId);
            if (container) {
                container.innerHTML = Array(quantidade).fill(0).map(() => criarSkeletonCard()).join('');
            }
        }

        // ========== FUNÇÃO HELPER - CRIAÇÃO DE MODAIS REUTILIZÁVEIS ==========
        function criarModal({ titulo, conteudo, acoes, id, tamanho = 'medio', fecharAoClickFora = true }) {
            const modalId = id || `modal-${Date.now()}`;
            const tamanhoClass = {
                pequeno: 'modal-sm',
                medio: '',
                grande: 'modal-lg',
                extraGrande: 'modal-xl'
            }[tamanho] || '';

            const modal = document.createElement('div');
            modal.className = `modal-overlay ${modalId}`;
            modal.id = modalId;
            modal.innerHTML = `
                <div class="modal ${tamanhoClass}" style="max-width: ${tamanho === 'pequeno' ? '400px' : tamanho === 'grande' ? '800px' : tamanho === 'extraGrande' ? '1200px' : '600px'};">
                    <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1.5rem; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
                        <h3 style="margin: 0; font-size: 1.3rem; font-weight: 600;">${titulo}</h3>
                        <button class="close-modal" onclick="fecharModalHelper('${modalId}')" style="background: rgba(255,255,255,0.2); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: all 0.3s;">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body" style="padding: 1.5rem; max-height: 70vh; overflow-y: auto;">
                        ${conteudo}
                    </div>
                    ${acoes ? `
                    <div class="modal-footer" style="padding: 1rem 1.5rem; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 0.5rem; border-radius: 0 0 12px 12px;">
                        ${acoes}
                    </div>
                    ` : ''}
                </div>
            `;

            // Fechar ao clicar fora do modal
            if (fecharAoClickFora) {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        fecharModalHelper(modalId);
                    }
                });
            }

            document.body.appendChild(modal);
            setTimeout(() => modal.classList.add('active'), 10);
            
            return modalId;
        }

        function fecharModalHelper(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
                setTimeout(() => {
                    modal.remove();
                }, 300);
            }
        }

        // ========== FUNÇÃO HELPER - CONFIRMAÇÃO PARA AÇÕES DESTRUTIVAS ==========
        async function confirmarAcaoDestrutiva({ titulo, mensagem, detalhes, textoConfirmar = 'Confirmar', textoCancelar = 'Cancelar', corConfirmar = '#dc3545' }) {
            return new Promise((resolve) => {
                const modalId = criarModal({
                    titulo: `⚠️ ${titulo}`,
                    tamanho: 'pequeno',
                    conteudo: `
                        <div style="text-align: center;">
                            <div style="font-size: 3rem; color: #dc3545; margin-bottom: 1rem;">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <p style="font-size: 1.1rem; margin-bottom: 1rem; color: #333;">${mensagem}</p>
                            ${detalhes ? `
                            <div style="background: #fff3cd; padding: 1rem; border-radius: 8px; margin: 1rem 0; text-align: left; border-left: 4px solid #ffc107;">
                                <strong style="color: #856404;">Detalhes:</strong>
                                <div style="margin-top: 0.5rem; color: #856404;">${detalhes}</div>
                            </div>
                            ` : ''}
                            <p style="color: #dc3545; font-weight: 600; margin-top: 1.5rem; padding: 1rem; background: #f8d7da; border-radius: 8px;">
                                <i class="fas fa-info-circle"></i> Esta ação não pode ser desfeita.
                            </p>
                        </div>
                    `,
                    acoes: `
                        <button class="btn btn-secondary" onclick="cancelarAcaoDestrutiva('${modalId}')" style="padding: 0.6rem 1.5rem; border-radius: 8px; border: 1px solid #6c757d; background: white; color: #6c757d; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                            <i class="fas fa-times"></i> ${textoCancelar}
                        </button>
                        <button class="btn btn-danger" onclick="executarAcaoDestrutiva('${modalId}')" style="padding: 0.6rem 1.5rem; border-radius: 8px; border: none; background: ${corConfirmar}; color: white; cursor: pointer; font-weight: 600; transition: all 0.3s; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);">
                            <i class="fas fa-check"></i> ${textoConfirmar}
                        </button>
                    `
                });

                // Armazenar resolve na variável global temporária
                window._acaoDestrutivaResolve = resolve;
                window._acaoDestrutivaModalId = modalId;
            });
        }

        function cancelarAcaoDestrutiva(modalId) {
            if (window._acaoDestrutivaResolve) {
                window._acaoDestrutivaResolve(false);
                window._acaoDestrutivaResolve = null;
            }
            fecharModalHelper(modalId);
        }

        function executarAcaoDestrutiva(modalId) {
            if (window._acaoDestrutivaResolve) {
                window._acaoDestrutivaResolve(true);
                window._acaoDestrutivaResolve = null;
            }
            fecharModalHelper(modalId);
        }

        // Etapas do processo - MODELO ÚNICO KANBAN (FIXO)
        // Etapas fixas do kanban único conforme solicitado
        const ETAPAS = [
            { id: 'programacao', nome: 'Programação', ordem: 1 },
            { id: 'pendencias', nome: 'Pendências', ordem: 2 },
            { id: 'contratacao', nome: 'Contratação', ordem: 3 },
            { id: 'gr', nome: 'GR', ordem: 4 },
            { id: 'documentacao', nome: 'Documentação', ordem: 5 },
            { id: 'inicio_monitoramento', nome: 'Inicio de monitoramento', ordem: 6 },
            { id: 'pagamento', nome: 'Pagamento', ordem: 7 },
            { id: 'em_viagem', nome: 'Em viagem', ordem: 8 },
            { id: 'price', nome: 'Price', ordem: 9 },
            { id: 'controladoria', nome: 'Controladoria', ordem: 10 },
            { id: 'ti', nome: 'TI', ordem: 11 },
            { id: 'finalizar_operacao', nome: 'Finalizar operação', ordem: 12 }
        ];

        // ========== FUNIL GERAL - Apenas para usuários com permissão de settings ==========
        /**
         * Verifica se o usuário tem permissão de settings/configuracoes
         * @returns {Promise<boolean>}
         */
        async function verificarPermissaoSettings() {
            try {
                // Verificar se é admin
                const userData = JSON.parse(localStorage.getItem('loggedInUser') || '{}');
                const isAdmin = (userData.isAdmin === true) || (userData.role === 'admin');
                
                if (isAdmin) {
                    console.log('✅ Usuário é ADMIN, permissão de settings concedida');
                    return true;
                }

                // Verificar permissão específica de settings
                if (typeof verificarPermissaoPagina === 'function') {
                    const temPermissao = await verificarPermissaoPagina('settings');
                    console.log('🔐 Permissão de settings:', temPermissao);
                    return temPermissao;
                }

                return false;
            } catch (error) {
                console.error('❌ Erro ao verificar permissão de settings:', error);
                return false;
            }
        }

        /**
         * Calcula estatísticas de uma etapa específica
         * @param {string} etapaId - ID da etapa
         * @param {Array} coletas - Array de coletas
         * @returns {Object} Estatísticas da etapa
         */
        function calcularEstatisticasEtapa(etapaId, coletas) {
            const coletasNaEtapa = coletas.filter(c => c.etapa_atual === etapaId);
            const quantidade = coletasNaEtapa.length;
            const valorTotal = coletasNaEtapa.reduce((sum, c) => {
                const valor = parseFloat(c.valor || c.valor_total || 0);
                return sum + valor;
            }, 0);

            // Calcular tempo médio na etapa
            let tempoMedio = 0;
            if (coletasNaEtapa.length > 0) {
                const tempos = coletasNaEtapa
                    .filter(c => c.data_entrada_etapa)
                    .map(c => {
                        const entrada = new Date(c.data_entrada_etapa);
                        const agora = new Date();
                        return (agora - entrada) / (1000 * 60); // minutos
                    });
                
                if (tempos.length > 0) {
                    tempoMedio = tempos.reduce((sum, t) => sum + t, 0) / tempos.length;
                }
            }

            return {
                quantidade,
                valorTotal,
                tempoMedio: Math.round(tempoMedio)
            };
        }

        /**
         * Formata tempo em minutos para string legível
         * @param {number} minutos - Tempo em minutos
         * @returns {string} Tempo formatado
         */
        function formatarTempo(minutos) {
            if (minutos < 60) {
                return `${Math.round(minutos)}min`;
            } else if (minutos < 1440) {
                const horas = Math.floor(minutos / 60);
                const mins = Math.round(minutos % 60);
                return `${horas}h ${mins}min`;
            } else {
                const dias = Math.floor(minutos / 1440);
                const horas = Math.floor((minutos % 1440) / 60);
                return `${dias}d ${horas}h`;
            }
        }

        /**
         * Renderiza o funil geral com todas as etapas
         * Nota: A verificação de permissão já foi feita na função verificarPermissaoPaginaKanban
         */
        async function renderizarFunilGeral() {
            const container = document.getElementById('funilGeralContainer');
            const wrapper = document.getElementById('funilEtapasWrapper');
            
            if (!container || !wrapper) {
                console.warn('⚠️ Elementos do funil geral não encontrados');
                return;
            }

            // Mostrar container (permissão já verificada na aba)
            container.classList.add('visible');

            // Função auxiliar para formatar moeda (caso formatters não esteja acessível)
            const formatarMoeda = (valor) => {
                if (valor === null || valor === undefined || valor === '') return 'R$ 0,00';
                return `R$ ${parseFloat(valor || 0).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`;
            };

            // Calcular estatísticas gerais
            const totalColetas = coletasData.length;
            const valorTotalGeral = coletasData.reduce((sum, c) => {
                const valor = parseFloat(c.valor || c.valor_total || 0);
                return sum + valor;
            }, 0);

            // Atualizar estatísticas gerais
            const totalColetasEl = document.getElementById('funilTotalColetas');
            const totalValorEl = document.getElementById('funilTotalValor');
            if (totalColetasEl) totalColetasEl.textContent = totalColetas;
            if (totalValorEl) totalValorEl.textContent = formatarMoeda(valorTotalGeral);

            // Renderizar etapas (ordenadas por ordem)
            const etapasOrdenadas = [...ETAPAS].sort((a, b) => a.ordem - b.ordem);
            wrapper.innerHTML = etapasOrdenadas.map(etapa => {
                const stats = calcularEstatisticasEtapa(etapa.id, coletasData);
                
                return `
                    <div class="funil-etapa-item">
                        <div class="funil-etapa-ordem">${etapa.ordem}</div>
                        <div class="funil-etapa-info">
                            <div class="funil-etapa-nome">${etapa.nome}</div>
                            <div class="funil-etapa-detalhes">
                                <div class="funil-etapa-detalhe">
                                    <i class="fas fa-box"></i>
                                    <span><strong>${stats.quantidade}</strong> coletas</span>
                                </div>
                                <div class="funil-etapa-detalhe">
                                    <i class="fas fa-dollar-sign"></i>
                                    <span><strong>${formatarMoeda(stats.valorTotal)}</strong> total</span>
                                </div>
                                ${stats.tempoMedio > 0 ? `
                                <div class="funil-etapa-detalhe">
                                    <i class="fas fa-clock"></i>
                                    <span><strong>${formatarTempo(stats.tempoMedio)}</strong> tempo médio</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <span class="funil-etapa-badge quantidade">${stats.quantidade}</span>
                            <span class="funil-etapa-badge valor">${formatarMoeda(stats.valorTotal)}</span>
                            ${stats.tempoMedio > 0 ? `<span class="funil-etapa-badge tempo-medio">${formatarTempo(stats.tempoMedio)}</span>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Definição de páginas e suas etapas
        // IMPORTANTE: As permissões são baseadas em MENUS do sistema (RBAC)
        // O acesso às áreas do kanban é controlado pelas permissões de menu correspondentes
        const PAGINAS_KANBAN = {
            comercial: {
                nome: 'Comercial',
                etapas: [], // Será preenchido com funis dinâmicos do banco
                icone: 'fa-handshake',
                permissaoMenu: 'comercial' // Permissão do MENU Comercial (RBAC)
            },
            administrativo: {
                nome: 'Administrativo',
                etapas: [], // Será preenchido com funis dinâmicos do banco
                icone: 'fa-briefcase',
                permissaoMenu: 'cadastro' // Permissão do MENU Administrativo/Gestão (RBAC)
            },
            financeiro: {
                nome: 'Pagamento',
                etapas: [], // Será preenchido com funis dinâmicos do banco
                icone: 'fa-dollar-sign',
                permissaoMenu: 'contas-pagar' // Permissão do MENU Financeiro (RBAC)
            },
            operacao: {
                nome: 'Operação',
                etapas: [], // Será preenchido com funis dinâmicos do banco
                icone: 'fa-cogs',
                permissaoMenu: 'coletas', // Permissão do MENU Operações/Coletas (RBAC)
                temSubPaginas: false, // Será definido dinamicamente se houver múltiplos funis
                subPaginas: undefined // Será preenchido com funis dinâmicos do banco
            },
            funil_geral: {
                nome: 'Funil Geral',
                etapas: [], // Será preenchido dinamicamente com todas as etapas do banco
                icone: 'fa-filter',
                permissaoMenu: 'configuracoes', // Permissão de Settings/Configurações
                isFunilGeral: true // Flag especial para identificar que é o funil geral
            }
        };

        // Página ativa (será definida baseado nas permissões)
        let paginaAtivaKanban = null;
        let subPaginaAtivaKanban = null; // Sub-página ativa (para páginas com sub-opções)
        
        // Funis carregados dinamicamente do banco
        let funisDinamicos = {};
        let etapasDinamicas = [];
        
        /**
         * Verifica se o usuário tem permissão para visualizar uma página do kanban
         * Baseado em permissões de MENU E ÁREA (RBAC - Role Based Access Control)
         * @param {string} paginaId - ID da página (comercial, administrativo, financeiro, operacao)
         * @returns {Promise<boolean>} - true se tem permissão, false caso contrário
         */
        async function verificarPermissaoPaginaKanban(paginaId) {
            try {
                const pagina = PAGINAS_KANBAN[paginaId];
                if (!pagina) {
                    console.error('Página não encontrada:', paginaId);
                    return false;
                }

                // Buscar permissões do usuário
                const loggedInUserData = localStorage.getItem('loggedInUser');
                if (!loggedInUserData) {
                    console.log('❌ Nenhum usuário logado');
                    return false;
                }

                const userData = JSON.parse(loggedInUserData);
                
                // Se for ADMIN, permite acesso a tudo
                const isAdmin = (userData.isAdmin === true) || (userData.role === 'admin');
                if (isAdmin) {
                    console.log('✅ Usuário é ADMIN, permissão concedida para:', paginaId);
                    return true;
                }

                // ✅ RBAC: Verificar permissão do MENU correspondente
                if (typeof verificarPermissaoPagina === 'function') {
                    const temPermissaoMenu = await verificarPermissaoPagina(pagina.permissaoMenu);
                    if (!temPermissaoMenu) {
                        console.log(`❌ Verificação RBAC: Menu '${pagina.permissaoMenu}' NEGADO para área '${paginaId}'`);
                        return false;
                    }
                }

                // Para o Funil Geral, apenas verificar a permissão de configuracoes (não precisa de permissão de área)
                if (pagina.isFunilGeral) {
                    console.log(`🔐 Verificação RBAC: Funil Geral - permissão '${pagina.permissaoMenu}': PERMITIDO`);
                    return true;
                }

                // ✅ RBAC: Verificar permissão específica da ÁREA do kanban (apenas para páginas normais)
                const permissaoArea = `kanban_${paginaId}`;
                if (typeof verificarPermissaoPagina === 'function') {
                    const temPermissaoArea = await verificarPermissaoPagina(permissaoArea);
                    console.log(`🔐 Verificação RBAC: Menu '${pagina.permissaoMenu}' + Área '${permissaoArea}' para '${paginaId}': ${temPermissaoArea ? 'PERMITIDO' : 'NEGADO'}`);
                    return temPermissaoArea; // Precisa ter AMBAS as permissões
                }

                // Fallback: se a função não estiver disponível, negar acesso por segurança
                console.warn('⚠️ Função verificarPermissaoPagina não disponível, negando acesso');
                return false;
            } catch (error) {
                console.error('❌ Erro ao verificar permissão da página:', error);
                return false; // Por segurança, nega acesso em caso de erro
            }
        }

        /**
         * Obtém todas as páginas do kanban que o usuário tem permissão para visualizar
         * Baseado em permissões de MENU (RBAC)
         * ✅ MODELO ÚNICO: Simplificado - apenas verifica permissão 'coletas'
         * @returns {Promise<Array>} - Array com IDs das páginas permitidas
         */
        async function obterPaginasPermitidas() {
            try {
                // ✅ MODELO ÚNICO: Se o usuário tem permissão 'coletas', permitir acesso
                if (typeof verificarPermissaoPagina === 'function') {
                    const temPermissaoColetas = await verificarPermissaoPagina('coletas');
                    if (temPermissaoColetas) {
                        console.log('✅ Usuário tem permissão coletas - retornando acesso ao kanban único');
                        // Retornar array com um item fictício para indicar que tem acesso
                        return ['operacao']; // Retorna 'operacao' como página permitida (mesmo que não use mais)
                    }
                }

                const loggedInUserData = localStorage.getItem('loggedInUser');
                if (!loggedInUserData) {
                    return [];
                }

                const userData = JSON.parse(loggedInUserData);
                
                // Se for ADMIN, permite acesso
                const isAdmin = (userData.isAdmin === true) || (userData.role === 'admin');
                if (isAdmin) {
                    console.log('✅ ADMIN: Acesso total ao kanban');
                    return ['operacao'];
                }

                // Fallback: se a função não estiver disponível, retornar array vazio
                console.warn('⚠️ Função verificarPermissaoPagina não disponível');
                return [];
            } catch (error) {
                console.error('❌ Erro ao obter páginas permitidas:', error);
                return [];
            }
        }

        /**
         * Valida se o usuário tem acesso a pelo menos uma área do kanban de coletas
         * Se não tiver acesso, mostra mensagem de acesso negado e esconde o conteúdo
         * @returns {Promise<boolean>} - true se tem acesso, false caso contrário
         */
        async function validarAcessoColetas() {
            try {
                // ✅ MODELO ÚNICO: Verificar apenas se o usuário tem permissão 'coletas'
                // Não precisa verificar áreas específicas do kanban
                if (typeof verificarPermissaoPagina === 'function') {
                    const temPermissaoColetas = await verificarPermissaoPagina('coletas');
                    if (temPermissaoColetas) {
                        console.log('✅ Usuário tem permissão coletas - acesso concedido ao kanban único');
                        return true;
                    } else {
                        console.log('❌ Usuário não tem permissão coletas');
                    }
                } else {
                    // Se a função não estiver disponível, permitir acesso (fallback)
                    console.warn('⚠️ Função verificarPermissaoPagina não disponível - permitindo acesso');
                    return true;
                }
                
                // Verificar se o usuário tem acesso a pelo menos uma página do kanban (código antigo - mantido para compatibilidade)
                const paginasPermitidas = await obterPaginasPermitidas();
                
                if (paginasPermitidas.length === 0) {
                    // Usuário não tem acesso a nenhuma área do kanban
                    console.log('❌ Usuário não tem acesso a nenhuma área do kanban de coletas');
                    
                    // Substituir o conteúdo da página por mensagem de acesso negado
                    const mainContent = document.querySelector('main') || document.body;
                    mainContent.innerHTML = `
                        <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 80vh; padding: 2rem; text-align: center;">
                            <div style="max-width: 600px; background: white; padding: 3rem; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.1);">
                                <div style="font-size: 4rem; color: #dc3545; margin-bottom: 1.5rem;">
                                    <i class="fas fa-lock"></i>
                                </div>
                                <h1 style="color: #333; margin-bottom: 1rem; font-size: 1.8rem;">Acesso Negado</h1>
                                <p style="color: #666; margin-bottom: 2rem; line-height: 1.6;">
                                    Você não tem permissão para acessar o sistema de coletas.
                                </p>
                                <p style="color: #999; font-size: 0.9rem; margin-bottom: 2rem;">
                                    Entre em contato com o administrador do sistema para solicitar as permissões necessárias.
                                </p>
                                <a href="/index.html" style="display: inline-block; padding: 0.75rem 2rem; background: var(--primary-color, #667eea); color: white; text-decoration: none; border-radius: 8px; transition: all 0.3s;">
                                    <i class="fas fa-arrow-left"></i> Voltar ao Início
                                </a>
                            </div>
                        </div>
                    `;
                    
                    return false;
                }
                
                // Usuário tem acesso a pelo menos uma área
                console.log(`✅ Usuário tem acesso a ${paginasPermitidas.length} área(s) do kanban:`, paginasPermitidas);
                return true;
                
            } catch (error) {
                console.error('❌ Erro ao validar acesso às coletas:', error);
                // Em caso de erro, por segurança, negar acesso
                return false;
            }
        }

        /**
         * Toggle do menu lateral de funis
         */
        function toggleFunisSidebar() {
            const sidebar = document.getElementById('funisSidebar');
            const overlay = document.getElementById('funisSidebarOverlay');
            
            if (sidebar && overlay) {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
                
                // Se está abrindo, carregar funis se ainda não foram carregados
                if (sidebar.classList.contains('open')) {
                    carregarFunisNoSidebar();
                }
            }
        }

        // ========== MENU LATERAL DE MÓDULOS ==========
        
        /**
         * Toggle do menu lateral de módulos (desktop)
         */
        function toggleModulesSidebar() {
            const sidebar = document.getElementById('modulesSidebar');
            const wrapper = document.getElementById('mainContentWrapper');
            const toggleFloat = document.getElementById('modulesSidebarToggleFloat');
            
            if (sidebar && wrapper) {
                sidebar.classList.toggle('collapsed');
                wrapper.classList.toggle('with-sidebar');
                
                // Atualizar visibilidade do botão flutuante
                if (toggleFloat) {
                    if (sidebar.classList.contains('collapsed')) {
                        toggleFloat.classList.add('visible');
                    } else {
                        toggleFloat.classList.remove('visible');
                    }
                }
                
                // Salvar estado no localStorage
                const isCollapsed = sidebar.classList.contains('collapsed');
                localStorage.setItem('modulesSidebarCollapsed', isCollapsed);
            }
        }

        /**
         * Toggle do menu lateral de módulos (mobile)
         */
        function toggleModulesSidebarMobile() {
            const sidebar = document.getElementById('modulesSidebar');
            const overlay = document.getElementById('modulesSidebarOverlay');
            
            if (sidebar && overlay) {
                sidebar.classList.toggle('mobile-open');
                overlay.classList.toggle('active');
            }
        }

        /**
         * Fechar menu lateral em mobile
         */
        function closeModulesSidebarMobile() {
            const sidebar = document.getElementById('modulesSidebar');
            const overlay = document.getElementById('modulesSidebarOverlay');
            
            if (sidebar && overlay) {
                sidebar.classList.remove('mobile-open');
                overlay.classList.remove('active');
            }
        }

        /**
         * Carregar e renderizar módulos no menu lateral
         */
        async function carregarModulosNoSidebar() {
            const sidebarContent = document.getElementById('modulesSidebarContent');
            if (!sidebarContent) {
                console.warn('⚠️ Elemento modulesSidebarContent não encontrado');
                return;
            }

            try {
                console.log('🔄 Carregando módulos no sidebar...');
                
                let html = '';
                const modulosDisponiveis = [];

                // ✅ FERRAMENTAS FIXAS DO MENU LATERAL
                const ferramentasFixas = [
                    { id: 'chat_interno', nome: 'Chat Interno', icone: 'comments', url: 'chat-interno.html' },
                    { id: 'chamados', nome: 'Chamados', icone: 'ticket-alt', url: 'chamados.html' },
                    { id: 'relatorios_coletas', nome: 'Relatórios de Coletas', icone: 'chart-bar', url: 'relatorios.html' },
                    { id: 'treinamentos', nome: 'Treinamentos', icone: 'graduation-cap', url: 'treinamentos.html' },
                    { id: 'rastreamento', nome: 'Rastreamento', icone: 'map-marked-alt', url: 'monitoramento-rastreamento.html' }
                ];

                // Adicionar ferramentas fixas diretamente
                for (const ferramenta of ferramentasFixas) {
                    modulosDisponiveis.push({
                        id: ferramenta.id,
                        nome: ferramenta.nome,
                        icone: ferramenta.icone,
                        url: ferramenta.url,
                        isFerramenta: true
                    });
                }

                console.log('✅ Ferramentas fixas adicionadas:', modulosDisponiveis.length);

                // ✅ MODELO ÚNICO: Não carregar módulos de PAGINAS_KANBAN para evitar travamentos
                // As ferramentas fixas são suficientes

                // Renderizar cada módulo/ferramenta
                for (const modulo of modulosDisponiveis) {
                    const isActive = paginaAtivaKanban === modulo.id;
                    const hasSubPages = modulo.temSubPaginas && modulo.subPaginas;
                    const isExpanded = isActive && hasSubPages;
                    const isFerramenta = modulo.isFerramenta || false;

                    // Contar sub-páginas
                    let subPagesCount = 0;
                    if (hasSubPages) {
                        subPagesCount = Object.keys(modulo.subPaginas).length;
                    }

                    // Se for ferramenta, usar link direto
                    const onClickAction = isFerramenta 
                        ? `window.location.href='${modulo.url}'`
                        : (hasSubPages ? `toggleModuleSubpages('${modulo.id}')` : `selecionarModulo('${modulo.id}')`);

                    html += `
                        <div class="module-item ${isActive ? 'active' : ''} ${isExpanded ? 'expanded' : ''}" 
                             data-module-id="${modulo.id}">
                            <div class="module-item-header" 
                                 onclick="${onClickAction}">
                                <div class="module-icon">
                                    <i class="fas fa-${modulo.icone || 'cog'}"></i>
                                </div>
                                <div class="module-info">
                                    <div class="module-name">${modulo.nome}</div>
                                    ${subPagesCount > 0 ? `
                                        <span class="module-badge">
                                            <i class="fas fa-layer-group"></i>
                                            ${subPagesCount} sub-página${subPagesCount !== 1 ? 's' : ''}
                                        </span>
                                    ` : ''}
                                </div>
                                ${hasSubPages ? `
                                    <i class="fas fa-chevron-right module-expand-icon"></i>
                                ` : isFerramenta ? `
                                    <i class="fas fa-external-link-alt" style="font-size: 0.75rem; opacity: 0.6;"></i>
                                ` : ''}
                            </div>
                            ${hasSubPages ? `
                                <div class="module-subpages">
                                    ${Object.entries(modulo.subPaginas).map(([subId, subPagina]) => {
                                        const isSubActive = paginaAtivaKanban === modulo.id && subPaginaAtivaKanban === subId;
                                        return `
                                            <div class="subpage-item ${isSubActive ? 'active' : ''}" 
                                                 onclick="selecionarModulo('${modulo.id}', '${subId}')">
                                                <i class="fas fa-${subPagina.icone || 'circle'} subpage-icon"></i>
                                                <span class="subpage-name">${subPagina.nome}</span>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }

                if (modulosDisponiveis.length === 0) {
                    html = `
                        <div style="padding: 2rem; text-align: center; color: rgba(255,255,255,0.5);">
                            <i class="fas fa-lock" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>Nenhum módulo disponível</p>
                            <p style="font-size: 0.85rem; margin-top: 0.5rem;">Você não tem permissão para acessar nenhum módulo</p>
                        </div>
                    `;
                }

                sidebarContent.innerHTML = html;
                console.log('✅ Sidebar atualizado com', modulosDisponiveis.length, 'itens');

                // Restaurar estado colapsado do sidebar (desktop)
                const isCollapsed = localStorage.getItem('modulesSidebarCollapsed') === 'true';
                const sidebar = document.getElementById('modulesSidebar');
                const wrapper = document.getElementById('mainContentWrapper');
                const toggleFloat = document.getElementById('modulesSidebarToggleFloat');
                if (sidebar && wrapper) {
                    if (isCollapsed) {
                        sidebar.classList.add('collapsed');
                        wrapper.classList.remove('with-sidebar');
                        if (toggleFloat) {
                            toggleFloat.classList.add('visible');
                        }
                    } else {
                        sidebar.classList.remove('collapsed');
                        wrapper.classList.add('with-sidebar');
                        if (toggleFloat) {
                            toggleFloat.classList.remove('visible');
                        }
                    }
                }

            } catch (error) {
                console.error('❌ Erro ao carregar módulos no sidebar:', error);
                sidebarContent.innerHTML = `
                    <div style="padding: 2rem; text-align: center; color: rgba(255,255,255,0.5);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Erro ao carregar módulos</p>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem;">${error.message || 'Erro desconhecido'}</p>
                    </div>
                `;
            }
        }

        /**
         * Expandir/colapsar sub-páginas de um módulo
         */
        function toggleModuleSubpages(moduloId) {
            const moduleItem = document.querySelector(`.module-item[data-module-id="${moduloId}"]`);
            if (!moduleItem) return;

            moduleItem.classList.toggle('expanded');
        }

        /**
         * Selecionar um módulo (e opcionalmente uma sub-página)
         */
        async function selecionarModulo(moduloId, subPaginaId = null) {
            console.log('🎯 Selecionando módulo:', moduloId, 'Sub-página:', subPaginaId);

            // Fechar menu em mobile após seleção
            closeModulesSidebarMobile();

            // Atualizar página e sub-página ativas
            paginaAtivaKanban = moduloId;
            subPaginaAtivaKanban = subPaginaId;

            // Atualizar visual do menu
            atualizarMenuLateralAtivo();

            // Se tem sub-página, usar a função existente
            if (subPaginaId) {
                await trocarSubPaginaKanban(moduloId, subPaginaId);
            } else {
                // Selecionar módulo sem sub-páginas
                await trocarPaginaKanban(moduloId);
            }

            // Expandir o módulo selecionado se tiver sub-páginas
            const moduleItem = document.querySelector(`.module-item[data-module-id="${moduloId}"]`);
            if (moduleItem && PAGINAS_KANBAN[moduloId]?.temSubPaginas) {
                moduleItem.classList.add('expanded');
            }
        }

        // Função trocarPaginaKanban está definida mais abaixo (linha ~9993) com validação completa

        /**
         * Atualizar visual do menu lateral (marcar item ativo)
         */
        function atualizarMenuLateralAtivo() {
            // Remover active de todos os módulos
            document.querySelectorAll('.module-item').forEach(item => {
                item.classList.remove('active');
            });

            // Adicionar active ao módulo atual
            if (paginaAtivaKanban) {
                const moduleItem = document.querySelector(`.module-item[data-module-id="${paginaAtivaKanban}"]`);
                if (moduleItem) {
                    moduleItem.classList.add('active');
                }
            }

            // Remover active de todas as sub-páginas
            document.querySelectorAll('.subpage-item').forEach(item => {
                item.classList.remove('active');
            });

            // Adicionar active à sub-página atual
            if (paginaAtivaKanban && subPaginaAtivaKanban) {
                const subpageItem = document.querySelector(`.subpage-item[onclick*="'${paginaAtivaKanban}', '${subPaginaAtivaKanban}'"]`);
                if (subpageItem) {
                    subpageItem.classList.add('active');
                }
            }
        }
        
        /**
         * Carrega e exibe os funis no menu lateral
         */
        async function carregarFunisNoSidebar() {
            const sidebarContent = document.getElementById('funisSidebarContent');
            if (!sidebarContent) return;
            
            try {
                sidebarContent.innerHTML = `
                    <div class="funis-loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Carregando funis...</span>
                    </div>
                `;
                
                const response = await fetch('/api/coletas/funis-kanban?pagina_id=operacao');
                const data = await response.json();
                
                if (data.success && data.funis && data.funis.length > 0) {
                    let html = '';
                    
                    data.funis.forEach(funil => {
                        const etapasCount = funil.etapas ? funil.etapas.length : 0;
                        const etapasHtml = funil.etapas ? funil.etapas.slice(0, 3).map(e => 
                            `<span class="funil-etapa-badge">${e.nome}</span>`
                        ).join('') : '';
                        const maisEtapas = etapasCount > 3 ? `<span class="funil-etapa-badge">+${etapasCount - 3}</span>` : '';
                        
                        // Criar ID da sub-página baseado no nome
                        const subPaginaId = funil.nome.toLowerCase()
                            .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
                            .replace(/\s+/g, '_')
                            .replace(/[^a-z0-9_]/g, '');
                        
                        const isActive = paginaAtivaKanban === 'operacao' && subPaginaAtivaKanban === subPaginaId;
                        
                        html += `
                            <div class="funil-item-sidebar ${isActive ? 'active' : ''}" 
                                 onclick="selecionarFunil('operacao', '${subPaginaId}', this)">
                                <div class="funil-item-sidebar-header">
                                    <div class="funil-item-sidebar-icon">
                                        <i class="fas ${funil.icone || 'fa-cogs'}"></i>
                                    </div>
                                    <div class="funil-item-sidebar-title">${funil.nome}</div>
                                </div>
                                <div class="funil-item-sidebar-info">
                                    ${etapasCount} etapa${etapasCount !== 1 ? 's' : ''}
                                </div>
                                ${etapasCount > 0 ? `
                                    <div class="funil-item-sidebar-etapas">
                                        ${etapasHtml}${maisEtapas}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    });
                    
                    sidebarContent.innerHTML = html;
                } else {
                    sidebarContent.innerHTML = `
                        <div class="funis-empty-state">
                            <i class="fas fa-inbox"></i>
                            <p>Nenhum funil encontrado</p>
                            <p style="font-size: 0.85rem; margin-top: 0.5rem;">Crie funis através do painel de administração</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Erro ao carregar funis no sidebar:', error);
                sidebarContent.innerHTML = `
                    <div class="funis-empty-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Erro ao carregar funis</p>
                        <p style="font-size: 0.85rem; margin-top: 0.5rem;">${error.message}</p>
                    </div>
                `;
            }
        }
        
        /**
         * Seleciona um funil e atualiza o kanban
         */
        async function selecionarFunil(paginaId, subPaginaId, element = null) {
            console.log('🎯 Selecionando funil:', paginaId, subPaginaId);
            
            // Atualizar página e sub-página ativas
            paginaAtivaKanban = paginaId;
            subPaginaAtivaKanban = subPaginaId;
            
            // Atualizar estado visual no sidebar
            document.querySelectorAll('.funil-item-sidebar').forEach(item => {
                item.classList.remove('active');
            });
            
            // Se o elemento foi passado, marcar como ativo
            if (element) {
                const selectedItem = typeof element === 'string' 
                    ? document.querySelector(element)
                    : element.closest ? element.closest('.funil-item-sidebar') : element;
                if (selectedItem) {
                    selectedItem.classList.add('active');
                }
            } else {
                // Tentar encontrar pelo subPaginaId
                const allItems = document.querySelectorAll('.funil-item-sidebar');
                allItems.forEach(item => {
                    if (item.onclick && item.onclick.toString().includes(subPaginaId)) {
                        item.classList.add('active');
                    }
                });
            }
            
            // Fechar o sidebar
            toggleFunisSidebar();
            
            // Atualizar o kanban
            await trocarSubPaginaKanban(paginaId, subPaginaId);
        }
        
        /**
         * Carrega funis e etapas dinamicamente do banco de dados
         * NOTA: Desabilitado - usando etapas fixas do kanban único
         */
        async function carregarFunisDinamicos() {
            // ✅ MODELO ÚNICO KANBAN: ETAPAS são fixas, não carregamos do banco
            console.log('✅ Usando etapas fixas do kanban único:', ETAPAS.length, 'etapas');
        }

        /**
         * Carrega e renderiza as abas do kanban baseado nas permissões do usuário
         */
        async function carregarAbasKanban() {
            // ✅ Carregar menu lateral de módulos PRIMEIRO (independente de outras funções)
            // Isso garante que as ferramentas apareçam mesmo se outras funções travarem
            try {
                await carregarModulosNoSidebar();
            } catch (error) {
                console.error('❌ Erro ao carregar módulos no sidebar (continuando mesmo assim):', error);
            }
            
            // Carregar funis dinâmicos primeiro (se ainda não foram carregados)
            try {
            if (Object.keys(funisDinamicos).length === 0) {
                await carregarFunisDinamicos();
                }
            } catch (error) {
                console.error('❌ Erro ao carregar funis dinâmicos (continuando mesmo assim):', error);
            }

            // Obter páginas permitidas
            const paginasPermitidas = await obterPaginasPermitidas();

            if (paginasPermitidas.length === 0) {
                // Se não tiver nenhuma permissão, ocultar o kanban
                const kanbanContainer = document.getElementById('kanbanContainer');
                if (kanbanContainer) {
                    kanbanContainer.style.display = 'none';
                }
                return;
            }

            // Se não há página ativa ou a página ativa não está permitida, definir a primeira permitida
            if (!paginaAtivaKanban || !paginasPermitidas.includes(paginaAtivaKanban)) {
                paginaAtivaKanban = paginasPermitidas[0];
                // Se a página tem sub-páginas, inicializar a primeira sub-página
                const primeiraPagina = PAGINAS_KANBAN[paginaAtivaKanban];
                if (primeiraPagina && primeiraPagina.temSubPaginas && primeiraPagina.subPaginas) {
                    const primeiraSubPagina = Object.keys(primeiraPagina.subPaginas)[0];
                    subPaginaAtivaKanban = primeiraSubPagina;
                } else {
                    subPaginaAtivaKanban = null;
                }
            }

            // Garantir que se a página ativa tem sub-páginas, uma sub-página esteja selecionada antes de renderizar
            const paginaAtiva = PAGINAS_KANBAN[paginaAtivaKanban];
            if (paginaAtiva && paginaAtiva.temSubPaginas && paginaAtiva.subPaginas) {
                if (!subPaginaAtivaKanban || !paginaAtiva.subPaginas[subPaginaAtivaKanban]) {
                    const primeiraSubPagina = Object.keys(paginaAtiva.subPaginas)[0];
                    subPaginaAtivaKanban = primeiraSubPagina;
                }
            }
            
            // Atualizar menu lateral para mostrar o módulo ativo
            atualizarMenuLateralAtivo();
            
            // Re-renderizar o kanban com a página ativa
            renderColetasKanban();
        }

        // Mapeamento de tipos de carroceria já declarado acima (linha 3413)

        // Função para obter nome amigável da carroceria
        function obterNomeCarroceria(chave) {
            return tiposCarroceriaMap[chave] || chave;
        }

        function obterNomeEtapa(etapaId) {
            return ETAPAS.find(e => e.id === etapaId)?.nome || etapaId;
        }

        // Mapa cliente -> { origens[], destinos[], registros[] } para popular origem/destino após seleção (sem duplicar clientes)
        let mapaClienteOrigemDestino = {};

        // ========== MAPEAMENTO DE CLIENTES POR FILIAL ==========
        const clientesPorFilial = {
            'JBO': [
                'VIVIX / OWENS - JAZIDA',
                'VIVIX / NACIONAL - AREAL',
                'VIVIX / OWENS - FELDSPATO',
                'VIVIX / OWENS - AREAL',
                'VIVIX / MURO ALTO - AREIA',
                'VIVIX / TENNIS PACK',
                'VIVIX / PRAINHA ZN',
                'VIVIX / POLIPISO',
                'VIVIX NAVIO',
                'CONTINENTAL NAVIO',
                'OWENS - BARRILHA (PARATIBE)',
                'OWENS - GARRAFAS MG',
                'OWENS - IMPORTAÇÃO',
                'OWENS-PE / CENTROAIDAR-GO',
                'OWENS - MOV. INTERNA',
                'OWENS - TESTE CALCÁRIO',
                'OWENS - TESTE FELDSPATO',
                'VIVIX / MANUCHAR',
                'OWENS / ACQUA EMBALAGENS BH',
                'NAVIO VIVIX',
                'POLIPISO',
                'HNK MALTE PACATUBA CE',
                'HNK GARRAFAS - BENEVIDES PA',
                'HNK MALTE - CABEDELO PB',
                'HNK MALTE - CAXIAS',
                'HNK GARRAFAS - RECIFE / IGARASSU',
                'HNK CARRAFAS - IGARASSU PE',
                'HNK GARRAFAS - ALAGOINHAS BA',
                'YARA BIG BAGS',
                'MOHAWKBR - PB x BA',
                'GRUPO MOURA',
                'COLSUGAR',
                'NAVIO SOLVAY / VIVIX',
                'NAVIO MV K BEREKET / VIVIX',
                'NAVIO MV K BEREKET / CONTINENTAL-PB',
                'GERDAU'
            ],
            'US': [
                'NAVIO - USINA OLHO D\'AGUA',
                'NAVIO SINDAÇÚCAR',
                'USINA MIRIRI',
                'USINA GIASA-PB x SINDAÇÚCAR-PE',
                'USINA SÃO JOSÉ X MARILAN',
                'USINA IPOJUCA x BONGI',
                'USINA IPOJUCA x PETROLINA',
                'USINA IPOJUCA X CABO',
                'USINA IPOJUCA x M.DIAS BRANCO',
                'USINA PETRIBU VHP',
                'USINA UNIÃO',
                'NAVIO BARRILHA OWENS',
                'NAVIO BARRILHA CONTINENTAL',
                'NAVIO JB (ST THERESA)',
                'HNK GARRAFAS RECIFE',
                'HNK RETORNO ATG',
                'ENERGIZER IMPORTAÇÃO',
                'BEEVA_USINAS'
            ],
            'AMBEV': [
                'AMBEV AÇÚCAR',
                'AMBEV GARRAFAS OWENS',
                'AMBEV GARRAFAS JACUTINGA',
                'AMBEV PREFORMA',
                'AMBEV MALTE',
                'NAVIO AMBEV MALTE (PARATIBE)',
                'AMBEV ATG',
                'NAVIO AMBEV'
            ],
            'BA': [
                'HNK GARRAFAS',
                'IVN X HNK ALAGOINHAS',
                'INOVA PISOS CNTR',
                'HNK X IVN RETORNO',
                'NATIVILLE INSUMOS',
                'MERCOSUL SSA',
                'AMBEV CDR - BA / PE',
                'AMBEV - JACAREÍ SP',
                'COSTA BRASIL CNTR',
                'MAERSK SAFRA',
                'INDAIÁ',
                'JMACÊDO - SSA',
                'JMACÊDO - SIF',
                'ENGEPACK'
            ],
            'SE': [
                'HNK GARRAFAS',
                'IVN X HNK ALAGOINHAS',
                'INOVA PISOS CNTR',
                'HNK X IVN RETORNO',
                'NATIVILLE INSUMOS',
                'MERCOSUL SSA',
                'AMBEV CDR - BA / PE',
                'AMBEV - JACAREÍ SP',
                'COSTA BRASIL CNTR',
                'MAERSK SAFRA',
                'INDAIÁ',
                'JMACÊDO - SSA',
                'JMACÊDO - SIF',
                'ENGEPACK'
            ],
            'CE': [
                'HNK GARRAFAS',
                'IVN X HNK ALAGOINHAS',
                'INOVA PISOS CNTR',
                'HNK X IVN RETORNO',
                'NATIVILLE INSUMOS',
                'MERCOSUL SSA',
                'AMBEV CDR - BA / PE',
                'AMBEV - JACAREÍ SP',
                'COSTA BRASIL CNTR',
                'MAERSK SAFRA',
                'INDAIÁ',
                'JMACÊDO - SSA',
                'JMACÊDO - SIF',
                'ENGEPACK'
            ],
            'PARATIBE': [
                'ADESBRA'
            ],
            'AL': [
                'SERRA GRANDE-AL x MDB SALVADOR-BA',
                'USINA CORURIPE',
                'NATVILLE',
                'USINA CAETÉ - SALVADOR',
                'USINA CAETÉ - MARACANAÚ',
                'BEEVA',
                'NAVIO SERRA GRANDE',
                'NAVIO YARA  MCZ',
                'YARA TRANSF. - PORTO ALEGRE',
                'YARA OUTBOUND'
            ],
            'SP': [
                'AMBEV GARRAFAS - VIRALLIA-MG / JACAREÍ-SP',
                'AMBEV AÇÚCAR  "SP"'
            ],
            'CABO': [
                'ENERGIZER EXPORTAÇÃO',
                'ENERGIZER IMPORTAÇÃO "CABO"',
                'ALIANÇA CNTR',
                'CBMC',
                'UNIVAR SOLUTIONS',
                'COSTA BRASIL',
                'IQUINE',
                'USINA SERRA GRANDE',
                'NATURALLY',
                'CIMENTO NACIONAL',
                'GUARAVES',
                'ACTION',
                'INOVA PISOS',
                'MERCOSUL SUA',
                'GERDAU CNTR',
                'GRUPO JB',
                'NORCOAST'
            ]
        };

        // Função para filtrar clientes baseado na filial selecionada
        async function filtrarClientesPorFilial() {
            const filialSelect = document.getElementById('filial');
            const clienteSelect = document.getElementById('cliente');
            const origemSelect = document.getElementById('origem');
            const destinoSelect = document.getElementById('destino');
            const filialSelecionada = filialSelect.value;

            // Limpar opções atuais
            clienteSelect.innerHTML = '';
            origemSelect.innerHTML = '<option value="">Selecione primeiro o cliente</option>';
            destinoSelect.innerHTML = '<option value="">Selecione primeiro o cliente</option>';
            const tipoProdutoSelect = document.getElementById('tipoProduto');
            const codigoTabelaInput = document.getElementById('codigoTabela');
            if (tipoProdutoSelect) {
                tipoProdutoSelect.innerHTML = '<option value="">Selecione primeiro o cliente</option>';
                tipoProdutoSelect.disabled = true;
            }
            if (codigoTabelaInput) {
                codigoTabelaInput.value = '';
            }
            origemSelect.disabled = true;
            destinoSelect.disabled = true;

            if (!filialSelecionada) {
                clienteSelect.innerHTML = '<option value="">Selecione primeiro a filial</option>';
                clienteSelect.disabled = true;
                return;
            }

            // Habilitar o select de clientes
            clienteSelect.disabled = false;
            clienteSelect.innerHTML = '<option value="">Carregando clientes...</option>';

            try {
                // Buscar clientes da filial selecionada
                const response = await fetch(`/api/clientes/filial/${filialSelecionada}`);
                const data = await response.json();
                
                if (data.success && data.clientes) {
                    // Agrupar por razao_social para evitar duplicados e montar mapa origem/destino por cliente
                    const agrupado = {};
                    data.clientes.forEach(cliente => {
                        const razaoSocial = (cliente.razao_social || cliente.nome || '').trim();
                        if (!razaoSocial) return;
                        if (!agrupado[razaoSocial]) {
                            agrupado[razaoSocial] = { origens: new Set(), destinos: new Set(), registros: [] };
                        }
                        const g = agrupado[razaoSocial];
                        g.registros.push(cliente);
                        const co = (cliente.cidade_origem || '').trim();
                        const uo = (cliente.uf_origem || '').trim();
                        if (co || uo) {
                            g.origens.add(co && uo ? `${co} - ${uo}` : (co || uo));
                        }
                        const cd = (cliente.cidade_destino || '').trim();
                        const ud = (cliente.uf_destino || '').trim();
                        if (cd || ud) {
                            g.destinos.add(cd && ud ? `${cd} - ${ud}` : (cd || ud));
                        }
                    });
                    mapaClienteOrigemDestino = {};
                    Object.keys(agrupado).sort().forEach(razaoSocial => {
                        const g = agrupado[razaoSocial];
                        mapaClienteOrigemDestino[razaoSocial] = {
                            origens: Array.from(g.origens).sort(),
                            destinos: Array.from(g.destinos).sort(),
                            registros: g.registros
                        };
                    });
                    // Limpar e adicionar opção padrão
                    clienteSelect.innerHTML = '<option value="">Selecione o cliente</option>';
                    // Uma option por cliente único (sem duplicar por origem/destino)
                    Object.keys(mapaClienteOrigemDestino).forEach(razaoSocial => {
                        const option = document.createElement('option');
                        option.value = razaoSocial;
                        option.textContent = razaoSocial;
                        const primeiro = mapaClienteOrigemDestino[razaoSocial].registros[0];
                        if (primeiro) option.dataset.clienteId = primeiro.id;
                        clienteSelect.appendChild(option);
                    });
                } else {
                    clienteSelect.innerHTML = '<option value="">Nenhum cliente encontrado</option>';
                }
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
                clienteSelect.innerHTML = '<option value="">Erro ao carregar clientes</option>';
            }
        }

        // Função para preencher origem, destino, tipo de produto e código da tabela quando cliente for selecionado
        // Usa mapaClienteOrigemDestino: ao selecionar 1 cliente, mostra todas as opções de origem e destino daquele cliente
        function preencherOrigemDestino() {
            const clienteSelect = document.getElementById('cliente');
            const origemSelect = document.getElementById('origem');
            const destinoSelect = document.getElementById('destino');
            const tipoProdutoSelect = document.getElementById('tipoProduto');
            const codigoTabelaInput = document.getElementById('codigoTabela');
            const razaoSocial = (clienteSelect.value || '').trim();

            // Limpar selects e campos
            origemSelect.innerHTML = '<option value="">Selecione a origem</option>';
            destinoSelect.innerHTML = '<option value="">Selecione o destino</option>';
            tipoProdutoSelect.innerHTML = '<option value="">Selecione o tipo de produto</option>';
            if (codigoTabelaInput) {
                codigoTabelaInput.value = '';
            }

            if (!razaoSocial) {
                origemSelect.disabled = true;
                destinoSelect.disabled = true;
                tipoProdutoSelect.disabled = true;
                if (codigoTabelaInput) codigoTabelaInput.value = '';
                return;
            }

            const dados = mapaClienteOrigemDestino[razaoSocial];
            if (!dados) {
                origemSelect.disabled = true;
                destinoSelect.disabled = true;
                tipoProdutoSelect.disabled = true;
                origemSelect.innerHTML = '<option value="">Origem não cadastrada</option>';
                destinoSelect.innerHTML = '<option value="">Destino não cadastrado</option>';
                tipoProdutoSelect.innerHTML = '<option value="">Nenhum tipo de produto cadastrado</option>';
                return;
            }

            origemSelect.disabled = false;
            destinoSelect.disabled = false;
            tipoProdutoSelect.disabled = false;

            // Preencher origem com todas as opções do cliente
            (dados.origens || []).forEach(val => {
                const opt = document.createElement('option');
                opt.value = val;
                opt.textContent = val;
                origemSelect.appendChild(opt);
            });
            if (dados.origens.length === 0) {
                origemSelect.innerHTML = '<option value="">Origem não cadastrada</option>';
            }

            // Preencher destino com todas as opções do cliente
            (dados.destinos || []).forEach(val => {
                const opt = document.createElement('option');
                opt.value = val;
                opt.textContent = val;
                destinoSelect.appendChild(opt);
            });
            if (dados.destinos.length === 0) {
                destinoSelect.innerHTML = '<option value="">Destino não cadastrado</option>';
            }

            // Tipo de produto: tipos únicos dos registros deste cliente
            const tiposSet = new Set();
            (dados.registros || []).forEach(r => {
                const t = (r.tipo_produto || r.tipoProduto || '').trim();
                if (t) tiposSet.add(t);
            });
            const tiposOrdenados = Array.from(tiposSet).sort();
            tiposOrdenados.forEach(tipo => {
                const option = document.createElement('option');
                option.value = tipo;
                option.textContent = tipo;
                tipoProdutoSelect.appendChild(option);
            });
            if (tiposOrdenados.length === 0) {
                tipoProdutoSelect.innerHTML = '<option value="">Nenhum tipo de produto cadastrado</option>';
            }

            atualizarCodigoTabela();
        }

        // Função para atualizar código da tabela baseado em Cliente + Tipo de Produto (usa mapa de registros por cliente)
        function atualizarCodigoTabela() {
            const clienteSelect = document.getElementById('cliente');
            const tipoProdutoSelect = document.getElementById('tipoProduto');
            const codigoTabelaInput = document.getElementById('codigoTabela');
            if (!codigoTabelaInput) return;

            const razaoSocial = (clienteSelect.value || '').trim();
            const tipoProdutoSelecionado = (tipoProdutoSelect.value || '').trim();
            codigoTabelaInput.placeholder = 'Será preenchido automaticamente';
            codigoTabelaInput.title = '';

            if (!razaoSocial || !tipoProdutoSelecionado) {
                codigoTabelaInput.value = '';
                return;
            }

            const dados = mapaClienteOrigemDestino[razaoSocial];
            if (!dados || !dados.registros || !dados.registros.length) {
                codigoTabelaInput.value = '';
                return;
            }

            const codigosDoTipo = new Set();
            dados.registros.forEach(r => {
                const t = (r.tipo_produto || r.tipoProduto || '').trim();
                const c = (r.codigo_tabela || r.codigoTabela || '').trim();
                if (t === tipoProdutoSelecionado && c) codigosDoTipo.add(c);
            });

            if (codigosDoTipo.size === 1) {
                codigoTabelaInput.value = Array.from(codigosDoTipo)[0];
            } else if (codigosDoTipo.size > 1) {
                codigoTabelaInput.value = '';
                codigoTabelaInput.placeholder = `Múltiplos códigos: ${Array.from(codigosDoTipo).join(', ')}`;
                codigoTabelaInput.title = `Este tipo de produto tem ${codigosDoTipo.size} códigos de tabela diferentes para este cliente.`;
            } else {
                codigoTabelaInput.value = '';
                codigoTabelaInput.placeholder = 'Código não encontrado para esta combinação';
            }
        }

        // Tornar funções acessíveis globalmente
        window.filtrarClientesPorFilial = filtrarClientesPorFilial;
        window.preencherOrigemDestino = preencherOrigemDestino;
        window.atualizarCodigoTabela = atualizarCodigoTabela;

        // ========== SISTEMA DE CRIAÇÃO EM LOTE ==========
        let modoCriacaoLote = false; // false = única, true = múltiplas

        // Função para alternar entre modo único e múltiplo
        function alternarModoCriacao() {
            modoCriacaoLote = !modoCriacaoLote;
            const grupoNumero = document.getElementById('grupoNumeroColeta');
            const grupoMultiplos = document.getElementById('grupoMultiplosNumeros');
            const inputNumero = document.getElementById('numeroColeta');
            const textareaMultiplos = document.getElementById('multiplosNumeros');
            const modoTexto = document.getElementById('modoTexto');
            const previewNumeros = document.getElementById('previewNumeros');

            if (modoCriacaoLote) {
                // Modo múltiplas coletas
                grupoNumero.style.display = 'none';
                grupoMultiplos.style.display = 'block';
                inputNumero.removeAttribute('required');
                textareaMultiplos.setAttribute('required', 'required');
                modoTexto.innerHTML = '<i class="fas fa-layer-group"></i> Criar Uma';
                previewNumeros.style.display = 'none';
                textareaMultiplos.value = '';
            } else {
                // Modo única coleta
                grupoNumero.style.display = 'block';
                grupoMultiplos.style.display = 'none';
                inputNumero.setAttribute('required', 'required');
                textareaMultiplos.removeAttribute('required');
                modoTexto.innerHTML = '<i class="fas fa-layer-group"></i> Criar Múltiplas';
                previewNumeros.style.display = 'none';
                textareaMultiplos.value = '';
            }
        }

        // Função para processar múltiplos números e mostrar preview
        function processarMultiplosNumeros() {
            const textarea = document.getElementById('multiplosNumeros');
            const preview = document.getElementById('previewNumeros');
            const totalSpan = document.getElementById('totalColetas');
            const listaSpan = document.getElementById('listaNumeros');
            const valor = textarea.value.trim();

            if (!valor) {
                preview.style.display = 'none';
                return;
            }

            const numeros = parsearMultiplosNumeros(valor);
            
            if (numeros.length === 0) {
                preview.style.display = 'none';
                return;
            }

            totalSpan.textContent = numeros.length;
            listaSpan.innerHTML = numeros.slice(0, 10).map(n => `<span style="display: inline-block; background: #667eea; color: white; padding: 0.2rem 0.5rem; margin: 0.2rem; border-radius: 4px; font-size: 0.75rem;">${n}</span>`).join('');
            
            if (numeros.length > 10) {
                listaSpan.innerHTML += `<span style="display: block; margin-top: 0.3rem; color: #6c757d;">... e mais ${numeros.length - 10} coleta(s)</span>`;
            }

            preview.style.display = 'block';
        }

        // Função para parsear múltiplos números (suporta vírgula e intervalos)
        function parsearMultiplosNumeros(input) {
            const numeros = new Set();
            const partes = input.split(/[,\n]/).map(p => p.trim()).filter(p => p);

            partes.forEach(parte => {
                // Verificar se é um intervalo (ex: 5565-5569)
                if (parte.includes('-')) {
                    const [inicio, fim] = parte.split('-').map(n => parseInt(n.trim(), 10));
                    if (!isNaN(inicio) && !isNaN(fim) && inicio > 0 && fim > 0) {
                        const menor = Math.min(inicio, fim);
                        const maior = Math.max(inicio, fim);
                        for (let i = menor; i <= maior; i++) {
                            numeros.add(String(i));
                        }
                    }
                } else {
                    // Número único
                    const num = parte.replace(/[^0-9]/g, '');
                    if (num && parseInt(num, 10) > 0) {
                        numeros.add(String(parseInt(num, 10)));
                    }
                }
            });

            // Converter para array e ordenar
            return Array.from(numeros).sort((a, b) => parseInt(a, 10) - parseInt(b, 10));
        }

        // Função para criar múltiplas coletas
        async function criarMultiplasColetas(rawData, numerosColetas) {
            console.log('🚀 Iniciando criação de múltiplas coletas:', { 
                quantidade: numerosColetas.length, 
                numeros: numerosColetas,
                filial: rawData.filial,
                cliente: rawData.cliente
            });
            
            if (!supabaseClient) {
                console.error('❌ Supabase não inicializado');
                showNotification('Erro: Supabase não inicializado', 'error');
                return;
            }

            if (!numerosColetas || numerosColetas.length === 0) {
                console.error('❌ Nenhum número de coleta fornecido');
                showNotification('⚠️ Nenhum número de coleta válido fornecido', 'warning');
                return;
            }

            showNotification(`🔄 Criando ${numerosColetas.length} coleta(s)...`, 'info');
            
            // Converter datas
            let dataRecebimento = rawData.dataRecebimento;
            if (dataRecebimento && dataRecebimento.length === 10) {
                dataRecebimento = dataRecebimento + 'T12:00:00.000Z';
            }
            
            let dataEntrega = rawData.dataEntrega;
            if (dataEntrega && dataEntrega.length === 10) {
                dataEntrega = dataEntrega + 'T12:00:00.000Z';
            }
            
            // Coletar tipos de veículo e carroceria
            const tiposVeiculoSelecionados = Array.from(document.querySelectorAll('input[name="tiposVeiculo"]:checked'))
                .map(checkbox => checkbox.value);
            
            const tiposCarroceriaSelecionados = Array.from(document.querySelectorAll('input[name="tiposCarroceria"]:checked'))
                .map(checkbox => checkbox.value);
            
            // Buscar usuário atual
            const loggedInUserData = localStorage.getItem('loggedInUser');
            const userData = loggedInUserData ? JSON.parse(loggedInUserData) : null;
            
            // Verificar se é diária
            const isDiaria = document.getElementById('diaria')?.checked || false;
            
            // ✅ Prioridade: sempre "normal" na criação para usuários comuns
            // Apenas admin/coordenador pode escolher outra prioridade na criação
            const isAdminOrManager = currentUser && (currentUser.isAdmin || currentUser.role === 'admin' || currentUser.role === 'manager');
            const prioridadeFinal = isAdminOrManager ? (rawData.prioridade || 'normal') : 'normal';
            
            // Preparar dados base para todas as coletas
            const dadosBase = {
                filial: rawData.filial,
                cliente: rawData.cliente,
                data_recebimento: dataRecebimento,
                data_entrega: dataEntrega || null,
                origem: rawData.origem,
                destino: rawData.destino,
                tipo_produto: rawData.tipoProduto || null,
                codigo_tabela: rawData.codigoTabela || null,
                valor: parseFloat(rawData.valor) || 0,
                frete_motorista: parseFloat(rawData.freteMotorista) || 0,
                km: parseFloat(rawData.km) || 0,
                tipos_veiculo: tiposVeiculoSelecionados,
                tipos_carroceria: tiposCarroceriaSelecionados,
                status: rawData.status || 'pendente',
                etapa_atual: rawData.etapaAtual || 'comercial',
                observacoes: rawData.observacoes || null,
                prioridade: prioridadeFinal,
                diaria: isDiaria,
                created_by: userData?.id || null,
                updated_by: userData?.id || null,
                created_at: new Date().toISOString(),
                updated_at: new Date().toISOString(),
                data_atualizacao: new Date().toISOString()
            };
            
            // Verificar duplicatas antes de criar
            const { data: coletasExistentes } = await supabaseClient
                .from('coletas')
                .select('filial, numero_coleta')
                .eq('filial', rawData.filial)
                .in('numero_coleta', numerosColetas);
            
            const numerosExistentes = new Set((coletasExistentes || []).map(c => c.numero_coleta));
            const numerosParaCriar = numerosColetas.filter(n => !numerosExistentes.has(n));
            const numerosDuplicados = numerosColetas.filter(n => numerosExistentes.has(n));
            
            if (numerosDuplicados.length > 0) {
                showNotification(
                    `⚠️ ${numerosDuplicados.length} número(s) já existem: ${numerosDuplicados.join(', ')}. Serão ignorados.`,
                    'warning',
                    5000
                );
            }
            
            if (numerosParaCriar.length === 0) {
                showNotification('⚠️ Todas as coletas já existem!', 'warning');
                return;
            }
            
            // Preparar array de coletas para inserção
            const coletasParaInserir = numerosParaCriar.map(numero => ({
                ...dadosBase,
                numero_coleta: numero
            }));
            
            // Inserir todas as coletas de uma vez
            const { data: coletasCriadas, error } = await supabaseClient
                .from('coletas')
                .insert(coletasParaInserir)
                .select();
            
            if (error) {
                console.error('❌ Erro ao criar múltiplas coletas:', error);
                showNotification(`❌ Erro ao criar coletas: ${error.message}`, 'error');
                return;
            }
            
            // Registrar no histórico para cada coleta criada
            if (coletasCriadas && coletasCriadas.length > 0) {
                for (const coleta of coletasCriadas) {
                    try {
                        await salvarNoHistorico(coleta.id, 'coleta_criada', `Nova coleta criada em lote - ${rawData.filial} #${coleta.numero_coleta}`);
                    } catch (histError) {
                        console.warn('⚠️ Erro ao salvar histórico:', histError);
                    }
                }
            }
            
            // Fechar modal e recarregar
            closeModal();
            showNotification(
                `✅ ${coletasCriadas.length} coleta(s) criada(s) com sucesso!${numerosDuplicados.length > 0 ? ` (${numerosDuplicados.length} ignorada(s))` : ''}`,
                'success',
                5000
            );
            
            // Recarregar coletas após um pequeno delay
            setTimeout(() => {
                carregarColetas();
            }, 500);
        }

        // Tornar funções acessíveis globalmente
        window.alternarModoCriacao = alternarModoCriacao;
        window.processarMultiplosNumeros = processarMultiplosNumeros;
        window.parsearMultiplosNumeros = parsearMultiplosNumeros;
        window.criarMultiplasColetas = criarMultiplasColetas;

        // Variável global para permissões de etapas
        let permissoesEtapasColetas = [];

        // Buscar permissões de etapas do usuário logado
        async function carregarPermissoesEtapasColetas() {
            try {
                const loggedInUserData = localStorage.getItem('loggedInUser');
                if (!loggedInUserData) return [];

                const userData = JSON.parse(loggedInUserData);
                // ✅ SEGURANÇA: Não logar emails em produção
                if (window.DEBUG || window.location.hostname === 'localhost') {
                console.log('🔐 Carregando permissões de etapas para:', userData.email);
                }

                const { data, error } = await supabaseClient
                    .from('permissoes_coletas')
                    .select('etapa_id')
                    .eq('usuario_id', userData.id);

                if (error) {
                    console.error('❌ Erro ao buscar permissões:', error);
                    return [];
                }

                const permissoes = (data || []).map(p => p.etapa_id);
                console.log('✅ Permissões de etapas carregadas:', permissoes);
                return permissoes;
            } catch (error) {
                console.error('❌ Erro ao carregar permissões:', error);
                return [];
            }
        }

        async function getSupabaseAuthHeaders() {
            try {
                if (!supabaseClient) {
                    console.warn('⚠️ Supabase não inicializado ao obter headers');
                    // Tentar obter token do localStorage como fallback
                    const userData = localStorage.getItem('loggedInUser');
                    if (userData) {
                        try {
                            const user = JSON.parse(userData);
                            // Se houver token no localStorage, usar
                            if (user.token) {
                                return {
                                    Authorization: `Bearer ${user.token}`
                                };
                            }
                        } catch (e) {
                            console.warn('⚠️ Erro ao parsear userData:', e);
                        }
                    }
                    return {};
                }

                const now = Date.now();
                // Verificar se o token em cache ainda é válido (com margem de 5 minutos)
                if (supabaseAccessToken && supabaseTokenExpiry && supabaseTokenExpiry - now > 300000) {
                    return {
                        Authorization: `Bearer ${supabaseAccessToken}`
                    };
                }

                // Tentar obter a sessão atual
                const { data, error } = await supabaseClient.auth.getSession();

                if (error) {
                    console.error('❌ Erro ao obter sessão do Supabase:', error);
                    
                    // Se o erro indica sessão expirada, limpar cache e tentar refresh
                    if (error.message && (error.message.includes('session') || error.message.includes('expired') || error.message.includes('invalid'))) {
                        console.warn('⚠️ Sessão expirada ou inválida, tentando refresh...');
                        supabaseAccessToken = null;
                        supabaseTokenExpiry = 0;
                        
                        try {
                            const { data: refreshData, error: refreshError } = await supabaseClient.auth.refreshSession();
                            if (!refreshError && refreshData?.session?.access_token) {
                                supabaseAccessToken = refreshData.session.access_token;
                                supabaseTokenExpiry = refreshData.session.expires_at ? refreshData.session.expires_at * 1000 : now + (60 * 60 * 1000);
                                console.log('✅ Sessão atualizada com sucesso via refresh');
                                return {
                                    Authorization: `Bearer ${supabaseAccessToken}`
                                };
                            } else {
                                console.error('❌ Erro ao fazer refresh da sessão:', refreshError);
                                // Tentar fallback com localStorage
                                const userData = localStorage.getItem('loggedInUser');
                                if (userData) {
                                    try {
                                        const user = JSON.parse(userData);
                                        if (user.token) {
                                            return {
                                                Authorization: `Bearer ${user.token}`
                                            };
                                        }
                                    } catch (e) {
                                        console.warn('⚠️ Erro ao parsear userData no fallback:', e);
                                    }
                                }
                            }
                        } catch (refreshErr) {
                            console.error('❌ Erro ao tentar refresh da sessão:', refreshErr);
                        }
                    }
                    
                    // Último fallback: tentar localStorage
                    const userData = localStorage.getItem('loggedInUser');
                    if (userData) {
                        try {
                            const user = JSON.parse(userData);
                            if (user.token) {
                                return {
                                    Authorization: `Bearer ${user.token}`
                                };
                            }
                        } catch (e) {
                            console.warn('⚠️ Erro ao parsear userData no último fallback:', e);
                        }
                    }
                    
                    return {};
                }

                const session = data?.session;
                if (session?.access_token) {
                    supabaseAccessToken = session.access_token;
                    supabaseTokenExpiry = session.expires_at ? session.expires_at * 1000 : now + (60 * 60 * 1000);
                    return {
                        Authorization: `Bearer ${supabaseAccessToken}`
                    };
                }

                // Não há sessão Supabase ativa - isso é normal se a autenticação for via cookie/sessão do servidor
                // Tentar fallback com localStorage (silenciosamente)
                const userData = localStorage.getItem('loggedInUser');
                if (userData) {
                    try {
                        const user = JSON.parse(userData);
                        if (user.token) {
                            return {
                                Authorization: `Bearer ${user.token}`
                            };
                        }
                    } catch (e) {
                        // Erro ao parsear, continuar silenciosamente
                    }
                }
                
                // Retornar objeto vazio - o servidor usará autenticação via cookie/sessão (req.session)
                // Isso não é um erro, apenas significa que não há token Supabase disponível
                return {};
            } catch (error) {
                console.error('❌ Erro ao construir headers de autenticação:', error);
                return {};
            }
        }

        // Verificar se o usuário tem permissão para a etapa
        function temPermissaoEtapa(etapaId) {
            // Todos os usuários têm acesso à etapa finalizar_operacao
            if (etapaId === 'finalizar_operacao') {
                console.log('✅ Etapa finalizar_operacao: acesso liberado para todos');
                return true;
            }

            // Se for admin, tem permissão para tudo
            const loggedInUserData = localStorage.getItem('loggedInUser');
            if (loggedInUserData) {
                const userData = JSON.parse(loggedInUserData);
                if (userData.isAdmin === true || userData.role === 'admin') {
                    // ✅ SEGURANÇA: Logs condicionais apenas em desenvolvimento
                    if (window.DEBUG || window.location.hostname === 'localhost') {
                    console.log('✅ Usuário é admin, permissão concedida para etapa:', etapaId);
                    }
                    return true;
                }
            }

            // Verificar se a etapa está nas permissões
            const temPermissao = permissoesEtapasColetas.includes(etapaId);
            // ✅ SEGURANÇA: Logs condicionais apenas em desenvolvimento
            if (window.DEBUG || window.location.hostname === 'localhost') {
            console.log(`🔍 Verificando permissão para etapa ${etapaId}:`, temPermissao);
            }
            return temPermissao;
        }

        // ========== KANBAN FUNCTIONS ==========
        let visualizacaoAtual = 'kanban'; // 'grid' ou 'kanban' - Kanban é o modo principal
        
        // ✅ ORDENAÇÃO DO KANBAN: Armazenar preferências de ordenação por etapa
        let ordenacaoKanban = {}; // { etapaId: { tipo: 'maior_tempo', campo: 'tempo_acumulado_etapa' } }
        
        // Carregar preferências do localStorage
        try {
            const ordenacaoSalva = localStorage.getItem('ordenacaoKanban');
            if (ordenacaoSalva) {
                ordenacaoKanban = JSON.parse(ordenacaoSalva);
            }
        } catch (error) {
            console.warn('⚠️ Erro ao carregar preferências de ordenação:', error);
        }
        
        // Salvar preferências no localStorage
        function salvarOrdenacaoKanban() {
            try {
                localStorage.setItem('ordenacaoKanban', JSON.stringify(ordenacaoKanban));
            } catch (error) {
                console.warn('⚠️ Erro ao salvar preferências de ordenação:', error);
            }
        }
        
        // Função para ordenar coletas
        function ordenarColetas(coletas, tipoOrdenacao) {
            if (!coletas || coletas.length === 0) return coletas;
            
            const coletasOrdenadas = [...coletas];
            
            switch (tipoOrdenacao) {
                case 'maior_tempo':
                    coletasOrdenadas.sort((a, b) => {
                        const tempoA = a.tempo_acumulado_etapa || 0;
                        const tempoB = b.tempo_acumulado_etapa || 0;
                        return tempoB - tempoA; // Maior primeiro
                    });
                    break;
                case 'menor_tempo':
                    coletasOrdenadas.sort((a, b) => {
                        const tempoA = a.tempo_acumulado_etapa || 0;
                        const tempoB = b.tempo_acumulado_etapa || 0;
                        return tempoA - tempoB; // Menor primeiro
                    });
                    break;
                case 'maior_valor':
                    coletasOrdenadas.sort((a, b) => {
                        const valorA = parseFloat(a.valor) || 0;
                        const valorB = parseFloat(b.valor) || 0;
                        return valorB - valorA; // Maior primeiro
                    });
                    break;
                case 'menor_valor':
                    coletasOrdenadas.sort((a, b) => {
                        const valorA = parseFloat(a.valor) || 0;
                        const valorB = parseFloat(b.valor) || 0;
                        return valorA - valorB; // Menor primeiro
                    });
                    break;
                case 'cliente_asc':
                    coletasOrdenadas.sort((a, b) => {
                        const clienteA = (a.cliente || '').toLowerCase();
                        const clienteB = (b.cliente || '').toLowerCase();
                        return clienteA.localeCompare(clienteB);
                    });
                    break;
                case 'cliente_desc':
                    coletasOrdenadas.sort((a, b) => {
                        const clienteA = (a.cliente || '').toLowerCase();
                        const clienteB = (b.cliente || '').toLowerCase();
                        return clienteB.localeCompare(clienteA);
                    });
                    break;
                case 'data_mais_recente':
                    coletasOrdenadas.sort((a, b) => {
                        const dataA = new Date(a.created_at || 0);
                        const dataB = new Date(b.created_at || 0);
                        return dataB - dataA; // Mais recente primeiro
                    });
                    break;
                case 'data_mais_antiga':
                    coletasOrdenadas.sort((a, b) => {
                        const dataA = new Date(a.created_at || 0);
                        const dataB = new Date(b.created_at || 0);
                        return dataA - dataB; // Mais antiga primeiro
                    });
                    break;
                default:
                    // Sem ordenação (ordem padrão)
                    break;
            }
            
            return coletasOrdenadas;
        }

        async function alternarVisualizacao(tipo) {
            visualizacaoAtual = tipo;
            const gridContainer = document.getElementById('coletasGrid');
            const kanbanContainer = document.getElementById('kanbanContainer');
            const btnGrid = document.getElementById('btnViewGrid');
            const btnKanban = document.getElementById('btnViewKanban');

            if (!gridContainer || !kanbanContainer || !btnGrid || !btnKanban) {
                console.error('❌ Elementos de visualização não encontrados');
                return;
            }

            if (tipo === 'grid') {
                // Mostrar grid (tabela de cards) e ocultar kanban
                gridContainer.style.display = 'grid';
                gridContainer.style.visibility = 'visible';
                kanbanContainer.style.display = 'none';
                gridContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                // Atualizar estilos dos botões
                btnGrid.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                btnGrid.style.color = 'white';
                btnKanban.style.background = 'transparent';
                btnKanban.style.color = '#667eea';
                
                // Re-renderizar grid
                console.log('🔄 Alternando para Grid');
                await renderColetasWrapper();
                // Iniciar atualização de tempo parado
                iniciarAtualizacaoTempoParado();
            } else {
                // Mostrar kanban e ocultar grid
                gridContainer.style.display = 'none';
                kanbanContainer.style.display = 'block';
                
                // Atualizar estilos dos botões
                btnKanban.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                btnKanban.style.color = 'white';
                
                // Iniciar atualização de tempo parado
                iniciarAtualizacaoTempoParado();
                btnGrid.style.background = 'transparent';
                btnGrid.style.color = '#667eea';
                
                // Re-renderizar kanban
                console.log('🔄 Alternando para Kanban');
                await renderColetasKanban();
            }
        }

        async function renderColetasKanban(filteredData = null) {
            const kanbanBoard = document.getElementById('kanbanBoard');
            if (!kanbanBoard) return;

            // ✅ MODELO ÚNICO KANBAN: Sempre mostrar o kanban, sem lógica de páginas/funis
                const funilContainer = document.getElementById('funilGeralContainer');
                const kanbanContainer = document.getElementById('kanbanContainer');
                const kanbanNavigation = document.getElementById('kanbanNavigation');
                const prioridadeFarol = document.getElementById('prioridadeFarol');
                
            // Ocultar funil geral se existir
                if (funilContainer) {
                    funilContainer.style.display = 'none';
                    funilContainer.classList.remove('visible');
                }
                
                // Mostrar o conteúdo do kanban
                if (kanbanBoard) kanbanBoard.style.display = 'flex';
                if (kanbanNavigation) kanbanNavigation.style.display = 'flex';
                if (prioridadeFarol) prioridadeFarol.style.display = 'block';

            let dataToRender = filteredData || window.coletasAtivas || coletasData.filter(c => !c.arquivado);

            // Remover duplicatas
            const coletasUnicas = [];
            const idsVistos = new Set();
            for (const coleta of dataToRender) {
                if (coleta && coleta.id && !idsVistos.has(coleta.id)) {
                    idsVistos.add(coleta.id);
                    coletasUnicas.push(coleta);
                }
            }
            dataToRender = coletasUnicas;

            // ✅ PERFORMANCE: NÃO carregar dados pesados aqui - apenas dados básicos
            // Os dados completos serão carregados sob demanda quando o drawer abrir

            // Agrupar coletas por etapa
            const coletasPorEtapa = {};
            ETAPAS.forEach(etapa => {
                coletasPorEtapa[etapa.id] = dataToRender.filter(c => c.etapa_atual === etapa.id);
            });
            
            // ✅ CORREÇÃO: Coletas sem etapa_atual válida (null, undefined ou valor não existe no ETAPAS)
            const etapasIds = new Set(ETAPAS.map(e => e.id));
            const coletasSemEtapa = dataToRender.filter(c => {
                const etapaAtual = c.etapa_atual;
                return !etapaAtual || !etapasIds.has(etapaAtual);
            });
            
            // Se houver coletas sem etapa válida, adicionar à primeira etapa disponível como fallback
            if (coletasSemEtapa.length > 0 && ETAPAS.length > 0) {
                // ✅ SILENCIOSO: Apenas log em desenvolvimento para não poluir o console
                if (window.DEBUG || window.location.hostname === 'localhost') {
                    console.warn(`⚠️ ${coletasSemEtapa.length} coleta(s) sem etapa_atual válida, adicionando à primeira etapa disponível como fallback:`, coletasSemEtapa.map(c => ({ id: c.id, etapa_atual: c.etapa_atual, cliente: c.cliente })));
                }
                const primeiraEtapa = ETAPAS[0];
                if (primeiraEtapa) {
                    if (!coletasPorEtapa[primeiraEtapa.id]) {
                        coletasPorEtapa[primeiraEtapa.id] = [];
                    }
                    coletasPorEtapa[primeiraEtapa.id].push(...coletasSemEtapa);
                }
            } else if (coletasSemEtapa.length > 0 && ETAPAS.length === 0) {
                console.warn('⚠️ Coletas sem etapa válida, mas nenhuma etapa disponível no sistema. Carregue os funis primeiro.');
            }

            // Função para calcular valor total de coletas
            const calcularValorTotal = (coletas) => {
                return coletas.reduce((total, coleta) => {
                    const valor = parseFloat(coleta.valor) || 0;
                    return total + valor;
                }, 0);
            };

            // Função para formatar valor em moeda brasileira
            const formatarMoeda = (valor) => {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(valor);
            };

            // ✅ MODELO ÚNICO KANBAN: Usar todas as etapas fixas, sem filtrar por página
            // Ordenar etapas por ordem para garantir que apareçam na sequência correta
            const etapasDaPagina = [...ETAPAS].sort((a, b) => a.ordem - b.ordem);
            console.log('✅ [MODELO ÚNICO] Renderizando kanban com todas as etapas fixas:', etapasDaPagina.length, 'etapas');

            // Renderizar colunas de todas as etapas fixas
            kanbanBoard.innerHTML = etapasDaPagina.map(etapa => {
                let coletas = coletasPorEtapa[etapa.id] || [];
                
                // ✅ ORDENAÇÃO: Aplicar ordenação se houver preferência salva
                const ordenacaoEtapa = ordenacaoKanban[etapa.id];
                if (ordenacaoEtapa && ordenacaoEtapa.tipo) {
                    coletas = ordenarColetas(coletas, ordenacaoEtapa.tipo);
                }
                
                const valorTotal = calcularValorTotal(coletas);
                const valorFormatado = formatarMoeda(valorTotal);
                const ordenacaoAtual = ordenacaoKanban[etapa.id]?.tipo || 'padrao';
                
                return `
                    <div class="kanban-column" data-etapa-id="${etapa.id}">
                        <div class="kanban-column-header">
                            <div class="kanban-column-title" style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
                                <div style="display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-layer-group"></i>
                                ${etapa.nome}
                                </div>
                                <div style="position: relative;">
                                    <button class="kanban-sort-btn ${ordenacaoAtual !== 'padrao' ? 'active' : ''}" 
                                            onclick="event.stopPropagation(); toggleSortMenu('${etapa.id}', event)" 
                                            title="Ordenar coletas">
                                        <i class="fas fa-sort"></i>
                                        <i class="fas fa-chevron-down" style="font-size: 0.65rem;"></i>
                                    </button>
                                    <div class="kanban-sort-menu" id="sortMenu_${etapa.id}">
                                    <button class="kanban-sort-menu-item ${ordenacaoAtual === 'padrao' ? 'active' : ''}" 
                                            onclick="event.stopPropagation(); aplicarOrdenacao('${etapa.id}', 'padrao')">
                                        <i class="fas fa-times"></i>
                                        <span>Padrão</span>
                                    </button>
                                    <button class="kanban-sort-menu-item ${ordenacaoAtual === 'maior_tempo' ? 'active' : ''}" 
                                            onclick="event.stopPropagation(); aplicarOrdenacao('${etapa.id}', 'maior_tempo')">
                                        <i class="fas fa-sort-amount-down"></i>
                                        <span>Maior Tempo</span>
                                    </button>
                                    <button class="kanban-sort-menu-item ${ordenacaoAtual === 'menor_tempo' ? 'active' : ''}" 
                                            onclick="event.stopPropagation(); aplicarOrdenacao('${etapa.id}', 'menor_tempo')">
                                        <i class="fas fa-sort-amount-up"></i>
                                        <span>Menor Tempo</span>
                                    </button>
                                    <button class="kanban-sort-menu-item ${ordenacaoAtual === 'maior_valor' ? 'active' : ''}" 
                                            onclick="event.stopPropagation(); aplicarOrdenacao('${etapa.id}', 'maior_valor')">
                                        <i class="fas fa-sort-amount-down"></i>
                                        <span>Maior Valor</span>
                                    </button>
                                    <button class="kanban-sort-menu-item ${ordenacaoAtual === 'menor_valor' ? 'active' : ''}" 
                                            onclick="event.stopPropagation(); aplicarOrdenacao('${etapa.id}', 'menor_valor')">
                                        <i class="fas fa-sort-amount-up"></i>
                                        <span>Menor Valor</span>
                                    </button>
                                    <button class="kanban-sort-menu-item ${ordenacaoAtual === 'cliente_asc' ? 'active' : ''}" 
                                            onclick="event.stopPropagation(); aplicarOrdenacao('${etapa.id}', 'cliente_asc')">
                                        <i class="fas fa-sort-alpha-down"></i>
                                        <span>Cliente A-Z</span>
                                    </button>
                                    <button class="kanban-sort-menu-item ${ordenacaoAtual === 'cliente_desc' ? 'active' : ''}" 
                                            onclick="event.stopPropagation(); aplicarOrdenacao('${etapa.id}', 'cliente_desc')">
                                        <i class="fas fa-sort-alpha-up"></i>
                                        <span>Cliente Z-A</span>
                                    </button>
                                    <button class="kanban-sort-menu-item ${ordenacaoAtual === 'data_mais_recente' ? 'active' : ''}" 
                                            onclick="event.stopPropagation(); aplicarOrdenacao('${etapa.id}', 'data_mais_recente')">
                                        <i class="fas fa-calendar-alt"></i>
                                        <span>Data Mais Recente</span>
                                    </button>
                                    <button class="kanban-sort-menu-item ${ordenacaoAtual === 'data_mais_antiga' ? 'active' : ''}" 
                                            onclick="event.stopPropagation(); aplicarOrdenacao('${etapa.id}', 'data_mais_antiga')">
                                        <i class="fas fa-calendar"></i>
                                        <span>Data Mais Antiga</span>
                                    </button>
                                    </div>
                                </div>
                            </div>
                            <div class="kanban-column-info">
                                <div class="kanban-column-count">${coletas.length}</div>
                                <div class="kanban-column-value">${valorFormatado}</div>
                            </div>
                        </div>
                        <div class="kanban-column-cards" 
                             ondrop="handleKanbanDrop(event, '${etapa.id}')" 
                             ondragover="handleKanbanDragOver(event)"
                             ondragleave="handleKanbanDragLeave(event)">
                            ${coletas.map(coleta => createKanbanCard(coleta)).join('')}
                        </div>
                    </div>
                `;
            }).join('');

            // Adicionar event listeners de drag e botões
            setTimeout(() => {
                document.querySelectorAll('.kanban-card').forEach(card => {
                    card.addEventListener('dragstart', handleKanbanDragStart);
                    card.addEventListener('dragend', handleKanbanDragEnd);
                });
                
                // Adicionar event listeners aos botões de avançar etapa
                document.querySelectorAll('button[onclick*="avancarEtapa"]').forEach(button => {
                    const onclickAttr = button.getAttribute('onclick');
                    if (onclickAttr && onclickAttr.includes('avancarEtapa')) {
                        // Extrair o ID da coleta do onclick
                        const match = onclickAttr.match(/avancarEtapa\(['"]([^'"]+)['"]\)/);
                        if (match && match[1]) {
                            const coletaId = match[1];
                            button.removeAttribute('onclick'); // Remover onclick inline
                            button.addEventListener('click', function(e) {
                                e.stopPropagation();
                                e.preventDefault();
                                console.log('🔘 Botão clicado, chamando avancarEtapa para:', coletaId);
                                if (typeof window.avancarEtapa === 'function') {
                                    window.avancarEtapa(coletaId);
                                } else if (typeof avancarEtapa === 'function') {
                                    avancarEtapa(coletaId);
                                } else {
                                    console.error('❌ Função avancarEtapa não encontrada');
                                    alert('Erro: Função avancarEtapa não encontrada. Recarregue a página.');
                                }
                            });
                        }
                    }
                });
            }, 100);
            
            // Configurar navegação do Kanban
            setTimeout(() => {
                configurarNavegacaoKanban();
            }, 200);
            
            // Iniciar atualização de tempo parado
            iniciarAtualizacaoTempoParado();
        }

        // Função para trocar de página no Kanban
        async function trocarPaginaKanban(paginaId) {
            if (!PAGINAS_KANBAN[paginaId]) {
                console.error('Página não encontrada:', paginaId);
                return;
            }

            // Verificar permissão antes de trocar
            const temPermissao = await verificarPermissaoPaginaKanban(paginaId);
            if (!temPermissao) {
                console.warn('⚠️ Usuário não tem permissão para acessar a página:', paginaId);
                alert('Você não tem permissão para acessar esta página.');
                return;
            }

            // Atualizar página ativa
            paginaAtivaKanban = paginaId;
            const novaPagina = PAGINAS_KANBAN[paginaId];

            // Se a página tem sub-páginas, inicializar a primeira sub-página
            if (novaPagina && novaPagina.temSubPaginas && novaPagina.subPaginas) {
                // Se não há sub-página ativa ou a sub-página atual não pertence a esta página, usar a primeira
                if (!subPaginaAtivaKanban || !novaPagina.subPaginas[subPaginaAtivaKanban]) {
                    const primeiraSubPagina = Object.keys(novaPagina.subPaginas)[0];
                    subPaginaAtivaKanban = primeiraSubPagina;
                    console.log('🔄 [DEBUG trocarPaginaKanban] Sub-página inicializada:', subPaginaAtivaKanban);
                }
                console.log('📋 [DEBUG trocarPaginaKanban] Página:', paginaId, 'Sub-página ativa:', subPaginaAtivaKanban);
                // Atualizar menu lateral
                atualizarMenuLateralAtivo();
            } else {
                // Se a página não tem sub-páginas, limpar sub-página ativa
                subPaginaAtivaKanban = null;
                console.log('📋 [DEBUG] Página sem sub-páginas:', paginaId);
                // Menu lateral agora gerencia a navegação
            }

            // Atualizar menu lateral de módulos
            atualizarMenuLateralAtivo();

            // Verificar se a nova página é o Funil Geral
            const funilContainer = document.getElementById('funilGeralContainer');
            const kanbanBoard = document.getElementById('kanbanBoard');
            const kanbanNavigation = document.getElementById('kanbanNavigation');
            const prioridadeFarol = document.getElementById('prioridadeFarol');
            
            if (novaPagina && novaPagina.isFunilGeral) {
                // Mostrar funil geral e ocultar o conteúdo do kanban
                if (funilContainer) {
                    funilContainer.style.display = 'block';
                    funilContainer.classList.add('visible');
                }
                // Ocultar apenas o board e controles
                if (kanbanBoard) kanbanBoard.style.display = 'none';
                if (kanbanNavigation) kanbanNavigation.style.display = 'none';
                if (prioridadeFarol) prioridadeFarol.style.display = 'none';
                // Renderizar o funil geral
                await renderizarFunilGeral();
            } else {
                // Mostrar kanban e ocultar funil geral
                if (funilContainer) {
                    funilContainer.style.display = 'none';
                    funilContainer.classList.remove('visible');
                }
                // Mostrar o conteúdo do kanban
                if (kanbanBoard) kanbanBoard.style.display = 'flex';
                if (kanbanNavigation) kanbanNavigation.style.display = 'flex';
                if (prioridadeFarol) prioridadeFarol.style.display = 'block';
                
                // Se a página tem sub-páginas, garantir que a sub-página está inicializada antes de renderizar
                if (novaPagina && novaPagina.temSubPaginas && novaPagina.subPaginas) {
                    if (!subPaginaAtivaKanban || !novaPagina.subPaginas[subPaginaAtivaKanban]) {
                        const primeiraSubPagina = Object.keys(novaPagina.subPaginas)[0];
                        subPaginaAtivaKanban = primeiraSubPagina;
                        console.log('🔄 [DEBUG] Sub-página inicializada antes de renderizar:', subPaginaAtivaKanban);
                    }
                }
                
                // Re-renderizar o kanban com as etapas da nova página
                await renderColetasKanban();
            }
        }

        // Função para alternar exibição de sub-páginas (mantida para compatibilidade, mas não é mais usada)
        async function toggleSubPaginas(paginaId) {
            // Esta função não é mais necessária, mas mantida para compatibilidade
            // O menu lateral agora gerencia a navegação
            console.log('⚠️ toggleSubPaginas não é mais usado. Use o menu lateral para navegar.');
        }

        // Função para trocar de sub-página no Kanban
        async function trocarSubPaginaKanban(paginaId, subPaginaId) {
            console.log('🔄 [trocarSubPaginaKanban] Página:', paginaId, 'Sub-página:', subPaginaId);
            const pagina = PAGINAS_KANBAN[paginaId];
            if (!pagina) {
                console.error('❌ Página não encontrada:', paginaId);
                return;
            }
            if (!pagina.temSubPaginas || !pagina.subPaginas) {
                console.error('❌ Página não tem sub-páginas:', paginaId);
                return;
            }
            if (!pagina.subPaginas[subPaginaId]) {
                console.error('❌ Sub-página não encontrada:', subPaginaId, 'Disponíveis:', Object.keys(pagina.subPaginas));
                return;
            }

            // Atualizar página e sub-página ativas
            paginaAtivaKanban = paginaId;
            subPaginaAtivaKanban = subPaginaId;
            console.log('✅ Página e sub-página atualizadas:', paginaAtivaKanban, subPaginaAtivaKanban);

            // Atualizar estado visual das abas principais
            document.querySelectorAll('.kanban-page-tab').forEach(tab => {
                if (tab.dataset.pagina === paginaId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });

            // Atualizar estado visual dos containers de dropdown
            document.querySelectorAll('.kanban-page-tab-dropdown').forEach(container => {
                if (container.dataset.pagina === paginaId) {
                    container.classList.add('active');
                } else {
                    container.classList.remove('active');
                }
            });

            // Atualizar estado visual das sub-abas
            document.querySelectorAll('.sub-pagina-option').forEach(option => {
                option.classList.remove('active');
            });
            const subPaginaOption = document.querySelector(`.sub-pagina-option[onclick*="'${paginaId}', '${subPaginaId}'"]`);
            if (subPaginaOption) {
                subPaginaOption.classList.add('active');
            }

            // Garantir que o dropdown está visível
            const dropdown = document.getElementById(`subPaginas-${paginaId}`);
            if (dropdown) {
                dropdown.style.display = 'block';
            }

            // Re-renderizar o kanban com as etapas da sub-página
            await renderColetasKanban();
            
            // Atualizar estado visual no sidebar se estiver aberto
            atualizarSidebarAtivo();
            
            // Atualizar menu lateral de módulos
            atualizarMenuLateralAtivo();
        }
        
        /**
         * Atualiza o estado visual do sidebar para mostrar qual funil está ativo
         */
        function atualizarSidebarAtivo() {
            if (paginaAtivaKanban === 'operacao' && subPaginaAtivaKanban) {
                document.querySelectorAll('.funil-item-sidebar').forEach(item => {
                    item.classList.remove('active');
                    // Verificar se o onclick contém o subPaginaId ativo
                    const onclickAttr = item.getAttribute('onclick');
                    if (onclickAttr && onclickAttr.includes(`'${subPaginaAtivaKanban}'`)) {
                        item.classList.add('active');
                    }
                });
            }
        }

        // Expor funções globalmente para uso em onclick
        window.trocarPaginaKanban = trocarPaginaKanban;
        window.toggleSubPaginas = toggleSubPaginas;
        window.trocarSubPaginaKanban = trocarSubPaginaKanban;
        window.toggleFunisSidebar = toggleFunisSidebar;
        window.selecionarFunil = selecionarFunil;
        window.selecionarModulo = selecionarModulo;
        window.toggleModulesSidebar = toggleModulesSidebar;
        window.toggleModulesSidebarMobile = toggleModulesSidebarMobile;
        window.toggleModuleSubpages = toggleModuleSubpages;
        
        // Função para configurar navegação do Kanban
        function configurarNavegacaoKanban() {
            const kanbanBoard = document.getElementById('kanbanBoard');
            const kanbanWrapper = kanbanBoard?.parentElement;
            const navPrev = document.getElementById('kanbanNavPrev');
            const navNext = document.getElementById('kanbanNavNext');
            const stagesIndicator = document.getElementById('kanbanStagesIndicator');
            const stagesInfo = document.getElementById('kanbanStagesInfo');
            
            if (!kanbanBoard || !kanbanWrapper || !navPrev || !navNext) return;
            
            const columns = kanbanBoard.querySelectorAll('.kanban-column');
            const totalColumns = columns.length;
            let currentIndex = 0;
            
            // Criar indicadores de etapas
            if (stagesIndicator && totalColumns > 0) {
                stagesIndicator.innerHTML = '';
                columns.forEach((col, index) => {
                    const dot = document.createElement('div');
                    dot.className = 'kanban-stage-dot' + (index === 0 ? ' active' : '');
                    dot.title = col.querySelector('.kanban-column-title')?.textContent?.trim() || `Etapa ${index + 1}`;
                    dot.addEventListener('click', () => {
                        scrollToStage(index);
                    });
                    stagesIndicator.appendChild(dot);
                });
            }
            
            // Função para rolar para uma etapa específica
            function scrollToStage(index) {
                if (index < 0 || index >= totalColumns) return;
                
                const targetColumn = columns[index];
                if (!targetColumn) return;
                
                // Usar o wrapper para scroll
                const wrapper = kanbanWrapper;
                const wrapperRect = wrapper.getBoundingClientRect();
                const columnRect = targetColumn.getBoundingClientRect();
                
                // Calcular posição para centralizar a coluna
                const columnCenter = columnRect.left - wrapperRect.left + wrapper.scrollLeft + (columnRect.width / 2);
                const targetScroll = columnCenter - (wrapperRect.width / 2);
                
                // Scroll suave no wrapper
                wrapper.scrollTo({
                    left: targetScroll,
                    behavior: 'smooth'
                });
                
                currentIndex = index;
                
                // Atualizar após scroll
                setTimeout(() => {
                    updateNavigation();
                }, 300);
            }
            
            // Função para atualizar estado dos botões e indicadores
            function updateNavigation() {
                // Atualizar botões
                navPrev.disabled = currentIndex <= 0;
                navNext.disabled = currentIndex >= totalColumns - 1;
                
                // Atualizar indicadores
                if (stagesIndicator) {
                    stagesIndicator.querySelectorAll('.kanban-stage-dot').forEach((dot, index) => {
                        dot.classList.toggle('active', index === currentIndex);
                    });
                }
                
                // Atualizar informação
                if (stagesInfo && totalColumns > 0) {
                    const etapaNome = columns[currentIndex]?.querySelector('.kanban-column-title')?.textContent?.trim() || '';
                    stagesInfo.textContent = `${currentIndex + 1} de ${totalColumns}${etapaNome ? ` - ${etapaNome}` : ''}`;
                }
            }
            
            // Event listeners dos botões
            navPrev.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (currentIndex > 0) {
                    scrollToStage(currentIndex - 1);
                }
            });
            
            navNext.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                if (currentIndex < totalColumns - 1) {
                    scrollToStage(currentIndex + 1);
                }
            });
            
            // Atualizar índice baseado no scroll do wrapper
            const wrapperForScroll = kanbanBoard.parentElement;
            if (wrapperForScroll) {
                wrapperForScroll.addEventListener('scroll', () => {
                    const scrollLeft = wrapperForScroll.scrollLeft;
                    const wrapperWidth = wrapperForScroll.clientWidth;
                    const centerX = scrollLeft + (wrapperWidth / 2);
                
                    let closestIndex = 0;
                    let closestDistance = Infinity;
                    
                    columns.forEach((col, index) => {
                        const colRect = col.getBoundingClientRect();
                        const wrapperRect = wrapperForScroll.getBoundingClientRect();
                        const colCenterX = colRect.left - wrapperRect.left + (colRect.width / 2) + scrollLeft;
                        const distance = Math.abs(colCenterX - centerX);
                        
                        if (distance < closestDistance) {
                            closestDistance = distance;
                            closestIndex = index;
                        }
                    });
                    
                    if (closestIndex !== currentIndex) {
                        currentIndex = closestIndex;
                        updateNavigation();
                    }
                });
            }
            
            // Inicializar
            updateNavigation();
            
            // Atualizar quando redimensionar
            let resizeTimeout;
            window.addEventListener('resize', () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(() => {
                    updateNavigation();
                }, 200);
            });
        }
        
        // Função para sincronizar a barra de rolagem customizada com o kanban-board
        function sincronizarScrollbarKanban() {
            // Scroll nativo do navegador com visual melhorado funciona perfeitamente
            // Não precisamos de scrollbar customizada complexa
            return;
            
            // Limpar intervalos e listeners anteriores
            if (window.kanbanScrollInterval) {
                clearInterval(window.kanbanScrollInterval);
            }
            if (window.handleKanbanBoardScroll) {
                kanbanBoard.removeEventListener('scroll', window.handleKanbanBoardScroll);
            }
            if (window.handleKanbanResize) {
                window.removeEventListener('resize', window.handleKanbanResize);
            }
            
            // Throttle para limitar atualizações
            let lastUpdateTime = 0;
            const UPDATE_THROTTLE = 50; // ms
            
            // Função para atualizar a barra de rolagem customizada
            const updateCustomScrollbar = () => {
                const now = Date.now();
                if (now - lastUpdateTime < UPDATE_THROTTLE) {
                    return;
                }
                lastUpdateTime = now;
                
                if (!kanbanBoard || !scrollbarWrapper || !scrollbarTrack || !scrollbarThumb) {
                    return;
                }
                
                // Forçar cálculo do scrollWidth
                const boardScrollWidth = kanbanBoard.scrollWidth;
                const boardClientWidth = kanbanBoard.clientWidth;
                const boardScrollLeft = kanbanBoard.scrollLeft;
                
                // Calcular a largura total das colunas manualmente
                const columns = kanbanBoard.querySelectorAll('.kanban-column');
                let totalColumnsWidth = 0;
                columns.forEach(col => {
                    const colWidth = col.offsetWidth || col.getBoundingClientRect().width || 260;
                    totalColumnsWidth += colWidth;
                });
                // Adicionar gaps entre colunas (1rem = 16px por gap)
                totalColumnsWidth += (columns.length - 1) * 16;
                // Adicionar padding do board (1rem de cada lado = 32px)
                totalColumnsWidth += 32;
                
                // Verificar se precisa de scroll (comparar largura total com largura visível)
                // Usar uma margem menor para detectar melhor quando precisa de scroll
                const needsScroll = totalColumnsWidth > boardClientWidth + 1 || boardScrollWidth > boardClientWidth + 1;
                
                // SEMPRE mostrar a scrollbar se houver mais de uma coluna
                // Isso garante que o usuário possa navegar entre todas as etapas
                if (columns.length === 0) {
                    scrollbarWrapper.classList.add('hidden');
                    scrollbarWrapper.classList.remove('visible');
                    return;
                }
                
                // Sempre mostrar quando há múltiplas colunas
                if (columns.length > 1) {
                    scrollbarWrapper.classList.remove('hidden');
                    scrollbarWrapper.classList.add('visible');
                    scrollbarWrapper.style.display = 'block';
                    scrollbarWrapper.style.visibility = 'visible';
                    scrollbarWrapper.style.opacity = '1';
                    scrollbarWrapper.style.width = '100%';
                } else {
                    scrollbarWrapper.classList.add('hidden');
                    scrollbarWrapper.classList.remove('visible');
                    return;
                }
                
                // Aguardar um frame para garantir que o track tenha largura
                requestAnimationFrame(() => {
                    const trackWidth = scrollbarTrack.offsetWidth || scrollbarTrack.clientWidth || scrollbarTrack.getBoundingClientRect().width;
                    
                    if (trackWidth === 0 || !trackWidth) {
                        // Se ainda não tem largura, tentar novamente
                        setTimeout(() => updateCustomScrollbar(), 50);
                        return;
                    }
                    
                    // Usar a largura total calculada para melhor precisão
                    const effectiveScrollWidth = Math.max(boardScrollWidth, totalColumnsWidth);
                    
                    // Calcular proporção do thumb
                    const thumbRatio = boardClientWidth / effectiveScrollWidth;
                    const thumbWidth = Math.max(60, Math.min(trackWidth * 0.9, trackWidth * thumbRatio));
                    scrollbarThumb.style.width = `${thumbWidth}px`;
                    
                    // Calcular posição do thumb baseado no scroll atual do board
                    const maxThumbLeft = trackWidth - thumbWidth;
                    const maxScroll = Math.max(1, effectiveScrollWidth - boardClientWidth);
                    const currentScroll = kanbanBoard.scrollLeft || 0;
                    const scrollRatio = maxScroll > 0 ? currentScroll / maxScroll : 0;
                    const thumbLeft = Math.max(0, Math.min(maxThumbLeft, scrollRatio * maxThumbLeft));
                    scrollbarThumb.style.left = `${thumbLeft}px`;
                    
                    // Atualizar estado dos botões
                    if (scrollLeftBtn && scrollRightBtn) {
                        scrollLeftBtn.disabled = boardScrollLeft <= 1;
                        scrollRightBtn.disabled = boardScrollLeft >= (maxScroll - 1);
                    }
                });
            };
            
            // Flag para evitar loop infinito
            let isUpdatingScrollbar = false;
            
            // Handler de scroll do board
            window.handleKanbanBoardScroll = () => {
                if (!isUpdatingScrollbar && !isDraggingThumb) {
                    updateCustomScrollbar();
                }
            };
            kanbanBoard.addEventListener('scroll', window.handleKanbanBoardScroll, { passive: true });
            
            // Permitir scroll horizontal com shift + wheel no board
            kanbanBoard.addEventListener('wheel', (e) => {
                if (e.shiftKey || Math.abs(e.deltaX) > Math.abs(e.deltaY)) {
                    e.preventDefault();
                    kanbanBoard.scrollLeft += e.deltaX || e.deltaY;
                    updateCustomScrollbar();
                }
            }, { passive: false });
            
            // Botões de seta
            if (scrollLeftBtn) {
                scrollLeftBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const currentScroll = kanbanBoard.scrollLeft;
                    const newScroll = Math.max(0, currentScroll - 300);
                    isUpdatingScrollbar = true;
                    kanbanBoard.scrollTo({ left: newScroll, behavior: 'smooth' });
                    setTimeout(() => {
                        isUpdatingScrollbar = false;
                        updateCustomScrollbar();
                    }, 300);
                });
            }
            
            if (scrollRightBtn) {
                scrollRightBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const currentScroll = kanbanBoard.scrollLeft;
                    const maxScroll = kanbanBoard.scrollWidth - kanbanBoard.clientWidth;
                    const newScroll = Math.min(maxScroll, currentScroll + 300);
                    isUpdatingScrollbar = true;
                    kanbanBoard.scrollTo({ left: newScroll, behavior: 'smooth' });
                    setTimeout(() => {
                        isUpdatingScrollbar = false;
                        updateCustomScrollbar();
                    }, 300);
                });
            }
            
            // Arrastar o thumb
            let isDraggingThumb = false;
            let dragStartX = 0;
            let dragStartLeft = 0;
            
            scrollbarThumb.addEventListener('mousedown', (e) => {
                isDraggingThumb = true;
                dragStartX = e.clientX;
                dragStartLeft = parseFloat(scrollbarThumb.style.left) || 0;
                e.preventDefault();
                e.stopPropagation();
            });
            
            const handleThumbMouseMove = (e) => {
                if (!isDraggingThumb) return;
                e.preventDefault();
                
                const trackWidth = scrollbarTrack.offsetWidth || scrollbarTrack.getBoundingClientRect().width;
                const thumbWidth = scrollbarThumb.offsetWidth || scrollbarThumb.getBoundingClientRect().width;
                const maxThumbLeft = trackWidth - thumbWidth;
                
                const deltaX = e.clientX - dragStartX;
                let newThumbLeft = dragStartLeft + deltaX;
                newThumbLeft = Math.max(0, Math.min(maxThumbLeft, newThumbLeft));
                
                scrollbarThumb.style.left = `${newThumbLeft}px`;
                
                // Calcular scroll do board
                const boardScrollWidth = kanbanBoard.scrollWidth;
                const boardClientWidth = kanbanBoard.clientWidth;
                const columns = kanbanBoard.querySelectorAll('.kanban-column');
                let totalColumnsWidth = 0;
                columns.forEach(col => {
                    totalColumnsWidth += (col.offsetWidth || col.getBoundingClientRect().width || 260);
                });
                totalColumnsWidth += (columns.length - 1) * 16 + 32;
                const effectiveScrollWidth = Math.max(boardScrollWidth, totalColumnsWidth);
                const maxScroll = Math.max(1, effectiveScrollWidth - boardClientWidth);
                const scrollRatio = maxThumbLeft > 0 ? newThumbLeft / maxThumbLeft : 0;
                const newScrollLeft = scrollRatio * maxScroll;
                
                // Forçar atualização do scroll - usar scrollLeft diretamente para resposta imediata
                isUpdatingScrollbar = true;
                const finalScroll = Math.max(0, Math.min(newScrollLeft, maxScroll));
                kanbanBoard.scrollLeft = finalScroll;
                // Forçar atualização visual imediata
                kanbanBoard.style.scrollBehavior = 'auto';
                // Atualizar a scrollbar após o scroll
                requestAnimationFrame(() => {
                    isUpdatingScrollbar = false;
                    kanbanBoard.style.scrollBehavior = 'smooth';
                    // Garantir que a posição do thumb esteja sincronizada
                    updateCustomScrollbar();
                });
            };
            
            const handleThumbMouseUp = () => {
                isDraggingThumb = false;
            };
            
            document.addEventListener('mousemove', handleThumbMouseMove);
            document.addEventListener('mouseup', handleThumbMouseUp);
            
            // Clicar na track para mover
            scrollbarTrack.addEventListener('click', (e) => {
                if (e.target === scrollbarThumb) return;
                
                const trackRect = scrollbarTrack.getBoundingClientRect();
                const clickX = e.clientX - trackRect.left;
                const trackWidth = scrollbarTrack.offsetWidth || scrollbarTrack.getBoundingClientRect().width;
                const thumbWidth = scrollbarThumb.offsetWidth || scrollbarThumb.getBoundingClientRect().width;
                const thumbCenter = thumbWidth / 2;
                
                let newThumbLeft = clickX - thumbCenter;
                const maxThumbLeft = trackWidth - thumbWidth;
                newThumbLeft = Math.max(0, Math.min(maxThumbLeft, newThumbLeft));
                
                scrollbarThumb.style.left = `${newThumbLeft}px`;
                
                // Calcular scroll do board
                const boardScrollWidth = kanbanBoard.scrollWidth;
                const boardClientWidth = kanbanBoard.clientWidth;
                const columns = kanbanBoard.querySelectorAll('.kanban-column');
                let totalColumnsWidth = 0;
                columns.forEach(col => {
                    totalColumnsWidth += (col.offsetWidth || col.getBoundingClientRect().width || 260);
                });
                totalColumnsWidth += (columns.length - 1) * 16 + 32;
                const effectiveScrollWidth = Math.max(boardScrollWidth, totalColumnsWidth);
                const maxScroll = Math.max(1, effectiveScrollWidth - boardClientWidth);
                const scrollRatio = maxThumbLeft > 0 ? newThumbLeft / maxThumbLeft : 0;
                const newScrollLeft = scrollRatio * maxScroll;
                
                // Forçar atualização do scroll
                isUpdatingScrollbar = true;
                kanbanBoard.scrollTo({ left: newScrollLeft, behavior: 'smooth' });
                // Forçar reflow para garantir que o scroll seja aplicado
                kanbanBoard.offsetHeight;
                setTimeout(() => {
                    isUpdatingScrollbar = false;
                    updateCustomScrollbar();
                }, 300);
            });
            
            // Atualizar quando redimensionar (com debounce)
            let resizeTimeout;
            window.handleKanbanResize = () => {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(updateCustomScrollbar, 200);
            };
            window.addEventListener('resize', window.handleKanbanResize);
            
            // Atualizar inicialmente após renderização
            setTimeout(updateCustomScrollbar, 100);
            requestAnimationFrame(() => {
                setTimeout(updateCustomScrollbar, 200);
            });
            
            // Observar mudanças no tamanho do kanban-board (com throttle)
            if (window.kanbanResizeObserver) {
                window.kanbanResizeObserver.disconnect();
            }
            let resizeObserverTimeout;
            window.kanbanResizeObserver = new ResizeObserver(() => {
                clearTimeout(resizeObserverTimeout);
                resizeObserverTimeout = setTimeout(updateCustomScrollbar, 100);
            });
            window.kanbanResizeObserver.observe(kanbanBoard);
            
            // Observar mudanças no conteúdo também (com throttle)
            if (window.kanbanMutationObserver) {
                window.kanbanMutationObserver.disconnect();
            }
            let mutationObserverTimeout;
            window.kanbanMutationObserver = new MutationObserver(() => {
                clearTimeout(mutationObserverTimeout);
                mutationObserverTimeout = setTimeout(updateCustomScrollbar, 300);
            });
            window.kanbanMutationObserver.observe(kanbanBoard, {
                childList: true,
                subtree: true,
                attributes: false
            });
        }

        // Função para calcular tempo parado na etapa atual
        /**
         * Calcula o tempo em minutos que a coleta está na etapa atual
         * @param {Object} coleta - Objeto da coleta
         * @returns {number} - Tempo em minutos (0 se não conseguir calcular)
         */
        function calcularTempoMinutosEtapa(coleta) {
            let tempoMinutos = 0;
            
            // ✅ Prioridade: usar tempo_acumulado_etapa se disponível e válido (considera múltiplas entradas)
            if (coleta.tempo_acumulado_etapa !== undefined && 
                coleta.tempo_acumulado_etapa !== null && 
                !isNaN(coleta.tempo_acumulado_etapa) &&
                coleta.tempo_acumulado_etapa >= 0) {
                tempoMinutos = Math.floor(coleta.tempo_acumulado_etapa);
                // ✅ MELHORIA: Se o tempo acumulado for 0 mas a coleta existe, calcular pelo fallback
                if (tempoMinutos === 0 && coleta.data_entrada_etapa) {
                    // Pode ser que o tempo acumulado seja 0 mas a coleta já está na etapa há algum tempo
                    // Nesse caso, usar data_entrada_etapa para calcular
                    const dataEntrada = new Date(coleta.data_entrada_etapa);
                    if (!isNaN(dataEntrada.getTime())) {
                        const agora = new Date();
                        const diffMs = agora - dataEntrada;
                        const tempoCalculado = Math.floor(diffMs / (1000 * 60));
                        if (tempoCalculado > 0) {
                            return tempoCalculado;
                        }
                    }
                }
                return tempoMinutos;
            }
            
            // ✅ MELHORIA: Fallback melhorado - tentar múltiplas fontes de data
            let dataEntrada = null;
            
            // 1. Tentar data_entrada_etapa
            if (coleta.data_entrada_etapa) {
                dataEntrada = new Date(coleta.data_entrada_etapa);
                if (isNaN(dataEntrada.getTime())) {
                    dataEntrada = null;
                }
            }
            
            // 2. Se não funcionou, tentar updated_at
            if (!dataEntrada && coleta.updated_at) {
                dataEntrada = new Date(coleta.updated_at);
                if (isNaN(dataEntrada.getTime())) {
                    dataEntrada = null;
                }
            }
            
            // 3. Último fallback: created_at
            if (!dataEntrada && coleta.created_at) {
                dataEntrada = new Date(coleta.created_at);
                if (isNaN(dataEntrada.getTime())) {
                    dataEntrada = null;
                }
            }
            
            if (!dataEntrada) {
                console.warn('⚠️ Não foi possível calcular tempo da etapa para coleta:', coleta.id);
                return 0;
            }
            
            const agora = new Date();
            const diffMs = agora - dataEntrada;
            tempoMinutos = Math.floor(diffMs / (1000 * 60));
            
            // Garantir que não seja negativo
            return Math.max(0, tempoMinutos);
        }

        /**
         * Determina a prioridade automática baseada no tempo na etapa atual
         * @param {Object} coleta - Objeto da coleta
         * @returns {Object} - { nivel: string, cor: string, nome: string }
         */
        function determinarPrioridadeAutomatica(coleta) {
            const tempoMinutos = calcularTempoMinutosEtapa(coleta);
            
            // Regras de prioridade baseadas no tempo na etapa atual
            if (tempoMinutos >= 40) {
                return {
                    nivel: 'urgente',
                    cor: '#dc3545', // Vermelho
                    nome: 'Urgente',
                    bgGradient: 'linear-gradient(135deg, #dc3545 0%, #c82333 100%)',
                    borderColor: '#dc3545'
                };
            } else if (tempoMinutos >= 20) {
                return {
                    nivel: 'alta',
                    cor: '#fd7e14', // Laranja
                    nome: 'Alta',
                    bgGradient: 'linear-gradient(135deg, #fd7e14 0%, #e8590c 100%)',
                    borderColor: '#fd7e14'
                };
            } else if (tempoMinutos >= 10) {
                return {
                    nivel: 'normal',
                    cor: '#ffc107', // Amarelo
                    nome: 'Normal',
                    bgGradient: 'linear-gradient(135deg, #ffc107 0%, #e0a800 100%)',
                    borderColor: '#ffc107'
                };
            } else {
                return {
                    nivel: 'baixa',
                    cor: '#ffffff', // Branco
                    nome: 'Baixa',
                    bgGradient: 'linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%)',
                    borderColor: '#dee2e6'
                };
            }
        }

        /**
         * Verifica se a coleta está em risco de perder cliente
         * (Pode ser customizado conforme regras de negócio)
         * @param {Object} coleta - Objeto da coleta
         * @returns {boolean} - true se está em risco
         */
        function verificarRiscoPerderCliente(coleta) {
            // Exemplo: Se está há mais de 2 horas na etapa e é um cliente importante
            // Ou se está há mais de 4 horas em qualquer etapa crítica
            const tempoMinutos = calcularTempoMinutosEtapa(coleta);
            const etapasCriticas = ['comercial', 'price', 'cs', 'contratacao'];
            const estaEmEtapaCritica = etapasCriticas.includes(coleta.etapa_atual);
            
            // Se está há mais de 2 horas (120 minutos) em etapa crítica
            if (estaEmEtapaCritica && tempoMinutos >= 120) {
                return true;
            }
            
            // Se está há mais de 4 horas (240 minutos) em qualquer etapa
            if (tempoMinutos >= 240) {
                return true;
            }
            
            return false;
        }

        function calcularTempoParado(coleta) {
            // ✅ NOVO: Se tempo_acumulado_etapa estiver disponível, usar ele (considera múltiplas entradas)
            if (coleta.tempo_acumulado_etapa !== undefined && coleta.tempo_acumulado_etapa !== null) {
                const tempoAcumuladoMinutos = coleta.tempo_acumulado_etapa;
                const diffMinutos = Math.floor(tempoAcumuladoMinutos);
                const diffHoras = Math.floor(diffMinutos / 60);
                const diffDias = Math.floor(diffHoras / 24);
                
                if (diffDias > 0) {
                    return { valor: diffDias, unidade: 'dia', plural: diffDias > 1 ? 's' : '' };
                } else if (diffHoras > 0) {
                    return { valor: diffHoras, unidade: 'hora', plural: diffHoras > 1 ? 's' : '' };
                } else if (diffMinutos > 0) {
                    return { valor: diffMinutos, unidade: 'min', plural: '' };
                } else {
                    const diffSegundos = Math.floor(tempoAcumuladoMinutos * 60);
                    return { valor: diffSegundos, unidade: 'seg', plural: '' };
                }
            }
            
            // Fallback: usar data_entrada_etapa se disponível, senão usar updated_at
            if (!coleta.data_entrada_etapa && !coleta.updated_at) {
                return null;
            }
            
            const dataEntrada = coleta.data_entrada_etapa 
                ? new Date(coleta.data_entrada_etapa) 
                : (coleta.updated_at ? new Date(coleta.updated_at) : null);
            
            if (!dataEntrada || isNaN(dataEntrada.getTime())) {
                return null;
            }
            
            const agora = new Date();
            const diffMs = agora - dataEntrada;
            const diffSegundos = Math.floor(diffMs / 1000);
            const diffMinutos = Math.floor(diffSegundos / 60);
            const diffHoras = Math.floor(diffMinutos / 60);
            const diffDias = Math.floor(diffHoras / 24);
            
            if (diffDias > 0) {
                return { valor: diffDias, unidade: 'dia', plural: diffDias > 1 ? 's' : '' };
            } else if (diffHoras > 0) {
                return { valor: diffHoras, unidade: 'hora', plural: diffHoras > 1 ? 's' : '' };
            } else if (diffMinutos > 0) {
                return { valor: diffMinutos, unidade: 'min', plural: '' };
            } else {
                return { valor: diffSegundos, unidade: 'seg', plural: '' };
            }
        }
        
        // Função para formatar tempo parado com cor baseada no tempo
        // ✅ ATUALIZADO: Agora usa a prioridade automática para determinar cores
        function formatarTempoParado(tempoInfo, isDiaria, isUrgente, coleta = null) {
            if (!tempoInfo) return '';
            
            const { valor, unidade, plural } = tempoInfo;
            let cor = '#6c757d'; // Cinza padrão
            let bgColor = 'rgba(108, 117, 125, 0.1)';
            
            // ✅ NOVO: Se tiver coleta, usar prioridade automática para determinar cor
            if (coleta) {
                const prioridadeAuto = determinarPrioridadeAutomatica(coleta);
                const riscoPerderCliente = verificarRiscoPerderCliente(coleta);
                
                if (riscoPerderCliente) {
                    cor = 'rgba(255, 255, 255, 0.9)';
                    bgColor = 'rgba(0, 0, 0, 0.3)';
                } else if (prioridadeAuto.nivel === 'urgente') {
                    cor = 'rgba(255, 255, 255, 0.9)';
                    bgColor = 'rgba(220, 53, 69, 0.3)';
                } else if (prioridadeAuto.nivel === 'alta') {
                    cor = 'rgba(255, 255, 255, 0.9)';
                    bgColor = 'rgba(253, 126, 20, 0.3)';
                } else if (prioridadeAuto.nivel === 'normal') {
                    cor = '#856404';
                    bgColor = 'rgba(255, 193, 7, 0.3)';
                } else {
                    cor = '#6c757d';
                    bgColor = 'rgba(108, 117, 125, 0.1)';
                }
            } else {
                // Fallback: cores baseadas no tempo parado (lógica antiga)
                if (unidade === 'dia') {
                    if (valor >= 7) {
                        cor = '#dc3545'; // Vermelho para mais de 7 dias
                        bgColor = 'rgba(220, 53, 69, 0.15)';
                    } else if (valor >= 3) {
                        cor = '#ffc107'; // Amarelo para 3-6 dias
                        bgColor = 'rgba(255, 193, 7, 0.15)';
                    } else {
                        cor = '#28a745'; // Verde para menos de 3 dias
                        bgColor = 'rgba(40, 167, 69, 0.15)';
                    }
                } else if (unidade === 'hora') {
                    if (valor >= 24) {
                        cor = '#ffc107'; // Amarelo para mais de 24 horas
                        bgColor = 'rgba(255, 193, 7, 0.15)';
                    } else {
                        cor = '#28a745'; // Verde para menos de 24 horas
                        bgColor = 'rgba(40, 167, 69, 0.15)';
                    }
                } else {
                    cor = '#28a745'; // Verde para minutos/segundos
                    bgColor = 'rgba(40, 167, 69, 0.15)';
                }
            }
            
            // Ajustar cores se for diária (sempre branco)
            if (isDiaria) {
                cor = 'rgba(255, 255, 255, 0.9)';
                bgColor = 'rgba(255, 255, 255, 0.2)';
            }
            
            return `
                <div class="tempo-parado-badge" style="
                    display: inline-flex;
                    align-items: center;
                    gap: 0.4rem;
                    padding: 0.35rem 0.7rem;
                    border-radius: 8px;
                    background: ${bgColor};
                    color: ${cor};
                    font-size: 0.75rem;
                    font-weight: 600;
                    margin: 0;
                ">
                    <i class="fas fa-clock" style="font-size: 0.7rem;"></i>
                    <span>${valor} ${unidade}${plural}</span>
                </div>
            `;
        }

        function createKanbanCard(coleta) {
            const podeMover = temPermissaoEtapa(coleta.etapa_atual);
            const podeFinalizarOperacao = temPermissaoEtapa('finalizar_operacao');
            if (coleta.etapa_atual === 'finalizar_operacao') {
                console.log('🔍 Verificando permissão para finalizar operação:', podeFinalizarOperacao, 'coleta:', coleta.id);
            }
            const statusClass = coleta.status || 'pendente';
            const isDiaria = coleta.diaria === true || coleta.diaria === 'true' || coleta.diaria === 1;
            const isUrgente = coleta.prioridade === 'urgente';
            
            // Calcular tempo parado na etapa atual
            const tempoParado = calcularTempoParado(coleta);
            const tempoParadoHTML = formatarTempoParado(tempoParado, isDiaria, isUrgente, coleta);
            
            // ✅ NOVO: Determinar prioridade automática baseada no tempo na etapa atual
            let prioridadeAuto;
            try {
                prioridadeAuto = determinarPrioridadeAutomatica(coleta);
            } catch (error) {
                console.warn('⚠️ Erro ao determinar prioridade automática, usando padrão:', error);
                // Fallback: prioridade baixa (branco) se houver erro
                prioridadeAuto = {
                    nivel: 'baixa',
                    cor: '#ffffff',
                    nome: 'Baixa',
                    bgGradient: 'linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%)',
                    borderColor: '#dee2e6'
                };
            }
            
            const riscoPerderCliente = verificarRiscoPerderCliente(coleta);
            
            // Estilo do card baseado em prioridade automática
            // Prioridade de cores:
            // 1. Diária (sempre azul, independente de tempo)
            // 2. Risco de perder cliente (preto)
            // 3. Prioridade automática por tempo (baixa/normal/alta/urgente)
            // 4. Prioridade manual urgente (vermelho, se não for diária)
            let cardStyle = '';
            let textColor = '';
            let badgePrioridade = '';
            
            if (isDiaria) {
                // Diária sempre azul, mesmo se for urgente ou com risco
                cardStyle = 'background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%); color: white; border: 2px solid #0ea5e9; box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);';
                textColor = 'color: white;';
            } else if (riscoPerderCliente) {
                // Risco de perder cliente - Preto
                cardStyle = 'background: linear-gradient(135deg, #1a1a1a 0%, #000000 100%); color: white; border: 2px solid #000000; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);';
                textColor = 'color: white;';
                // Badge com fundo escuro/vermelho explícito para ficar legível em qualquer fundo (evita texto branco em fundo claro ao mover para etapa nova)
                badgePrioridade = '<span style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: #ffffff !important; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; flex-shrink: 0; border: 1px solid rgba(255,255,255,0.3); animation: piscarBadgeUrgente 1.5s ease-in-out infinite;"><i class="fas fa-exclamation-circle"></i> RISCO CLIENTE</span>';
            } else if (prioridadeAuto.nivel === 'urgente' || (isUrgente && prioridadeAuto.nivel !== 'urgente')) {
                // Urgente (automático ou manual) - Vermelho
                cardStyle = `background: ${prioridadeAuto.bgGradient}; color: white; border: 2px solid ${prioridadeAuto.borderColor}; box-shadow: 0 4px 12px rgba(220, 53, 69, 0.3);`;
                textColor = 'color: white;';
                if (prioridadeAuto.nivel === 'urgente') {
                    badgePrioridade = `<span style="background: rgba(255, 255, 255, 0.3); color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; flex-shrink: 0;"><i class="fas fa-exclamation-triangle"></i> ${prioridadeAuto.nome.toUpperCase()}</span>`;
                }
            } else if (prioridadeAuto.nivel === 'alta') {
                // Alta - Laranja
                cardStyle = `background: ${prioridadeAuto.bgGradient}; color: white; border: 2px solid ${prioridadeAuto.borderColor}; box-shadow: 0 4px 12px rgba(253, 126, 20, 0.3);`;
                textColor = 'color: white;';
            } else if (prioridadeAuto.nivel === 'normal') {
                // Normal - Amarelo
                cardStyle = `background: ${prioridadeAuto.bgGradient}; color: #333; border: 2px solid ${prioridadeAuto.borderColor}; box-shadow: 0 2px 8px rgba(255, 193, 7, 0.2);`;
                textColor = 'color: #333;';
            } else {
                // Baixa - Branco (padrão)
                // ✅ CORREÇÃO: Garantir fundo branco sólido e texto escuro bem visível
                cardStyle = `background: #ffffff !important; color: #212529 !important; border: 1px solid #dee2e6; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);`;
                textColor = 'color: #212529 !important;';
            }
            
            // ✅ CARD LEVE: Apenas dados essenciais para performance
            // ✅ CORREÇÃO: Adicionar classe para identificar cards brancos
            const isCardBranco = prioridadeAuto.nivel === 'baixa' && !isDiaria && !riscoPerderCliente;
            const cardClass = `kanban-card ${!podeMover ? 'no-drag' : ''} ${isCardBranco ? 'card-branco' : ''}`;
            // ✅ CORREÇÃO: Cor do texto do cliente sempre derivada do fundo real do card (cardStyle) — evita texto branco em fundo claro ao mover coleta em risco para etapa nova (novo tempo)
            const cardFundoClaro = (cardStyle.indexOf('#ffffff') >= 0 || cardStyle.indexOf('background: white') >= 0);
            const corTextoCliente = cardFundoClaro ? 'color: #212529 !important;' : (prioridadeAuto.nivel === 'normal' ? 'color: #333 !important;' : 'color: #ffffff !important;');
            
            return `
                <div class="${cardClass}" 
                     draggable="${podeMover}"
                     data-coleta-id="${coleta.id}"
                     data-etapa-atual="${coleta.etapa_atual}"
                     onclick="abrirKanbanDrawer('${coleta.id}')"
                     style="${cardStyle}">
                    <div class="kanban-card-header">
                        <div class="kanban-card-title" style="${textColor}; display: flex; align-items: center; flex-wrap: wrap; gap: 0.5rem;">
                            <span style="flex: 1; min-width: 0; ${corTextoCliente}">${escapeHtml(coleta.cliente || 'Sem cliente')}</span>
                            ${isDiaria ? '<span style="background: rgba(255, 255, 255, 0.3); color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; flex-shrink: 0;"><i class="fas fa-calendar-day"></i> DIÁRIA</span>' : ''}
                            ${badgePrioridade || ''}
                            ${isUrgente && !badgePrioridade ? '<span style="background: rgba(255, 255, 255, 0.3); color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; flex-shrink: 0; animation: piscarBadgeUrgente 1.5s ease-in-out infinite;"><i class="fas fa-exclamation-triangle"></i> URGENTE</span>' : ''}
                        </div>
                    </div>
                    
                    <div class="kanban-card-body" style="${textColor}">
                        ${coleta.filial && coleta.numero_coleta ? `
                            <div class="kanban-card-info" style="${textColor} !important;">
                                <i class="fas fa-building" style="${prioridadeAuto.nivel === 'baixa' || prioridadeAuto.nivel === 'normal' ? 'color: #495057 !important;' : 'color: inherit;'}"></i> ${coleta.filial} | 
                                <i class="fas fa-hashtag" style="${prioridadeAuto.nivel === 'baixa' || prioridadeAuto.nivel === 'normal' ? 'color: #495057 !important;' : 'color: inherit;'}"></i> ${coleta.numero_coleta}
                            </div>
                        ` : ''}
                        <div class="kanban-card-info" style="${textColor} !important;">
                            <i class="fas fa-map-marker-alt" style="${prioridadeAuto.nivel === 'baixa' || prioridadeAuto.nivel === 'normal' ? 'color: #495057 !important;' : 'color: inherit;'}"></i> ${escapeHtml(coleta.origem || 'N/A')} → ${escapeHtml(coleta.destino || 'N/A')}
                        </div>
                        ${coleta.valor ? `
                            <div class="kanban-card-info" style="font-weight: 600; ${textColor} !important;">
                                <i class="fas fa-dollar-sign" style="${prioridadeAuto.nivel === 'baixa' || prioridadeAuto.nivel === 'normal' ? (prioridadeAuto.nivel === 'normal' ? 'color: #856404 !important;' : 'color: #667eea !important;') : 'color: inherit;'}"></i> R$ ${(coleta.valor || 0).toFixed(2)}
                            </div>
                        ` : ''}
                        ${coleta.etapa_atual === 'contas_pagar' && coleta.contas_pagar_tipo ? `
                            <div class="kanban-card-info" style="background: ${prioridadeAuto.nivel === 'baixa' || prioridadeAuto.nivel === 'normal' ? 'rgba(72, 12, 168, 0.1);' : 'rgba(255, 255, 255, 0.2);'}; padding: 0.4rem 0.6rem; border-radius: 6px; margin-top: 0.5rem; border-left: 3px solid ${prioridadeAuto.nivel === 'baixa' || prioridadeAuto.nivel === 'normal' ? '#480ca8;' : 'white;'}">
                                <i class="fas fa-money-bill-wave" style="color: ${prioridadeAuto.nivel === 'baixa' || prioridadeAuto.nivel === 'normal' ? '#480ca8;' : 'white;'}"></i> 
                                <span style="color: ${prioridadeAuto.nivel === 'baixa' || prioridadeAuto.nivel === 'normal' ? '#480ca8;' : 'white;'}; font-weight: 600; font-size: 0.85rem;">${escapeHtml(coleta.contas_pagar_tipo)}</span>
                                ${coleta.contas_pagar_pago ? `
                                    <span style="color: ${prioridadeAuto.nivel === 'baixa' || prioridadeAuto.nivel === 'normal' ? '#28a745;' : 'rgba(255, 255, 255, 0.9);'}; font-size: 0.75rem; margin-left: 0.5rem;">
                                        <i class="fas fa-check-circle"></i> Pago
                                    </span>
                                ` : `
                                    <span style="color: ${prioridadeAuto.nivel === 'baixa' || prioridadeAuto.nivel === 'normal' ? '#ffc107;' : 'rgba(255, 255, 255, 0.8);'}; font-size: 0.75rem; margin-left: 0.5rem;">
                                        <i class="fas fa-clock"></i> Pendente
                                    </span>
                                `}
                            </div>
                        ` : ''}
                        ${coleta.titulo_contrato ? `
                            <div class="kanban-card-info" style="background: ${prioridadeAuto.nivel === 'baixa' || prioridadeAuto.nivel === 'normal' ? 'rgba(253, 126, 20, 0.1);' : 'rgba(255, 255, 255, 0.2);'}; padding: 0.4rem 0.6rem; border-radius: 6px; margin-top: 0.5rem; border-left: 3px solid ${prioridadeAuto.nivel === 'baixa' || prioridadeAuto.nivel === 'normal' ? '#fd7e14;' : 'white;'}">
                                <i class="fas fa-file-contract" style="color: ${prioridadeAuto.nivel === 'baixa' || prioridadeAuto.nivel === 'normal' ? '#fd7e14;' : 'white;'}"></i> 
                                <span style="color: ${prioridadeAuto.nivel === 'baixa' || prioridadeAuto.nivel === 'normal' ? '#fd7e14;' : 'white;'}; font-weight: 600; font-size: 0.85rem; word-break: break-word;">${escapeHtml(coleta.titulo_contrato)}</span>
                            </div>
                        ` : ''}
                        ${tempoParadoHTML || coleta.etapa_atual === 'pagamento' || coleta.etapa_atual === 'inicio_monitoramento' ? `
                            <div style="margin-top: 0.5rem; display: flex; align-items: center; gap: 0.4rem; flex-wrap: wrap;">
                                ${tempoParadoHTML || ''}
                                ${coleta.etapa_atual === 'pagamento' ? `
                                    <button class="kanban-card-btn" onclick="event.stopPropagation(); abrirModalConfirmarPagamento('${coleta.id}')" title="Confirmar Pagamento" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; font-weight: 600; padding: 0.3rem 0.6rem; font-size: 0.7rem; box-shadow: 0 2px 4px rgba(40, 167, 69, 0.2); border-radius: 5px; margin: 0; white-space: nowrap; display: inline-flex; align-items: center; gap: 0.25rem; flex-shrink: 0;">
                                        <i class="fas fa-check-circle"></i> Pagamento
                                    </button>
                                    <button class="kanban-card-btn" onclick="event.stopPropagation(); abrirModalLancarPendencia('${coleta.id}')" title="Lançar Pendência" style="background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%); color: white; border: none; font-weight: 600; padding: 0.3rem 0.55rem; font-size: 0.7rem; box-shadow: 0 2px 4px rgba(220, 53, 69, 0.2); border-radius: 5px; margin: 0; white-space: nowrap; display: inline-flex; align-items: center; gap: 0.2rem; flex-shrink: 0; min-width: fit-content;">
                                        <i class="fas fa-exclamation-triangle"></i> Pend.
                                    </button>
                                ` : ''}
                                ${coleta.etapa_atual === 'inicio_monitoramento' ? `
                                    <button class="kanban-card-btn" onclick="event.stopPropagation(); enviarLinkRastreamento('${coleta.id}')" title="Enviar Link de Rastreamento via WhatsApp" style="background: linear-gradient(135deg, #25D366 0%, #128C7E 100%); color: white; border: none; font-weight: 600; padding: 0.45rem 0.9rem; font-size: 0.75rem; box-shadow: 0 2px 4px rgba(37, 211, 102, 0.2); border-radius: 6px; margin: 0; white-space: nowrap; display: inline-flex; align-items: center; gap: 0.3rem;">
                                        <i class="fab fa-whatsapp"></i> Enviar Link
                                    </button>
                                ` : ''}
                            </div>
                        ` : ''}
                        ${coleta.etiquetas && coleta.etiquetas.length > 0 ? `
                            <div class="kanban-card-etiquetas" style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.25rem; align-items: center;">
                                ${coleta.etiquetas.map(et => `
                                    <span class="kanban-etiqueta-badge" style="background: ${et.cor || '#667eea'}; color: #fff; padding: 0.2rem 0.45rem; border-radius: 6px; font-size: 0.65rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.2rem; white-space: nowrap; box-shadow: 0 1px 3px rgba(0,0,0,0.12); border: 1px solid rgba(255,255,255,0.3);">
                                        <i class="fas fa-tag" style="font-size: 0.55rem; opacity: 0.9;"></i>${escapeHtml((et.nome || '').trim()) || '—'}
                                    </span>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    
                    <div class="kanban-card-footer" style="${prioridadeAuto.nivel === 'baixa' || prioridadeAuto.nivel === 'normal' ? '' : 'border-top: 1px solid rgba(255, 255, 255, 0.2);'}">
                        <span class="kanban-card-status ${statusClass}" style="${prioridadeAuto.nivel === 'baixa' || prioridadeAuto.nivel === 'normal' ? '' : 'background: rgba(255, 255, 255, 0.2) !important; color: white !important;'}">${getStatusText(coleta.status)}</span>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; align-items: center;">
                            ${podeMover ? `
                                <button class="kanban-card-btn" onclick="event.stopPropagation(); abrirModalMoverColeta('${coleta.id}')" title="Mover coleta" style="${prioridadeAuto.nivel === 'baixa' || prioridadeAuto.nivel === 'normal' ? 'background: rgba(102, 126, 234, 0.1); color: #667eea;' : 'background: rgba(255, 255, 255, 0.3) !important;'}">
                                    <i class="fas fa-exchange-alt"></i>
                                </button>
                            ` : ''}
                        <button class="kanban-card-btn" onclick="event.stopPropagation(); abrirKanbanDrawer('${coleta.id}')" title="Ver detalhes" style="${prioridadeAuto.nivel === 'baixa' || prioridadeAuto.nivel === 'normal' ? '' : 'background: rgba(255, 255, 255, 0.3) !important;'}">
                            <i class="fas fa-arrow-right"></i>
                        </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function createKanbanExpandedContent(coleta, progresso) {
            const temPermissao = temPermissaoEtapa(coleta.etapa_atual);
            
            return `
                <div style="margin-top: 1rem; padding-top: 1rem; border-top: 2px solid rgba(102, 126, 234, 0.2);">
                    <!-- Informações Detalhadas -->
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <strong><i class="fas fa-truck"></i> Tipos de Veículo:</strong>
                            <div style="margin-top: 0.25rem;">
                                ${coleta.tipos_veiculo && coleta.tipos_veiculo.length > 0 
                                    ? coleta.tipos_veiculo.map(v => `<span style="background: #667eea; color: white; padding: 0.2rem 0.5rem; border-radius: 6px; font-size: 0.75rem; margin-right: 0.25rem; display: inline-block;">${v}</span>`).join('')
                                    : '<span style="color: #999;">-</span>'}
                            </div>
                        </div>
                        <div>
                            <strong><i class="fas fa-box"></i> Tipos de Carroceria:</strong>
                            <div style="margin-top: 0.25rem;">
                                ${coleta.tipos_carroceria && coleta.tipos_carroceria.length > 0 
                                    ? coleta.tipos_carroceria.map(c => {
                                        const nomeAmigavel = tiposCarroceriaMap[c] || c;
                                        return `<span style="background: #f5576c; color: white; padding: 0.2rem 0.5rem; border-radius: 6px; font-size: 0.75rem; margin-right: 0.25rem; display: inline-block;">${nomeAmigavel}</span>`;
                                    }).join('')
                                    : '<span style="color: #999;">-</span>'}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Etiquetas -->
                    ${coleta.etiquetas && coleta.etiquetas.length > 0 ? `
                        <div style="margin-bottom: 1rem;">
                            <strong><i class="fas fa-tags"></i> Etiquetas:</strong>
                            <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${coleta.etiquetas.map(et => `
                                    <span style="background: ${et.cor || '#667eea'}; color: white; padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.75rem;">
                                        <i class="fas fa-tag"></i> ${et.nome}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Motorista -->
                    ${coleta.motorista_id ? `
                        <div style="background: rgba(40, 167, 69, 0.1); padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; border: 1px solid #28a745;">
                            <strong><i class="fas fa-user-check"></i> Motorista:</strong>
                            <div id="kanban-motorista-info-${coleta.id}" style="margin-top: 0.5rem;">
                                <i class="fas fa-spinner fa-spin"></i> Carregando...
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Anexos -->
                    ${coleta.anexos && coleta.anexos.length > 0 ? `
                        <div style="margin-bottom: 1rem;">
                            <strong><i class="fas fa-paperclip"></i> Anexos (${coleta.anexos.length}):</strong>
                            <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                ${coleta.anexos.slice(0, 5).map(anexo => `
                                    <a href="${anexo.url}" target="_blank" 
                                       style="background: #667eea; color: white; padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.75rem; text-decoration: none; display: inline-flex; align-items: center; gap: 0.3rem;"
                                       onclick="event.stopPropagation();">
                                        <i class="fas fa-file"></i> ${anexo.nome || 'Anexo'}
                                    </a>
                                `).join('')}
                                ${coleta.anexos.length > 5 ? `<span style="color: #999; font-size: 0.75rem;">+${coleta.anexos.length - 5} mais</span>` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Progresso das Etapas -->
                    <div style="margin-bottom: 1rem;">
                        <strong><i class="fas fa-project-diagram"></i> Progresso: ${progresso.concluidas}/${progresso.total} etapas</strong>
                        <div style="margin-top: 0.5rem; background: rgba(0,0,0,0.1); border-radius: 8px; height: 8px; overflow: hidden;">
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); height: 100%; width: ${(progresso.concluidas / progresso.total) * 100}%; transition: width 0.3s;"></div>
                        </div>
                    </div>
                    
                    <!-- ITs Relacionadas -->
                    ${coleta.cliente ? `
                        <div id="kanban-its-${coleta.id}" style="margin-bottom: 1rem;">
                            <strong><i class="fas fa-file-alt"></i> ITs Relacionadas:</strong>
                            <div style="margin-top: 0.5rem; color: #999; font-size: 0.85rem;">
                                <i class="fas fa-spinner fa-spin"></i> Carregando...
                            </div>
                        </div>
                    ` : ''}
                    
                    <!-- Histórico -->
                    <div id="kanban-historico-${coleta.id}" style="margin-bottom: 1rem;">
                        <strong><i class="fas fa-history"></i> Últimas Movimentações:</strong>
                        <div style="margin-top: 0.5rem; color: #999; font-size: 0.85rem;">
                            <i class="fas fa-spinner fa-spin"></i> Carregando...
                        </div>
                    </div>
                    
                    <!-- Botões de Ação -->
                    <div style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(0,0,0,0.1);">
                        <button onclick="event.stopPropagation(); openChatModal('${coleta.id}')" 
                                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600;">
                            <i class="fas fa-comment"></i> Chat
                        </button>
                        ${temPermissao ? `
                            <button onclick="event.stopPropagation(); event.preventDefault(); if(typeof avancarEtapa === 'function') { avancarEtapa('${coleta.id}'); } else if(typeof window.avancarEtapa === 'function') { window.avancarEtapa('${coleta.id}'); } else { console.error('❌ Função avancarEtapa não encontrada'); alert('Erro: Função avancarEtapa não encontrada. Recarregue a página.'); }" 
                                    style="background: #28a745; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600;">
                                <i class="fas fa-arrow-right"></i> Avançar
                            </button>
                            <button onclick="event.stopPropagation(); openEditColetaModal('${coleta.id}')" 
                                    style="background: #667eea; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: 600;">
                                <i class="fas fa-edit"></i> Editar
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // ========== DRAWER DO KANBAN (WORKSPACE) ==========
        async function abrirKanbanDrawer(coletaId) {
            const drawer = document.getElementById('kanbanDrawer');
            const drawerContent = document.getElementById('kanbanDrawerContent');
            
            if (!drawer || !drawerContent) return;
            
            // Mostrar drawer
            drawer.classList.add('active');
            
            // Mostrar loading
            drawerContent.innerHTML = `
                <div class="kanban-drawer-header">
                    <div class="kanban-drawer-title">
                        <i class="fas fa-spinner fa-spin"></i>
                        <span>Carregando...</span>
                    </div>
                    <button class="kanban-drawer-close" onclick="fecharKanbanDrawer()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="kanban-drawer-body">
                    <div style="text-align: center; padding: 3rem;">
                        <i class="fas fa-spinner fa-spin fa-3x" style="color: #667eea; margin-bottom: 1rem;"></i>
                        <p>Carregando dados da coleta...</p>
                    </div>
                </div>
            `;
            
            // Carregar dados completos sob demanda
            await carregarConteudoDrawer(coletaId);
        }

        function fecharKanbanDrawer() {
            const drawer = document.getElementById('kanbanDrawer');
            if (drawer) {
                drawer.classList.remove('active');
            }
        }

        async function carregarConteudoDrawer(coletaId) {
            const drawerContent = document.getElementById('kanbanDrawerContent');
            const coleta = coletasData.find(c => c.id === coletaId);
            
            if (!coleta || !drawerContent) return;
            
            const temPermissao = temPermissaoEtapa(coleta.etapa_atual);
            const progresso = calcularProgressoEtapas(coleta);
            
            // Garantir que os funis estão carregados para organizar etapas por funil
            if (!todosFunisDisponiveis || todosFunisDisponiveis.length === 0) {
                await carregarFunisParaModal();
            }
            
            // Carregar dados pesados sob demanda
            const [anexos, motorista, historico, its] = await Promise.all([
                carregarAnexos(coletaId),
                coleta.motorista_id ? buscarMotoristaPorId(coleta.motorista_id).catch(() => null) : Promise.resolve(null),
                carregarHistorico(coletaId),
                coleta.cliente ? carregarITsRelacionadasParaDrawer(coleta.cliente, coleta.filial) : Promise.resolve([])
            ]);
            
            // Verificar se motorista está reprovado ESPECIFICAMENTE PARA ESTA COLETA
            const reprovacaoInfo = verificarReprovacaoPorColeta(motorista, coleta.id);
            const motoristaReprovado = reprovacaoInfo.reprovado;
            
            // Log para debug
            if (coleta.etapa_atual === 'contratacao' && coleta.motorista_id) {
                console.log('🔍 Verificando motorista reprovado:', {
                    coletaId: coletaId,
                    motoristaId: coleta.motorista_id,
                    motorista: motorista ? {
                        nome: motorista.nome,
                        reprovado: motorista.reprovado,
                        motivo: motorista.motivo_reprovacao
                    } : null,
                    motoristaReprovado: motoristaReprovado
                });
            }
            
            // Renderizar conteúdo completo
            drawerContent.innerHTML = `
                <div class="kanban-drawer-header">
                    <div class="kanban-drawer-title">
                        <i class="fas fa-file-invoice"></i>
                        <div>
                            <div>${escapeHtml(coleta.cliente || 'Sem cliente')}</div>
                            ${coleta.filial && coleta.numero_coleta ? `
                                <div style="font-size: 0.85rem; color: #6c757d; font-weight: normal;">
                                    ${coleta.filial} | Coleta #${coleta.numero_coleta}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <button class="kanban-drawer-close" onclick="fecharKanbanDrawer()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="kanban-drawer-body">
                    <!-- Tabs de Navegação -->
                    <div class="kanban-drawer-tabs">
                        <button class="kanban-drawer-tab active" onclick="trocarTabDrawer('geral')">
                            <i class="fas fa-info-circle"></i> Geral
                        </button>
                        <button class="kanban-drawer-tab" onclick="trocarTabDrawer('anexos')">
                            <i class="fas fa-paperclip"></i> Anexos (${anexos?.length || 0})
                        </button>
                        <button class="kanban-drawer-tab" onclick="trocarTabDrawer('motorista')">
                            <i class="fas fa-user"></i> Motorista
                        </button>
                        <button class="kanban-drawer-tab" onclick="trocarTabDrawer('its')">
                            <i class="fas fa-file-alt"></i> ITs Relacionadas
                        </button>
                        <button class="kanban-drawer-tab" onclick="trocarTabDrawer('historico')">
                            <i class="fas fa-history"></i> Histórico
                        </button>
                        <button class="kanban-drawer-tab" onclick="trocarTabDrawer('chat')">
                            <i class="fas fa-comment"></i> Chat
                        </button>
                    </div>
                    
                    <!-- Tab: Geral -->
                    <div class="kanban-drawer-tab-content active" id="tab-geral">
                        ${renderTabGeral(coleta, progresso, temPermissao)}
                    </div>
                    
                    <!-- Tab: Anexos -->
                    <div class="kanban-drawer-tab-content" id="tab-anexos">
                        ${renderTabAnexos(anexos, coletaId, temPermissao)}
                    </div>
                    
                    <!-- Tab: Motorista -->
                    <div class="kanban-drawer-tab-content" id="tab-motorista">
                        ${renderTabMotorista(motorista, coleta, temPermissao)}
                    </div>
                    
                    <!-- Tab: ITs -->
                    <div class="kanban-drawer-tab-content" id="tab-its">
                        ${renderTabITs(its)}
                    </div>
                    
                    <!-- Tab: Histórico -->
                    <div class="kanban-drawer-tab-content" id="tab-historico">
                        ${renderTabHistorico(historico)}
                    </div>
                    
                    <!-- Tab: Chat -->
                    <div class="kanban-drawer-tab-content" id="tab-chat">
                        ${renderTabChat(coletaId)}
                    </div>
                </div>
            `;
            
            // Configurar event listener do input file após renderizar
            setTimeout(async () => {
                const fileInput = document.getElementById(`drawer-upload-anexo-${coletaId}`);
                if (fileInput) {
                    // Remover listeners antigos clonando o elemento
                    const newInput = fileInput.cloneNode(true);
                    fileInput.parentNode.replaceChild(newInput, fileInput);
                    
                    // Adicionar novo listener
                    newInput.addEventListener('change', function(e) {
                        console.log('📎 Input file change detectado:', e.target.files?.length || 0);
                        const files = e.target.files;
                        if (files && files.length > 0) {
                            // Criar cópia do FileList antes de resetar
                            const filesArray = Array.from(files);
                            console.log('📎 Arquivos capturados antes do reset:', filesArray.map(f => f.name));
                            
                            // Resetar input apenas após capturar os arquivos
                            e.target.value = '';
                            
                            // Chamar função de upload com o array
                            handleDrawerUploadAnexo(coletaId, filesArray);
                        }
                    });
                }
                
                // Verificar e mostrar alerta de motorista reprovado
                // Verificar novamente o status do motorista para garantir que está atualizado
                if (coleta.etapa_atual === 'contratacao' && coleta.motorista_id) {
                    let isReprovado = false;
                    let motivoReprovacao = null;
                    
                    if (motorista) {
                        const reprovacaoInfo = verificarReprovacaoPorColeta(motorista, coleta.id);
                        isReprovado = reprovacaoInfo.reprovado;
                        motivoReprovacao = reprovacaoInfo.motivo;
                    } else {
                        // Se o motorista não foi carregado, tentar buscar novamente
                        try {
                            const motoristaRecarregado = await buscarMotoristaPorId(coleta.motorista_id);
                            if (motoristaRecarregado) {
                                const reprovacaoInfo = verificarReprovacaoPorColeta(motoristaRecarregado, coleta.id);
                                isReprovado = reprovacaoInfo.reprovado;
                                motivoReprovacao = reprovacaoInfo.motivo;
                            }
                        } catch (err) {
                            console.warn('⚠️ Erro ao recarregar motorista:', err);
                        }
                    }
                    
                    const alertaDiv = document.getElementById(`alerta-motorista-reprovado-${coletaId}`);
                    if (alertaDiv) {
                        if (isReprovado) {
                            alertaDiv.style.display = 'block';
                            
                            // Atualizar motivo se existir
                            if (motivoReprovacao) {
                                const motivoDiv = document.getElementById(`motivo-reprovacao-${coletaId}`);
                                const motivoTexto = document.getElementById(`motivo-texto-${coletaId}`);
                                if (motivoDiv && motivoTexto) {
                                    motivoTexto.textContent = motivoReprovacao;
                                    motivoDiv.style.display = 'block';
                                }
                            }
                            
                            console.log('✅ Alerta de motorista reprovado exibido para coleta:', coletaId, { motivo: motivoReprovacao });
                        } else {
                            alertaDiv.style.display = 'none';
                        }
                    } else {
                        console.warn('⚠️ Elemento de alerta não encontrado:', `alerta-motorista-reprovado-${coletaId}`);
                    }
                }
            }, 100);
        }

        function trocarTabDrawer(tabId) {
            // Remover active de todas as tabs
            document.querySelectorAll('.kanban-drawer-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.kanban-drawer-tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Ativar tab selecionada
            const tab = document.querySelector(`.kanban-drawer-tab[onclick*="${tabId}"]`);
            const content = document.getElementById(`tab-${tabId}`);
            
            if (tab) tab.classList.add('active');
            if (content) content.classList.add('active');
        }

        // Função auxiliar para verificar se uma etapa é GR (suporta etapas dinâmicas)
        function isEtapaGR(etapaAtualId) {
            if (!etapaAtualId) return false;
            
            const etapaIdLower = String(etapaAtualId).toLowerCase().trim();
            
            // Verificar se é exatamente 'gr'
            if (etapaIdLower === 'gr') return true;
            
            // Verificar se o ID contém 'gr' ou 'aprovacao'
            if (etapaIdLower.includes('gr') || etapaIdLower.includes('aprovacao') || etapaIdLower.includes('aprovação')) {
                return true;
            }
            
            // Verificar no array ETAPAS se há uma etapa com esse ID e se o nome contém GR ou Aprovação
            const etapaInfo = ETAPAS.find(e => e.id === etapaIdLower);
            if (etapaInfo) {
                const nomeLower = (etapaInfo.nome || '').toLowerCase();
                if (nomeLower.includes('gr') || nomeLower.includes('aprovação') || nomeLower.includes('aprovacao')) {
                    return true;
                }
            }
            
            return false;
        }

        // Função auxiliar para agrupar etapas por funil
        function agruparEtapasPorFunil() {
            const etapasPorFunil = {};
            
            // Tentar usar todosFunisDisponiveis se disponível, senão usar funisDinamicos
            let funisParaUsar = [];
            
            if (typeof todosFunisDisponiveis !== 'undefined' && todosFunisDisponiveis && todosFunisDisponiveis.length > 0) {
                funisParaUsar = todosFunisDisponiveis;
            } else if (typeof funisDinamicos !== 'undefined' && funisDinamicos) {
                // Extrair todos os funis de todas as páginas
                Object.values(funisDinamicos).forEach(funisDaPagina => {
                    if (Array.isArray(funisDaPagina)) {
                        funisParaUsar.push(...funisDaPagina);
                    }
                });
            }
            
            // Se não temos funis carregados, retornar etapas sem agrupamento
            if (funisParaUsar.length === 0) {
                return {
                    'Geral': ETAPAS.map(e => ({ etapa: e, funil: null }))
                };
            }
            
            // Agrupar etapas por funil
            funisParaUsar.forEach(funil => {
                if (funil.etapas && funil.etapas.length > 0) {
                    const funilNome = funil.nome;
                    if (!etapasPorFunil[funilNome]) {
                        etapasPorFunil[funilNome] = [];
                    }
                    
                    funil.etapas.forEach(etapaFunil => {
                        const etapaInfo = ETAPAS.find(e => e.id === etapaFunil.id);
                        if (etapaInfo) {
                            etapasPorFunil[funilNome].push({
                                etapa: etapaInfo,
                                funil: funil
                            });
                        }
                    });
                }
            });
            
            // Adicionar etapas que não pertencem a nenhum funil (se houver)
            const etapasComFunil = new Set();
            Object.values(etapasPorFunil).forEach(etapas => {
                etapas.forEach(e => etapasComFunil.add(e.etapa.id));
            });
            
            const etapasSemFunil = ETAPAS.filter(e => !etapasComFunil.has(e.id));
            if (etapasSemFunil.length > 0) {
                etapasPorFunil['Outras Etapas'] = etapasSemFunil.map(e => ({ etapa: e, funil: null }));
            }
            
            return etapasPorFunil;
        }

        // Função auxiliar para renderizar etapa individual
        function renderizarEtapaItem(etapa, coleta, temPermissao) {
                            const isAtiva = coleta.etapa_atual === etapa.id;
                            const passouPorEla = coleta.etapas_concluidas?.includes(etapa.id) || false;
                            const jaPassouMasNaoEAtual = passouPorEla && !isAtiva;
                            const icon = isAtiva ? 'fa-check-circle' : (jaPassouMasNaoEAtual ? 'fa-check-circle' : 'fa-clock');
                            const color = isAtiva ? '#28a745' : (jaPassouMasNaoEAtual ? '#667eea' : '#999');
                            
                            // ✅ Validações para determinar se pode clicar
                            let podeClicar = temPermissao && !isAtiva;
                            let motivoBloqueio = '';
                            
                            if (podeClicar) {
                                // Validação: Não pode sair de contratação sem motorista
                                if (coleta.etapa_atual === 'contratacao' && !coleta.motorista_id) {
                                    podeClicar = false;
                                    motivoBloqueio = 'Vincule um motorista primeiro';
                                }
                                // Validação: Não pode sair de GR sem aprovação
                                else if (isEtapaGR(coleta.etapa_atual)) {
                                    const etapaAtualIndex = ETAPAS.findIndex(e => e.id === coleta.etapa_atual);
                                    const novaEtapaIndex = ETAPAS.findIndex(e => e.id === etapa.id);
                                    
                                    if (novaEtapaIndex > etapaAtualIndex) {
                                        // Tentando avançar de GR
                                        if (coleta.gr_aprovado === null || coleta.gr_aprovado === undefined) {
                                            podeClicar = false;
                                            motivoBloqueio = 'Aprove ou reprove o GR primeiro';
                                        } else if (coleta.gr_aprovado === false) {
                                            podeClicar = false;
                                            motivoBloqueio = 'GR reprovado - deve voltar para Contratação';
                                        }
                                    }
                                }
                            }
                            
                            return `
                                <span 
                                    class="drawer-etapa-item ${podeClicar ? 'drawer-etapa-clickable' : ''}"
                                    data-etapa-id="${etapa.id}"
                                    data-coleta-id="${coleta.id}"
                                    onclick="${podeClicar ? `moverParaEtapaDrawer('${coleta.id}', '${etapa.id}')` : ''}"
                                    style="
                                        display: flex; 
                                        align-items: center; 
                                        gap: 0.4rem; 
                                        font-size: 0.85rem; 
                                        color: ${podeClicar ? color : '#ccc'};
                                        font-weight: ${isAtiva ? '600' : 'normal'};
                                        ${podeClicar ? 'cursor: pointer; padding: 0.5rem 0.75rem; border-radius: 6px; transition: all 0.2s;' : 'cursor: not-allowed; padding: 0.5rem 0.75rem; border-radius: 6px; opacity: 0.6;'}
                                    "
                                    onmouseover="${podeClicar ? `this.style.background='rgba(102, 126, 234, 0.1)'; this.style.transform='translateY(-2px)';` : ''}"
                                    onmouseout="${podeClicar ? `this.style.background='transparent'; this.style.transform='translateY(0)';` : ''}"
                                    title="${isAtiva ? 'Etapa atual' : podeClicar ? `Clique para mover para ${etapa.nome}` : motivoBloqueio || 'Sem permissão para mover'}">
                                    <i class="fas ${icon}"></i>
                                    ${etapa.nome}
                                    ${podeClicar ? '<i class="fas fa-hand-pointer" style="font-size: 0.7rem; margin-left: 0.25rem; opacity: 0.6;"></i>' : ''}
                                    ${!podeClicar && !isAtiva && motivoBloqueio ? '<i class="fas fa-lock" style="font-size: 0.7rem; margin-left: 0.25rem; opacity: 0.6;"></i>' : ''}
                                </span>
                            `;
        }

        function renderTabGeral(coleta, progresso, temPermissao) {
            // Agrupar etapas por funil
            const etapasPorFunil = agruparEtapasPorFunil();
            
            // Renderizar seções por funil (ordenar por ordem do funil se disponível)
            let htmlEtapasPorFunil = '';
            const funisOrdenados = Object.keys(etapasPorFunil).sort((a, b) => {
                const funilA = etapasPorFunil[a][0]?.funil;
                const funilB = etapasPorFunil[b][0]?.funil;
                const ordemA = funilA?.ordem || 999;
                const ordemB = funilB?.ordem || 999;
                return ordemA - ordemB;
            });
            
            funisOrdenados.forEach(funilNome => {
                const etapasDoFunil = etapasPorFunil[funilNome];
                if (etapasDoFunil.length === 0) return;
                
                const funil = etapasDoFunil[0]?.funil;
                const iconeFunil = funil?.icone || 'fa-project-diagram';
                
                // Calcular progresso do funil
                const etapasConcluidasFunil = etapasDoFunil.filter(e => 
                    coleta.etapas_concluidas?.includes(e.etapa.id) || coleta.etapa_atual === e.etapa.id
                ).length;
                const totalEtapasFunil = etapasDoFunil.length;
                const porcentagemFunil = totalEtapasFunil > 0 ? (etapasConcluidasFunil / totalEtapasFunil) * 100 : 0;
                
                htmlEtapasPorFunil += `
                    <div class="funil-etapas-card" style="margin-bottom: 1.5rem; padding: 1.25rem; background: white; border-radius: 12px; border: 2px solid rgba(102, 126, 234, 0.15); box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <div class="funil-etapas-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid rgba(102, 126, 234, 0.1); flex-wrap: wrap; gap: 0.75rem;">
                            <div style="display: flex; align-items: center; gap: 0.75rem; flex: 1; min-width: 200px;">
                                <div style="width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); display: flex; align-items: center; justify-content: center; color: white; font-size: 1.1rem; flex-shrink: 0;">
                                    <i class="fas ${iconeFunil}"></i>
                                </div>
                                <div style="flex: 1; min-width: 0;">
                                    <strong style="font-size: 1rem; color: #333; display: block; word-wrap: break-word;">${escapeHtml(funilNome)}</strong>
                                    <div style="font-size: 0.8rem; color: #666; margin-top: 0.25rem;">
                                        ${totalEtapasFunil} etapa${totalEtapasFunil > 1 ? 's' : ''}
                                    </div>
                                </div>
                            </div>
                            <div style="text-align: right; flex-shrink: 0;">
                                <div style="color: #667eea; font-weight: 600; font-size: 0.9rem;">
                                    ${etapasConcluidasFunil}/${totalEtapasFunil}
                                </div>
                                <div style="font-size: 0.75rem; color: #999; margin-top: 0.25rem;">
                                    ${porcentagemFunil.toFixed(0)}%
                                </div>
                            </div>
                        </div>
                        
                        <!-- Barra de progresso do funil -->
                        <div class="funil-progress-bar" style="margin-bottom: 1rem; background: rgba(0,0,0,0.05); border-radius: 8px; padding: 0.25rem; overflow: hidden; display: flex; gap: 0.15rem;">
                            ${etapasDoFunil.map(({ etapa }) => {
                                const isAtiva = coleta.etapa_atual === etapa.id;
                                const passouPorEla = coleta.etapas_concluidas?.includes(etapa.id) || false;
                                const jaPassouMasNaoEAtual = passouPorEla && !isAtiva;
                                const bgColor = isAtiva ? '#28a745' : (jaPassouMasNaoEAtual ? '#667eea' : 'rgba(0,0,0,0.1)');
                                return `<div style="flex: 1; min-width: 4px; height: 6px; background: ${bgColor}; border-radius: 4px; transition: all 0.3s;"></div>`;
                        }).join('')}
                    </div>
                        
                        <!-- Etapas do funil -->
                        <div class="funil-etapas-grid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 0.5rem;">
                            ${etapasDoFunil.map(({ etapa }) => renderizarEtapaItem(etapa, coleta, temPermissao)).join('')}
                        </div>
                    </div>
                `;
            });
            
            const tipoProduto = coleta.tipo_produto ?? coleta.tipoProduto ?? '';
            const tabela = coleta.codigo_tabela ?? coleta.codigoTabela ?? '';
            const valorCte = coleta.valor != null ? (Number(coleta.valor)).toFixed(2) : '0,00';
            const freteMotorista = coleta.frete_motorista ?? coleta.freteMotorista ?? '';
            const kmVal = coleta.km != null && coleta.km !== '' ? coleta.km : '0';
            return `
                <div class="coleta-info-grid" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1.5rem; margin-bottom: 1.5rem;">
                    <div>
                        <strong><i class="fas fa-cube"></i> Tipo de produto:</strong>
                        <div style="margin-top: 0.5rem; color: #666;">${escapeHtml(tipoProduto || 'N/A')}</div>
                    </div>
                    <div>
                        <strong><i class="fas fa-table"></i> Tabela:</strong>
                        <div style="margin-top: 0.5rem; color: #666;">${escapeHtml(tabela || 'N/A')}</div>
                    </div>
                    <div>
                        <strong><i class="fas fa-file-invoice-dollar"></i> Valor CTE:</strong>
                        <div style="margin-top: 0.5rem; color: #667eea; font-weight: 600; font-size: 1.1rem;">
                            R$ ${valorCte}
                        </div>
                    </div>
                    <div>
                        <strong><i class="fas fa-money-bill-wave"></i> Frete Motorista:</strong>
                        <div style="margin-top: 0.5rem; color: #666;">${freteMotorista !== '' && freteMotorista != null ? ('R$ ' + (Number(freteMotorista)).toFixed(2)) : 'N/A'}</div>
                    </div>
                    <div>
                        <strong><i class="fas fa-route"></i> KM:</strong>
                        <div style="margin-top: 0.5rem; color: #666;">${kmVal} km</div>
                    </div>
                    <div>
                        <strong><i class="fas fa-map-marker-alt"></i> Origem:</strong>
                        <div style="margin-top: 0.5rem; color: #666;">${escapeHtml(coleta.origem || 'N/A')}</div>
                    </div>
                    <div>
                        <strong><i class="fas fa-flag-checkered"></i> Destino:</strong>
                        <div style="margin-top: 0.5rem; color: #666;">${escapeHtml(coleta.destino || 'N/A')}</div>
                    </div>
                    <div>
                        <strong><i class="fas fa-truck"></i> Tipos de Veículo:</strong>
                        <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${coleta.tipos_veiculo && coleta.tipos_veiculo.length > 0 
                                ? coleta.tipos_veiculo.map(v => `<span style="background: #667eea; color: white; padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.85rem;">${v}</span>`).join('')
                                : '<span style="color: #999;">-</span>'}
                        </div>
                    </div>
                    <div>
                        <strong><i class="fas fa-box"></i> Tipos de Carroceria:</strong>
                        <div style="margin-top: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${coleta.tipos_carroceria && coleta.tipos_carroceria.length > 0 
                                ? coleta.tipos_carroceria.map(c => {
                                    const nomeAmigavel = tiposCarroceriaMap[c] || c;
                                    return `<span style="background: #f5576c; color: white; padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.85rem;">${nomeAmigavel}</span>`;
                                }).join('')
                                : '<span style="color: #999;">-</span>'}
                        </div>
                    </div>
                </div>
                
                <!-- Visualização Completa das Etapas Organizadas por Funil -->
                <div class="etapas-processo-container" style="margin-bottom: 1.5rem; padding: 1.5rem; background: rgba(102, 126, 234, 0.05); border-radius: 12px; border: 1px solid rgba(102, 126, 234, 0.1);">
                    <div class="etapas-processo-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem;">
                        <strong style="font-size: 1.1rem;"><i class="fas fa-project-diagram"></i> Etapas do Processo</strong>
                        <span style="color: #667eea; font-weight: 600; white-space: nowrap;">${progresso.concluidas}/${progresso.total} etapas</span>
                    </div>
                    
                    ${htmlEtapasPorFunil || '<div style="text-align: center; padding: 2rem; color: #999;">Nenhuma etapa disponível</div>'}
                </div>
                
                <!-- Validações de Etapa -->
                ${coleta.etapa_atual === 'contratacao' && !coleta.motorista_id ? `
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 152, 0, 0.1) 100%); border: 2px solid #ffc107; border-radius: 8px;">
                        <div style="color: #f57c00; font-weight: 600; margin-bottom: 0.5rem;">
                            <i class="fas fa-exclamation-triangle"></i> Validação Necessária
                        </div>
                        <div style="color: #333; margin-bottom: 1rem; font-size: 0.9rem;">
                            Para avançar da etapa Contratação, é necessário vincular um motorista à coleta.
                        </div>
                        ${temPermissao ? `
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button onclick="vincularMotorista('${coleta.id}')" 
                                        style="background: #28a745; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem;">
                                    <i class="fas fa-user-plus"></i> Vincular Motorista
                                </button>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
                ${coleta.etapa_atual === 'contratacao' && coleta.motorista_id ? `
                    <div id="alerta-motorista-reprovado-${coleta.id}" style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, rgba(220, 53, 69, 0.1) 0%, rgba(200, 35, 51, 0.1) 100%); border: 2px solid #dc3545; border-radius: 8px; display: none;">
                        <div style="color: #dc3545; font-weight: 600; margin-bottom: 0.5rem;">
                            <i class="fas fa-exclamation-triangle"></i> Motorista Reprovado
                        </div>
                        <div style="color: #333; margin-bottom: 1rem; font-size: 0.9rem;">
                            O motorista vinculado está reprovado. É <strong>obrigatório</strong> trocar o motorista ou solicitar uma nova análise antes de avançar para outra etapa.
                        </div>
                        <div id="motivo-reprovacao-${coleta.id}" style="color: #721c24; font-size: 0.85rem; margin-bottom: 0.5rem; padding: 0.5rem; background: rgba(220, 53, 69, 0.1); border-left: 3px solid #dc3545; border-radius: 4px; display: none;">
                            <strong>Motivo:</strong> <span id="motivo-texto-${coleta.id}"></span>
                        </div>
                        ${temPermissao ? `
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button onclick="trocarMotorista('${coleta.id}')" 
                                        style="background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem;">
                                    <i class="fas fa-exchange-alt"></i> Trocar Motorista
                                </button>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
                ${coleta.etapa_atual === 'finalizar_operacao' ? `
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 152, 0, 0.1) 100%); border: 2px solid #ffc107; border-radius: 8px;">
                        <div style="color: #f57c00; font-weight: 600; margin-bottom: 0.5rem;">
                            <i class="fas fa-check-circle"></i> Canhoto Anexado - Aguardando Validação
                        </div>
                        <div style="color: #333; margin-bottom: 1rem; font-size: 0.9rem;">
                            O motorista anexou o canhoto da entrega. Verifique o documento nos anexos. Só é possível finalizar a operação com canhoto anexado; ao finalizar, a coleta vai para o histórico.
                        </div>
                        <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                            <button onclick="trocarTabDrawer('anexos')" 
                                    style="background: #ffc107; color: #333; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem;">
                                <i class="fas fa-paperclip"></i> Ver Anexos
                            </button>
                            <button onclick="finalizarOperacao('${coleta.id}')" 
                                    style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem;">
                                <i class="fas fa-flag-checkered"></i> Finalizar Operação
                            </button>
                        </div>
                    </div>
                ` : ''}
                ${isEtapaGR(coleta.etapa_atual) && (coleta.gr_aprovado === null || coleta.gr_aprovado === undefined || coleta.gr_aprovado === false) ? `
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); border: 2px solid #667eea; border-radius: 8px;">
                        <div style="color: #667eea; font-weight: 600; margin-bottom: 0.5rem;">
                            <i class="fas fa-clipboard-check"></i> Aprovação GR Necessária
                        </div>
                        <div style="color: #333; margin-bottom: 1rem; font-size: 0.9rem;">
                            Usuário com função GR deve aprovar ou reprovar esta coleta para continuar.
                        </div>
                        ${temPermissao ? `
                            <div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
                                <button onclick="aprovarGR('${coleta.id}')" 
                                        style="background: #28a745; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem;">
                                    <i class="fas fa-check"></i> Aprovar
                                </button>
                                <button onclick="reprovarGR('${coleta.id}')" 
                                        style="background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.85rem;">
                                    <i class="fas fa-times"></i> Reprovar
                                </button>
                            </div>
                        ` : ''}
                    </div>
                ` : ''}
                ${coleta.etapa_atual === 'contas_pagar' && coleta.contas_pagar_tipo ? `
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: linear-gradient(135deg, rgba(72, 12, 168, 0.1) 0%, rgba(102, 126, 234, 0.1) 100%); border: 2px solid #480ca8; border-radius: 8px;">
                        <div style="color: #480ca8; font-weight: 600; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-money-bill-wave"></i> Tipo de Pagamento Solicitado
                        </div>
                        <div style="color: #333; font-size: 1rem; font-weight: 600; padding: 0.75rem; background: rgba(72, 12, 168, 0.05); border-radius: 6px; margin-top: 0.5rem;">
                            ${escapeHtml(coleta.contas_pagar_tipo)}
                        </div>
                        ${coleta.contas_pagar_pago ? `
                            <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(40, 167, 69, 0.1); border-radius: 6px; border: 1px solid #28a745;">
                                <div style="color: #28a745; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-check-circle"></i> Pagamento Realizado
                                </div>
                                ${coleta.contas_pagar_pago_por ? `
                                    <div style="color: #666; font-size: 0.85rem; margin-top: 0.25rem;">
                                        Pago por: ${escapeHtml(coleta.contas_pagar_pago_por)}
                                    </div>
                                ` : ''}
                                ${coleta.contas_pagar_data ? `
                                    <div style="color: #666; font-size: 0.85rem; margin-top: 0.25rem;">
                                        Data: ${formatarDataHora(coleta.contas_pagar_data)}
                                    </div>
                                ` : ''}
                            </div>
                        ` : `
                            <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(255, 193, 7, 0.1); border-radius: 6px; border: 1px solid #ffc107;">
                                <div style="color: #f57c00; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; margin-bottom: 0.75rem;">
                                    <i class="fas fa-clock"></i> Aguardando Pagamento
                                </div>
                                ${temPermissao ? `
                                    <button onclick="confirmarPagamentoContasPagar('${coleta.id}')" 
                                            style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 0.9rem; width: 100%; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); transition: all 0.3s;"
                                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(40, 167, 69, 0.4)';"
                                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(40, 167, 69, 0.3)';">
                                        <i class="fas fa-check-circle"></i> Confirmar Pagamento
                                    </button>
                                ` : ''}
                            </div>
                        `}
                    </div>
                ` : ''}
                
                <!-- Etiquetas -->
                <div style="margin-bottom: 1.5rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <strong><i class="fas fa-tags"></i> Etiquetas:</strong>
                        ${temPermissao ? `
                            <button onclick="abrirModalEtiquetas('${coleta.id}')" 
                                    style="background: transparent; color: #667eea; border: 1px solid #667eea; padding: 0.4rem 0.8rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;">
                                <i class="fas fa-edit"></i> Gerenciar
                            </button>
                        ` : ''}
                    </div>
                    ${coleta.etiquetas && coleta.etiquetas.length > 0 ? `
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${coleta.etiquetas.map(et => `
                                <span style="background: ${et.cor || '#667eea'}; color: white; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.85rem;">
                                    <i class="fas fa-tag"></i> ${et.nome}
                                </span>
                            `).join('')}
                        </div>
                    ` : `
                        <div style="color: #999; font-size: 0.85rem; font-style: italic;">Nenhuma etiqueta adicionada</div>
                    `}
                </div>
                
                <!-- Datas -->
                <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(0,0,0,0.02); border-radius: 8px; display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; font-size: 0.85rem;">
                    ${coleta.created_at ? `
                        <div>
                            <strong style="color: #666;"><i class="fas fa-calendar-plus"></i> Criado em:</strong>
                            <div style="color: #999; margin-top: 0.25rem;">${formatarDataHora(coleta.created_at)}</div>
                        </div>
                    ` : ''}
                    ${coleta.updated_at ? `
                        <div>
                            <strong style="color: #666;"><i class="fas fa-calendar-edit"></i> Atualizado em:</strong>
                            <div style="color: #999; margin-top: 0.25rem;">${formatarDataHora(coleta.updated_at)}</div>
                        </div>
                    ` : ''}
                </div>
                
                <!-- Observações -->
                ${coleta.observacoes ? `
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(102, 126, 234, 0.05); border-radius: 8px;">
                        <strong><i class="fas fa-sticky-note"></i> Observações:</strong>
                        <div style="margin-top: 0.5rem; color: #666; white-space: pre-wrap;">${escapeHtml(coleta.observacoes)}</div>
                    </div>
                ` : ''}
                
                <!-- Botões de Ação -->
                <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 2rem; padding-top: 1.5rem; border-top: 2px solid #e5e7eb;">
                    ${temPermissao ? `
                        <button onclick="if(typeof avancarEtapa === 'function') { avancarEtapa('${coleta.id}'); } else if(typeof window.avancarEtapa === 'function') { window.avancarEtapa('${coleta.id}'); } else { console.error('❌ Função avancarEtapa não encontrada'); alert('Erro: Função avancarEtapa não encontrada. Recarregue a página.'); }" 
                                style="background: #28a745; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-arrow-right"></i> Avançar Etapa
                        </button>
                        ${(() => {
                            const etapaAtualIndex = ETAPAS.findIndex(e => e.id === coleta.etapa_atual);
                            const etapaAnterior = etapaAtualIndex > 0 ? ETAPAS[etapaAtualIndex - 1] : null;
                            return etapaAnterior ? `
                                <button onclick="voltarEtapa('${coleta.id}', '${etapaAnterior.id}')" 
                                        style="background: #ffc107; color: #333; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-arrow-left"></i> Voltar para ${etapaAnterior.nome}
                                </button>
                            ` : '';
                        })()}
                        <button onclick="openEditColetaModal('${coleta.id}')" 
                                style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        ${currentUser && (currentUser.isAdmin || currentUser.role === 'admin') ? `
                        <button onclick="if(confirm('Tem certeza que deseja excluir esta coleta?')) { excluirColeta('${coleta.id}'); fecharKanbanDrawer(); }" 
                                style="background: #dc3545; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                        ` : ''}
                    ` : ''}
                    <button onclick="openChatModal('${coleta.id}')" 
                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-comment"></i> Chat
                    </button>
                </div>
            `;
        }

        function renderTabAnexos(anexos, coletaId, temPermissao) {
            // Agrupar anexos por categoria
            const anexosPorCategoria = {};
            const anexosSemCategoria = [];
            
            if (anexos && anexos.length > 0) {
                anexos.forEach(anexo => {
                    const categoria = anexo.categoria || anexo.area || 'outros';
                    if (!anexosPorCategoria[categoria]) {
                        anexosPorCategoria[categoria] = [];
                    }
                    anexosPorCategoria[categoria].push(anexo);
                });
            }
            
            const categoriasOrdenadas = [
                'canhoto',
                'documentos_motorista',
                'documentos_proprietario',
                'documentos_veiculo',
                'evidencias',
                'faturamento',
                'notas_fiscais',
                'contratos',
                'outros'
            ];
            
            return `
                ${temPermissao ? `
                    <div style="margin-bottom: 1.5rem; padding: 1rem; background: rgba(102, 126, 234, 0.05); border-radius: 8px; border: 2px dashed #667eea;">
                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                            <i class="fas fa-upload" style="color: #667eea; font-size: 1.2rem;"></i>
                            <strong style="color: #667eea;">Adicionar Anexo</strong>
                        </div>
                        <input type="file" 
                               id="drawer-upload-anexo-${coletaId}" 
                               multiple 
                               style="display: none;">
                        <button onclick="const input = document.getElementById('drawer-upload-anexo-${coletaId}'); if(input) { input.click(); }" 
                                style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-plus"></i> Selecionar Arquivo(s)
                        </button>
                        <div style="margin-top: 0.5rem; font-size: 0.85rem; color: #666;">
                            Você pode selecionar múltiplos arquivos. A categoria será solicitada antes do envio.
                        </div>
                    </div>
                ` : ''}
                
                ${!anexos || anexos.length === 0 ? `
                    <div style="text-align: center; padding: 3rem; color: #999;">
                        <i class="fas fa-paperclip fa-3x" style="margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>Nenhum anexo encontrado</p>
                    </div>
                ` : `
                    <div style="display: flex; flex-direction: column; gap: 2rem;">
                        ${categoriasOrdenadas.map(categoria => {
                            const anexosCategoria = anexosPorCategoria[categoria] || [];
                            if (anexosCategoria.length === 0) return '';
                            
                            const corCategoria = obterCorCategoria(categoria);
                            const iconeCategoria = obterIconeCategoria(categoria);
                            const nomeCategoria = obterNomeCategoria(categoria);
                            
                            return `
                                <div style="border: 2px solid ${corCategoria}20; border-radius: 12px; padding: 1.5rem; background: ${corCategoria}08;">
                                    <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid ${corCategoria}30;">
                                        <i class="fas ${iconeCategoria}" style="color: ${corCategoria}; font-size: 1.5rem;"></i>
                                        <h3 style="margin: 0; color: ${corCategoria}; font-size: 1.1rem; font-weight: 700;">
                                            ${nomeCategoria}
                                        </h3>
                                        <span style="background: ${corCategoria}; color: white; padding: 0.25rem 0.75rem; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
                                            ${anexosCategoria.length} arquivo(s)
                                        </span>
                                    </div>
                                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                                        ${anexosCategoria.map(anexo => `
                                            <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; text-align: center; transition: all 0.2s; background: white; border-left: 3px solid ${corCategoria};">
                                                <i class="fas fa-file fa-2x" style="color: ${corCategoria}; margin-bottom: 0.5rem;"></i>
                                                <div style="font-weight: 600; margin-bottom: 0.5rem; word-break: break-word; font-size: 0.9rem;">${escapeHtml(anexo.nome_arquivo || anexo.nome || 'Anexo')}</div>
                                                ${anexo.created_at ? `
                                                    <div style="font-size: 0.75rem; color: #999; margin-bottom: 0.5rem;">
                                                        ${formatarDataHora(anexo.created_at)}
                                                    </div>
                                                ` : ''}
                                                <div style="display: flex; gap: 0.5rem; justify-content: center; flex-wrap: wrap;">
                                                    <button onclick="visualizarAnexo('${anexo.id}')" 
                                                            style="background: ${corCategoria}; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;">
                                                        <i class="fas fa-eye"></i> Ver
                                                    </button>
                                                    <button onclick="downloadAnexoDireto('${anexo.id}')" 
                                                            style="background: transparent; color: ${corCategoria}; border: 1px solid ${corCategoria}; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;">
                                                        <i class="fas fa-download"></i> Baixar
                                                    </button>
                                                    ${currentUser && (currentUser.isAdmin || currentUser.role === 'admin') ? `
                                                    <button onclick="excluirAnexo('${anexo.id}')" 
                                                            style="background: #dc3545; color: white; border: none; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.85rem; font-weight: 600;">
                                                        <i class="fas fa-trash"></i> Excluir
                                                    </button>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                </div>
                            `;
                        }).filter(html => html !== '').join('')}
                    </div>
                `}
            `;
        }
        
        async function handleDrawerUploadAnexo(coletaId, files) {
            console.log('📎 handleDrawerUploadAnexo chamado:', { 
                coletaId, 
                filesCount: files?.length || 0,
                filesType: Array.isArray(files) ? 'Array' : (files instanceof FileList ? 'FileList' : typeof files)
            });
            
            if (!files || files.length === 0) {
                console.warn('⚠️ Nenhum arquivo selecionado');
                showNotification('Nenhum arquivo selecionado', 'warning');
                return;
            }
            
            // Converter FileList para Array se necessário (pode já ser Array)
            const filesArray = Array.isArray(files) ? files : Array.from(files);
            console.log('📎 Arquivos para upload:', filesArray.map(f => f.name));
            
            if (filesArray.length === 0) {
                console.error('❌ Nenhum arquivo válido após conversão');
                showNotification('Erro: Nenhum arquivo válido selecionado', 'error');
                return;
            }
            
            // Criar modal para seleção de categoria
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.id = 'modalCategoriaAnexo';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; z-index: 10001; padding: 2rem;';
            modal.innerHTML = `
                <div class="modal-dialog" style="background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); max-width: 500px; width: 100%;">
                    <div class="modal-content" style="padding: 0;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px 20px 0 0; padding: 1.5rem 2rem;">
                            <h5 class="modal-title" style="margin: 0; font-size: 1.3rem; font-weight: 600;">
                                <i class="fas fa-folder"></i> Selecionar Categoria
                            </h5>
                            <button type="button" class="btn-close" style="filter: invert(1); opacity: 0.9; font-size: 1.5rem; background: none; border: none; color: white; cursor: pointer;" onclick="this.closest('.modal').remove();"></button>
                        </div>
                        <div class="modal-body" style="padding: 2rem;">
                            <p style="margin-bottom: 1.5rem; color: #333;">
                                Selecione a categoria para os <strong>${files.length}</strong> arquivo(s) selecionado(s):
                            </p>
                            <select id="drawerCategoriaSelect" style="width: 100%; padding: 0.8rem; border: 2px solid #e9ecef; border-radius: 10px; font-size: 1rem; background: white;">
                                <option value="">Selecione a categoria</option>
                                <option value="canhoto">📋 Canhoto (comprovante de entrega)</option>
                                <option value="documentos_motorista">📄 Documentos do Motorista</option>
                                <option value="documentos_proprietario">📋 Documentos do Proprietário</option>
                                <option value="documentos_veiculo">🚛 Documentos do Veículo</option>
                                <option value="evidencias">📸 Evidências</option>
                                <option value="faturamento">💰 Faturamento</option>
                                <option value="notas_fiscais">🧾 Notas Fiscais</option>
                                <option value="contratos">📝 Contratos</option>
                                <option value="outros">📁 Outros</option>
                            </select>
                        </div>
                        <div class="modal-footer" style="padding: 1.5rem 2rem; border-top: 1px solid #e9ecef; display: flex; justify-content: flex-end; gap: 1rem; border-radius: 0 0 20px 20px;">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove();" style="padding: 0.75rem 2rem; border-radius: 10px; border: none; font-weight: 600; background: #6c757d; color: white; cursor: pointer;">Cancelar</button>
                            <button type="button" class="btn btn-primary" id="btnConfirmarCategoria" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; padding: 0.75rem 2rem; border-radius: 10px; font-weight: 600; color: white; cursor: pointer;">
                                <i class="fas fa-check"></i> Confirmar
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Fechar modal ao clicar no backdrop
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
            
            // Event listener para mudança de categoria (mostrar campo de título se for contratos)
            const categoriaSelect = modal.querySelector('#drawerCategoriaSelect');
            categoriaSelect.addEventListener('change', function() {
                const categoria = this.value;
                const tituloContainer = document.getElementById('tituloContratoContainer');
                
                if (categoria === 'contratos') {
                    if (!tituloContainer) {
                        const tituloDiv = document.createElement('div');
                        tituloDiv.id = 'tituloContratoContainer';
                        tituloDiv.style.marginTop = '1.5rem';
                        tituloDiv.innerHTML = `
                            <label for="tituloContratoInput" style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #333;">
                                <i class="fas fa-file-contract"></i> Título do Contrato:
                            </label>
                            <input type="text" 
                                   id="tituloContratoInput" 
                                   placeholder="Ex: Contrato de Prestação de Serviços - Cliente XYZ"
                                   style="width: 100%; padding: 0.8rem; border: 2px solid #e9ecef; border-radius: 10px; font-size: 1rem; background: white;">
                            <small style="color: #6c757d; font-size: 0.85rem; margin-top: 0.25rem; display: block;">
                                O título será exibido no card principal da coleta
                            </small>
                        `;
                        categoriaSelect.closest('.modal-body').appendChild(tituloDiv);
                    } else {
                        tituloContainer.style.display = 'block';
                    }
                } else {
                    if (tituloContainer) {
                        tituloContainer.style.display = 'none';
                    }
                }
            });
            
            // Event listener para o botão confirmar
            const confirmBtn = modal.querySelector('#btnConfirmarCategoria');
            if (confirmBtn) {
            confirmBtn.onclick = () => {
                    const categoriaEl = document.getElementById('drawerCategoriaSelect');
                    const categoria = categoriaEl ? categoriaEl.value : null;
                if (!categoria) {
                    showNotification('Por favor, selecione uma categoria', 'warning');
                    return;
                }
                
                // Validar título se for contrato
                let tituloContrato = null;
                if (categoria === 'contratos') {
                    const tituloInput = document.getElementById('tituloContratoInput');
                    if (tituloInput) {
                        tituloContrato = tituloInput.value.trim();
                        if (!tituloContrato) {
                            showNotification('⚠️ Por favor, informe o título do contrato', 'warning');
                            return;
                        }
                    }
                }
                
                modal.remove();
                // Converter FileList para Array se necessário
                const filesArray = Array.from(files);
                processarUploadComCategoria(coletaId, filesArray, categoria, tituloContrato);
            };
            }
        }
        
        async function processarUploadComCategoria(coletaId, files, categoria, tituloContrato = null) {
            const drawerContent = document.getElementById('kanbanDrawerContent');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'drawer-upload-loading';
            loadingDiv.innerHTML = `
                <div style="text-align: center; padding: 1rem; background: rgba(102, 126, 234, 0.1); border-radius: 8px; margin-bottom: 1rem;">
                    <i class="fas fa-spinner fa-spin"></i> Enviando ${files.length} arquivo(s) para ${obterNomeCategoria(categoria)}...
                </div>
            `;
            const anexosTab = document.getElementById('tab-anexos');
            if (anexosTab) {
                anexosTab.insertBefore(loadingDiv, anexosTab.firstChild);
            }
            
            try {
                for (const file of files) {
                    await uploadAnexo(coletaId, file, categoria, tituloContrato);
                }
                
                showNotification(`${files.length} arquivo(s) enviado(s) com sucesso na categoria ${obterNomeCategoria(categoria)}!`, 'success');
                
                // Recarregar anexos (forçando refresh para garantir que busca os novos)
                // Invalidar cache antes de buscar
                invalidarCacheAnexos(coletaId);
                
                // Aguardar um pouco para garantir que o banco foi atualizado
                await new Promise(resolve => setTimeout(resolve, 300));
                
                // Buscar anexos novamente (forçando refresh)
                const novosAnexos = await carregarAnexos(coletaId, true);
                
                console.log('🔄 Anexos recarregados após upload:', novosAnexos.length, 'arquivo(s)');
                console.log('📋 Lista de anexos:', novosAnexos.map(a => ({ id: a.id, nome: a.nome_arquivo, categoria: a.categoria })));
                
                // Atualizar tab de anexos
                const anexosTabContent = document.getElementById('tab-anexos');
                if (anexosTabContent) {
                    const temPermissao = temPermissaoEtapa(coletasData.find(c => c.id === coletaId)?.etapa_atual);
                    const novaRenderizacao = renderTabAnexos(novosAnexos, coletaId, temPermissao);
                    anexosTabContent.innerHTML = novaRenderizacao;
                    
                    console.log('✅ Tab de anexos atualizada com', novosAnexos.length, 'arquivo(s)');
                    
                    // Reconfigurar event listener do input file após renderizar
                    const fileInput = document.getElementById(`drawer-upload-anexo-${coletaId}`);
                    if (fileInput) {
                        // Remover listeners antigos
                        const newInput = fileInput.cloneNode(true);
                        fileInput.parentNode.replaceChild(newInput, fileInput);
                        
                        // Adicionar novo listener
                        newInput.addEventListener('change', function(e) {
                            if (e.target.files && e.target.files.length > 0) {
                                handleDrawerUploadAnexo(coletaId, e.target.files);
                                e.target.value = ''; // Resetar input
                            }
                        });
                    }
                } else {
                    console.warn('⚠️ Tab de anexos não encontrada para atualizar');
                }
                
                // Atualizar contador na tab
                const anexosTabBtn = document.querySelector('.kanban-drawer-tab[onclick*="anexos"]');
                if (anexosTabBtn) {
                    anexosTabBtn.innerHTML = `<i class="fas fa-paperclip"></i> Anexos (${novosAnexos.length})`;
                }
            } catch (error) {
                console.error('Erro ao enviar anexos:', error);
                showNotification('Erro ao enviar arquivo(s): ' + error.message, 'error');
            } finally {
                const loading = document.getElementById('drawer-upload-loading');
                if (loading) loading.remove();
            }
        }

        function renderTabMotorista(motorista, coleta, temPermissao) {
            if (!motorista) {
                return `
                    <div style="text-align: center; padding: 3rem;">
                        <div style="background: linear-gradient(135deg, rgba(156, 163, 175, 0.1) 0%, rgba(107, 114, 128, 0.1) 100%); border-radius: 50%; width: 100px; height: 100px; display: flex; align-items: center; justify-content: center; margin: 0 auto 1.5rem;">
                            <i class="fas fa-user-slash fa-3x" style="color: #9ca3af;"></i>
                        </div>
                        <h3 style="color: #6b7280; margin-bottom: 0.5rem; font-size: 1.25rem;">Nenhum motorista vinculado</h3>
                        <p style="color: #9ca3af; margin-bottom: 1.5rem; font-size: 0.9rem;">Vincule um motorista para continuar com a coleta</p>
                        ${temPermissao ? `
                            <button onclick="vincularMotorista('${coleta.id}')" 
                                    style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 0.75rem 2rem; border-radius: 10px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3); transition: all 0.3s;"
                                    onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(40, 167, 69, 0.4)';"
                                    onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(40, 167, 69, 0.3)';">
                                <i class="fas fa-plus"></i> Vincular Motorista
                            </button>
                        ` : ''}
                    </div>
                `;
            }
            
            // ✅ IMPORTANTE: Verificar status do motorista ESPECÍFICO PARA ESTA COLETA
            // O motorista só pode estar aprovado ou reprovado DEPOIS de passar pela etapa GR
            // Antes disso, o status é NEUTRO (pendente de análise GR)
            
            const quantidadeReprovacoes = parseInt(motorista.quantidade_reprovacoes) || 0;
            const historicoReprovacoes = motorista.historico_reprovacoes || [];
            
            // Verificar status completo do motorista para esta coleta
            const statusInfo = verificarStatusMotoristaPorColeta(motorista, coleta);
            const statusMotorista = statusInfo.status; // 'neutro', 'aprovado', 'reprovado'
            
            // Extrair informações
            const isReprovado = statusMotorista === 'reprovado';
            const isAprovado = statusMotorista === 'aprovado';
            const isNeutro = statusMotorista === 'neutro';
            const motivoReprovacaoEstaColeta = statusInfo.motivo;
            const reprovadoPorEstaColeta = statusInfo.reprovado_por;
            const dataReprovacaoEstaColeta = statusInfo.data_reprovacao;
            const aprovadoPorEstaColeta = statusInfo.aprovado_por;
            const dataAprovacaoEstaColeta = statusInfo.data_aprovacao;
            
            // Log para debug - SEMPRE exibir para identificar o problema
            console.log('🔍 Verificando status do motorista (POR COLETA):', {
                coleta_id: coleta.id,
                etapa_atual: coleta.etapa_atual,
                gr_aprovado: coleta.gr_aprovado,
                motorista_id: motorista.id,
                nome: motorista.nome,
                status: statusMotorista,
                motivo_reprovacao: motivoReprovacaoEstaColeta,
                quantidade_reprovacoes_total: quantidadeReprovacoes,
                historico_length: Array.isArray(historicoReprovacoes) ? historicoReprovacoes.length : 'N/A'
            });
            
            // Determinar cores baseado no status
            let bgColor, borderColor, iconColor, iconClass;
            
            if (statusMotorista === 'reprovado') {
                bgColor = 'linear-gradient(135deg, rgba(220, 53, 69, 0.2) 0%, rgba(200, 35, 51, 0.25) 100%)';
                borderColor = '#dc3545';
                iconColor = '#dc3545';
                iconClass = 'fa-user-times';
            } else if (statusMotorista === 'aprovado') {
                bgColor = 'linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(32, 201, 151, 0.1) 100%)';
                borderColor = '#28a745';
                iconColor = '#28a745';
                iconClass = 'fa-user-check';
            } else {
                // Status neutro (pendente de análise GR)
                bgColor = 'linear-gradient(135deg, rgba(108, 117, 125, 0.1) 0%, rgba(134, 142, 150, 0.1) 100%)';
                borderColor = '#6c757d';
                iconColor = '#6c757d';
                iconClass = 'fa-user-clock';
            }
            
            return `
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <!-- Card Principal do Motorista -->
                    <div style="padding: 1.5rem; background: ${bgColor}; border-radius: 12px; border: 2px solid ${borderColor}; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);">
                        <!-- Header com Nome e Status -->
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
                            <div style="flex: 1;">
                                <h3 style="color: ${iconColor}; margin: 0 0 0.5rem 0; font-size: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas ${iconClass}"></i> ${escapeHtml(motorista.nome || 'N/A')}
                                </h3>
                                ${statusMotorista === 'reprovado' ? `
                                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.5rem; flex-wrap: wrap;">
                                        <span style="background: #dc3545; color: white; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.8rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4); animation: piscarBadgeUrgente 1.5s ease-in-out infinite;">
                                            <i class="fas fa-times-circle"></i> ${coleta.etapa_atual === 'contratacao' ? 'REPROVADO NO GR' : 'MOTORISTA REPROVADO'}
                                        </span>
                                        ${quantidadeReprovacoes > 0 ? `
                                            <span style="background: rgba(220, 53, 69, 0.2); color: #dc3545; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; border: 1px solid rgba(220, 53, 69, 0.3);">
                                                ${quantidadeReprovacoes} reprovação(ões)
                                            </span>
                                        ` : ''}
                                    </div>
                                ` : statusMotorista === 'aprovado' ? `
                                    <span style="background: #28a745; color: white; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; margin-top: 0.5rem;">
                                        <i class="fas fa-check-circle"></i> APROVADO NO GR
                                    </span>
                                ` : `
                                    <span style="background: #6c757d; color: white; padding: 0.3rem 0.8rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-block; margin-top: 0.5rem;">
                                        <i class="fas fa-clock"></i> PENDENTE DE ANÁLISE GR
                                    </span>
                                `}
                            </div>
                        </div>
                        
                        ${isReprovado && motivoReprovacaoEstaColeta ? `
                            <div style="background: rgba(220, 53, 69, 0.15); border-left: 4px solid #dc3545; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
                                <div style="color: #dc3545; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                    <i class="fas fa-info-circle"></i> Motivo da Reprovação (Esta Coleta)
                                </div>
                                <div style="color: #721c24; font-size: 0.9rem; line-height: 1.5;">
                                    ${escapeHtml(motivoReprovacaoEstaColeta)}
                                </div>
                                ${reprovadoPorEstaColeta && dataReprovacaoEstaColeta ? `
                                    <div style="color: #6c757d; font-size: 0.8rem; margin-top: 0.5rem; font-style: italic;">
                                        Por ${escapeHtml(reprovadoPorEstaColeta)} em ${new Date(dataReprovacaoEstaColeta).toLocaleDateString('pt-BR')} às ${new Date(dataReprovacaoEstaColeta).toLocaleTimeString('pt-BR')}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                        
                        ${isAprovado && aprovadoPorEstaColeta && dataAprovacaoEstaColeta ? `
                            <div style="background: rgba(40, 167, 69, 0.1); border-left: 4px solid #28a745; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
                                <div style="color: #28a745; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                    <i class="fas fa-check-circle"></i> Aprovado no GR
                                </div>
                                <div style="color: #155724; font-size: 0.85rem; line-height: 1.5;">
                                    Motorista aprovado por ${escapeHtml(aprovadoPorEstaColeta)} em ${new Date(dataAprovacaoEstaColeta).toLocaleDateString('pt-BR')} às ${new Date(dataAprovacaoEstaColeta).toLocaleTimeString('pt-BR')}
                                </div>
                            </div>
                        ` : ''}
                        
                        ${isNeutro ? `
                            <div style="background: rgba(108, 117, 125, 0.1); border-left: 4px solid #6c757d; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
                                <div style="color: #6c757d; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                    <i class="fas fa-clock"></i> Pendente de Análise GR
                                </div>
                                <div style="color: #495057; font-size: 0.85rem; line-height: 1.5;">
                                    Este motorista ainda não passou pela etapa GR. O status será definido após a análise do GR.
                                </div>
                            </div>
                        ` : ''}
                        
                        ${quantidadeReprovacoes > 0 && !isReprovado ? `
                            <div style="background: rgba(255, 193, 7, 0.1); border-left: 4px solid #ffc107; padding: 1rem; border-radius: 6px; margin-bottom: 1.5rem;">
                                <div style="color: #856404; font-weight: 600; margin-bottom: 0.5rem; font-size: 0.9rem;">
                                    <i class="fas fa-info-circle"></i> Histórico de Reprovações
                                </div>
                                <div style="color: #856404; font-size: 0.85rem; line-height: 1.5;">
                                    Este motorista possui <strong>${quantidadeReprovacoes}</strong> reprovação(ões) em outras coletas, mas está <strong>${isAprovado ? 'aprovado' : 'pendente de análise'}</strong> para esta coleta.
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Informações do Motorista em Grid -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                            ${motorista.cnh ? `
                                <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.1);">
                                    <div style="color: #6b7280; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.5px;">
                                        <i class="fas fa-id-card" style="color: #667eea;"></i> CNH
                                    </div>
                                    <div style="color: #1f2937; font-size: 1.1rem; font-weight: 600;">${escapeHtml(motorista.cnh)}</div>
                                    ${motorista.categoria_cnh ? `
                                        <div style="color: #6b7280; font-size: 0.85rem; margin-top: 0.25rem;">Categoria: ${escapeHtml(motorista.categoria_cnh)}</div>
                                    ` : ''}
                                </div>
                            ` : ''}
                            
                            ${motorista.telefone1 ? `
                                <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.1);">
                                    <div style="color: #6b7280; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.5px;">
                                        <i class="fas fa-phone" style="color: #10b981;"></i> Telefone 1
                                    </div>
                                    <div style="color: #1f2937; font-size: 1.1rem; font-weight: 600;">
                                        <a href="tel:${motorista.telefone1}" style="color: #1f2937; text-decoration: none;">${escapeHtml(motorista.telefone1)}</a>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${motorista.telefone2 ? `
                                <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.1);">
                                    <div style="color: #6b7280; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.5px;">
                                        <i class="fas fa-phone" style="color: #10b981;"></i> Telefone 2
                                    </div>
                                    <div style="color: #1f2937; font-size: 1.1rem; font-weight: 600;">
                                        <a href="tel:${motorista.telefone2}" style="color: #1f2937; text-decoration: none;">${escapeHtml(motorista.telefone2)}</a>
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${motorista.estado ? `
                                <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.1);">
                                    <div style="color: #6b7280; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.5px;">
                                        <i class="fas fa-map-marker-alt" style="color: #f59e0b;"></i> Estado
                                    </div>
                                    <div style="color: #1f2937; font-size: 1.1rem; font-weight: 600;">${escapeHtml(motorista.estado)}</div>
                                </div>
                            ` : ''}
                            
                            ${motorista.classe_veiculo ? `
                                <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.1);">
                                    <div style="color: #6b7280; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.5px;">
                                        <i class="fas fa-truck" style="color: #8b5cf6;"></i> Classe Veículo
                                    </div>
                                    <div style="color: #1f2937; font-size: 1.1rem; font-weight: 600;">${escapeHtml(motorista.classe_veiculo)}</div>
                                </div>
                            ` : ''}
                            
                            ${motorista.placa_cavalo ? `
                                <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.1);">
                                    <div style="color: #6b7280; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.5px;">
                                        <i class="fas fa-car" style="color: #ec4899;"></i> Placa Cavalo
                                    </div>
                                    <div style="color: #1f2937; font-size: 1.1rem; font-weight: 600;">${escapeHtml(motorista.placa_cavalo)}</div>
                                </div>
                            ` : ''}
                            
                            ${motorista.tipo_veiculo ? `
                                <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.1);">
                                    <div style="color: #6b7280; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.5px;">
                                        <i class="fas fa-truck-pickup" style="color: #06b6d4;"></i> Tipo Veículo
                                    </div>
                                    <div style="color: #1f2937; font-size: 1.1rem; font-weight: 600;">${escapeHtml(motorista.tipo_veiculo)}</div>
                                </div>
                            ` : ''}
                            
                            ${motorista.tipo_carroceria ? `
                                <div style="background: white; padding: 1rem; border-radius: 8px; border: 1px solid rgba(0, 0, 0, 0.1);">
                                    <div style="color: #6b7280; font-size: 0.75rem; font-weight: 600; text-transform: uppercase; margin-bottom: 0.5rem; letter-spacing: 0.5px;">
                                        <i class="fas fa-box" style="color: #f97316;"></i> Tipo Carroceria
                                    </div>
                                    <div style="color: #1f2937; font-size: 1.1rem; font-weight: 600;">${escapeHtml(motorista.tipo_carroceria)}</div>
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Histórico de Reprovações -->
                        ${historicoReprovacoes && historicoReprovacoes.length > 0 ? `
                            <div style="background: rgba(220, 53, 69, 0.05); border: 1px solid rgba(220, 53, 69, 0.2); border-radius: 8px; padding: 1rem; margin-bottom: 1.5rem;">
                                <div style="color: #dc3545; font-weight: 600; margin-bottom: 1rem; font-size: 0.9rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-history"></i> Histórico de Reprovações (${historicoReprovacoes.length})
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0.75rem; max-height: 200px; overflow-y: auto;">
                                    ${historicoReprovacoes.map((reprovacao, index) => `
                                        <div style="background: white; padding: 0.75rem; border-radius: 6px; border-left: 3px solid #dc3545;">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.25rem;">
                                                <div style="color: #dc3545; font-weight: 600; font-size: 0.85rem;">
                                                    Reprovação #${index + 1}
                                                </div>
                                                ${reprovacao.data_reprovacao ? `
                                                    <div style="color: #6b7280; font-size: 0.75rem;">
                                                        ${new Date(reprovacao.data_reprovacao).toLocaleDateString('pt-BR')}
                                                    </div>
                                                ` : ''}
                                            </div>
                                            ${reprovacao.motivo ? `
                                                <div style="color: #374151; font-size: 0.85rem; margin-bottom: 0.25rem;">
                                                    ${escapeHtml(reprovacao.motivo)}
                                                </div>
                                            ` : ''}
                                            ${reprovacao.reprovado_por ? `
                                                <div style="color: #6b7280; font-size: 0.75rem; font-style: italic;">
                                                    Por: ${escapeHtml(reprovacao.reprovado_por)}
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Botões de Ação -->
                        ${temPermissao ? `
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap; padding-top: 1.5rem; border-top: 2px solid ${borderColor};">
                                <button onclick="trocarMotorista('${coleta.id}')" 
                                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); transition: all 0.3s; flex: 1; min-width: 150px;"
                                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(102, 126, 234, 0.4)';"
                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(102, 126, 234, 0.3)';">
                                    <i class="fas fa-exchange-alt"></i> Trocar Motorista
                                </button>
                                <button onclick="verDetalhesMotorista('${coleta.id}')" 
                                        style="background: white; color: #667eea; border: 2px solid #667eea; padding: 0.75rem 1.5rem; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s; flex: 1; min-width: 150px;"
                                        onmouseover="this.style.background='#667eea'; this.style.color='white';"
                                        onmouseout="this.style.background='white'; this.style.color='#667eea';">
                                    <i class="fas fa-info-circle"></i> Ver Detalhes
                                </button>
                                <button onclick="visualizarTermoAceito('${coleta.id}')" 
                                        style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 10px; cursor: pointer; font-weight: 600; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); transition: all 0.3s; flex: 1; min-width: 150px;"
                                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 16px rgba(16, 185, 129, 0.4)';"
                                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)';">
                                    <i class="fas fa-file-signature"></i> Ver Termo Aceito
                                </button>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderTabITs(its) {
            if (!its || its.length === 0) {
                return `
                    <div style="text-align: center; padding: 3rem; color: #999;">
                        <i class="fas fa-file-alt fa-3x" style="margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>Nenhuma IT relacionada encontrada</p>
                    </div>
                `;
            }
            
            return `
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    ${its.map(it => `
                        <div style="border: 1px solid #e5e7eb; border-radius: 8px; padding: 1rem; border-left: 4px solid #667eea;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div>
                                    ${it.codigo_it ? `<span style="background: #667eea; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; margin-right: 0.5rem;">${it.codigo_it}</span>` : ''}
                                    <strong>${escapeHtml(it.nome)}</strong>
                                </div>
                            </div>
                            ${it.area ? `<div style="color: #666; font-size: 0.85rem; margin-bottom: 0.5rem;"><i class="fas fa-building"></i> ${escapeHtml(it.area)}</div>` : ''}
                            <div style="display: flex; gap: 0.5rem;">
                                <a href="${it.url}" target="_blank" 
                                   style="background: #667eea; color: white; padding: 0.5rem 1rem; border-radius: 6px; text-decoration: none; font-size: 0.85rem;">
                                    <i class="fas fa-eye"></i> Visualizar
                                </a>
                                <a href="${it.url}" download="${it.nome_arquivo || 'it.pdf'}"
                                   style="background: transparent; color: #667eea; border: 1px solid #667eea; padding: 0.5rem 1rem; border-radius: 6px; text-decoration: none; font-size: 0.85rem;">
                                    <i class="fas fa-download"></i> Baixar
                                </a>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderTabHistorico(historico) {
            if (!historico || historico.length === 0) {
                return `
                    <div style="text-align: center; padding: 3rem; color: #999;">
                        <i class="fas fa-history fa-3x" style="margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>Nenhuma movimentação registrada</p>
                    </div>
                `;
            }
            
            return `
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    ${historico.map(item => `
                        <div style="border-left: 3px solid #667eea; padding-left: 1rem; padding: 1rem; background: rgba(102, 126, 234, 0.05); border-radius: 6px;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                <div style="font-weight: 600; color: #667eea;">${getTextoAcao(item.acao)}</div>
                                <div style="color: #999; font-size: 0.85rem;">${formatarDataHora(item.created_at)}</div>
                            </div>
                            <div style="color: #666; font-size: 0.9rem;">${escapeHtml(item.detalhes || 'Sem detalhes')}</div>
                            ${item.usuario || item.usuario_nome ? `
                                <div style="color: #999; font-size: 0.8rem; margin-top: 0.5rem;">
                                    <i class="fas fa-user"></i> ${item.usuario || item.usuario_nome || 'Sistema'}
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderTabChat(coletaId) {
            return `
                <div id="kanban-chat-container-${coletaId}" style="min-height: 400px;">
                    <div style="text-align: center; padding: 2rem; color: #999;">
                        <i class="fas fa-comment fa-2x" style="margin-bottom: 1rem; opacity: 0.3;"></i>
                        <p>Chat será carregado aqui</p>
                        <button onclick="openChatModal('${coletaId}')" 
                                style="background: #667eea; color: white; border: none; padding: 0.75rem 1.5rem; border-radius: 8px; cursor: pointer; font-weight: 600; margin-top: 1rem;">
                            <i class="fas fa-external-link-alt"></i> Abrir Chat Completo
                        </button>
                    </div>
                </div>
            `;
        }

        async function carregarITsRelacionadasParaDrawer(nomeCliente, filial) {
            try {
                const response = await fetch(`/api/clientes/nome/${encodeURIComponent(nomeCliente)}/its${filial ? `?filial=${encodeURIComponent(filial)}` : ''}`, {
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const result = await response.json();
                    return result.success && result.its ? result.its : [];
                }
                return [];
            } catch (e) {
                console.error('Erro ao carregar ITs:', e);
                return [];
            }
        }

        // ========== MOVER PARA ETAPA NO DRAWER ==========
        async function moverParaEtapaDrawer(coletaId, novaEtapaId) {
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta) {
                showNotification('Coleta não encontrada', 'error');
                return;
            }

            // Verificar se é a mesma etapa
            if (coleta.etapa_atual === novaEtapaId) {
                showNotification('Esta já é a etapa atual', 'info');
                return;
            }

            // ✅ VALIDAÇÃO: Não pode sair de contratação sem motorista
            if (coleta.etapa_atual === 'contratacao' && !coleta.motorista_id) {
                showNotification('⚠️ Para mover uma coleta da etapa Contratação, é necessário vincular um motorista à coleta.', 'warning');
                return;
            }

            // ✅ Não pode ir para a etapa GR sem motorista vinculado
            if (novaEtapaId === 'gr' && !coleta.motorista_id) {
                showNotification('⚠️ Para mover para a etapa GR, é necessário vincular um motorista à coleta.', 'warning');
                return;
            }

            // ✅ Só bloqueia se o motorista já foi reprovado NESTA coleta (gr_aprovado === false).
            // Ao mover para a etapa GR, sempre permitir – o GR fará nova avaliação.
            const reprovadoNestaColeta = coleta.gr_aprovado === false || coleta.gr_aprovado === 'false' || coleta.gr_aprovado === 0;
            if (coleta.etapa_atual === 'contratacao' && coleta.motorista_id && reprovadoNestaColeta && novaEtapaId !== 'gr') {
                showNotification('⚠️ O motorista foi reprovado pelo GR nesta coleta. Troque o motorista ou mova para a etapa GR para nova avaliação.', 'warning');
                return;
            }

            // ✅ VALIDAÇÃO: Não pode sair de GR sem aprovação ou reprovação
            if (isEtapaGR(coleta.etapa_atual)) {
                // Verificar se GR foi aprovado ou reprovado
                if (coleta.gr_aprovado === null || coleta.gr_aprovado === undefined) {
                    showNotification('⚠️ Para mover uma coleta da etapa GR, é necessário aprovar ou reprovar a coleta primeiro.\n\nUse os botões "Aprovar GR" ou "Reprovar GR" no card da coleta.', 'warning');
                    return;
                }
                
                const etapaAtualIndex = ETAPAS.findIndex(e => e.id === coleta.etapa_atual);
                const novaEtapaIndex = ETAPAS.findIndex(e => e.id === novaEtapaId);
                
                // Se foi reprovado, não pode avançar (deve estar em contratação)
                if (coleta.gr_aprovado === false) {
                    if (novaEtapaIndex > etapaAtualIndex) {
                        showNotification('⚠️ Esta coleta foi reprovada pelo GR e não pode avançar. Ela deve voltar para a etapa de Contratação.', 'warning');
                        return;
                    }
                }
                
                // Se foi aprovado, pode avançar para documentação sempre
                // Também permite outras etapas através de automações configuradas
                // Aceitar true, 'true', 1, '1' como aprovado
                const grAprovado = coleta.gr_aprovado === true || 
                                   coleta.gr_aprovado === 'true' || 
                                   coleta.gr_aprovado === 1 || 
                                   coleta.gr_aprovado === '1';
                
                if (grAprovado && novaEtapaId === 'documentacao') {
                    // Permitir movimento para documentacao sempre - não bloquear
                } else if (grAprovado && novaEtapaId !== 'documentacao' && novaEtapaIndex > etapaAtualIndex) {
                    // Se está tentando ir para outra etapa além de documentacao, permitir
                    // As automações no backend irão decidir se aplica ou não
                    // Não bloquear aqui para dar flexibilidade
                }
            }
            
            // ✅ VALIDAÇÃO: Não pode avançar para documentação ou monitoramento sem aprovação no GR
            const etapasQueRequeremAprovacaoGR = ['documentacao', 'monitoramento'];
            if (etapasQueRequeremAprovacaoGR.includes(novaEtapaId)) {
                // Verificar se o motorista foi aprovado no GR
                if (!coleta.motorista_id) {
                    showNotification('⚠️ Para avançar para esta etapa, é necessário ter um motorista vinculado e aprovado no GR.', 'warning');
                    return;
                }
                
                // Verificar se passou pelo GR e foi aprovado
                // Aceitar true, 'true', 1, '1' como aprovado
                const grAprovado = coleta.gr_aprovado === true || 
                                   coleta.gr_aprovado === 'true' || 
                                   coleta.gr_aprovado === 1 || 
                                   coleta.gr_aprovado === '1';
                
                if (!grAprovado) {
                    if (coleta.gr_aprovado === false) {
                        showNotification('⚠️ Esta coleta foi reprovada pelo GR. Não é possível avançar para esta etapa. É necessário aprovar o motorista no GR primeiro.', 'warning');
                    } else {
                        showNotification('⚠️ Para avançar para esta etapa, o motorista deve ser aprovado no GR primeiro.', 'warning');
                    }
                    return;
                }
                
                // Verificar também se o motorista não está reprovado para esta coleta
                try {
                    const motorista = await buscarMotoristaPorId(coleta.motorista_id);
                    if (motorista) {
                        // ✅ CORREÇÃO: Passar o objeto coleta completo, não apenas o ID
                        const statusInfo = verificarStatusMotoristaPorColeta(motorista, coleta);
                        console.log('🔍 Status do motorista verificado:', {
                            coleta_id: coleta.id,
                            etapa_atual: coleta.etapa_atual,
                            gr_aprovado: coleta.gr_aprovado,
                            status_motorista: statusInfo.status
                        });
                        
                        if (statusInfo.status === 'reprovado') {
                            showNotification('⚠️ O motorista vinculado está reprovado para esta coleta. Não é possível avançar para esta etapa.', 'warning');
                            return;
                        }
                        // ✅ CORREÇÃO: Se gr_aprovado === true, considerar aprovado mesmo se statusInfo não retornar 'aprovado'
                        // Isso resolve o caso onde o motorista foi aprovado mas a função não detectou corretamente
                        if (statusInfo.status !== 'aprovado' && coleta.gr_aprovado !== true) {
                            showNotification('⚠️ O motorista deve ser aprovado no GR antes de avançar para esta etapa.', 'warning');
                            return;
                        }
                    }
                } catch (err) {
                    console.warn('⚠️ Erro ao verificar status do motorista:', err);
                    showNotification('⚠️ Erro ao verificar status do motorista. Não é possível avançar.', 'warning');
                    return;
                }
            }

            // Confirmar movimentação
            const etapaAtualNome = obterNomeEtapa(coleta.etapa_atual);
            const novaEtapaNome = obterNomeEtapa(novaEtapaId);
            const confirmar = confirm(`Deseja mover esta coleta de "${etapaAtualNome}" para "${novaEtapaNome}"?`);
            
            if (!confirmar) return;

            // Mostrar loading no drawer
            const drawerContent = document.getElementById('kanbanDrawerContent');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'drawer-mover-etapa-loading';
            loadingDiv.innerHTML = `
                <div style="text-align: center; padding: 1rem; background: rgba(102, 126, 234, 0.1); border-radius: 8px; margin-bottom: 1rem;">
                    <i class="fas fa-spinner fa-spin"></i> Movendo para ${novaEtapaNome}...
                </div>
            `;
            const geralTab = document.getElementById('tab-geral');
            if (geralTab) {
                geralTab.insertBefore(loadingDiv, geralTab.firstChild);
            }

            try {
                // Usar a função moverEtapa existente
                await moverEtapa(coletaId, novaEtapaId);
                
                // Recarregar coletas para atualizar o Kanban
                await carregarColetas();
                
                // Recarregar o conteúdo do drawer
                await carregarConteudoDrawer(coletaId);
                
                showNotification(`✅ Coleta movida para ${novaEtapaNome}`, 'success');
            } catch (error) {
                console.error('Erro ao mover etapa:', error);
                showNotification('Erro ao mover etapa: ' + error.message, 'error');
            } finally {
                const loading = document.getElementById('drawer-mover-etapa-loading');
                if (loading) loading.remove();
            }
        }


        let draggedCard = null;
        let draggedFromEtapa = null;

        function handleKanbanDragStart(e) {
            if (!e.target.classList.contains('kanban-card') || e.target.classList.contains('no-drag')) {
                e.preventDefault();
                return false;
            }
            draggedCard = e.target;
            draggedFromEtapa = e.target.getAttribute('data-etapa-atual');
            e.target.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.outerHTML);
        }

        function handleKanbanDragEnd(e) {
            if (draggedCard) {
                draggedCard.classList.remove('dragging');
                draggedCard = null;
            }
            document.querySelectorAll('.kanban-drop-zone').forEach(zone => {
                zone.classList.remove('drag-over');
            });
        }

        function handleKanbanDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const dropZone = e.currentTarget;
            dropZone.classList.add('drag-over');
        }

        // ✅ FUNÇÕES DE ORDENAÇÃO DO KANBAN
        function toggleSortMenu(etapaId, event) {
            event.stopPropagation();
            
            // Fechar todos os menus abertos
            document.querySelectorAll('.kanban-sort-menu.show').forEach(menu => {
                if (menu.id !== `sortMenu_${etapaId}`) {
                    menu.classList.remove('show');
                }
            });
            
            // Toggle do menu atual
            const menu = document.getElementById(`sortMenu_${etapaId}`);
            if (menu) {
                menu.classList.toggle('show');
            }
        }
        
        function aplicarOrdenacao(etapaId, tipoOrdenacao) {
            // Salvar preferência
            if (tipoOrdenacao === 'padrao') {
                delete ordenacaoKanban[etapaId];
            } else {
                ordenacaoKanban[etapaId] = { tipo: tipoOrdenacao };
            }
            
            salvarOrdenacaoKanban();
            
            // Fechar menu
            const menu = document.getElementById(`sortMenu_${etapaId}`);
            if (menu) {
                menu.classList.remove('show');
            }
            
            // Re-renderizar kanban para aplicar ordenação
            renderColetasKanban();
        }
        
        // Fechar menus ao clicar fora (uma vez só)
        if (!window.kanbanSortMenuListenerAdded) {
            document.addEventListener('click', (e) => {
                if (!e.target.closest('.kanban-sort-btn') && !e.target.closest('.kanban-sort-menu')) {
                    document.querySelectorAll('.kanban-sort-menu.show').forEach(menu => {
                        menu.classList.remove('show');
                    });
                }
            });
            window.kanbanSortMenuListenerAdded = true;
        }

        function handleKanbanDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        // ========== FUNÇÕES DO MODAL DE MOVIMENTAÇÃO ==========
        let coletaMovendoId = null;
        let todosFunisDisponiveis = [];

        async function abrirModalMoverColeta(coletaId) {
            coletaMovendoId = coletaId;
            const coleta = coletasData.find(c => c.id === coletaId);
            
            if (!coleta) {
                alert('Coleta não encontrada.');
                return;
            }

            // Validar permissão na etapa atual
            if (!temPermissaoEtapa(coleta.etapa_atual)) {
                alert('⚠️ Você não tem permissão para mover coletas desta etapa.');
                return;
            }

            // Atualizar preview
            const previewTitle = document.getElementById('modalMoverColetaPreviewTitle');
            const previewInfo = document.getElementById('modalMoverColetaPreviewInfo');
            
            if (previewTitle) {
                previewTitle.textContent = coleta.cliente || 'Sem cliente';
            }
            if (previewInfo) {
                const etapaAtualNome = obterNomeEtapa(coleta.etapa_atual);
                previewInfo.innerHTML = `
                    <strong>Etapa Atual:</strong> ${etapaAtualNome}<br>
                    ${coleta.filial ? `<strong>Filial:</strong> ${coleta.filial}` : ''}
                    ${coleta.numero_coleta ? ` | <strong>Coleta #${coleta.numero_coleta}</strong>` : ''}
                `;
            }

            // Carregar funis disponíveis
            await carregarFunisParaModal();

            // Pre-selecionar funil atual (se existir)
            const selectFunil = document.getElementById('selectFunilDestino');
            const selectEtapa = document.getElementById('selectEtapaDestino');
            const btnConfirmar = document.getElementById('btnConfirmarMovimentacao');

            if (selectFunil) {
                selectFunil.value = '';
                // ✅ CRÍTICO: Chamar atualizarEtapasDoFunil diretamente para garantir que limpe
                atualizarEtapasDoFunil();
            }
            if (selectEtapa) {
                selectEtapa.innerHTML = '<option value="">Selecione primeiro um funil</option>';
                selectEtapa.disabled = true;
            }
            if (btnConfirmar) {
                btnConfirmar.disabled = true;
            }

            // Mostrar modal
            const modal = document.getElementById('modalMoverColeta');
            if (modal) {
                modal.classList.add('active');
            }
        }

        function fecharModalMoverColeta() {
            const modal = document.getElementById('modalMoverColeta');
            if (modal) {
                modal.classList.remove('active');
            }
            coletaMovendoId = null;
        }

        // ========== FUNÇÕES PARA MODAL DE CONFIRMAR PAGAMENTO ==========
        let coletaPagamentoId = null;

        async function abrirModalConfirmarPagamento(coletaId) {
            console.log('🔍 abrirModalConfirmarPagamento chamado com coletaId:', coletaId);
            // Garantir que o ID seja string para comparação
            const coletaIdStr = String(coletaId);
            coletaPagamentoId = coletaIdStr;
            
            // Tentar encontrar a coleta em coletasData primeiro (comparando como strings)
            let coleta = coletasData?.find(c => String(c.id) === coletaIdStr) || null;
            
            // Se não encontrar, tentar buscar do Supabase
            if (!coleta) {
                console.log('⚠️ Coleta não encontrada em coletasData, tentando buscar do Supabase...');
                try {
                    if (!supabaseClient) {
                        console.error('❌ Supabase não inicializado');
                        showNotification('Erro: Sistema não inicializado. Recarregue a página.', 'error');
                        return;
                    }
                    
                    const { data: coletaData, error: coletaError } = await supabaseClient
                        .from('coletas')
                        .select('*')
                        .eq('id', coletaIdStr)
                        .single();
                    
                    if (coletaError || !coletaData) {
                        console.error('❌ Erro ao buscar coleta do Supabase:', coletaError);
                        showNotification('Coleta não encontrada. Verifique se o ID está correto.', 'error');
                        return;
                    }
                    
                    console.log('✅ Coleta encontrada no Supabase');
                    coleta = coletaData;
                    // Adicionar ao coletasData para uso futuro
                    if (coletasData && !coletasData.find(c => String(c.id) === String(coletaData.id))) {
                        coletasData.push(coletaData);
                    }
                } catch (error) {
                    console.error('❌ Erro ao buscar coleta:', error);
                    showNotification('Erro ao buscar dados da coleta. Tente novamente.', 'error');
                    return;
                }
            }

            // Atualizar preview
            const preview = document.getElementById('confirmarPagamentoPreview');
            if (preview) {
                preview.innerHTML = `
                    <p style="margin: 0; font-weight: 600; margin-bottom: 0.5rem;">${escapeHtml(coleta.cliente || 'Sem cliente')}</p>
                    <p style="margin: 0; font-size: 0.9rem; color: #666;">
                        ${coleta.filial ? `<strong>Filial:</strong> ${coleta.filial}` : ''}
                        ${coleta.numero_coleta ? ` | <strong>Coleta #${coleta.numero_coleta}</strong>` : ''}
                        ${coleta.valor ? ` | <strong>Valor:</strong> R$ ${(coleta.valor || 0).toFixed(2)}` : ''}
                    </p>
                `;
            }

            // Limpar campos
            const tipoPagamento = document.getElementById('tipoPagamentoConfirmar');
            const valorPagamento = document.getElementById('valorPagamentoConfirmar');
            const observacoes = document.getElementById('observacoesPagamento');
            if (tipoPagamento) tipoPagamento.value = '';
            if (valorPagamento) valorPagamento.value = '';
            if (observacoes) observacoes.value = '';

            // Mostrar modal
            const modal = document.getElementById('modalConfirmarPagamento');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        function fecharModalConfirmarPagamento() {
            const modal = document.getElementById('modalConfirmarPagamento');
            if (modal) {
                modal.style.display = 'none';
            }
            coletaPagamentoId = null;
        }

        // ========== FUNÇÃO PARA ENVIAR LINK DE RASTREAMENTO VIA WHATSAPP ==========
        async function enviarLinkRastreamento(coletaId) {
            const coleta = coletasData.find(c => c.id === coletaId);
            
            if (!coleta) {
                showNotification('Coleta não encontrada.', 'error');
                return;
            }

            // Verificar se há motorista vinculado
            if (!coleta.motorista_id) {
                showNotification('⚠️ Esta coleta não possui motorista vinculado. É necessário vincular um motorista antes de enviar o link de rastreamento.', 'warning');
                return;
            }

            // Buscar dados completos do motorista para obter o telefone
            showNotification('🔍 Buscando dados do motorista...', 'info');
            let motorista = null;
            let telefoneMotorista = null;

            try {
                // Buscar motorista completo
                motorista = await buscarMotoristaPorId(coleta.motorista_id);
                
                if (!motorista) {
                    showNotification('⚠️ Não foi possível carregar os dados do motorista. Tente novamente.', 'warning');
                    return;
                }

                // Tentar obter telefone do motorista (telefone1 tem prioridade, depois telefone2)
                telefoneMotorista = motorista.telefone1 || motorista.telefone2 || null;

                if (!telefoneMotorista) {
                    showNotification('⚠️ Este motorista não possui telefone cadastrado. É necessário cadastrar um telefone antes de enviar o link.', 'warning');
                    return;
                }
            } catch (error) {
                console.error('❌ Erro ao buscar motorista:', error);
                showNotification('⚠️ Erro ao buscar dados do motorista. Tente novamente.', 'error');
                return;
            }

            // Formatar telefone (remover caracteres não numéricos)
            telefoneMotorista = telefoneMotorista.replace(/\D/g, '');
            
            // Garantir que o telefone tenha DDD (adicionar se não tiver)
            if (telefoneMotorista.length === 10 || telefoneMotorista.length === 11) {
                // Já tem DDD, usar como está
            } else if (telefoneMotorista.length === 8 || telefoneMotorista.length === 9) {
                // Não tem DDD, adicionar DDD padrão (pode ser ajustado)
                telefoneMotorista = '55' + telefoneMotorista; // Adicionar código do país + DDD padrão
            } else if (telefoneMotorista.length < 8) {
                showNotification('⚠️ Número de telefone inválido. Deve ter pelo menos 8 dígitos.', 'warning');
                return;
            }
            
            // Validar formato final do telefone (deve ter pelo menos 10 dígitos com DDD)
            if (telefoneMotorista.length < 10) {
                showNotification('⚠️ Número de telefone inválido. Verifique o formato.', 'warning');
                return;
            }

            // Gerar link único para o motorista aceitar o termo e iniciar rastreamento
            const baseUrl = window.location.origin;
            const linkRastreamento = `${baseUrl}/termo-rastreamento.html?coleta=${coletaId}`;
            
            // Mensagem para o WhatsApp (limitada a 4096 caracteres)
            const mensagem = `Olá ${motorista.nome || 'motorista'}! Você foi designado para a coleta #${coleta.numero_coleta || coletaId}.\n\n` +
                           `Cliente: ${coleta.cliente || 'N/A'}\n` +
                           `Origem: ${coleta.origem || 'N/A'}\n` +
                           `Destino: ${coleta.destino || 'N/A'}\n\n` +
                           `Para aceitar o termo de rastreamento e iniciar o monitoramento, clique no link abaixo:\n${linkRastreamento}\n\n` +
                           `Ao clicar no link, você será redirecionado para a página de aceite do termo. Após aceitar, o rastreamento será ativado automaticamente.`;

            // Obter userId do usuário logado
            let userId = null;
            let usuarioEmail = null;
            
            try {
                // Tentar obter do localStorage
                const loggedInUserData = localStorage.getItem('loggedInUser');
                if (loggedInUserData) {
                    const userData = JSON.parse(loggedInUserData);
                    userId = userData.id || userData.userId;
                    usuarioEmail = userData.email || userData.username;
                }
                
                // Se não encontrou, tentar obter da sessão do Supabase
                if (!userId && window.supabase) {
                    try {
                        const { data: { session } } = await window.supabase.auth.getSession();
                        if (session?.user) {
                            userId = session.user.id;
                            usuarioEmail = session.user.email;
                        }
                    } catch (supabaseError) {
                        console.warn('⚠️ Erro ao obter sessão do Supabase:', supabaseError);
                    }
                }
            } catch (error) {
                console.warn('⚠️ Erro ao obter dados do usuário:', error);
            }

            if (!userId && !usuarioEmail) {
                showNotification('⚠️ Não foi possível identificar o usuário logado. Faça login novamente.', 'warning');
                return;
            }

            // Mostrar loading
            showNotification('📤 Enviando mensagem via WhatsApp...', 'info');

            try {
                // Preparar FormData para enviar via Evolution API
                const formData = new FormData();
                formData.append('number', telefoneMotorista);
                formData.append('message', mensagem);
                if (userId) {
                    formData.append('userId', userId);
                }
                if (usuarioEmail) {
                    formData.append('usuario', usuarioEmail);
                }

                // Enviar via Evolution API usando as credenciais do usuário
                const response = await fetch('/webhook/send-supabase', {
                    method: 'POST',
                    credentials: 'include',
                    body: formData
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showNotification('✅ Mensagem enviada com sucesso via WhatsApp!', 'success');
                    console.log('✅ Mensagem enviada:', {
                        coletaId: coletaId,
                        telefone: telefoneMotorista,
                        motorista: coleta.motorista_nome || 'N/A',
                        link: linkRastreamento
                    });
                } else {
                    const errorMsg = result.error || 'Erro ao enviar mensagem';
                    showNotification(`❌ Erro ao enviar: ${errorMsg}`, 'error');
                    console.error('❌ Erro ao enviar mensagem:', result);
                }
            } catch (error) {
                console.error('❌ Erro ao enviar mensagem:', error);
                showNotification('❌ Erro ao enviar mensagem. Tente novamente.', 'error');
            }
        }

        // Expor função globalmente
        window.enviarLinkRastreamento = enviarLinkRastreamento;

        async function confirmarPagamento() {
            console.log('🔍 confirmarPagamento chamado, coletaPagamentoId:', coletaPagamentoId);
            
            if (!coletaPagamentoId) {
                console.error('❌ coletaPagamentoId não definido');
                showNotification('Erro: ID da coleta não encontrado.', 'error');
                return;
            }

            const tipoPagamento = document.getElementById('tipoPagamentoConfirmar');
            const valorPagamentoEl = document.getElementById('valorPagamentoConfirmar');
            const observacoes = document.getElementById('observacoesPagamento');

            if (!tipoPagamento || !tipoPagamento.value) {
                showNotification('Por favor, selecione o tipo de pagamento.', 'warning');
                tipoPagamento?.focus();
                return;
            }

            // Validar valor obrigatório
            const valorStr = (valorPagamentoEl && valorPagamentoEl.value) ? valorPagamentoEl.value.trim() : '';
            if (!valorStr) {
                showNotification('Por favor, informe o valor referente ao tipo de pagamento.', 'warning');
                valorPagamentoEl?.focus();
                return;
            }
            const valorNumerico = parseFloat(valorStr.replace(',', '.').replace(/\s/g, ''));
            if (isNaN(valorNumerico) || valorNumerico <= 0) {
                showNotification('Informe um valor numérico válido e maior que zero (ex: 1500,00).', 'warning');
                valorPagamentoEl?.focus();
                return;
            }

            // Garantir que o ID seja string para comparação
            const coletaIdStr = String(coletaPagamentoId);

            console.log('🔍 Procurando coleta em coletasData:', {
                coletaId: coletaIdStr,
                coletasDataDefinida: !!coletasData,
                totalColetas: coletasData?.length || 0,
                coletasIds: coletasData?.slice(0, 5).map(c => String(c.id)) || []
            });

            // Comparar IDs como strings
            let coleta = coletasData?.find(c => String(c.id) === coletaIdStr) || null;
            
            // Se não encontrar em coletasData, buscar do Supabase
            if (!coleta) {
                console.log('⚠️ Coleta não encontrada em coletasData, tentando buscar do Supabase...');
                try {
                    if (!supabaseClient) {
                        throw new Error('Supabase não inicializado');
                    }
                    
                    const { data: coletaData, error: coletaError } = await supabaseClient
                        .from('coletas')
                        .select('*')
                        .eq('id', coletaIdStr)
                        .single();
                    
                    if (coletaError || !coletaData) {
                        console.error('❌ Erro ao buscar coleta do Supabase:', coletaError);
                        throw new Error(coletaError?.message || 'Coleta não encontrada no banco de dados');
                    }
                    
                    console.log('✅ Coleta encontrada no Supabase:', {
                        id: coletaData.id,
                        cliente: coletaData.cliente,
                        etapa_atual: coletaData.etapa_atual
                    });
                    
                    coleta = coletaData;
                    
                    // Adicionar ao coletasData para uso futuro
                    if (coletasData && !coletasData.find(c => String(c.id) === String(coletaData.id))) {
                        coletasData.push(coletaData);
                        console.log('✅ Coleta adicionada ao coletasData');
                    }
                    
                } catch (error) {
                    console.error('❌ Erro ao buscar coleta do Supabase:', error);
                    showNotification(`Erro: Coleta não encontrada. ${error.message}`, 'error');
                    return;
                }
            }

            if (!coleta) {
                console.error('❌ Coleta ainda não encontrada após todas as tentativas');
                showNotification('Erro: Não foi possível encontrar a coleta. Tente novamente.', 'error');
                return;
            }

            // Verificar se a coleta está na etapa de pagamento ou contas_pagar
            const etapaAtual = coleta.etapa_atual;
            console.log('🔍 Etapa atual da coleta:', etapaAtual);
            
            if (etapaAtual !== 'pagamento' && etapaAtual !== 'contas_pagar') {
                showNotification(`Esta coleta não está na etapa de pagamento. Etapa atual: ${etapaAtual}`, 'warning');
                return;
            }
            
            console.log('✅ Coleta validada, processando confirmação de pagamento...');
            await processarConfirmacaoPagamento(coleta, tipoPagamento.value, valorNumerico, observacoes?.value || '');
        }

        async function processarConfirmacaoPagamento(coleta, tipoPagamentoValor, valorPagamentoValor, observacoesValor) {
            const coletaId = coleta.id;
            const valorFormatado = typeof valorPagamentoValor === 'number' ? valorPagamentoValor.toFixed(2).replace('.', ',') : String(valorPagamentoValor || '0,00');
            console.log('📤 Processando confirmação de pagamento:', {
                coletaId: coletaId,
                tipoPagamento: tipoPagamentoValor,
                valor: valorPagamentoValor,
                etapaAtual: coleta.etapa_atual
            });

            if (!confirm(`Confirmar pagamento do tipo "${tipoPagamentoValor}" no valor de R$ ${valorFormatado} para a coleta de ${coleta.cliente || 'cliente desconhecido'}?\n\nA coleta será movida automaticamente para a etapa "Em viagem".`)) {
                return;
            }

            try {
                // Preparar dados para atualização
                const dadosAtualizacao = {
                    contas_pagar_tipo: tipoPagamentoValor,
                    contas_pagar_pago: true,
                    etapa_atual: 'em_viagem' // Mover automaticamente para em_viagem
                };

                // Adicionar valor e observações às observações da coleta
                const valorTexto = `Valor: R$ ${typeof valorPagamentoValor === 'number' ? valorPagamentoValor.toFixed(2).replace('.', ',') : (valorPagamentoValor || '0,00')}`;
                const obsPagamento = observacoesValor && observacoesValor.trim() 
                    ? `${valorTexto}. ${observacoesValor.trim()}` 
                    : valorTexto;
                const obsAtual = coleta.observacoes || '';
                dadosAtualizacao.observacoes = obsAtual 
                    ? `${obsAtual}\n\n[Pagamento - ${new Date().toLocaleString('pt-BR')}] Tipo: ${tipoPagamentoValor}. ${obsPagamento}`
                    : `[Pagamento - ${new Date().toLocaleString('pt-BR')}] Tipo: ${tipoPagamentoValor}. ${obsPagamento}`;

                console.log('📤 Confirmando pagamento e movendo para em_viagem:', {
                    coletaId: coletaId,
                    tipoPagamento: tipoPagamentoValor,
                    etapaAtual: coleta.etapa_atual,
                    etapaDestino: 'em_viagem',
                    dadosAtualizacao: dadosAtualizacao
                });

                // Primeiro, atualizar os dados do pagamento diretamente no Supabase
                console.log('💾 Atualizando dados do pagamento no Supabase...');
                const valorTextoUpdate = `Valor: R$ ${typeof valorPagamentoValor === 'number' ? valorPagamentoValor.toFixed(2).replace('.', ',') : (valorPagamentoValor || '0,00')}`;
                const obsPagamentoUpdate = observacoesValor && observacoesValor.trim() 
                    ? `${valorTextoUpdate}. ${observacoesValor.trim()}` 
                    : valorTextoUpdate;
                const obsColetaUpdate = coleta.observacoes 
                    ? `${coleta.observacoes}\n\n[Pagamento - ${new Date().toLocaleString('pt-BR')}] Tipo: ${tipoPagamentoValor}. ${obsPagamentoUpdate}`
                    : `[Pagamento - ${new Date().toLocaleString('pt-BR')}] Tipo: ${tipoPagamentoValor}. ${obsPagamentoUpdate}`;
                const { error: updateError } = await supabaseClient
                    .from('coletas')
                    .update({
                        contas_pagar_tipo: tipoPagamentoValor,
                        contas_pagar_pago: true,
                        contas_pagar_data: new Date().toISOString(),
                        observacoes: obsColetaUpdate
                    })
                    .eq('id', coletaId);

                if (updateError) {
                    console.error('❌ Erro ao atualizar pagamento:', updateError);
                    throw new Error('Erro ao salvar dados do pagamento: ' + updateError.message);
                }

                console.log('✅ Dados do pagamento salvos com sucesso');

                // Salvar no histórico
                try {
                    const userData = JSON.parse(localStorage.getItem('loggedInUser') || '{}');
                    const usuarioNome = currentUser?.nome || currentUser?.username || userData?.email || 'Sistema';
                    const valorFormatadoHist = typeof valorPagamentoValor === 'number' ? valorPagamentoValor.toFixed(2).replace('.', ',') : (valorPagamentoValor || '0,00');
                    const detalhesHistorico = `Pagamento do tipo "${tipoPagamentoValor}" no valor de R$ ${valorFormatadoHist} confirmado por ${usuarioNome}${observacoesValor && observacoesValor.trim() ? '. Observações: ' + observacoesValor.trim() : ''}`;
                    await salvarNoHistorico(coletaId, 'pagamento_confirmado', detalhesHistorico);
                    console.log('✅ Histórico de pagamento salvo com sucesso');
                } catch (errorHistorico) {
                    console.warn('⚠️ Erro ao salvar histórico (não bloqueia a operação):', errorHistorico);
                }

                // Depois, mover para a etapa em_viagem
                console.log('🔄 Movendo coleta para etapa em_viagem...');
                const authHeaders = await getSupabaseAuthHeaders();
                const response = await fetch(`/api/coletas/${coletaId}/mover-etapa`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeaders
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        etapa_destino: 'em_viagem'
                    })
                });

                console.log('📡 Resposta da API mover-etapa:', response.status, response.statusText);

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.error('❌ Erro na API mover-etapa:', errorData);
                    
                    // Se a API falhar, tentar atualizar diretamente no Supabase
                    console.log('🔄 Tentando atualizar etapa diretamente no Supabase...');
                    const { error: etapaError } = await supabaseClient
                        .from('coletas')
                        .update({ etapa_atual: 'em_viagem' })
                        .eq('id', coletaId);
                    
                    if (etapaError) {
                        console.error('❌ Erro ao atualizar etapa diretamente:', etapaError);
                        throw new Error(errorData.error || `Erro ${response.status}: ${response.statusText}. Erro ao atualizar etapa: ${etapaError.message}`);
                    }
                    
                    console.log('✅ Etapa atualizada diretamente no Supabase');
                    showNotification('✅ Pagamento confirmado e coleta movida para "Em viagem"!', 'success');
                } else {
                    const result = await response.json();
                    console.log('📦 Resposta do servidor:', result);
                    
                    if (result.success !== false) {
                        showNotification('✅ Pagamento confirmado e coleta movida para "Em viagem"!', 'success');
                    } else {
                        throw new Error(result.error || 'Erro ao confirmar pagamento');
                    }
                }
                
                // Fechar modal
                fecharModalConfirmarPagamento();
                
                // Recarregar coletas para atualizar a visualização
                await carregarColetas();
            } catch (error) {
                console.error('❌ Erro ao confirmar pagamento:', error);
                showNotification('Erro ao confirmar pagamento: ' + error.message, 'error');
            }
        }

        // ========== FUNÇÕES PARA MODAL DE LANÇAR PENDÊNCIA ==========
        let coletaPendenciaId = null;
        let arquivosEvidencia = [];

        async function abrirModalLancarPendencia(coletaId) {
            // Garantir que o ID seja string para comparação
            const coletaIdStr = String(coletaId);
            coletaPendenciaId = coletaIdStr;
            
            // Tentar encontrar a coleta em coletasData primeiro (comparando como strings)
            let coleta = coletasData.find(c => String(c.id) === coletaIdStr);
            
            // Se não encontrar, tentar buscar do Supabase
            if (!coleta) {
                console.log('⚠️ Coleta não encontrada em coletasData, tentando buscar do Supabase...');
                try {
                    if (!supabaseClient) {
                        console.error('❌ Supabase não inicializado');
                        showNotification('Erro: Sistema não inicializado. Recarregue a página.', 'error');
                        return;
                    }
                    
                    const { data: coletaData, error: coletaError } = await supabaseClient
                        .from('coletas')
                        .select('*')
                        .eq('id', coletaIdStr)
                        .single();
                    
                    if (coletaError || !coletaData) {
                        console.error('❌ Erro ao buscar coleta do Supabase:', coletaError);
                        showNotification('Coleta não encontrada. Verifique se o ID está correto.', 'error');
                        return;
                    }
                    
                    console.log('✅ Coleta encontrada no Supabase');
                    coleta = coletaData;
                    // Adicionar ao coletasData para uso futuro
                    if (coletasData && !coletasData.find(c => String(c.id) === String(coletaData.id))) {
                        coletasData.push(coletaData);
                    }
                } catch (error) {
                    console.error('❌ Erro ao buscar coleta:', error);
                    showNotification('Erro ao buscar dados da coleta. Tente novamente.', 'error');
                    return;
                }
            }

            // Atualizar preview
            const preview = document.getElementById('lancarPendenciaPreview');
            if (preview) {
                preview.innerHTML = `
                    <p style="margin: 0; font-weight: 600; margin-bottom: 0.5rem;">${escapeHtml(coleta.cliente || 'Sem cliente')}</p>
                    <p style="margin: 0; font-size: 0.9rem; color: #666;">
                        ${coleta.filial ? `<strong>Filial:</strong> ${coleta.filial}` : ''}
                        ${coleta.numero_coleta ? ` | <strong>Coleta #${coleta.numero_coleta}</strong>` : ''}
                    </p>
                `;
            }

            // Limpar campos
            const motivo = document.getElementById('motivoPendencia');
            const evidencia = document.getElementById('evidenciaPendencia');
            const previewEvidencia = document.getElementById('evidenciaPreview');
            const listaEvidencia = document.getElementById('evidenciaList');
            
            if (motivo) motivo.value = '';
            if (evidencia) evidencia.value = '';
            if (previewEvidencia) previewEvidencia.style.display = 'none';
            if (listaEvidencia) listaEvidencia.innerHTML = '';
            arquivosEvidencia = [];

            // Adicionar listener para preview de arquivos
            if (evidencia) {
                evidencia.onchange = function(e) {
                    const files = Array.from(e.target.files);
                    arquivosEvidencia = files;
                    
                    if (files.length > 0 && previewEvidencia && listaEvidencia) {
                        previewEvidencia.style.display = 'block';
                        listaEvidencia.innerHTML = files.map((file, index) => `
                            <div style="background: #f8f9fa; padding: 0.5rem; border-radius: 6px; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-file" style="color: #667eea;"></i>
                                <span style="font-size: 0.85rem;">${escapeHtml(file.name)}</span>
                                <span style="font-size: 0.75rem; color: #666;">(${(file.size / 1024).toFixed(2)} KB)</span>
                            </div>
                        `).join('');
                    } else {
                        previewEvidencia.style.display = 'none';
                    }
                };
            }

            // Mostrar modal
            const modal = document.getElementById('modalLancarPendencia');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        function fecharModalLancarPendencia() {
            const modal = document.getElementById('modalLancarPendencia');
            if (modal) {
                modal.style.display = 'none';
            }
            coletaPendenciaId = null;
            arquivosEvidencia = [];
        }

        async function confirmarLancarPendencia() {
            if (!coletaPendenciaId) {
                alert('Erro: ID da coleta não encontrado.');
                return;
            }

            const motivo = document.getElementById('motivoPendencia');
            const evidencia = document.getElementById('evidenciaPendencia');

            if (!motivo || !motivo.value.trim()) {
                alert('Por favor, informe o motivo da pendência.');
                motivo?.focus();
                return;
            }

            // Garantir que o ID seja string para comparação
            const coletaIdStr = String(coletaPendenciaId);
            
            // Comparar IDs como strings
            let coleta = coletasData.find(c => String(c.id) === coletaIdStr);
            
            // Se não encontrar, tentar buscar do Supabase
            if (!coleta) {
                console.log('⚠️ Coleta não encontrada em coletasData, tentando buscar do Supabase...');
                try {
                    if (!supabaseClient) {
                        throw new Error('Supabase não inicializado');
                    }
                    
                    const { data: coletaData, error: coletaError } = await supabaseClient
                        .from('coletas')
                        .select('*')
                        .eq('id', coletaIdStr)
                        .single();
                    
                    if (coletaError || !coletaData) {
                        throw new Error(coletaError?.message || 'Coleta não encontrada no banco de dados');
                    }
                    
                    console.log('✅ Coleta encontrada no Supabase');
                    coleta = coletaData;
                    // Adicionar ao coletasData para uso futuro
                    if (coletasData && !coletasData.find(c => String(c.id) === String(coletaData.id))) {
                        coletasData.push(coletaData);
                    }
                } catch (error) {
                    console.error('❌ Erro ao buscar coleta do Supabase:', error);
                    alert(`Erro: Coleta não encontrada. ${error.message}`);
                    return;
                }
            }

            if (!confirm(`Confirmar lançamento de pendência e mover a coleta para "Pendências"?`)) {
                return;
            }

            try {
                // Preparar dados para atualização
                const dadosAtualizacao = {
                    etapa_atual: 'pendencias'
                };

                // Adicionar motivo e evidências nas observações
                let observacoesTexto = `[Pendência - ${new Date().toLocaleString('pt-BR')}]\nMotivo: ${motivo.value.trim()}`;
                
                if (arquivosEvidencia.length > 0) {
                    observacoesTexto += `\nEvidências anexadas: ${arquivosEvidencia.map(f => f.name).join(', ')}`;
                }

                const obsAtual = coleta.observacoes || '';
                dadosAtualizacao.observacoes = obsAtual 
                    ? `${obsAtual}\n\n${observacoesTexto}`
                    : observacoesTexto;

                // TODO: Fazer upload dos arquivos de evidência se necessário
                // Por enquanto, apenas salvar os nomes dos arquivos nas observações

                // Fazer requisição para mover etapa
                const authHeaders = await getSupabaseAuthHeaders();
                const response = await fetch(`/api/coletas/${coletaPendenciaId}/mover-etapa`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...authHeaders
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        etapa_destino: 'pendencias',
                        ...dadosAtualizacao
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.error || `Erro ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                
                if (result.success !== false) {
                    showNotification('✅ Pendência lançada e coleta movida para "Pendências"!', 'success');
                    
                    // Fechar modal
                    fecharModalLancarPendencia();
                    
                    // Recarregar coletas
                    await carregarColetas();
                } else {
                    throw new Error(result.error || 'Erro ao lançar pendência');
                }
            } catch (error) {
                console.error('❌ Erro ao lançar pendência:', error);
                alert('Erro ao lançar pendência: ' + error.message);
            }
        }

        async function carregarFunisParaModal() {
            try {
                const response = await fetch('/api/coletas/funis-kanban');
                const data = await response.json();
                
                if (data.success && data.funis) {
                    todosFunisDisponiveis = data.funis;
                    
                    const selectFunil = document.getElementById('selectFunilDestino');
                    if (selectFunil) {
                        selectFunil.innerHTML = '<option value="">Selecione um funil</option>';
                        
                        // Agrupar funis por página para melhor organização
                        const funisPorPagina = {};
                        data.funis.forEach(funil => {
                            if (!funisPorPagina[funil.pagina_id]) {
                                funisPorPagina[funil.pagina_id] = [];
                            }
                            funisPorPagina[funil.pagina_id].push(funil);
                        });

                        // Adicionar funis agrupados por página
                        Object.keys(funisPorPagina).sort().forEach(paginaId => {
                            const paginaNome = PAGINAS_KANBAN[paginaId]?.nome || paginaId;
                            const funis = funisPorPagina[paginaId];
                            
                            if (funis.length > 0) {
                                const optgroup = document.createElement('optgroup');
                                optgroup.label = `${paginaNome} (${funis.length} funil${funis.length > 1 ? 's' : ''})`;
                                
                                funis.forEach(funil => {
                                    const option = document.createElement('option');
                                    option.value = funil.id;
                                    option.textContent = funil.nome;
                                    optgroup.appendChild(option);
                                });
                                
                                selectFunil.appendChild(optgroup);
                            }
                        });
                    }
                }
            } catch (error) {
                console.error('❌ Erro ao carregar funis para modal:', error);
                alert('Erro ao carregar funis disponíveis.');
            }
        }

        function atualizarEtapasDoFunil() {
            const selectFunil = document.getElementById('selectFunilDestino');
            const selectEtapa = document.getElementById('selectEtapaDestino');
            const btnConfirmar = document.getElementById('btnConfirmarMovimentacao');
            
            if (!selectFunil || !selectEtapa) return;

            const funilId = selectFunil.value;
            
            // ✅ CRÍTICO: Limpar etapa selecionada quando funil muda
            selectEtapa.value = '';
            if (btnConfirmar) btnConfirmar.disabled = true;
            
            if (!funilId) {
                selectEtapa.innerHTML = '<option value="">Selecione primeiro um funil</option>';
                selectEtapa.disabled = true;
                return;
            }

            // Buscar funil selecionado
            const funil = todosFunisDisponiveis.find(f => f.id === funilId);
            
            if (!funil || !funil.etapas) {
                selectEtapa.innerHTML = '<option value="">Nenhuma etapa disponível</option>';
                selectEtapa.disabled = true;
                return;
            }

            // Popular etapas do funil - apenas etapas ativas do funil selecionado
            selectEtapa.innerHTML = '<option value="">Selecione uma etapa</option>';
            
            // Filtrar apenas etapas ativas do funil
            const etapasAtivas = (funil.etapas || []).filter(etapa => etapa.ativo !== false);
            
            etapasAtivas.forEach(etapa => {
                // ✅ VALIDAÇÃO CRÍTICA: Verificar se a etapa realmente pertence ao funil
                // Isso evita adicionar etapas que por algum motivo não deveriam estar aqui
                if (etapa.funil_id && etapa.funil_id !== funil.id) {
                    console.warn(`⚠️ Etapa ${etapa.id} pertence ao funil ${etapa.funil_id}, não ao funil ${funil.id}`);
                    return; // Não adicionar esta etapa
                }
                
                const etapaInfo = ETAPAS.find(e => e.id === etapa.id);
                if (etapaInfo) {
                    const option = document.createElement('option');
                    option.value = etapa.id;
                    option.textContent = etapaInfo.nome;
                    option.setAttribute('data-funil-id', funil.id); // Marcar qual funil pertence
                    selectEtapa.appendChild(option);
                } else {
                    // Se não encontrar na lista ETAPAS, adicionar mesmo assim (pode ser etapa dinâmica)
                    const option = document.createElement('option');
                    option.value = etapa.id;
                    option.textContent = etapa.nome || etapa.id;
                    option.setAttribute('data-funil-id', funil.id);
                    selectEtapa.appendChild(option);
                }
            });
            
            // ✅ VALIDAÇÃO FINAL: Verificar se todas as opções têm o data-funil-id correto
            const todasOpcoes = selectEtapa.querySelectorAll('option[value]');
            todasOpcoes.forEach(option => {
                if (option.value && option.getAttribute('data-funil-id') !== funil.id) {
                    console.error(`❌ Opção inválida encontrada: ${option.value} pertence ao funil ${option.getAttribute('data-funil-id')}, não ao funil ${funil.id}`);
                    option.remove(); // Remover opção inválida
                }
            });
            
            // Log para debug
            if (window.DEBUG || window.location.hostname === 'localhost') {
                console.log('📋 Etapas carregadas para funil:', {
                    funilId: funil.id,
                    funilNome: funil.nome,
                    etapas: etapasAtivas.map(e => ({ id: e.id, nome: e.nome || ETAPAS.find(et => et.id === e.id)?.nome || e.id }))
                });
            }

            selectEtapa.disabled = false;
            
            // Remover listeners antigos antes de adicionar novo
            const newSelectEtapa = selectEtapa.cloneNode(true);
            selectEtapa.parentNode.replaceChild(newSelectEtapa, selectEtapa);
            
            // Habilitar botão quando etapa for selecionada
            newSelectEtapa.addEventListener('change', function() {
                const btnConfirmar = document.getElementById('btnConfirmarMovimentacao');
                if (btnConfirmar) {
                    // Validar se a etapa pertence ao funil selecionado
                    const funilAtual = selectFunil.value;
                    const etapaSelecionada = this.value;
                    const optionSelecionada = this.options[this.selectedIndex];
                    const funilDaEtapa = optionSelecionada ? optionSelecionada.getAttribute('data-funil-id') : null;
                    
                    if (etapaSelecionada && funilDaEtapa !== funilAtual) {
                        alert('⚠️ Esta etapa não pertence ao funil selecionado. Selecione uma etapa válida.');
                        this.value = '';
                        btnConfirmar.disabled = true;
                        return;
                    }
                    
                    btnConfirmar.disabled = !this.value;
                }
            });
        }

        async function confirmarMovimentacaoColeta() {
            if (!coletaMovendoId) {
                alert('Erro: ID da coleta não encontrado.');
                return;
            }

            const selectFunil = document.getElementById('selectFunilDestino');
            const selectEtapa = document.getElementById('selectEtapaDestino');
            const btnConfirmar = document.getElementById('btnConfirmarMovimentacao');

            if (!selectFunil || !selectEtapa) {
                alert('Erro: Elementos do formulário não encontrados.');
                return;
            }

            const funilId = selectFunil.value;
            const etapaId = selectEtapa.value;

            if (!funilId || !etapaId) {
                alert('Por favor, selecione um funil e uma etapa de destino.');
                return;
            }

            // Validar se etapa pertence ao funil
            const funil = todosFunisDisponiveis.find(f => f.id === funilId);
            if (!funil) {
                alert('Funil não encontrado. Por favor, selecione um funil válido.');
                return;
            }
            
            // ✅ VALIDAÇÃO CRÍTICA: Verificar se a etapa pertence ao funil selecionado
            // Primeiro, verificar pelo data-funil-id da opção selecionada
            const optionSelecionada = selectEtapa.options[selectEtapa.selectedIndex];
            const funilDaEtapa = optionSelecionada ? optionSelecionada.getAttribute('data-funil-id') : null;
            
            // Se a opção selecionada pertence a outro funil, bloquear
            if (funilDaEtapa && funilDaEtapa !== funilId) {
                const funilCorreto = todosFunisDisponiveis.find(f => f.id === funilDaEtapa);
                alert(`⚠️ A etapa selecionada pertence ao funil "${funilCorreto?.nome || funilDaEtapa}".\n\nPor favor, selecione o funil correto "${funilCorreto?.nome || funilDaEtapa}" ou escolha uma etapa do funil "${funil.nome}".`);
                
                // Limpar seleção inválida
                selectEtapa.value = '';
                if (btnConfirmar) btnConfirmar.disabled = true;
                return;
            }
            
            // Depois, verificar se a etapa realmente pertence ao funil
            const etapaPertenceAoFunil = funil.etapas && funil.etapas.some(e => e.id === etapaId && e.ativo !== false);
            if (!etapaPertenceAoFunil) {
                alert(`⚠️ A etapa selecionada não pertence ao funil "${funil.nome}".\n\nPor favor, selecione uma etapa válida deste funil.`);
                
                // Limpar seleção inválida
                selectEtapa.value = '';
                if (btnConfirmar) btnConfirmar.disabled = true;
                return;
            }

            // Buscar coleta atual
            const coleta = coletasData.find(c => c.id === coletaMovendoId);
            if (!coleta) {
                alert('Coleta não encontrada.');
                return;
            }

            // Validações adicionais
            if (coleta.etapa_atual === 'contratacao' && !coleta.motorista_id) {
                alert('⚠️ Para mover uma coleta da etapa Contratação, é necessário vincular um motorista à coleta primeiro.');
                return;
            }

            // Confirmar movimentação
            const etapaAtualNome = obterNomeEtapa(coleta.etapa_atual);
            const etapaDestinoNome = obterNomeEtapa(etapaId);
            const funilNome = funil.nome;

            if (!confirm(`Mover coleta de "${etapaAtualNome}" para "${etapaDestinoNome}" no funil "${funilNome}"?`)) {
                return;
            }

            // Desabilitar botão durante a requisição
            if (btnConfirmar) {
                btnConfirmar.disabled = true;
                btnConfirmar.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Movendo...';
            }

            try {
                // Validar ID antes de fazer a requisição
                if (!coletaMovendoId || typeof coletaMovendoId !== 'string' || coletaMovendoId.trim() === '') {
                    throw new Error('ID da coleta inválido');
                }

                // ✅ CORREÇÃO: Buscar o funil correto da etapa selecionada
                // A etapa pode pertencer a um funil diferente do selecionado
                let funilIdCorreto = funilId;
                
                // Verificar se a etapa pertence ao funil selecionado
                const etapaPertenceAoFunilSelecionado = funil.etapas && funil.etapas.some(e => e.id === etapaId && e.ativo !== false);
                
                if (!etapaPertenceAoFunilSelecionado) {
                    // Buscar em qual funil a etapa realmente pertence
                    for (const f of todosFunisDisponiveis) {
                        if (f.etapas && f.etapas.some(e => e.id === etapaId && e.ativo !== false)) {
                            funilIdCorreto = f.id;
                            console.log(`🔍 Etapa ${etapaId} pertence ao funil ${f.nome} (${f.id}), não ao funil ${funil.nome}`);
                            break;
                        }
                    }
                }

                console.log('🔄 Movendo coleta:', {
                    coletaId: coletaMovendoId,
                    etapaDestino: etapaId,
                    funilIdOriginal: funilId,
                    funilIdCorreto: funilIdCorreto,
                    funilNome: funil.nome
                });

                // ✅ Enviar apenas etapa_destino (como a função antiga faz)
                // O servidor pode buscar o funil correto automaticamente
                const response = await fetch(`/api/coletas/${coletaMovendoId}/mover-etapa`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token') || ''}`
                    },
                    body: JSON.stringify({
                        etapa_destino: etapaId
                        // Não enviar funil_id para evitar validação rígida
                        // O servidor pode buscar o funil correto da etapa
                    })
                });

                const result = await response.json();

                if (!response.ok) {
                    console.error('❌ Erro na resposta do servidor:', {
                        status: response.status,
                        statusText: response.statusText,
                        error: result.error,
                        details: result.details
                    });
                    throw new Error(result.error || `Erro ao mover coleta (${response.status})`);
                }

                if (result.success) {
                    // Atualizar coleta localmente
                    const coletaIndex = coletasData.findIndex(c => c.id === coletaMovendoId);
                    if (coletaIndex !== -1) {
                        coletasData[coletaIndex].etapa_atual = result.etapa_final || etapaId;
                        coletasData[coletaIndex].funil_id = funilId;
                    }

                    // Fechar modal
                    fecharModalMoverColeta();

                    // Recarregar kanban
                    await renderColetasKanban();

                    // Mostrar notificação de sucesso
                    showNotification(`Coleta movida com sucesso para "${etapaDestinoNome}" no funil "${funilNome}"!`, 'success');
                } else {
                    throw new Error(result.error || 'Erro ao mover coleta');
                }
            } catch (error) {
                console.error('❌ Erro ao mover coleta:', error);
                alert('Erro ao mover coleta: ' + error.message);
            } finally {
                if (btnConfirmar) {
                    btnConfirmar.disabled = false;
                    btnConfirmar.innerHTML = '<i class="fas fa-check"></i> Confirmar Movimentação';
                }
            }
        }

        // Função para executar migração de constraint automaticamente
        async function executarMigracaoConstraint() {
            try {
                console.log('🔧 Executando migração para remover constraint...');
                const response = await fetch('/api/admin/remover-constraint-etapa-atual', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    console.log('✅ Constraint removida com sucesso!');
                    showNotification('✅ Constraint atualizada com sucesso! Você pode tentar novamente.', 'success', 5000);
                    return true;
                } else {
                    console.error('❌ Erro ao remover constraint:', result.error);
                    showNotification('⚠️ Não foi possível remover a constraint automaticamente. Execute o SQL manualmente no Supabase Dashboard.', 'warning', 10000);
                    if (result.sql) {
                        console.log('SQL para executar manualmente:', result.sql);
                    }
                    return false;
                }
            } catch (error) {
                console.error('❌ Erro ao executar migração:', error);
                showNotification('⚠️ Erro ao executar migração automática. Execute o SQL manualmente no Supabase Dashboard.', 'error', 10000);
                return false;
            }
        }

        // Expor função globalmente
        window.abrirModalMoverColeta = abrirModalMoverColeta;
        window.fecharModalMoverColeta = fecharModalMoverColeta;
        window.atualizarEtapasDoFunil = atualizarEtapasDoFunil;
        window.confirmarMovimentacaoColeta = confirmarMovimentacaoColeta;
        
        // Funções de pagamento e pendência
        window.abrirModalConfirmarPagamento = abrirModalConfirmarPagamento;
        window.fecharModalConfirmarPagamento = fecharModalConfirmarPagamento;
        window.confirmarPagamento = confirmarPagamento;
        window.abrirModalLancarPendencia = abrirModalLancarPendencia;
        window.fecharModalLancarPendencia = fecharModalLancarPendencia;
        window.confirmarLancarPendencia = confirmarLancarPendencia;
        
        // ========== FUNÇÕES PARA MODAL DE VALIDAR CANHOTO E FINALIZAR ==========
        let coletaFinalizarId = null;

        async function abrirModalValidarCanhoto(coletaId) {
            console.log('🔍 abrirModalValidarCanhoto chamado com coletaId:', coletaId);
            // Garantir que o ID seja string para comparação
            const coletaIdStr = String(coletaId);
            coletaFinalizarId = coletaIdStr;
            
            // Tentar encontrar a coleta em coletasData primeiro (comparando como strings)
            let coleta = coletasData?.find(c => String(c.id) === coletaIdStr) || null;
            
            // Se não encontrar, tentar buscar do Supabase
            if (!coleta) {
                console.log('⚠️ Coleta não encontrada em coletasData, tentando buscar do Supabase...');
                try {
                    if (!supabaseClient) {
                        console.error('❌ Supabase não inicializado');
                        showNotification('Erro: Sistema não inicializado. Recarregue a página.', 'error');
                        return;
                    }
                    
                    const { data: coletaData, error: coletaError } = await supabaseClient
                        .from('coletas')
                        .select('*')
                        .eq('id', coletaIdStr)
                        .single();
                    
                    if (coletaError || !coletaData) {
                        console.error('❌ Erro ao buscar coleta do Supabase:', coletaError);
                        showNotification('Coleta não encontrada. Verifique se o ID está correto.', 'error');
                        return;
                    }
                    
                    console.log('✅ Coleta encontrada no Supabase');
                    coleta = coletaData;
                    // Adicionar ao coletasData para uso futuro
                    if (coletasData && !coletasData.find(c => String(c.id) === String(coletaData.id))) {
                        coletasData.push(coletaData);
                    }
                } catch (error) {
                    console.error('❌ Erro ao buscar coleta:', error);
                    showNotification('Erro ao buscar dados da coleta. Tente novamente.', 'error');
                    return;
                }
            }

            // Verificar se a coleta está na etapa correta
            if (coleta.etapa_atual !== 'finalizar_operacao') {
                showNotification('Esta coleta não está na etapa de finalizar operação.', 'warning');
                return;
            }

            // Atualizar preview
            const preview = document.getElementById('validarCanhotoPreview');
            if (preview) {
                preview.innerHTML = `
                    <p style="margin: 0; font-weight: 600; margin-bottom: 0.5rem;">${escapeHtml(coleta.cliente || 'Sem cliente')}</p>
                    <p style="margin: 0; font-size: 0.9rem; color: #666;">
                        ${coleta.filial ? `<strong>Filial:</strong> ${coleta.filial}` : ''}
                        ${coleta.numero_coleta ? ` | <strong>Coleta #${coleta.numero_coleta}</strong>` : ''}
                        ${coleta.origem ? ` | <strong>Origem:</strong> ${coleta.origem}` : ''}
                        ${coleta.destino ? ` | <strong>Destino:</strong> ${coleta.destino}` : ''}
                    </p>
                `;
            }

            // Limpar campos
            const canhotoValidado = document.getElementById('canhotoValidado');
            const informacoesValidadas = document.getElementById('informacoesValidadas');
            const observacoes = document.getElementById('observacoesFinalizacao');
            if (canhotoValidado) canhotoValidado.checked = false;
            if (informacoesValidadas) informacoesValidadas.checked = false;
            if (observacoes) observacoes.value = '';

            // Mostrar modal
            const modal = document.getElementById('modalValidarCanhoto');
            if (modal) {
                modal.style.display = 'flex';
            }
        }

        function fecharModalValidarCanhoto() {
            const modal = document.getElementById('modalValidarCanhoto');
            if (modal) {
                modal.style.display = 'none';
            }
            coletaFinalizarId = null;
        }

        async function confirmarFinalizarOperacao() {
            if (!coletaFinalizarId) {
                showNotification('Erro: ID da coleta não encontrado.', 'error');
                return;
            }

            const canhotoValidado = document.getElementById('canhotoValidado');
            const informacoesValidadas = document.getElementById('informacoesValidadas');
            const observacoes = document.getElementById('observacoesFinalizacao');

            if (!canhotoValidado || !canhotoValidado.checked) {
                showNotification('Por favor, confirme que o canhoto foi verificado e está correto.', 'warning');
                canhotoValidado?.focus();
                return;
            }

            if (!informacoesValidadas || !informacoesValidadas.checked) {
                showNotification('Por favor, confirme que todas as informações da coleta estão corretas.', 'warning');
                informacoesValidadas?.focus();
                return;
            }

            // Garantir que o ID seja string para comparação
            const coletaIdStr = String(coletaFinalizarId);
            
            // Comparar IDs como strings
            let coleta = coletasData?.find(c => String(c.id) === coletaIdStr) || null;
            
            // Se não encontrar em coletasData, buscar do Supabase
            if (!coleta) {
                console.log('⚠️ Coleta não encontrada em coletasData, tentando buscar do Supabase...');
                try {
                    if (!supabaseClient) {
                        throw new Error('Supabase não inicializado');
                    }
                    
                    const { data: coletaData, error: coletaError } = await supabaseClient
                        .from('coletas')
                        .select('*')
                        .eq('id', coletaIdStr)
                        .single();
                    
                    if (coletaError || !coletaData) {
                        throw new Error(coletaError?.message || 'Coleta não encontrada no banco de dados');
                    }
                    
                    coleta = coletaData;
                } catch (error) {
                    console.error('❌ Erro ao buscar coleta do Supabase:', error);
                    showNotification(`Erro: Coleta não encontrada. ${error.message}`, 'error');
                    return;
                }
            }

            if (!coleta) {
                showNotification('Erro: Não foi possível encontrar a coleta. Tente novamente.', 'error');
                return;
            }

            // Verificar se a coleta está na etapa correta
            if (coleta.etapa_atual !== 'finalizar_operacao') {
                showNotification(`Esta coleta não está na etapa de finalizar operação. Etapa atual: ${coleta.etapa_atual}`, 'warning');
                return;
            }

            // Confirmar ação
            if (!confirm(`Confirmar finalização da operação para a coleta de ${coleta.cliente || 'cliente desconhecido'}?\n\nA coleta será arquivada e movida para o histórico.`)) {
                return;
            }

            try {
                const usuarioNome = currentUser?.nome || currentUser?.username || currentUser?.email || 'Sistema';
                const observacoesTexto = observacoes?.value?.trim() || '';
                
                // Preparar dados para atualização
                const dadosAtualizacao = {
                    etapa_atual: 'finalizar_operacao',
                    status: 'concluida',
                    arquivado: true,
                    resultado_final: 'ganhou',
                    data_finalizacao: new Date().toISOString(),
                    canhoto_validado: true,
                    canhoto_validado_por: usuarioNome,
                    canhoto_validado_em: new Date().toISOString()
                };

                // Adicionar observações se houver
                if (observacoesTexto) {
                    const obsAtual = coleta.observacoes || '';
                    dadosAtualizacao.observacoes = obsAtual 
                        ? `${obsAtual}\n\n[Finalização - ${new Date().toLocaleString('pt-BR')}] Canhoto validado por ${usuarioNome}. ${observacoesTexto}`
                        : `[Finalização - ${new Date().toLocaleString('pt-BR')}] Canhoto validado por ${usuarioNome}. ${observacoesTexto}`;
                } else {
                    const obsAtual = coleta.observacoes || '';
                    dadosAtualizacao.observacoes = obsAtual 
                        ? `${obsAtual}\n\n[Finalização - ${new Date().toLocaleString('pt-BR')}] Canhoto validado por ${usuarioNome}.`
                        : `[Finalização - ${new Date().toLocaleString('pt-BR')}] Canhoto validado por ${usuarioNome}.`;
                }

                console.log('📤 Finalizando operação:', {
                    coletaId: coletaIdStr,
                    dadosAtualizacao: dadosAtualizacao
                });

                // Atualizar coleta no banco
                const { error: updateError } = await supabaseClient
                    .from('coletas')
                    .update(dadosAtualizacao)
                    .eq('id', coletaIdStr);

                if (updateError) {
                    console.error('❌ Erro ao atualizar coleta:', updateError);
                    throw new Error('Erro ao salvar dados da finalização: ' + updateError.message);
                }

                console.log('✅ Dados da finalização salvos com sucesso');

                // Salvar no histórico
                try {
                    const detalhesHistorico = `Operação finalizada. Canhoto validado por ${usuarioNome}${observacoesTexto ? '. Observações: ' + observacoesTexto : ''}`;
                    await salvarNoHistorico(coletaIdStr, 'operacao_finalizada', detalhesHistorico);
                    console.log('✅ Histórico de finalização salvo com sucesso');
                } catch (errorHistorico) {
                    console.warn('⚠️ Erro ao salvar histórico (não bloqueia a operação):', errorHistorico);
                }

                showNotification('✅ Operação finalizada com sucesso! Redirecionando para o histórico...', 'success');

                // Fechar modal
                fecharModalValidarCanhoto();

                // Redirecionar para histórico após 1 segundo
                setTimeout(() => {
                    window.location.href = 'historico_coletas.html';
                }, 1000);
                
            } catch (error) {
                console.error('❌ Erro ao finalizar operação:', error);
                showNotification('Erro ao finalizar operação: ' + error.message, 'error');
            }
        }

        // Expor funções globalmente
        window.abrirModalValidarCanhoto = abrirModalValidarCanhoto;
        window.fecharModalValidarCanhoto = fecharModalValidarCanhoto;
        window.confirmarFinalizarOperacao = confirmarFinalizarOperacao;
        window.finalizarOperacao = finalizarOperacao;
        
        window.executarMigracaoConstraint = executarMigracaoConstraint;

        async function handleKanbanDrop(e, etapaDestino) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');

            if (!draggedCard) return;

            const coletaId = draggedCard.getAttribute('data-coleta-id');
            const etapaOrigem = draggedFromEtapa;

            // Validar permissão na etapa de origem
            if (!temPermissaoEtapa(etapaOrigem)) {
                alert('Você não tem permissão para mover coletas desta etapa.');
                return;
            }

            // Se a etapa de destino for a mesma, não fazer nada
            if (etapaOrigem === etapaDestino) {
                return;
            }

            // Confirmar movimento
            const etapaOrigemNome = obterNomeEtapa(etapaOrigem);
            const etapaDestinoNome = obterNomeEtapa(etapaDestino);
            
            if (!confirm(`Mover coleta de "${etapaOrigemNome}" para "${etapaDestinoNome}"?`)) {
                return;
            }

            // Mover a coleta usando a função existente
            try {
                // Validar se a etapa de destino é válida
                const etapaValida = ETAPAS.find(e => e.id === etapaDestino);
                if (!etapaValida) {
                    console.error('Etapa inválida:', etapaDestino);
                    alert(`Etapa "${etapaDestino}" não é válida.`);
                    return;
                }

                // Buscar a coleta atual
                const coleta = coletasData.find(c => c.id === coletaId);
                if (!coleta) {
                    alert('Coleta não encontrada.');
                    return;
                }

                // ✅ VALIDAÇÃO OBRIGATÓRIA: Não pode sair da etapa contratação sem motorista vinculado
                if (coleta.etapa_atual === 'contratacao' && !coleta.motorista_id) {
                    alert('⚠️ Para mover uma coleta da etapa Contratação, é necessário vincular um motorista à coleta primeiro.');
                    return;
                }

                // ✅ Não pode ir para a etapa GR sem motorista vinculado
                if (etapaDestino === 'gr' && !coleta.motorista_id) {
                    alert('⚠️ Para mover para a etapa GR, é necessário vincular um motorista à coleta.');
                    return;
                }

                // ✅ Só bloqueia se o motorista já foi reprovado NESTA coleta (gr_aprovado === false).
                // Ao mover para a etapa GR, sempre permitir – o GR fará nova avaliação (mesmo se reprovado antes).
                const reprovadoNestaColeta = coleta.gr_aprovado === false || coleta.gr_aprovado === 'false' || coleta.gr_aprovado === 0;
                if (coleta.etapa_atual === 'contratacao' && coleta.motorista_id && reprovadoNestaColeta && etapaDestino !== 'gr') {
                    alert('⚠️ O motorista foi reprovado pelo GR nesta coleta. Troque o motorista ou mova para a etapa GR para nova avaliação.');
                    return;
                }

                // ✅ VALIDAÇÃO OBRIGATÓRIA: Não pode sair da etapa GR sem aprovação ou reprovação
                if (isEtapaGR(coleta.etapa_atual)) {
                    // Verificar se GR foi aprovado ou reprovado
                    if (coleta.gr_aprovado === null || coleta.gr_aprovado === undefined) {
                        alert('⚠️ Para mover uma coleta da etapa GR, é necessário aprovar ou reprovar a coleta primeiro.\n\nUse os botões "Aprovar GR" ou "Reprovar GR" no card da coleta.');
                        return;
                    }
                    
                    // Se foi reprovado, não pode avançar (deve estar em contratação)
                    if (coleta.gr_aprovado === false) {
                        const etapaDestinoIndex = ETAPAS.findIndex(e => e.id === etapaDestino);
                        const grIndex = ETAPAS.findIndex(e => e.id === 'gr');
                        
                        // Se tentar avançar (ir para frente), bloquear
                        if (etapaDestinoIndex > grIndex) {
                            alert('⚠️ Esta coleta foi reprovada pelo GR e não pode avançar. Ela deve voltar para a etapa de Contratação.');
                            return;
                        }
                    }
                    
                    // Se foi aprovado, só pode avançar para documentação
                    if (coleta.gr_aprovado === true) {
                        const etapaDestinoIndex = ETAPAS.findIndex(e => e.id === etapaDestino);
                        const documentacaoIndex = ETAPAS.findIndex(e => e.id === 'documentacao');
                        
                        // Permitir movimento para documentacao sempre
                        // Se não for documentacao, permitir também (automações podem direcionar)
                        // As automações no backend irão decidir a etapa final correta
                    }
                }
                
                // ✅ VALIDAÇÃO: Não pode avançar para documentação ou monitoramento sem aprovação no GR
                const etapasQueRequeremAprovacaoGR = ['documentacao', 'monitoramento'];
                if (etapasQueRequeremAprovacaoGR.includes(etapaDestino)) {
                    // Verificar se o motorista foi aprovado no GR
                    if (!coleta.motorista_id) {
                        alert('⚠️ Para avançar para esta etapa, é necessário ter um motorista vinculado e aprovado no GR.');
                        return;
                    }
                    
                    // Verificar se passou pelo GR e foi aprovado
                    if (coleta.gr_aprovado !== true) {
                        if (coleta.gr_aprovado === false) {
                            alert('⚠️ Esta coleta foi reprovada pelo GR. Não é possível avançar para esta etapa. É necessário aprovar o motorista no GR primeiro.');
                        } else {
                            alert('⚠️ Para avançar para esta etapa, o motorista deve ser aprovado no GR primeiro.');
                        }
                        return;
                    }
                    
                    // Verificar também se o motorista não está reprovado para esta coleta
                    try {
                        const motorista = await buscarMotoristaPorId(coleta.motorista_id);
                        if (motorista) {
                            // ✅ CORREÇÃO: Passar o objeto coleta completo, não apenas o ID
                            const statusInfo = verificarStatusMotoristaPorColeta(motorista, coleta);
                            console.log('🔍 Status do motorista verificado:', {
                                coleta_id: coleta.id,
                                etapa_atual: coleta.etapa_atual,
                                gr_aprovado: coleta.gr_aprovado,
                                status_motorista: statusInfo.status
                            });
                            
                            if (statusInfo.status === 'reprovado') {
                                alert('⚠️ O motorista vinculado está reprovado para esta coleta. Não é possível avançar para esta etapa.');
                                return;
                            }
                            // ✅ CORREÇÃO: Se gr_aprovado === true, considerar aprovado mesmo se statusInfo não retornar 'aprovado'
                            if (statusInfo.status !== 'aprovado' && coleta.gr_aprovado !== true) {
                                alert('⚠️ O motorista deve ser aprovado no GR antes de avançar para esta etapa.');
                                return;
                            }
                        }
                    } catch (err) {
                        console.warn('⚠️ Erro ao verificar status do motorista:', err);
                        alert('⚠️ Erro ao verificar status do motorista. Não é possível avançar.');
                        return;
                    }
                }

                // Validar permissão na etapa de destino
                if (!temPermissaoEtapa(etapaDestino)) {
                    alert('Você não tem permissão para mover coletas para esta etapa.');
                    return;
                }

                // ✅ Usar endpoint que executa automações
                const response = await fetch(`/api/coletas/${coletaId}/mover-etapa`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        etapa_destino: etapaDestino
                    })
                });
                
                const result = await response.json();
                
                if (!response.ok || result.error) {
                    throw new Error(result.error || 'Erro ao mover coleta');
                }
                
                // Se automação foi aplicada, mostrar mensagem
                if (result.automacao_aplicada && result.etapa_final !== etapaDestino) {
                    const etapaFinalNome = obterNomeEtapa(result.etapa_final);
                    showNotification(`🤖 Automação aplicada! Coleta redirecionada para ${etapaFinalNome}`, 'info');
                }
                
                const data = result.coleta ? [result.coleta] : null;
                const error = result.error ? { message: result.error } : null;

                if (error) {
                    console.error('Erro detalhado do Supabase:', {
                        message: error.message,
                        details: error.details,
                        hint: error.hint,
                        code: error.code,
                        etapaDestino: etapaDestino,
                        coletaId: coletaId
                    });
                    
                    // Mensagem de erro mais específica
                    let mensagemErro = 'Erro ao mover coleta.';
                    if (error.code === '23514' || error.message?.includes('check constraint')) {
                        mensagemErro = `A etapa "${etapaDestino}" não é permitida. Verifique se a etapa está configurada corretamente no banco de dados.`;
                    } else if (error.message) {
                        mensagemErro = `Erro: ${error.message}`;
                    }
                    
                    alert(mensagemErro);
                    throw error;
                }

                // Salvar no histórico
                const etapaOrigemNome = obterNomeEtapa(etapaOrigem);
                const etapaDestinoNome = obterNomeEtapa(etapaDestino);
                await salvarNoHistorico(coletaId, 'etapa_avancada', 
                    `Coleta movida de "${etapaOrigemNome}" para "${etapaDestinoNome}" via Kanban`);

                showNotification(`Coleta movida para ${etapaDestinoNome}`, 'success');
                
                // Recarregar coletas e re-renderizar Kanban
                await carregarColetas();
            } catch (error) {
                console.error('Erro ao mover coleta:', error);
                // Não mostrar alert duplicado se já foi mostrado acima
                if (!error.message || !error.message.includes('Erro:')) {
                    alert('Erro ao mover coleta. Tente novamente.');
                }
            }
        }

        // ========== INICIALIZAÇÃO ==========
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚚 Sistema de Coletas inicializando...');
            
            // ✅ RBAC: Verificar permissão de acesso ao menu de coletas
            const temPermissaoMenu = await verificarEAplicarPermissao('coletas');
            if (!temPermissaoMenu) {
                console.log('❌ Sem permissão para acessar menu de coletas');
                return; // A função verificarEAplicarPermissao já redireciona
            }
            
            // ✅ RBAC: Validar acesso a pelo menos uma área do kanban
            const temAcesso = await validarAcessoColetas();
            if (!temAcesso) {
                return; // Página já foi substituída pela mensagem de acesso negado
            }

            try {
                // Verificar autenticação
                currentUser = verificarAutenticacao();
                if (!currentUser) return;
                
                // Configurar interface do usuário
                setupUserInfo(currentUser);
                
                // Inicializar Supabase primeiro
                console.log('🔧 Inicializando Supabase...');
                const supabaseOk = await inicializarSupabase();
                if (!supabaseOk) {
                    console.log('⚠️ Supabase não conectado, continuando offline');
                    mostrarErro('Erro ao conectar com o banco de dados');
                        return;
                }
                
                // 🔐 Carregar permissões de etapas
                permissoesEtapasColetas = await carregarPermissoesEtapasColetas();
                console.log('✅ Permissões de etapas carregadas:', permissoesEtapasColetas);
                
                // ✅ Carregar menu lateral de módulos/ferramentas PRIMEIRO (independente)
                try {
                    await carregarModulosNoSidebar();
                } catch (error) {
                    console.error('❌ Erro ao carregar módulos no sidebar:', error);
                }
                
                // 📋 Carregar funis dinâmicos do banco
                await carregarFunisDinamicos();
                
                // Inicializar campo cliente (desabilitado por padrão)
                const clienteSelect = document.getElementById('cliente');
                if (clienteSelect) {
                    clienteSelect.disabled = true;
                    clienteSelect.innerHTML = '<option value="">Selecione primeiro a filial</option>';
                }
                
                // Adicionar listener adicional para o campo filial (além do onchange inline)
                const filialSelect = document.getElementById('filial');
                if (filialSelect) {
                    filialSelect.addEventListener('change', filtrarClientesPorFilial);
                }
                
                // 🏷️ Carregar etiquetas disponíveis
                await carregarEtiquetasDisponiveis();
                
                // Inicializar componentes
                initializeDateFilters();
                setupDragAndDrop();
                setupChatInput();
                
                // ✅ OTIMIZAÇÃO: Adicionar debounce no filtro de busca
                const searchFilter = document.getElementById('searchFilter');
                if (searchFilter) {
                    const debouncedFilter = debounce(filterColetas, 300);
                    searchFilter.addEventListener('input', debouncedFilter);
                    console.log('✅ Debounce aplicado ao filtro de busca');
                }
                
                // ✅ MELHORIA UX: Adicionar atalhos de teclado
                document.addEventListener('keydown', (e) => {
                    // Ctrl/Cmd + N: Nova coleta
                    if ((e.ctrlKey || e.metaKey) && e.key === 'n' && !e.shiftKey) {
                        e.preventDefault();
                        const modal = document.getElementById('coletaModal');
                        if (!modal?.classList.contains('active')) {
                            openNewColetaModal();
                        }
                    }
                    
                    // Esc: Fechar modais
                    if (e.key === 'Escape') {
                        const modais = document.querySelectorAll('.modal-overlay.active, .modal.active, .modal.show');
                        modais.forEach(modal => {
                            const fecharBtn = modal.querySelector('[onclick*="close"], [onclick*="fechar"], .close-modal, .btn-close');
                            if (fecharBtn) {
                                fecharBtn.click();
                            } else {
                                modal.classList.remove('active', 'show');
                                modal.style.display = 'none';
                            }
                        });
                    }
                    
                    // Ctrl/Cmd + F: Focar busca (se não estiver em input/textarea)
                    if ((e.ctrlKey || e.metaKey) && e.key === 'f' && !e.target.matches('input, textarea, [contenteditable="true"]')) {
                        e.preventDefault();
                        const searchInput = document.getElementById('searchFilter');
                        if (searchInput) {
                            searchInput.focus();
                            searchInput.select();
                        }
                    }
                    
                    // Ctrl/Cmd + R: Recarregar coletas (prevenir reload da página)
                    if ((e.ctrlKey || e.metaKey) && e.key === 'r' && !e.target.matches('input, textarea')) {
                        e.preventDefault();
                        carregarColetas();
                    }
                });
                
                console.log('✅ Atalhos de teclado configurados');
                
                // Carregar dados do Supabase
                await carregarColetas();
                
                // Verificar notificações de pagamento para o criador
                await verificarNotificacoesPagamento();
                
                // Configurar listener em tempo real para atualizações de coletas
                configurarRealtimeColetas();
                
                // Verificar se há hash #funil-geral na URL e fazer scroll
                if (window.location.hash === '#funil-geral') {
                    setTimeout(() => {
                        const funilContainer = document.getElementById('funilGeralContainer');
                        if (funilContainer && funilContainer.classList.contains('visible')) {
                            funilContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
                            // Destacar o funil por um momento
                            funilContainer.style.transition = 'box-shadow 0.3s ease';
                            funilContainer.style.boxShadow = '0 0 30px rgba(102, 126, 234, 0.6)';
                            setTimeout(() => {
                                funilContainer.style.boxShadow = '';
                            }, 2000);
                        }
                    }, 1000); // Aguardar um pouco para garantir que o funil foi renderizado
                }
                
                console.log('✅ Sistema de Coletas inicializado com sucesso!');
            } catch (error) {
                console.error('❌ Erro na inicialização:', error);
                mostrarErro('Erro ao inicializar o sistema');
            }
        });

        // ========== FUNÇÕES DE AUTENTICAÇÃO ==========
        function verificarAutenticacao() {
            try {
                const userData = localStorage.getItem('loggedInUser');
                
                if (!userData) {
                    // ✅ SEGURANÇA: Logs condicionais apenas em desenvolvimento
                    if (window.DEBUG || window.location.hostname === 'localhost') {
                    console.log('❌ Usuário não autenticado, redirecionando para portal...');
                    }
                    window.location.href = 'portal.html';
                    return null;
                }
                
                const user = JSON.parse(userData);
                return user;
                
            } catch (error) {
                console.error('❌ Erro ao verificar autenticação:', error);
                window.location.href = 'portal.html';
                return null;
            }
        }
        
        // Verificar se o usuário tem permissão para acessar a página de coletas
        async function verificarPermissaoColetas() {
            try {
                const userData = localStorage.getItem('loggedInUser');
                if (!userData) {
                    window.location.href = 'portal.html';
                    return false;
                }
                
                const user = JSON.parse(userData);
                
                // Se é admin, tem acesso total
                if (user.isAdmin) {
                    // ✅ SEGURANÇA: Logs condicionais apenas em desenvolvimento
                if (window.DEBUG || window.location.hostname === 'localhost') {
                    console.log('✅ Usuário é admin, acesso liberado');
                }
                    return true;
                }
                
                // Buscar permissões no banco
                const { data: permissoes, error } = await supabaseClient
                    .from('permissoes_portal')
                    .select('permissao_id')
                    .eq('usuario_id', user.id);
                
                if (error) {
                    console.error('❌ Erro ao buscar permissões:', error);
                    // Permitir acesso básico
                    return true;
                }
                
                // Verificar se tem permissão 'coletas'
                const temPermissao = permissoes.some(p => p.permissao_id === 'coletas');
                // ✅ SEGURANÇA: Logs condicionais apenas em desenvolvimento
                if (window.DEBUG || window.location.hostname === 'localhost') {
                console.log('🔐 Usuário tem permissão de coletas:', temPermissao);
                }
                
                if (!temPermissao) {
                    // ✅ SEGURANÇA: Logs condicionais apenas em desenvolvimento
                    if (window.DEBUG || window.location.hostname === 'localhost') {
                    console.log('❌ Usuário não tem permissão de coletas');
                    }
                    // Ainda permitir acesso (fallback)
                    return true;
                }
                
                return true;
                
            } catch (error) {
                console.error('❌ Erro ao verificar permissão:', error);
                return true; // Permitir acesso em caso de erro
            }
        }

        function setupUserInfo(user) {
            const userNameEl = document.getElementById('userName');
            const userAvatarEl = document.getElementById('userAvatar');
            const userRoleEl = document.getElementById('userRole');
            
            if (userNameEl) userNameEl.textContent = user.nome || 'Usuário';
            if (userAvatarEl) userAvatarEl.textContent = (user.nome || 'US').substring(0, 2).toUpperCase();
            
            if (userRoleEl) {
            if (user.isAdmin) {
                    userRoleEl.textContent = 'Administrador';
                } else {
                    userRoleEl.textContent = 'Usuário';
                }
            }
        }

        // ========== FUNÇÕES DE SUBMENU ==========
        function toggleSubmenu(submenuId) {
            const content = document.getElementById(submenuId);
            const toggle = document.getElementById(`toggle-${submenuId}`);
            
            if (content && toggle) {
                content.classList.toggle('expanded');
                toggle.classList.toggle('expanded');
                
                // Se está expandindo, carrega o conteúdo se necessário
                if (content.classList.contains('expanded')) {
                    if (submenuId.includes('historico')) {
                        const coletaId = submenuId.replace('historico-', '');
                        carregarHistoricoParaCard(coletaId);
                    }
                }
            }
        }

        // ========== FUNÇÕES DE VALIDAÇÃO DE ETAPAS ==========
        async function vincularMotorista(coletaId) {
            try {
                // Mostrar loading
                showNotification('Carregando motoristas...', 'info');
                
                // Buscar motoristas cadastrados (primeiro lote de 100)
                const resultado = await buscarMotoristas({}, 0, 100);
                const motoristas = resultado.data || [];
                const totalMotoristas = resultado.total || 0;
                
                if (motoristas.length === 0) {
                    showNotification('Nenhum motorista cadastrado encontrado. Cadastre um motorista primeiro.', 'warning');
                    return;
                }
                
                console.log(`✅ ${motoristas.length} motorista(s) carregado(s) de ${totalMotoristas} total`);
                
                // Criar modal para seleção de motorista
                const modal = document.createElement('div');
                modal.className = 'modal fade show';
                modal.id = 'modalVincularMotorista';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; z-index: 10001; padding: 2rem;';
                modal.innerHTML = `
                    <div class="modal-vincular-dialog">
                        <header class="modal-vincular-header">
                            <h2><i class="fas fa-user-plus"></i> Vincular Motorista</h2>
                            <button type="button" class="modal-vincular-close" onclick="fecharModalMotorista()" aria-label="Fechar"><i class="fas fa-times"></i></button>
                        </header>
                        <div class="modal-vincular-body">
                            <section class="modal-vincular-filters motorista-filters">
                                <h3><i class="fas fa-filter"></i> Filtros de busca</h3>
                                <div class="motorista-filters-grid">
                                    <div>
                                        <label for="filtroNome">Nome</label>
                                        <input type="text" id="filtroNome" placeholder="Nome do motorista...">
                                    </div>
                                    <div>
                                        <label for="filtroCNH">CNH</label>
                                        <input type="text" id="filtroCNH" placeholder="Número da CNH...">
                                    </div>
                                    <div>
                                        <label for="filtroCategoria">Categoria CNH</label>
                                        <select id="filtroCategoria">
                                            <option value="">Todas</option>
                                            <option value="A">A - Moto</option>
                                            <option value="B">B - Carro</option>
                                            <option value="C">C - Caminhão</option>
                                            <option value="D">D - Ônibus</option>
                                            <option value="E">E - Caminhão + Reboque</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="filtroStatus">Status</label>
                                        <select id="filtroStatus">
                                            <option value="">Todos</option>
                                            <option value="ativo">Ativo</option>
                                            <option value="inativo">Inativo</option>
                                            <option value="suspenso">Suspenso</option>
                                        </select>
                                    </div>
                                </div>
                            </section>
                            <h3 class="modal-vincular-list-title">Selecione um motorista</h3>
                            <div class="motoristas-list" id="motoristasListContainer">
                                <div id="motoristasListContent">
                                    ${motoristas.map(motorista => {
                                        const iniciais = motorista.nome ? motorista.nome.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : 'M';
                                        const telefone = motorista.telefone1 || motorista.telefone2 || '';
                                        const telefoneFormatado = telefone ? telefone.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3') : 'N/A';
                                        const status = motorista.status || 'ativo';
                                        const badgeStyle = status === 'ativo' ? 'background: #22c55e; color: #ffffff;' : status === 'inativo' ? 'background: #475569; color: #ffffff;' : 'background: #f59e0b; color: #1e293b;';
                                        return `
                                        <div class="motorista-item" data-nome="${motorista.nome}" data-cnh="${motorista.cnh || ''}" data-categoria="${motorista.categoria_cnh || ''}" data-status="${status}" onclick="selecionarMotorista('${coletaId}', '${motorista.id}')" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.25rem; background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 0.5rem; cursor: pointer; transition: all 0.2s;">
                                            <div style="display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 0;">
                                                <div style="width: 44px; height: 44px; border-radius: 10px; background: linear-gradient(135deg, #002776 0%, #003d99 100%); display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 700; font-size: 0.9rem; flex-shrink: 0;">${iniciais}</div>
                                                <div style="flex: 1; min-width: 0;">
                                                    <div style="font-weight: 700; color: #1e293b; font-size: 1rem; margin-bottom: 0.4rem;">${escapeHtml(motorista.nome || 'N/A')}</div>
                                                    <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; font-size: 0.85rem; color: #475569;">
                                                        ${motorista.categoria_cnh ? `<span style="display: inline-flex; align-items: center; gap: 0.35rem; color: #475569;"><i class="fas fa-car" style="color: #667eea;"></i> ${escapeHtml(motorista.categoria_cnh)}</span>` : ''}
                                                        ${motorista.cnh ? `<span style="display: inline-flex; align-items: center; gap: 0.35rem; color: #475569;"><i class="fas fa-id-badge" style="color: #667eea;"></i> ${escapeHtml(motorista.cnh)}</span>` : ''}
                                                        ${telefone ? `<span style="display: inline-flex; align-items: center; gap: 0.35rem; color: #475569;"><i class="fas fa-phone" style="color: #667eea;"></i> ${telefoneFormatado}</span>` : ''}
                                                    </div>
                                                </div>
                                            </div>
                                            <span style="padding: 0.4rem 0.85rem; border-radius: 8px; font-size: 0.8rem; font-weight: 700; flex-shrink: 0; text-transform: capitalize; ${badgeStyle}">
                                                ${status}
                                            </span>
                                        </div>
                                    `;
                                    }).join('')}
                                </div>
                                ${resultado.hasMore ? `
                                <div id="carregarMaisContainer" style="text-align: center; padding: 1rem; margin-top: 0.75rem; border-top: 1px solid #e5e7eb;">
                                    <button type="button" onclick="carregarMaisMotoristas('${coletaId}')" id="btnCarregarMais" style="padding: 0.5rem 1rem; background: #002776; color: #fff; border: none; border-radius: 8px; font-weight: 600; font-size: 0.875rem; cursor: pointer;">
                                        <i class="fas fa-chevron-down" style="margin-right: 0.4rem;"></i>Carregar mais
                                    </button>
                                    <p style="margin-top: 0.5rem; font-size: 0.8125rem; color: #64748b;">${motoristas.length} de ${totalMotoristas} motoristas</p>
                                </div>
                                ` : totalMotoristas > 0 ? `
                                <div style="text-align: center; padding: 0.75rem; font-size: 0.8125rem; color: #64748b;">Todos os ${totalMotoristas} motoristas carregados</div>
                                ` : ''}
                            </div>
                            </div>
                            <footer class="modal-vincular-footer">
                                <button type="button" class="btn-cancelar" onclick="fecharModalMotorista()"><i class="fas fa-times"></i> Cancelar</button>
                                <button type="button" class="btn-cadastrar" onclick="abrirModalCadastroMotorista('${coletaId}')"><i class="fas fa-user-plus"></i> Cadastrar novo motorista</button>
                            </footer>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                // Armazenar informações de paginação e filtros
                window.motoristasPaginacao = {
                    motoristas: motoristas,
                    total: totalMotoristas,
                    from: 0,
                    limit: 100,
                    hasMore: resultado.hasMore,
                    filtros: {}
                };
                window.coletaIdVincular = coletaId;
                
                // Função debounce para otimizar buscas
                function debounce(func, wait) {
                    let timeout;
                    return function executedFunction(...args) {
                        const later = () => {
                            clearTimeout(timeout);
                            func(...args);
                        };
                        clearTimeout(timeout);
                        timeout = setTimeout(later, wait);
                    };
                }
                
                // Adicionar event listeners para filtros
                // Quando houver texto nos campos de busca (nome ou CNH), buscar no servidor
                // Caso contrário, filtrar localmente
                const filtrarComDebounce = debounce(async () => {
                    const filtroNome = document.getElementById('filtroNome')?.value.trim() || '';
                    const filtroCNH = document.getElementById('filtroCNH')?.value.trim() || '';
                    
                    // Se houver texto nos campos de busca, buscar no servidor
                    if (filtroNome.length >= 2 || filtroCNH.length >= 2) {
                        await aplicarFiltrosMotoristas(coletaId);
                    } else {
                        // Caso contrário, filtrar localmente
                        filtrarMotoristas();
                    }
                }, 500);
                
                document.getElementById('filtroNome').addEventListener('input', filtrarComDebounce);
                document.getElementById('filtroCNH').addEventListener('input', filtrarComDebounce);
                document.getElementById('filtroCategoria').addEventListener('change', async () => {
                    const filtroNome = document.getElementById('filtroNome')?.value.trim() || '';
                    const filtroCNH = document.getElementById('filtroCNH')?.value.trim() || '';
                    
                    // Se houver texto nos campos de busca, buscar no servidor
                    if (filtroNome.length >= 2 || filtroCNH.length >= 2) {
                        await aplicarFiltrosMotoristas(coletaId);
                    } else {
                        filtrarMotoristas();
                    }
                });
                document.getElementById('filtroStatus').addEventListener('change', async () => {
                    // Quando mudar o status, sempre buscar novamente do servidor
                    await aplicarFiltrosMotoristas(coletaId);
                });
                
                // Função para aplicar filtros e recarregar motoristas
                window.aplicarFiltrosMotoristas = async function(coletaId) {
                    const filtroStatus = document.getElementById('filtroStatus')?.value || '';
                    const filtroNome = document.getElementById('filtroNome')?.value.trim() || '';
                    const filtroCNH = document.getElementById('filtroCNH')?.value.trim() || '';
                    const filtroCategoria = document.getElementById('filtroCategoria')?.value || '';
                    
                    const filtros = {
                        status: filtroStatus,
                        nome: filtroNome,
                        cnh: filtroCNH,
                        categoria: filtroCategoria
                    };
                    
                    // Mostrar loading apenas se houver busca ativa
                    if (filtroNome.length >= 2 || filtroCNH.length >= 2) {
                        showNotification('Buscando motoristas...', 'info');
                    }
                    
                    const resultado = await buscarMotoristas(filtros, 0, 100);
                    
                    console.log(`🔍 Busca realizada:`, {
                        filtros: filtros,
                        encontrados: resultado.data?.length || 0,
                        total: resultado.total || 0
                    });
                    
                    window.motoristasPaginacao = {
                        motoristas: resultado.data || [],
                        total: resultado.total || 0,
                        from: 0,
                        limit: 100,
                        hasMore: resultado.hasMore,
                        filtros: filtros
                    };
                    
                    atualizarListaMotoristas(resultado.data || [], coletaId, resultado);
                };
                
                // Função para carregar mais motoristas
                window.carregarMaisMotoristas = async function(coletaId) {
                    const paginacao = window.motoristasPaginacao;
                    if (!paginacao || !paginacao.hasMore) return;
                    
                    const btnCarregarMais = document.getElementById('btnCarregarMais');
                    if (btnCarregarMais) {
                        btnCarregarMais.disabled = true;
                        btnCarregarMais.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Carregando...';
                    }
                    
                    const novoFrom = paginacao.from + paginacao.limit;
                    const resultado = await buscarMotoristas(paginacao.filtros, novoFrom, paginacao.limit);
                    
                    if (resultado.data && resultado.data.length > 0) {
                        // Adicionar novos motoristas à lista
                        const container = document.getElementById('motoristasListContent');
                        const novosItens = resultado.data.map(motorista => {
                            const iniciais = motorista.nome ? motorista.nome.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : 'M';
                            const telefone = motorista.telefone1 || motorista.telefone2 || '';
                            const telefoneFormatado = telefone ? telefone.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3') : 'N/A';
                            const status = motorista.status || 'ativo';
                            const badgeStyle = status === 'ativo' ? 'background: #22c55e; color: #ffffff;' : status === 'inativo' ? 'background: #475569; color: #ffffff;' : 'background: #f59e0b; color: #1e293b;';
                            return `
                            <div class="motorista-item" data-nome="${motorista.nome}" data-cnh="${motorista.cnh || ''}" data-categoria="${motorista.categoria_cnh || ''}" data-status="${status}" onclick="selecionarMotorista('${coletaId}', '${motorista.id}')" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.25rem; background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 0.5rem; cursor: pointer;">
                                <div style="display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 0;">
                                    <div style="width: 44px; height: 44px; border-radius: 10px; background: linear-gradient(135deg, #002776 0%, #003d99 100%); display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 700; font-size: 0.9rem; flex-shrink: 0;">${iniciais}</div>
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: 700; color: #1e293b; font-size: 1rem; margin-bottom: 0.4rem;">${escapeHtml(motorista.nome || 'N/A')}</div>
                                        <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; font-size: 0.85rem; color: #475569;">
                                            ${motorista.categoria_cnh ? `<span style="display: inline-flex; align-items: center; gap: 0.35rem;"><i class="fas fa-car" style="color: #667eea;"></i> ${escapeHtml(motorista.categoria_cnh)}</span>` : ''}
                                            ${motorista.cnh ? `<span style="display: inline-flex; align-items: center; gap: 0.35rem;"><i class="fas fa-id-badge" style="color: #667eea;"></i> ${escapeHtml(motorista.cnh)}</span>` : ''}
                                            ${telefone ? `<span style="display: inline-flex; align-items: center; gap: 0.35rem;"><i class="fas fa-phone" style="color: #667eea;"></i> ${telefoneFormatado}</span>` : ''}
                                        </div>
                                    </div>
                                </div>
                                <span style="padding: 0.4rem 0.85rem; border-radius: 8px; font-size: 0.8rem; font-weight: 700; flex-shrink: 0; text-transform: capitalize; ${badgeStyle}">${status}</span>
                            </div>
                        `;
                        }).join('');
                        container.insertAdjacentHTML('beforeend', novosItens);
                        
                        // Atualizar paginação
                        window.motoristasPaginacao.motoristas = [...window.motoristasPaginacao.motoristas, ...resultado.data];
                        window.motoristasPaginacao.from = novoFrom;
                        window.motoristasPaginacao.hasMore = resultado.hasMore;
                        
                        // Atualizar botão de carregar mais
                        const carregarMaisContainer = document.getElementById('carregarMaisContainer');
                        if (carregarMaisContainer) {
                            if (resultado.hasMore) {
                                if (btnCarregarMais) {
                                    btnCarregarMais.disabled = false;
                                    btnCarregarMais.innerHTML = '<i class="fas fa-arrow-down me-2"></i>Carregar Mais Motoristas';
                                }
                                const totalCarregados = window.motoristasPaginacao.motoristas.length;
                                const total = window.motoristasPaginacao.total;
                                carregarMaisContainer.querySelector('p').textContent = `Mostrando ${totalCarregados} de ${total} motoristas`;
                            } else {
                                carregarMaisContainer.innerHTML = `
                                    <p style="font-size: 0.85rem; color: #6c757d; margin: 0;">
                                        Todos os ${window.motoristasPaginacao.total} motoristas foram carregados
                                    </p>
                                `;
                            }
                        }
                    }
                    
                    if (btnCarregarMais && resultado.hasMore) {
                        btnCarregarMais.disabled = false;
                        btnCarregarMais.innerHTML = '<i class="fas fa-arrow-down me-2"></i>Carregar Mais Motoristas';
                    }
                };
                
            } catch (error) {
                console.error('❌ Erro ao vincular motorista:', error);
                showNotification('Erro ao carregar motoristas: ' + error.message, 'error');
            }
        }

        // Função para atualizar lista de motoristas
        function atualizarListaMotoristas(motoristas, coletaId, resultado = null) {
            const container = document.getElementById('motoristasListContent');
            if (!container) return;
            
            if (motoristas.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #6c757d;">
                        <i class="fas fa-search" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                        <p style="font-size: 1.1rem;">Nenhum motorista encontrado</p>
                        <p style="font-size: 0.9rem; color: #999;">Tente ajustar os filtros de busca</p>
                    </div>
                `;
                
                // Remover botão de carregar mais se existir
                const carregarMaisContainer = document.getElementById('carregarMaisContainer');
                if (carregarMaisContainer) carregarMaisContainer.remove();
                return;
            }
            
            container.innerHTML = motoristas.map(motorista => {
                const iniciais = motorista.nome ? motorista.nome.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase() : 'M';
                const telefone = motorista.telefone1 || motorista.telefone2 || '';
                const telefoneFormatado = telefone ? telefone.replace(/(\d{2})(\d{5})(\d{4})/, '($1) $2-$3') : 'N/A';
                const status = motorista.status || 'ativo';
                const badgeStyle = status === 'ativo' ? 'background: #22c55e; color: #ffffff;' : status === 'inativo' ? 'background: #475569; color: #ffffff;' : 'background: #f59e0b; color: #1e293b;';
                return `
                <div class="motorista-item" data-nome="${motorista.nome}" data-cnh="${motorista.cnh || ''}" data-categoria="${motorista.categoria_cnh || ''}" data-status="${status}" onclick="selecionarMotorista('${coletaId}', '${motorista.id}')" style="display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.25rem; background: #fff; border: 1px solid #e5e7eb; border-radius: 12px; margin-bottom: 0.5rem; cursor: pointer;">
                    <div style="display: flex; align-items: center; gap: 1rem; flex: 1; min-width: 0;">
                        <div style="width: 44px; height: 44px; border-radius: 10px; background: linear-gradient(135deg, #002776 0%, #003d99 100%); display: flex; align-items: center; justify-content: center; color: #fff; font-weight: 700; font-size: 0.9rem; flex-shrink: 0;">${iniciais}</div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-weight: 700; color: #1e293b; font-size: 1rem; margin-bottom: 0.4rem;">${escapeHtml(motorista.nome || 'N/A')}</div>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; font-size: 0.85rem; color: #475569;">
                                ${motorista.categoria_cnh ? `<span style="display: inline-flex; align-items: center; gap: 0.35rem;"><i class="fas fa-car" style="color: #667eea;"></i> ${escapeHtml(motorista.categoria_cnh)}</span>` : ''}
                                ${motorista.cnh ? `<span style="display: inline-flex; align-items: center; gap: 0.35rem;"><i class="fas fa-id-badge" style="color: #667eea;"></i> ${escapeHtml(motorista.cnh)}</span>` : ''}
                                ${telefone ? `<span style="display: inline-flex; align-items: center; gap: 0.35rem;"><i class="fas fa-phone" style="color: #667eea;"></i> ${telefoneFormatado}</span>` : ''}
                            </div>
                        </div>
                    </div>
                    <span style="padding: 0.4rem 0.85rem; border-radius: 8px; font-size: 0.8rem; font-weight: 700; flex-shrink: 0; text-transform: capitalize; ${badgeStyle}">${status}</span>
                </div>
            `;
            }).join('');
            
            // Atualizar ou criar botão de carregar mais
            const carregarMaisContainer = document.getElementById('carregarMaisContainer');
            if (resultado && resultado.hasMore) {
                if (!carregarMaisContainer) {
                    const container = document.getElementById('motoristasListContainer');
                    const novoContainer = document.createElement('div');
                    novoContainer.id = 'carregarMaisContainer';
                    novoContainer.style.cssText = 'text-align: center; padding: 1rem; border-top: 1px solid #e2e8f0; margin-top: 1rem;';
                    novoContainer.innerHTML = `
                        <button type="button" class="btn btn-modern btn-modern-primary" onclick="carregarMaisMotoristas('${coletaId}')" id="btnCarregarMais">
                            <i class="fas fa-arrow-down me-2"></i>Carregar Mais Motoristas
                        </button>
                        <p style="margin-top: 0.5rem; font-size: 0.85rem; color: #6c757d;">
                            Mostrando ${motoristas.length} de ${resultado.total} motoristas
                        </p>
                    `;
                    container.appendChild(novoContainer);
                } else {
                    const totalCarregados = window.motoristasPaginacao?.motoristas?.length || motoristas.length;
                    carregarMaisContainer.querySelector('p').textContent = `Mostrando ${totalCarregados} de ${resultado.total} motoristas`;
                }
            } else if (resultado && resultado.total > 0) {
                if (carregarMaisContainer) {
                    carregarMaisContainer.innerHTML = `
                        <p style="font-size: 0.85rem; color: #6c757d; margin: 0;">
                            Todos os ${resultado.total} motoristas foram carregados
                        </p>
                    `;
                }
            } else if (carregarMaisContainer) {
                carregarMaisContainer.remove();
            }
            
            // Remover mensagem de "sem motoristas" se existir
            const mensagemAnterior = document.getElementById('semMotoristasMensagem');
            if (mensagemAnterior) mensagemAnterior.remove();
        }
        
        async function cadastrarMotorista(coletaId) {
            // Abrir modal de cadastro de motorista
            openMotoristaModal(coletaId);
        }

        async function selecionarMotorista(coletaId, motoristaId) {
            try {
                // Buscar dados do motorista e da coleta para o histórico
                const coleta = coletasData.find(c => c.id === coletaId);
                const motorista = await buscarMotoristaPorId(motoristaId);
                
                const motoristaAnteriorId = coleta?.motorista_id || null;
                let detalhes = `Motorista vinculado: ${motorista?.nome || motoristaId}`;
                
                // Usuário e departamento que estão vinculando (para log e controle "quem mais contratou")
                const userData = JSON.parse(localStorage.getItem('loggedInUser') || '{}');
                const usuarioNome = currentUser?.nome || currentUser?.username || userData?.nome || userData?.email || 'Sistema';
                const usuarioId = currentUser?.id || userData?.id || null;
                const departamento = (currentUser?.departamento ?? userData?.departamento ?? 'N/A').toString().trim() || 'N/A';
                detalhes += ` | Vinculado por: ${usuarioNome} (${departamento})`;
                
                // Verificar se é o mesmo motorista
                if (motoristaAnteriorId === motoristaId) {
                    showNotification('Este motorista já está vinculado a esta coleta.', 'info');
                    fecharModalMotorista();
                    return;
                }
                
                if (motoristaAnteriorId) {
                    const motoristaAnterior = await buscarMotoristaPorId(motoristaAnteriorId);
                    detalhes = `Motorista trocado: ${motoristaAnterior?.nome || motoristaAnteriorId} → ${motorista?.nome || motoristaId} | Vinculado por: ${usuarioNome} (${departamento})`;
                }

                // Atualizar coleta com motorista vinculado
                // (sempre permite, mesmo se já tiver motorista)
                // NOTA: Não arquivar aqui - a coleta só deve ser arquivada quando finalizada (ganhou/perdeu)
                // ✅ SEMPRE resetar status do GR ao vincular motorista (primeira vinculação ou troca).
                // Cada coleta exige nova avaliação do GR para o motorista vinculado; reprovação em outra coleta não deve virar "reprovado" aqui.
                const updateData = { 
                    motorista_id: motoristaId,
                    gr_aprovado: null,
                    gr_aprovado_por: null,
                    gr_reprovado_por: null,
                    gr_motivo_reprovacao: null,
                    gr_data_reprovacao: null,
                    gr_data_aprovacao: null
                };

                // Se estava na etapa GR, voltar para contratação para exigir nova validação do GR
                if (isEtapaGR(coleta.etapa_atual)) {
                    updateData.etapa_atual = 'contratacao';
                    detalhes += ' - Nova avaliação do GR necessária';
                } else if (motoristaAnteriorId && motoristaAnteriorId !== motoristaId) {
                    detalhes += ' - Status do GR resetado (nova aprovação necessária)';
                } else if (!motoristaAnteriorId) {
                    detalhes += ' - Aguardando avaliação do GR';
                }

                const { error } = await supabaseClient
                    .from('coletas')
                    .update(updateData)
                    .eq('id', coletaId);

                if (error) throw error;

                // Registrar no histórico (com usuário e departamento para controle "quem mais contratou")
                await salvarNoHistorico(coletaId, motoristaAnteriorId ? 'motorista_trocado' : 'motorista_vinculado', detalhes, { departamento, motorista_id: motoristaId });

                // Registrar que esta coleta exige nova avaliação do GR (sempre ao vincular motorista)
                await salvarNoHistorico(coletaId, 'gr_resetado', 
                    'Nova avaliação do GR necessária para o motorista vinculado.'
                );

                showNotification('Motorista vinculado com sucesso!', 'success');
                fecharModalMotorista();
                
                // Solicitar anexo de documentação do motorista
                const confirmar = confirm('⚠️ IMPORTANTE: Anexe os documentos do motorista (CNH, CPF, etc.) para prosseguir.\n\nDeseja anexar agora?');
                if (confirmar) {
                    // Abrir modal de anexos com pequeno delay para garantir que o DOM está pronto
                    if (coleta) {
                        setTimeout(() => {
                            abrirModalAnexos(coletaId);
                            // Garantir que os event listeners estão configurados após abrir o modal
                            setTimeout(() => {
                                configurarEventListenersModalAnexos();
                            }, 100);
                        }, 200);
                    }
                }
                
                // Recarregar coletas para atualizar a interface
                await carregarColetas();
                
            } catch (error) {
                console.error('❌ Erro ao vincular motorista:', error);
                showNotification('Erro ao vincular motorista: ' + error.message, 'error');
            }
        }

        function fecharModalMotorista() {
            const modal = document.getElementById('modalVincularMotorista');
            if (modal) {
                modal.remove();
            }
            // Também remover qualquer modal de cadastro
            const modalCadastro = document.getElementById('modalCadastroMotorista');
            if (modalCadastro) {
                modalCadastro.remove();
            }
        }
        
        // ✅ FUNÇÃO PARA ABRIR MODAL DE CADASTRO RÁPIDO DE MOTORISTA
        async function abrirModalCadastroMotorista(coletaId) {
            // Fechar modal de vinculação primeiro
            fecharModalMotorista();
            
            // Criar modal de cadastro (mesmo padrão visual do Vincular Motorista)
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.id = 'modalCadastroMotorista';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; z-index: 10002; padding: 2rem;';
            modal.innerHTML = `
                <div class="modal-cadastro-dialog">
                    <header class="modal-cadastro-header">
                        <h2><i class="fas fa-user-plus"></i> Cadastrar Novo Motorista</h2>
                        <button type="button" class="modal-cadastro-close" onclick="fecharModalCadastroMotorista()" aria-label="Fechar"><i class="fas fa-times"></i></button>
                    </header>
                    <div class="modal-cadastro-body">
                        <form id="formCadastroMotoristaRapido">
                            <section class="modal-cadastro-section">
                                <h3><i class="fas fa-id-card"></i> Informações Pessoais</h3>
                                <div class="modal-cadastro-grid cols-2">
                                    <div style="grid-column: span 2;">
                                        <label for="nomeMotorista">Nome Completo *</label>
                                        <input type="text" id="nomeMotorista" required placeholder="Ex: João da Silva" maxlength="100">
                                    </div>
                                    <div>
                                        <label for="cnhMotorista">CNH</label>
                                        <input type="text" id="cnhMotorista" placeholder="00000000000" maxlength="11" pattern="[0-9]{11}" title="CNH deve conter exatamente 11 dígitos numéricos">
                                    </div>
                                    <div>
                                        <label for="categoriaCNH">Categoria CNH</label>
                                        <select id="categoriaCNH">
                                            <option value="">Selecione</option>
                                            <option value="A">A - Motos</option>
                                            <option value="B">B - Carros</option>
                                            <option value="C">C - Caminhões</option>
                                            <option value="D">D - Ônibus</option>
                                            <option value="E">E - Carreta</option>
                                        </select>
                                    </div>
                                </div>
                            </section>
                            <section class="modal-cadastro-section">
                                <h3><i class="fas fa-phone"></i> Contatos</h3>
                                <div class="modal-cadastro-grid">
                                    <div>
                                        <label for="telefone1Motorista">Telefone 1 *</label>
                                        <input type="text" id="telefone1Motorista" required placeholder="5511999999999" maxlength="13" pattern="[0-9]{11,13}" title="Telefone deve ter 11 ou 13 dígitos (formato: 55+DDD+9+Número)">
                                        <span class="field-hint">Formato: 55+DDD+9+Número</span>
                                    </div>
                                    <div>
                                        <label for="telefone2Motorista">Telefone 2</label>
                                        <input type="text" id="telefone2Motorista" placeholder="5511888888888" maxlength="13" pattern="[0-9]{11,13}" title="Telefone deve ter 11 ou 13 dígitos (formato: 55+DDD+9+Número)">
                                    </div>
                                    <div>
                                        <label for="estadoMotorista">Estado (DDD)</label>
                                        <select id="estadoMotorista">
                                            <option value="">Selecione o estado</option>
                                            <option value="SP">São Paulo</option>
                                            <option value="RJ">Rio de Janeiro</option>
                                            <option value="MG">Minas Gerais</option>
                                            <option value="ES">Espírito Santo</option>
                                            <option value="PR">Paraná</option>
                                            <option value="SC">Santa Catarina</option>
                                            <option value="RS">Rio Grande do Sul</option>
                                            <option value="MS">Mato Grosso do Sul</option>
                                            <option value="MT">Mato Grosso</option>
                                            <option value="GO">Goiás</option>
                                            <option value="DF">Distrito Federal</option>
                                            <option value="BA">Bahia</option>
                                            <option value="SE">Sergipe</option>
                                            <option value="AL">Alagoas</option>
                                            <option value="PE">Pernambuco</option>
                                            <option value="PB">Paraíba</option>
                                            <option value="RN">Rio Grande do Norte</option>
                                            <option value="CE">Ceará</option>
                                            <option value="PI">Piauí</option>
                                            <option value="MA">Maranhão</option>
                                            <option value="PA">Pará</option>
                                            <option value="AP">Amapá</option>
                                            <option value="AM">Amazonas</option>
                                            <option value="RR">Roraima</option>
                                            <option value="AC">Acre</option>
                                            <option value="RO">Rondônia</option>
                                            <option value="TO">Tocantins</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="cidadeMotorista">Cidade</label>
                                        <input type="text" id="cidadeMotorista" placeholder="Ex: São Paulo" maxlength="100">
                                    </div>
                                </div>
                            </section>
                            <section class="modal-cadastro-section">
                                <h3><i class="fas fa-truck"></i> Veículo</h3>
                                <div class="modal-cadastro-grid">
                                    <div>
                                        <label for="classeVeiculoMotorista">Classe do veículo</label>
                                        <select id="classeVeiculoMotorista">
                                            <option value="">Selecione</option>
                                            <option value="leve">Leve</option>
                                            <option value="medio">Médio</option>
                                            <option value="pesado">Pesado</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="tipoVeiculoMotorista">Tipo de veículo</label>
                                        <select id="tipoVeiculoMotorista" disabled>
                                            <option value="">Selecione a classe primeiro</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="tipoCarroceriaMotorista">Tipo de carroceria</label>
                                        <select id="tipoCarroceriaMotorista" disabled>
                                            <option value="">Selecione a classe primeiro</option>
                                        </select>
                                    </div>
                                </div>
                            </section>
                            <section class="modal-cadastro-section">
                                <h3><i class="fas fa-id-card-alt"></i> Placas</h3>
                                <div class="modal-cadastro-grid modal-cadastro-grid-4">
                                    <div>
                                        <label for="placaCavaloMotorista">Placa do cavalo</label>
                                        <input type="text" id="placaCavaloMotorista" placeholder="ABC1D23" maxlength="7" style="text-transform: uppercase;">
                                    </div>
                                    <div>
                                        <label for="placaCarreta1Motorista">Placa carreta 1</label>
                                        <input type="text" id="placaCarreta1Motorista" placeholder="XYZ4W56" maxlength="7" style="text-transform: uppercase;">
                                    </div>
                                    <div>
                                        <label for="placaCarreta2Motorista">Placa carreta 2</label>
                                        <input type="text" id="placaCarreta2Motorista" placeholder="QRS7T89" maxlength="7" style="text-transform: uppercase;">
                                    </div>
                                    <div>
                                        <label for="placaCarreta3Motorista">Placa carreta 3</label>
                                        <input type="text" id="placaCarreta3Motorista" placeholder="LMN8P10" maxlength="7" style="text-transform: uppercase;">
                                    </div>
                                </div>
                            </section>
                        </form>
                    </div>
                    <footer class="modal-cadastro-footer">
                        <button type="button" class="btn-cancelar" onclick="fecharModalCadastroMotorista()"><i class="fas fa-times"></i> Cancelar</button>
                        <button type="button" class="btn-cadastrar" onclick="salvarMotoristaRapido('${coletaId}')"><i class="fas fa-save"></i> Salvar e Vincular</button>
                    </footer>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Inicializar selects dinâmicos de veículo (classe -> tipo_veiculo / tipo_carroceria)
            const tiposVeiculoCadastro = { leve: ['3/4', 'Fiorino', 'Toco', 'VLC'], medio: ['Bitruck', 'Truck'], pesado: ['Bitrem', 'Carreta', 'Carreta LS', 'Rodotrem', 'Vanderleia'] };
            const bodyworkByClassCadastro = { leve: ['bau', 'bau_frigorifico', 'bau_refrigerado', 'cacamba', 'prancha'], medio: ['bau', 'bau_frigorifico', 'sider', 'graneleiro', 'plataforma', 'basculante', 'cacamba'], pesado: ['bau', 'sider', 'graneleiro', 'grade_baixa', 'bitrem', 'carreta', 'carreta_ls', 'rodotrem', 'vanderleia', 'apenas_cavalo', 'cegonheiro', 'gaiola', 'tanque', 'porta_container_20', 'porta_container_40', 'basculante', 'cacamba'] };
            const tiposCarroceriaMapCadastro = { bau: 'Baú', bau_frigorifico: 'Baú Frigorífico', bau_refrigerado: 'Baú Refrigerado', sider: 'Sider', cacamba: 'Caçamba', graneleiro: 'Graneleiro', plataforma: 'Plataforma', prancha: 'Prancha', bitrem: 'Bitrem', carreta: 'Carreta', carreta_ls: 'Carreta LS', rodotrem: 'Rodotrem', vanderleia: 'Vanderleia', apenas_cavalo: 'Apenas Cavalo', cegonheiro: 'Cegonheiro', gaiola: 'Gaiola', tanque: 'Tanque', grade_baixa: 'Grade Baixa', basculante: 'Basculante', porta_container_20: 'Porta Container 20', porta_container_40: 'Porta Container 40' };
            const selClasse = document.getElementById('classeVeiculoMotorista');
            const selTipo = document.getElementById('tipoVeiculoMotorista');
            const selCarroceria = document.getElementById('tipoCarroceriaMotorista');
            if (selClasse && selTipo && selCarroceria) {
                selClasse.addEventListener('change', function() {
                    const classe = this.value;
                    selTipo.innerHTML = '<option value="">Não informado</option>';
                    selCarroceria.innerHTML = '<option value="">Não informado</option>';
                    selTipo.disabled = !classe;
                    selCarroceria.disabled = !classe;
                    if (classe && tiposVeiculoCadastro[classe]) {
                        tiposVeiculoCadastro[classe].forEach(t => { const o = document.createElement('option'); o.value = t.toLowerCase().replace(/ /g, '_'); o.textContent = t; selTipo.appendChild(o); });
                    }
                    if (classe && bodyworkByClassCadastro[classe]) {
                        bodyworkByClassCadastro[classe].forEach(t => { const o = document.createElement('option'); o.value = t; o.textContent = tiposCarroceriaMapCadastro[t] || t; selCarroceria.appendChild(o); });
                    }
                });
            }
        }
        
        function fecharModalCadastroMotorista() {
            const modal = document.getElementById('modalCadastroMotorista');
            if (modal) {
                modal.remove();
            }
        }
        
        // ✅ FUNÇÃO PARA SALVAR MOTORISTA RÁPIDO E VINCULAR À COLETA
        async function salvarMotoristaRapido(coletaId) {
            try {
                // Usuário logado (obrigatório para usuario_id na tabela motoristas)
                const userId = (typeof currentUser !== 'undefined' && currentUser) ? (currentUser.id || currentUser.user_id || currentUser.userId) : null;
                if (!userId) {
                    showNotification('Não foi possível identificar o usuário. Faça login novamente.', 'error');
                    return;
                }
                
                // Validar campos obrigatórios
                const nomeEl = document.getElementById('nomeMotorista');
                const telefone1El = document.getElementById('telefone1Motorista');
                
                if (!nomeEl || !telefone1El) {
                    showNotification('Erro: Campos do formulário não encontrados', 'error');
                    return;
                }
                
                const nome = nomeEl.value.trim();
                const telefone1 = telefone1El.value.trim();
                
                if (!nome) {
                    showNotification('Nome completo é obrigatório', 'error');
                    return;
                }
                
                if (!telefone1) {
                    showNotification('Telefone 1 é obrigatório', 'error');
                    return;
                }
                
                // Normalizar telefones
                const normalizarTelefone = (tel) => {
                    if (!tel) return null;
                    const apenasNumeros = tel.replace(/\D/g, '');
                    if (apenasNumeros.length === 13 && apenasNumeros.startsWith('55')) {
                        return apenasNumeros;
                    }
                    if (apenasNumeros.length === 11) {
                        return '55' + apenasNumeros;
                    }
                    return apenasNumeros.length >= 11 ? apenasNumeros : null;
                };
                
                const telefone1Normalizado = normalizarTelefone(telefone1);
                if (!telefone1Normalizado || (telefone1Normalizado.length !== 13 && telefone1Normalizado.length !== 11)) {
                    showNotification('Telefone 1 inválido. Use o formato: 5511999999999 ou 11999999999', 'error');
                    return;
                }
                
                const telefone2El = document.getElementById('telefone2Motorista');
                const telefone2 = telefone2El ? telefone2El.value.trim() : '';
                const telefone2Normalizado = telefone2 ? normalizarTelefone(telefone2) : null;
                
                // Normalizar CNH
                const cnhEl = document.getElementById('cnhMotorista');
                const cnh = cnhEl ? cnhEl.value.trim() : '';
                const cnhNormalizada = cnh ? cnh.replace(/\D/g, '') : null;
                if (cnhNormalizada && cnhNormalizada.length !== 11) {
                    showNotification('CNH deve conter exatamente 11 dígitos numéricos', 'error');
                    return;
                }
                
                // Verificar se telefone já existe
                if (!supabaseClient) {
                    showNotification('Erro: Supabase não inicializado', 'error');
                    return;
                }
                
                const { data: telefoneExistente } = await supabaseClient
                    .from('motoristas')
                    .select('id, nome')
                    .or(`telefone1.eq.${telefone1Normalizado},telefone2.eq.${telefone1Normalizado}`);
                
                if (telefoneExistente && telefoneExistente.length > 0) {
                    showNotification(`Este telefone já está cadastrado para: ${telefoneExistente[0].nome}`, 'warning');
                    return;
                }
                
                // Normalizar placa (uppercase, apenas A-Z0-9, max 7)
                const normalizarPlaca = (v) => {
                    if (!v || typeof v !== 'string') return null;
                    const s = v.toUpperCase().replace(/\s/g, '').replace(/[^A-Z0-9]/g, '').slice(0, 7);
                    return s.length >= 1 ? s : null;
                };
                const placaCavalo = normalizarPlaca(document.getElementById('placaCavaloMotorista')?.value);
                const placaCarreta1 = normalizarPlaca(document.getElementById('placaCarreta1Motorista')?.value);
                const placaCarreta2 = normalizarPlaca(document.getElementById('placaCarreta2Motorista')?.value);
                const placaCarreta3 = normalizarPlaca(document.getElementById('placaCarreta3Motorista')?.value);
                const classeVeiculo = (document.getElementById('classeVeiculoMotorista')?.value || '').trim() || null;
                let tipoVeiculo = (document.getElementById('tipoVeiculoMotorista')?.value || '').trim() || null;
                let tipoCarroceria = (document.getElementById('tipoCarroceriaMotorista')?.value || '').trim() || null;
                if (!tipoVeiculo || tipoVeiculo === '') tipoVeiculo = 'nao_informado';
                if (!tipoCarroceria || tipoCarroceria === '') tipoCarroceria = 'nao_informado';
                
                // Preparar dados do motorista (usuario_id e created_by obrigatórios na tabela)
                // Nota: coluna 'cidade' não existe na tabela motoristas
                const motoristaData = {
                    nome: nome,
                    telefone1: telefone1Normalizado,
                    telefone2: telefone2Normalizado,
                    cnh: cnhNormalizada,
                    categoria_cnh: (document.getElementById('categoriaCNH')?.value) || null,
                    estado: (document.getElementById('estadoMotorista')?.value) || null,
                    classe_veiculo: classeVeiculo,
                    tipo_veiculo: tipoVeiculo,
                    tipo_carroceria: tipoCarroceria,
                    placa_cavalo: placaCavalo,
                    placa_carreta1: placaCarreta1,
                    placa_carreta2: placaCarreta2,
                    placa_carreta3: placaCarreta3,
                    status: 'ativo',
                    usuario_id: userId,
                    created_by: userId,
                    created_by_departamento: (typeof currentUser !== 'undefined' && currentUser && currentUser.departamento) ? currentUser.departamento : 'coletas',
                    data_cadastro: new Date().toISOString(),
                    data_atualizacao: new Date().toISOString()
                };
                
                // Salvar motorista
                const { data: novoMotorista, error } = await supabaseClient
                    .from('motoristas')
                    .insert([motoristaData])
                    .select()
                    .single();
                
                if (error) {
                    console.error('❌ Supabase insert motoristas:', error);
                    throw error;
                }
                
                showNotification('✅ Motorista cadastrado com sucesso!', 'success');
                
                // Fechar modal de cadastro
                fecharModalCadastroMotorista();
                
                // Vincular motorista à coleta automaticamente
                await selecionarMotorista(coletaId, novoMotorista.id);
                
            } catch (error) {
                console.error('❌ Erro ao cadastrar motorista:', error);
                const msg = (error && (error.message || error.details || error.hint)) ? (error.message || error.details || error.hint) : 'Erro ao salvar';
                showNotification('Erro ao cadastrar motorista: ' + msg, 'error');
            }
        }

        // Função para trocar motorista (usa a mesma lógica de vincular)
        async function trocarMotorista(coletaId) {
            console.log('🔄 Função trocarMotorista chamada:', { coletaId });
            // Reutilizar a função vincularMotorista, que já permite trocar motorista
            await vincularMotorista(coletaId);
        }

        // Função para filtrar motoristas
        function filtrarMotoristas() {
            const filtroNome = document.getElementById('filtroNome')?.value.toLowerCase() || '';
            const filtroCNH = document.getElementById('filtroCNH')?.value.toLowerCase() || '';
            const filtroCategoria = document.getElementById('filtroCategoria')?.value || '';
            const filtroStatus = document.getElementById('filtroStatus')?.value || '';
            
            const motoristasItens = document.querySelectorAll('.motorista-item');
            let totalVisiveis = 0;
            
            motoristasItens.forEach(item => {
                const nome = item.dataset.nome?.toLowerCase() || '';
                const cnh = item.dataset.cnh?.toLowerCase() || '';
                const categoria = item.dataset.categoria || '';
                const status = item.dataset.status || '';
                
                const matchNome = !filtroNome || nome.includes(filtroNome);
                const matchCNH = !filtroCNH || cnh.includes(filtroCNH);
                const matchCategoria = !filtroCategoria || categoria === filtroCategoria;
                const matchStatus = !filtroStatus || status === filtroStatus;
                
                if (matchNome && matchCNH && matchCategoria && matchStatus) {
                    item.style.display = 'flex';
                    totalVisiveis++;
                } else {
                    item.style.display = 'none';
                }
            });
            
            // Mostrar mensagem se nenhum motorista encontrado
            const container = document.getElementById('motoristasListContainer');
            const mensagemAnterior = document.getElementById('semMotoristasMensagem');
            if (mensagemAnterior) mensagemAnterior.remove();
            
            if (totalVisiveis === 0 && motoristasItens.length > 0) {
                const mensagem = document.createElement('div');
                mensagem.id = 'semMotoristasMensagem';
                mensagem.style.cssText = 'text-align: center; padding: 2rem; color: #6c757d;';
                mensagem.innerHTML = `
                    <i class="fas fa-search" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                    <p style="font-size: 1.1rem;">Nenhum motorista encontrado com os filtros aplicados</p>
                    <p style="font-size: 0.9rem; color: #999;">Tente ajustar os filtros de busca</p>
                `;
                container.appendChild(mensagem);
            }
        }

        async function aprovarGR(coletaId) {
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta) return;

            // 🔐 Verificar permissão para a etapa GR
            if (!temPermissaoEtapa('gr')) {
                showNotification('⚠️ Você não tem permissão para aprovar GR', 'warning');
                // ✅ SEGURANÇA: Logs condicionais apenas em desenvolvimento
                if (window.DEBUG || window.location.hostname === 'localhost') {
                console.log('❌ Usuário não tem permissão para etapa: gr');
                }
                return;
            }

            try {
                // Aprovar GR
                const { error } = await supabaseClient
                    .from('coletas')
                    .update({ 
                        gr_aprovado: true,
                        gr_aprovado_por: currentUser.nome || currentUser.username,
                        gr_data_aprovacao: new Date().toISOString()
                    })
                    .eq('id', coletaId);

                if (error) throw error;

                // Salvar no histórico
                await salvarNoHistorico(coletaId, 'GR Aprovado', `Aprovado por ${currentUser.nome || currentUser.username}`);

                // Avançar automaticamente usando sistema de automações
                // Isso permite que as automações baseadas em tags definam a próxima etapa
                const etapaAtual = coleta.etapa_atual || 'gr';
                const etapaPadrao = 'documentacao'; // Etapa padrão caso nenhuma automação se aplique
                
                try {
                    // Usar o endpoint mover-etapa que já executa as automações
                    const response = await fetch(`/api/coletas/${coletaId}/mover-etapa`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            etapa_destino: etapaPadrao,
                            funil_id: coleta.funil_id || null
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        const etapaFinalNome = ETAPAS.find(e => e.id === result.etapa_final)?.nome || result.etapa_final;
                        
                        if (result.automacao_aplicada) {
                            showNotification(`✅ GR aprovado! Automação aplicada: Coleta avançada para ${etapaFinalNome}`, 'success');
                        } else {
                            showNotification(`✅ GR aprovado! Coleta avançada para ${etapaFinalNome}`, 'success');
                        }
                        
                        // Salvar no histórico do avanço
                        await salvarNoHistorico(coletaId, 'etapa_avancada', 
                            `Etapa avançada de GR para ${etapaFinalNome} após aprovação${result.automacao_aplicada ? ' (via automação)' : ''}`
                        );
                    } else {
                        throw new Error(result.error || 'Erro ao mover etapa');
                    }
                } catch (moveError) {
                    console.error('❌ Erro ao mover etapa após aprovação GR:', moveError);
                    // Se falhar, tentar mover diretamente para documentação como fallback
                const etapaDocumentacao = ETAPAS.find(e => e.id === 'documentacao');
                if (etapaDocumentacao) {
                    const { error: updateError } = await supabaseClient
                        .from('coletas')
                        .update({ 
                            etapa_atual: 'documentacao',
                            updated_at: new Date().toISOString()
                        })
                        .eq('id', coletaId);

                    if (updateError) throw updateError;
                    showNotification(`✅ GR aprovado! Coleta avançada para ${etapaDocumentacao.nome}`, 'success');
                } else {
                    showNotification('✅ Coleta aprovada pelo GR!', 'success');
                    }
                }

                await carregarColetas();
                
            } catch (error) {
                console.error('❌ Erro ao aprovar GR:', error);
                showNotification('Erro ao aprovar GR: ' + error.message, 'error');
            }
        }

        async function solicitarAtualizacaoDocumento(coletaId) {
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta || !coleta.motorista_id) {
                showNotification('⚠️ É necessário ter motorista vinculado para solicitar atualização de documentos.', 'warning');
                return;
            }

            // Criar modal para solicitar atualização
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; z-index: 10001; padding: 2rem;';
            modal.innerHTML = `
                <div class="modal-dialog" style="background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); max-width: 600px; width: 100%;">
                    <div class="modal-content" style="padding: 0;">
                        <div class="modal-header" style="background: linear-gradient(135deg, #002776 0%, #0044AA 100%); color: white; border-radius: 20px 20px 0 0; padding: 1.5rem 2rem;">
                            <h5 class="modal-title"><i class="fas fa-file-upload"></i> Solicitar Atualização de Documento</h5>
                            <button type="button" class="btn-close" onclick="this.closest('.modal').remove()" style="background: none; border: none; color: white; font-size: 1.5rem; cursor: pointer;">&times;</button>
                        </div>
                        <div class="modal-body" style="padding: 2rem;">
                            <form id="formSolicitarDoc">
                                <div class="form-group" style="margin-bottom: 1.5rem;">
                                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Categoria do Documento *</label>
                                    <select id="categoriaDocumento" class="form-control" required style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 10px;">
                                        <option value="">Selecione a categoria</option>
                                        <option value="proprietario">Documentos - Proprietário</option>
                                        <option value="veiculo">Documentos - Veículo</option>
                                        <option value="motorista">Documentos - Motorista</option>
                                    </select>
                                </div>
                                <div class="form-group" style="margin-bottom: 1.5rem;">
                                    <label style="font-weight: 600; margin-bottom: 0.5rem; display: block;">Motivo da Solicitação *</label>
                                    <textarea id="motivoSolicitacao" class="form-control" required rows="4" placeholder="Ex: CNH vencida, documento ilegível, falta de comprovante de residência..." style="width: 100%; padding: 0.75rem; border: 2px solid #e9ecef; border-radius: 10px; resize: vertical;"></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer" style="padding: 1.5rem 2rem; background: #f8f9fa; border-top: 1px solid #e9ecef; border-radius: 0 0 20px 20px;">
                            <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">Cancelar</button>
                            <button type="button" class="btn btn-primary" onclick="confirmarSolicitacaoDoc('${coletaId}')" style="background: linear-gradient(135deg, #002776 0%, #0044AA 100%); border: none; padding: 0.75rem 2rem; border-radius: 10px; font-weight: 600;">
                                <i class="fas fa-paper-plane"></i> Enviar Solicitação
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);

            // Fechar modal ao clicar no backdrop
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        async function confirmarSolicitacaoDoc(coletaId) {
            const categoria = document.getElementById('categoriaDocumento')?.value;
            const motivo = document.getElementById('motivoSolicitacao')?.value;

            if (!categoria || !motivo) {
                showNotification('⚠️ Preencha todos os campos obrigatórios.', 'warning');
                return;
            }

            try {
                // Obter headers de autenticação
                const headers = await getSupabaseAuthHeaders();
                
                // Verificar se o token foi obtido
                if (!headers.Authorization) {
                    console.error('❌ Token de autenticação não disponível');
                    // Tentar obter sessão novamente
                    if (supabaseClient) {
                        const { data, error } = await supabaseClient.auth.getSession();
                        if (error) {
                            throw new Error('Erro ao obter sessão: ' + error.message);
                        }
                        if (data?.session?.access_token) {
                            headers.Authorization = `Bearer ${data.session.access_token}`;
                        } else {
                            throw new Error('Sessão não encontrada. Faça login novamente.');
                        }
                    } else {
                        throw new Error('Supabase não inicializado. Recarregue a página.');
                    }
                }
                
                headers['Content-Type'] = 'application/json';
                
                console.log('📤 Enviando solicitação de atualização de documento:', {
                    coletaId,
                    categoria,
                    temToken: !!headers.Authorization
                });
                
                const response = await fetch(`/api/coletas/${encodeURIComponent(coletaId)}/solicitar-atualizacao-documento`, {
                    method: 'POST',
                    headers,
                    credentials: 'include',
                    body: JSON.stringify({ categoria, motivo: motivo.trim() })
                });

                const result = await response.json();

                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('Não autenticado. Faça login novamente.');
                    }
                    throw new Error(result.error || 'Erro ao criar solicitação');
                }

                showNotification('✅ Solicitação de atualização enviada ao motorista!', 'success');
                
                // Fechar modal
                const modal = document.querySelector('.modal.show');
                if (modal) {
                    modal.remove();
                }

                // Recarregar coletas para atualizar interface
                await carregarColetas();
            } catch (error) {
                console.error('❌ Erro ao solicitar atualização:', error);
                showNotification('Erro ao enviar solicitação: ' + error.message, 'error');
            }
        }

        async function reprovarGR(coletaId) {
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta) return;

            // 🔐 Verificar permissão para a etapa GR
            if (!temPermissaoEtapa('gr')) {
                showNotification('⚠️ Você não tem permissão para reprovar GR', 'warning');
                // ✅ SEGURANÇA: Logs condicionais apenas em desenvolvimento
                if (window.DEBUG || window.location.hostname === 'localhost') {
                console.log('❌ Usuário não tem permissão para etapa: gr');
                }
                return;
            }

            try {
                // Criar modal para motivo da reprovação
                const modal = document.createElement('div');
                modal.className = 'modal fade show';
                modal.id = 'modalReprovarGR';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; z-index: 10001; padding: 2rem;';
                modal.innerHTML = `
                    <div class="modal-dialog" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%); backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); max-width: 600px; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
                        <div class="modal-content" style="padding: 0; background: transparent;">
                            <div class="modal-header" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; padding: 1.5rem; border-radius: 20px 20px 0 0;">
                                <h5 class="modal-title" style="margin: 0; font-size: 1.5rem; font-weight: 600;"><i class="fas fa-exclamation-triangle"></i> Reprovar GR</h5>
                                <button type="button" class="btn-close" style="filter: invert(1); opacity: 0.9; font-size: 1.5rem;" onclick="this.closest('.modal').remove()"></button>
                            </div>
                            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 2rem;">
                                <p style="margin-bottom: 1rem; color: #333; font-size: 1rem;">Informe o motivo da reprovação:</p>
                                <textarea id="motivoReprovacao" class="form-control" rows="6" placeholder="Digite o motivo da reprovação..." required style="width: 100%; padding: 1rem; border: 2px solid #e9ecef; border-radius: 10px; font-size: 1rem; resize: vertical; min-height: 120px;"></textarea>
                            </div>
                            <div class="modal-footer" style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: flex-end; gap: 1rem; border-radius: 0 0 20px 20px;">
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()" style="padding: 0.75rem 2rem; border-radius: 10px; border: none; font-weight: 600;">Cancelar</button>
                                <button type="button" class="btn btn-danger" onclick="confirmarReprovarGR('${coletaId}')" style="padding: 0.75rem 2rem; border-radius: 10px; border: none; font-weight: 600; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                                    <i class="fas fa-times"></i> Reprovar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Fechar modal ao clicar no backdrop (fora do conteúdo)
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        delete window.confirmarReprovarGR;
                    }
                });

                // Adicionar função global temporária
                window.confirmarReprovarGR = async (coletaId) => {
                    const motivoEl = document.getElementById('motivoReprovacao');
                    const motivo = motivoEl ? motivoEl.value.trim() : '';
                    if (!motivo) {
                        showNotification('Por favor, informe o motivo da reprovação.', 'warning');
                        return;
                    }

                    try {
                        // Reprovar GR e voltar para etapa anterior (Contratação)
                        const etapaAnterior = ETAPAS.find(e => e.id === 'contratacao');
                        
                        const { error: updateError } = await supabaseClient
                    .from('coletas')
                            .update({ 
                                gr_aprovado: false,
                                gr_reprovado_por: currentUser.nome || currentUser.username || currentUser.email,
                                gr_motivo_reprovacao: motivo,
                                gr_data_reprovacao: new Date().toISOString(),
                                etapa_atual: 'contratacao', // Volta para Contratação
                                updated_at: new Date().toISOString()
                            })
                            .eq('id', coletaId);

                        if (updateError) throw updateError;

                        // Salvar no histórico da reprovação
                        await salvarNoHistorico(coletaId, 'GR Reprovação', 
                            `Reprovado por ${currentUser.nome || currentUser.username || currentUser.email}. Motivo: ${motivo}`
                        );

                        // Salvar no histórico da volta de etapa
                        await salvarNoHistorico(coletaId, 'etapa_retornada', 
                            `Etapa voltou de GR para ${etapaAnterior?.nome || 'Contratação'} após reprovação`
                        );

                        showNotification(`⚠️ GR reprovado! Coleta voltou para etapa de ${etapaAnterior?.nome || 'Contratação'}.`, 'warning');
                        modal.remove();
                        delete window.confirmarReprovarGR;
                        await carregarColetas();
                        
                    } catch (error) {
                        console.error('❌ Erro ao reprovar GR:', error);
                        showNotification('Erro ao reprovar GR: ' + error.message, 'error');
                    }
                };
                
            } catch (error) {
                console.error('❌ Erro ao criar modal de reprovação:', error);
                showNotification('Erro ao abrir modal de reprovação: ' + error.message, 'error');
            }
        }

        async function voltarEtapa(coletaId, etapaDestino) {
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta) return;

            // 🔐 Verificar permissão para a etapa atual
            if (!temPermissaoEtapa(coleta.etapa_atual)) {
                showNotification('⚠️ Você não tem permissão para alterar esta etapa', 'warning');
                // ✅ SEGURANÇA: Logs condicionais apenas em desenvolvimento
                if (window.DEBUG || window.location.hostname === 'localhost') {
                console.log(`❌ Usuário não tem permissão para etapa: ${coleta.etapa_atual}`);
                }
                return;
            }

            try {
                const etapaOrigemNome = obterNomeEtapa(coleta.etapa_atual);
                const etapaDestinoNome = obterNomeEtapa(etapaDestino);

                const { error } = await supabaseClient
                    .from('coletas')
                    .update({ 
                        etapa_atual: etapaDestino,
                        data_atualizacao: new Date().toISOString()
                    })
                    .eq('id', coletaId);

                if (error) throw error;

                // Salvar no histórico
                await salvarNoHistorico(coletaId, 'etapa_retornada', `Etapa voltou de ${etapaOrigemNome} para ${etapaDestinoNome}`);

                showNotification(`Coleta voltou para etapa ${etapaDestinoNome}!`, 'info');
                await carregarColetas();
                
            } catch (error) {
                console.error('❌ Erro ao voltar etapa:', error);
                showNotification('Erro ao voltar etapa: ' + error.message, 'error');
            }
        }

        // ========== FUNÇÕES SUPABASE - MOTORISTAS ==========
        
        /**
         * Verifica o status do motorista para uma coleta específica
         * Considera se a coleta já passou pela etapa GR
         * @param {Object} motorista - Objeto do motorista
         * @param {Object} coleta - Objeto da coleta (deve ter etapa_atual, gr_aprovado, id)
         * @returns {Object} - { status: 'neutro'|'aprovado'|'reprovado', motivo: string|null, reprovado_por: string|null, data_reprovacao: string|null, aprovado_por: string|null, data_aprovacao: string|null }
         */
        function verificarStatusMotoristaPorColeta(motorista, coleta) {
            if (!motorista || !coleta || !coleta.id) {
                return { status: 'neutro', motivo: null, reprovado_por: null, data_reprovacao: null, aprovado_por: null, data_aprovacao: null };
            }
            
            // Verificar se a coleta já passou pela etapa GR
            const etapas = ['comercial', 'price', 'cs', 'contratacao', 'gr', 'documentacao', 'controladoria', 'ti', 'contas_pagar', 'contas_receber', 'monitoramento', 'servicos_adicionais', 'finalizar_operacao'];
            const etapaAtualIndex = etapas.indexOf(coleta.etapa_atual);
            const etapaGRIndex = etapas.indexOf('gr');
            const passouPeloGR = etapaAtualIndex > etapaGRIndex || isEtapaGR(coleta.etapa_atual);
            
            // Se NÃO passou pelo GR ainda, status é NEUTRO
            if (!passouPeloGR && coleta.gr_aprovado === null) {
                return { 
                    status: 'neutro', 
                    motivo: null, 
                    reprovado_por: null, 
                    data_reprovacao: null,
                    aprovado_por: null,
                    data_aprovacao: null
                };
            }
            
            // Se está na etapa GR mas ainda não foi aprovado/reprovado, status é NEUTRO
            if (isEtapaGR(coleta.etapa_atual) && (coleta.gr_aprovado === null || coleta.gr_aprovado === undefined)) {
                return { 
                    status: 'neutro', 
                    motivo: null, 
                    reprovado_por: null, 
                    data_reprovacao: null,
                    aprovado_por: null,
                    data_aprovacao: null
                };
            }
            
            // Se passou pelo GR, verificar se foi aprovado ou reprovado
            // Verificar reprovação no histórico do motorista
            const historicoReprovacoes = motorista.historico_reprovacoes || [];
            let reprovado = false;
            let motivo = null;
            let reprovado_por = null;
            let data_reprovacao = null;
            
            if (Array.isArray(historicoReprovacoes) && historicoReprovacoes.length > 0) {
                const reprovacaoEstaColeta = historicoReprovacoes.find(hist => hist.coleta_id === coleta.id);
                if (reprovacaoEstaColeta) {
                    reprovado = true;
                    motivo = reprovacaoEstaColeta.motivo || null;
                    reprovado_por = reprovacaoEstaColeta.reprovado_por || null;
                    data_reprovacao = reprovacaoEstaColeta.data_reprovacao || null;
                }
            }
            
            // Verificar também o campo coleta_id_reprovacao (compatibilidade)
            if (!reprovado && motorista.coleta_id_reprovacao === coleta.id) {
                reprovado = true;
                motivo = motorista.motivo_reprovacao || null;
                reprovado_por = motorista.reprovado_por || null;
                data_reprovacao = motorista.data_reprovacao || null;
            }
            
            // Verificar se foi reprovado no GR (coleta.gr_aprovado === false)
            if (coleta.gr_aprovado === false) {
                reprovado = true;
                // Se não tem motivo no histórico, usar o motivo do GR
                if (!motivo) {
                    motivo = coleta.gr_motivo_reprovacao || null;
                }
                if (!reprovado_por) {
                    reprovado_por = coleta.gr_reprovado_por || null;
                }
                if (!data_reprovacao) {
                    data_reprovacao = coleta.gr_data_reprovacao || null;
                }
            }
            
            // Se foi reprovado, retornar status reprovado
            if (reprovado) {
                return { 
                    status: 'reprovado', 
                    motivo, 
                    reprovado_por, 
                    data_reprovacao,
                    aprovado_por: null,
                    data_aprovacao: null
                };
            }
            
            // Se passou pelo GR e foi aprovado (gr_aprovado === true), status é APROVADO
            if (coleta.gr_aprovado === true) {
                return { 
                    status: 'aprovado', 
                    motivo: null, 
                    reprovado_por: null, 
                    data_reprovacao: null,
                    aprovado_por: coleta.gr_aprovado_por || null,
                    data_aprovacao: coleta.gr_data_aprovacao || null
                };
            }
            
            // Se passou pelo GR mas não tem status definido, ainda é neutro
            return { 
                status: 'neutro', 
                motivo: null, 
                reprovado_por: null, 
                data_reprovacao: null,
                aprovado_por: null,
                data_aprovacao: null
            };
        }
        
        /**
         * Verifica se um motorista foi reprovado ESPECIFICAMENTE para uma coleta
         * DEPRECATED: Use verificarStatusMotoristaPorColeta ao invés desta função
         * Mantida para compatibilidade
         * @param {Object} motorista - Objeto do motorista
         * @param {string} coletaId - ID da coleta a verificar
         * @returns {Object} - { reprovado: boolean, motivo: string|null, reprovado_por: string|null, data_reprovacao: string|null }
         */
        function verificarReprovacaoPorColeta(motorista, coletaId) {
            if (!motorista || !coletaId) {
                return { reprovado: false, motivo: null, reprovado_por: null, data_reprovacao: null };
            }
            
            // Buscar a coleta para verificar status completo
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta) {
                return { reprovado: false, motivo: null, reprovado_por: null, data_reprovacao: null };
            }
            
            const statusInfo = verificarStatusMotoristaPorColeta(motorista, coleta);
            return { 
                reprovado: statusInfo.status === 'reprovado', 
                motivo: statusInfo.motivo, 
                reprovado_por: statusInfo.reprovado_por, 
                data_reprovacao: statusInfo.data_reprovacao 
            };
        }
        
        async function buscarMotoristas(filtros = {}, from = 0, limit = 100) {
            try {
                // Verificar se o Supabase está inicializado
                if (!supabaseClient) {
                    console.error('❌ Supabase não inicializado');
                    return { data: [], hasMore: false, total: 0 };
                }
                
                // Construir query com filtros opcionais
                let query = supabaseClient
                    .from('motoristas')
                    .select('id, nome, cnh, categoria_cnh, telefone1, telefone2, status, estado, classe_veiculo, tipo_veiculo, tipo_carroceria', { count: 'exact' });
                
                // Aplicar filtro de status apenas se especificado
                if (filtros.status && filtros.status.trim() !== '') {
                    query = query.eq('status', filtros.status);
                }
                
                // Aplicar filtro de nome (busca parcial - case insensitive)
                if (filtros.nome && filtros.nome.trim() !== '') {
                    const nomeBusca = filtros.nome.trim();
                    // Usar ilike para busca case-insensitive e parcial
                    query = query.ilike('nome', `%${nomeBusca}%`);
                }
                
                // Aplicar filtro de CNH (busca parcial)
                if (filtros.cnh && filtros.cnh.trim() !== '') {
                    query = query.ilike('cnh', `%${filtros.cnh.trim()}%`);
                }
                
                // Aplicar filtro de categoria
                if (filtros.categoria && filtros.categoria.trim() !== '') {
                    query = query.eq('categoria_cnh', filtros.categoria);
                }
                
                // Ordenar por nome
                query = query.order('nome', { ascending: true });
                
                // Aplicar paginação
                query = query.range(from, from + limit - 1);
                
                const { data, error, count } = await query;

                if (error) {
                    console.error('❌ Erro ao buscar motoristas:', error);
                    throw error;
                }
                
                const total = count || 0;
                const hasMore = (from + limit) < total;
                
                return { 
                    data: data || [], 
                    hasMore: hasMore,
                    total: total,
                    from: from,
                    limit: limit
                };
            } catch (error) {
                console.error('❌ Erro ao buscar motoristas:', error);
                return { data: [], hasMore: false, total: 0 };
            }
        }

        async function buscarMotoristaPorId(motoristaId) {
            try {
                if (!supabaseClient || !motoristaId) {
                    console.warn('⚠️ Supabase não inicializado ou motoristaId inválido:', { supabase: !!supabaseClient, motoristaId });
                    return null;
                }
                
                console.log('🔍 Buscando motorista por ID:', motoristaId);
                
                // Buscar todos os campos incluindo histórico de reprovações
                // Usar select('*') primeiro e depois adicionar campos específicos se necessário
                let query = supabaseClient
                    .from('motoristas')
                    .select('*')
                    .eq('id', motoristaId);
                
                const { data, error } = await query.single();

                if (error) {
                    console.error('❌ Erro ao buscar motorista:', error);
                    console.error('❌ Detalhes do erro:', {
                        message: error.message,
                        code: error.code,
                        details: error.details,
                        hint: error.hint
                    });
                    
                    // Se o erro for por campo não encontrado, tentar sem os campos problemáticos
                    if (error.code === '42703' || error.message?.includes('column') || error.message?.includes('campo')) {
                        console.warn('⚠️ Tentando buscar sem campos específicos de reprovação...');
                        const { data: dataFallback, error: errorFallback } = await supabaseClient
                            .from('motoristas')
                            .select('*')
                            .eq('id', motoristaId)
                            .single();
                        
                        if (!errorFallback && dataFallback) {
                            console.log('✅ Motorista encontrado (fallback):', dataFallback.id);
                            return dataFallback;
                        }
                    }
                    
                    throw error;
                }
                
                // Log detalhado de todos os campos relacionados a reprovação
                console.log('✅ Motorista encontrado:', {
                    id: data?.id,
                    nome: data?.nome,
                    reprovado: data?.reprovado,
                    reprovado_tipo: typeof data?.reprovado,
                    reprovado_valor_exato: JSON.stringify(data?.reprovado),
                    quantidade_reprovacoes: data?.quantidade_reprovacoes,
                    historico_length: Array.isArray(data?.historico_reprovacoes) ? data.historico_reprovacoes.length : 'N/A',
                    historico_reprovacoes: data?.historico_reprovacoes,
                    motivo_reprovacao: data?.motivo_reprovacao,
                    reprovado_por: data?.reprovado_por,
                    data_reprovacao: data?.data_reprovacao,
                    // Verificar se tem qualquer indicador de reprovação
                    tem_indicadores_reprovacao: {
                        reprovado_true: data?.reprovado === true,
                        reprovado_string_true: data?.reprovado === 'true',
                        quantidade_maior_zero: (data?.quantidade_reprovacoes || 0) > 0,
                        historico_nao_vazio: Array.isArray(data?.historico_reprovacoes) && data.historico_reprovacoes.length > 0,
                        tem_motivo: !!data?.motivo_reprovacao
                    }
                });
                
                return data;
            } catch (error) {
                console.error('❌ Erro completo ao buscar motorista:', error);
                return null;
            }
        }

        async function carregarInfoMotorista(coletaId, motoristaId, anexos) {
            console.log('🔄 Carregando informações do motorista:', { coletaId, motoristaId });
            
            const motoristaInfoDiv = document.getElementById(`motorista-info-${coletaId}`);
            
            if (!motoristaInfoDiv) {
                console.warn('⚠️ Elemento motorista-info não encontrado para coleta:', coletaId);
                return;
            }
            
            // Limpar conteúdo anterior antes de adicionar novo para evitar duplicação
            motoristaInfoDiv.innerHTML = '';
            
            // Buscar informações da coleta para verificar a etapa atual
            const coleta = coletasData.find(c => c.id === coletaId);
            const coletaEstaEmGR = coleta && isEtapaGR(coleta.etapa_atual);
            
            const motorista = await buscarMotoristaPorId(motoristaId);
            
            if (!motorista) {
                console.error('❌ Motorista não encontrado:', motoristaId);
                motoristaInfoDiv.innerHTML = '<span style="color: #dc3545;"><i class="fas fa-exclamation-triangle"></i> Erro ao carregar motorista</span>';
                return;
            }
            
            // Verificar status completo do motorista para esta coleta
            const statusInfo = verificarStatusMotoristaPorColeta(motorista, coleta);
            const statusMotorista = statusInfo.status; // 'neutro', 'aprovado', 'reprovado'
            const isReprovado = statusMotorista === 'reprovado';
            const isAprovado = statusMotorista === 'aprovado';
            const isNeutro = statusMotorista === 'neutro';
            
            console.log('📊 Status do motorista (por coleta):', { 
                coleta_id: coletaId,
                etapa_atual: coleta?.etapa_atual,
                gr_aprovado: coleta?.gr_aprovado,
                nome: motorista.nome, 
                status: statusMotorista,
                motivo: statusInfo.motivo?.substring(0, 30)
            });
            
            // Determinar visual e tag baseado no status
            let cardBackground, cardBorder, cardBorderWidth, cardBoxShadow, tagStatus;
            
            if (isReprovado) {
                cardBackground = 'linear-gradient(135deg, rgba(220, 53, 69, 0.2) 0%, rgba(200, 35, 51, 0.25) 100%)';
                cardBorder = '#dc3545';
                cardBorderWidth = '3px';
                cardBoxShadow = '0 4px 12px rgba(220, 53, 69, 0.3), 0 0 0 1px rgba(220, 53, 69, 0.2)';
                tagStatus = coleta && coleta.etapa_atual === 'contratacao' ? 'REPROVADO NO GR' : 'MOTORISTA REPROVADO';
            } else if (isAprovado) {
                cardBackground = 'linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(32, 201, 151, 0.1) 100%)';
                cardBorder = '#28a745';
                cardBorderWidth = '2px';
                cardBoxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
                tagStatus = 'APROVADO NO GR';
            } else {
                // Status neutro (pendente de análise GR)
                cardBackground = 'linear-gradient(135deg, rgba(108, 117, 125, 0.1) 0%, rgba(134, 142, 150, 0.1) 100%)';
                cardBorder = '#6c757d';
                cardBorderWidth = '2px';
                cardBoxShadow = '0 2px 8px rgba(0, 0, 0, 0.1)';
                tagStatus = 'PENDENTE DE ANÁLISE GR';
            }
            
                motoristaInfoDiv.innerHTML = `
                    <div style="padding: 1rem; background: ${cardBackground}; border: ${cardBorderWidth} solid ${cardBorder}; border-radius: 10px; box-shadow: ${cardBoxShadow}; width: 100%;">
                        <div style="display: flex; flex-wrap: wrap; gap: 1rem; align-items: center; width: 100%;">
                            <div style="flex: 1; min-width: 200px;">
                                <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                    <strong style="color: ${isReprovado ? '#dc3545' : '#1f2937'}; font-size: 1.1rem;">${motorista.nome}</strong>
                                    ${isReprovado ? `
                                        <span style="background: #dc3545; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 2px 6px rgba(220, 53, 69, 0.4);">
                                            <i class="fas fa-times-circle"></i> ${tagStatus}
                                        </span>
                                    ` : `
                                        <span style="background: #28a745; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px;">
                                            <i class="fas fa-check-circle"></i> APROVADO
                                        </span>
                                    `}
                                </div>
                                ${isReprovado && reprovacaoInfo.motivo ? `
                                    <div style="margin-top: 0.75rem; padding: 0.75rem; background: rgba(220, 53, 69, 0.15); border-left: 4px solid #dc3545; border-radius: 6px;">
                                        <div style="color: #dc3545; font-weight: 600; font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                                            <i class="fas fa-info-circle"></i> Motivo da Reprovação
                                        </div>
                                        <div style="color: #721c24; font-size: 0.85rem; line-height: 1.5;">
                                            ${statusInfo.motivo.length > 100 ? statusInfo.motivo.substring(0, 100) + '...' : statusInfo.motivo}
                                        </div>
                                        ${statusInfo.reprovado_por && statusInfo.data_reprovacao ? `
                                            <div style="color: #6c757d; font-size: 0.75rem; margin-top: 0.5rem; font-style: italic;">
                                                Por ${escapeHtml(statusInfo.reprovado_por)} em ${new Date(statusInfo.data_reprovacao).toLocaleDateString('pt-BR')} às ${new Date(statusInfo.data_reprovacao).toLocaleTimeString('pt-BR')}
                                            </div>
                                        ` : ''}
                                    </div>
                                ` : ''}
                            <div style="font-size: 0.85rem; color: #6c757d; margin-top: 0.3rem;">
                                <span><i class="fas fa-id-badge"></i> CNH: ${motorista.cnh || 'N/A'}</span>
                                ${motorista.classe_veiculo ? `<span style="margin-left: 1rem;"><i class="fas fa-car"></i> ${motorista.classe_veiculo}</span>` : ''}
                            </div>
                            <div style="font-size: 0.85rem; color: #6c757d; margin-top: 0.3rem;">
                                <span><i class="fas fa-car"></i> ${motorista.categoria_cnh || 'N/A'}</span>
                                <span style="margin-left: 1rem;"><i class="fas fa-phone"></i> ${motorista.telefone1 || 'N/A'}</span>
                            </div>
                        </div>
                        <div style="display: flex; gap: 0.5rem; align-items: center; flex-wrap: wrap;">
                        ${anexos && anexos.length > 0 ? `
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.5rem 1rem; border-radius: 10px; font-size: 0.85rem; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
                                <i class="fas fa-paperclip"></i> ${anexos.length} Documento(s)
                            </div>
                        ` : ''}
                            ${isReprovado ? `
                                <button onclick="event.stopPropagation(); trocarMotorista('${coletaId}')" 
                                        style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%); color: white; border: none; padding: 0.5rem 1rem; border-radius: 10px; font-size: 0.85rem; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3); transition: transform 0.2s;"
                                        onmouseover="this.style.transform='scale(1.05)'" 
                                        onmouseout="this.style.transform='scale(1)'"
                                        title="Trocar Motorista">
                                    <i class="fas fa-exchange-alt"></i> Trocar
                                </button>
                            ` : coletaEstaEmGR ? `
                                <button onclick="event.stopPropagation(); reprovarMotorista('${coletaId}', '${motoristaId}')" 
                                        style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; border: none; padding: 0.5rem 1rem; border-radius: 10px; font-size: 0.85rem; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3); transition: transform 0.2s;"
                                        onmouseover="this.style.transform='scale(1.05)'" 
                                        onmouseout="this.style.transform='scale(1)'"
                                        title="Reprovar Motorista (Apenas na etapa GR)">
                                    <i class="fas fa-times-circle"></i> Reprovar
                                </button>
                                <button onclick="event.stopPropagation(); trocarMotorista('${coletaId}')" 
                                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.5rem 1rem; border-radius: 10px; font-size: 0.85rem; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); transition: transform 0.2s;"
                                        onmouseover="this.style.transform='scale(1.05)'" 
                                        onmouseout="this.style.transform='scale(1)'"
                                        title="Trocar Motorista">
                                    <i class="fas fa-exchange-alt"></i> Trocar
                                </button>
                            ` : `
                                <button onclick="event.stopPropagation(); trocarMotorista('${coletaId}')" 
                                        style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.5rem 1rem; border-radius: 10px; font-size: 0.85rem; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3); transition: transform 0.2s;"
                                        onmouseover="this.style.transform='scale(1.05)'" 
                                        onmouseout="this.style.transform='scale(1)'"
                                        title="Trocar Motorista">
                                    <i class="fas fa-exchange-alt"></i> Trocar
                                </button>
                            `}
                        </div>
                    </div>
                `;
            
            // Atualizar o card do motorista com a cor correta
            const motoristaCard = document.getElementById(`motorista-card-wrapper-${coletaId}`);
            const motoristaLabel = document.getElementById(`motorista-label-${coletaId}`);
            
            if (motoristaCard) {
                motoristaCard.style.background = cardBackground;
                motoristaCard.style.borderColor = cardBorder;
                
                // Atualizar sombra e hover para motoristas reprovados
                if (isReprovado) {
                    motoristaCard.setAttribute('onmouseover', 'this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 4px 12px rgba(220, 53, 69, 0.3)\';');
                } else {
                    motoristaCard.setAttribute('onmouseover', 'this.style.transform=\'translateY(-2px)\'; this.style.boxShadow=\'0 4px 12px rgba(40, 167, 69, 0.3)\';');
                }
            }
            
            // Atualizar o título do card se motorista estiver reprovado
            if (motoristaLabel) {
                if (isReprovado) {
                    motoristaLabel.style.color = '#dc3545';
                    const labelSpan = motoristaLabel.querySelector('span');
                    if (labelSpan) {
                        labelSpan.innerHTML = '<i class="fas fa-user-times"></i> Motorista Reprovado';
                    }
                } else {
                    motoristaLabel.style.color = '#28a745';
                    const labelSpan = motoristaLabel.querySelector('span');
                    if (labelSpan) {
                        labelSpan.innerHTML = '<i class="fas fa-user-check"></i> Motorista Vinculado';
                    }
                }
            }
            
            console.log('✅ Informações do motorista carregadas com sucesso');
        }

        window.solicitarAtivacaoLocalizacao = async function(coletaId) {
            try {
                const coleta = coletasData.find(c => c.id === coletaId);
                if (!coleta || !coleta.motorista_id) {
                    showNotification('⚠️ É necessário ter motorista vinculado para solicitar ativação de localização.', 'warning');
                    return;
                }

                const confirmar = confirm(
                    `📍 Solicitar Ativação de Localização GPS\n\n` +
                    `Você está prestes a solicitar ao motorista que ative a localização GPS para esta coleta.\n\n` +
                    `O motorista receberá uma notificação e poderá ativar a localização diretamente pelo portal.\n\n` +
                    `Deseja continuar?`
                );

                if (!confirmar) {
                    return;
                }

                // Obter nome do usuário atual
                const usuario = currentUser?.nome || currentUser?.email || 'Sistema';

                // Fazer solicitação via API
                const headers = await getSupabaseAuthHeaders();
                
                const response = await fetch(`/api/coletas/${coletaId}/solicitar-ativacao-localizacao`, {
                    method: 'POST',
                    headers: {
                        ...headers,
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        motivo: 'Solicitação de ativação de localização GPS para rastreamento em tempo real'
                    })
                });

                const result = await response.json();

                if (!response.ok || !result.success) {
                    throw new Error(result.error || 'Erro ao criar solicitação');
                }

                showNotification('✅ Solicitação de ativação de localização enviada ao motorista com sucesso!', 'success');

            } catch (error) {
                console.error('❌ Erro ao solicitar ativação de localização:', error);
                showNotification('Erro ao enviar solicitação: ' + (error.message || 'Erro desconhecido'), 'error');
            }
        }

        async function verDetalhesMotorista(coletaId) {
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta || !coleta.motorista_id) return;
            
            const motorista = await buscarMotoristaPorId(coleta.motorista_id);
            if (!motorista) return;
            
            const anexos = await carregarAnexos(coletaId);
            const coletaEstaEmGR = coleta && isEtapaGR(coleta.etapa_atual);
            
            // Criar modal com detalhes do motorista
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; z-index: 10001; padding: 2rem;';
            modal.innerHTML = `
                <div class="modal-dialog" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%); backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); max-width: 700px; width: 100%; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-content" style="padding: 2rem;">
                        <div class="modal-header" style="margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 2px solid #e9ecef; display: flex; justify-content: space-between; align-items: center;">
                            <h5 class="modal-title" style="font-size: 1.5rem; font-weight: 700; color: #28a745; display: flex; align-items: center; gap: 0.7rem;">
                                <i class="fas fa-user-tie"></i>
                                Detalhes do Motorista
                            </h5>
                            <button class="btn-close" onclick="this.closest('.modal').remove()"></button>
                        </div>
                        
                        <!-- Informações do Motorista -->
                        <div style="background: ${motorista.reprovado ? 'linear-gradient(135deg, rgba(220, 53, 69, 0.1) 0%, rgba(200, 35, 51, 0.1) 100%)' : 'linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(32, 201, 151, 0.1) 100%)'}; padding: 1.5rem; border-radius: 15px; margin-bottom: 2rem; border: 1px solid ${motorista.reprovado ? '#dc3545' : '#28a745'};">
                            ${motorista.reprovado || (motorista.quantidade_reprovacoes && motorista.quantidade_reprovacoes > 0) ? `
                                <div style="background: rgba(220, 53, 69, 0.2); padding: 1rem; border-radius: 10px; margin-bottom: 1.5rem; border-left: 4px solid #dc3545;">
                                    <div style="display: flex; align-items: center; gap: 0.5rem; color: #dc3545; font-weight: 700; font-size: 1rem; margin-bottom: 0.5rem;">
                                        <i class="fas fa-exclamation-triangle"></i>
                                        Motorista Reprovado
                                        ${motorista.quantidade_reprovacoes ? `
                                            <span style="background: #dc3545; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.85rem; margin-left: 0.5rem;">
                                                ${motorista.quantidade_reprovacoes} ${motorista.quantidade_reprovacoes === 1 ? 'reprovação' : 'reprovações'}
                                            </span>
                                        ` : ''}
                                    </div>
                                    ${motorista.motivo_reprovacao ? `
                                        <div style="color: #721c24; font-size: 0.9rem; margin-bottom: 0.5rem; font-style: italic; background: white; padding: 0.8rem; border-radius: 8px;">
                                            <strong>Último Motivo:</strong> ${escapeHtml(motorista.motivo_reprovacao)}
                                        </div>
                                    ` : ''}
                                    <div style="color: #6c757d; font-size: 0.85rem;">
                                        ${motorista.reprovado_por ? `<span><i class="fas fa-user"></i> Última reprovação por: ${escapeHtml(motorista.reprovado_por)}</span>` : ''}
                                        ${motorista.data_reprovacao ? `<span style="margin-left: 1rem;"><i class="fas fa-calendar"></i> ${new Date(motorista.data_reprovacao).toLocaleDateString('pt-BR')} às ${new Date(motorista.data_reprovacao).toLocaleTimeString('pt-BR')}</span>` : ''}
                                    </div>
                                </div>
                            ` : ''}
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                                <div>
                                    <strong style="color: ${motorista.reprovado ? '#dc3545' : '#28a745'}; font-size: 0.9rem;">Nome Completo</strong>
                                    <div style="font-size: 1.1rem; margin-top: 0.5rem;">${motorista.nome}</div>
                                </div>
                                <div>
                                    <strong style="color: ${motorista.reprovado ? '#dc3545' : '#28a745'}; font-size: 0.9rem;">CNH</strong>
                                    <div style="font-size: 1.1rem; margin-top: 0.5rem;">${motorista.cnh || 'N/A'}</div>
                                </div>
                                ${motorista.classe_veiculo ? `
                                <div>
                                    <strong style="color: ${motorista.reprovado ? '#dc3545' : '#28a745'}; font-size: 0.9rem;">Classe Veículo</strong>
                                    <div style="font-size: 1.1rem; margin-top: 0.5rem;">${motorista.classe_veiculo}</div>
                                </div>
                                ` : ''}
                                <div>
                                    <strong style="color: ${motorista.reprovado ? '#dc3545' : '#28a745'}; font-size: 0.9rem;">Categoria</strong>
                                    <div style="font-size: 1.1rem; margin-top: 0.5rem;">${motorista.categoria_cnh || 'N/A'}</div>
                                </div>
                                <div>
                                    <strong style="color: ${motorista.reprovado ? '#dc3545' : '#28a745'}; font-size: 0.9rem;">Telefone</strong>
                                    <div style="font-size: 1.1rem; margin-top: 0.5rem;">${motorista.telefone1 || motorista.telefone2 || 'N/A'}</div>
                                </div>
                                <div>
                                    <strong style="color: ${motorista.reprovado ? '#dc3545' : '#28a745'}; font-size: 0.9rem;">Estado</strong>
                                    <div style="font-size: 1.1rem; margin-top: 0.5rem;">${motorista.estado || 'N/A'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Histórico de Reprovações -->
                        ${motorista.quantidade_reprovacoes && motorista.quantidade_reprovacoes > 0 ? `
                            <div style="margin-bottom: 1.5rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                    <h6 style="font-size: 1.1rem; font-weight: 700; color: #dc3545; display: flex; align-items: center; gap: 0.5rem;">
                                        <i class="fas fa-history"></i>
                                        Histórico de Reprovações (${motorista.quantidade_reprovacoes})
                                    </h6>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0.8rem; max-height: 400px; overflow-y: auto;">
                                    ${(motorista.historico_reprovacoes && Array.isArray(motorista.historico_reprovacoes) ? motorista.historico_reprovacoes : []).map((reprovacao, index) => `
                                        <div style="background: rgba(220, 53, 69, 0.1); padding: 1rem; border-radius: 10px; border-left: 4px solid #dc3545; border: 1px solid rgba(220, 53, 69, 0.3);">
                                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                                <div style="color: #dc3545; font-weight: 600; font-size: 0.9rem;">
                                                    <i class="fas fa-times-circle"></i> Reprovação #${index + 1}
                                                </div>
                                                <div style="color: #6c757d; font-size: 0.85rem;">
                                                    ${reprovacao.data_reprovacao ? new Date(reprovacao.data_reprovacao).toLocaleDateString('pt-BR') + ' às ' + new Date(reprovacao.data_reprovacao).toLocaleTimeString('pt-BR') : 'Data não informada'}
                                                </div>
                                            </div>
                                            ${reprovacao.motivo ? `
                                                <div style="color: #333; font-size: 0.9rem; margin-bottom: 0.5rem; background: white; padding: 0.75rem; border-radius: 6px;">
                                                    <strong>Motivo:</strong> ${escapeHtml(reprovacao.motivo)}
                                                </div>
                                            ` : ''}
                                            <div style="display: flex; gap: 1rem; flex-wrap: wrap; color: #6c757d; font-size: 0.85rem;">
                                                ${reprovacao.reprovado_por ? `
                                                    <span><i class="fas fa-user"></i> Por: ${escapeHtml(reprovacao.reprovado_por)}</span>
                                                ` : ''}
                                                ${reprovacao.coleta_id ? `
                                                    <span><i class="fas fa-box"></i> Coleta: ${reprovacao.coleta_id.substring(0, 8)}...</span>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Documentos Anexados -->
                        <div style="margin-bottom: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                                <h6 style="font-size: 1.1rem; font-weight: 700; color: #333; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-paperclip"></i>
                                    Documentos Anexados (${anexos?.length || 0})
                                </h6>
                                <button class="btn btn-primary" onclick="event.stopPropagation(); abrirModalAnexos('${coletaId}')" style="padding: 0.5rem 1rem; font-size: 0.85rem;">
                                    <i class="fas fa-plus"></i> Adicionar
                                </button>
                            </div>
                            ${anexos && anexos.length > 0 ? `
                                <div style="display: flex; flex-direction: column; gap: 0.8rem; max-height: 400px; overflow-y: auto;">
                                    ${anexos.map(anexo => `
                                        <div style="background: white; padding: 1rem; border-radius: 10px; border: 1px solid #e9ecef; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                                            <div style="display: flex; align-items: center; gap: 1rem; flex: 1;">
                                                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center; color: white;">
                                                    <i class="fas ${getFileIcon(anexo.tipo_arquivo)}"></i>
                                                </div>
                                                <div>
                                                    <div style="font-weight: 600; color: #333;">${anexo.nome_arquivo}</div>
                                                    <div style="font-size: 0.85rem; color: #6c757d;">${formatFileSize(anexo.tamanho)} • ${anexo.tipo_arquivo || 'N/A'}</div>
                                                </div>
                                            </div>
                                            <div style="display: flex; gap: 0.5rem;">
                                                <button class="btn btn-sm btn-info" onclick="event.stopPropagation(); visualizarAnexo('${anexo.id}')" title="Visualizar">
                                    <i class="fas fa-eye"></i>
                                </button>
                                                <button class="btn btn-sm btn-success" onclick="event.stopPropagation(); downloadAnexoDireto('${anexo.id}')" title="Baixar">
                                                    <i class="fas fa-download"></i>
                                </button>
                            </div>
                                        </div>
                                    `).join('')}
                                </div>
                            ` : `
                                <div style="text-align: center; padding: 2rem; background: #f8f9fa; border-radius: 10px; color: #6c757d;">
                                    <i class="fas fa-file-alt" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                                    <p>Nenhum documento anexado ainda</p>
                                </div>
                            `}
                        </div>
                        
                        <div class="modal-footer" style="padding-top: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: space-between; gap: 1rem; flex-wrap: wrap;">
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap;">
                                <button class="btn btn-primary" onclick="event.stopPropagation(); solicitarAtivacaoLocalizacao('${coletaId}'); this.closest('.modal').remove();" style="padding: 0.75rem 1.5rem; border-radius: 10px; border: none; font-weight: 600; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                                    <i class="fas fa-map-marker-alt me-2"></i>
                                    Solicitar Localização GPS
                                </button>
                                <button class="btn btn-warning" onclick="event.stopPropagation(); trocarMotorista('${coletaId}')" style="padding: 0.75rem 1.5rem; border-radius: 10px; border: none; font-weight: 600;">
                                    <i class="fas fa-exchange-alt"></i> Trocar Motorista
                                </button>
                                ${!motorista.reprovado && coletaEstaEmGR ? `
                                    <button class="btn btn-danger" onclick="event.stopPropagation(); reprovarMotorista('${coletaId}', '${motorista.id}')" style="padding: 0.75rem 1.5rem; border-radius: 10px; border: none; font-weight: 600; margin-left: 0.5rem;">
                                        <i class="fas fa-times-circle"></i> Reprovar Motorista
                                    </button>
                                ` : ''}
                            </div>
                            <button class="btn btn-secondary" onclick="this.closest('.modal').remove()" style="padding: 0.75rem 1.5rem; border-radius: 10px; border: none; font-weight: 600;">Fechar</button>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
            
            // Fechar modal ao clicar no backdrop
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }

        async function visualizarTermoAceito(coletaId) {
            try {
                // Mostrar loading
                const loadingModal = document.createElement('div');
                loadingModal.className = 'modal fade show';
                loadingModal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; z-index: 10001;';
                loadingModal.innerHTML = `
                    <div style="background: white; padding: 2rem; border-radius: 15px; text-align: center;">
                        <i class="fas fa-spinner fa-spin fa-3x" style="color: #667eea; margin-bottom: 1rem;"></i>
                        <p>Carregando termo aceito...</p>
                    </div>
                `;
                document.body.appendChild(loadingModal);

                // Buscar termo aceito
                const response = await fetch(`/api/rastreamento/termo-aceito?coletaId=${coletaId}`);
                const result = await response.json();

                loadingModal.remove();

                if (!result.success) {
                    showNotification(result.error || 'Erro ao buscar termo aceito', 'error');
                    return;
                }

                if (!result.termo) {
                    showNotification('Nenhum termo aceito encontrado para esta coleta', 'warning');
                    return;
                }

                const termo = result.termo;
                const motoristaInfo = termo.motorista_info || {};
                const dataAceite = termo.aceito_em ? new Date(termo.aceito_em) : null;

                // Criar modal com o termo
                const modal = document.createElement('div');
                modal.className = 'modal fade show';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; z-index: 10001; padding: 2rem;';
                modal.innerHTML = `
                    <div class="modal-dialog" style="background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); max-width: 900px; width: 100%; max-height: 90vh; overflow-y: auto;">
                        <div class="modal-content" style="padding: 2rem;">
                            <div class="modal-header" style="margin-bottom: 2rem; padding-bottom: 1.5rem; border-bottom: 2px solid #e9ecef; display: flex; justify-content: space-between; align-items: center;">
                                <h5 class="modal-title" style="font-size: 1.5rem; font-weight: 700; color: #10b981; display: flex; align-items: center; gap: 0.7rem;">
                                    <i class="fas fa-file-signature"></i>
                                    Termo de Rastreamento Aceito
                                </h5>
                                <button class="btn-close" onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #999;">&times;</button>
                            </div>
                            
                            <!-- Informações do Termo -->
                            <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%); padding: 1.5rem; border-radius: 15px; margin-bottom: 2rem; border: 1px solid #10b981;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                                    <div>
                                        <strong style="color: #10b981; font-size: 0.9rem;">Motorista</strong>
                                        <div style="font-size: 1.1rem; margin-top: 0.5rem;">${escapeHtml(termo.motorista_nome_termo || motoristaInfo.nome || 'N/A')}</div>
                                    </div>
                                    <div>
                                        <strong style="color: #10b981; font-size: 0.9rem;">CNH</strong>
                                        <div style="font-size: 1.1rem; margin-top: 0.5rem;">${escapeHtml(termo.motorista_cnh_termo || motoristaInfo.cnh || 'N/A')}</div>
                                    </div>
                                    <div>
                                        <strong style="color: #10b981; font-size: 0.9rem;">Versão do Termo</strong>
                                        <div style="font-size: 1.1rem; margin-top: 0.5rem;">${escapeHtml(termo.termo_versao || 'N/A')}</div>
                                    </div>
                                    ${dataAceite ? `
                                    <div>
                                        <strong style="color: #10b981; font-size: 0.9rem;">Data de Aceite</strong>
                                        <div style="font-size: 1.1rem; margin-top: 0.5rem;">${dataAceite.toLocaleDateString('pt-BR')} às ${dataAceite.toLocaleTimeString('pt-BR')}</div>
                                    </div>
                                    ` : ''}
                                </div>
                                ${termo.ip_address ? `
                                <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid rgba(16, 185, 129, 0.2);">
                                    <div style="color: #6c757d; font-size: 0.85rem;">
                                        <i class="fas fa-network-wired"></i> IP: ${escapeHtml(termo.ip_address)}
                                    </div>
                                    ${termo.user_agent ? `
                                    <div style="color: #6c757d; font-size: 0.85rem;">
                                        <i class="fas fa-desktop"></i> ${escapeHtml(termo.user_agent.length > 50 ? termo.user_agent.substring(0, 50) + '...' : termo.user_agent)}
                                    </div>
                                    ` : ''}
                                </div>
                                ` : ''}
                            </div>
                            
                            <!-- Conteúdo do Termo -->
                            <div style="background: #f8f9fa; padding: 2rem; border-radius: 15px; margin-bottom: 2rem; border: 1px solid #e9ecef;">
                                <h6 style="font-size: 1.1rem; font-weight: 700; color: #333; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <i class="fas fa-file-alt"></i>
                                    Conteúdo do Termo Aceito
                                </h6>
                                ${termo.conteudo_termo ? `
                                    <div style="background: white; padding: 1.5rem; border-radius: 10px; border: 1px solid #e9ecef; white-space: pre-wrap; line-height: 1.8; color: #333; font-size: 0.95rem; max-height: 500px; overflow-y: auto;">
                                        ${escapeHtml(termo.conteudo_termo)}
                                    </div>
                                ` : `
                                    <div style="text-align: center; padding: 2rem; background: white; border-radius: 10px; color: #6c757d;">
                                        <i class="fas fa-file-alt" style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;"></i>
                                        <p>Conteúdo do termo não disponível</p>
                                    </div>
                                `}
                            </div>
                            
                            <div class="modal-footer" style="padding-top: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: flex-end;">
                                <button class="btn btn-secondary" onclick="this.closest('.modal').remove()" style="padding: 0.75rem 1.5rem; border-radius: 10px; border: none; font-weight: 600; background: #6c757d; color: white; cursor: pointer;">Fechar</button>
                            </div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);
                
                // Fechar modal ao clicar no backdrop
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });
            } catch (error) {
                console.error('❌ Erro ao visualizar termo aceito:', error);
                showNotification('Erro ao carregar termo aceito: ' + error.message, 'error');
            }
        }

        async function reprovarMotorista(coletaId, motoristaId) {
            console.log('🔄 Função reprovarMotorista chamada:', { coletaId, motoristaId });
            
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta) {
                console.error('❌ Coleta não encontrada:', coletaId);
                showNotification('Coleta não encontrada', 'error');
                return;
            }
            
            // Verificar se está na etapa GR
            if (coleta.etapa_atual !== 'gr') {
                console.error('❌ A reprovação do motorista só pode ser feita na etapa GR');
                showNotification('A reprovação do motorista só pode ser feita na etapa GR', 'warning');
                return;
            }
            
            if (!motoristaId) {
                console.error('❌ Motorista ID não fornecido');
                showNotification('ID do motorista não fornecido', 'error');
                return;
            }
            
            try {
                // Criar modal para motivo da reprovação
                const modal = document.createElement('div');
                modal.className = 'modal fade show';
                modal.id = 'modalReprovarMotorista';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); display: flex; justify-content: center; align-items: center; z-index: 10001; padding: 2rem;';
                modal.innerHTML = `
                    <div class="modal-dialog" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%); backdrop-filter: blur(20px); border-radius: 20px; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3); max-width: 600px; width: 100%; max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
                        <div class="modal-content" style="padding: 0; background: transparent;">
                            <div class="modal-header" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); color: white; padding: 1.5rem; border-radius: 20px 20px 0 0;">
                                <h5 class="modal-title" style="margin: 0; font-size: 1.5rem; font-weight: 600;"><i class="fas fa-exclamation-triangle"></i> Reprovar Motorista</h5>
                                <button type="button" class="btn-close" style="filter: invert(1); opacity: 0.9; font-size: 1.5rem;" onclick="this.closest('.modal').remove()"></button>
                            </div>
                            <div class="modal-body" style="flex: 1; overflow-y: auto; padding: 2rem;">
                                <p style="margin-bottom: 1rem; color: #333; font-size: 1rem;">Informe o motivo da reprovação do motorista:</p>
                                <textarea id="motivoReprovacaoMotorista" class="form-control" rows="6" placeholder="Digite o motivo da reprovação do motorista..." required style="width: 100%; padding: 1rem; border: 2px solid #e9ecef; border-radius: 10px; font-size: 1rem; resize: vertical; min-height: 120px;"></textarea>
                            </div>
                            <div class="modal-footer" style="padding: 1.5rem; border-top: 1px solid #e9ecef; display: flex; justify-content: flex-end; gap: 1rem; border-radius: 0 0 20px 20px;">
                                <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()" style="padding: 0.75rem 2rem; border-radius: 10px; border: none; font-weight: 600;">Cancelar</button>
                                <button type="button" class="btn btn-danger" onclick="confirmarReprovarMotorista('${coletaId}', '${motoristaId}')" style="padding: 0.75rem 2rem; border-radius: 10px; border: none; font-weight: 600; background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
                                    <i class="fas fa-times"></i> Reprovar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                // Fechar modal ao clicar no backdrop
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                        delete window.confirmarReprovarMotorista;
                    }
                });

                // Adicionar função global temporária
                window.confirmarReprovarMotorista = async (coletaIdParam, motoristaIdParam) => {
                    const motivoEl = document.getElementById('motivoReprovacaoMotorista');
                    const motivo = motivoEl ? motivoEl.value.trim() : '';
                    if (!motivo) {
                        showNotification('Por favor, informe o motivo da reprovação.', 'warning');
                        return;
                    }

                    try {
                        const userData = JSON.parse(localStorage.getItem('loggedInUser'));
                        const usuarioNome = currentUser?.nome || currentUser?.username || userData?.email || 'Sistema';

                        console.log('🔄 Iniciando reprovação de motorista:', {
                            coletaId: coletaIdParam,
                            motoristaId: motoristaIdParam,
                            motivo: motivo,
                            usuarioNome: usuarioNome
                        });

                        // Usar API do servidor para reprovar motorista (usa service key, ignora RLS)
                        const response = await fetch('/api/motoristas/reprovar', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                motoristaId: motoristaIdParam,
                                coletaId: coletaIdParam,
                                motivo: motivo,
                                usuarioNome: usuarioNome
                            })
                        });

                        const result = await response.json();

                        if (!response.ok || !result.success) {
                            console.error('❌ Erro na resposta da API:', {
                                status: response.status,
                                statusText: response.statusText,
                                result: result
                            });
                            throw new Error(result.error || `Erro HTTP: ${response.status}`);
                        }

                        console.log('✅ Motorista reprovado via API:', result);
                        console.log('✅ Dados do motorista atualizado:', result.data);
                        
                        // Verificar se os dados foram realmente atualizados
                        if (result.data && result.data.length > 0) {
                            const motoristaAtualizado = result.data[0];
                            console.log('✅ Confirmação de atualização:', {
                                reprovado: motoristaAtualizado.reprovado,
                                quantidade_reprovacoes: motoristaAtualizado.quantidade_reprovacoes,
                                motivo: motoristaAtualizado.motivo_reprovacao
                            });
                        } else {
                            console.warn('⚠️ API retornou sucesso mas sem dados do motorista atualizado');
                        }

                        // ✅ IMPORTANTE: Voltar coleta para etapa de Contratação após reprovar motorista
                        try {
                            const { error: updateError } = await supabaseClient
                                .from('coletas')
                                .update({
                                    etapa_atual: 'contratacao',
                                    updated_at: new Date().toISOString()
                                })
                                .eq('id', coletaIdParam);

                            if (updateError) {
                                console.error('❌ Erro ao voltar coleta para contratação:', updateError);
                            } else {
                                console.log('✅ Coleta voltou para etapa de Contratação');
                            }
                        } catch (errorEtapa) {
                            console.error('❌ Erro ao atualizar etapa da coleta:', errorEtapa);
                        }

                        // Salvar no histórico da coleta
                        try {
                            await salvarNoHistorico(coletaIdParam, 'Motorista Reprovado', 
                                `Motorista ${motoristaIdParam} reprovado por ${usuarioNome}. Motivo: ${motivo}. Coleta voltou para etapa de Contratação.`
                            );
                            console.log('✅ Histórico salvo');
                        } catch (errorHist) {
                            console.warn('⚠️ Erro ao salvar histórico (não crítico):', errorHist);
                        }

                        showNotification('⚠️ Motorista reprovado! A coleta voltou para etapa de Contratação. É necessário trocar o motorista.', 'warning');
                        
                        // Fechar todos os modais abertos
                        document.querySelectorAll('.modal').forEach(m => m.remove());
                        delete window.confirmarReprovarMotorista;
                        
                        // ✅ IMPORTANTE: Invalidar cache e forçar recarregamento dos dados do motorista
                        // Limpar qualquer cache do motorista completamente
                        if (window.motoristaCache) {
                            delete window.motoristaCache[coleta.motorista_id];
                            delete window.motoristaCache[motoristaIdParam];
                            console.log('🗑️ Cache do motorista limpo:', { coleta_motorista_id: coleta.motorista_id, motoristaIdParam });
                        }
                        
                        // Recarregar coletas primeiro para atualizar a interface
                        await carregarColetas();
                        
                        // Aguardar mais tempo para garantir que o Supabase processou completamente a atualização
                        await new Promise(resolve => setTimeout(resolve, 1000));
                        
                        // Buscar motorista atualizado diretamente do Supabase SEM CACHE
                        // Usar uma query direta para garantir que pegamos os dados mais recentes
                        try {
                            console.log('🔄 Buscando motorista diretamente do Supabase (sem cache)...');
                            const { data: motoristaDireto, error: errorDireto } = await supabaseClient
                                .from('motoristas')
                                .select('*')
                                .eq('id', motoristaIdParam)
                                .single();
                            
                            if (errorDireto) {
                                console.error('❌ Erro ao buscar motorista diretamente:', errorDireto);
                            } else if (motoristaDireto) {
                                console.log('✅ Motorista encontrado diretamente do Supabase:', {
                                    id: motoristaDireto.id,
                                    nome: motoristaDireto.nome,
                                    reprovado: motoristaDireto.reprovado,
                                    reprovado_tipo: typeof motoristaDireto.reprovado,
                                    quantidade_reprovacoes: motoristaDireto.quantidade_reprovacoes,
                                    historico_length: Array.isArray(motoristaDireto.historico_reprovacoes) ? motoristaDireto.historico_reprovacoes.length : 'N/A',
                                    motivo_reprovacao: motoristaDireto.motivo_reprovacao
                                });
                                
                                // Atualizar cache com os dados mais recentes
                                if (window.motoristaCache) {
                                    window.motoristaCache[motoristaIdParam] = motoristaDireto;
                                }
                            }
                        } catch (err) {
                            console.error('❌ Erro ao buscar motorista diretamente:', err);
                        }
                        
                        // Recarregar informações do motorista usando a função buscarMotoristaPorId
                        const coletaAtualizada = coletasData.find(c => c.id === coletaIdParam);
                        if (coletaAtualizada && coletaAtualizada.motorista_id) {
                            try {
                                // Buscar novamente usando a função normal (agora deve pegar do cache atualizado ou do Supabase)
                                const motoristaRecarregado = await buscarMotoristaPorId(coletaAtualizada.motorista_id);
                                console.log('🔄 Motorista recarregado após reprovação (via função):', {
                                    id: motoristaRecarregado?.id,
                                    reprovado: motoristaRecarregado?.reprovado,
                                    reprovado_tipo: typeof motoristaRecarregado?.reprovado,
                                    quantidade_reprovacoes: motoristaRecarregado?.quantidade_reprovacoes,
                                    historico_length: Array.isArray(motoristaRecarregado?.historico_reprovacoes) ? motoristaRecarregado.historico_reprovacoes.length : 'N/A'
                                });
                                
                                if (motoristaRecarregado) {
                                    // Atualizar o card do motorista no Kanban
                                    await carregarInfoMotorista(coletaIdParam, coletaAtualizada.motorista_id, []);
                                }
                            } catch (err) {
                                console.error('❌ Erro ao recarregar motorista:', err);
                            }
                        }
                        
                        // Recarregar conteúdo do drawer se estiver aberto - FORÇAR RECARREGAMENTO COMPLETO
                        const drawer = document.getElementById('kanbanDrawer');
                        if (drawer && drawer.classList.contains('active')) {
                            console.log('🔄 Recarregando drawer completo após reprovação...');
                            
                            // Fechar e reabrir o drawer para garantir recarregamento completo
                            drawer.classList.remove('active');
                            await new Promise(resolve => setTimeout(resolve, 300));
                            
                            // Reabrir o drawer com os dados atualizados
                            await abrirKanbanDrawer(coletaIdParam);
                            
                            // Aguardar um pouco e atualizar novamente o card do motorista
                            setTimeout(async () => {
                                const coletaAtualizada2 = coletasData.find(c => c.id === coletaIdParam);
                                if (coletaAtualizada2 && coletaAtualizada2.motorista_id) {
                                    console.log('🔄 Atualizando card do motorista após recarregar drawer...');
                                    await carregarInfoMotorista(coletaIdParam, coletaAtualizada2.motorista_id, []);
                                }
                            }, 500);
                        } else {
                            // Se o drawer não estiver aberto, apenas atualizar o card do motorista no Kanban
                            const coletaAtualizada2 = coletasData.find(c => c.id === coletaIdParam);
                            if (coletaAtualizada2 && coletaAtualizada2.motorista_id) {
                                console.log('🔄 Atualizando card do motorista no Kanban...');
                                await carregarInfoMotorista(coletaIdParam, coletaAtualizada2.motorista_id, []);
                            }
                        }
                        
                    } catch (error) {
                        console.error('❌ Erro completo ao reprovar motorista:', error);
                        console.error('Stack trace:', error.stack);
                        showNotification('Erro ao reprovar motorista: ' + (error.message || error), 'error');
                    }
                };
                
            } catch (error) {
                console.error('❌ Erro ao criar modal de reprovação:', error);
                showNotification('Erro ao abrir modal de reprovação: ' + error.message, 'error');
            }
        }

        async function trocarMotorista(coletaId) {
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta) return;

            // Fechar modal de detalhes se estiver aberto
            const modalDetalhes = document.querySelector('.modal.show');
            if (modalDetalhes) {
                modalDetalhes.remove();
            }

            // Abrir modal de seleção de motorista
            await vincularMotorista(coletaId);
        }

        async function salvarMotorista(motoristaData) {
            try {
                // Verificar se o Supabase está inicializado
                if (!supabaseClient) {
                    console.error('❌ Supabase não inicializado');
                    showNotification('Erro: Supabase não inicializado', 'error');
                    return;
                }
                
                const { data, error } = await supabaseClient
                    .from('motoristas')
                    .insert([motoristaData]);

                if (error) throw error;
                
                showNotification('Motorista cadastrado com sucesso!', 'success');
                return data;
            } catch (error) {
                console.error('❌ Erro ao salvar motorista:', error);
                showNotification('Erro ao salvar motorista: ' + error.message, 'error');
                throw error;
            }
        }

        function openMotoristaModal(coletaId) {
            const modal = document.createElement('div');
            modal.className = 'modal fade show';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Cadastrar Novo Motorista</h5>
                            <button type="button" class="btn-close" onclick="fecharModalMotorista()"></button>
                        </div>
                        <div class="modal-body">
                            <form id="motoristaForm">
                                <div class="form-group">
                                    <label for="nome">Nome Completo *</label>
                                    <input type="text" class="form-control" id="nome" required>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="telefone">Telefone *</label>
                                            <input type="text" class="form-control" id="telefone" placeholder="Ex: (11) 99999-9999" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="cnh">CNH *</label>
                                            <input type="text" class="form-control" id="cnh" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="categoria">Categoria CNH *</label>
                                    <select class="form-control" id="categoria" required>
                                        <option value="">Selecione</option>
                                        <option value="A">A - Motocicleta</option>
                                        <option value="B">B - Carro</option>
                                        <option value="C">C - Caminhão</option>
                                        <option value="D">D - Ônibus</option>
                                        <option value="E">E - Carreta</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="fecharModalMotorista()">Cancelar</button>
                            <button type="button" class="btn btn-primary" onclick="salvarNovoMotorista('${coletaId}')">Cadastrar</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        async function salvarNovoMotorista(coletaId) {
            try {
                const form = document.getElementById('motoristaForm');
                const formData = new FormData(form);
                
                const motoristaData = {
                    id: generateId(),
                    nome: (document.getElementById('nome')?.value) || '',
                    telefone1: (document.getElementById('telefone')?.value) || '',
                    cnh: (document.getElementById('cnh')?.value) || '',
                    categoria_cnh: (document.getElementById('categoria')?.value) || '',
                    status: 'ativo',
                    data_cadastro: new Date().toISOString(),
                    data_atualizacao: new Date().toISOString(),
                    usuario_id: currentUser?.id || null
                };

                // Validar campos obrigatórios
                if (!motoristaData.nome || !motoristaData.telefone1 || 
                    !motoristaData.cnh || !motoristaData.categoria_cnh) {
                    showNotification('Preencha todos os campos obrigatórios!', 'warning');
                    return;
                }

                await salvarMotorista(motoristaData);
                fecharModalMotorista();
                
                // Vincular automaticamente o motorista à coleta
                await selecionarMotorista(coletaId, motoristaData.id);
                
            } catch (error) {
                console.error('❌ Erro ao salvar novo motorista:', error);
            }
        }

        // ========== FUNÇÕES SUPABASE - COLETAS ==========
        let coletasRealtimeChannel = null;
        
        function configurarRealtimeColetas() {
            if (!supabaseClient) {
                console.warn('⚠️ Supabase não inicializado, pulando configuração de realtime');
                return;
            }
            
            try {
            // Remover listener anterior se existir
            if (coletasRealtimeChannel) {
                    try {
                supabaseClient.removeChannel(coletasRealtimeChannel);
                    } catch (e) {
                        // Ignorar erros ao remover canal
                    }
            }
            
            // Configurar listener para mudanças na tabela coletas
            coletasRealtimeChannel = supabaseClient
                .channel('coletas-changes')
                .on('postgres_changes', {
                    event: '*', // Escutar todos os eventos (INSERT, UPDATE, DELETE)
                    schema: 'public',
                    table: 'coletas'
                }, (payload) => {
                    console.log('🔄 Mudança detectada na tabela coletas:', payload);
                    
                    // Se foi uma atualização (UPDATE)
                    if (payload.eventType === 'UPDATE') {
                        const coletaAtualizada = payload.new;
                        const coletaAntiga = payload.old;
                        
                        // Verificar se o motorista_id foi alterado
                        if (coletaAtualizada.motorista_id !== coletaAntiga.motorista_id) {
                            console.log('🚗 Motorista vinculado/desvinculado detectado:', {
                                coletaId: coletaAtualizada.id,
                                motoristaAntigo: coletaAntiga.motorista_id,
                                motoristaNovo: coletaAtualizada.motorista_id
                            });
                            
                            // Atualizar os dados locais
                            const index = coletasData.findIndex(c => c.id === coletaAtualizada.id);
                            if (index !== -1) {
                                // Atualizar o objeto na lista
                                coletasData[index] = { ...coletasData[index], ...coletaAtualizada };
                                
                                // Atualizar coletas ativas/arquivadas
                                if (!coletaAtualizada.arquivado) {
                                    const indexAtiva = window.coletasAtivas.findIndex(c => c.id === coletaAtualizada.id);
                                    if (indexAtiva !== -1) {
                                        window.coletasAtivas[indexAtiva] = { ...window.coletasAtivas[indexAtiva], ...coletaAtualizada };
                                    } else if (!coletaAtualizada.arquivado) {
                                        // Se não estava nas ativas e não está arquivada, adicionar
                                        window.coletasAtivas.push(coletaAtualizada);
                                    }
                                }
                                
                                // Re-renderizar apenas o card da coleta afetada
                                atualizarCardColeta(coletaAtualizada.id);
                            } else {
                                // Se não encontrou, recarregar todas as coletas para evitar duplicações
                                console.log('⚠️ Coleta não encontrada localmente, recarregando todas...');
                                carregarColetas();
                            }
                        } else {
                            // Outra atualização (não relacionada a motorista)
                            // Atualizar apenas o card específico
                            const index = coletasData.findIndex(c => c.id === coletaAtualizada.id);
                            if (index !== -1) {
                                coletasData[index] = { ...coletasData[index], ...coletaAtualizada };
                                
                                // Atualizar coletas ativas/arquivadas
                                if (!coletaAtualizada.arquivado) {
                                    const indexAtiva = window.coletasAtivas.findIndex(c => c.id === coletaAtualizada.id);
                                    if (indexAtiva !== -1) {
                                        window.coletasAtivas[indexAtiva] = { ...window.coletasAtivas[indexAtiva], ...coletaAtualizada };
                                    }
                                }
                                
                                atualizarCardColeta(coletaAtualizada.id);
                            }
                        }
                    } else if (payload.eventType === 'INSERT') {
                        // Nova coleta adicionada
                        console.log('➕ Nova coleta detectada, recarregando...');
                        carregarColetas();
                    } else if (payload.eventType === 'DELETE') {
                        // Coleta removida
                        console.log('➖ Coleta removida, recarregando...');
                        carregarColetas();
                    }
                })
                .subscribe((status) => {
                    if (status === 'SUBSCRIBED') {
                        console.log('✅ Listener de realtime configurado com sucesso');
                    } else if (status === 'CHANNEL_ERROR') {
                        // ✅ Tornar erro silencioso - WebSocket pode falhar em alguns ambientes
                        console.warn('⚠️ Erro no canal de realtime (funcionando em modo offline)');
                    } else if (status === 'TIMED_OUT' || status === 'CLOSED') {
                        // Conexão fechada ou timeout - não é crítico
                        console.warn('⚠️ Conexão realtime fechada (funcionando em modo offline)');
                    }
                });
            } catch (error) {
                // ✅ Capturar erros de conexão WebSocket e torná-los silenciosos
                console.warn('⚠️ Não foi possível configurar realtime (funcionando em modo offline):', error.message);
                coletasRealtimeChannel = null;
            }
        }
        
        async function atualizarCardColeta(coletaId) {
            try {
                // Buscar a coleta atualizada do banco
                const { data: coletaAtualizada, error } = await supabaseClient
                    .from('coletas')
                    .select('*')
                    .eq('id', coletaId)
                    .single();
                
                if (error) throw error;
                
                // Atualizar na lista local
                const index = coletasData.findIndex(c => c.id === coletaId);
                if (index !== -1) {
                    coletasData[index] = coletaAtualizada;
                }
                
                // Atualizar coletas ativas/arquivadas
                if (!coletaAtualizada.arquivado) {
                    const indexAtiva = window.coletasAtivas.findIndex(c => c.id === coletaId);
                    if (indexAtiva !== -1) {
                        window.coletasAtivas[indexAtiva] = coletaAtualizada;
                    }
                }
                
                // Encontrar o card existente (pode haver múltiplos se houver duplicação)
                const grid = document.getElementById('coletasGrid');
                const cardsExistentes = grid.querySelectorAll(`[data-coleta-id="${coletaId}"]`);
                
                // Se houver múltiplos cards com o mesmo ID, remover os duplicados
                if (cardsExistentes.length > 1) {
                    console.warn('⚠️ Detectados múltiplos cards com o mesmo ID, removendo duplicados:', coletaId);
                    // Manter apenas o primeiro, remover os demais
                    for (let i = 1; i < cardsExistentes.length; i++) {
                        cardsExistentes[i].remove();
                    }
                }
                
                const cardExistente = cardsExistentes[0];
                
                if (cardExistente) {
                    // Se a coleta foi arquivada ou mudou de status de forma que não deve mais aparecer, remover o card
                    if (coletaAtualizada.arquivado) {
                        console.log('🗑️ Coleta arquivada, removendo card:', coletaId);
                        cardExistente.remove();
                        updateStats(window.coletasAtivas || coletasData.filter(c => !c.arquivado));
                        return;
                    }
                    
                    // Verificar novamente se não há duplicatas antes de substituir
                    const grid = document.getElementById('coletasGrid');
                    const todosCards = grid.querySelectorAll(`[data-coleta-id="${coletaId}"]`);
                    if (todosCards.length > 1) {
                        console.warn('⚠️ Múltiplos cards detectados antes de atualizar, removendo duplicados:', coletaId);
                        // Manter apenas o primeiro, remover os demais
                        for (let i = 1; i < todosCards.length; i++) {
                            todosCards[i].remove();
                        }
                    }
                    
                    // Carregar anexos
                    coletaAtualizada.anexos = await carregarAnexos(coletaId);
                    
                    // Substituir o card
                    const novoCard = createColetaCard(coletaAtualizada);
                    novoCard.setAttribute('data-coleta-id', coletaId);
                    cardExistente.replaceWith(novoCard);
                    
                    // Verificar se não foi criado um duplicado após a substituição
                    const cardsAposSubstituicao = grid.querySelectorAll(`[data-coleta-id="${coletaId}"]`);
                    if (cardsAposSubstituicao.length > 1) {
                        console.warn('⚠️ Duplicata criada após substituição, removendo:', coletaId);
                        for (let i = 1; i < cardsAposSubstituicao.length; i++) {
                            cardsAposSubstituicao[i].remove();
                        }
                    }
                    
                    // Carregar informações do motorista se houver vinculação
                    if (coletaAtualizada.motorista_id) {
                        await carregarInfoMotorista(coletaId, coletaAtualizada.motorista_id, coletaAtualizada.anexos);
                    }
                } else {
                    // Se não encontrou o card, verificar se não está duplicado em outro lugar
                    const grid = document.getElementById('coletasGrid');
                    const cardsComMesmoId = grid.querySelectorAll(`[data-coleta-id="${coletaId}"]`);
                    if (cardsComMesmoId.length > 0) {
                        console.warn('⚠️ Card encontrado mas não foi retornado pela query, recarregando todas as coletas...');
                        await carregarColetas();
                    } else {
                        // Se realmente não existe, recarregar todas as coletas
                    console.log('⚠️ Card não encontrado, recarregando todas as coletas...');
                    await carregarColetas();
                    }
                }
            } catch (error) {
                console.error('❌ Erro ao atualizar card da coleta:', error);
                // Em caso de erro, recarregar todas as coletas
                await carregarColetas();
            }
        }
        
        // Proteção contra múltiplas chamadas simultâneas de carregarColetas
        let carregandoColetas = false;
        let timeoutCarregarColetas = null;
        
        /**
         * ✅ ELEVAÇÃO AUTOMÁTICA DE PRIORIDADE BASEADA EM TEMPO
         * Calcula e aplica a prioridade automaticamente baseado no tempo desde data_recebimento:
         * - Baixa: 0-15 minutos
         * - Normal: 15-25 minutos
         * - Alta: 25-45 minutos
         * - Urgente: > 45 minutos
         * 
         * IMPORTANTE: A prioridade é atualizada automaticamente conforme o tempo passa.
         * Coletas criadas como "normal" serão atualizadas automaticamente quando passarem dos limites.
         */
        async function aplicarElevacaoAutomaticaPrioridade(coletas) {
            if (!coletas || coletas.length === 0) return;
            
            if (!supabaseClient) {
                console.warn('⚠️ Supabase não inicializado, não é possível atualizar prioridades');
                return;
            }
            
            const agora = new Date();
            const coletasParaAtualizar = [];
            
            console.log(`🔄 Verificando elevação automática de prioridade para ${coletas.length} coleta(s)...`);
            
            for (const coleta of coletas) {
                // Pular se a coleta estiver arquivada
                if (coleta.arquivado) continue;
                
                // ✅ NOVO: Usar tempo acumulado na etapa (considera múltiplas entradas)
                // Se tempo_acumulado_etapa estiver disponível, usar ele
                // Senão, calcular tempo desde data_entrada_etapa (compatibilidade)
                let tempoMinutos = 0;
                
                if (coleta.tempo_acumulado_etapa !== undefined && coleta.tempo_acumulado_etapa !== null) {
                    // Usar tempo acumulado (considera múltiplas entradas na mesma etapa)
                    tempoMinutos = coleta.tempo_acumulado_etapa;
                } else {
                    // Fallback: calcular tempo desde última entrada
                    const dataEntradaEtapa = coleta.data_entrada_etapa 
                        ? new Date(coleta.data_entrada_etapa)
                        : (coleta.updated_at ? new Date(coleta.updated_at) : null);
                    
                    if (!dataEntradaEtapa || isNaN(dataEntradaEtapa.getTime())) {
                        console.log(`⚠️ Coleta ${coleta.id} sem data de entrada na etapa válida, pulando...`);
                        continue;
                    }
                    
                    tempoMinutos = (agora.getTime() - dataEntradaEtapa.getTime()) / (1000 * 60);
                }
                
                // Se o tempo for negativo, pular (data no futuro)
                if (tempoMinutos < 0) {
                    console.log(`⚠️ Coleta ${coleta.id}: data de entrada na etapa no futuro (${tempoMinutos.toFixed(1)}min), pulando...`);
                    continue;
                }
                
                const prioridadeAtual = coleta.prioridade || 'normal';
                
                // Determinar prioridade baseada no tempo (conforme especificação)
                // - Baixa: 0-15 minutos
                // - Normal: 15-25 minutos
                // - Alta: 25-45 minutos
                // - Urgente: > 45 minutos
                let prioridadeBaseadaNoTempo;
                if (tempoMinutos < 15) {
                    prioridadeBaseadaNoTempo = 'baixa';
                } else if (tempoMinutos < 25) {
                    prioridadeBaseadaNoTempo = 'normal';
                } else if (tempoMinutos < 45) {
                    prioridadeBaseadaNoTempo = 'alta';
                } else {
                    prioridadeBaseadaNoTempo = 'urgente';
                }
                
                // Atualizar se a prioridade calculada for diferente da atual
                // IMPORTANTE: Sempre atualiza baseado no tempo, EXCETO se:
                // - A prioridade atual é "urgente" E a calculada NÃO é "urgente" (preserva urgente manual)
                if (prioridadeBaseadaNoTempo !== prioridadeAtual) {
                    // Se o tempo indica urgente, SEMPRE atualiza (elevação automática)
                    // Se a atual é urgente mas o tempo NÃO indica urgente, NÃO atualiza (preserva urgente manual)
                    const deveAtualizar = prioridadeBaseadaNoTempo === 'urgente' || prioridadeAtual !== 'urgente';
                    
                    if (deveAtualizar) {
                        console.log(`🔄 Coleta ${coleta.id}: atualizando prioridade ${prioridadeAtual} → ${prioridadeBaseadaNoTempo} (tempo: ${tempoMinutos.toFixed(1)}min)`);
                        coletasParaAtualizar.push({
                            id: coleta.id,
                            prioridade: prioridadeBaseadaNoTempo,
                            tempoMinutos: tempoMinutos.toFixed(1),
                            prioridadeAtual: prioridadeAtual
                        });
                    }
                }
            }
            
            // Atualizar coletas em lote
            if (coletasParaAtualizar.length > 0) {
                console.log(`🔄 Atualizando prioridade automaticamente para ${coletasParaAtualizar.length} coleta(s)`);
                
                for (const item of coletasParaAtualizar) {
                    try {
                        console.log(`🔄 Atualizando coleta ${item.id}: ${item.prioridadeAtual} → ${item.prioridade} (${item.tempoMinutos}min)`);
                        
                        // Atualizar no banco de dados
                        const { error } = await supabaseClient
                            .from('coletas')
                            .update({ prioridade: item.prioridade })
                            .eq('id', item.id);
                        
                        if (error) {
                            console.error(`❌ Erro ao atualizar prioridade da coleta ${item.id}:`, error);
                        } else {
                            // Atualizar também no array local
                            const coletaIndex = coletas.findIndex(c => c.id === item.id);
                            if (coletaIndex !== -1) {
                                coletas[coletaIndex].prioridade = item.prioridade;
                            }
                            console.log(`✅ Prioridade atualizada automaticamente para coleta ${item.id}: ${item.prioridade} (${item.tempoMinutos}min)`);
                        }
                    } catch (error) {
                        console.error(`❌ Erro ao atualizar prioridade da coleta ${item.id}:`, error);
                    }
                }
            } else {
                console.log('✅ Nenhuma coleta precisa de atualização de prioridade');
            }
        }
        
        async function carregarColetas() {
            // Limpar timeout anterior se existir
            if (timeoutCarregarColetas) {
                clearTimeout(timeoutCarregarColetas);
                timeoutCarregarColetas = null;
            }
            
            // Se já está carregando, agendar nova tentativa
            if (carregandoColetas) {
                console.log('⏳ Carregamento já em andamento, agendando nova tentativa...');
                timeoutCarregarColetas = setTimeout(() => {
                    carregarColetas();
                }, 300);
                return;
            }
            
            carregandoColetas = true;
            
            try {
                // Verificar se o Supabase está inicializado
                if (!supabaseClient) {
                    console.error('❌ Supabase não inicializado');
                    showNotification('Erro: Supabase não inicializado', 'error');
                    return;
                }
                
                // ✅ MELHORIA UX: Mostrar skeletons durante carregamento
                const coletasGrid = document.getElementById('coletasGrid');
                if (coletasGrid && coletasGrid.children.length === 0) {
                    mostrarSkeletons('coletasGrid', 6);
                }
                
                showNotification('Carregando coletas...', 'info');
                
                // ✅ OTIMIZAÇÃO: Selecionar apenas campos necessários em vez de *
                // v2.0 - Campos corrigidos: removidos contas_pagar_adiantamento, contas_pagar_saldo, pendencia_saldo (não existem na tabela)
                const { data, error } = await supabaseClient
                    .from('coletas')
                    .select('id, filial, numero_coleta, cliente, data_recebimento, data_entrega, origem, destino, tipo_produto, codigo_tabela, valor, frete_motorista, km, tipos_veiculo, tipos_carroceria, status, etapa_atual, observacoes, prioridade, motorista_id, etapas_concluidas, arquivado, resultado_final, data_finalizacao, created_at, updated_at, created_by, updated_by, data_atualizacao, gr_aprovado, gr_reprovado_por, gr_motivo_reprovacao, gr_data_reprovacao, contas_pagar_pago, contas_pagar_tipo, contas_pagar_data, contas_pagar_pago_por, diaria')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Remover duplicatas baseado no ID antes de atribuir
                const coletasUnicas = [];
                const idsVistos = new Set();
                (data || []).forEach(coleta => {
                    if (coleta && coleta.id && !idsVistos.has(coleta.id)) {
                        idsVistos.add(coleta.id);
                        coletasUnicas.push(coleta);
                    }
                });

                coletasData = coletasUnicas;
                console.log('📦 Coletas carregadas (após remoção de duplicatas):', coletasData.length);
                
                // ✅ ENRIQUECER COLETAS COM TEMPO ACUMULADO (deve ser ANTES da elevação de prioridade)
                await enriquecerColetasComTempoParado();
                
                // ✅ ELEVAÇÃO AUTOMÁTICA DE PRIORIDADE BASEADA EM TEMPO
                await aplicarElevacaoAutomaticaPrioridade(coletasData);
                
                // Buscar contratos para cada coleta
                const headers = await getSupabaseAuthHeaders();
                for (const coleta of coletasData) {
                    try {
                        const response = await fetch(`/api/anexos/coleta/${encodeURIComponent(coleta.id)}`, {
                            credentials: 'include',
                            headers
                        });
                        if (response.ok) {
                            const result = await response.json();
                            const anexos = result?.anexos || [];
                            // Buscar primeiro contrato com título
                            const contrato = anexos.find(a => a.categoria === 'contratos' && a.titulo_contrato);
                            if (contrato) {
                                coleta.titulo_contrato = contrato.titulo_contrato;
                            }
                        }
                    } catch (error) {
                        console.warn('⚠️ Erro ao buscar contratos para coleta:', coleta.id, error);
                    }
                }
                
                // Separar ativas e arquivadas
                window.coletasAtivas = coletasData.filter(c => !c.arquivado);
                window.coletasArquivadas = coletasData.filter(c => c.arquivado);
                
                console.log('📊 Coletas Ativas:', window.coletasAtivas.length);
                console.log('📚 Coletas Arquivadas:', window.coletasArquivadas.length);
                
                // ✅ PRESERVAR FILTROS: Verificar se há filtros ativos e reaplicá-los
                const temFiltrosAtivos = 
                    document.getElementById('statusFilter')?.value ||
                    document.getElementById('etapaFilter')?.value ||
                    document.getElementById('filialFilter')?.value ||
                    document.getElementById('searchFilter')?.value ||
                    document.getElementById('dataInicio')?.value ||
                    document.getElementById('dataFim')?.value;
                
                if (temFiltrosAtivos) {
                    console.log('🔍 Filtros detectados, reaplicando após carregamento...');
                    // Reaplicar filtros automaticamente
                    filterColetas();
                } else {
                    // Se não há filtros, renderizar normalmente
                await renderColetasWrapper();
                updateStats();
                }
                
            } catch (error) {
                await handleError(error, 'carregarColetas');
            } finally {
                carregandoColetas = false;
            }
        }

        async function salvarColeta(coletaData) {
            try {
                // Verificar se o Supabase está inicializado
                if (!supabaseClient) {
                    console.error('❌ Supabase não inicializado');
                    showNotification('Erro: Supabase não inicializado', 'error');
                    return;
                }
                
                console.log('📤 Dados recebidos para salvar:', coletaData);
                
                let data, error;
                
                if (currentEditingId) {
                    // ✅ CAPTURAR DADOS ANTIGOS ANTES DE ATUALIZAR
                    // ✅ OTIMIZAÇÃO: Selecionar apenas campos necessários
                    const { data: dadosAntigos } = await supabaseClient
                        .from('coletas')
                        .select('id, filial, numero_coleta, cliente, data_recebimento, data_entrega, origem, destino, tipo_produto, codigo_tabela, valor, frete_motorista, km, tipos_veiculo, tipos_carroceria, status, etapa_atual, observacoes, prioridade, motorista_id, etapas_concluidas, arquivado, contas_pagar_tipo, diaria')
                        .eq('id', currentEditingId)
                        .single();
                    
                    // ✅ UPDATE - FILTRA apenas campos VÁLIDOS
                    const camposValidos = [
                        'filial', 'numero_coleta', 'cliente', 'data_recebimento', 'data_entrega', 'origem', 'destino',
                        'tipo_produto', 'codigo_tabela', 'valor', 'frete_motorista', 'km', 'tipos_veiculo', 'tipos_carroceria', 'status', 'etapa_atual', 'observacoes',
                        'prioridade', 'motorista_id', 'etapas_concluidas', 'diaria'
                    ];
                    
                    const updateData = {};
                    camposValidos.forEach(campo => {
                        if (coletaData[campo] !== undefined) {
                            updateData[campo] = coletaData[campo];
                        }
                    });
                    
                    // Garante updated_at e updated_by
                    updateData.updated_at = new Date().toISOString();
                    updateData.updated_by = currentUser.id || null;
                    updateData.data_atualizacao = new Date().toISOString();
                    
                    console.log('🔄 Dados filtrados para update:', updateData);
                    
                    ({ data, error } = await supabaseClient
                        .from('coletas')
                        .update(updateData)
                        .eq('id', currentEditingId)
                        .select());

                if (error) throw error;
                    
                    // ✅ GERAR HISTÓRICO DETALHADO DAS MUDANÇAS
                    if (dadosAntigos) {
                        console.log('📋 Dados antigos:', dadosAntigos);
                        console.log('📋 Dados novos (updateData):', updateData);
                        const mudancas = compararDadosColeta(dadosAntigos, updateData);
                        console.log('📋 Mudanças detectadas:', mudancas);
                        if (mudancas.length > 0) {
                            await salvarNoHistorico(currentEditingId, 'coleta_editada', mudancas);
                            console.log('✅ Histórico detalhado salvo com sucesso');
                        } else {
                            console.log('⚠️ Nenhuma mudança detectada para salvar no histórico');
                        }
                    } else {
                        console.warn('⚠️ Dados antigos não encontrados, não será possível gerar histórico detalhado');
                    }
                } else {
                    // ✅ INSERT - já está funcionando
                    const novaColeta = {
                        id: generateId(),
                        ...coletaData,
                        created_by: currentUser.id || null,
                        updated_by: currentUser.id || null,
                        created_at: new Date().toISOString(),
                        updated_at: new Date().toISOString(),
                        data_recebimento: coletaData.data_recebimento || new Date().toISOString(),
                        data_atualizacao: new Date().toISOString()
                    };
                    
                    ({ data, error } = await supabaseClient
                        .from('coletas')
                        .insert([novaColeta])
                        .select());
                }

                if (error) throw error;

                console.log('✅ Sucesso:', data);
                showNotification(currentEditingId ? 'Coleta atualizada!' : 'Nova coleta criada!', 'success');
                
                // ✅ HISTÓRICO DENTRO DO TRY - DEPOIS DO SUCESSO
                // (Para updates, o histórico já foi salvo acima com detalhes)
                if (!currentEditingId) {
                    await salvarNoHistorico(data[0].id, 'coleta_criada', 'Nova coleta criada'); // usa o ID retornado
                }
                
                await carregarColetas();
                
                // Recarregar histórico se o card estiver expandido
                if (currentEditingId) {
                    const card = document.querySelector(`.coleta-card[data-coleta-id="${currentEditingId}"]`);
                    if (card && card.classList.contains('expanded')) {
                        setTimeout(() => {
                            carregarHistoricoParaCard(currentEditingId);
                        }, 500);
                    }
                }
                
                return data;
                
            } catch (error) {
                await handleError(error, 'salvarColeta');
                throw error;
            }
        }

        /** Finalizar operação: só ganha se tiver canhoto anexado. Ao ganhar, redireciona para historico_coletas.html */
        async function finalizarOperacao(coletaId) {
            try {
                if (!supabaseClient) {
                    showNotification('Erro: Supabase não inicializado', 'error');
                    return;
                }
                const coleta = coletasData.find(c => String(c.id) === String(coletaId));
                if (!coleta) {
                    showNotification('Coleta não encontrada.', 'error');
                    return;
                }
                if (coleta.etapa_atual !== 'finalizar_operacao') {
                    showNotification('Esta coleta não está na etapa Finalizar Operação.', 'warning');
                    return;
                }
                const anexos = await carregarAnexos(coletaId, true);
                const temCanhoto = anexos && anexos.some(a => {
                    const nome = (a.nome_arquivo || '').toString().toLowerCase();
                    const cat = (a.categoria || '').toString().toLowerCase();
                    return nome.includes('canhoto') || cat === 'canhoto';
                });
                if (!temCanhoto) {
                    showNotification('É necessário ter canhoto anexado na coleta para finalizar a operação. Anexe o canhoto e tente novamente.', 'warning');
                    return;
                }
                if (!confirm(`Confirmar finalização da operação?\n\nA coleta "${coleta.cliente || 'Sem cliente'}" será marcada como ganha e enviada ao histórico.`)) {
                    return;
                }
                const usuarioNome = (typeof currentUser !== 'undefined' && currentUser) ? (currentUser.nome || currentUser.username || currentUser.email) : 'Sistema';
                // Usar apenas colunas existentes na tabela coletas (canhoto_validado* podem não existir)
                const dadosAtualizacao = {
                    etapa_atual: 'finalizar_operacao',
                    status: 'concluida',
                    arquivado: true,
                    resultado_final: 'ganhou',
                    data_finalizacao: new Date().toISOString()
                };
                const { error: updateError } = await supabaseClient
                    .from('coletas')
                    .update(dadosAtualizacao)
                    .eq('id', coletaId);
                if (updateError) {
                    console.error('❌ Supabase update coletas:', updateError);
                    throw updateError;
                }
                try {
                    await salvarNoHistorico(coletaId, 'operacao_finalizada', `Operação finalizada. Canhoto validado por ${usuarioNome}. Coleta enviada ao histórico.`);
                } catch (e) {
                    console.warn('Erro ao salvar histórico:', e);
                }
                showNotification('Operação finalizada com sucesso! Redirecionando para o histórico...', 'success');
                setTimeout(() => {
                    window.location.href = 'historico_coletas.html';
                }, 800);
            } catch (error) {
                console.error('❌ Erro ao finalizar operação:', error);
                const msg = (error && (error.message || error.details || error.hint)) ? (error.message || error.details || error.hint) : 'Erro ao finalizar';
                showNotification('Erro ao finalizar operação: ' + msg, 'error');
            }
        }

        async function finalizarColeta(coletaId, resultado) {
            try {
                if (!supabaseClient) {
                    console.error('❌ Supabase não inicializado');
                    showNotification('Erro: Supabase não inicializado', 'error');
                    return;
                }

                const coleta = coletasData.find(c => c.id === coletaId);
                if (!coleta) return;

                const confirmacao = resultado === 'ganhou' 
                    ? confirm('🎉 Confirmar que esta coleta GANHOU?')
                    : confirm('⚠️ Confirmar que esta coleta PERDEU?');

                if (!confirmacao) return;

                // Atualizar status da coleta para arquivada
                const { error } = await supabaseClient
                    .from('coletas')
                    .update({
                        resultado_final: resultado,
                        data_finalizacao: new Date().toISOString(),
                        arquivado: true,
                        status: resultado === 'ganhou' ? 'concluida' : 'cancelada'
                    })
                    .eq('id', coletaId);

                if (error) throw error;

                // Salvar no histórico
                await salvarNoHistorico(coletaId, `Resultado: ${resultado.toUpperCase()}`, 
                    `Coleta ${resultado === 'ganhou' ? 'CONQUISTADA' : 'PERDIDA'} por ${currentUser.nome || currentUser.username}`);

                showNotification(
                    resultado === 'ganhou' 
                        ? '🎉 Coleta Ganhou! Status arquivado com sucesso!' 
                        : '⚠️ Coleta Perdeu. Status arquivado com sucesso!', 
                    resultado === 'ganhou' ? 'success' : 'warning'
                );

                await carregarColetas();
                
            } catch (error) {
                console.error('❌ Erro ao finalizar coleta:', error);
                showNotification('Erro ao finalizar coleta: ' + error.message, 'error');
            }
        }

        async function marcarComoPago(coletaId, tipoPagamento) {
            try {
                if (!supabaseClient) {
                    console.error('❌ Supabase não inicializado');
                    showNotification('Erro: Supabase não inicializado', 'error');
                    return;
                }

                const coleta = coletasData.find(c => c.id === coletaId);
                if (!coleta) {
                    showNotification('Coleta não encontrada', 'error');
                    return;
                }

                // 🔐 Verificar permissão para a etapa contas_pagar
                if (!temPermissaoEtapa('contas_pagar')) {
                    showNotification('⚠️ Você não tem permissão para marcar como pago nesta etapa', 'warning');
                    // ✅ SEGURANÇA: Logs condicionais apenas em desenvolvimento
                    if (window.DEBUG || window.location.hostname === 'localhost') {
                    console.log('❌ Usuário não tem permissão para etapa: contas_pagar');
                    }
                    return;
                }

                if (!coleta.motorista_id) {
                    showNotification('⚠️ É necessário ter um motorista vinculado para marcar como pago', 'warning');
                    return;
                }

                // Validar tipo de pagamento
                if (!tipoPagamento || !['adiantamento', 'saldo', 'pagamento_total'].includes(tipoPagamento)) {
                    showNotification('⚠️ Tipo de pagamento inválido', 'warning');
                    return;
                }

                // Definir textos conforme o tipo de pagamento
                const tiposPagamento = {
                    'adiantamento': {
                        titulo: 'Adiantamento de Frete',
                        emoji: '💵',
                        mensagemConfirmacao: '💰 Confirmar que o ADIANTAMENTO DE FRETE foi realizado? O motorista e o criador da oportunidade serão notificados.',
                        mensagemMotorista: (motorista, coleta) => `💵 *ADIANTAMENTO DE FRETE REALIZADO*\n\nOlá ${motorista.nome || 'Motorista'}!\n\nO adiantamento de frete da coleta *${coleta.cliente}* (${coleta.origem} → ${coleta.destino}) foi marcado como realizado.\n\nValor: R$ ${(coleta.valor || 0).toFixed(2)}\n\nO saldo restante será pago após a conclusão da operação.\n\nObrigado pelo seu trabalho! 🚚`,
                        mensagemCriador: (usuario) => `💵 Adiantamento de frete marcado como realizado por ${usuario}`,
                        notificacaoSucesso: '✅ Adiantamento de frete marcado como realizado! Motorista e criador da oportunidade foram notificados.'
                    },
                    'saldo': {
                        titulo: 'Saldo',
                        emoji: '💰',
                        mensagemConfirmacao: '💰 Confirmar que o SALDO foi pago? O motorista e o criador da oportunidade serão notificados.',
                        mensagemMotorista: (motorista, coleta) => `💰 *SALDO PAGO*\n\nOlá ${motorista.nome || 'Motorista'}!\n\nO saldo da coleta *${coleta.cliente}* (${coleta.origem} → ${coleta.destino}) foi marcado como pago.\n\nValor: R$ ${(coleta.valor || 0).toFixed(2)}\n\nPagamento completo realizado! 🎉\n\nObrigado pelo seu trabalho! 🚚`,
                        mensagemCriador: (usuario) => `💰 Saldo marcado como pago por ${usuario}`,
                        notificacaoSucesso: '✅ Saldo marcado como pago! Motorista e criador da oportunidade foram notificados.'
                    },
                    'pagamento_total': {
                        titulo: 'Pagamento Total',
                        emoji: '💳',
                        mensagemConfirmacao: '💳 Confirmar que o PAGAMENTO TOTAL foi realizado? O motorista e o criador da oportunidade serão notificados.',
                        mensagemMotorista: (motorista, coleta) => `💳 *PAGAMENTO TOTAL REALIZADO*\n\nOlá ${motorista.nome || 'Motorista'}!\n\nO pagamento total da coleta *${coleta.cliente}* (${coleta.origem} → ${coleta.destino}) foi marcado como realizado.\n\nValor Total: R$ ${(coleta.valor || 0).toFixed(2)}\n\nPagamento completo realizado de uma única vez! 🎉\n\nObrigado pelo seu trabalho! 🚚`,
                        mensagemCriador: (usuario) => `💳 Pagamento total marcado como realizado por ${usuario}`,
                        notificacaoSucesso: '✅ Pagamento total marcado como realizado! Motorista e criador da oportunidade foram notificados.'
                    }
                };

                const tipoInfo = tiposPagamento[tipoPagamento];

                const confirmacao = confirm(tipoInfo.mensagemConfirmacao);
                if (!confirmacao) return;

                // Buscar informações do motorista
                const motorista = await buscarMotoristaPorId(coleta.motorista_id);
                if (!motorista) {
                    showNotification('Erro ao buscar informações do motorista', 'error');
                    return;
                }

                // Buscar informações do criador da coleta
                let criadorNome = 'Usuário';
                let criadorEmail = null;
                if (coleta.created_by) {
                    try {
                        const { data: userData, error: userError } = await supabaseClient
                            .from('user_profiles')
                            .select('nome, email')
                            .eq('id', coleta.created_by)
                            .single();
                        
                        if (!userError && userData) {
                            criadorNome = userData.nome || criadorNome;
                            criadorEmail = userData.email;
                        }
                    } catch (error) {
                        console.warn('⚠️ Erro ao buscar criador da coleta:', error);
                    }
                }

                const usuarioNome = currentUser.nome || currentUser.username || currentUser.email;

                // Verificar se já existe um tipo de pagamento marcado anteriormente
                let tipoFinal = tipoPagamento;
                const tipoAtual = coleta.contas_pagar_tipo;
                
                // Se já existe um tipo e não é pagamento_total, combinar os tipos
                if (tipoAtual && tipoAtual !== tipoPagamento && tipoAtual !== 'pagamento_total' && tipoPagamento !== 'pagamento_total') {
                    // Combinar tipos: se já tem adiantamento e está marcando saldo, ou vice-versa
                    if ((tipoAtual === 'adiantamento' && tipoPagamento === 'saldo') || 
                        (tipoAtual === 'saldo' && tipoPagamento === 'adiantamento')) {
                        tipoFinal = 'ambos'; // Usar 'ambos' para indicar que adiantamento e saldo foram pagos
                    }
                }

                // Verificar se a coleta está na etapa de pagamento ou contas_pagar para mover para em_viagem
                const etapaAtual = coleta.etapa_atual;
                const deveMoverParaViagem = (etapaAtual === 'pagamento' || etapaAtual === 'contas_pagar');
                
                // Preparar dados de atualização
                const dadosAtualizacao = {
                    contas_pagar_pago: true,
                    contas_pagar_data: new Date().toISOString(),
                    contas_pagar_pago_por: usuarioNome,
                    contas_pagar_tipo: tipoFinal,
                    updated_at: new Date().toISOString()
                };

                // Se estiver na etapa de pagamento, mover para em_viagem
                if (deveMoverParaViagem) {
                    dadosAtualizacao.etapa_atual = 'em_viagem';
                    console.log('📤 Movendo coleta para etapa "em_viagem" após confirmar pagamento');
                }

                // Atualizar coleta como paga
                const { error: updateError } = await supabaseClient
                    .from('coletas')
                    .update(dadosAtualizacao)
                    .eq('id', coletaId);

                if (updateError) throw updateError;

                // Se moveu para em_viagem, também atualizar via API de mover etapa para garantir consistência
                if (deveMoverParaViagem) {
                    try {
                        const authHeaders = await getSupabaseAuthHeaders();
                        await fetch(`/api/coletas/${coletaId}/mover-etapa`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                ...authHeaders
                            },
                            credentials: 'include',
                            body: JSON.stringify({
                                etapa_destino: 'em_viagem'
                            })
                        });
                        console.log('✅ Coleta movida para "em_viagem" via API');
                    } catch (error) {
                        console.warn('⚠️ Erro ao mover etapa via API (não crítico):', error);
                        // Não bloquear o processo se falhar
                    }
                }

                // Salvar no histórico
                await salvarNoHistorico(coletaId, 'contas_pagar_pago', 
                    `${tipoInfo.titulo} marcado como realizado por ${usuarioNome}`
                );

                // Enviar mensagem para o motorista
                if (motorista.telefone1) {
                    try {
                        const mensagemMotorista = tipoInfo.mensagemMotorista(motorista, coleta);

                        const userData = localStorage.getItem('loggedInUser');
                        const user = userData ? JSON.parse(userData) : null;

                        const response = await fetch('/webhook/send-supabase', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                number: motorista.telefone1,
                                message: mensagemMotorista,
                                usuario: user?.email || currentUser?.email || 'sistema',
                                userId: user?.id || currentUser?.id || null
                            })
                        });

                        if (response.ok) {
                            console.log('✅ Mensagem enviada para o motorista');
                        } else {
                            console.warn('⚠️ Erro ao enviar mensagem para o motorista:', await response.text());
                        }
                    } catch (error) {
                        console.error('❌ Erro ao enviar mensagem para o motorista:', error);
                        // Não bloquear o processo se falhar o envio
                    }
                }

                // Criar notificação para o criador da coleta (se for diferente do usuário atual)
                if (coleta.created_by && coleta.created_by !== currentUser.id) {
                    try {
                        // Adicionar mensagem no chat da coleta para notificar o criador
                        await supabaseClient
                            .from('chat_mensagens')
                            .insert({
                                coleta_id: coletaId,
                                usuario: 'Sistema',
                                mensagem: tipoInfo.mensagemCriador(usuarioNome),
                                tipo: 'system',
                                tipo_mensagem: 'sistema'
                            });
                        
                        console.log('✅ Notificação criada para o criador da coleta');
                    } catch (error) {
                        console.warn('⚠️ Erro ao criar notificação para o criador:', error);
                    }
                }

                // Mostrar notificação de sucesso para o usuário atual
                const mensagemSucesso = deveMoverParaViagem 
                    ? `${tipoInfo.notificacaoSucesso} Coleta movida para "Em viagem".`
                    : tipoInfo.notificacaoSucesso;
                showNotification(mensagemSucesso, 'success');

                // Recarregar coletas para atualizar a interface
                await carregarColetas();
                
            } catch (error) {
                console.error('❌ Erro ao marcar como pago:', error);
                showNotification('Erro ao marcar como pago: ' + error.message, 'error');
            }
        }

        // Função confirmarPagamentoComTipo - alias para marcarComoPago
        async function confirmarPagamentoComTipo(coletaId, tipoPagamento) {
            // Se não foi passado tipoPagamento, tentar inferir do tipo selecionado na coleta
            if (!tipoPagamento) {
                const coleta = coletasData.find(c => c.id === coletaId);
                if (coleta && coleta.contas_pagar_tipo) {
                    // Mapear tipos específicos para tipos genéricos
                    const tipoMapeado = coleta.contas_pagar_tipo.toLowerCase();
                    if (tipoMapeado.includes('adiantamento') && !tipoMapeado.includes('saldo')) {
                        tipoPagamento = 'adiantamento';
                    } else if (tipoMapeado.includes('saldo') && !tipoMapeado.includes('adiantamento')) {
                        tipoPagamento = 'saldo';
                    } else if (tipoMapeado.includes('total') || tipoMapeado.includes('pagamento total')) {
                        tipoPagamento = 'pagamento_total';
                    } else {
                        // Se não conseguir mapear, usar o tipo da coleta diretamente
                        tipoPagamento = coleta.contas_pagar_tipo;
                    }
                } else {
                    showNotification('⚠️ Tipo de pagamento não especificado', 'warning');
                    return;
                }
            }
            
            // Chamar marcarComoPago com o tipo de pagamento
            await marcarComoPago(coletaId, tipoPagamento);
        }

        // Função para marcar tipo de pagamento específico (GNRE, PEDÁGIO, etc.)
        async function marcarTipoPagamentoEspecifico(coletaId, tipoPagamentoEspecifico) {
            try {
                if (!supabaseClient) {
                    console.error('❌ Supabase não inicializado');
                    showNotification('Erro: Supabase não inicializado', 'error');
                    return;
                }

                const coleta = coletasData.find(c => c.id === coletaId);
                if (!coleta) {
                    showNotification('Coleta não encontrada', 'error');
                    return;
                }

                // 🔐 Verificar permissão para a etapa contas_pagar
                if (!temPermissaoEtapa('contas_pagar')) {
                    showNotification('⚠️ Você não tem permissão para marcar como pago nesta etapa', 'warning');
                    return;
                }

                if (!coleta.motorista_id) {
                    showNotification('⚠️ É necessário ter um motorista vinculado para marcar como pago', 'warning');
                    return;
                }

                // Validar tipo de pagamento específico
                const tiposValidos = ['GNRE', 'PEDÁGIO', 'GNRE + PEDÁGIO', 'ADIANTAMENTO', 'SALDO', 'PAGAMENTO DE FRETE TOTAL'];
                if (!tipoPagamentoEspecifico || !tiposValidos.includes(tipoPagamentoEspecifico)) {
                    showNotification('⚠️ Tipo de pagamento inválido', 'warning');
                    return;
                }

                const usuarioNome = currentUser.nome || currentUser.username || currentUser.email;
                const mensagemConfirmacao = `💰 Confirmar que o pagamento "${tipoPagamentoEspecifico}" foi realizado? O motorista e o criador da oportunidade serão notificados.`;
                
                const confirmacao = confirm(mensagemConfirmacao);
                if (!confirmacao) return;

                // Buscar informações do motorista
                const motorista = await buscarMotoristaPorId(coleta.motorista_id);
                if (!motorista) {
                    showNotification('Erro ao buscar informações do motorista', 'error');
                    return;
                }

                // Atualizar coleta como paga com o tipo específico
                const { error: updateError } = await supabaseClient
                    .from('coletas')
                    .update({
                        contas_pagar_pago: true,
                        contas_pagar_data: new Date().toISOString(),
                        contas_pagar_pago_por: usuarioNome,
                        contas_pagar_tipo: tipoPagamentoEspecifico,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', coletaId);

                if (updateError) throw updateError;

                // Salvar no histórico
                await salvarNoHistorico(coletaId, 'contas_pagar_pago', 
                    `${tipoPagamentoEspecifico} marcado como realizado por ${usuarioNome}`
                );

                // Enviar mensagem para o motorista
                if (motorista.telefone1) {
                    try {
                        const mensagemMotorista = `💰 *${tipoPagamentoEspecifico} REALIZADO*\n\nOlá ${motorista.nome || 'Motorista'}!\n\nO pagamento "${tipoPagamentoEspecifico}" da coleta *${coleta.cliente}* (${coleta.origem} → ${coleta.destino}) foi marcado como realizado.\n\nValor: R$ ${(coleta.valor || 0).toFixed(2)}\n\nObrigado pelo seu trabalho! 🚚`;

                        const userData = localStorage.getItem('loggedInUser');
                        const user = userData ? JSON.parse(userData) : null;

                        const response = await fetch('/webhook/send-supabase', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                number: motorista.telefone1,
                                message: mensagemMotorista,
                                usuario: user?.email || currentUser?.email || 'sistema',
                                userId: user?.id || currentUser?.id || null
                            })
                        });

                        if (response.ok) {
                            console.log('✅ Mensagem enviada para o motorista');
                        } else {
                            console.warn('⚠️ Erro ao enviar mensagem para o motorista:', await response.text());
                        }
                    } catch (error) {
                        console.error('❌ Erro ao enviar mensagem para o motorista:', error);
                    }
                }

                // Criar notificação para o criador da coleta
                if (coleta.created_by && coleta.created_by !== currentUser.id) {
                    try {
                        await supabaseClient
                            .from('chat_mensagens')
                            .insert({
                                coleta_id: coletaId,
                                usuario: 'Sistema',
                                mensagem: `💰 ${tipoPagamentoEspecifico} marcado como realizado por ${usuarioNome}`,
                                tipo: 'system',
                                tipo_mensagem: 'sistema'
                            });
                        
                        console.log('✅ Notificação criada para o criador da coleta');
                    } catch (error) {
                        console.warn('⚠️ Erro ao criar notificação para o criador:', error);
                    }
                }

                showNotification(`✅ ${tipoPagamentoEspecifico} marcado como realizado! Motorista e criador da oportunidade foram notificados.`, 'success');

                // Recarregar coletas para atualizar a interface
                await carregarColetas();
                
            } catch (error) {
                console.error('❌ Erro ao marcar tipo de pagamento específico:', error);
                showNotification('Erro ao marcar como pago: ' + error.message, 'error');
            }
        }

        // Função para verificar e exibir notificações de pagamento para o criador
        async function verificarNotificacoesPagamento() {
            try {
                if (!supabaseClient || !currentUser) return;

                // Buscar coletas criadas pelo usuário atual que foram marcadas como pagas recentemente
                const { data: coletasPagas, error } = await supabaseClient
                    .from('coletas')
                    .select('id, cliente, origem, destino, contas_pagar_pago, contas_pagar_data, contas_pagar_pago_por, contas_pagar_tipo, etapa_atual')
                    .eq('created_by', currentUser.id)
                    .eq('contas_pagar_pago', true)
                    .eq('etapa_atual', 'contas_pagar')
                    .order('contas_pagar_data', { ascending: false })
                    .limit(5);

                if (error) {
                    console.warn('⚠️ Erro ao verificar notificações de pagamento:', error);
                    return;
                }

                if (coletasPagas && coletasPagas.length > 0) {
                    // Verificar se já foi exibido um alerta para essas coletas
                    const ultimaNotificacao = localStorage.getItem('ultimaNotificacaoPagamento');
                    const coletasNovas = coletasPagas.filter(coleta => {
                        if (!ultimaNotificacao) return true;
                        const ultimaData = new Date(ultimaNotificacao);
                        const coletaData = new Date(coleta.contas_pagar_data);
                        return coletaData > ultimaData;
                    });

                    if (coletasNovas.length > 0) {
                        // Exibir alerta visual
                        const tipoPagamentoTexto = coletasNovas[0].contas_pagar_tipo === 'adiantamento' 
                            ? '💵 Adiantamento de Frete' 
                            : coletasNovas[0].contas_pagar_tipo === 'saldo' 
                            ? '💰 Saldo' 
                            : coletasNovas[0].contas_pagar_tipo === 'pagamento_total'
                            ? '💳 Pagamento Total'
                            : '💰 Pagamento';
                        
                        const mensagem = coletasNovas.length === 1
                            ? `${tipoPagamentoTexto} realizado! A coleta "${coletasNovas[0].cliente}" (${coletasNovas[0].origem} → ${coletasNovas[0].destino}) foi marcada como paga.`
                            : `💰 ${coletasNovas.length} coletas foram marcadas como pagas recentemente!`;

                        // Criar alerta visual destacado
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-success alert-dismissible fade show';
                        alertDiv.style.cssText = 'position: fixed; top: 80px; right: 20px; z-index: 10001; max-width: 400px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);';
                        alertDiv.innerHTML = `
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <i class="fas fa-money-check-alt" style="font-size: 1.5rem; color: #28a745;"></i>
                                <div style="flex: 1;">
                                    <strong>${tipoPagamentoTexto} Realizado!</strong>
                                    <p style="margin: 0.5rem 0 0 0; font-size: 0.9rem;">${mensagem}</p>
                                    ${coletasNovas.length === 1 ? `
                                        <small style="color: #6c757d;">Marcado por: ${coletasNovas[0].contas_pagar_pago_por || 'Sistema'}</small>
                                    ` : ''}
                                </div>
                                <button type="button" class="btn-close" onclick="this.parentElement.parentElement.remove()" style="margin-left: 1rem;"></button>
                            </div>
                        `;
                        document.body.appendChild(alertDiv);

                        // Remover automaticamente após 10 segundos
                        setTimeout(() => {
                            if (alertDiv.parentElement) {
                                alertDiv.remove();
                            }
                        }, 10000);

                        // Salvar última notificação verificada
                        if (coletasNovas.length > 0) {
                            const maisRecente = coletasNovas.sort((a, b) => 
                                new Date(b.contas_pagar_data) - new Date(a.contas_pagar_data)
                            )[0];
                            localStorage.setItem('ultimaNotificacaoPagamento', maisRecente.contas_pagar_data);
                        }
                    }
                }
            } catch (error) {
                console.error('❌ Erro ao verificar notificações de pagamento:', error);
            }
        }

        async function excluirColeta(coletaId) {
            try {
                // 🔐 Verificar se o usuário é admin
                if (!currentUser || (!currentUser.isAdmin && currentUser.role !== 'admin')) {
                    showNotification('⚠️ Apenas administradores podem excluir oportunidades', 'warning');
                    return;
                }
                
                // Verificar se o Supabase está inicializado
                if (!supabaseClient) {
                    console.error('❌ Supabase não inicializado');
                    showNotification('Erro: Supabase não inicializado', 'error');
                    return;
                }

                if (!confirm('Tem certeza que deseja excluir esta coleta? Esta ação não pode ser desfeita.')) {
                    return;
                }
                
                // Buscar dados da coleta antes de excluir para o histórico
                const coleta = coletasData.find(c => c.id === coletaId);
                let detalhesExclusao = 'Coleta excluída';
                if (coleta) {
                    detalhesExclusao = `Coleta excluída: ${coleta.filial || ''} ${coleta.numero_coleta || ''} - ${coleta.cliente || ''} (${coleta.origem || ''} → ${coleta.destino || ''})`;
                }

                // Registrar no histórico ANTES de excluir (pois depois não terá mais acesso aos dados)
                await salvarNoHistorico(coletaId, 'coleta_excluida', detalhesExclusao);
                
                const { error } = await supabaseClient
                    .from('coletas')
                    .delete()
                    .eq('id', coletaId);

                if (error) throw error;

                showNotification('Coleta excluída com sucesso', 'success');
                await carregarColetas();
                
            } catch (error) {
                console.error('❌ Erro ao excluir coleta:', error);
                showNotification('Erro ao excluir coleta: ' + error.message, 'error');
            }
        }

        // ========== FUNÇÕES SUPABASE - ANEXOS ==========
        // Cache de anexos para evitar requisições duplicadas
        const anexosCache = new Map();
        const anexosCarregando = new Set();
        
        async function carregarAnexos(coletaId, forceRefresh = false) {
            try {
                // Se forceRefresh for true, invalidar cache e forçar nova busca
                if (forceRefresh) {
                    invalidarCacheAnexos(coletaId);
                }
                
                // Verificar cache primeiro (apenas se não for forçar refresh)
                if (!forceRefresh && anexosCache.has(coletaId)) {
                    return anexosCache.get(coletaId);
                }
                
                // Se já está carregando, aguardar
                if (anexosCarregando.has(coletaId)) {
                    // Aguardar até 5 segundos para a requisição anterior completar
                    let tentativas = 0;
                    while (anexosCarregando.has(coletaId) && tentativas < 50) {
                        await new Promise(resolve => setTimeout(resolve, 100));
                        tentativas++;
                        if (anexosCache.has(coletaId)) {
                            return anexosCache.get(coletaId);
                        }
                    }
                }
                
                // Marcar como carregando
                anexosCarregando.add(coletaId);
                
                console.log('📥 Carregando anexos para coleta:', coletaId, forceRefresh ? '(forçando refresh)' : '');
                
                const headers = await getSupabaseAuthHeaders();
                
                // Se não houver autenticação, retornar array vazio silenciosamente
                if (!headers.Authorization) {
                    console.warn('⚠️ Sem autenticação para carregar anexos, retornando vazio');
                    anexosCarregando.delete(coletaId);
                    return [];
                }
                
                const response = await fetch(`/api/anexos/coleta/${encodeURIComponent(coletaId)}`, {
                    credentials: 'include',
                    headers
                });

                // Ler a resposta uma única vez
                let result;
                try {
                    result = await response.json();
                } catch (parseError) {
                    console.error('❌ Erro ao parsear resposta JSON:', parseError);
                    anexosCarregando.delete(coletaId);
                    return [];
                }

                if (!response.ok) {
                    if (response.status === 401) {
                        console.warn('⚠️ Erro de autenticação ao carregar anexos');
                        anexosCarregando.delete(coletaId);
                        return [];
                    }
                    throw new Error(result.error || result.details || `Erro ${response.status} ao carregar anexos.`);
                }

                const anexos = result?.anexos || [];
                
                console.log('✅ Anexos carregados:', anexos.length, 'arquivo(s)');
                
                // Armazenar no cache
                anexosCache.set(coletaId, anexos);
                
                // Remover do set de carregando
                anexosCarregando.delete(coletaId);
                
                return anexos;
            } catch (error) {
                console.error('❌ Erro ao carregar anexos:', error);
                // Remover do set de carregando em caso de erro
                anexosCarregando.delete(coletaId);
                return [];
            }
        }
        
        // Função para invalidar cache de anexos quando necessário
        function invalidarCacheAnexos(coletaId) {
            if (coletaId) {
                anexosCache.delete(coletaId);
            } else {
                anexosCache.clear();
            }
        }

        async function uploadAnexo(coletaId, file, categoria = null, tituloContrato = null) {
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('coleta_id', coletaId);
                
                // Adicionar categoria se fornecida
                if (categoria) {
                    formData.append('categoria', categoria);
                }
                
                // Adicionar título do contrato se fornecida e categoria for contratos
                if (categoria === 'contratos' && tituloContrato) {
                    formData.append('titulo_contrato', tituloContrato);
                }

                if (currentUser?.usuario) {
                    formData.append('usuario', currentUser.usuario);
                } else if (currentUser?.nome) {
                    formData.append('usuario', currentUser.nome);
                }

                const headers = await getSupabaseAuthHeaders();
                // NÃO enviar Content-Type ao usar FormData, o browser define automaticamente
                // Remover Content-Type dos headers se existir
                const headersSemContentType = { ...headers };
                delete headersSemContentType['Content-Type'];
                
                const response = await fetch('/api/anexos', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include',
                    headers: headersSemContentType
                });

                let result;
                try {
                    result = await response.json();
                } catch (parseError) {
                    console.error('❌ Erro ao parsear resposta JSON:', parseError);
                    const text = await response.text();
                    console.error('❌ Resposta do servidor:', text);
                    throw new Error('Erro ao processar resposta do servidor: ' + text);
                }

                if (!response.ok) {
                    console.error('❌ Erro na resposta do servidor:', {
                        status: response.status,
                        statusText: response.statusText,
                        error: result
                    });
                    throw new Error(result.error || result.details || 'Erro ao enviar arquivo.');
                }

                // Invalidar cache de anexos para esta coleta
                invalidarCacheAnexos(coletaId);

                // Registrar no histórico
                const nomeArquivo = result.anexo?.nome_arquivo || file.name || 'arquivo';
                const categoriaTexto = categoria ? ` (${obterNomeCategoria(categoria)})` : '';
                await salvarNoHistorico(coletaId, 'anexo_adicionado', `Anexo adicionado: ${nomeArquivo}${categoriaTexto}`);

                return { success: true, anexo: result.anexo };
            } catch (error) {
                console.error('❌ Erro no upload:', error);
                throw error;
            }
        }

        // ========== FUNÇÕES PARA VISUALIZAR E BAIXAR ANEXOS ==========
        
        // Função para buscar anexo por ID
        async function buscarAnexoPorId(anexoId) {
            try {
                const headers = await getSupabaseAuthHeaders();
                const response = await fetch(`/api/anexos/${encodeURIComponent(anexoId)}/info`, {
                    credentials: 'include',
                    headers
                });
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Erro ao carregar anexo.');
                }

                return result?.anexo || null;
            } catch (error) {
                console.error('❌ Erro ao buscar anexo:', error);
                showNotification('Erro ao carregar anexo', 'error');
                return null;
            }
        }

        // Função para Visualizar Anexo (abre em nova aba)
        async function visualizarAnexo(anexoId) {
            try {
                const anexo = await buscarAnexoPorId(anexoId);
                if (!anexo) return;

                // Se o anexo tem URL direta (ex: Supabase Storage), usar diretamente
                if (anexo.url && !anexo.url.startsWith('/api/')) {
                    window.open(anexo.url, '_blank');
                    return;
                }

                // Para URLs da API, usar fetch com autenticação
                const headers = await getSupabaseAuthHeaders();
                if (!headers.Authorization) {
                    showNotification('⚠️ Erro de autenticação. Por favor, faça login novamente.', 'warning');
                    return;
                }

                const url = anexo.url || `/api/anexos/${encodeURIComponent(anexoId)}/download`;
                const response = await fetch(url, {
                    credentials: 'include',
                    headers
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        showNotification('⚠️ Erro de autenticação. Por favor, faça login novamente.', 'warning');
                } else {
                        throw new Error(`Erro ${response.status}: ${response.statusText}`);
                    }
                    return;
                }

                const blob = await response.blob();
                const blobUrl = window.URL.createObjectURL(blob);
                window.open(blobUrl, '_blank');
                
                // Limpar URL após um tempo
                setTimeout(() => {
                    window.URL.revokeObjectURL(blobUrl);
                }, 60000);
                
            } catch (error) {
                console.error('❌ Erro ao visualizar anexo:', error);
                showNotification('Erro ao visualizar arquivo: ' + error.message, 'error');
            }
        }

        // Função para Download Direto
        async function downloadAnexoDireto(anexoId) {
            try {
                console.log('🔄 Forçando download para ID:', anexoId);
                
                const anexo = await buscarAnexoPorId(anexoId);
                if (!anexo) {
                    showNotification('Anexo não encontrado', 'error');
                    return;
                }

                console.log('📄 Forçando download de:', anexo.nome_arquivo);
                
                // Obter headers de autenticação
                const headers = await getSupabaseAuthHeaders();
                if (!headers.Authorization) {
                    showNotification('⚠️ Erro de autenticação. Por favor, faça login novamente.', 'warning');
                    return;
                }

                // Determinar URL para download
                let downloadUrl = anexo.url;
                if (!downloadUrl || downloadUrl.startsWith('/api/')) {
                    downloadUrl = `/api/anexos/${encodeURIComponent(anexoId)}/download`;
                }

                // Fazer fetch com autenticação
                const response = await fetch(downloadUrl, {
                    credentials: 'include',
                    headers
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        showNotification('⚠️ Erro de autenticação. Por favor, faça login novamente.', 'warning');
                    } else {
                        throw new Error(`Erro ${response.status}: ${response.statusText}`);
                    }
                    return;
                }

                const blob = await response.blob();
                const blobUrl = window.URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = blobUrl;
                link.download = anexo.nome_arquivo; // Isso que força o download
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                
                // Limpeza
                setTimeout(() => {
                    document.body.removeChild(link);
                    window.URL.revokeObjectURL(blobUrl);
                    console.log('✅ Download forçado finalizado');
                }, 100);
                
                showNotification(`💾 Baixando: ${anexo.nome_arquivo}`, 'success');
                
            } catch (error) {
                console.error('❌ Erro no download forçado:', error);
                showNotification('Erro ao baixar arquivo: ' + error.message, 'error');
            }
        }

        async function excluirAnexo(anexoId) {
            try {
                // 🔐 Verificar se o usuário é admin
                if (!currentUser || (!currentUser.isAdmin && currentUser.role !== 'admin')) {
                    showNotification('⚠️ Apenas administradores podem excluir anexos', 'warning');
                    return;
                }
                
                // Buscar informações do anexo para obter o coletaId e nome do arquivo
                let coletaId = null;
                let nomeArquivo = 'arquivo';
                try {
                    const anexoInfo = await buscarAnexoPorId(anexoId);
                    if (anexoInfo) {
                        if (anexoInfo.coleta_id) {
                        coletaId = anexoInfo.coleta_id;
                        }
                        if (anexoInfo.nome_arquivo) {
                            nomeArquivo = anexoInfo.nome_arquivo;
                        }
                    }
                } catch (err) {
                    console.warn('⚠️ Não foi possível obter informações do anexo:', err);
                }
                
                const headers = await getSupabaseAuthHeaders();
                const response = await fetch(`/api/anexos/${encodeURIComponent(anexoId)}`, {
                    method: 'DELETE',
                    credentials: 'include',
                    headers
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Erro ao excluir anexo.');
                }

                // Registrar no histórico ANTES de invalidar o cache
                if (coletaId) {
                    await salvarNoHistorico(coletaId, 'anexo_removido', `Anexo removido: ${nomeArquivo}`);
                }

                // Invalidar cache de anexos para esta coleta (ou todas se não encontrou o coletaId)
                if (coletaId) {
                    invalidarCacheAnexos(coletaId);
                } else {
                    // Se não encontrou o coletaId, invalidar todo o cache
                    invalidarCacheAnexos();
                }

                showNotification('Anexo excluído com sucesso', 'success');
            } catch (error) {
                console.error('❌ Erro ao excluir anexo:', error);
                showNotification('Erro ao excluir anexo: ' + error.message, 'error');
            }
        }

        // ========== FUNÇÕES SUPABASE - CHAT ==========
        async function carregarMensagensChat(coletaId) {
            try {
                // Verificar se o Supabase está inicializado
                if (!supabaseClient) {
                    console.error('❌ Supabase não inicializado');
                    return [];
                }
                
                const { data, error } = await supabaseClient
                    .from('chat_mensagens')
                    .select('*')
                    .eq('coleta_id', coletaId)
                    .order('created_at', { ascending: true });

                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('❌ Erro ao carregar mensagens:', error);
                return [];
            }
        }

        async function enviarMensagem(coletaId, mensagem, usuario) {
            try {
                // Verificar se o Supabase está inicializado
                if (!supabaseClient) {
                    console.error('❌ Supabase não inicializado');
                    showNotification('Erro: Supabase não inicializado', 'error');
                    return { success: false };
                }
                
                // Enviar mensagem
                const { data, error } = await supabaseClient
                    .from('chat_mensagens')
                    .insert([{
                        id: generateId(),
                        coleta_id: coletaId,
                        usuario: usuario,
                        mensagem: mensagem,
                        tipo: 'user',
                        created_at: new Date().toISOString()
                    }])
                    .select();

                if (error) throw error;

                console.log('✅ Mensagem enviada:', data);
                return { success: true, data: data };
            } catch (error) {
                console.error('❌ Erro ao enviar mensagem:', error);
                console.error('❌ Detalhes:', error.message, error.details);
                showNotification('Erro ao enviar mensagem: ' + error.message, 'error');
                throw error;
            }
        }

        // ========== FUNÇÕES PARA HISTÓRICO ==========

        // Função para carregar histórico do banco
        async function carregarHistorico(coletaId) {
            try {
                // Verificar se o Supabase está inicializado
                if (!supabaseClient) {
                    console.error('❌ Supabase não inicializado');
                    return [];
                }
                
                // ID é UUID - usar como string
                const idString = String(coletaId);
                
                const { data, error } = await supabaseClient
                    .from('historico_coletas')
                    .select('*')
                    .eq('coleta_id', idString)
                    .order('created_at', { ascending: false });

                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('❌ Erro ao carregar histórico:', error);
                return [];
            }
        }

        // Função para comparar dados e gerar histórico detalhado
        function compararDadosColeta(dadosAntigos, dadosNovos) {
            const mudancas = [];
            const nomesCampos = {
                'filial': 'Filial',
                'numero_coleta': 'Número da Coleta',
                'cliente': 'Cliente',
                'data_recebimento': 'Data de Coleta',
                'data_entrega': 'Data de Entrega',
                'origem': 'Origem',
                'destino': 'Destino',
                'valor': 'Valor',
                'km': 'KM',
                'tipos_veiculo': 'Tipos de Veículo',
                'tipos_carroceria': 'Tipos de Carroceria',
                'status': 'Status',
                'etapa_atual': 'Etapa Atual',
                'observacoes': 'Observações',
                'prioridade': 'Prioridade',
                'motorista_id': 'Motorista'
            };
            
            Object.keys(dadosNovos).forEach(campo => {
                if (campo === 'updated_at' || campo === 'updated_by' || campo === 'data_atualizacao') {
                    return; // Ignorar campos de controle
                }
                
                const valorAntigo = dadosAntigos[campo];
                const valorNovo = dadosNovos[campo];
                
                // Normalizar valores para comparação (convertendo strings para números quando aplicável)
                let valorAntigoNormalizado = valorAntigo;
                let valorNovoNormalizado = valorNovo;
                
                // Converter strings numéricas para números para campos numéricos
                if (campo === 'valor' || campo === 'km') {
                    if (typeof valorAntigo === 'string' && valorAntigo !== '' && valorAntigo !== null) {
                        valorAntigoNormalizado = parseFloat(valorAntigo.replace(/[^\d,.-]/g, '').replace(',', '.')) || valorAntigo;
                    }
                    if (typeof valorNovo === 'string' && valorNovo !== '' && valorNovo !== null) {
                        valorNovoNormalizado = parseFloat(valorNovo.replace(/[^\d,.-]/g, '').replace(',', '.')) || valorNovo;
                    }
                    // Comparar números arredondados para evitar problemas de precisão
                    if (typeof valorAntigoNormalizado === 'number' && typeof valorNovoNormalizado === 'number') {
                        if (Math.abs(valorAntigoNormalizado - valorNovoNormalizado) < 0.01) {
                            return; // Valores são iguais, não registrar mudança (retorna do forEach)
                        }
                    }
                }
                
                // Comparar valores (considerando arrays e objetos)
                const valorAntigoStr = JSON.stringify(valorAntigoNormalizado);
                const valorNovoStr = JSON.stringify(valorNovoNormalizado);
                
                if (valorAntigoStr !== valorNovoStr) {
                    let valorAntigoFormatado = formatarValorParaHistorico(valorAntigo, campo);
                    let valorNovoFormatado = formatarValorParaHistorico(valorNovo, campo);
                    
                    mudancas.push({
                        campo: nomesCampos[campo] || campo,
                        valorAntigo: valorAntigoFormatado,
                        valorNovo: valorNovoFormatado
                    });
                }
            });
            
            return mudancas;
        }
        
        // Função para formatar valores para exibição no histórico
        function formatarValorParaHistorico(valor, campo) {
            if (valor === null || valor === undefined || valor === '') {
                return '(vazio)';
            }
            
            // Formatar arrays (tipos_veiculo, tipos_carroceria)
            if (Array.isArray(valor)) {
                return valor.length > 0 ? valor.join(', ') : '(nenhum)';
            }
            
            // Formatar datas
            if (campo.includes('data') || campo.includes('Data')) {
                if (valor) {
                    try {
                        return new Date(valor).toLocaleDateString('pt-BR', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    } catch (e) {
                        return valor;
                    }
                }
            }
            
            // Formatar valores monetários
            if (campo === 'valor') {
                return `R$ ${parseFloat(valor || 0).toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            }
            
            // Formatar motorista_id (buscar nome se possível)
            if (campo === 'motorista_id') {
                // Retornar ID por enquanto, pode ser melhorado buscando o nome
                return valor || '(nenhum)';
            }
            
            return valor;
        }

        // Função para salvar no histórico (salva em ambas as tabelas)
        // opts: { departamento, motorista_id } — usado na vinculação para log "quem mais contratou"
        async function salvarNoHistorico(coletaId, acao, detalhes = '', opts = {}) {
            try {
                const userData = JSON.parse(localStorage.getItem('loggedInUser')) || {};
                const usuarioNome = currentUser?.nome || currentUser?.username || userData?.email || 'Sistema';
                const usuarioId = currentUser?.id || userData?.id || null;
                const departamento = opts.departamento ?? currentUser?.departamento ?? userData?.departamento ?? null;
                
                console.log('📝 Salvando histórico via API:', { coletaId, acao, usuarioNome, departamento: departamento || '(não informado)' });
                
                const body = {
                    coleta_id: coletaId,
                    acao: acao,
                    detalhes: detalhes,
                    usuario_id: usuarioId,
                    usuario_nome: usuarioNome
                };
                if (departamento != null) body.departamento = departamento;
                if (opts.motorista_id != null) body.motorista_id = opts.motorista_id;
                
                // Usar API do servidor para salvar histórico (contorna RLS)
                const headers = await getSupabaseAuthHeaders();
                const response = await fetch('/api/historico/salvar', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        ...headers
                    },
                    credentials: 'include',
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    let result;
                    try {
                        result = JSON.parse(errorText);
                    } catch {
                        result = { error: errorText };
                    }
                    console.error('❌ Erro ao salvar histórico:', result.error || result.details || errorText);
                    // Não lançar erro para não bloquear outras operações
                } else {
                    const result = await response.json();
                    console.log('✅ Histórico salvo com sucesso:', acao, result);
                }
            } catch (error) {
                console.error('❌ Erro ao salvar histórico (catch):', error);
                // Não lançar erro para não bloquear outras operações
            }
        }

        // ========== FUNÇÕES PARA TRAJETÓRIA COMPLETA ==========
        
        /**
         * Busca uma coleta por ID, número ou cliente (funciona mesmo com permissões limitadas)
         * @param {string} termo - Termo de busca (ID, número da coleta, cliente, etc.)
         * @returns {Promise<Object|null>} - Coleta encontrada ou null
         */
        async function buscarColetaPorTermo(termo) {
            try {
                if (!supabaseClient) {
                    console.error('❌ Supabase não inicializado');
                    return null;
                }

                const termoLimpo = termo.trim();
                if (!termoLimpo) return null;

                // Se o termo for numérico, buscar por número da coleta (não por ID, pois ID é UUID)
                if (!isNaN(termoLimpo)) {
                    // Buscar por número da coleta
                    const { data: porNumero, error: errorNumero } = await supabaseClient
                        .from('coletas')
                        .select('*')
                        .ilike('numero_coleta', `%${termoLimpo}%`)
                        .limit(10);

                    if (!errorNumero && porNumero && porNumero.length > 0) {
                        // Se encontrar exatamente uma, retornar ela
                        if (porNumero.length === 1) {
                            return porNumero[0];
                        }
                        // Se encontrar múltiplas, retornar a primeira
                        return porNumero[0];
                    }
                    
                    // Se não encontrou por número da coleta, tentar buscar por ID se parecer UUID
                    // UUIDs têm formato: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
                    const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                    if (uuidPattern.test(termoLimpo)) {
                        const { data: porId, error: errorId } = await supabaseClient
                            .from('coletas')
                            .select('*')
                            .eq('id', termoLimpo)
                            .maybeSingle();

                        if (!errorId && porId) {
                            return porId;
                        }
                    }
                } else {
                    // Se não for numérico, buscar por número da coleta também (pode conter letras)
                    const { data: porNumero, error: errorNumero } = await supabaseClient
                        .from('coletas')
                        .select('*')
                        .ilike('numero_coleta', `%${termoLimpo}%`)
                        .limit(10);

                    if (!errorNumero && porNumero && porNumero.length > 0) {
                        if (porNumero.length === 1) {
                            return porNumero[0];
                        }
                        return porNumero[0];
                    }
                }

                // Buscar por cliente
                const { data: porCliente, error: errorCliente } = await supabaseClient
                    .from('coletas')
                    .select('*')
                    .ilike('cliente', `%${termoLimpo}%`)
                    .limit(10);

                if (!errorCliente && porCliente && porCliente.length > 0) {
                    return porCliente[0];
                }

                // Se o termo parecer UUID, tentar buscar por ID
                const uuidPattern = /^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i;
                if (uuidPattern.test(termoLimpo)) {
                    const { data: porId, error: errorId } = await supabaseClient
                        .from('coletas')
                        .select('*')
                        .eq('id', termoLimpo)
                        .maybeSingle();

                    if (!errorId && porId) {
                        return porId;
                    }
                }

                return null;
            } catch (error) {
                console.error('❌ Erro ao buscar coleta:', error);
                return null;
            }
        }

        /**
         * Busca histórico completo e calcula tempo em cada etapa
         * @param {string} coletaId - ID da coleta (UUID)
         * @returns {Promise<Array>} - Array com histórico de etapas e tempos
         */
        async function buscarTrajetoriaCompleta(coletaId) {
            try {
                if (!supabaseClient) {
                    console.error('❌ Supabase não inicializado');
                    return [];
                }

                // ID é UUID - usar como string
                const idString = String(coletaId);

                // Buscar histórico de movimentações
                const { data: historico, error: errorHistorico } = await supabaseClient
                    .from('historico_coletas')
                    .select('*')
                    .eq('coleta_id', idString)
                    .order('created_at', { ascending: true });

                if (errorHistorico) {
                    console.error('❌ Erro ao buscar histórico:', errorHistorico);
                }

                // Buscar dados da coleta atual
                    
                const { data: coleta, error: errorColeta } = await supabaseClient
                    .from('coletas')
                    .select('*')
                    .eq('id', idString)
                    .maybeSingle();

                if (errorColeta || !coleta) {
                    console.error('❌ Erro ao buscar coleta:', errorColeta);
                    return [];
                }

                const etapaAtual = coleta.etapa_atual;
                const etapasConcluidas = coleta.etapas_concluidas || [];
                const trajetoriaItems = []; // Array para armazenar todas as passagens por etapas
                
                // Função auxiliar para extrair etapa de texto
                const extrairEtapaDoTexto = (texto) => {
                    if (!texto) return null;
                    const textoLower = texto.trim().toLowerCase();
                    
                    // Primeiro tentar match exato com nomes e IDs
                    for (const etapa of ETAPAS) {
                        const nomeLower = etapa.nome.toLowerCase();
                        const idLower = etapa.id.toLowerCase();
                        
                        // Tentar diferentes padrões: com aspas, sem aspas, com espaços
                        if (textoLower === `"${nomeLower}"` || textoLower === `"${idLower}"` ||
                            textoLower === nomeLower || textoLower === idLower ||
                            textoLower.includes(`"${nomeLower}"`) || textoLower.includes(`"${idLower}"`) ||
                            textoLower.includes(` ${nomeLower} `) || textoLower.includes(` ${idLower} `) ||
                            textoLower.startsWith(nomeLower) || textoLower.startsWith(idLower) ||
                            textoLower.endsWith(nomeLower) || textoLower.endsWith(idLower)) {
                            return etapa.id;
                        }
                    }
                    
                    // Se não encontrou match exato, tentar match parcial
                    for (const etapa of ETAPAS) {
                        const nomeLower = etapa.nome.toLowerCase();
                        const idLower = etapa.id.toLowerCase();
                        if (textoLower.includes(nomeLower) || textoLower.includes(idLower)) {
                            return etapa.id;
                        }
                    }
                    
                    return null;
                };
                
                // Processar histórico cronologicamente
                if (historico && historico.length > 0) {
                    const historicoOrdenado = [...historico].sort((a, b) => 
                        new Date(a.created_at) - new Date(b.created_at)
                    );
                    
                    // Rastrear etapa atual em cada momento
                    let etapaAtualMomento = null;
                    
                    // Começar com a etapa inicial (criação da coleta)
                    const primeiraEtapa = historicoOrdenado.find(h => h.etapa_atual || h.detalhes?.includes('criada'))?.etapa_atual || 
                                         etapaAtual || 
                                         'comercial';
                    etapaAtualMomento = primeiraEtapa;
                    
                    // Adicionar etapa inicial (criação)
                    if (primeiraEtapa) {
                        const dataCriacao = coleta.created_at || historicoOrdenado[0]?.created_at || new Date().toISOString();
                        trajetoriaItems.push({
                            etapa: primeiraEtapa,
                            nome: ETAPAS.find(e => e.id === primeiraEtapa)?.nome || primeiraEtapa,
                            dataEntrada: dataCriacao,
                            dataSaida: null,
                            atualizadoPor: coleta.created_by ? 'Criador' : 'Sistema',
                            isAtual: false,
                            ordem: -1
                        });
                    }
                    
                    historicoOrdenado.forEach((item, index) => {
                        let novaEtapaId = item.etapa_atual;
                        let etapaAnteriorId = item.etapa_anterior;
                        
                        // Se não tem nos campos, tentar extrair dos detalhes
                        if (!novaEtapaId && item.detalhes) {
                            // Tentar múltiplos padrões: "para X", "movida para X", "mudou para X"
                            const patterns = [
                                /para[:\s]+"?([^"",\n]+)/i,
                                /movida[^"]*para[:\s]+"?([^"",\n]+)/i,
                                /mudou[^"]*para[:\s]+"?([^"",\n]+)/i
                            ];
                            
                            for (const pattern of patterns) {
                                const match = item.detalhes.match(pattern);
                                if (match) {
                                    novaEtapaId = extrairEtapaDoTexto(match[1]);
                                    if (novaEtapaId) break;
                                }
                            }
                        }
                        
                        if (!etapaAnteriorId && item.detalhes) {
                            // Tentar múltiplos padrões: "de X", "movida de X"
                            const patterns = [
                                /de[:\s]+"?([^"",\n]+)/i,
                                /movida[^"]*de[:\s]+"?([^"",\n]+)/i
                            ];
                            
                            for (const pattern of patterns) {
                                const match = item.detalhes.match(pattern);
                                if (match) {
                                    etapaAnteriorId = extrairEtapaDoTexto(match[1]);
                                    if (etapaAnteriorId) break;
                                }
                            }
                        }
                        
                        // Debug: logar tentativas de extração
                        if (item.detalhes && item.detalhes.includes('movida')) {
                            console.log('🔍 Processando histórico:', {
                                detalhes: item.detalhes,
                                novaEtapaId,
                                etapaAnteriorId,
                                etapaAtualMomento
                            });
                        }
                        
                        // Se encontrou mudança de etapa
                        if (novaEtapaId && ETAPAS.find(e => e.id === novaEtapaId)) {
                            // Se havia etapa anterior diferente, marcar sua saída
                            if (etapaAtualMomento && etapaAtualMomento !== novaEtapaId) {
                                // Encontrar a última entrada nesta etapa que ainda não tem saída
                                const ultimaPassagem = trajetoriaItems
                                    .filter(t => t.etapa === etapaAtualMomento && !t.dataSaida)
                                    .sort((a, b) => new Date(b.dataEntrada) - new Date(a.dataEntrada))[0];
                                
                                if (ultimaPassagem) {
                                    ultimaPassagem.dataSaida = item.created_at;
                                }
                            }
                            
                            // Adicionar nova entrada na etapa
                            trajetoriaItems.push({
                                etapa: novaEtapaId,
                                nome: ETAPAS.find(e => e.id === novaEtapaId)?.nome || novaEtapaId,
                                dataEntrada: item.created_at,
                                dataSaida: null,
                                atualizadoPor: item.usuario_nome || item.usuario || 'Sistema',
                                isAtual: false,
                                ordem: index
                            });
                            
                            etapaAtualMomento = novaEtapaId;
                        }
                    });
                    
                    // Se não encontrou etapa inicial, adicionar
                    if (trajetoriaItems.length === 0) {
                        const etapaInicial = etapaAtual || 'comercial';
                        trajetoriaItems.push({
                            etapa: etapaInicial,
                            nome: ETAPAS.find(e => e.id === etapaInicial)?.nome || etapaInicial,
                            dataEntrada: coleta.created_at || coleta.data_entrada_etapa || new Date().toISOString(),
                            dataSaida: null,
                            atualizadoPor: coleta.created_by ? 'Criador' : 'Sistema',
                            isAtual: false,
                            ordem: -1
                        });
                    }
                } else {
                    // Sem histórico, adicionar etapa inicial
                    const etapaInicial = etapaAtual || 'comercial';
                    trajetoriaItems.push({
                        etapa: etapaInicial,
                        nome: ETAPAS.find(e => e.id === etapaInicial)?.nome || etapaInicial,
                        dataEntrada: coleta.created_at || coleta.data_entrada_etapa || new Date().toISOString(),
                        dataSaida: null,
                        atualizadoPor: coleta.created_by ? 'Criador' : 'Sistema',
                        isAtual: false,
                        ordem: -1
                    });
                }
                
                // Consolidar: para cada etapa, manter apenas a última passagem (mais recente)
                // Mas manter TODAS as etapas visitadas, não apenas as que estão na ordem do fluxo
                const etapasConsolidadas = {};
                trajetoriaItems.forEach(item => {
                    const etapaId = item.etapa;
                    if (!etapasConsolidadas[etapaId] || 
                        new Date(item.dataEntrada) > new Date(etapasConsolidadas[etapaId].dataEntrada)) {
                        etapasConsolidadas[etapaId] = { ...item };
                    }
                });
                
                // Adicionar etapas concluídas que não estão no histórico
                etapasConcluidas.forEach(etapaId => {
                    if (ETAPAS.find(e => e.id === etapaId) && !etapasConsolidadas[etapaId]) {
                        // Etapa concluída mas não está no histórico - adicionar com data estimada
                        etapasConsolidadas[etapaId] = {
                            etapa: etapaId,
                            nome: ETAPAS.find(e => e.id === etapaId)?.nome || etapaId,
                            dataEntrada: coleta.created_at || new Date().toISOString(),
                            dataSaida: coleta.updated_at || new Date().toISOString(),
                            atualizadoPor: 'Sistema',
                            isAtual: false,
                            ordem: 9998
                        };
                    }
                });
                
                // Marcar etapa atual
                if (etapaAtual && etapasConsolidadas[etapaAtual]) {
                    etapasConsolidadas[etapaAtual].isAtual = true;
                } else if (etapaAtual) {
                    // Adicionar etapa atual se não estiver na lista
                    etapasConsolidadas[etapaAtual] = {
                        etapa: etapaAtual,
                        nome: ETAPAS.find(e => e.id === etapaAtual)?.nome || etapaAtual,
                        dataEntrada: coleta.data_entrada_etapa || coleta.updated_at || coleta.created_at || new Date().toISOString(),
                        dataSaida: null,
                        atualizadoPor: coleta.updated_by ? 'Atualizador' : 'Sistema',
                        isAtual: true,
                        ordem: 9999
                    };
                }

                // Converter para array e ordenar CRONOLOGICAMENTE (por data de entrada)
                // Não filtrar por ETAPAS - mostrar TODAS as etapas visitadas
                const trajetoriaArray = Object.values(etapasConsolidadas);
                
                // Ordenar cronologicamente por data de entrada
                trajetoriaArray.sort((a, b) => {
                    const dataA = new Date(a.dataEntrada);
                    const dataB = new Date(b.dataEntrada);
                    return dataA - dataB;
                });
                
                // Calcular tempos para cada item
                const trajetoriaOrdenada = trajetoriaArray.map(item => {
                        
                        // Calcular tempo na etapa
                        if (item.dataEntrada) {
                            const entrada = new Date(item.dataEntrada);
                            let saida = null;
                            
                            if (item.dataSaida) {
                                // Etapa concluída: usar data de saída
                                saida = new Date(item.dataSaida);
                            } else if (item.isAtual) {
                                // Etapa atual: usar data atual para cálculo
                                saida = new Date();
                            }
                            
                            if (saida) {
                                const tempoMs = saida - entrada;
                                const tempoMinutos = Math.max(0, Math.floor(tempoMs / (1000 * 60)));
                                
                                item.tempoMinutos = tempoMinutos;
                                item.tempoFormatado = item.isAtual ? formatarTempo(tempoMinutos) + ' (em andamento)' : formatarTempo(tempoMinutos);
                            } else {
                                // Etapa sem saída e não atual (erro nos dados)
                                item.tempoMinutos = 0;
                                item.tempoFormatado = 'Sem tempo registrado';
                            }
                        } else {
                            item.tempoMinutos = 0;
                            item.tempoFormatado = 'Sem tempo registrado';
                        }
                        
                        item.acao = item.isAtual ? 'Etapa Atual' : 'Concluída';
                        return item;
                    });

                return trajetoriaOrdenada;
            } catch (error) {
                console.error('❌ Erro ao buscar trajetória completa:', error);
                return [];
            }
        }

        /**
         * Busca informações do usuário que atualizou
         * @param {string} userId - ID do usuário
         * @returns {Promise<Object|null>} - Dados do usuário ou null
         */
        async function buscarUsuarioPorId(userId) {
            try {
                if (!userId || !supabaseClient) return null;

                const { data, error } = await supabaseClient
                    .from('user_profiles')
                    .select('id, nome, email')
                    .eq('id', userId)
                    .maybeSingle();

                if (error || !data) return null;
                return data;
            } catch (error) {
                console.error('❌ Erro ao buscar usuário:', error);
                return null;
            }
        }

        /**
         * Abre modal de trajetória completa da coleta
         * @param {string} coletaId - ID da coleta
         */
        async function abrirModalTrajetoria(coletaId) {
            const modal = document.getElementById('modalTrajetoriaColeta');
            const conteudo = document.getElementById('conteudoTrajetoriaColeta');
            
            if (!modal || !conteudo) {
                console.error('❌ Modal de trajetória não encontrado');
                return;
            }

            // Mostrar modal com loading
            modal.style.display = 'flex';
            conteudo.innerHTML = `
                <div style="text-align: center; padding: 2rem;">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; color: #667eea;"></i>
                    <p style="margin-top: 1rem; color: #666;">Carregando trajetória...</p>
                </div>
            `;

            try {
                // Buscar dados da coleta
                // ID é UUID, não número - usar diretamente como string
                const { data: coleta, error: errorColeta } = await supabaseClient
                    .from('coletas')
                    .select('*')
                    .eq('id', String(coletaId))
                    .maybeSingle();

                if (errorColeta) {
                    console.error('❌ Erro ao buscar coleta:', errorColeta);
                    conteudo.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>Erro ao carregar dados da coleta.</p>
                            <p style="font-size: 0.9rem; margin-top: 0.5rem; color: #666;">${errorColeta.message || 'ID não encontrado ou inválido'}</p>
                        </div>
                    `;
                    return;
                }

                if (!coleta) {
                    conteudo.innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #dc3545;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                            <p>Coleta não encontrada.</p>
                        </div>
                    `;
                    return;
                }

                // Buscar trajetória
                const trajetoria = await buscarTrajetoriaCompleta(coletaId);
                
                // Buscar histórico completo
                const historico = await carregarHistorico(coletaId);

                // Buscar informações do usuário que criou
                const criadoPor = coleta.created_by ? await buscarUsuarioPorId(coleta.created_by) : null;
                
                // Buscar informações do usuário que atualizou
                const atualizadoPor = coleta.updated_by ? await buscarUsuarioPorId(coleta.updated_by) : null;

                // Renderizar conteúdo
                renderizarTrajetoriaCompleta(coleta, trajetoria, historico, criadoPor, atualizadoPor);
            } catch (error) {
                console.error('❌ Erro ao abrir modal de trajetória:', error);
                conteudo.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #dc3545;">
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                        <p>Erro ao carregar trajetória: ${error.message}</p>
                    </div>
                `;
            }
        }

        /**
         * Renderiza o conteúdo da trajetória completa
         */
        function renderizarTrajetoriaCompleta(coleta, trajetoria, historico, criadoPor, atualizadoPor) {
            const conteudo = document.getElementById('conteudoTrajetoriaColeta');
            if (!conteudo) return;

            // Função auxiliar para formatar moeda
            const formatarMoeda = (valor) => {
                if (valor === null || valor === undefined || valor === '') return 'R$ 0,00';
                return `R$ ${parseFloat(valor || 0).toLocaleString('pt-BR', {
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                })}`;
            };

            // Função auxiliar para formatar data
            const formatarData = (data) => {
                if (!data) return 'Não informado';
                try {
                    return new Date(data).toLocaleString('pt-BR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                } catch (e) {
                    return data;
                }
            };

            const etapaAtual = ETAPAS.find(e => e.id === coleta.etapa_atual);
            const etapaAtualNome = etapaAtual ? etapaAtual.nome : coleta.etapa_atual || 'Não definida';

            // Obter prioridade e cores baseadas na prioridade da coleta
            const prioridadeInfo = determinarPrioridadeAutomatica(coleta);
            
            // Mapear cores baseadas na prioridade
            const prioridadeColors = {
                'urgente': {
                    cor: '#dc3545',
                    corGradiente1: '#dc3545',
                    corGradiente2: '#c82333',
                    corHover: '#c82333',
                    corClara: 'rgba(220, 53, 69, 0.1)',
                    corBorda: '#dc3545',
                    corTexto: '#721c24',
                    corTextoSobreGradiente: 'rgba(255, 255, 255, 0.95)',
                    icon: 'fa-exclamation-triangle'
                },
                'alta': {
                    cor: '#fd7e14',
                    corGradiente1: '#fd7e14',
                    corGradiente2: '#e8590c',
                    corHover: '#e8590c',
                    corClara: 'rgba(253, 126, 20, 0.1)',
                    corBorda: '#fd7e14',
                    corTexto: '#8b4513',
                    corTextoSobreGradiente: 'rgba(255, 255, 255, 0.95)',
                    icon: 'fa-exclamation-circle'
                },
                'normal': {
                    cor: '#ffc107',
                    corGradiente1: '#ffc107',
                    corGradiente2: '#e0a800',
                    corHover: '#e0a800',
                    corClara: 'rgba(255, 193, 7, 0.15)',
                    corBorda: '#ffc107',
                    corTexto: '#856404',
                    corTextoSobreGradiente: '#856404',
                    icon: 'fa-clock'
                },
                'baixa': {
                    cor: '#28a745',
                    corGradiente1: '#28a745',
                    corGradiente2: '#20c997',
                    corHover: '#218838',
                    corClara: 'rgba(40, 167, 69, 0.1)',
                    corBorda: '#28a745',
                    corTexto: '#1b5e20',
                    corTextoSobreGradiente: 'rgba(255, 255, 255, 0.95)',
                    icon: 'fa-check-circle'
                }
            };

            const statusColors = prioridadeColors[prioridadeInfo.nivel] || prioridadeColors['baixa'];

            // Função auxiliar para formatar status
            const formatarStatus = (status) => {
                const statusMap = {
                    'ativa': { label: 'Ativa', cor: '#28a745', icon: 'fa-check-circle' },
                    'concluida': { label: 'Concluída', cor: '#17a2b8', icon: 'fa-check-double' },
                    'cancelada': { label: 'Cancelada', cor: '#dc3545', icon: 'fa-times-circle' },
                    'arquivada': { label: 'Arquivada', cor: '#6c757d', icon: 'fa-archive' }
                };
                const statusInfo = statusMap[status?.toLowerCase()] || { label: status || 'Ativa', cor: '#667eea', icon: 'fa-circle' };
                return `<span style="background: ${statusInfo.cor}; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.25rem; box-shadow: 0 2px 8px ${statusInfo.cor}40;">
                    <i class="fas ${statusInfo.icon}"></i> ${statusInfo.label}
                </span>`;
            };

            // Função auxiliar para formatar prioridade
            const formatarPrioridade = (prioridadeInfo) => {
                const cor = statusColors.cor;
                const bgGradient = statusColors.corGradiente1;
                return `<span style="background: linear-gradient(135deg, ${statusColors.corGradiente1} 0%, ${statusColors.corGradiente2} 100%); color: white; padding: 0.35rem 1rem; border-radius: 20px; font-size: 0.8rem; font-weight: 700; display: inline-flex; align-items: center; gap: 0.5rem; box-shadow: 0 3px 10px ${cor}50; text-transform: uppercase; letter-spacing: 0.5px;">
                    <i class="fas ${statusColors.icon}"></i> ${prioridadeInfo.nome}
                </span>`;
            };

            let html = `
                <!-- Header Principal com Informações da Coleta -->
                <div style="background: linear-gradient(135deg, ${statusColors.corGradiente1} 0%, ${statusColors.corGradiente2} 100%); color: white; padding: 2rem; border-radius: 16px; margin-bottom: 2rem; box-shadow: 0 8px 24px ${statusColors.cor}40;">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1.5rem;">
                        <div>
                            <div>
                            <div style="font-size: 0.9rem; opacity: 0.9; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-barcode"></i> Número da Coleta
                            </div>
                            <div style="font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem;">${coleta.numero_coleta || 'N/A'}</div>
                            <div style="font-size: 1rem; opacity: 0.9; margin-bottom: 0.75rem;">${coleta.cliente || 'Cliente não informado'}</div>
                            <div style="display: flex; align-items: center; gap: 0.75rem; margin-top: 0.75rem;">
                                <div style="font-size: 0.85rem; opacity: 0.9;">Prioridade:</div>
                                ${formatarPrioridade(prioridadeInfo)}
                            </div>
                        </div>
                        </div>
                        <div style="text-align: right;">
                            ${formatarPrioridade(prioridadeInfo)}
                            <div style="margin-top: 1rem; font-size: 0.9rem; opacity: 0.9; display: flex; align-items: center; gap: 0.5rem; justify-content: flex-end;">
                                <i class="fas fa-tag"></i> ${formatarStatus(coleta.status)}
                            </div>
                            <div style="margin-top: 0.75rem; font-size: 0.9rem; opacity: 0.9;">Etapa Atual</div>
                            <div style="font-size: 1.2rem; font-weight: 600; margin-top: 0.25rem;">${etapaAtualNome}</div>
                        </div>
                    </div>
                    
                    <!-- Grid de Informações Principais -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid rgba(255,255,255,0.2);">
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 12px; backdrop-filter: blur(10px);">
                            <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-dollar-sign"></i> Valor
                            </div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${formatarMoeda(coleta.valor)}</div>
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 12px; backdrop-filter: blur(10px);">
                            <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-building"></i> Filial
                            </div>
                            <div style="font-size: 1.2rem; font-weight: 600;">${coleta.filial || 'N/A'}</div>
                        </div>
                        ${coleta.km ? `
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 12px; backdrop-filter: blur(10px);">
                            <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-route"></i> Distância
                            </div>
                            <div style="font-size: 1.2rem; font-weight: 600;">${parseFloat(coleta.km || 0).toLocaleString('pt-BR')} km</div>
                        </div>
                        ` : ''}
                        ${coleta.data_recebimento ? `
                        <div style="background: rgba(255,255,255,0.15); padding: 1rem; border-radius: 12px; backdrop-filter: blur(10px);">
                            <div style="font-size: 0.8rem; opacity: 0.9; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-calendar-alt"></i> Data Coleta
                            </div>
                            <div style="font-size: 1rem; font-weight: 600;">${formatarData(coleta.data_recebimento)}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Rota: Origem → Destino -->
                ${coleta.origem || coleta.destino ? `
                <div style="background: linear-gradient(135deg, ${statusColors.corClara} 0%, rgba(248, 249, 250, 1) 100%); padding: 1.5rem; border-radius: 16px; margin-bottom: 2rem; border-left: 4px solid ${statusColors.cor}; box-shadow: 0 2px 8px ${statusColors.cor}20;">
                    <div style="display: flex; align-items: center; gap: 1rem; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-map-marker-alt" style="color: #28a745;"></i> Origem
                            </div>
                            <div style="font-weight: 600; color: #2d3748; font-size: 1.1rem;">${coleta.origem || 'Não informado'}</div>
                        </div>
                        <div style="font-size: 1.5rem; color: ${statusColors.cor}; margin: 0 1rem; transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.2)'" onmouseout="this.style.transform='scale(1)'">
                            <i class="fas fa-arrow-right"></i>
                        </div>
                        <div style="flex: 1; min-width: 200px;">
                            <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                                <i class="fas fa-map-marker-alt" style="color: #dc3545;"></i> Destino
                            </div>
                            <div style="font-weight: 600; color: #2d3748; font-size: 1.1rem;">${coleta.destino || 'Não informado'}</div>
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- Informações Adicionais -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    ${coleta.tipos_veiculo && Array.isArray(coleta.tipos_veiculo) && coleta.tipos_veiculo.length > 0 ? `
                    <div style="background: white; padding: 1rem; border-radius: 12px; border: 1px solid #e0e0e0; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-truck" style="color: #667eea;"></i> Tipos de Veículo
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${coleta.tipos_veiculo.map(tipo => `
                                <span style="background: #e3f2fd; color: #1976d2; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 500;">
                                    ${tipo}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    ${coleta.tipos_carroceria && Array.isArray(coleta.tipos_carroceria) && coleta.tipos_carroceria.length > 0 ? `
                    <div style="background: white; padding: 1rem; border-radius: 12px; border: 1px solid #e0e0e0; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-box" style="color: #764ba2;"></i> Tipos de Carroceria
                        </div>
                        <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                            ${coleta.tipos_carroceria.map(tipo => `
                                <span style="background: #f3e5f5; color: #7b1fa2; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 500;">
                                    ${tipo}
                                </span>
                            `).join('')}
                        </div>
                    </div>
                    ` : ''}
                    ${coleta.motorista_id ? `
                    <div style="background: white; padding: 1rem; border-radius: 12px; border: 1px solid #e0e0e0; box-shadow: 0 2px 8px rgba(0,0,0,0.05);">
                        <div style="font-size: 0.85rem; color: #6c757d; margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-user-tie" style="color: #ff9800;"></i> Motorista
                        </div>
                        <div style="font-weight: 600; color: #2d3748;">${coleta.motorista_nome || 'Motorista atribuído'}</div>
                    </div>
                    ` : ''}
                </div>

                <!-- Informações de Criação e Atualização -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-bottom: 2rem;">
                    <div style="background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #28a745; box-shadow: 0 2px 8px rgba(40, 167, 69, 0.1);">
                        <div style="font-size: 0.85rem; color: #2e7d32; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
                            <i class="fas fa-user-plus"></i> Criado por
                        </div>
                        <div style="font-weight: 700; color: #1b5e20; font-size: 1.1rem; margin-bottom: 0.5rem;">
                            ${criadoPor ? (criadoPor.nome || criadoPor.email) : 'Sistema'}
                        </div>
                        <div style="font-size: 0.9rem; color: #4caf50; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-calendar"></i> ${formatarData(coleta.created_at)}
                        </div>
                    </div>
                    <div style="background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); padding: 1.5rem; border-radius: 12px; border-left: 4px solid #667eea; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.1);">
                        <div style="font-size: 0.85rem; color: #1565c0; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
                            <i class="fas fa-user-edit"></i> Última atualização por
                        </div>
                        <div style="font-weight: 700; color: #0d47a1; font-size: 1.1rem; margin-bottom: 0.5rem;">
                            ${atualizadoPor ? (atualizadoPor.nome || atualizadoPor.email) : (coleta.updated_by || 'Sistema')}
                        </div>
                        <div style="font-size: 0.9rem; color: #2196f3; display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-clock"></i> ${formatarData(coleta.updated_at || coleta.data_atualizacao)}
                        </div>
                    </div>
                </div>

                <!-- Timeline da Trajetória -->
                <div style="margin-bottom: 2rem;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid #e9ecef;">
                        <h3 style="color: #2d3748; margin: 0; display: flex; align-items: center; gap: 0.5rem; font-size: 1.5rem;">
                            <i class="fas fa-route" style="color: ${statusColors.cor};"></i>
                            Trajetória Completa
                        </h3>
                        ${trajetoria.length > 0 ? `
                        <div style="display: flex; gap: 0.5rem; align-items: center;">
                            <span style="background: ${statusColors.cor}; color: white; padding: 0.5rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: 600; box-shadow: 0 2px 8px ${statusColors.cor}40;">
                                <i class="fas fa-list"></i> ${trajetoria.length} ${trajetoria.length === 1 ? 'Etapa' : 'Etapas'}
                            </span>
                        </div>
                        ` : ''}
                    </div>
            `;

            if (trajetoria.length === 0) {
                html += `
                    <div style="text-align: center; padding: 2rem; background: #f8f9fa; border-radius: 8px; color: #6c757d;">
                        <i class="fas fa-info-circle" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>Nenhuma movimentação registrada ainda.</p>
                    </div>
                `;
            } else {
                html += `
                    <div style="position: relative; padding-left: 2rem;">
                        <!-- Linha vertical da timeline -->
                        <div style="position: absolute; left: 0.5rem; top: 0; bottom: 0; width: 3px; background: linear-gradient(to bottom, ${statusColors.corGradiente1}, ${statusColors.corGradiente2}); border-radius: 2px; box-shadow: 0 0 10px ${statusColors.cor}30;"></div>
                `;

                trajetoria.forEach((item, index) => {
                    const isAtual = !item.dataSaida;
                    const isUltima = index === trajetoria.length - 1;
                    
                    html += `
                        <div style="position: relative; margin-bottom: 2rem; padding-left: 2rem;">
                            <!-- Ponto da timeline -->
                            <div style="position: absolute; left: -1.5rem; top: 0.5rem; width: 1.2rem; height: 1.2rem; background: ${isAtual ? statusColors.cor : statusColors.corGradiente1}; border-radius: 50%; border: 3px solid white; box-shadow: 0 0 0 3px ${isAtual ? statusColors.cor : statusColors.corGradiente1}, 0 0 0 6px ${statusColors.cor}20; z-index: 2; transition: transform 0.3s;" onmouseover="this.style.transform='scale(1.3)'" onmouseout="this.style.transform='scale(1)'"></div>
                            
                            <!-- Card da etapa -->
                            <div style="background: ${isAtual ? `linear-gradient(135deg, ${statusColors.corClara} 0%, rgba(232, 245, 233, 1) 100%)` : 'white'}; border: 2px solid ${isAtual ? statusColors.cor : statusColors.corBorda}; border-left: 4px solid ${isAtual ? statusColors.cor : statusColors.corGradiente1}; border-radius: 16px; padding: 1.5rem; box-shadow: ${isAtual ? `0 4px 16px ${statusColors.cor}30` : `0 2px 8px ${statusColors.cor}20`}; transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);" onmouseover="this.style.transform='translateY(-4px) scale(1.01)'; this.style.boxShadow='${isAtual ? `0 8px 24px ${statusColors.cor}40` : `0 4px 16px ${statusColors.cor}30`}'; this.style.borderColor='${statusColors.cor}'" onmouseout="this.style.transform=''; this.style.boxShadow='${isAtual ? `0 4px 16px ${statusColors.cor}30` : `0 2px 8px ${statusColors.cor}20`}'; this.style.borderColor='${isAtual ? statusColors.cor : statusColors.corBorda}'">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem; flex-wrap: wrap; gap: 1rem;">
                                    <div style="flex: 1; min-width: 200px;">
                                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.75rem;">
                                            <div style="font-size: 1.4rem; font-weight: 700; color: ${isAtual ? statusColors.corTexto : '#2d3748'};">
                                                ${item.nome}
                                            </div>
                                            ${isAtual ? `<span style="background: linear-gradient(135deg, ${statusColors.cor} 0%, ${statusColors.corGradiente2} 100%); color: white; padding: 0.35rem 0.85rem; border-radius: 20px; font-size: 0.75rem; font-weight: 700; display: inline-flex; align-items: center; gap: 0.35rem; box-shadow: 0 2px 8px ${statusColors.cor}40; animation: pulse 2s infinite;"><i class="fas fa-circle" style="font-size: 0.5rem;"></i> ETAPA ATUAL</span>` : `<span style="background: linear-gradient(135deg, #6c757d 0%, #5a6268 100%); color: white; padding: 0.35rem 0.85rem; border-radius: 20px; font-size: 0.75rem; font-weight: 600; box-shadow: 0 2px 6px rgba(108, 117, 125, 0.3);"><i class="fas fa-check"></i> Concluída</span>`}
                                        </div>
                                        <div style="font-size: 0.9rem; color: #6c757d; display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: ${statusColors.corClara}; border-radius: 8px; border-left: 3px solid ${statusColors.cor};">
                                            <i class="fas fa-user-circle" style="color: ${statusColors.cor};"></i>
                                            <span style="font-weight: 500;">${item.atualizadoPor}</span>
                                        </div>
                                    </div>
                                    ${item.tempoFormatado ? `
                                    <div style="text-align: right;">
                                        <div style="background: linear-gradient(135deg, ${statusColors.corGradiente1} 0%, ${statusColors.corGradiente2} 100%); color: white; padding: 0.75rem 1.25rem; border-radius: 16px; font-weight: 700; font-size: 1rem; box-shadow: 0 4px 12px ${statusColors.cor}40; display: inline-flex; align-items: center; gap: 0.5rem; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                                            <i class="fas fa-clock"></i>
                                            <span>${item.tempoFormatado}</span>
                                        </div>
                                    </div>
                                    ` : ''}
                                </div>
                                
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-top: 1rem; padding-top: 1rem; border-top: 2px solid ${isAtual ? statusColors.corClara : '#e0e0e0'};">
                                    <div style="background: ${isAtual ? statusColors.corClara : '#f8f9fa'}; padding: 1rem; border-radius: 12px; border-left: 3px solid ${statusColors.cor}; transition: transform 0.2s;" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform=''">
                                        <div style="color: ${statusColors.corTexto}; margin-bottom: 0.5rem; font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
                                            <i class="fas fa-sign-in-alt" style="color: ${statusColors.cor};"></i> Data de Entrada
                                        </div>
                                        <div style="font-weight: 700; color: #2d3748; font-size: 1rem;">
                                            ${formatarData(item.dataEntrada)}
                                        </div>
                                    </div>
                                    ${item.dataSaida ? `
                                        <div style="background: #f8f9fa; padding: 1rem; border-radius: 12px; border-left: 3px solid #dc3545; transition: transform 0.2s;" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform=''">
                                            <div style="color: #6c757d; margin-bottom: 0.5rem; font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
                                                <i class="fas fa-sign-out-alt" style="color: #dc3545;"></i> Data de Saída
                                            </div>
                                            <div style="font-weight: 700; color: #2d3748; font-size: 1rem;">
                                                ${formatarData(item.dataSaida)}
                                            </div>
                                        </div>
                                    ` : `
                                        <div style="background: linear-gradient(135deg, ${statusColors.corClara} 0%, rgba(232, 245, 233, 1) 100%); padding: 1rem; border-radius: 12px; border: 1px solid ${statusColors.cor}; border-left: 3px solid ${statusColors.cor}; transition: transform 0.2s;" onmouseover="this.style.transform='translateX(4px)'" onmouseout="this.style.transform=''">
                                            <div style="color: ${statusColors.corTexto}; margin-bottom: 0.5rem; font-size: 0.85rem; display: flex; align-items: center; gap: 0.5rem; font-weight: 600;">
                                                <i class="fas fa-hourglass-half" style="color: ${statusColors.cor};"></i> Status
                                            </div>
                                            <div style="font-weight: 700; color: ${statusColors.corTexto}; font-size: 1rem;">
                                                Em andamento
                                            </div>
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    `;
                });

                html += `</div>`;
            }

            html += `</div>`;

            // Adicionar resumo de estatísticas
            if (trajetoria.length > 0) {
                const tempoTotal = trajetoria.reduce((sum, item) => sum + (item.tempoMinutos || 0), 0);
                const etapasCompletas = trajetoria.filter(item => item.dataSaida).length;
                const etapasEmAndamento = trajetoria.filter(item => !item.dataSaida).length;
                const tempoMedioPorEtapa = etapasCompletas > 0 ? Math.round(tempoTotal / etapasCompletas) : 0;
                
                html += `
                    <div style="background: linear-gradient(135deg, ${statusColors.corGradiente1} 0%, ${statusColors.corGradiente2} 100%); padding: 2rem; border-radius: 16px; margin-top: 2rem; box-shadow: 0 8px 24px ${statusColors.cor}40;">
                        <h4 style="color: white; margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; font-size: 1.3rem;">
                            <i class="fas fa-chart-line"></i> Resumo Estatístico
                        </h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 1.5rem;">
                            <div style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); padding: 1.5rem; border-radius: 16px; text-align: center; border: 2px solid rgba(255,255,255,0.3); transition: transform 0.3s, box-shadow 0.3s;" onmouseover="this.style.transform='translateY(-4px) scale(1.05)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.2)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                                <div style="font-size: 2.5rem; font-weight: 700; color: white; margin-bottom: 0.5rem; text-shadow: 0 2px 8px rgba(0,0,0,0.2);">${trajetoria.length}</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.95); font-weight: 600;">
                                    <i class="fas fa-list"></i> Etapas Visitadas
                                </div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); padding: 1.5rem; border-radius: 16px; text-align: center; border: 2px solid rgba(255,255,255,0.3); transition: transform 0.3s, box-shadow 0.3s;" onmouseover="this.style.transform='translateY(-4px) scale(1.05)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.2)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                                <div style="font-size: 2.5rem; font-weight: 700; color: white; margin-bottom: 0.5rem; text-shadow: 0 2px 8px rgba(0,0,0,0.2);">${etapasCompletas}</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.95); font-weight: 600;">
                                    <i class="fas fa-check-circle"></i> Etapas Concluídas
                                </div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); padding: 1.5rem; border-radius: 16px; text-align: center; border: 2px solid rgba(255,255,255,0.3); transition: transform 0.3s, box-shadow 0.3s;" onmouseover="this.style.transform='translateY(-4px) scale(1.05)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.2)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                                <div style="font-size: 2.5rem; font-weight: 700; color: white; margin-bottom: 0.5rem; text-shadow: 0 2px 8px rgba(0,0,0,0.2);">${etapasEmAndamento}</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.95); font-weight: 600;">
                                    <i class="fas fa-hourglass-half"></i> Em Andamento
                                </div>
                            </div>
                            <div style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); padding: 1.5rem; border-radius: 16px; text-align: center; border: 2px solid rgba(255,255,255,0.3); transition: transform 0.3s, box-shadow 0.3s;" onmouseover="this.style.transform='translateY(-4px) scale(1.05)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.2)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                                <div style="font-size: 1.8rem; font-weight: 700; color: white; margin-bottom: 0.5rem; text-shadow: 0 2px 8px rgba(0,0,0,0.2);">${formatarTempo(tempoTotal)}</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.95); font-weight: 600;">
                                    <i class="fas fa-clock"></i> Tempo Total
                                </div>
                            </div>
                            ${tempoMedioPorEtapa > 0 ? `
                            <div style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); padding: 1.5rem; border-radius: 16px; text-align: center; border: 2px solid rgba(255,255,255,0.3); transition: transform 0.3s, box-shadow 0.3s;" onmouseover="this.style.transform='translateY(-4px) scale(1.05)'; this.style.boxShadow='0 8px 20px rgba(0,0,0,0.2)'" onmouseout="this.style.transform=''; this.style.boxShadow=''">
                                <div style="font-size: 1.8rem; font-weight: 700; color: white; margin-bottom: 0.5rem; text-shadow: 0 2px 8px rgba(0,0,0,0.2);">${formatarTempo(tempoMedioPorEtapa)}</div>
                                <div style="font-size: 0.9rem; color: rgba(255,255,255,0.95); font-weight: 600;">
                                    <i class="fas fa-chart-bar"></i> Tempo Médio/Etapa
                                </div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }

            conteudo.innerHTML = html;
        }

        /**
         * Fecha o modal de trajetória
         */
        function fecharModalTrajetoria() {
            const modal = document.getElementById('modalTrajetoriaColeta');
            if (modal) {
                modal.style.display = 'none';
            }
        }

        /**
         * Busca uma coleta pelo termo de busca e abre o modal de trajetória
         */
        async function buscarECarregarTrajetoria() {
            const searchInput = document.getElementById('searchFilter');
            if (!searchInput) {
                showNotification('Campo de busca não encontrado', 'error');
                return;
            }

            const termo = searchInput.value.trim();
            if (!termo) {
                showNotification('Digite um termo de busca (número da coleta, cliente, etc.)', 'warning');
                return;
            }

            try {
                showNotification('Buscando coleta...', 'info');
                
                // Buscar coleta
                const coleta = await buscarColetaPorTermo(termo);
                
                if (!coleta) {
                    showNotification('Coleta não encontrada. Tente buscar por número da coleta, cliente ou ID.', 'warning');
                    return;
                }

                // Abrir modal de trajetória
                await abrirModalTrajetoria(coleta.id);
                showNotification('Trajetória carregada com sucesso!', 'success');
            } catch (error) {
                console.error('❌ Erro ao buscar trajetória:', error);
                showNotification('Erro ao buscar trajetória: ' + error.message, 'error');
            }
        }

        // Expor funções globalmente
        window.abrirModalTrajetoria = abrirModalTrajetoria;
        window.fecharModalTrajetoria = fecharModalTrajetoria;
        window.buscarColetaPorTermo = buscarColetaPorTermo;
        window.buscarECarregarTrajetoria = buscarECarregarTrajetoria;

        // Função para carregar histórico no card
        async function carregarHistoricoParaCard(coletaId) {
            try {
                // Verificar se o Supabase está inicializado
                if (!supabaseClient) {
                    console.error('❌ Supabase não inicializado');
                    return [];
                }
                
                const historico = await carregarHistorico(coletaId);
                const historicoContainer = document.getElementById(`historico-content-${coletaId}`);
                
                if (!historicoContainer) return;
                
                if (historico.length === 0) {
                    historicoContainer.innerHTML = `
                        <div style="text-align: center; color: #6c757d; padding: 0.5rem; font-size: 0.8rem;">
                            <i class="fas fa-inbox"></i>
                            <div>Nenhuma movimentação</div>
                        </div>
                    `;
                } else {
                    // Mostra apenas as 3 últimas movimentações
                    const ultimasMovimentacoes = historico.slice(0, 3);
                    
                    historicoContainer.innerHTML = ultimasMovimentacoes.map(item => {
                        // Verificar se detalhes contém mudanças formatadas
                        let detalhesHTML = '';
                        if (item.detalhes && item.detalhes.includes('→')) {
                            detalhesHTML = item.detalhes.split('\n').map(linha => {
                                if (linha.includes('→')) {
                                    const [campo, mudanca] = linha.split(':');
                                    const [antigo, novo] = mudanca.split('→').map(s => s.trim().replace(/"/g, ''));
                                    return `
                                        <div style="margin: 0.5rem 0; padding: 0.5rem; background: rgba(102, 126, 234, 0.05); border-radius: 6px; border-left: 3px solid #667eea;">
                                            <div style="font-weight: 600; color: #667eea; font-size: 0.75rem; margin-bottom: 0.3rem;">${campo.replace('•', '').trim()}</div>
                                            <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; flex-wrap: wrap;">
                                                <span style="color: #6c757d; text-decoration: line-through;">${antigo}</span>
                                                <i class="fas fa-arrow-right" style="color: #667eea; font-size: 0.7rem;"></i>
                                                <span style="color: #28a745; font-weight: 600;">${novo}</span>
                                            </div>
                                        </div>
                                    `;
                                }
                                return `<div style="margin: 0.3rem 0; font-size: 0.85rem;">${linha}</div>`;
                            }).join('');
                        } else {
                            detalhesHTML = `<div style="font-size: 0.85rem; color: #6c757d; margin-top: 0.5rem;">${item.detalhes || 'Sem detalhes'}</div>`;
                        }
                        
                        return `
                        <div class="historico-item-card">
                            <div class="historico-item-header">
                                <span class="historico-usuario-card">${item.usuario || item.usuario_nome || 'Sistema'}</span>
                                <span class="historico-data-card">${formatarDataHora(item.created_at)}</span>
                            </div>
                            <div class="historico-acao-card">
                                ${getTextoAcao(item.acao)}
                            </div>
                            ${detalhesHTML}
                        </div>
                    `;
                    }).join('');
                    
                    // Se tiver mais de 3, mostra contador
                    if (historico.length > 3) {
                        historicoContainer.innerHTML += `
                            <div class="historico-mais-itens" onclick="event.stopPropagation(); openEditColetaModal('${coletaId}')">
                                +${historico.length - 3} movimentações anteriores
                            </div>
                        `;
                    }
                }
            } catch (error) {
                console.error('❌ Erro ao carregar histórico para card:', error);
                const historicoContainer = document.getElementById(`historico-${coletaId}`);
                if (historicoContainer) {
                    historicoContainer.innerHTML = `
                        <div style="text-align: center; color: #6c757d; padding: 0.5rem; font-size: 0.8rem;">
                            <i class="fas fa-exclamation-triangle"></i>
                            <div>Erro ao carregar histórico</div>
                        </div>
                    `;
                }
            }
        }

        // Função auxiliar para formatar data e hora
        function formatarDataHora(dataString) {
            const data = new Date(dataString);
            return data.toLocaleString('pt-BR', {
                day: '2-digit',
                month: '2-digit', 
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Função para traduzir ações
        function getTextoAcao(acao) {
            const acoes = {
                'coleta_criada': '📝 Coleta criada',
                'coleta_editada': '✏️ Coleta editada', 
                'etapa_avancada': '🚀 Etapa avançada',
                'etapa_retornada': '⬅️ Etapa retornada',
                'coleta_excluida': '🗑️ Coleta excluída',
                'anexo_adicionado': '📎 Anexo adicionado',
                'anexo_removido': '📎 Anexo removido',
                'etiquetas_alteradas': '🏷️ Etiquetas alteradas',
                'motorista_vinculado': '👤 Motorista vinculado',
                'motorista_trocado': '🔄 Motorista trocado'
            };
            return acoes[acao] || acao;
        }

        // ========== RENDERIZAÇÃO DE COLETAS ==========
        let renderizandoColetas = false;
        let ultimaRenderizacao = 0;
        let timeoutRenderizacao = null;
        
        // Função wrapper que decide qual renderização usar
        async function renderColetasWrapper(filteredData = null) {
            if (visualizacaoAtual === 'kanban') {
                await renderColetasKanban(filteredData);
            } else {
                await renderColetas(filteredData);
            }
        }
        
        async function renderColetas(filteredData = null) {
            // Limpar timeout anterior se existir
            if (timeoutRenderizacao) {
                clearTimeout(timeoutRenderizacao);
                timeoutRenderizacao = null;
            }
            
            // Proteção contra renderizações simultâneas
            if (renderizandoColetas) {
                console.warn('⚠️ Renderização já em andamento, agendando nova renderização...');
                // Agendar renderização após a atual terminar
                timeoutRenderizacao = setTimeout(() => {
                    renderColetas(filteredData);
                }, 200);
                return;
            }
            
            // Debounce: se foi chamada há menos de 150ms, aguardar
            const agora = Date.now();
            const tempoDesdeUltima = agora - ultimaRenderizacao;
            if (tempoDesdeUltima < 150 && ultimaRenderizacao > 0) {
                console.log(`⏳ Renderização muito rápida (${tempoDesdeUltima}ms), aguardando...`);
                timeoutRenderizacao = setTimeout(() => {
                    renderColetas(filteredData);
                }, 150 - tempoDesdeUltima);
                return;
            }
            
            ultimaRenderizacao = agora;
            renderizandoColetas = true;
            
            try {
                const grid = document.getElementById('coletasGrid');
                if (!grid) {
                    console.error('❌ Grid de coletas não encontrado');
                    renderizandoColetas = false;
                    return;
                }
                
                // Garantir que o grid está visível antes de renderizar
                if (visualizacaoAtual === 'grid' && grid.style.display === 'none') {
                    grid.style.display = 'grid';
                }
                
                // Por padrão, mostrar apenas coletas ativas (não arquivadas)
                let dataToRender = filteredData || window.coletasAtivas || coletasData.filter(c => !c.arquivado);

                // Remover duplicatas baseado no ID da coleta
                const coletasUnicas = [];
                const idsVistos = new Set();
                for (const coleta of dataToRender) {
                    if (coleta && coleta.id && !idsVistos.has(coleta.id)) {
                        idsVistos.add(coleta.id);
                        coletasUnicas.push(coleta);
                    }
                }
                dataToRender = coletasUnicas;
                
                // ✅ PAGINAÇÃO: Armazenar coletas filtradas e aplicar paginação
                coletasFiltradas = dataToRender;
                const totalPaginas = Math.ceil(coletasFiltradas.length / itensPorPagina);
                
                // Ajustar página atual se necessário
                if (paginaAtual > totalPaginas && totalPaginas > 0) {
                    paginaAtual = totalPaginas;
                }
                if (paginaAtual < 1) {
                    paginaAtual = 1;
                }
                
                // Aplicar paginação
                const inicio = (paginaAtual - 1) * itensPorPagina;
                const fim = inicio + itensPorPagina;
                dataToRender = coletasFiltradas.slice(inicio, fim);
                
                console.log(`📄 Paginação: Página ${paginaAtual} de ${totalPaginas} (${coletasFiltradas.length} coletas total, mostrando ${dataToRender.length})`);

                // Verificar cards existentes ANTES de limpar o grid
                const cardsExistentes = grid.querySelectorAll('[data-coleta-id]');
                const idsExistentes = new Set();
                cardsExistentes.forEach(card => {
                    const id = card.getAttribute('data-coleta-id');
                    if (id) idsExistentes.add(id);
                });

                // Limpar o grid completamente antes de renderizar
            grid.innerHTML = '';

            if (dataToRender.length === 0) {
                grid.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: #6c757d;">
                        <i class="fas fa-inbox" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <h3>Nenhuma coleta encontrada</h3>
                        <p>Tente ajustar os filtros para ver mais resultados</p>
                    </div>
                `;
                    return;
                }

                // Carregar anexos para cada coleta e adicionar apenas se não existir
            for (const coleta of dataToRender) {
                    // Verificar novamente se não foi adicionado durante o loop
                    const cardJaExiste = grid.querySelector(`[data-coleta-id="${coleta.id}"]`);
                    if (cardJaExiste) {
                        console.warn('⚠️ Card já existe no grid, pulando:', coleta.id);
                        continue;
                    }
                    
                coleta.anexos = await carregarAnexos(coleta.id);
                const card = createColetaCard(coleta);
                    card.setAttribute('data-coleta-id', coleta.id);
                    
                    // Verificar uma última vez antes de adicionar
                    const cardDuplicado = grid.querySelector(`[data-coleta-id="${coleta.id}"]`);
                    if (!cardDuplicado) {
                grid.appendChild(card);
                
                // Carregar informações do motorista se houver vinculação
                if (coleta.motorista_id) {
                    await carregarInfoMotorista(coleta.id, coleta.motorista_id, coleta.anexos);
                        }
                
                // ✅ Carregar ITs relacionadas ao cliente (filtradas por filial)
                if (coleta.cliente) {
                    await carregarITsRelacionadas(coleta.id, coleta.cliente, coleta.filial);
                        }
                    } else {
                        console.warn('⚠️ Card duplicado detectado no último momento, removendo:', coleta.id);
                        cardDuplicado.remove();
                        grid.appendChild(card);
                        
                        if (coleta.motorista_id) {
                            await carregarInfoMotorista(coleta.id, coleta.motorista_id, coleta.anexos);
                        }
                        
                        // ✅ Carregar ITs relacionadas ao cliente (filtradas por filial)
                        if (coleta.cliente) {
                            await carregarITsRelacionadas(coleta.id, coleta.cliente, coleta.filial);
                        }
                    }
                }

                // Verificação final: remover qualquer duplicata que possa ter sido criada
                const todosCards = grid.querySelectorAll('[data-coleta-id]');
                const idsFinais = new Map();
                todosCards.forEach(card => {
                    const id = card.getAttribute('data-coleta-id');
                    if (id) {
                        if (idsFinais.has(id)) {
                            console.warn('⚠️ Duplicata final detectada, removendo:', id);
                            card.remove();
                        } else {
                            idsFinais.set(id, card);
                        }
                    }
                });

            updateStats(dataToRender);
                
                // ✅ PAGINAÇÃO: Adicionar controles de paginação
                renderizarControlesPaginacao(totalPaginas);
                
            } finally {
                renderizandoColetas = false;
            }
        }

        // ========== FUNÇÕES DE PAGINAÇÃO ==========
        function renderizarControlesPaginacao(totalPaginas) {
            // Remover controles anteriores se existirem
            const controlesAnteriores = document.getElementById('paginacaoControles');
            if (controlesAnteriores) {
                controlesAnteriores.remove();
            }
            
            // Se não há necessidade de paginação, não mostrar controles
            if (totalPaginas <= 1) {
                return;
            }
            
            const grid = document.getElementById('coletasGrid');
            if (!grid) return;
            
            // Criar container de paginação
            const paginacaoContainer = document.createElement('div');
            paginacaoContainer.id = 'paginacaoControles';
            paginacaoContainer.style.cssText = `
                grid-column: 1 / -1;
                display: flex;
                justify-content: center;
                align-items: center;
                gap: 0.5rem;
                padding: 2rem 1rem;
                margin-top: 1rem;
                flex-wrap: wrap;
            `;
            
            // Botão Primeira Página
            const btnPrimeira = criarBotaoPaginacao('Primeira', () => irParaPagina(1), paginaAtual === 1);
            btnPrimeira.innerHTML = '<i class="fas fa-angle-double-left"></i> Primeira';
            
            // Botão Anterior
            const btnAnterior = criarBotaoPaginacao('Anterior', () => irParaPagina(paginaAtual - 1), paginaAtual === 1);
            btnAnterior.innerHTML = '<i class="fas fa-angle-left"></i> Anterior';
            
            // Informações da página
            const infoPagina = document.createElement('div');
            infoPagina.style.cssText = `
                padding: 0.6rem 1.2rem;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                border-radius: 8px;
                font-weight: 600;
                font-size: 0.9rem;
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            `;
            const inicio = (paginaAtual - 1) * itensPorPagina + 1;
            const fim = Math.min(paginaAtual * itensPorPagina, coletasFiltradas.length);
            infoPagina.textContent = `Página ${paginaAtual} de ${totalPaginas} (${inicio}-${fim} de ${coletasFiltradas.length})`;
            
            // Botão Próxima
            const btnProxima = criarBotaoPaginacao('Próxima', () => irParaPagina(paginaAtual + 1), paginaAtual === totalPaginas);
            btnProxima.innerHTML = 'Próxima <i class="fas fa-angle-right"></i>';
            
            // Botão Última Página
            const btnUltima = criarBotaoPaginacao('Última', () => irParaPagina(totalPaginas), paginaAtual === totalPaginas);
            btnUltima.innerHTML = 'Última <i class="fas fa-angle-double-right"></i>';
            
            // Adicionar botões ao container
            paginacaoContainer.appendChild(btnPrimeira);
            paginacaoContainer.appendChild(btnAnterior);
            paginacaoContainer.appendChild(infoPagina);
            paginacaoContainer.appendChild(btnProxima);
            paginacaoContainer.appendChild(btnUltima);
            
            // Adicionar após o grid
            grid.parentNode.insertBefore(paginacaoContainer, grid.nextSibling);
        }

        function criarBotaoPaginacao(texto, onClick, desabilitado) {
            const btn = document.createElement('button');
            btn.textContent = texto;
            btn.onclick = onClick;
            btn.disabled = desabilitado;
            btn.style.cssText = `
                padding: 0.6rem 1.2rem;
                border: 1px solid #667eea;
                background: ${desabilitado ? '#f0f0f0' : 'white'};
                color: ${desabilitado ? '#999' : '#667eea'};
                border-radius: 8px;
                cursor: ${desabilitado ? 'not-allowed' : 'pointer'};
                font-weight: 600;
                font-size: 0.9rem;
                transition: all 0.3s;
                display: flex;
                align-items: center;
                gap: 0.3rem;
            `;
            
            if (!desabilitado) {
                btn.onmouseenter = () => {
                    btn.style.background = '#667eea';
                    btn.style.color = 'white';
                    btn.style.transform = 'translateY(-2px)';
                    btn.style.boxShadow = '0 4px 12px rgba(102, 126, 234, 0.3)';
                };
                btn.onmouseleave = () => {
                    btn.style.background = 'white';
                    btn.style.color = '#667eea';
                    btn.style.transform = 'translateY(0)';
                    btn.style.boxShadow = 'none';
                };
            }
            
            return btn;
        }

        function irParaPagina(novaPagina) {
            const totalPaginas = Math.ceil(coletasFiltradas.length / itensPorPagina);
            if (novaPagina < 1 || novaPagina > totalPaginas) {
                return;
            }
            
            paginaAtual = novaPagina;
            
            // Scroll suave para o topo do grid
            const grid = document.getElementById('coletasGrid');
            if (grid) {
                grid.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
            
            // Re-renderizar com a nova página
            renderColetasWrapper();
        }

        function createColetaCard(coleta) {
            const card = document.createElement('div');
            // Adicionar classe 'urgente' se a prioridade for urgente
            const classeUrgente = (coleta.prioridade === 'urgente') ? 'urgente' : '';
            card.className = `coleta-card ${coleta.status} ${classeUrgente} collapsed`.trim();
            card.setAttribute('data-coleta-id', coleta.id);
            card.onclick = () => openEditColetaModal(coleta.id);

            const progresso = calcularProgressoEtapas(coleta);
            
            card.innerHTML = `
                <button class="card-toggle" onclick="event.stopPropagation(); toggleCardExpand(this);">
                    <i class="fas fa-chevron-down"></i>
                </button>
                
                <div class="card-header">
                    <div class="card-title-section">
                        <h3 class="card-title">${coleta.cliente}</h3>
                        ${coleta.filial && coleta.numero_coleta ? `
                            <div class="card-filial-numero" style="display: flex; align-items: center; gap: 0.5rem; margin-top: 0.3rem; font-size: 0.85rem; color: #667eea; font-weight: 600;">
                                <i class="fas fa-building"></i>
                                <span>${coleta.filial}</span>
                                <span style="color: #999;">|</span>
                                <i class="fas fa-hashtag"></i>
                                <span>Coleta: ${coleta.numero_coleta}</span>
                            </div>
                        ` : ''}
                        </div>
                    <div class="status-section">
                        ${coleta.prioridade === 'urgente' ? `
                        <div class="urgente-badge" style="background: #e74c3c; color: white; padding: 0.35rem 0.75rem; border-radius: 6px; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 0.5rem; box-shadow: 0 2px 4px rgba(231, 76, 60, 0.25); white-space: nowrap; display: inline-flex; align-items: center; gap: 0.3rem;">
                            <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg" style="flex-shrink: 0;">
                                <path d="M6 0L7.5 4.5L12 6L7.5 7.5L6 12L4.5 7.5L0 6L4.5 4.5L6 0Z" fill="currentColor"/>
                            </svg>
                            <span>URGENTE</span>
                        </div>
                        ` : ''}
                        ${coleta.etapa_atual === 'contas_pagar' && coleta.contas_pagar_tipo ? `
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.4rem 0.8rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.4rem; margin-bottom: 0.5rem; box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>Tipo: ${coleta.contas_pagar_tipo}</span>
                        </div>
                        ` : ''}
                        ${coleta.titulo_contrato ? `
                        <div style="background: linear-gradient(135deg, #fd7e14 0%, #ff9500 100%); color: white; padding: 0.4rem 0.8rem; border-radius: 8px; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.4rem; margin-bottom: 0.5rem; box-shadow: 0 2px 6px rgba(253, 126, 20, 0.3); max-width: 100%; word-break: break-word;">
                            <i class="fas fa-file-contract"></i>
                            <span style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${escapeHtml(coleta.titulo_contrato)}">${escapeHtml(coleta.titulo_contrato)}</span>
                        </div>
                        ` : ''}
                        <div class="status-badge status-${coleta.status}">
                            ${getStatusText(coleta.status)}
                        </div>
                        ${coleta.anexos && coleta.anexos.length > 0 ? `
                            <div class="anexos-badge" title="${coleta.anexos.length} documentos anexados" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.3rem 0.7rem; border-radius: 12px; font-size: 0.7rem; display: flex; align-items: center; gap: 0.3rem; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
                                <i class="fas fa-paperclip"></i>
                                ${coleta.anexos.length}
                            </div>
                        ` : ''}
                        <div class="valor-badge">
                            R$ ${(coleta.valor || 0).toFixed(2)}
                        </div>
                    </div>
                </div>

                <!-- Etiquetas no topo (sempre visíveis) -->
                <div class="etiquetas-container-top" style="padding: 0.8rem 1rem; border-bottom: 1px solid rgba(255,255,255,0.2); background: linear-gradient(135deg, rgba(102, 126, 234, 0.08) 0%, rgba(118, 75, 162, 0.08) 100%);">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                        <span style="font-weight: 600; color: #667eea; font-size: 0.85rem;">
                            <i class="fas fa-tags"></i> Etiquetas
                        </span>
                        <button onclick="event.stopPropagation(); event.preventDefault(); abrirModalEtiquetas('${coleta.id}')" 
                                class="btn btn-sm" 
                                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.25rem 0.6rem; border-radius: 6px; border: none; font-size: 0.75rem; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
                            <i class="fas fa-plus"></i> Gerenciar
                        </button>
                    </div>
                    <div id="etiquetas-coleta-${coleta.id}" class="etiquetas-list-top" style="display: flex; flex-wrap: wrap; gap: 0.4rem; min-height: 1.5rem;">
                        ${coleta.etiquetas && coleta.etiquetas.length > 0 
                            ? coleta.etiquetas.map(et => `
                                <span class="badge" style="background: ${et.cor || '#667eea'}; color: white; padding: 0.35rem 0.75rem; border-radius: 6px; font-size: 0.75rem; box-shadow: 0 2px 6px rgba(0,0,0,0.1); display: inline-flex; align-items: center; gap: 0.3rem;">
                                    <i class="fas fa-tag"></i> ${et.nome}
                                </span>
                            `).join('')
                            : '<span style="color: #6c757d; font-size: 0.75rem; font-style: italic;"><i class="fas fa-info-circle"></i> Nenhuma etiqueta</span>'
                        }
                    </div>
                </div>

                <div class="card-details">
                    <div class="card-content">
                    <div class="info-grid">
                        <div class="info-item">
                            <div class="info-label">Origem</div>
                            <div class="info-value">
                                <i class="fas fa-map-marker-alt"></i>
                                ${coleta.origem}
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Destino</div>
                            <div class="info-value">
                                <i class="fas fa-flag-checkered"></i>
                                ${coleta.destino}
                            </div>
                        </div>
                        <div class="info-item" style="grid-column: 1 / -1;">
                            <div class="info-label">Tipos de Veículo</div>
                            <div class="info-value" style="flex-wrap: wrap; gap: 0.3rem;">
                                <i class="fas fa-truck" style="flex-shrink: 0;"></i>
                                <span style="display: flex; flex-wrap: wrap; gap: 0.3rem; flex: 1; min-width: 0; max-width: 100%; box-sizing: border-box;">
                                ${coleta.tipos_veiculo && coleta.tipos_veiculo.length > 0 
                                        ? coleta.tipos_veiculo.map(v => `<span style="display: inline-block; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem; white-space: nowrap; max-width: 100%; box-sizing: border-box;">${v}</span>`).join('')
                                    : '-'}
                                </span>
                            </div>
                        </div>
                        <div class="info-item" style="grid-column: 1 / -1;">
                            <div class="info-label">Tipos de Carroceria</div>
                            <div class="info-value" style="flex-wrap: wrap; gap: 0.3rem;">
                                <i class="fas fa-box" style="flex-shrink: 0;"></i>
                                <span style="display: flex; flex-wrap: wrap; gap: 0.3rem; flex: 1; min-width: 0; max-width: 100%; box-sizing: border-box;">
                                ${(() => {
                                    if (!coleta.tipos_carroceria || coleta.tipos_carroceria.length === 0) return '-';
                                    return coleta.tipos_carroceria.map(c => {
                                        const nomeAmigavel = tiposCarroceriaMap[c] || c;
                                            return `<span style="display: inline-block; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.75rem; white-space: nowrap; max-width: 100%; box-sizing: border-box;">${nomeAmigavel}</span>`;
                                    }).join('');
                                })()}
                                </span>
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">KM</div>
                            <div class="info-value">
                                <i class="fas fa-road"></i>
                                ${coleta.km || '0'} km
                            </div>
                        </div>
                        ${coleta.motorista_id ? `
                        <div class="info-item motorista-card-${coleta.id}" id="motorista-card-wrapper-${coleta.id}" style="grid-column: 1 / -1; background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(32, 201, 151, 0.1) 100%); padding: 0.8rem; border-radius: 10px; border: 1px solid #28a745; transition: all 0.3s;">
                            <div class="info-label motorista-label-${coleta.id}" id="motorista-label-${coleta.id}" style="color: #28a745; font-weight: 700; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                                <span><i class="fas fa-user-check"></i> Motorista Vinculado</span>
                                <div style="display: flex; gap: 0.5rem;">
                                    <button onclick="event.stopPropagation(); solicitarAtivacaoLocalizacao('${coleta.id}')" 
                                            title="Solicitar ao motorista que ative a localização GPS" 
                                            style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 0.4rem; box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3); transition: all 0.2s;" 
                                            onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 10px rgba(102, 126, 234, 0.4)';" 
                                            onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 6px rgba(102, 126, 234, 0.3)';">
                                        <i class="fas fa-map-marker-alt"></i>
                                        Solicitar Localização
                                    </button>
                                    <button onclick="event.stopPropagation(); verDetalhesMotorista('${coleta.id}')" 
                                            title="Ver detalhes do motorista" 
                                            style="background: transparent; color: #28a745; border: 1px solid #28a745; padding: 0.4rem 0.8rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; cursor: pointer; transition: all 0.2s;" 
                                            onmouseover="this.style.background='#28a745'; this.style.color='white';" 
                                            onmouseout="this.style.background='transparent'; this.style.color='#28a745';">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="info-value" id="motorista-info-${coleta.id}" style="color: var(--cinza-escuro); font-weight: 500; display: flex; flex-wrap: wrap; gap: 1rem;">
                                <span><i class="fas fa-spinner fa-spin"></i> Carregando...</span>
                            </div>
                        </div>
                        ` : `
                        <div class="info-item">
                            <div class="info-label">Motorista</div>
                            <div class="info-value" style="color: #6c757d;">
                                <i class="fas fa-user-times"></i>
                                Não vinculado
                            </div>
                        </div>
                        `}
                    </div>

                    <!-- Submenu de Anexos -->
                    <div class="card-submenu anexos-submenu">
                        <div class="submenu-header" onclick="event.stopPropagation(); toggleSubmenu('anexos-${coleta.id}')">
                            <div class="submenu-title">
                                <i class="fas fa-paperclip"></i> Anexos
                                <span class="badge" style="background: rgba(255,255,255,0.3); color: white; margin-left: 0.5rem; font-size: 0.7rem;">
                                    ${coleta.anexos?.length || 0}
                                </span>
                            </div>
                            <i class="fas fa-chevron-down submenu-toggle" id="toggle-anexos-${coleta.id}"></i>
                        </div>
                        <div class="submenu-content" id="anexos-${coleta.id}">
                            <div class="submenu-body">
                                <div class="anexos-actions" style="margin-bottom: 1rem;">
                                    <button class="btn-anexar" onclick="event.stopPropagation(); abrirModalAnexos('${coleta.id}')">
                                        <i class="fas fa-plus"></i> Adicionar Anexo
                                    </button>
                                </div>
                                <div class="anexos-list">
                                    ${(coleta.anexos && coleta.anexos.length > 0) ? 
                                        coleta.anexos.map(anexo => `
                                            <div class="anexo-item">
                                                <div class="anexo-info">
                                                    <div class="anexo-icon ${getFileIconClass(anexo.tipo_arquivo)}">
                                                        <i class="fas ${getFileIcon(anexo.tipo_arquivo)}"></i>
                                                    </div>
                                                    <div class="anexo-details">
                                                        <div class="anexo-nome">${anexo.nome_arquivo}</div>
                                                        <div class="anexo-tamanho">${formatFileSize(anexo.tamanho)}</div>
                                                    </div>
                                                </div>
                                                <div class="anexo-actions">
                                                    <button class="btn-anexo-action btn-anexo-view" onclick="event.stopPropagation(); visualizarAnexo('${anexo.id}')" title="Visualizar">
                                                        <i class="fas fa-eye"></i>
                                                    </button>
                                                    <button class="btn-anexo-action btn-anexo-download" onclick="event.stopPropagation(); downloadAnexoDireto('${anexo.id}')" title="Baixar">
                                <i class="fas fa-download"></i>
                            </button>
                                                    ${currentUser && (currentUser.isAdmin || currentUser.role === 'admin') ? `
                                                    <button class="btn-anexo-action btn-anexo-delete" onclick="event.stopPropagation(); excluirAnexo('${anexo.id}')" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                            ` : ''}
                        </div>
                                            </div>
                                        `).join('') : 
                                        '<div style="text-align: center; color: #6c757d; font-size: 0.8rem; padding: 1rem;">Nenhum anexo adicionado</div>'
                                    }
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Submenu de Histórico -->
                    <div class="card-submenu historico-submenu">
                        <div class="submenu-header">
                            <div class="submenu-title" onclick="event.stopPropagation(); toggleSubmenu('historico-${coleta.id}')">
                                <i class="fas fa-history"></i> Últimas Movimentações
                            </div>
                            <div style="display: flex; gap: 0.5rem; align-items: center;">
                                <button onclick="event.stopPropagation(); abrirModalTrajetoria('${coleta.id}')" 
                                    style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 600; transition: transform 0.2s; display: flex; align-items: center; gap: 0.3rem;" 
                                    onmouseover="this.style.transform='scale(1.05)'" 
                                    onmouseout="this.style.transform='scale(1)'"
                                    title="Ver trajetória completa da coleta">
                                    <i class="fas fa-route"></i> Trajetória
                                </button>
                                <button onclick="event.stopPropagation(); abrirModalHistoricoCompleto('${coleta.id}')" 
                                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 0.3rem 0.6rem; border-radius: 6px; cursor: pointer; font-size: 0.75rem; font-weight: 600; transition: transform 0.2s;" 
                                    onmouseover="this.style.transform='scale(1.05)'" 
                                    onmouseout="this.style.transform='scale(1)'">
                                    <i class="fas fa-eye"></i> Ver Tudo
                                </button>
                                <i class="fas fa-chevron-down submenu-toggle" id="toggle-historico-${coleta.id}" onclick="event.stopPropagation(); toggleSubmenu('historico-${coleta.id}')"></i>
                            </div>
                        </div>
                        <div class="submenu-content" id="historico-${coleta.id}">
                            <div class="submenu-body">
                                <div class="historico-list-card" id="historico-content-${coleta.id}">
                                    <div style="text-align: center; color: #6c757d; padding: 0.5rem; font-size: 0.8rem;">
                                        <i class="fas fa-spinner fa-spin"></i>
                                        Carregando histórico...
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                    <!-- Submenu de ITs Relacionadas -->
                    <div class="card-submenu its-submenu" id="its-submenu-${coleta.id}">
                        <div class="submenu-header">
                            <div class="submenu-title" onclick="event.stopPropagation(); toggleSubmenu('its-${coleta.id}')">
                                <i class="fas fa-file-alt"></i> ITs Relacionadas
                            </div>
                            <i class="fas fa-chevron-down submenu-toggle" id="toggle-its-${coleta.id}" onclick="event.stopPropagation(); toggleSubmenu('its-${coleta.id}')"></i>
                        </div>
                        <div class="submenu-content" id="its-${coleta.id}">
                            <div class="submenu-body">
                                <div id="its-content-${coleta.id}" style="text-align: center; color: #6c757d; padding: 0.5rem; font-size: 0.8rem;">
                                    <i class="fas fa-spinner fa-spin"></i>
                                    Carregando ITs...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                </div>

                <div class="etapas-container">
                    <div class="etapas-header">
                        <div class="etapas-title">
                            <i class="fas fa-project-diagram"></i> Etapas do Processo
                        </div>
                        <div class="progress-text">
                            ${progresso.concluidas}/${progresso.total} etapas
                        </div>
                    </div>
                    <div class="etapas-progress">
                        ${ETAPAS.map(etapa => `
                            <div class="etapa-progress etapa-${etapa.id}" 
                                style="width: ${100/ETAPAS.length}%"
                                title="${etapa.nome}">
                            </div>
                        `).join('')}
                    </div>
                    <div class="etapas-labels">
                        ${ETAPAS.map(etapa => {
                            const isAtiva = coleta.etapa_atual === etapa.id; // Etapa atual
                            const passouPorEla = coleta.etapas_concluidas?.includes(etapa.id) || false; // Passou por esta etapa
                            const jaPassouMasNaoEAtual = passouPorEla && !isAtiva; // Passou mas não é a atual
                            
                            // Lógica: apenas a etapa atual fica verde, as que passou ficam azuis
                            const classe = isAtiva ? 'concluida' : (jaPassouMasNaoEAtual ? 'ativa' : '');
                            const icon = isAtiva ? 'fa-check' : (jaPassouMasNaoEAtual ? 'fa-check' : 'fa-clock');
                            return `
                                <span class="etapa-badge ${classe}">
                                    <i class="fas ${icon}"></i>
                                    ${etapa.nome}
                                </span>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                <!-- Validação para etapa Contratação -->
                ${coleta.etapa_atual === 'contratacao' && !coleta.motorista_id ? `
                    <div class="etapa-validation" id="validation-contratacao-${coleta.id}">
                        <div class="validation-title">
                            <i class="fas fa-exclamation-triangle"></i>
                            Validação Necessária
                        </div>
                        <div class="validation-message">
                            Para avançar da etapa Contratação, é necessário vincular um motorista à coleta.
                        </div>
                        <div class="validation-actions">
                            <button class="btn-validation primary" onclick="event.stopPropagation(); vincularMotorista('${coleta.id}')">
                                <i class="fas fa-user-plus"></i> Vincular Motorista
                            </button>
                            <button class="btn-validation success" onclick="event.stopPropagation(); cadastrarMotorista('${coleta.id}')">
                                <i class="fas fa-user-plus"></i> Cadastrar Novo Motorista
                            </button>
                        </div>
                    </div>
                ` : ''}
                
                <!-- Validação para etapa Finalizar Operação (Canhoto Anexado) -->
                ${coleta.etapa_atual === 'finalizar_operacao' ? `
                    <div class="etapa-validation" id="validation-finalizar-${coleta.id}" style="background: linear-gradient(135deg, rgba(255, 193, 7, 0.1) 0%, rgba(255, 152, 0, 0.1) 100%); border: 2px solid #ffc107;">
                        <div class="validation-title" style="color: #f57c00;">
                            <i class="fas fa-check-circle"></i>
                            Canhoto Anexado - Aguardando Validação
                        </div>
                        <div class="validation-message" style="color: #333;">
                            O motorista anexou o canhoto da entrega. Verifique o documento nos anexos e finalize a operação quando estiver tudo correto.
                            ${coleta.contas_pagar_tipo && coleta.contas_pagar_tipo.includes('saldo') && coleta.contas_pagar_tipo !== 'pagamento_total' && coleta.contas_pagar_tipo !== 'ambos' ? 
                                '<br><br><strong style="color: #f57c00;"><i class="fas fa-exclamation-triangle"></i> ATENÇÃO: Pendência de pagamento do saldo.</strong>' : 
                                ''
                            }
                        </div>
                        <div class="validation-actions">
                            <button class="btn-validation success" onclick="event.stopPropagation(); abrirModalAnexos('${coleta.id}')">
                                <i class="fas fa-paperclip"></i> Ver Anexos
                            </button>
                            <button class="btn-validation primary" onclick="event.stopPropagation(); abrirModalHistoricoCompleto('${coleta.id}')">
                                <i class="fas fa-history"></i> Ver Histórico
                            </button>
                            <button class="btn-validation success" onclick="event.stopPropagation(); abrirModalValidarCanhoto('${coleta.id}')" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; font-weight: 600;">
                                <i class="fas fa-check-circle"></i> Finalizar Operação
                            </button>
                        </div>
                    </div>
                ` : ''}
                
                <!-- Validação para etapa GR -->
                ${isEtapaGR(coleta.etapa_atual) && (coleta.gr_aprovado === null || coleta.gr_aprovado === undefined || coleta.gr_aprovado === false) ? `
                    <div class="etapa-validation" id="validation-gr-${coleta.id}">
                        <div class="validation-title">
                            <i class="fas fa-clipboard-check"></i>
                            Aprovação GR Necessária
                        </div>
                        <div class="validation-message">
                            Usuário com função GR deve aprovar ou reprovar esta coleta para continuar.
                        </div>
                        <div class="validation-actions">
                            <button class="btn-validation success" onclick="event.stopPropagation(); aprovarGR('${coleta.id}')">
                                <i class="fas fa-check"></i> Aprovar
                            </button>
                            <button class="btn-validation danger" onclick="event.stopPropagation(); reprovarGR('${coleta.id}')">
                                <i class="fas fa-times"></i> Reprovar
                            </button>
                            <button class="btn-validation warning" onclick="event.stopPropagation(); solicitarAtualizacaoDocumento('${coleta.id}')" ${!coleta.motorista_id ? 'disabled title="É necessário ter motorista vinculado"' : ''}>
                                <i class="fas fa-file-upload"></i> Solicitar Atualização de Documento
                            </button>
                            <button class="btn-validation primary" onclick="event.stopPropagation(); voltarEtapa('${coleta.id}', 'contratacao')" ${!temPermissaoEtapa(coleta.etapa_atual) ? 'disabled title="Sem permissão para esta etapa"' : ''}>
                                <i class="fas fa-arrow-left"></i> Voltar para Contratação
                            </button>
                        </div>
                    </div>
                ` : ''}

                <!-- Validação para etapa Contas a Pagar -->
                ${coleta.etapa_atual === 'contas_pagar' ? (() => {
                    // Tipo de pagamento selecionado ao mover para contas_pagar
                    const tipoPagamentoSelecionado = coleta.contas_pagar_tipo || null;
                    const tiposEspecificos = ['GNRE', 'PEDÁGIO', 'GNRE + PEDÁGIO', 'ADIANTAMENTO', 'SALDO', 'PAGAMENTO DE FRETE TOTAL'];
                    const tiposGenericos = ['adiantamento', 'saldo', 'pagamento_total', 'ambos'];
                    // Verificar se é um tipo específico (comparação exata ou parcial para "GNRE + PEDÁGIO")
                    const isTipoEspecifico = tipoPagamentoSelecionado && (
                        tiposEspecificos.some(t => tipoPagamentoSelecionado.trim() === t.trim()) ||
                        (tipoPagamentoSelecionado.includes('GNRE') && tipoPagamentoSelecionado.includes('PEDÁGIO'))
                    );
                    const isTipoGenerico = tipoPagamentoSelecionado && tiposGenericos.includes(tipoPagamentoSelecionado.toLowerCase());
                    
                    // Verificar se já foi marcado como pago
                    const tipoPagamentoPago = coleta.contas_pagar_pago === true;
                    
                    // Verificar tipos genéricos (quando foi marcado como pago usando tipos genéricos)
                    const tipoPagoGenerico = isTipoGenerico ? tipoPagamentoSelecionado : null;
                    const adiantamentoPago = tipoPagoGenerico === 'adiantamento' || tipoPagoGenerico === 'pagamento_total' || tipoPagoGenerico === 'ambos';
                    const saldoPago = tipoPagoGenerico === 'saldo' || tipoPagoGenerico === 'pagamento_total' || tipoPagoGenerico === 'ambos';
                    const pagamentoTotalPago = tipoPagoGenerico === 'pagamento_total';
                    const ambosPagos = tipoPagoGenerico === 'ambos';
                    
                    // Badge com o tipo de pagamento selecionado (sempre visível)
                    const tipoPagamentoBadge = tipoPagamentoSelecionado ? `
                        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.6rem 1rem; border-radius: 12px; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem; font-weight: 600; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
                            <i class="fas fa-money-bill-wave"></i>
                            <span>Tipo de Pagamento: <strong>${tipoPagamentoSelecionado}</strong></span>
                        </div>
                    ` : '';
                    
                    // Se já foi marcado como pago, mostrar mensagem de sucesso
                    if (tipoPagamentoPago) {
                        return `
                            <div class="etapa-validation" style="background: linear-gradient(135deg, rgba(40, 167, 69, 0.1) 0%, rgba(32, 201, 151, 0.1) 100%); border: 1px solid #28a745;">
                                ${tipoPagamentoBadge}
                                <div class="validation-title" style="color: #28a745;">
                                    <i class="fas fa-check-circle"></i>
                                    Pagamento Realizado
                                </div>
                                <div class="validation-message" style="color: #155724;">
                                    ✅ ${tipoPagamentoSelecionado || 'Pagamento'} marcado como realizado em ${coleta.contas_pagar_data ? new Date(coleta.contas_pagar_data).toLocaleString('pt-BR') : 'data não informada'} por ${coleta.contas_pagar_pago_por || 'Usuário Desconhecido'}.
                                </div>
                            </div>
                        `;
                    }
                    
                    // Se algum pagamento genérico foi realizado (mas não completo), mostrar status e opções pendentes
                    if (tipoPagoGenerico && tipoPagamentoPago && (adiantamentoPago || saldoPago) && !pagamentoTotalPago && !ambosPagos) {
                        const botoesPendentes = [];
                        
                        if (!adiantamentoPago) {
                            botoesPendentes.push(`
                                <button class="btn-validation success" onclick="event.stopPropagation(); marcarComoPago('${coleta.id}', 'adiantamento')" ${!coleta.motorista_id ? 'disabled title="É necessário ter motorista vinculado"' : !temPermissaoEtapa('contas_pagar') ? 'disabled title="Sem permissão para esta etapa"' : ''} style="flex: 1; min-width: 180px;">
                                    <i class="fas fa-money-bill-wave"></i> Adiantamento de Frete
                                </button>
                            `);
                        }
                        
                        if (!saldoPago) {
                            botoesPendentes.push(`
                                <button class="btn-validation success" onclick="event.stopPropagation(); marcarComoPago('${coleta.id}', 'saldo')" ${!coleta.motorista_id ? 'disabled title="É necessário ter motorista vinculado"' : !temPermissaoEtapa('contas_pagar') ? 'disabled title="Sem permissão para esta etapa"' : ''} style="flex: 1; min-width: 180px;">
                                    <i class="fas fa-wallet"></i> Saldo
                                </button>
                            `);
                        }
                        
                        if (!pagamentoTotalPago) {
                            botoesPendentes.push(`
                                <button class="btn-validation success" onclick="event.stopPropagation(); marcarComoPago('${coleta.id}', 'pagamento_total')" ${!coleta.motorista_id ? 'disabled title="É necessário ter motorista vinculado"' : !temPermissaoEtapa('contas_pagar') ? 'disabled title="Sem permissão para esta etapa"' : ''} style="flex: 1; min-width: 180px;">
                                    <i class="fas fa-credit-card"></i> Pagamento Total
                                </button>
                            `);
                        }
                        
                        return `
                    <div class="etapa-validation" id="validation-contas_pagar-${coleta.id}">
                                ${tipoPagamentoBadge}
                        <div class="validation-title">
                            <i class="fas fa-money-check-alt"></i>
                                    ${tipoPagoGenerico === 'adiantamento' ? '💵 Adiantamento Pago - Pendente: Saldo' : tipoPagoGenerico === 'saldo' ? '💰 Saldo Pago - Pendente: Adiantamento' : 'Pagamentos'}
                        </div>
                        <div class="validation-message">
                                    ${tipoPagoGenerico ? `${tipoPagoGenerico === 'adiantamento' ? '💵 Adiantamento' : tipoPagoGenerico === 'saldo' ? '💰 Saldo' : '✅ Pagamento'} marcado como realizado em ${coleta.contas_pagar_data ? new Date(coleta.contas_pagar_data).toLocaleString('pt-BR') : 'data não informada'} por ${coleta.contas_pagar_pago_por || 'Usuário Desconhecido'}.<br><br>` : ''}
                                    ${botoesPendentes.length > 0 ? 'Marque os pagamentos pendentes como realizados. O motorista e o criador da oportunidade serão notificados.' : ''}
                        </div>
                                ${botoesPendentes.length > 0 ? `
                                    <div class="validation-actions" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 1rem;">
                                        ${botoesPendentes.join('')}
                                    </div>
                                ` : ''}
                            </div>
                        `;
                    }
                    
                    // Se nenhum pagamento foi realizado, mostrar APENAS o tipo selecionado
                    const botoesPagamento = [];
                    
                    // SEMPRE mostrar APENAS o tipo selecionado quando o usuário moveu para contas_pagar
                    // Não mostrar opções genéricas se já foi selecionado um tipo específico
                    if (tipoPagamentoSelecionado && !isTipoGenerico) {
                        // Mostrar APENAS o tipo específico selecionado
                        botoesPagamento.push(`
                            <button class="btn-validation success" onclick="event.stopPropagation(); marcarTipoPagamentoEspecifico('${coleta.id}', '${String(tipoPagamentoSelecionado).replace(/'/g, "\\'").replace(/"/g, '&quot;')}')" ${!coleta.motorista_id ? 'disabled title="É necessário ter motorista vinculado"' : !temPermissaoEtapa('contas_pagar') ? 'disabled title="Sem permissão para esta etapa"' : ''} style="flex: 1; min-width: 200px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); font-weight: 600; font-size: 0.95rem;">
                                <i class="${getIconeTipoPagamento(tipoPagamentoSelecionado)}"></i> 
                                Marcar ${tipoPagamentoSelecionado} como Pago
                            </button>
                        `);
                    } else if (!tipoPagamentoSelecionado || isTipoGenerico) {
                        // Se não há tipo selecionado OU é um tipo genérico antigo, mostrar opções genéricas
                        botoesPagamento.push(`
                            <button class="btn-validation success" onclick="event.stopPropagation(); marcarComoPago('${coleta.id}', 'adiantamento')" ${!coleta.motorista_id ? 'disabled title="É necessário ter motorista vinculado"' : !temPermissaoEtapa('contas_pagar') ? 'disabled title="Sem permissão para esta etapa"' : ''} style="flex: 1; min-width: 180px;">
                                <i class="fas fa-money-bill-wave"></i> Adiantamento de Frete
                            </button>
                        `);
                        botoesPagamento.push(`
                            <button class="btn-validation success" onclick="event.stopPropagation(); marcarComoPago('${coleta.id}', 'saldo')" ${!coleta.motorista_id ? 'disabled title="É necessário ter motorista vinculado"' : !temPermissaoEtapa('contas_pagar') ? 'disabled title="Sem permissão para esta etapa"' : ''} style="flex: 1; min-width: 180px;">
                                <i class="fas fa-wallet"></i> Saldo
                            </button>
                        `);
                        botoesPagamento.push(`
                            <button class="btn-validation success" onclick="event.stopPropagation(); marcarComoPago('${coleta.id}', 'pagamento_total')" ${!coleta.motorista_id ? 'disabled title="É necessário ter motorista vinculado"' : !temPermissaoEtapa('contas_pagar') ? 'disabled title="Sem permissão para esta etapa"' : ''} style="flex: 1; min-width: 180px;">
                                <i class="fas fa-credit-card"></i> Pagamento Total
                            </button>
                        `);
                    }
                    
                    return `
                    <div class="etapa-validation" id="validation-contas_pagar-${coleta.id}">
                        ${tipoPagamentoBadge}
                        <div class="validation-title">
                            <i class="fas fa-money-check-alt"></i>
                            Marcar como Pago
                        </div>
                        <div class="validation-message">
                            ${tipoPagamentoSelecionado 
                                ? `Tipo de pagamento selecionado: <strong>${tipoPagamentoSelecionado}</strong>. Marque como pago quando o pagamento for realizado. O motorista e o criador da oportunidade serão notificados.`
                                : 'Selecione o tipo de pagamento realizado. O motorista e o criador da oportunidade serão notificados.'
                            }
                    </div>
                        <div class="validation-actions" style="display: flex; gap: 10px; flex-wrap: wrap;">
                            ${botoesPagamento.join('')}
                        </div>
                        </div>
                    `;
                })() : ''}

                <div class="card-footer">
                    <div class="card-actions">
                        <button class="action-btn chat" onclick="event.stopPropagation(); openChatModal('${coleta.id}')">
                            <i class="fas fa-comment"></i> Chat
                        </button>
                        <button class="action-btn secondary" onclick="event.stopPropagation(); openMoverEtapaModal('${coleta.id}')" ${!temPermissaoEtapa(coleta.etapa_atual) ? 'disabled title="Sem permissão para esta etapa"' : coleta.etapa_atual === 'contratacao' && !coleta.motorista_id ? 'disabled title="É necessário vincular um motorista para mover da etapa Contratação"' : ''}>
                            <i class="fas fa-arrows-alt-h"></i> Mover Etapa
                        </button>
                        <button class="action-btn primary" onclick="event.stopPropagation(); avancarEtapa('${coleta.id}')" ${coleta.etapa_atual === 'finalizar_operacao' ? 'disabled title="Use os botões Ganhou/Perdeu para finalizar"' : coleta.etapa_atual === 'contratacao' && !coleta.motorista_id ? 'disabled' : isEtapaGR(coleta.etapa_atual) && !coleta.gr_aprovado ? 'disabled' : !temPermissaoEtapa(coleta.etapa_atual) ? 'disabled title="Sem permissão para esta etapa"' : ''}>
                            <i class="fas fa-arrow-right"></i> Avançar
                        </button>
                        <button class="action-btn warning" onclick="event.stopPropagation(); openEditColetaModal('${coleta.id}')" ${!temPermissaoEtapa(coleta.etapa_atual) ? 'disabled title="Sem permissão para esta etapa"' : ''}>
                            <i class="fas fa-edit"></i> Editar
                        </button>
                        ${currentUser && (currentUser.isAdmin || currentUser.role === 'admin') ? `
                        <button class="action-btn danger" onclick="event.stopPropagation(); excluirColeta('${coleta.id}')">
                            <i class="fas fa-trash"></i> Excluir
                        </button>
                        ` : ''}
                        ${coleta.etapa_atual === 'finalizar_operacao' ? `
                            <button class="action-btn success" onclick="event.stopPropagation(); finalizarOperacao('${coleta.id}')" title="Finalizar operação — só conclui se houver canhoto anexado; em seguida envia ao histórico" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); box-shadow: 0 4px 20px rgba(40, 167, 69, 0.5); font-weight: 700; border: 2px solid #1e7e34; font-size: 0.95rem; padding: 0.8rem 1.5rem; animation: pulse-success 2s infinite;">
                                <i class="fas fa-flag-checkered"></i> Finalizar Operação
                            </button>
                            <button class="action-btn danger" onclick="event.stopPropagation(); finalizarColeta('${coleta.id}', 'perdeu')" title="Perder Oportunidade — Marcar coleta como cancelada" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); box-shadow: 0 4px 20px rgba(220, 53, 69, 0.5); font-weight: 700; border: 2px solid #bd2130; font-size: 0.95rem; padding: 0.8rem 1.5rem;">
                                <i class="fas fa-times-circle"></i> Perder Oportunidade
                            </button>
                        ` : ''}
                    </div>
                    <div class="card-date" style="display: flex; flex-direction: column; gap: 0.3rem;">
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-calendar"></i>
                            <span><strong>Data de Coleta:</strong> ${formatarData(coleta.data_recebimento)}</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                            <i class="fas fa-calendar-check"></i>
                            <span><strong>Data de Entrega:</strong> ${coleta.data_entrega ? formatarData(coleta.data_entrega) : 'Não informada'}</span>
                        </div>
                    </div>
                </div>
            `;

            // Carrega o histórico para este card
            carregarHistoricoParaCard(coleta.id);
            
            // Atualizar cores da barra de progresso
            setTimeout(() => {
                ETAPAS.forEach((etapa, index) => {
                    const progressBar = card.querySelector(`.etapa-${etapa.id}`);
                    if (coleta.etapas_concluidas?.includes(etapa.id)) {
                        progressBar.style.opacity = '1';
                    } else if (coleta.etapa_atual === etapa.id) {
                        progressBar.style.opacity = '0.8';
                    } else {
                        progressBar.style.opacity = '0.2';
                    }
                });
            }, 100);

            return card;
        }

        // ========== MODAIS ==========
        // Função global para abrir modal de nova coleta (chamada do HTML)
        // Redefinir com implementação completa (já foi definida no início do script)
        function openNewColetaModal() {
            currentEditingId = null;
            modoCriacaoLote = false; // Resetar para modo único
            
            const modalTitleEl = document.getElementById('modalTitle');
            const coletaFormEl = document.getElementById('coletaForm');
            const dataRecebimentoEl = document.getElementById('dataRecebimento');
            const statusEl = document.getElementById('status');
            const prioridadeEl = document.getElementById('prioridade');
            const etapaAtualEl = document.getElementById('etapaAtual');
            
            if (modalTitleEl) modalTitleEl.textContent = 'Nova Coleta';
            if (coletaFormEl) coletaFormEl.reset();
            if (dataRecebimentoEl) dataRecebimentoEl.valueAsDate = new Date();
            if (statusEl) statusEl.value = 'pendente';
            if (prioridadeEl) prioridadeEl.value = 'normal';
            if (etapaAtualEl) etapaAtualEl.value = 'comercial';
            
            // ✅ Desabilitar campo de prioridade na criação para usuários comuns
            // Apenas admin ou coordenador (manager) podem escolher prioridade na criação
            const prioridadeSelect = document.getElementById('prioridade');
            const isAdminOrManager = currentUser && (currentUser.isAdmin || currentUser.role === 'admin' || currentUser.role === 'manager');
            
            if (prioridadeSelect) {
                if (!isAdminOrManager) {
                    // Usuários comuns: desabilitar e garantir que seja "normal"
                    prioridadeSelect.disabled = true;
                    prioridadeSelect.value = 'normal';
                    prioridadeSelect.title = 'Prioridade inicial sempre será Normal. Apenas coordenadores e administradores podem definir outras prioridades.';
                } else {
                    // Admin/Coordenador: habilitar e mostrar todas as opções
                    prioridadeSelect.disabled = false;
                    prioridadeSelect.title = '';
                    const prioridadeUrgenteOption = document.getElementById('prioridadeUrgenteOption');
                    if (prioridadeUrgenteOption) {
                        prioridadeUrgenteOption.style.display = 'block';
                    }
                }
            }
            document.getElementById('filial').value = ''; // Não preencher automaticamente, obrigar seleção
            
            // Desmarcar checkbox de diária
            const diariaCheckbox = document.getElementById('diaria');
            if (diariaCheckbox) {
                diariaCheckbox.checked = false;
                toggleCamposObrigatorios(); // Atualizar campos obrigatórios
            }
            document.getElementById('numeroColeta').value = ''; // Limpar número da coleta
            // Limpar classe de veículo e atualizar tipos
            const classeSelect = document.getElementById('classeVeiculo');
            if (classeSelect) {
                classeSelect.value = '';
                atualizarTiposVeiculoECarroceria();
            }
            
            // Resetar modo de criação (mostrar campo único, esconder múltiplos)
            const grupoNumero = document.getElementById('grupoNumeroColeta');
            const grupoMultiplos = document.getElementById('grupoMultiplosNumeros');
            const inputNumero = document.getElementById('numeroColeta');
            const textareaMultiplos = document.getElementById('multiplosNumeros');
            const previewNumeros = document.getElementById('previewNumeros');
            const modoTexto = document.getElementById('modoTexto');
            
            grupoNumero.style.display = 'block';
            grupoMultiplos.style.display = 'none';
            inputNumero.setAttribute('required', 'required');
            textareaMultiplos.removeAttribute('required');
            modoTexto.innerHTML = '<i class="fas fa-layer-group"></i> Criar Múltiplas';
            previewNumeros.style.display = 'none';
            textareaMultiplos.value = '';
            
            // Mostrar botão de alternar modo ao criar nova coleta
            const toggleModoLote = document.getElementById('toggleModoLote');
            if (toggleModoLote) toggleModoLote.style.display = 'block';
            
            // Limpar e desabilitar campo cliente
            const clienteSelect = document.getElementById('cliente');
            clienteSelect.innerHTML = '<option value="">Selecione primeiro a filial</option>';
            clienteSelect.disabled = true;
            
            // Limpar checkboxes de tipos de veículo e carroceria
            document.querySelectorAll('input[name="tiposVeiculo"]').forEach(checkbox => checkbox.checked = false);
            document.querySelectorAll('input[name="tiposCarroceria"]').forEach(checkbox => checkbox.checked = false);
            
            // Garantir que os campos sejam obrigatórios ao abrir (se não for diária)
            toggleCamposObrigatorios();
            
            document.getElementById('coletaModal').classList.add('active');
        }
        
        // Salvar implementação completa e atualizar stub
        window._openNewColetaModalImpl = openNewColetaModal;
        window.openNewColetaModal = openNewColetaModal;

        // Função para alternar campos obrigatórios baseado no checkbox "Diária"
        function toggleCamposObrigatorios() {
            const diariaCheckbox = document.getElementById('diaria');
            const isDiaria = diariaCheckbox?.checked || false;
            
            // Lista de campos obrigatórios (ids e seus labels correspondentes)
            const camposObrigatorios = [
                { id: 'filial', labelText: 'Filial' },
                { id: 'numeroColeta', labelText: 'Nº da Coleta' },
                { id: 'cliente', labelText: 'Cliente' },
                { id: 'dataRecebimento', labelText: 'Data de Coleta' },
                { id: 'dataEntrega', labelText: 'Data de Entrega' },
                { id: 'origem', labelText: 'Origem' },
                { id: 'destino', labelText: 'Destino' },
                { id: 'valor', labelText: 'Valor CTE (R$)' },
                { id: 'freteMotorista', labelText: 'Frete Motorista (R$)' },
                { id: 'km', labelText: 'KM' },
                { id: 'classeVeiculo', labelText: 'Classe do Veículo' }
            ];
            
            camposObrigatorios.forEach(campo => {
                const input = document.getElementById(campo.id);
                const label = document.querySelector(`label[for="${campo.id}"]`);
                
                if (input && label) {
                    if (isDiaria) {
                        // Remover obrigatoriedade
                        input.removeAttribute('required');
                        input.removeAttribute('aria-required');
                        // Remover asterisco e classe do label
                        label.classList.remove('required');
                        // Remover asterisco do texto (qualquer formato)
                        let labelText = label.innerHTML;
                        labelText = labelText.replace(/\s*\*\s*$/, ''); // Remove asterisco no final
                        labelText = labelText.replace(/\s*\*\s*</, ' <'); // Remove asterisco antes de tag
                        labelText = labelText.replace(/\s*\*\s*/, ' '); // Remove asterisco no meio
                        label.innerHTML = labelText;
                    } else {
                        // Adicionar obrigatoriedade
                        input.setAttribute('required', 'required');
                        input.setAttribute('aria-required', 'true');
                        // Adicionar classe required ao label
                        label.classList.add('required');
                        // Garantir que o asterisco esteja presente
                        let labelText = label.innerHTML;
                        // Verificar se já tem asterisco (em qualquer formato)
                        if (!labelText.includes('*') && !labelText.includes('required-asterisk')) {
                            // Adicionar asterisco no final do texto do label
                            // Se o label tem HTML (como ícones), adicionar após o último texto
                            if (labelText.includes('<')) {
                                // Se tem HTML, adicionar antes do fechamento da tag ou no final
                                labelText = labelText.replace(/([^>])(<\/label>|$)/, '$1 <span class="required-asterisk">*</span>$2');
                            } else {
                                // Se não tem HTML, adicionar no final
                                labelText = labelText + ' <span class="required-asterisk">*</span>';
                            }
                            label.innerHTML = labelText;
                        } else if (labelText.includes('*') && !labelText.includes('required-asterisk')) {
                            // Se já tem asterisco mas não tem a classe, converter para o formato estilizado
                            // Remover asterisco simples e adicionar o estilizado
                            labelText = labelText.replace(/\s*\*\s*$/, ' <span class="required-asterisk">*</span>');
                            labelText = labelText.replace(/\s*\*\s*</, ' <span class="required-asterisk">*</span> <');
                            labelText = labelText.replace(/\s*\*\s*/, ' <span class="required-asterisk">*</span> ');
                            if (!labelText.includes('required-asterisk')) {
                                labelText = labelText + ' <span class="required-asterisk">*</span>';
                            }
                            label.innerHTML = labelText;
                        }
                    }
                }
            });
            
            // Tratar campo de múltiplos números separadamente
            const multiplosNumeros = document.getElementById('multiplosNumeros');
            const labelMultiplos = document.querySelector('label[for="multiplosNumeros"]');
            if (multiplosNumeros && labelMultiplos) {
                if (isDiaria) {
                    multiplosNumeros.removeAttribute('required');
                    labelMultiplos.classList.remove('required');
                    let labelText = labelMultiplos.innerHTML;
                    labelText = labelText.replace(/\s*\*\s*$/, '');
                    labelText = labelText.replace(/\s*<span class="required-asterisk">\*<\/span>\s*/g, '');
                    labelMultiplos.innerHTML = labelText;
                } else {
                    // Só adicionar required se estiver em modo lote
                    if (modoCriacaoLote) {
                        multiplosNumeros.setAttribute('required', 'required');
                        labelMultiplos.classList.add('required');
                        if (!labelMultiplos.innerHTML.includes('*') && !labelMultiplos.innerHTML.includes('required-asterisk')) {
                            let labelText = labelMultiplos.innerHTML;
                            // Adicionar asterisco após "Números das Coletas"
                            labelText = labelText.replace(/(Números das Coletas)/, '$1 <span class="required-asterisk">*</span>');
                            labelMultiplos.innerHTML = labelText;
                        }
                    }
                }
            }
            
            // Tratar labels de Tipos de Veículo e Carroceria (que não têm for attribute, mas têm ícones)
            const labelsFullWidth = document.querySelectorAll('.form-group.full-width label');
            labelsFullWidth.forEach(label => {
                const labelText = label.innerHTML;
                const isTiposVeiculo = labelText.includes('fa-truck') || labelText.includes('Tipos de Veículo');
                const isTiposCarroceria = labelText.includes('fa-box') || labelText.includes('Tipos de Carroceria');
                
                if (isTiposVeiculo || isTiposCarroceria) {
                    if (isDiaria) {
                        label.classList.remove('required');
                        let text = label.innerHTML;
                        text = text.replace(/\s*\*\s*$/, '');
                        text = text.replace(/\s*<span class="required-asterisk">\*<\/span>\s*/g, '');
                        label.innerHTML = text;
                    } else {
                        label.classList.add('required');
                        if (!label.innerHTML.includes('*') && !label.innerHTML.includes('required-asterisk')) {
                            let text = label.innerHTML;
                            text = text + ' <span class="required-asterisk">*</span>';
                            label.innerHTML = text;
                        }
                    }
                }
            });
        }
        
        // Expor função globalmente
        window.toggleCamposObrigatorios = toggleCamposObrigatorios;

        async function openEditColetaModal(coletaId) {
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta) return;

            // 🔐 Verificar permissão para a etapa atual (mas permitir visualização)
            const temPermissao = temPermissaoEtapa(coleta.etapa_atual);
            
            // Não bloquear abertura do modal - apenas desabilitar edição se não tiver permissão
            // O modal será aberto em modo "somente leitura" se não tiver permissão

            currentEditingId = coletaId;
            
            // Desabilitar modo lote ao editar (sempre editar uma coleta por vez)
            modoCriacaoLote = false;
            const grupoNumero = document.getElementById('grupoNumeroColeta');
            const grupoMultiplos = document.getElementById('grupoMultiplosNumeros');
            const toggleModoLote = document.getElementById('toggleModoLote');
            if (grupoNumero) grupoNumero.style.display = 'block';
            if (grupoMultiplos) grupoMultiplos.style.display = 'none';
            if (toggleModoLote) toggleModoLote.style.display = 'none'; // Esconder botão de alternar modo ao editar
            
            // Definir título do modal de forma amigável
            let tituloModal = 'Editar Coleta';
            if (coleta.filial && coleta.numero_coleta) {
                tituloModal = `Editar Coleta - ${coleta.filial} #${coleta.numero_coleta}`;
            } else if (coleta.cliente) {
                tituloModal = `Editar Coleta - ${coleta.cliente}`;
            }
            document.getElementById('modalTitle').textContent = tituloModal;
            
            // Preencher formulário
            document.getElementById('filial').value = coleta.filial || '';
            document.getElementById('numeroColeta').value = coleta.numero_coleta || '';
            
            // Filtrar clientes baseado na filial e depois selecionar o cliente
            // Carregar clientes da filial
            await filtrarClientesPorFilial();
            
            // Aguardar um pouco para garantir que as opções foram carregadas antes de selecionar
            setTimeout(() => {
                const clienteSelect = document.getElementById('cliente');
                clienteSelect.value = coleta.cliente || '';
                
                // Se houver cliente selecionado, preencher origem e destino
                if (coleta.cliente) {
                    preencherOrigemDestino();
                }
            }, 500);
            
            // Converter data_recebimento (timestamp) para formato de input date (YYYY-MM-DD)
            let dataRecebimentoValue = '';
            if (coleta.data_recebimento) {
                const data = new Date(coleta.data_recebimento);
                const ano = data.getFullYear();
                const mes = String(data.getMonth() + 1).padStart(2, '0');
                const dia = String(data.getDate()).padStart(2, '0');
                dataRecebimentoValue = `${ano}-${mes}-${dia}`;
            }
            document.getElementById('dataRecebimento').value = dataRecebimentoValue;
            
            // Converter data_entrega (timestamp) para formato de input date (YYYY-MM-DD)
            let dataEntregaValue = '';
            if (coleta.data_entrega) {
                const data = new Date(coleta.data_entrega);
                const ano = data.getFullYear();
                const mes = String(data.getMonth() + 1).padStart(2, '0');
                const dia = String(data.getDate()).padStart(2, '0');
                dataEntregaValue = `${ano}-${mes}-${dia}`;
            }
            document.getElementById('dataEntrega').value = dataEntregaValue;
            
            // Preencher origem e destino (agora são selects)
            const origemSelect = document.getElementById('origem');
            const destinoSelect = document.getElementById('destino');
            
            // Se já tiver origem/destino cadastrados, tentar encontrar nas opções ou criar nova
            if (coleta.origem) {
                origemSelect.disabled = false;
                // Verificar se já existe a opção
                const origemExists = Array.from(origemSelect.options).some(opt => opt.value === coleta.origem);
                if (!origemExists && origemSelect.options.length === 1) {
                    // Criar nova opção se não existir
                    const option = document.createElement('option');
                    option.value = coleta.origem;
                    option.textContent = coleta.origem;
                    origemSelect.appendChild(option);
                }
                origemSelect.value = coleta.origem;
            }
            
            if (coleta.destino) {
                destinoSelect.disabled = false;
                // Verificar se já existe a opção
                const destinoExists = Array.from(destinoSelect.options).some(opt => opt.value === coleta.destino);
                if (!destinoExists && destinoSelect.options.length === 1) {
                    // Criar nova opção se não existir
                    const option = document.createElement('option');
                    option.value = coleta.destino;
                    option.textContent = coleta.destino;
                    destinoSelect.appendChild(option);
                }
                destinoSelect.value = coleta.destino;
            }
            
            // Preencher tipo de produto e código da tabela
            const tipoProdutoSelect = document.getElementById('tipoProduto');
            const codigoTabelaInput = document.getElementById('codigoTabela');
            
            if (tipoProdutoSelect) {
                // Se já tiver tipo de produto cadastrado, tentar encontrar nas opções ou criar nova
                if (coleta.tipo_produto || coleta.tipoProduto) {
                    tipoProdutoSelect.disabled = false;
                    const tipoProdutoValue = coleta.tipo_produto || coleta.tipoProduto;
                    const tipoProdutoExists = Array.from(tipoProdutoSelect.options).some(opt => opt.value === tipoProdutoValue);
                    if (!tipoProdutoExists && tipoProdutoSelect.options.length === 1) {
                        // Criar nova opção se não existir
                        const option = document.createElement('option');
                        option.value = tipoProdutoValue;
                        option.textContent = tipoProdutoValue;
                        tipoProdutoSelect.appendChild(option);
                    }
                    tipoProdutoSelect.value = tipoProdutoValue;
                }
            }
            
            if (codigoTabelaInput) {
                codigoTabelaInput.value = coleta.codigo_tabela || coleta.codigoTabela || '';
            }
            
            document.getElementById('valor').value = coleta.valor || '';
            document.getElementById('freteMotorista').value = coleta.frete_motorista || '';
            document.getElementById('km').value = coleta.km || '';
            
            // Preencher checkboxes de tipos de veículo
            const checkboxesVeiculo = document.querySelectorAll('input[name="tiposVeiculo"]');
            checkboxesVeiculo.forEach(checkbox => {
                checkbox.checked = coleta.tipos_veiculo && coleta.tipos_veiculo.includes(checkbox.value);
            });
            
            // Preencher checkboxes de tipos de carroceria
            const checkboxesCarroceria = document.querySelectorAll('input[name="tiposCarroceria"]');
            checkboxesCarroceria.forEach(checkbox => {
                checkbox.checked = coleta.tipos_carroceria && coleta.tipos_carroceria.includes(checkbox.value);
            });
            
            document.getElementById('status').value = coleta.status || 'pendente';
            // ✅ Na edição: apenas admin ou coordenador (manager) podem alterar prioridade
            const prioridadeSelect = document.getElementById('prioridade');
            const isAdminOrManager = currentUser && (currentUser.isAdmin || currentUser.role === 'admin' || currentUser.role === 'manager');
            
            if (prioridadeSelect) {
                // Sempre mostrar todas as opções na edição (admin/coordenador pode alterar)
                const prioridadeUrgenteOption = document.getElementById('prioridadeUrgenteOption');
                if (prioridadeUrgenteOption) {
                    prioridadeUrgenteOption.style.display = isAdminOrManager ? 'block' : 'none';
                }
                
                // Desabilitar campo se não for admin/coordenador
                if (!isAdminOrManager) {
                    prioridadeSelect.disabled = true;
                    prioridadeSelect.title = 'Apenas coordenadores e administradores podem alterar a prioridade manualmente. O sistema pode elevar automaticamente baseado no tempo.';
                } else {
                    prioridadeSelect.disabled = false;
                    prioridadeSelect.title = '';
                }
            }
            
            document.getElementById('prioridade').value = coleta.prioridade || 'normal';
            document.getElementById('etapaAtual').value = coleta.etapa_atual || 'comercial';
            document.getElementById('observacoes').value = coleta.observacoes || '';
            
            // Preencher checkbox de diária
            const diariaCheckbox = document.getElementById('diaria');
            if (diariaCheckbox) {
                diariaCheckbox.checked = coleta.diaria === true || coleta.diaria === 'true' || coleta.diaria === 1;
            }
            
            // 🔐 Desabilitar campo de etapa se não tiver permissão
            const etapaSelect = document.getElementById('etapaAtual');
            etapaSelect.disabled = true; // Sempre desabilitar mudança de etapa no modal (use os botões Avançar/Voltar)
            etapaSelect.title = 'Use os botões Avançar/Voltar para mudar a etapa';
            
            // 🔐 Desabilitar campos de edição se não tiver permissão (modo somente leitura)
            const camposEditaveis = ['filial', 'numeroColeta', 'cliente', 'dataRecebimento', 'dataEntrega', 
                                     'origem', 'destino', 'valor', 'km', 'status', 'prioridade', 'observacoes'];
            const botaoSalvar = document.querySelector('#coletaForm button[type="submit"]');
            
            if (!temPermissao) {
                // Modo somente leitura - desabilitar todos os campos
                camposEditaveis.forEach(campoId => {
                    const campo = document.getElementById(campoId);
                    if (campo) {
                        campo.disabled = true;
                        campo.readOnly = true;
                    }
                });
                
                // Desabilitar checkboxes
                document.querySelectorAll('input[name="tiposVeiculo"], input[name="tiposCarroceria"]').forEach(cb => {
                    cb.disabled = true;
                });
                
                // Desabilitar botão salvar
                if (botaoSalvar) {
                    botaoSalvar.disabled = true;
                    botaoSalvar.title = 'Você não tem permissão para editar coletas nesta etapa';
                    botaoSalvar.style.opacity = '0.5';
                    botaoSalvar.style.cursor = 'not-allowed';
                }
                
                // Atualizar título do modal
                document.getElementById('modalTitle').textContent = tituloModal.replace('Editar', 'Visualizar');
            } else {
                // Modo edição - habilitar todos os campos
                camposEditaveis.forEach(campoId => {
                    const campo = document.getElementById(campoId);
                    if (campo) {
                        campo.disabled = false;
                        campo.readOnly = false;
                    }
                });
                
                document.querySelectorAll('input[name="tiposVeiculo"], input[name="tiposCarroceria"]').forEach(cb => {
                    cb.disabled = false;
                });
                
                if (botaoSalvar) {
                    botaoSalvar.disabled = false;
                    botaoSalvar.title = '';
                    botaoSalvar.style.opacity = '1';
                    botaoSalvar.style.cursor = 'pointer';
                }
            }
            
            document.getElementById('coletaModal').classList.add('active');
        }

        // Formulário de coleta
        document.getElementById('coletaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const formData = new FormData(this);
            const rawData = Object.fromEntries(formData);
            
            // ========== VALIDAÇÃO CENTRALIZADA ==========
            // Coletar tipos de veículo e carroceria selecionados
            const tiposVeiculoSelecionadosValidacao = Array.from(document.querySelectorAll('input[name="tiposVeiculo"]:checked')).map(cb => cb.value);
            const tiposCarroceriaSelecionadosValidacao = Array.from(document.querySelectorAll('input[name="tiposCarroceria"]:checked')).map(cb => cb.value);
            
            // Preparar dados para validação
            const dadosParaValidacao = {
                ...rawData,
                numero_coleta: rawData.numeroColeta || rawData.numero_coleta,
                data_recebimento: rawData.dataRecebimento || rawData.data_recebimento,
                data_entrega: rawData.dataEntrega || rawData.data_entrega,
                tiposVeiculo: tiposVeiculoSelecionadosValidacao,
                tiposCarroceria: tiposCarroceriaSelecionadosValidacao,
                classeVeiculo: rawData.classeVeiculo,
                valor: rawData.valor ? parseFloat(rawData.valor) : 0,
                frete_motorista: rawData.freteMotorista ? parseFloat(rawData.freteMotorista) : 0,
                km: rawData.km ? parseFloat(rawData.km) : 0
            };
            
            // Verificar se é diária
            const isDiaria = document.getElementById('diaria')?.checked || false;
            
            // Validar apenas se for criação de nova coleta (não edição) E não for diária
            // Pular validação se estiver em modo lote (a validação será feita dentro da função criarMultiplasColetas)
            // Pular validação se for diária (nenhum campo é obrigatório)
            if (!currentEditingId && !modoCriacaoLote && !isDiaria) {
                if (!Validator.validateAndShowErrors(dadosParaValidacao)) {
                    // Scroll para o primeiro erro
                    const firstError = document.querySelector('.field-input-error');
                    if (firstError) {
                        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        firstError.focus();
                    }
                    return;
                }
            }
            
            // 🔐 Verificar se está editando e se tem permissão
            if (currentEditingId) {
                const coleta = coletasData.find(c => c.id === currentEditingId);
                if (coleta && !temPermissaoEtapa(coleta.etapa_atual)) {
                    showNotification('⚠️ Você não tem permissão para editar coletas nesta etapa', 'warning');
                    return;
                }
                
                // Não permitir mudança de etapa através do formulário
                rawData.etapaAtual = coleta.etapa_atual;
            }
            
            // ========== MODO CRIAÇÃO EM LOTE ==========
            if (modoCriacaoLote && !currentEditingId) {
                console.log('🔄 Modo criação em lote ativado');
                const multiplosNumerosInput = document.getElementById('multiplosNumeros');
                
                if (!multiplosNumerosInput) {
                    console.error('❌ Campo multiplosNumeros não encontrado');
                    showNotification('⚠️ Erro: Campo de múltiplos números não encontrado', 'error');
                    return;
                }
                
                const multiplosNumerosValue = multiplosNumerosInput.value.trim();
                console.log('📝 Números informados:', multiplosNumerosValue);
                
                if (!multiplosNumerosValue) {
                    showNotification('⚠️ Por favor, informe os números das coletas', 'warning');
                    return;
                }
                
                const numerosColetas = parsearMultiplosNumeros(multiplosNumerosValue);
                console.log('🔢 Números processados:', numerosColetas);
                
                if (numerosColetas.length === 0) {
                    showNotification('⚠️ Nenhum número válido encontrado. Use vírgulas ou intervalos (ex: 5565,5566 ou 5565-5569)', 'warning');
                    return;
                }
                
                // Validar campos obrigatórios apenas se não for diária
                if (!isDiaria) {
                    if (!rawData.filial) {
                        showNotification('⚠️ Por favor, selecione a filial', 'warning');
                        return;
                    }
                    
                    if (!rawData.cliente) {
                        showNotification('⚠️ Por favor, selecione o cliente', 'warning');
                        return;
                    }
                    
                    // Validar tipos de veículo e carroceria
                    const tiposVeiculoSelecionados = Array.from(document.querySelectorAll('input[name="tiposVeiculo"]:checked'));
                    const tiposCarroceriaSelecionados = Array.from(document.querySelectorAll('input[name="tiposCarroceria"]:checked'));
                    
                    if (tiposVeiculoSelecionados.length === 0) {
                        showNotification('⚠️ Por favor, selecione pelo menos um tipo de veículo', 'warning');
                        return;
                    }
                    
                    if (tiposCarroceriaSelecionados.length === 0) {
                        showNotification('⚠️ Por favor, selecione pelo menos um tipo de carroceria', 'warning');
                        return;
                    }
                }
                
                console.log('✅ Validações passadas, criando múltiplas coletas...');
                // Criar múltiplas coletas
                await criarMultiplasColetas(rawData, numerosColetas);
                return; // Sair da função após criar múltiplas
            }
            
            // ========== MODO CRIAÇÃO ÚNICA ==========
            // Validar e processar número da coleta (remover zeros à esquerda)
            let numeroColeta = rawData.numeroColeta ? rawData.numeroColeta.trim() : '';
            if (numeroColeta) {
                // Remover zeros à esquerda convertendo para número e depois para string
                numeroColeta = String(parseInt(numeroColeta, 10));
                if (numeroColeta === 'NaN' || numeroColeta === '0') {
                    showNotification('⚠️ Número da coleta inválido. Digite apenas números (ex: 5565)', 'warning');
                    return;
                }
            }
            
            // Validar campos obrigatórios para nova coleta (apenas se não for diária)
            if (!currentEditingId && !isDiaria) {
                if (!rawData.filial) {
                    showNotification('⚠️ Por favor, selecione a filial', 'warning');
                    return;
                }
                if (!numeroColeta) {
                    showNotification('⚠️ Por favor, informe o número da coleta', 'warning');
                    return;
                }
                
                // Validar duplicidade (filial + número da coleta) antes de criar
                try {
                    if (!supabaseClient) {
                        console.error('❌ Supabase não inicializado');
                        showNotification('Erro: Supabase não inicializado', 'error');
                        return;
                    }
                    
                    const { data: coletasExistentes, error: buscaError } = await supabaseClient
                        .from('coletas')
                        .select('id, filial, numero_coleta, etapa_atual, cliente, origem, destino')
                        .eq('filial', rawData.filial)
                        .eq('numero_coleta', numeroColeta);
                    
                    if (buscaError) {
                        console.error('❌ Erro ao verificar duplicidade:', buscaError);
                        // Continuar mesmo com erro na busca (não bloquear criação)
                    } else if (coletasExistentes && coletasExistentes.length > 0) {
                        const coletaExistente = coletasExistentes[0];
                        const etapaNome = ETAPAS.find(e => e.id === coletaExistente.etapa_atual)?.nome || coletaExistente.etapa_atual;
                        showNotification(
                            `⚠️ Já existe uma coleta com a filial ${rawData.filial} e número ${numeroColeta}!\n\n` +
                            `📍 Localização: ${coletaExistente.cliente || 'N/A'} (${coletaExistente.origem || 'N/A'} → ${coletaExistente.destino || 'N/A'})\n` +
                            `📊 Etapa atual: ${etapaNome}\n` +
                            `🆔 ID: ${coletaExistente.id}`,
                            'warning',
                            10000 // Mostrar por 10 segundos
                        );
                        return;
                    }
                } catch (error) {
                    console.error('❌ Erro ao verificar duplicidade:', error);
                    // Continuar mesmo com erro (não bloquear criação)
                }
            }
            
            // ✅ INCLUI a etapaAtual do formulário
            // Converter data de recebimento para formato ISO (YYYY-MM-DD -> YYYY-MM-DDTHH:MM:SS)
            let dataRecebimento = rawData.dataRecebimento;
            if (dataRecebimento) {
                // Se tiver apenas a data, adicionar horário (meio-dia UTC)
                if (dataRecebimento.length === 10) {
                    dataRecebimento = dataRecebimento + 'T12:00:00.000Z';
                }
            }
            
            // Converter data de entrega para formato ISO (YYYY-MM-DD -> YYYY-MM-DDTHH:MM:SS)
            let dataEntrega = rawData.dataEntrega;
            if (dataEntrega) {
                // Se tiver apenas a data, adicionar horário (meio-dia UTC)
                if (dataEntrega.length === 10) {
                    dataEntrega = dataEntrega + 'T12:00:00.000Z';
                }
            }
            
            // Coletar tipos de veículo selecionados
            const tiposVeiculoSelecionados = Array.from(document.querySelectorAll('input[name="tiposVeiculo"]:checked'))
                .map(checkbox => checkbox.value);
            
            // Coletar tipos de carroceria selecionados
            const tiposCarroceriaSelecionados = Array.from(document.querySelectorAll('input[name="tiposCarroceria"]:checked'))
                .map(checkbox => checkbox.value);
            
            // Verificar se é diária (para uso no coletaData)
            const isDiariaData = document.getElementById('diaria')?.checked || false;
            
            // ✅ Prioridade: sempre "normal" na criação para usuários comuns
            // Apenas admin/coordenador pode escolher outra prioridade na criação
            const isAdminOrManager = currentUser && (currentUser.isAdmin || currentUser.role === 'admin' || currentUser.role === 'manager');
            const prioridadeFinal = (!currentEditingId && !isAdminOrManager) ? 'normal' : (rawData.prioridade || 'normal');
            
            const coletaData = {
                filial: rawData.filial,
                numero_coleta: numeroColeta || null,
                cliente: rawData.cliente,
                data_recebimento: dataRecebimento,
                data_entrega: dataEntrega || null,
                origem: rawData.origem,
                destino: rawData.destino,
                tipo_produto: rawData.tipoProduto || null,
                codigo_tabela: rawData.codigoTabela || null,
                valor: parseFloat(rawData.valor) || 0,
                frete_motorista: parseFloat(rawData.freteMotorista) || 0,
                km: parseFloat(rawData.km) || 0,
                tipos_veiculo: tiposVeiculoSelecionados,
                tipos_carroceria: tiposCarroceriaSelecionados,
                status: rawData.status,
                etapa_atual: rawData.etapaAtual, 
                prioridade: prioridadeFinal,
                observacoes: rawData.observacoes,
                diaria: isDiariaData
            };
            
            // ✅ SEGURANÇA: Logs condicionais apenas em desenvolvimento
            if (window.DEBUG || window.location.hostname === 'localhost') {
            console.log('📝 Dados do formulário:', coletaData); // ← Para debug
            console.log('🔍 Raw form data:', rawData);
            console.log('🔍 etapaAtual value:', rawData.etapaAtual);
            }

            try {
                await salvarColeta(coletaData);
                closeModal();
            } catch (error) {
                // Erro já tratado
            }
        });

        // ========== SISTEMA DE ANEXOS ==========
        async function abrirModalAnexos(coletaId) {
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta) return;
            
            currentAnexosColetaId = coletaId;
            
            // Definir título do modal de anexos de forma amigável
            let tituloAnexos = 'Anexos da Coleta';
            if (coleta.filial && coleta.numero_coleta) {
                tituloAnexos = `Anexos - ${coleta.filial} #${coleta.numero_coleta}`;
            } else if (coleta.cliente) {
                tituloAnexos = `Anexos - ${coleta.cliente}`;
            }
            document.getElementById('modalAnexosTitle').textContent = tituloAnexos;
            
            // Resetar o modal
            document.getElementById('selectedFiles').style.display = 'none';
            document.getElementById('uploadProgress').style.display = 'none';
            document.getElementById('btnUpload').disabled = true;
            document.getElementById('filesList').innerHTML = '';
            selectedFiles = [];
            
            // Resetar categoria e título do contrato
            const categoriaSelect = document.getElementById('anexoCategoriaSelect');
            if (categoriaSelect) {
                categoriaSelect.value = '';
            }
            const tituloContainer = document.getElementById('tituloContratoContainerModal');
            if (tituloContainer) {
                tituloContainer.style.display = 'none';
            }
            const tituloInput = document.getElementById('tituloContratoInputModal');
            if (tituloInput) {
                tituloInput.value = '';
            }
            
            // Carregar lista de anexos existentes
            await carregarListaAnexos(coleta);
            
            // Garantir que o input file está configurado corretamente
            configurarEventListenersModalAnexos();
            
            document.getElementById('anexosModal').classList.add('active');
        }

        function configurarEventListenersModalAnexos() {
            // Garantir que o input file tem o event listener correto
            const fileInput = document.getElementById('fileInput');
            if (fileInput) {
                // Remover listeners antigos clonando o elemento
                const newInput = fileInput.cloneNode(true);
                fileInput.parentNode.replaceChild(newInput, fileInput);
                
                // Adicionar novo listener
                newInput.addEventListener('change', function(e) {
                    if (e.target.files && e.target.files.length > 0) {
                        handleFileSelect(e.target.files);
                    }
                });
            }
            
            // Garantir que o botão de upload está configurado
            const btnUpload = document.getElementById('btnUpload');
            if (btnUpload) {
                // Remover listeners antigos
                const newBtn = btnUpload.cloneNode(true);
                btnUpload.parentNode.replaceChild(newBtn, btnUpload);
                
                // Adicionar novo listener
                newBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    fazerUpload();
                });
            }
            
            // Garantir que o select de categoria atualiza o botão
            const categoriaSelect = document.getElementById('anexoCategoriaSelect');
            if (categoriaSelect) {
                categoriaSelect.addEventListener('change', function() {
                    // Atualizar estado do botão quando categoria mudar
                    const btnUpload = document.getElementById('btnUpload');
                    if (btnUpload && selectedFiles.length > 0) {
                        btnUpload.disabled = !this.value || selectedFiles.length === 0;
                    }
                    toggleTituloContratoModal(this.value);
                });
            }
        }

        async function carregarListaAnexos(coleta) {
            const anexosList = document.getElementById('anexosListModal');
            const anexos = await carregarAnexos(coleta.id);
            
            if (!anexos || anexos.length === 0) {
                anexosList.innerHTML = `
                    <div style="text-align: center; color: #6c757d; padding: 2rem;">
                        <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <p>Nenhum anexo adicionado ainda</p>
                    </div>
                `;
                return;
            }
            
            // Agrupar anexos por categoria
            const anexosPorCategoria = {};
            anexos.forEach(anexo => {
                const categoria = anexo.categoria || anexo.area || 'outros';
                if (!anexosPorCategoria[categoria]) {
                    anexosPorCategoria[categoria] = [];
                }
                anexosPorCategoria[categoria].push(anexo);
            });
            
            const categoriasOrdenadas = [
                'canhoto',
                'documentos_motorista',
                'documentos_proprietario',
                'documentos_veiculo',
                'evidencias',
                'faturamento',
                'notas_fiscais',
                'contratos',
                'outros'
            ];
            
            anexosList.innerHTML = `
                <h6 style="margin-bottom: 1.5rem; color: var(--azul-escuro); font-size: 1.1rem; font-weight: 600;">
                    <i class="fas fa-paperclip"></i> Anexos organizados por categoria:
                </h6>
                <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                    ${categoriasOrdenadas.map(categoria => {
                        const anexosCategoria = anexosPorCategoria[categoria] || [];
                        if (anexosCategoria.length === 0) return '';
                        
                        const corCategoria = obterCorCategoria(categoria);
                        const iconeCategoria = obterIconeCategoria(categoria);
                        const nomeCategoria = obterNomeCategoria(categoria);
                        
                        return `
                            <div style="border: 2px solid ${corCategoria}30; border-radius: 10px; padding: 1rem; background: ${corCategoria}08;">
                                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 2px solid ${corCategoria}30;">
                                    <i class="fas ${iconeCategoria}" style="color: ${corCategoria}; font-size: 1.3rem;"></i>
                                    <h6 style="margin: 0; color: ${corCategoria}; font-size: 1rem; font-weight: 700;">
                                        ${nomeCategoria}
                                    </h6>
                                    <span style="background: ${corCategoria}; color: white; padding: 0.2rem 0.6rem; border-radius: 12px; font-size: 0.8rem; font-weight: 600; margin-left: auto;">
                                        ${anexosCategoria.length}
                                    </span>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                                    ${anexosCategoria.map(anexo => `
                                        <div class="file-item" style="border-left: 3px solid ${corCategoria};">
                        <div class="file-info">
                            <div class="file-icon ${getFileIconClass(anexo.tipo_arquivo)}">
                                <i class="fas ${getFileIcon(anexo.tipo_arquivo)}"></i>
                            </div>
                            <div class="file-details">
                                <div class="file-name">${anexo.nome_arquivo}</div>
                                <div class="file-size">${formatFileSize(anexo.tamanho)}</div>
                            </div>
                        </div>
                        <div class="anexo-actions">
                            <button class="btn-anexo-action btn-anexo-view" onclick="visualizarAnexo('${anexo.id}')" title="Visualizar">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-anexo-action btn-anexo-download" onclick="downloadAnexoDireto('${anexo.id}')" title="Baixar">
                                <i class="fas fa-download"></i>
                            </button>
                                                ${currentUser && (currentUser.isAdmin || currentUser.role === 'admin') ? `
                            <button class="btn-anexo-action btn-anexo-delete" onclick="excluirAnexo('${anexo.id}')" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                                                ` : ''}
                        </div>
                    </div>
                `).join('')}
                                </div>
                            </div>
                        `;
                    }).filter(html => html !== '').join('')}
                </div>
            `;
        }

        // Função para mostrar/ocultar campo de título do contrato
        function toggleTituloContratoModal(categoria) {
            const tituloContainer = document.getElementById('tituloContratoContainerModal');
            const tituloInput = document.getElementById('tituloContratoInputModal');
            
            if (categoria === 'contratos') {
                if (tituloContainer) {
                    tituloContainer.style.display = 'block';
                    if (tituloInput) tituloInput.required = true;
                }
            } else {
                if (tituloContainer) {
                    tituloContainer.style.display = 'none';
                    if (tituloInput) {
                        tituloInput.value = '';
                        tituloInput.required = false;
                    }
                }
            }
        }
        
        // Expor funções globalmente para uso em inline handlers
        window.toggleTituloContratoModal = toggleTituloContratoModal;
        window.handleFileSelect = handleFileSelect;
        window.fazerUpload = fazerUpload;
        window.removerArquivo = removerArquivo;
        window.configurarEventListenersModalAnexos = configurarEventListenersModalAnexos;

        async function fazerUpload() {
            if (!currentAnexosColetaId || selectedFiles.length === 0) return;

            // Verificar se categoria foi selecionada
            const categoriaSelect = document.getElementById('anexoCategoriaSelect');
            const categoria = categoriaSelect ? categoriaSelect.value : null;
            
            if (!categoria) {
                showNotification('⚠️ Selecione uma categoria antes de enviar os arquivos', 'warning');
                return;
            }
            
            // Verificar título do contrato se categoria for contratos
            let tituloContrato = null;
            if (categoria === 'contratos') {
                const tituloInput = document.getElementById('tituloContratoInputModal');
                if (tituloInput) {
                    tituloContrato = tituloInput.value.trim();
                    if (!tituloContrato) {
                        showNotification('⚠️ Por favor, informe o título do contrato', 'warning');
                        return;
                    }
                }
            }

            const progressFill = document.getElementById('progressFill');
            const progressText = document.getElementById('progressText');
            const uploadProgress = document.getElementById('uploadProgress');
            
            uploadProgress.style.display = 'block';
            document.getElementById('btnUpload').disabled = true;
            
            try {
                for (let i = 0; i < selectedFiles.length; i++) {
                    const file = selectedFiles[i];
                    const progress = ((i + 1) / selectedFiles.length) * 100;
                    
                    progressFill.style.width = progress + '%';
                    progressText.textContent = Math.round(progress) + '%';
                    
                    await uploadAnexo(currentAnexosColetaId, file, categoria, tituloContrato);
                }
                
                showNotification('Arquivos enviados com sucesso!', 'success');
                
                // Recarregar a lista de anexos
                const coleta = coletasData.find(c => c.id === currentAnexosColetaId);
                if (coleta) {
                    await carregarListaAnexos(coleta);
                }
                
                // Resetar interface
                document.getElementById('selectedFiles').style.display = 'none';
                document.getElementById('uploadProgress').style.display = 'none';
                document.getElementById('filesList').innerHTML = '';
                if (categoriaSelect) categoriaSelect.value = '';
                const tituloInput = document.getElementById('tituloContratoInputModal');
                if (tituloInput) {
                    tituloInput.value = '';
                    tituloInput.required = false;
                }
                const tituloContainer = document.getElementById('tituloContratoContainerModal');
                if (tituloContainer) tituloContainer.style.display = 'none';
                selectedFiles = [];
                
                // Atualizar cards
                await carregarColetas();
                
            } catch (error) {
                showNotification('Erro ao fazer upload: ' + error.message, 'error');
            } finally {
                document.getElementById('btnUpload').disabled = false;
            }
        }

        // ========== SISTEMA DE CHAT ==========
        async function openChatModal(coletaId) {
            currentChatColetaId = coletaId;
            const coleta = coletasData.find(c => c.id === coletaId);
            
            if (!coleta) return;
            
            // Definir identificação da coleta de forma amigável
            let identificacaoColeta = 'Coleta';
            if (coleta.filial && coleta.numero_coleta) {
                identificacaoColeta = `${coleta.filial} #${coleta.numero_coleta}`;
            } else if (coleta.cliente) {
                identificacaoColeta = coleta.cliente;
            }
            document.getElementById('chatColetaId').textContent = identificacaoColeta;
            document.getElementById('chatCliente').textContent = coleta.cliente;
            
            // Carregar mensagens
            await carregarMensagensChatModal(coletaId);
            
            setTimeout(() => {
                document.getElementById('chatInput').focus();
            }, 300);
            
            document.getElementById('chatModal').classList.add('active');
        }

        async function carregarMensagensChatModal(coletaId) {
            const chatMessagesContainer = document.getElementById('chatMessages');
            chatMessagesContainer.innerHTML = '';
            
            const mensagens = await carregarMensagensChat(coletaId);
            
            if (mensagens.length === 0) {
                // Mensagem inicial do sistema
                const systemMessage = {
                    id: 'msg-1',
                    usuario: 'Sistema',
                    mensagem: 'Chat iniciado para esta coleta. Use este espaço para comunicação interna sobre a operação.',
                    tipo: 'system',
                    created_at: new Date().toISOString()
                };
                mensagens.push(systemMessage);
            }
            
            // Renderizar mensagens
            mensagens.forEach(msg => {
                const messageElement = document.createElement('div');
                
                if (msg.tipo === 'system') {
                    messageElement.className = 'message system';
                    messageElement.innerHTML = `
                        <div class="message-content" style="text-align: center; font-style: italic; color: #6c757d;">
                            ${msg.mensagem}
                        </div>
                    `;
                } else {
                    const isSent = msg.usuario === currentUser.nome;
                    messageElement.className = `message ${isSent ? 'sent' : 'received'}`;
                    
                    messageElement.innerHTML = `
                        <div class="message-header">
                            <span class="message-sender">${msg.usuario}</span>
                            <span class="message-time">${formatarHora(msg.created_at)}</span>
                        </div>
                        <div class="message-content">${msg.mensagem}</div>
                    `;
                }
                
                chatMessagesContainer.appendChild(messageElement);
            });
            
            // Scroll para baixo
            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        async function sendMessage() {
            const chatInput = document.getElementById('chatInput');
            const messageContent = chatInput.value.trim();
            
            if (!messageContent || !currentChatColetaId) return;
            
            // Verificar se currentUser existe e obter nome do usuário
            if (!currentUser) {
                showNotification('Usuário não autenticado', 'error');
                return;
            }
            
            const userName = currentUser.nome || currentUser.username || currentUser.email || 'Usuário';
            
            try {
                await enviarMensagem(currentChatColetaId, messageContent, userName);
                
                // Recarregar mensagens
                await carregarMensagensChatModal(currentChatColetaId);
                
                // Limpar input
                chatInput.value = '';
                chatInput.style.height = 'auto';
                document.getElementById('chatSend').disabled = true;
                
            } catch (error) {
                console.error('❌ Erro detalhado:', error);
                showNotification('Erro ao enviar mensagem: ' + (error.message || 'Erro desconhecido'), 'error');
            }
        }

        // ========== FUNÇÕES UTILITÁRIAS ==========
        function setupDragAndDrop() {
            const uploadArea = document.getElementById('uploadArea');
            
            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, preventDefaults, false);
            });
            
            function preventDefaults(e) {
                e.preventDefault();
                e.stopPropagation();
            }
            
            ['dragenter', 'dragover'].forEach(eventName => {
                uploadArea.addEventListener(eventName, highlight, false);
            });
            
            ['dragleave', 'drop'].forEach(eventName => {
                uploadArea.addEventListener(eventName, unhighlight, false);
            });
            
            function highlight() {
                uploadArea.classList.add('dragover');
            }
            
            function unhighlight() {
                uploadArea.classList.remove('dragover');
            }
            
            uploadArea.addEventListener('drop', handleDrop, false);
            
            function handleDrop(e) {
                const dt = e.dataTransfer;
                const files = dt.files;
                handleFileSelect(files);
            }
        }

        function setupChatInput() {
            const chatInput = document.getElementById('chatInput');
            const chatSend = document.getElementById('chatSend');
            
            chatInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = (this.scrollHeight) + 'px';
                chatSend.disabled = this.value.trim() === '';
            });
            
            chatInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    if (!chatSend.disabled) {
                        sendMessage();
                    }
                }
            });
        }

        function initializeDateFilters() {
            const hoje = new Date();
            const inicioMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            
            // ✅ Setar para o mês atual por padrão
            document.getElementById('dataInicio').value = formatarDataParaInput(inicioMes);
            document.getElementById('dataFim').value = formatarDataParaInput(hoje);
            
            console.log('📅 Filtros de data inicializados:', {
                inicio: formatarDataParaInput(inicioMes),
                fim: formatarDataParaInput(hoje)
            });
        }

        function calcularProgressoEtapas(coleta) {
            const etapaAtualIndex = ETAPAS.findIndex(e => e.id === coleta.etapa_atual);
            const etapasConcluidasCount = coleta.etapas_concluidas?.length || 0;
            const totalEtapas = ETAPAS.length;
            
            return {
                concluidas: etapasConcluidasCount,
                total: totalEtapas,
                porcentagem: (etapasConcluidasCount / totalEtapas) * 100,
                etapaAtual: ETAPAS[etapaAtualIndex]?.nome || 'Não definida'
            };
        }

        // FUNÇÃO SIMPLES - usa a API instead do Supabase direto
        async function avancarEtapa(coletaId) {
            console.log('🚀 avancarEtapa chamado para coleta:', coletaId);
            
            if (!coletaId) {
                console.error('❌ avancarEtapa: coletaId não fornecido');
                showNotification('Erro: ID da coleta não encontrado', 'error');
                return;
            }
            
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta) {
                console.error('❌ Coleta não encontrada:', coletaId);
                showNotification('Erro: Coleta não encontrada', 'error');
                return;
            }
            
            console.log('📋 Dados da coleta antes de validar:', {
                id: coleta.id,
                etapa_atual: coleta.etapa_atual,
                motorista_id: coleta.motorista_id,
                gr_aprovado: coleta.gr_aprovado,
                tipo_gr_aprovado: typeof coleta.gr_aprovado
            });

            // 🔐 Verificar permissão para a etapa atual
            if (!temPermissaoEtapa(coleta.etapa_atual)) {
                showNotification('⚠️ Você não tem permissão para alterar esta etapa', 'warning');
                // ✅ SEGURANÇA: Logs condicionais apenas em desenvolvimento
                if (window.DEBUG || window.location.hostname === 'localhost') {
                console.log(`❌ Usuário não tem permissão para etapa: ${coleta.etapa_atual}`);
                }
                return;
            }

            // ✅ VALIDAÇÃO OBRIGATÓRIA: Não pode avançar da etapa contratação sem motorista vinculado
            if (coleta.etapa_atual === 'contratacao' && !coleta.motorista_id) {
                    showNotification('⚠️ Para avançar da etapa Contratação, é necessário vincular um motorista à coleta.', 'warning');
                    return;
            }

            // ✅ VALIDAÇÃO GR: Só pode avançar de GR se tiver sido aprovado
            if (coleta.etapa_atual === 'gr') {
                if (coleta.gr_aprovado === null || coleta.gr_aprovado === undefined) {
                    showNotification('⚠️ Para avançar da etapa GR, é necessário aprovar ou reprovar a coleta primeiro.\n\nUse os botões "Aprovar GR" ou "Reprovar GR" no card da coleta.', 'warning');
                    return;
                }
                if (coleta.gr_aprovado === false) {
                    showNotification('⚠️ Esta coleta foi reprovada pelo GR e não pode avançar. Ela deve voltar para a etapa de Contratação.', 'warning');
                    return;
                }
            }

            const etapaAtualIndex = ETAPAS.findIndex(e => e.id === coleta.etapa_atual);
            if (etapaAtualIndex < ETAPAS.length - 1) {
                const proximaEtapaId = ETAPAS[etapaAtualIndex + 1].id;
                
                console.log('🔍 Avançando etapa:', {
                    etapaAtual: coleta.etapa_atual,
                    proximaEtapa: proximaEtapaId,
                    motorista_id: coleta.motorista_id,
                    gr_aprovado: coleta.gr_aprovado
                });
                
                // ✅ VALIDAÇÃO: Não pode avançar para documentação ou monitoramento sem aprovação no GR
                const etapasQueRequeremAprovacaoGR = ['documentacao', 'monitoramento'];
                if (etapasQueRequeremAprovacaoGR.includes(proximaEtapaId)) {
                    // Verificar se o motorista foi aprovado no GR
                    if (!coleta.motorista_id) {
                        console.log('❌ Bloqueado: Sem motorista vinculado');
                        showNotification('⚠️ Para avançar para esta etapa, é necessário ter um motorista vinculado e aprovado no GR.', 'warning');
                        return;
                    }
                    
                    // Verificar se passou pelo GR e foi aprovado
                    // ✅ CORREÇÃO: Buscar dados atualizados do banco antes de validar
                    // O objeto em memória pode estar desatualizado
                    let grAprovadoFinal = false;
                    let coletaAtualizada = null; // Declarar no escopo correto
                    let valorBancoGrAprovado = null;
                    
                    try {
                        console.log('🔍 Buscando dados atualizados do banco para coleta:', coletaId, 'próxima etapa:', proximaEtapaId);
                        const { data: coletaAtualizadaTemp, error: errorBusca } = await supabaseClient
                            .from('coletas')
                            .select('gr_aprovado, motorista_id')
                            .eq('id', coletaId)
                            .single();
                        
                        coletaAtualizada = coletaAtualizadaTemp; // Atribuir à variável do escopo correto
                        
                        console.log('🔍 Dados buscados do banco:', {
                            coletaAtualizada,
                            errorBusca,
                            gr_aprovado_banco: coletaAtualizada?.gr_aprovado,
                            tipo_gr_aprovado_banco: typeof coletaAtualizada?.gr_aprovado,
                            proximaEtapa: proximaEtapaId
                        });
                        
                        if (errorBusca) {
                            console.warn('⚠️ Erro ao buscar coleta atualizada:', errorBusca);
                            // Se não conseguir buscar, usar o valor em memória
                            grAprovadoFinal = coleta.gr_aprovado === true || coleta.gr_aprovado === 'true' || coleta.gr_aprovado === 1;
                            console.log('⚠️ Usando valor em memória devido a erro:', grAprovadoFinal);
                        } else if (coletaAtualizada) {
                            // Atualizar objeto em memória
                            coleta.gr_aprovado = coletaAtualizada.gr_aprovado;
                            coleta.motorista_id = coletaAtualizada.motorista_id || coleta.motorista_id;
                            
                            // Verificar se está aprovado usando o valor do banco
                            valorBancoGrAprovado = coletaAtualizada.gr_aprovado;
                            grAprovadoFinal = valorBancoGrAprovado === true || 
                                            valorBancoGrAprovado === 'true' || 
                                            valorBancoGrAprovado === 1 ||
                                            valorBancoGrAprovado === '1' ||
                                            String(valorBancoGrAprovado).toLowerCase() === 'true';
                            
                            console.log('✅ Valor do banco processado:', {
                                valorBancoGrAprovado,
                                tipo: typeof valorBancoGrAprovado,
                                grAprovadoFinal,
                                igual_a_true: valorBancoGrAprovado === true,
                                igual_a_string_true: valorBancoGrAprovado === 'true',
                                igual_a_1: valorBancoGrAprovado === 1
                            });
                        } else {
                            // Se não encontrou no banco, usar valor em memória
                            console.warn('⚠️ Coleta não encontrada no banco, usando valor em memória');
                            grAprovadoFinal = coleta.gr_aprovado === true || coleta.gr_aprovado === 'true' || coleta.gr_aprovado === 1;
                        }
                    } catch (err) {
                        console.warn('⚠️ Erro ao buscar coleta atualizada:', err);
                        // Em caso de erro, usar valor em memória
                        grAprovadoFinal = coleta.gr_aprovado === true || coleta.gr_aprovado === 'true' || coleta.gr_aprovado === 1;
                    }
                    
                    console.log('🔍 Resultado da validação GR (FINAL):', {
                        proximaEtapa: proximaEtapaId,
                        grAprovadoFinal,
                        gr_aprovado_memoria: coleta.gr_aprovado,
                        tipo_memoria: typeof coleta.gr_aprovado,
                        valor_banco: valorBancoGrAprovado,
                        tipo_banco: typeof valorBancoGrAprovado,
                        coletaAtualizada_existe: !!coletaAtualizada
                    });
                    
                    if (!grAprovadoFinal) {
                        console.log('❌ Bloqueado: GR não aprovado', { 
                            coletaId: coletaId,
                            gr_aprovado: coleta.gr_aprovado, 
                            tipo: typeof coleta.gr_aprovado,
                            igual_a_true: coleta.gr_aprovado === true,
                            igual_a_string_true: coleta.gr_aprovado === 'true',
                            igual_a_1: coleta.gr_aprovado === 1,
                            grAprovadoFinal: grAprovadoFinal,
                            valor_banco: coletaAtualizada?.gr_aprovado
                        });
                        if (coleta.gr_aprovado === false || coleta.gr_aprovado === 'false' || coleta.gr_aprovado === 0) {
                            showNotification('⚠️ Esta coleta foi reprovada pelo GR. Não é possível avançar para esta etapa. É necessário aprovar o motorista no GR primeiro.', 'warning');
                        } else {
                            showNotification('⚠️ Para avançar para esta etapa, o motorista deve ser aprovado no GR primeiro. Status atual: ' + (coleta.gr_aprovado === null || coleta.gr_aprovado === undefined ? 'Pendente' : String(coleta.gr_aprovado)), 'warning');
                        }
                                return;
                            }
                    
                    console.log('✅ Validações passaram: Motorista vinculado e GR aprovado');
                }
                
                // ✅ VALIDAÇÃO: Se a próxima etapa for contas_pagar, solicitar tipo de pagamento
                if (proximaEtapaId === 'contas_pagar') {
                    console.log('📋 PRÓXIMA ETAPA É CONTAS_PAGAR - Abrindo modal de tipo de pagamento para coleta:', coletaId);
                    console.log('📋 Dados antes de abrir modal:', {
                        coletaId,
                        proximaEtapaId,
                        gr_aprovado: coleta.gr_aprovado,
                        motorista_id: coleta.motorista_id
                    });
                    etapaPendenteTipoPagamento = proximaEtapaId;
                    coletaPendenteTipoPagamento = coletaId;
                    
                    // Verificar se o modal existe antes de abrir
                    const modal = document.getElementById('modalTipoPagamento');
                    if (!modal) {
                        console.error('❌ Modal de tipo de pagamento não encontrado no DOM');
                        showNotification('Erro: Modal de tipo de pagamento não encontrado. Recarregue a página.', 'error');
                        return;
                    }
                    
                    abrirModalTipoPagamento();
                    return;
                }
                
                // Atualizar etapas_concluidas: adicionar a etapa atual se ainda não estiver
                const etapasConcluidas = Array.isArray(coleta.etapas_concluidas) ? [...coleta.etapas_concluidas] : [];
                if (!etapasConcluidas.includes(coleta.etapa_atual)) {
                    etapasConcluidas.push(coleta.etapa_atual);
                }
                
                const updateData = {
                    etapa_atual: proximaEtapaId,
                    status: etapaAtualIndex + 1 === ETAPAS.length - 1 ? 'concluida' : 'em_andamento',
                    etapas_concluidas: etapasConcluidas,
                    updated_at: new Date().toISOString()
                };

                console.log('🎯 Dados para update:', updateData);

                try {
                    currentEditingId = coletaId;
                    await salvarColeta(updateData);
                    currentEditingId = null;
                    
                    // ✅ HISTÓRICO NO LUGAR CERTO - DENTRO DO TRY (sucesso)
                    await salvarNoHistorico(coletaId, 'etapa_avancada', 
                        `Etapa avançada de ${coleta.etapa_atual} para ${proximaEtapaId}`
                    );
                    
                    showNotification(`✅ Etapa avançada para ${ETAPAS[etapaAtualIndex + 1].nome}`, 'success');
            } catch (error) {
                    console.error('❌ Erro:', error);
                    currentEditingId = null;
                    showNotification('Erro ao avançar etapa: ' + error.message, 'error');
                }
            } else {
                showNotification('🚫 Última etapa já alcançada', 'info');
            }
        }
        
        // Garantir que a função está disponível globalmente
        window.avancarEtapa = avancarEtapa;
        console.log('✅ Função avancarEtapa definida globalmente:', typeof window.avancarEtapa);

        function openMoverEtapaModal(coletaId) {
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta) return;

            if (!temPermissaoEtapa(coleta.etapa_atual)) {
                showNotification('⚠️ Você não tem permissão para alterar esta etapa', 'warning');
                return;
            }

            // ✅ VALIDAÇÃO: Se está na etapa contratação sem motorista, não permitir abrir o modal de mover
            if (coleta.etapa_atual === 'contratacao' && !coleta.motorista_id) {
                showNotification('⚠️ Para mover uma coleta da etapa Contratação, é necessário vincular um motorista à coleta.', 'warning');
                return;
            }

            moverEtapaColetaId = coletaId;
            document.getElementById('moverEtapaAtual').textContent = obterNomeEtapa(coleta.etapa_atual);

            const select = document.getElementById('novaEtapaSelect');
            select.innerHTML = `<option value="">Selecione a etapa</option>` + ETAPAS.map(etapa => {
                // Não permitir selecionar a própria etapa atual
                if (etapa.id === coleta.etapa_atual) {
                    return `<option value="${etapa.id}" disabled>${etapa.nome} (Atual)</option>`;
                }
                return `<option value="${etapa.id}">${etapa.nome}</option>`;
            }).join('');
            select.value = '';

            document.getElementById('moverEtapaModal').classList.add('active');
        }

        function fecharMoverEtapaModal() {
            moverEtapaColetaId = null;
            document.getElementById('novaEtapaSelect').value = '';
            document.getElementById('moverEtapaModal').classList.remove('active');
        }

        let etapaPendenteTipoPagamento = null; // Armazena a etapa que aguarda tipo de pagamento
        let coletaPendenteTipoPagamento = null; // Armazena o ID da coleta que aguarda tipo de pagamento

        async function confirmarMoverEtapa() {
            if (!moverEtapaColetaId) {
                showNotification('Nenhuma coleta selecionada para mover.', 'warning');
                return;
            }

            const coleta = coletasData.find(c => c.id === moverEtapaColetaId);
            if (!coleta) {
                showNotification('Coleta não encontrada.', 'error');
                return;
            }

            // ✅ VALIDAÇÃO OBRIGATÓRIA: Não pode sair da etapa contratação sem motorista vinculado
            if (coleta.etapa_atual === 'contratacao' && !coleta.motorista_id) {
                showNotification('⚠️ Para mover uma coleta da etapa Contratação, é necessário vincular um motorista à coleta.', 'warning');
                fecharMoverEtapaModal();
                return;
            }

            const novaEtapaId = document.getElementById('novaEtapaSelect').value;
            if (!novaEtapaId) {
                showNotification('Selecione a nova etapa desejada.', 'warning');
                return;
            }

            // Se a nova etapa for "contas_pagar", solicitar tipo de pagamento
            if (novaEtapaId === 'contas_pagar') {
                etapaPendenteTipoPagamento = novaEtapaId;
                coletaPendenteTipoPagamento = moverEtapaColetaId;
                fecharMoverEtapaModal();
                abrirModalTipoPagamento();
                return;
            }

            await moverEtapa(moverEtapaColetaId, novaEtapaId);
        }

        function abrirModalTipoPagamento() {
            const modal = document.getElementById('modalTipoPagamento');
            if (!modal) {
                console.error('❌ Modal de tipo de pagamento não encontrado');
                showNotification('Erro: Modal não encontrado. Recarregue a página.', 'error');
                return;
            }
            
            const select = document.getElementById('tipoPagamentoSelect');
            if (select) {
                select.value = '';
            }
            
            console.log('📋 Abrindo modal de tipo de pagamento');
            modal.style.display = 'flex';
            
            // Garantir que o modal está visível
            setTimeout(() => {
                if (modal.style.display !== 'flex') {
                    modal.style.display = 'flex';
                }
            }, 100);
        }
        
        // Event listener para fechar modal ao clicar fora (configurado uma vez)
        document.addEventListener('DOMContentLoaded', function() {
            const modalTipoPagamento = document.getElementById('modalTipoPagamento');
            if (modalTipoPagamento) {
                modalTipoPagamento.addEventListener('click', function(e) {
                    if (e.target === modalTipoPagamento) {
                        fecharModalTipoPagamento();
                    }
                });
            }
        });

        function fecharModalTipoPagamento() {
            document.getElementById('modalTipoPagamento').style.display = 'none';
            etapaPendenteTipoPagamento = null;
            coletaPendenteTipoPagamento = null;
        }

        async function confirmarPagamentoContasPagar(coletaId) {
            try {
                const coleta = coletasData.find(c => c.id === coletaId);
                if (!coleta) {
                    showNotification('Coleta não encontrada', 'error');
                    return;
                }

                if (coleta.etapa_atual !== 'contas_pagar') {
                    showNotification('Esta coleta não está na etapa de Contas a Pagar', 'warning');
                    return;
                }

                if (coleta.contas_pagar_pago) {
                    showNotification('Este pagamento já foi confirmado', 'info');
                    return;
                }

                // Confirmar ação
                const confirmar = confirm(`Deseja confirmar o pagamento de ${coleta.contas_pagar_tipo || 'tipo não informado'}?`);
                if (!confirmar) return;

                // Obter informações do usuário atual
                const usuarioNome = currentUser?.nome || currentUser?.username || currentUser?.email || 'Sistema';
                const dataAtual = new Date().toISOString();

                // Atualizar coleta no banco
                const { error } = await supabaseClient
                    .from('coletas')
                    .update({
                        contas_pagar_pago: true,
                        contas_pagar_pago_por: usuarioNome,
                        contas_pagar_data: dataAtual,
                        updated_at: dataAtual
                    })
                    .eq('id', coletaId);

                if (error) throw error;

                // Salvar no histórico
                await salvarNoHistorico(coletaId, 'pagamento_confirmado', 
                    `Pagamento ${coleta.contas_pagar_tipo || ''} confirmado por ${usuarioNome}`
                );

                showNotification('✅ Pagamento confirmado com sucesso!', 'success');

                // Recarregar coletas para atualizar a interface
                await carregarColetas();

                // Recarregar o conteúdo do drawer se estiver aberto
                const drawer = document.getElementById('kanbanDrawer');
                if (drawer && drawer.classList.contains('active')) {
                    await carregarConteudoDrawer(coletaId);
                }

            } catch (error) {
                console.error('❌ Erro ao confirmar pagamento:', error);
                showNotification('Erro ao confirmar pagamento: ' + error.message, 'error');
            }
        }

        async function confirmarTipoPagamento() {
            const tipoPagamento = document.getElementById('tipoPagamentoSelect').value;
            
            if (!tipoPagamento) {
                showNotification('⚠️ Selecione o tipo de pagamento', 'warning');
                return;
            }

            if (!coletaPendenteTipoPagamento || !etapaPendenteTipoPagamento) {
                showNotification('Erro: Dados não encontrados', 'error');
                fecharModalTipoPagamento();
                return;
            }

            const coletaId = coletaPendenteTipoPagamento;
            const novaEtapaId = etapaPendenteTipoPagamento;
            const coleta = coletasData.find(c => c.id === coletaId);
            
            if (!coleta) {
                showNotification('Coleta não encontrada', 'error');
                fecharModalTipoPagamento();
                return;
            }

            // Atualizar etapas_concluidas: adicionar a etapa atual se ainda não estiver
            const etapasConcluidas = Array.isArray(coleta.etapas_concluidas) ? [...coleta.etapas_concluidas] : [];
            if (!etapasConcluidas.includes(coleta.etapa_atual)) {
                etapasConcluidas.push(coleta.etapa_atual);
            }

            const updateData = {
                etapa_atual: novaEtapaId,
                status: 'em_andamento',
                etapas_concluidas: etapasConcluidas,
                contas_pagar_tipo: tipoPagamento
            };

            try {
                currentEditingId = coletaId;
                await salvarColeta(updateData);
                await salvarNoHistorico(coletaId, 'etapa_alterada', 
                    `Etapa alterada para ${obterNomeEtapa(novaEtapaId)}. Tipo de pagamento: ${tipoPagamento}`
                );
                showNotification(`✅ Etapa movida para ${obterNomeEtapa(novaEtapaId)} - Tipo: ${tipoPagamento}`, 'success');
                fecharModalTipoPagamento();
            } catch (error) {
                console.error('❌ Erro ao mover etapa:', error);
                showNotification('Erro ao mover etapa: ' + error.message, 'error');
            } finally {
                currentEditingId = null;
                etapaPendenteTipoPagamento = null;
                coletaPendenteTipoPagamento = null;
            }
        }

        // Função para marcar tipo de pagamento específico como pago (GNRE, PEDÁGIO, etc)
        async function marcarTipoPagamentoEspecifico(coletaId, tipoPagamento) {
            try {
                if (!supabaseClient) {
                    showNotification('Erro: Supabase não inicializado', 'error');
                    return;
                }

                const coleta = coletasData.find(c => c.id === coletaId);
                if (!coleta) {
                    showNotification('Coleta não encontrada', 'error');
                    return;
                }

                if (!temPermissaoEtapa('contas_pagar')) {
                    showNotification('⚠️ Você não tem permissão para marcar como pago nesta etapa', 'warning');
                    return;
                }

                if (!coleta.motorista_id) {
                    showNotification('⚠️ É necessário ter um motorista vinculado para marcar como pago', 'warning');
                    return;
                }

                const confirmacao = confirm(`Confirmar que ${tipoPagamento} foi pago? O motorista e o criador da oportunidade serão notificados.`);
                if (!confirmacao) return;

                const userData = JSON.parse(localStorage.getItem('loggedInUser'));
                const usuarioNome = userData?.nome || userData?.email || 'Usuário';

                // Buscar informações do motorista
                const motorista = await buscarMotoristaPorId(coleta.motorista_id);
                if (!motorista) {
                    showNotification('Erro ao buscar informações do motorista', 'error');
                    return;
                }

                // Atualizar coleta como paga
                const { error: updateError } = await supabaseClient
                    .from('coletas')
                    .update({
                        contas_pagar_pago: true,
                        contas_pagar_data: new Date().toISOString(),
                        contas_pagar_pago_por: usuarioNome,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', coletaId);

                if (updateError) throw updateError;

                // Salvar no histórico
                await salvarNoHistorico(coletaId, 'contas_pagar_pago', 
                    `${tipoPagamento} marcado como pago por ${usuarioNome}`
                );

                // Enviar mensagem para o motorista
                if (motorista.telefone1) {
                    try {
                        const mensagemMotorista = `✅ *${tipoPagamento} PAGO*\n\nOlá ${motorista.nome || 'Motorista'}!\n\nO pagamento ${tipoPagamento} da coleta *${coleta.cliente}* (${coleta.origem} → ${coleta.destino}) foi marcado como realizado.\n\nObrigado pelo seu trabalho! 🚚`;

                        const response = await fetch('/webhook/send-supabase', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                number: motorista.telefone1,
                                message: mensagemMotorista,
                                usuario: userData?.email || currentUser?.email || 'sistema',
                                userId: userData?.id || currentUser?.id || null
                            })
                        });

                        if (!response.ok) {
                            console.warn('⚠️ Erro ao enviar mensagem para motorista');
                        }
                    } catch (msgError) {
                        console.warn('⚠️ Erro ao enviar mensagem:', msgError);
                    }
                }

                showNotification(`✅ ${tipoPagamento} marcado como pago! Motorista e criador da oportunidade foram notificados.`, 'success');

                await carregarColetas();

            } catch (error) {
                console.error('❌ Erro ao marcar tipo de pagamento como pago:', error);
                showNotification('Erro ao marcar como pago: ' + error.message, 'error');
            }
        }

        // Tornar funções globalmente acessíveis
        window.fecharModalTipoPagamento = fecharModalTipoPagamento;
        window.confirmarTipoPagamento = confirmarTipoPagamento;
        window.marcarTipoPagamentoEspecifico = marcarTipoPagamentoEspecifico;

        async function moverEtapa(coletaId, novaEtapaId, tipoPagamento = null) {
            const coleta = coletasData.find(c => c.id === coletaId);
            if (!coleta) return;

            if (!temPermissaoEtapa(coleta.etapa_atual)) {
                showNotification('⚠️ Você não tem permissão para alterar esta etapa', 'warning');
                return;
            }

            if (novaEtapaId === coleta.etapa_atual) {
                showNotification('Selecione uma etapa diferente da atual.', 'info');
                return;
            }

            // ✅ VALIDAÇÃO: Se for mover para contas_pagar, tipo de pagamento é obrigatório
            if (novaEtapaId === 'contas_pagar' && !tipoPagamento) {
                etapaPendenteTipoPagamento = novaEtapaId;
                coletaPendenteTipoPagamento = coletaId;
                abrirModalTipoPagamento();
                return;
            }

            const etapaAtualIndex = ETAPAS.findIndex(e => e.id === coleta.etapa_atual);
            const novaEtapaIndex = ETAPAS.findIndex(e => e.id === novaEtapaId);
            if (novaEtapaIndex === -1) {
                showNotification('Etapa selecionada inválida.', 'error');
                return;
            }

            // ✅ VALIDAÇÃO OBRIGATÓRIA: Não pode sair da etapa contratação sem motorista vinculado
            // Aplica para qualquer movimento (avançar ou voltar) da etapa contratação
            if (coleta.etapa_atual === 'contratacao' && !coleta.motorista_id) {
                showNotification('⚠️ Para mover uma coleta da etapa Contratação, é necessário vincular um motorista à coleta.', 'warning');
                return;
            }

            // ✅ Não pode ir para a etapa GR sem motorista vinculado
            if (novaEtapaId === 'gr' && !coleta.motorista_id) {
                showNotification('⚠️ Para mover para a etapa GR, é necessário vincular um motorista à coleta.', 'warning');
                return;
            }

            // ✅ Só bloqueia se o motorista já foi reprovado NESTA coleta (gr_aprovado === false).
            // Ao mover para a etapa GR, sempre permitir – o GR fará nova avaliação.
            const reprovadoNestaColeta = coleta.gr_aprovado === false || coleta.gr_aprovado === 'false' || coleta.gr_aprovado === 0;
            if (coleta.etapa_atual === 'contratacao' && coleta.motorista_id && reprovadoNestaColeta && novaEtapaId !== 'gr') {
                showNotification('⚠️ O motorista foi reprovado pelo GR nesta coleta. Troque o motorista ou mova para a etapa GR para nova avaliação.', 'warning');
                return;
            }
            
            // ✅ VALIDAÇÃO: Não pode avançar para documentação ou monitoramento sem aprovação no GR
            const etapasQueRequeremAprovacaoGR = ['documentacao', 'monitoramento'];
            if (etapasQueRequeremAprovacaoGR.includes(novaEtapaId)) {
                // Verificar se o motorista foi aprovado no GR
                if (!coleta.motorista_id) {
                    showNotification('⚠️ Para avançar para esta etapa, é necessário ter um motorista vinculado e aprovado no GR.', 'warning');
                    return;
                }
                
                // Verificar se passou pelo GR e foi aprovado
                // Aceitar true, 'true', 1, '1' como aprovado
                const grAprovado = coleta.gr_aprovado === true || 
                                   coleta.gr_aprovado === 'true' || 
                                   coleta.gr_aprovado === 1 || 
                                   coleta.gr_aprovado === '1';
                
                if (!grAprovado) {
                    if (coleta.gr_aprovado === false || coleta.gr_aprovado === 'false' || coleta.gr_aprovado === 0) {
                        showNotification('⚠️ Esta coleta foi reprovada pelo GR. Não é possível avançar para esta etapa. É necessário aprovar o motorista no GR primeiro.', 'warning');
                    } else {
                        showNotification('⚠️ Para avançar para esta etapa, o motorista deve ser aprovado no GR primeiro.', 'warning');
                    }
                    return;
                }
                
                // Verificar também se o motorista não está reprovado para esta coleta
                try {
                    const motorista = await buscarMotoristaPorId(coleta.motorista_id);
                    if (motorista) {
                        // ✅ CORREÇÃO: Passar o objeto coleta completo, não apenas o ID
                        const statusInfo = verificarStatusMotoristaPorColeta(motorista, coleta);
                        console.log('🔍 Status do motorista verificado:', {
                            coleta_id: coleta.id,
                            etapa_atual: coleta.etapa_atual,
                            gr_aprovado: coleta.gr_aprovado,
                            status_motorista: statusInfo.status
                        });
                        
                        if (statusInfo.status === 'reprovado') {
                            showNotification('⚠️ O motorista vinculado está reprovado para esta coleta. Não é possível avançar para esta etapa.', 'warning');
                            return;
                        }
                        // ✅ CORREÇÃO: Se gr_aprovado === true, considerar aprovado mesmo se statusInfo não retornar 'aprovado'
                        // Isso resolve o caso onde o motorista foi aprovado mas a função não detectou corretamente
                        if (statusInfo.status !== 'aprovado' && coleta.gr_aprovado !== true) {
                            showNotification('⚠️ O motorista deve ser aprovado no GR antes de avançar para esta etapa.', 'warning');
                            return;
                        }
                    }
                } catch (err) {
                    console.warn('⚠️ Erro ao verificar status do motorista:', err);
                    showNotification('⚠️ Erro ao verificar status do motorista. Não é possível avançar.', 'warning');
                    return;
                }
            }

            // ✅ VALIDAÇÃO GR: Não pode sair de GR sem aprovação ou reprovação
            if (coleta.etapa_atual === 'gr') {
                // Verificar se GR foi aprovado ou reprovado
                if (coleta.gr_aprovado === null || coleta.gr_aprovado === undefined) {
                    showNotification('⚠️ Para mover uma coleta da etapa GR, é necessário aprovar ou reprovar a coleta primeiro.\n\nUse os botões "Aprovar GR" ou "Reprovar GR" no card da coleta.', 'warning');
                    return;
                }
                
                // Se foi reprovado, não pode avançar (deve estar em contratação)
                if (coleta.gr_aprovado === false) {
                    if (novaEtapaIndex > etapaAtualIndex) {
                        showNotification('⚠️ Esta coleta foi reprovada pelo GR e não pode avançar. Ela deve voltar para a etapa de Contratação.', 'warning');
                    return;
                    }
                }
                
                // Se foi aprovado, permite avançar para documentação ou outras etapas via automações
                if (coleta.gr_aprovado === true) {
                    // Permitir movimento para documentacao sempre
                    if (novaEtapaId === 'documentacao') {
                        // Permitir - não bloquear
                    }
                    // Se não for documentacao, permitir também (automações podem direcionar)
                    // Não bloquear aqui - as automações irão decidir
                    
                    // Não permitir voltar se foi aprovado (exceto para contratação)
                    if (novaEtapaIndex < etapaAtualIndex) {
                        if (novaEtapaId !== 'contratacao') {
                            showNotification('⚠️ Coleta já foi aprovada no GR. Não é possível voltar para esta etapa.', 'warning');
                        return;
                        }
                    }
                }
            }

            // Atualizar etapas_concluidas: adicionar a etapa atual se ainda não estiver
            const etapasConcluidas = Array.isArray(coleta.etapas_concluidas) ? [...coleta.etapas_concluidas] : [];
            if (!etapasConcluidas.includes(coleta.etapa_atual)) {
                etapasConcluidas.push(coleta.etapa_atual);
            }

            const updateData = {
                etapa_atual: novaEtapaId,
                status: novaEtapaId === 'finalizar_operacao' ? 'concluida' : 'em_andamento',
                etapas_concluidas: etapasConcluidas
            };

            // ✅ Adicionar tipo de pagamento se for contas_pagar
            if (novaEtapaId === 'contas_pagar' && tipoPagamento) {
                updateData.contas_pagar_tipo = tipoPagamento;
            }

            try {
                currentEditingId = coletaId;
                await salvarColeta(updateData);
                const detalhesHistorico = tipoPagamento 
                    ? `Etapa alterada de ${obterNomeEtapa(coleta.etapa_atual)} para ${obterNomeEtapa(novaEtapaId)}. Tipo de pagamento: ${tipoPagamento}`
                    : `Etapa alterada de ${obterNomeEtapa(coleta.etapa_atual)} para ${obterNomeEtapa(novaEtapaId)}`;
                await salvarNoHistorico(coletaId, 'etapa_alterada', detalhesHistorico);
                showNotification(`Etapa movida para ${obterNomeEtapa(novaEtapaId)}${tipoPagamento ? ` - Tipo: ${tipoPagamento}` : ''}`, 'success');
                fecharMoverEtapaModal();
                
                // Atualizar Kanban se estiver visível
                const kanbanContainer = document.getElementById('kanbanContainer');
                if (kanbanContainer && kanbanContainer.style.display !== 'none') {
                    await carregarColetas(); // Isso vai atualizar o Kanban automaticamente
                }
            } catch (error) {
                console.error('❌ Erro ao mover etapa:', error);
                showNotification('Erro ao mover etapa: ' + error.message, 'error');
            } finally {
                currentEditingId = null;
            }
        }

        // ✅ Funções para gerenciar multi-select
        const multiSelectValues = {
            statusFilter: [],
            etapaFilter: [],
            filialFilter: []
        };

        function toggleMultiSelect(filterId) {
            // Adicionar sufixo 'Button' se não tiver
            const buttonId = filterId.includes('Button') ? filterId : `${filterId}Button`;
            const button = document.getElementById(buttonId);
            if (!button) {
                console.warn(`⚠️ Botão não encontrado: ${buttonId}`);
                return;
            }
            
            const wrapper = button.closest('.multi-select-wrapper');
            if (!wrapper) {
                console.warn(`⚠️ Wrapper não encontrado para: ${buttonId}`);
                return;
            }
            
            const isActive = wrapper.classList.contains('active');
            
            // Fechar todos os outros multi-selects
            document.querySelectorAll('.multi-select-wrapper').forEach(w => {
                if (w !== wrapper) {
                    w.classList.remove('active');
                }
            });
            
            // Toggle do atual
            wrapper.classList.toggle('active', !isActive);
        }
        
        // Expor função globalmente para uso em inline handlers
        window.toggleMultiSelect = toggleMultiSelect;

        function updateMultiSelect(filterId, checkbox) {
            const value = checkbox.value;
            // Extrair o filterKey do ID do checkbox (ex: statusFilterOptions -> statusFilter)
            let filterKey = filterId;
            if (filterKey.includes('Options')) {
                filterKey = filterKey.replace('Options', '');
            } else if (filterKey.includes('Button')) {
                filterKey = filterKey.replace('Button', '');
            } else if (filterKey.includes('Dropdown')) {
                filterKey = filterKey.replace('Dropdown', '');
            }
            
            // Garantir que o filterKey existe no objeto
            if (!multiSelectValues.hasOwnProperty(filterKey)) {
                console.warn(`⚠️ FilterKey não encontrado: ${filterKey}`);
                return;
            }
            
            if (value === '') {
                // Se "Todos" foi clicado, desmarcar todos os outros e marcar apenas "Todos"
                if (checkbox.checked) {
                    const options = document.querySelectorAll(`#${filterKey}Options input[type="checkbox"]`);
                    options.forEach(opt => {
                        if (opt !== checkbox) opt.checked = false;
                    });
                    multiSelectValues[filterKey] = [];
                } else {
                    // Não permitir desmarcar "Todos" se for o único selecionado
                    checkbox.checked = true;
                    return;
                }
            } else {
                // Se outro item foi clicado, desmarcar "Todos"
                const todosCheckbox = document.querySelector(`#${filterKey}Options input[value=""]`);
                if (todosCheckbox) todosCheckbox.checked = false;
                
                if (checkbox.checked) {
                    if (!multiSelectValues[filterKey].includes(value)) {
                        multiSelectValues[filterKey].push(value);
                    }
                } else {
                    multiSelectValues[filterKey] = multiSelectValues[filterKey].filter(v => v !== value);
                }
                
                // Se nenhum item específico estiver selecionado, marcar "Todos"
                if (multiSelectValues[filterKey].length === 0) {
                    if (todosCheckbox) todosCheckbox.checked = true;
                }
            }
            
            updateMultiSelectText(filterKey);
            filterColetas();
        }
        
        // Expor função globalmente para uso em inline handlers
        window.updateMultiSelect = updateMultiSelect;

        function updateMultiSelectText(filterKey) {
            const values = multiSelectValues[filterKey];
            const textElement = document.getElementById(`${filterKey}Text`);
            
            if (!textElement) return;
            
            if (values.length === 0) {
                // Mostrar texto padrão
                const labels = {
                    statusFilter: 'Todos os Status',
                    etapaFilter: 'Todas as Etapas',
                    filialFilter: 'Todas as Filiais'
                };
                textElement.textContent = labels[filterKey] || 'Todos';
            } else if (values.length === 1) {
                // Mostrar o nome do item selecionado
                const option = document.querySelector(`#${filterKey}Options input[value="${values[0]}"]`);
                if (option) {
                    const label = option.closest('label').querySelector('span');
                    textElement.textContent = label ? label.textContent : values[0];
                } else {
                    textElement.textContent = values[0];
                }
            } else {
                // Mostrar quantidade selecionada
                textElement.textContent = `${values.length} selecionado(s)`;
            }
        }

        function filterMultiSelectOptions(input, filterKey) {
            const searchTerm = input.value.toLowerCase();
            // Se filterKey já inclui 'Options', usar diretamente; caso contrário, adicionar
            const optionsId = filterKey.includes('Options') ? filterKey : `${filterKey}Options`;
            const options = document.querySelectorAll(`#${optionsId} .multi-select-option`);
            
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    option.classList.remove('hidden');
                } else {
                    option.classList.add('hidden');
                }
            });
        }

        // Fechar multi-selects ao clicar fora
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.multi-select-wrapper')) {
                document.querySelectorAll('.multi-select-wrapper').forEach(w => {
                    w.classList.remove('active');
                });
            }
        });

        // Tornar funções globalmente acessíveis
        window.toggleMultiSelect = toggleMultiSelect;
        window.updateMultiSelect = updateMultiSelect;
        window.filterMultiSelectOptions = filterMultiSelectOptions;
        window.alternarVisualizacao = alternarVisualizacao;
        window.abrirKanbanDrawer = abrirKanbanDrawer;
        window.fecharKanbanDrawer = fecharKanbanDrawer;
        window.trocarTabDrawer = trocarTabDrawer;
        window.handleDrawerUploadAnexo = handleDrawerUploadAnexo;
        window.abrirModalEtiquetas = abrirModalEtiquetas;
        window.avancarEtapa = avancarEtapa;
        window.voltarEtapa = voltarEtapa;
        window.excluirColeta = excluirColeta;
        window.aprovarGR = aprovarGR;
        window.reprovarGR = reprovarGR;
        window.moverParaEtapaDrawer = moverParaEtapaDrawer;
        window.moverEtapa = moverEtapa;
        window.vincularMotorista = vincularMotorista;
        window.fecharModalMotorista = fecharModalMotorista;
        window.filtrarMotoristas = filtrarMotoristas;
        window.selecionarMotorista = selecionarMotorista;
        window.trocarMotorista = trocarMotorista;
        window.reprovarMotorista = reprovarMotorista;
        window.verDetalhesMotorista = verDetalhesMotorista;

        async function filterColetas() {
            // ✅ PAGINAÇÃO: Resetar para primeira página ao filtrar
            paginaAtual = 1;
            
            // ✅ Obter valores selecionados dos multi-selects
            const statusFilters = multiSelectValues.statusFilter.length > 0 ? multiSelectValues.statusFilter : null;
            const etapaFilters = multiSelectValues.etapaFilter.length > 0 ? multiSelectValues.etapaFilter : null;
            const filialFilters = multiSelectValues.filialFilter.length > 0 ? multiSelectValues.filialFilter : null;
            
            const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;

            if (window.DEBUG || window.location.hostname === 'localhost') {
            console.log('🔍 Aplicando filtros:', {
                dataInicio,
                dataFim,
                    statusFilters,
                    etapaFilters,
                    filialFilters,
                searchFilter
            });
            }

            // ✅ FILTRAR APENAS COLETAS NÃO ARQUIVADAS
            const coletasParaFiltrar = window.coletasAtivas || coletasData.filter(c => !c.arquivado);
            
            const filtered = coletasParaFiltrar.filter(coleta => {
                // ✅ Filtro de arquivado - garantir que nunca apareçam coletas arquivadas
                if (coleta.arquivado) {
                    return false;
                }

                // ✅ Filtro de status (múltiplas seleções)
                if (statusFilters && statusFilters.length > 0) {
                    if (!statusFilters.includes(coleta.status)) {
                        if (window.DEBUG || window.location.hostname === 'localhost') {
                            console.log(`❌ Filtrado por status: ${coleta.status} não está em [${statusFilters.join(', ')}]`);
                        }
                    return false;
                    }
                }

                // ✅ Filtro de etapa (múltiplas seleções)
                if (etapaFilters && etapaFilters.length > 0) {
                    if (!etapaFilters.includes(coleta.etapa_atual)) {
                        if (window.DEBUG || window.location.hostname === 'localhost') {
                            console.log(`❌ Filtrado por etapa: ${coleta.etapa_atual} não está em [${etapaFilters.join(', ')}]`);
                        }
                    return false;
                    }
                }

                // ✅ Filtro de filial (múltiplas seleções)
                if (filialFilters && filialFilters.length > 0) {
                    if (!filialFilters.includes(coleta.filial)) {
                        if (window.DEBUG || window.location.hostname === 'localhost') {
                            console.log(`❌ Filtrado por filial: ${coleta.filial} não está em [${filialFilters.join(', ')}]`);
                        }
                    return false;
                    }
                }

                // Filtro de busca
                if (searchFilter) {
                    const searchableText = `${coleta.cliente || ''} ${coleta.origem || ''} ${coleta.destino || ''} ${coleta.numero_coleta || ''} ${coleta.filial || ''}`.toLowerCase();
                    if (!searchableText.includes(searchFilter)) {
                        console.log(`❌ Filtrado por busca: "${searchableText}" não contém "${searchFilter}"`);
                        return false;
                    }
                }

                // ✅ CORREÇÃO: Filtro de datas - usando o campo correto
                if (dataInicio || dataFim) {
                    // Campo correto: data_recebimento (snake_case)
                    const dataColeta = coleta.data_recebimento || coleta.dataRecebimento;
                    
                    if (!dataColeta) {
                        console.log(`❌ Coleta sem data: ${coleta.id}`);
                        return false;
                    }

                    // Converter para Date para comparação
                    // Se já é uma string ISO, usar diretamente; se não, adicionar horário
                    let dataColetaObj;
                    if (typeof dataColeta === 'string') {
                        // Se já tem horário (ISO format), usar diretamente
                        if (dataColeta.includes('T') || dataColeta.includes(' ')) {
                            dataColetaObj = new Date(dataColeta);
                        } else {
                            // Se é apenas data (YYYY-MM-DD), adicionar horário
                            dataColetaObj = new Date(dataColeta + 'T00:00:00');
                        }
                    } else {
                        dataColetaObj = new Date(dataColeta);
                    }
                    
                    const inicioObj = dataInicio ? new Date(dataInicio + 'T00:00:00') : null;
                    const fimObj = dataFim ? new Date(dataFim + 'T23:59:59') : null; // Fim do dia

                    // Validar se as datas são válidas
                    if (isNaN(dataColetaObj.getTime())) {
                        console.log(`❌ Data inválida na coleta: ${coleta.id}, data: ${dataColeta}`);
                        return false;
                    }

                    console.log(`📅 Comparando datas: Coleta=${dataColetaObj.toISOString()}, Início=${inicioObj?.toISOString()}, Fim=${fimObj?.toISOString()}`);

                    // Filtro data início
                    if (dataInicio && inicioObj && dataColetaObj < inicioObj) {
                        console.log(`❌ Filtrado por data início: ${dataColetaObj.toISOString()} < ${inicioObj.toISOString()}`);
                        return false;
                    }

                    // Filtro data fim
                    if (dataFim && fimObj && dataColetaObj > fimObj) {
                        console.log(`❌ Filtrado por data fim: ${dataColetaObj.toISOString()} > ${fimObj.toISOString()}`);
                        return false;
                    }
                }

                if (window.DEBUG || window.location.hostname === 'localhost') {
                console.log(`✅ Coleta ${coleta.id} passou nos filtros`);
                }
                return true;
            });

            console.log(`📊 Resultado: ${filtered.length} de ${coletasData.length} coletas`);
            await renderColetasWrapper(filtered);
        }
        
        // Expor filterColetas globalmente para uso em inline handlers
        window.filterColetas = filterColetas;
        
        // Funções setQuickDate e clearDateFilters já estão definidas acima (linhas ~2939 e ~2926)

        function updateStats(data = coletasData) {
            // Função para calcular valor total de um conjunto de coletas
            const calcularValorTotal = (coletas) => {
                return coletas.reduce((total, coleta) => {
                    const valor = parseFloat(coleta.valor) || 0;
                    return total + valor;
                }, 0);
            };

            // Função para formatar valor em moeda brasileira
            const formatarMoeda = (valor) => {
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL',
                    minimumFractionDigits: 2
                }).format(valor);
            };

            // Filtrar coletas por status
            const pendentes = data.filter(c => c.status === 'pendente');
            const emAndamento = data.filter(c => c.status === 'em_andamento');
            const concluidas = data.filter(c => c.status === 'concluida');
            const canceladas = data.filter(c => c.status === 'cancelada');

            // Atualizar Total
            const totalCount = data.length;
            const totalValor = calcularValorTotal(data);
            document.getElementById('totalColetas').textContent = totalCount;
            document.getElementById('totalColetasValor').textContent = formatarMoeda(totalValor);

            // Atualizar Pendentes
            const pendentesCount = pendentes.length;
            const pendentesValor = calcularValorTotal(pendentes);
            document.getElementById('pendentesCount').textContent = pendentesCount;
            document.getElementById('pendentesValor').textContent = formatarMoeda(pendentesValor);

            // Atualizar Em Andamento
            const andamentoCount = emAndamento.length;
            const andamentoValor = calcularValorTotal(emAndamento);
            document.getElementById('andamentoCount').textContent = andamentoCount;
            document.getElementById('andamentoValor').textContent = formatarMoeda(andamentoValor);

            // Atualizar Concluídas
            const concluidasCount = concluidas.length;
            const concluidasValor = calcularValorTotal(concluidas);
            document.getElementById('concluidasCount').textContent = concluidasCount;
            document.getElementById('concluidasValor').textContent = formatarMoeda(concluidasValor);

            // Atualizar Canceladas
            const canceladasCount = canceladas.length;
            
            // Atualizar funil geral se estiver visível (apenas quando a aba Funil Geral estiver ativa)
            const funilContainer = document.getElementById('funilGeralContainer');
            if (funilContainer && funilContainer.classList.contains('visible') && paginaAtivaKanban === 'funil_geral') {
                renderizarFunilGeral();
            }
            const canceladasValor = calcularValorTotal(canceladas);
            document.getElementById('canceladasCount').textContent = canceladasCount;
            document.getElementById('canceladasValor').textContent = formatarMoeda(canceladasValor);
        }

        // Funções utilitárias
        function generateId() {
            // Gerar UUID v4 válido
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        function getStatusText(status) {
            const statusMap = {
                'pendente': 'Pendente',
                'em_andamento': 'Em Andamento',
                'concluida': 'Concluída',
                'cancelada': 'Cancelada'
            };
            return statusMap[status] || status;
        }

        function formatarData(dataString) {
            const data = new Date(dataString);
            return data.toLocaleDateString('pt-BR');
        }

        function formatarHora(dataString) {
            const data = new Date(dataString);
            return data.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
        }

        function formatarDataParaInput(data) {
            return data.toISOString().split('T')[0];
        }

        function toggleCardExpand(button) {
            const card = button.closest('.coleta-card');
            if (card) {
                card.classList.toggle('collapsed');
                card.classList.toggle('expanded');
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 4000);
        }

        function getFileIcon(fileType) {
            const icons = {
                'pdf': 'fa-file-pdf',
                'excel': 'fa-file-excel',
                'image': 'fa-image',
                'word': 'fa-file-word',
                'default': 'fa-file'
            };
            
            if (fileType.includes('pdf')) return icons.pdf;
            if (fileType.includes('spreadsheet') || fileType.includes('excel')) return icons.excel;
            if (fileType.includes('image')) return icons.image;
            if (fileType.includes('word') || fileType.includes('document')) return icons.word;
            return icons.default;
        }

        function getFileIconClass(fileType) {
            const classes = {
                'pdf': 'text-danger',
                'excel': 'text-success',
                'image': 'text-info',
                'word': 'text-primary',
                'default': 'text-secondary'
            };
            
            if (fileType.includes('pdf')) return classes.pdf;
            if (fileType.includes('spreadsheet') || fileType.includes('excel')) return classes.excel;
            if (fileType.includes('image')) return classes.image;
            if (fileType.includes('word') || fileType.includes('document')) return classes.word;
            return classes.default;
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function handleFileSelect(files) {
            selectedFiles = Array.from(files);
            const filesList = document.getElementById('filesList');
            if (!filesList) return;
            
            filesList.innerHTML = '';
            
            // Verificar se categoria foi selecionada
            const categoriaSelect = document.getElementById('anexoCategoriaSelect');
            const categoriaSelecionada = categoriaSelect ? categoriaSelect.value : '';
            
            if (selectedFiles.length > 0 && !categoriaSelecionada) {
                showNotification('⚠️ Selecione uma categoria antes de enviar os arquivos', 'warning');
            }
            
            selectedFiles.forEach((file, index) => {
                const fileType = file.type;
                const fileElement = document.createElement('div');
                fileElement.className = 'file-item';
                fileElement.innerHTML = `
                    <div class="file-info">
                        <div class="file-icon ${getFileIconClass(fileType)}">
                            <i class="fas ${getFileIcon(fileType)}"></i>
                        </div>
                        <div class="file-details">
                            <div class="file-name">${file.name}</div>
                            <div class="file-size">${formatFileSize(file.size)}</div>
                            ${categoriaSelecionada ? `
                                <div style="font-size: 0.75rem; color: #667eea; margin-top: 0.25rem;">
                                    <i class="fas fa-folder"></i> ${obterNomeCategoria(categoriaSelecionada)}
                                </div>
                            ` : ''}
                        </div>
                    </div>
                    <button class="file-remove" onclick="removerArquivo(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                filesList.appendChild(fileElement);
            });
            
            const selectedFilesDiv = document.getElementById('selectedFiles');
            if (selectedFilesDiv) {
                selectedFilesDiv.style.display = 'block';
            }
            
            // Atualizar estado do botão de upload
            const btnUpload = document.getElementById('btnUpload');
            if (btnUpload) {
                btnUpload.disabled = selectedFiles.length === 0 || !categoriaSelecionada;
            }
        }
        
        // Função para obter nome amigável da categoria
        function obterNomeCategoria(categoria) {
            const categorias = {
                'canhoto': 'Canhoto (comprovante de entrega)',
                'documentos_motorista': 'Documentos do Motorista',
                'documentos_proprietario': 'Documentos do Proprietário',
                'documentos_veiculo': 'Documentos do Veículo',
                'evidencias': 'Evidências',
                'faturamento': 'Faturamento',
                'notas_fiscais': 'Notas Fiscais',
                'contratos': 'Contratos',
                'outros': 'Outros'
            };
            return categorias[categoria] || categoria;
        }
        
        // Função para obter ícone da categoria
        function obterIconeCategoria(categoria) {
            const icones = {
                'canhoto': 'fa-file-signature',
                'documentos_motorista': 'fa-user',
                'documentos_proprietario': 'fa-building',
                'documentos_veiculo': 'fa-truck',
                'evidencias': 'fa-camera',
                'faturamento': 'fa-money-bill',
                'notas_fiscais': 'fa-file-invoice',
                'contratos': 'fa-file-contract',
                'outros': 'fa-folder'
            };
            return icones[categoria] || 'fa-folder';
        }
        
        // Função para obter cor da categoria
        function obterCorCategoria(categoria) {
            const cores = {
                'canhoto': '#059669',
                'documentos_motorista': '#28a745',
                'documentos_proprietario': '#667eea',
                'documentos_veiculo': '#ffc107',
                'evidencias': '#dc3545',
                'faturamento': '#17a2b8',
                'notas_fiscais': '#6f42c1',
                'contratos': '#fd7e14',
                'outros': '#6c757d'
            };
            return cores[categoria] || '#6c757d';
        }

        function removerArquivo(index) {
            selectedFiles.splice(index, 1);
            
            // Recriar a lista de arquivos
            const filesList = document.getElementById('filesList');
            if (filesList) {
                filesList.innerHTML = '';
                
                const categoriaSelect = document.getElementById('anexoCategoriaSelect');
                const categoriaSelecionada = categoriaSelect ? categoriaSelect.value : '';
                
                selectedFiles.forEach((file, idx) => {
                    const fileType = file.type;
                    const fileElement = document.createElement('div');
                    fileElement.className = 'file-item';
                    fileElement.innerHTML = `
                        <div class="file-info">
                            <div class="file-icon ${getFileIconClass(fileType)}">
                                <i class="fas ${getFileIcon(fileType)}"></i>
                            </div>
                            <div class="file-details">
                                <div class="file-name">${file.name}</div>
                                <div class="file-size">${formatFileSize(file.size)}</div>
                                ${categoriaSelecionada ? `
                                    <div style="font-size: 0.75rem; color: #667eea; margin-top: 0.25rem;">
                                        <i class="fas fa-folder"></i> ${obterNomeCategoria(categoriaSelecionada)}
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <button class="file-remove" onclick="removerArquivo(${idx})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    filesList.appendChild(fileElement);
                });
            }
            
            if (selectedFiles.length === 0) {
                const selectedFilesDiv = document.getElementById('selectedFiles');
                if (selectedFilesDiv) {
                    selectedFilesDiv.style.display = 'none';
                }
            }
            
            // Atualizar estado do botão
            const btnUpload = document.getElementById('btnUpload');
            const categoriaSelect = document.getElementById('anexoCategoriaSelect');
            const categoriaSelecionada = categoriaSelect ? categoriaSelect.value : '';
            if (btnUpload) {
                btnUpload.disabled = selectedFiles.length === 0 || !categoriaSelecionada;
            }
        }

        // ✅ Função auxiliar para escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        // ✅ Função para carregar ITs relacionadas ao cliente
        async function carregarITsRelacionadas(coletaId, nomeCliente, filialColeta = null) {
            try {
                // Construir URL com query parameter de filial se disponível
                let url = `/api/clientes/nome/${encodeURIComponent(nomeCliente)}/its`;
                if (filialColeta) {
                    url += `?filial=${encodeURIComponent(filialColeta)}`;
                }
                
                const response = await fetch(url, {
                    credentials: 'include'
                });
                
                if (!response.ok) {
                    console.warn('⚠️ Erro ao carregar ITs do cliente:', response.statusText);
                    const itsContent = document.getElementById(`its-content-${coletaId}`);
                    if (itsContent) {
                        itsContent.innerHTML = '<div style="text-align: center; color: #6c757d; font-size: 0.8rem; padding: 1rem;">Nenhuma IT relacionada encontrada</div>';
                    }
                    return;
                }
                
                const result = await response.json();
                const itsContent = document.getElementById(`its-content-${coletaId}`);
                
                if (!itsContent) return;
                
                if (!result.success || !result.its || result.its.length === 0) {
                    itsContent.innerHTML = `
                        <div style="text-align: center; color: #6c757d; font-size: 0.8rem; padding: 1rem;">
                            <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
                            Nenhuma IT relacionada encontrada para este cliente${filialColeta ? ` na filial ${filialColeta}` : ''}
                        </div>
                    `;
                    return;
                }
                
                // Renderizar ITs
                itsContent.innerHTML = `
                    <div style="display: flex; flex-direction: column; gap: 0.75rem;">
                        ${result.its.map(it => `
                            <div style="background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%); padding: 0.75rem; border-radius: 8px; border-left: 3px solid #667eea;">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                    <div style="flex: 1;">
                                        <div style="font-weight: 600; color: #667eea; margin-bottom: 0.25rem;">
                                            ${it.codigo_it ? `<span style="font-size: 0.75rem; background: #667eea; color: white; padding: 0.2rem 0.5rem; border-radius: 4px; margin-right: 0.5rem;">${it.codigo_it}</span>` : ''}
                                            ${escapeHtml(it.nome)}
                                        </div>
                                        ${it.area ? `<div style="font-size: 0.75rem; color: #6c757d; margin-top: 0.25rem;"><i class="fas fa-building"></i> ${escapeHtml(it.area)}</div>` : ''}
                                        ${it.operacao ? `<div style="font-size: 0.75rem; color: #6c757d; margin-top: 0.25rem;"><i class="fas fa-cog"></i> ${escapeHtml(it.operacao.replace('operacoes_', 'Operações - ').replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()))}</div>` : ''}
                                    </div>
                                </div>
                                <div style="display: flex; gap: 0.5rem; margin-top: 0.5rem;">
                                    <a href="${it.url}" target="_blank" 
                                       onclick="event.stopPropagation();"
                                       style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 0.4rem 0.8rem; border-radius: 6px; text-decoration: none; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.4rem; transition: transform 0.2s;"
                                       onmouseover="this.style.transform='translateY(-2px)'"
                                       onmouseout="this.style.transform='translateY(0)'">
                                        <i class="fas fa-eye"></i> Visualizar
                                    </a>
                                    <a href="${it.url}" download="${it.nome_arquivo || 'it.pdf'}"
                                       onclick="event.stopPropagation();"
                                       style="background: transparent; color: #667eea; border: 1px solid #667eea; padding: 0.4rem 0.8rem; border-radius: 6px; text-decoration: none; font-size: 0.75rem; font-weight: 600; display: inline-flex; align-items: center; gap: 0.4rem; transition: all 0.2s;"
                                       onmouseover="this.style.background='#667eea'; this.style.color='white'"
                                       onmouseout="this.style.background='transparent'; this.style.color='#667eea'">
                                        <i class="fas fa-download"></i> Baixar
                                    </a>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            } catch (error) {
                console.error('❌ Erro ao carregar ITs relacionadas:', error);
                const itsContent = document.getElementById(`its-content-${coletaId}`);
                if (itsContent) {
                    itsContent.innerHTML = '<div style="text-align: center; color: #dc3545; font-size: 0.8rem; padding: 1rem;">Erro ao carregar ITs</div>';
                }
            }
        }

        // Funções de fechar modais
        function closeModal() {
            document.getElementById('coletaModal').classList.remove('active');
            currentEditingId = null;
            // Limpar seleção de classe e tipos quando fechar o modal
            const classeSelect = document.getElementById('classeVeiculo');
            if (classeSelect) {
                classeSelect.value = '';
                atualizarTiposVeiculoECarroceria();
            }
        }

        function closeAnexosModal() {
            document.getElementById('anexosModal').classList.remove('active');
            currentAnexosColetaId = null;
        }

        function closeChatModal() {
            document.getElementById('chatModal').classList.remove('active');
            currentChatColetaId = null;
            
            const chatInput = document.getElementById('chatInput');
            chatInput.value = '';
            chatInput.style.height = 'auto';
            document.getElementById('chatSend').disabled = true;
        }

        // Modal de Histórico Completo
        // Função auxiliar para processar detalhes e substituir IDs de motorista por nome e telefone
        async function processarDetalhesComMotorista(detalhes) {
            if (!detalhes) return detalhes;
            
            // Regex para encontrar IDs de motorista (UUIDs)
            const motoristaIdRegex = /([a-f0-9]{8}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{4}-[a-f0-9]{12})/gi;
            const idsEncontrados = detalhes.match(motoristaIdRegex);
            
            if (!idsEncontrados) return detalhes;
            
            let detalhesProcessados = detalhes;
            
            // Processar cada ID único
            const idsUnicos = [...new Set(idsEncontrados)];
            for (const motoristaId of idsUnicos) {
                try {
                    const motorista = await buscarMotoristaPorId(motoristaId);
                    if (motorista) {
                        const nome = motorista.nome || 'Motorista desconhecido';
                        const telefone = motorista.telefone1 || motorista.telefone2 || '';
                        const infoMotorista = telefone ? `${nome} (${telefone})` : nome;
                        detalhesProcessados = detalhesProcessados.replace(new RegExp(motoristaId, 'g'), infoMotorista);
                    }
                } catch (error) {
                    console.warn(`⚠️ Erro ao buscar motorista ${motoristaId}:`, error);
                    // Manter o ID se não conseguir buscar
                }
            }
            
            return detalhesProcessados;
        }

        async function abrirModalHistoricoCompleto(coletaId) {
            try {
                document.getElementById('modalHistoricoCompleto').style.display = 'flex';
                document.getElementById('conteudoHistoricoCompleto').innerHTML = '<div style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin fa-2x"></i><p style="margin-top: 1rem;">Carregando histórico...</p></div>';
                
                // Buscar dados da coleta para obter o número da OC
                const { data: coleta, error: coletaError } = await supabaseClient
                    .from('coletas')
                    .select('id, filial, numero_coleta, cliente')
                    .eq('id', coletaId)
                    .single();
                
                const numeroOC = coleta?.numero_coleta ? `${coleta.filial || ''} #${coleta.numero_coleta}`.trim() : null;
                
                let historico = [];
                
                // Buscar histórico da tabela historico_movimentacoes (prioritária)
                // ✅ OTIMIZAÇÃO: Selecionar apenas campos necessários
                const { data: dataMov, error: errorMov } = await supabaseClient
                    .from('historico_movimentacoes')
                    .select('acao, usuario_nome, detalhes, created_at')
                    .eq('coleta_id', coletaId)
                    .order('created_at', { ascending: false });

                if (errorMov) {
                    console.warn('⚠️ Erro ao buscar historico_movimentacoes:', errorMov);
                } else if (dataMov && dataMov.length > 0) {
                    // Processar cada item do histórico para substituir IDs de motorista
                    historico = await Promise.all(dataMov.map(async (mov) => {
                        const detalhesProcessados = await processarDetalhesComMotorista(mov.detalhes || '');
                        return {
                        acao: mov.acao || 'Movimentação',
                        usuario_nome: mov.usuario_nome || 'Sistema',
                            detalhes: detalhesProcessados,
                        created_at: mov.created_at
                        };
                    }));
                }

                // Se não encontrou nada, buscar também de historico_coletas (compatibilidade)
                if (historico.length === 0) {
                    // ✅ OTIMIZAÇÃO: Selecionar apenas campos necessários
                    const { data: dataColetas, error: errorColetas } = await supabaseClient
                        .from('historico_coletas')
                        .select('acao, usuario, detalhes, created_at')
                        .eq('coleta_id', coletaId)
                        .order('created_at', { ascending: false });

                    if (errorColetas) {
                        console.warn('⚠️ Erro ao buscar historico_coletas:', errorColetas);
                    } else if (dataColetas && dataColetas.length > 0) {
                        // Processar cada item do histórico para substituir IDs de motorista
                        historico = await Promise.all(dataColetas.map(async (h) => {
                            const detalhesProcessados = await processarDetalhesComMotorista(h.detalhes || '');
                            return {
                            acao: h.acao || 'Movimentação',
                            usuario_nome: h.usuario || 'Sistema',
                                detalhes: detalhesProcessados,
                            created_at: h.created_at
                            };
                        }));
                    }
                }

                const historicoDiv = document.getElementById('conteudoHistoricoCompleto');
                
                if (historico.length > 0) {
                    // Ordenar por data mais recente primeiro
                    historico.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    
                    historicoDiv.innerHTML = `
                        ${numeroOC ? `
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
                                <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem; font-weight: 600;">
                                    <i class="fas fa-hashtag"></i>
                                    <span>OC: ${numeroOC}</span>
                                </div>
                            </div>
                        ` : ''}
                        <div style="display: grid; gap: 1rem;">
                            ${historico.map(mov => `
                                <div style="padding: 1rem; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-radius: 12px; border-left: 4px solid #667eea; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
                                        <div>
                                            <strong style="color: #667eea; font-size: 1rem;">${getTextoAcao(mov.acao) || mov.acao || 'Movimentação'}</strong>
                                        </div>
                                        <small style="color: #666;">${formatarDataHora(mov.created_at)}</small>
                                    </div>
                                    <div style="color: #333; font-size: 0.9rem; margin-bottom: 0.5rem;">
                                        <i class="fas fa-user"></i> ${mov.usuario_nome || 'Sistema'}
                                    </div>
                                    ${mov.detalhes ? `
                                        <div style="background: white; padding: 0.8rem; border-radius: 8px; margin-top: 0.5rem; font-style: italic; color: #555; border-left: 3px solid #667eea;">
                                            ${mov.detalhes}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    historicoDiv.innerHTML = `
                        ${numeroOC ? `
                            <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);">
                                <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 1.1rem; font-weight: 600;">
                                    <i class="fas fa-hashtag"></i>
                                    <span>OC: ${numeroOC}</span>
                                </div>
                            </div>
                        ` : ''}
                        <div style="text-align: center; padding: 3rem; color: #999;">
                            <i class="fas fa-inbox fa-3x" style="margin-bottom: 1rem; opacity: 0.5;"></i>
                            <p style="font-size: 1.1rem;">Nenhuma movimentação registrada</p>
                            <p style="font-size: 0.9rem;">O histórico desta coleta aparecerá aqui</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('❌ Erro ao carregar histórico completo:', error);
                document.getElementById('conteudoHistoricoCompleto').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #dc3545;">
                        <i class="fas fa-exclamation-circle fa-2x"></i>
                        <p style="margin-top: 1rem;">Erro ao carregar histórico: ${error.message}</p>
                    </div>
                `;
            }
        }

        function fecharModalHistoricoCompleto() {
            document.getElementById('modalHistoricoCompleto').style.display = 'none';
        }

        // Event listeners para fechar modais ao clicar fora
        document.getElementById('coletaModal').addEventListener('click', function(e) {
            if (e.target === this) closeModal();
        });

        document.getElementById('anexosModal').addEventListener('click', function(e) {
            if (e.target === this) closeAnexosModal();
        });

        document.getElementById('chatModal').addEventListener('click', function(e) {
            if (e.target === this) closeChatModal();
        });

        document.getElementById('modalHistoricoCompleto').addEventListener('click', function(e) {
            if (e.target === this) {
                fecharModalHistoricoCompleto();
            }
        });
        
        document.getElementById('moverEtapaModal').addEventListener('click', function(e) {
            if (e.target === this) {
                fecharMoverEtapaModal();
            }
        });

        // Função para mostrar erro
        function mostrarErro(mensagem) {
            showNotification(mensagem, 'error');
        }

        // ========== PARTÍCULAS ANIMADAS ==========
        const canvas = document.createElement('canvas');
        canvas.id = 'particlesCanvas';
        canvas.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 0; opacity: 0.6;';
        document.body.insertBefore(canvas, document.body.firstChild);

        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        let particles = [];
        const particleCount = 80;

        class Particle {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 3 + 1;
                this.speedX = Math.random() * 2 - 1;
                this.speedY = Math.random() * 2 - 1;
                this.opacity = Math.random() * 0.5 + 0.2;
            }

            update() {
                this.x += this.speedX;
                this.y += this.speedY;

                if (this.x > canvas.width) this.x = 0;
                if (this.x < 0) this.x = canvas.width;
                if (this.y > canvas.height) this.y = 0;
                if (this.y < 0) this.y = canvas.height;
            }

            draw() {
                ctx.fillStyle = `rgba(0, 39, 118, ${this.opacity})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function initParticles() {
            particles = [];
            for (let i = 0; i < particleCount; i++) {
                particles.push(new Particle());
            }
        }

        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            particles.forEach(particle => {
                particle.update();
                particle.draw();
            });

            // Conectar partículas próximas
            for (let i = 0; i < particles.length; i++) {
                for (let j = i + 1; j < particles.length; j++) {
                    const dx = particles[i].x - particles[j].x;
                    const dy = particles[i].y - particles[j].y;
                    const distance = Math.sqrt(dx * dx + dy * dy);

                    if (distance < 120) {
                        ctx.strokeStyle = `rgba(0, 39, 118, ${0.2 * (1 - distance / 120)})`;
                        ctx.lineWidth = 1;
                        ctx.beginPath();
                        ctx.moveTo(particles[i].x, particles[i].y);
                        ctx.lineTo(particles[j].x, particles[j].y);
                        ctx.stroke();
                    }
                }
            }

            requestAnimationFrame(animateParticles);
        }

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            initParticles();
        });

        initParticles();
        animateParticles();

        // Ajustar z-index do container principal para ficar sobre as partículas
        const mainContainer = document.querySelector('.main-container');
        if (mainContainer) {
            mainContainer.style.position = 'relative';
            mainContainer.style.zIndex = '1';
        }

        // ========== SISTEMA DE ETIQUETAS ==========
        let etiquetasDisponiveis = [];
        let coletaEtiquetasModal = null;

        async function carregarEtiquetasDisponiveis() {
            try {
                const { data, error } = await supabaseClient
                    .from('etiquetas_coletas')
                    .select('*')
                    .eq('ativo', true)
                    .order('nome', { ascending: true });

                if (error) throw error;
                etiquetasDisponiveis = data || [];
                console.log('🏷️ Etiquetas carregadas:', etiquetasDisponiveis.length);
            } catch (error) {
                console.error('❌ Erro ao carregar etiquetas:', error);
            }
        }

        async function abrirModalEtiquetas(coletaId) {
            if (!supabaseClient) {
                showNotification('Erro ao conectar com o banco de dados', 'error');
                return;
            }

            coletaEtiquetasModal = coletaId;
            const coleta = coletasData.find(c => c.id === coletaId);
            
            if (!coleta) {
                showNotification('Coleta não encontrada', 'error');
                return;
            }

            // Carregar etiquetas atuais da coleta
            const { data: etiquetasColeta } = await supabaseClient
                .from('coleta_etiquetas')
                .select('etiqueta_id')
                .eq('coleta_id', coletaId);

            const etiquetasAtuaisIds = (etiquetasColeta || []).map(e => e.etiqueta_id);

            // Criar modal elegante com overlay sutil
            const modalHTML = `
                <div class="modal fade show" id="modalEtiquetas" style="
                    display: block; 
                    z-index: 10001; 
                    position: fixed; 
                    top: 0; 
                    left: 0; 
                    width: 100%; 
                    height: 100%; 
                    background: rgba(0, 0, 0, 0.35);
                    backdrop-filter: blur(4px);
                    animation: fadeIn 0.3s ease;
                ">
                    <style>
                        @keyframes fadeIn {
                            from { opacity: 0; }
                            to { opacity: 1; }
                        }
                        @keyframes slideUp {
                            from { 
                                transform: translate(-50%, -45%);
                                opacity: 0;
                            }
                            to { 
                                transform: translate(-50%, -50%);
                                opacity: 1;
                            }
                        }
                        @keyframes pulse {
                            0%, 100% { transform: scale(1); }
                            50% { transform: scale(1.05); }
                        }
                    </style>
                    
                    <div class="modal-dialog" style="
                        position: absolute; 
                        top: 50%; 
                        left: 50%; 
                        transform: translate(-50%, -50%);
                        max-width: 700px; 
                        width: 92%;
                        animation: slideUp 0.4s ease;
                    ">
                        <div class="modal-content" style="
                            border-radius: 20px; 
                            border: 1px solid rgba(255,255,255,0.3);
                            box-shadow: 0 20px 60px rgba(0,0,0,0.3), 0 8px 32px rgba(102, 126, 234, 0.2);
                            overflow: hidden;
                            background: linear-gradient(135deg, #ffffff 0%, #fafbfc 100%);
                            backdrop-filter: blur(20px);
                        ">
                            <!-- Header elegante -->
                            <div class="modal-header" style="
                                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                color: white; 
                                padding: 1.5rem 2rem;
                                border: none;
                                position: relative;
                                overflow: hidden;
                            ">
                                <div style="flex: 1; position: relative; z-index: 1; display: flex; align-items: center; gap: 1rem;">
                                    <div style="
                                        width: 48px;
                                        height: 48px;
                                        background: rgba(255, 255, 255, 0.2);
                                        border-radius: 12px;
                                        display: flex;
                                        align-items: center;
                                        justify-content: center;
                                        backdrop-filter: blur(10px);
                                    ">
                                        <i class="fas fa-tags" style="font-size: 1.25rem;"></i>
                                    </div>
                                    <div>
                                        <h5 class="modal-title" style="
                                            margin: 0 0 0.25rem 0; 
                                            font-weight: 700; 
                                            font-size: 1.35rem;
                                            letter-spacing: -0.5px;
                                        ">
                                            Gerenciar Etiquetas
                                        </h5>
                                        <small style="
                                            opacity: 0.9; 
                                            display: flex; 
                                            align-items: center; 
                                            gap: 0.5rem;
                                            font-size: 0.8rem;
                                        ">
                                            <i class="fas fa-hashtag" style="font-size: 0.7rem;"></i>
                                            <span>${coleta.filial || ''} #${coleta.numero_coleta || coleta.id.substring(0, 8)}</span>
                                        </small>
                                    </div>
                                </div>
                                <button type="button" class="btn-close btn-close-white" onclick="fecharModalEtiquetas()" style="
                                    filter: brightness(0) invert(1);
                                    opacity: 0.8;
                                    transition: all 0.3s;
                                    position: relative;
                                    z-index: 1;
                                    background: rgba(255, 255, 255, 0.2);
                                    border-radius: 8px;
                                    padding: 0.5rem;
                                " onmouseover="this.style.opacity='1'; this.style.background='rgba(255, 255, 255, 0.3)'; this.style.transform='rotate(90deg)';" onmouseout="this.style.opacity='0.8'; this.style.background='rgba(255, 255, 255, 0.2)'; this.style.transform='rotate(0deg)';"></button>
                            </div>
                            
                            <!-- Body com glassmorphism e grid animado -->
                            <div class="modal-body" style="
                                max-height: 480px; 
                                overflow-y: auto; 
                                padding: 2rem;
                                background: linear-gradient(135deg, rgba(248, 249, 250, 0.95) 0%, rgba(255, 255, 255, 0.98) 100%);
                                position: relative;
                            ">
                                <p style="
                                    color: #495057; 
                                    margin-bottom: 1rem; 
                                    font-size: 0.95rem;
                                    font-weight: 500;
                                    display: flex;
                                    align-items: center;
                                    gap: 0.5rem;
                                ">
                                    <i class="fas fa-magic" style="color: #667eea;"></i>
                                    <span>Selecione as etiquetas que deseja vincular à esta coleta:</span>
                                </p>
                                <div class="filtro-etiquetas-wrapper" style="margin-bottom: 1.25rem;">
                                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 0.5rem;">
                                        <label for="filtroEtiquetasModal" style="font-size: 0.85rem; font-weight: 600; color: #475569; display: flex; align-items: center; gap: 0.4rem;">
                                            <i class="fas fa-search" style="color: #667eea;"></i> Buscar etiqueta
                                        </label>
                                        <span id="filtroEtiquetasContador" style="font-size: 0.8rem; color: #64748b; font-weight: 500;">${etiquetasDisponiveis.length} etiqueta${etiquetasDisponiveis.length !== 1 ? 's' : ''}</span>
                                    </div>
                                    <div style="position: relative; display: flex; align-items: center;">
                                        <i class="fas fa-search" style="position: absolute; left: 1rem; color: #94a3b8; font-size: 0.9rem; pointer-events: none;"></i>
                                        <input type="text" 
                                               id="filtroEtiquetasModal" 
                                               placeholder="Nome ou descrição..." 
                                               autocomplete="off"
                                               style="
                                                    width: 100%;
                                                    padding: 0.7rem 2.5rem 0.7rem 2.75rem;
                                                    border: 2px solid #e2e8f0;
                                                    border-radius: 12px;
                                                    font-size: 0.95rem;
                                                    color: #1e293b;
                                                    background: #fff;
                                                    transition: border-color 0.2s, box-shadow 0.2s;
                                               ">
                                        <button type="button" id="btnLimparFiltroEtiquetas" title="Limpar busca" style="
                                            position: absolute; right: 0.5rem; width: 32px; height: 32px;
                                            border: none; background: transparent; color: #94a3b8; cursor: pointer;
                                            border-radius: 8px; display: none; align-items: center; justify-content: center;
                                            transition: color 0.2s, background 0.2s;
                                        " onmouseover="this.style.color='#64748b'; this.style.background='#f1f5f9';" onmouseout="this.style.color='#94a3b8'; this.style.background='transparent';">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <div id="etiquetasNenhumResultado" style="display: none; margin-top: 1rem; padding: 1.5rem; text-align: center; background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); border: 2px dashed #e2e8f0; border-radius: 12px; color: #64748b; font-size: 0.9rem;">
                                        <i class="fas fa-inbox" style="font-size: 2rem; opacity: 0.4; margin-bottom: 0.75rem; display: block; color: #94a3b8;"></i>
                                        <strong style="color: #475569;">Nenhuma etiqueta encontrada</strong><br>
                                        <span style="font-size: 0.85rem;">Tente outro termo ou clique em ✕ para limpar a busca.</span>
                                    </div>
                                </div>
                                <div id="lista-etiquetas-modal" style="
                                    display: grid; 
                                    gap: 1rem;
                                ">
                                    ${etiquetasDisponiveis.map((et, index) => `
                                        <label class="etiqueta-checkbox-ultra-modern" for="etiqueta-${et.id}" data-etiqueta-nome="${String(et.nome || '').toLowerCase().replace(/"/g, '')}" data-etiqueta-descricao="${String(et.descricao || '').toLowerCase().replace(/"/g, '')}" style="
                                            display: flex;
                                            align-items: center;
                                            padding: 1.2rem 1.5rem;
                                            background: ${etiquetasAtuaisIds.includes(et.id) ? 
                                                `linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%)` : 
                                                'white'};
                                            border: 2px solid ${etiquetasAtuaisIds.includes(et.id) ? et.cor : '#e0e0e0'};
                                            border-radius: 16px;
                                            cursor: pointer;
                                            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
                                            box-shadow: ${etiquetasAtuaisIds.includes(et.id) ? 
                                                `0 8px 25px ${et.cor}40` : 
                                                '0 3px 15px rgba(0,0,0,0.08)'};
                                            position: relative;
                                            overflow: hidden;
                                            opacity: 0;
                                            animation: fadeInSlide 0.5s ease ${index * 0.05}s forwards;
                                        " onmouseover="
                                            this.style.transform='translateY(-4px) scale(1.02)';
                                            this.style.boxShadow='0 12px 35px ${et.cor}50';
                                            this.style.borderColor='${et.cor}';
                                        " onmouseout="
                                            this.style.transform='translateY(0) scale(1)';
                                            this.style.boxShadow='${etiquetasAtuaisIds.includes(et.id) ? 
                                                `0 8px 25px ${et.cor}40` : 
                                                '0 3px 15px rgba(0,0,0,0.08)'}';
                                            this.style.borderColor='${etiquetasAtuaisIds.includes(et.id) ? et.cor : '#e0e0e0'}';
                                        ">
                                            <style>
                                                @keyframes fadeInSlide {
                                                    from {
                                                        opacity: 0;
                                                        transform: translateX(-20px);
                                                    }
                                                    to {
                                                        opacity: 1;
                                                        transform: translateX(0);
                                                    }
                                                }
                                            </style>
                                            
                                            <!-- Indicador de seleção -->
                                            <input type="checkbox" 
                                                class="form-check-input" 
                                                id="etiqueta-${et.id}" 
                                                value="${et.id}"
                                                ${etiquetasAtuaisIds.includes(et.id) ? 'checked' : ''}
                                                style="
                                                    width: 24px; 
                                                    height: 24px; 
                                                    cursor: pointer; 
                                                    margin-right: 1.2rem; 
                                                    accent-color: ${et.cor};
                                                    z-index: 1;
                                                    position: relative;
                                                ">
                                            
                                            <!-- Badge com glow effect -->
                                            <span class="badge etiqueta-badge-modern" style="
                                                background: ${et.cor}; 
                                                color: white; 
                                                padding: 0.8rem 1.5rem; 
                                                border-radius: 12px; 
                                                font-size: 0.95rem;
                                                font-weight: 700;
                                                box-shadow: 0 4px 15px ${et.cor}50, inset 0 1px 0 rgba(255,255,255,0.3);
                                                display: flex;
                                                align-items: center;
                                                gap: 0.6rem;
                                                position: relative;
                                                overflow: hidden;
                                            ">
                                                <i class="fas fa-tag" style="font-size: 0.85rem;"></i> 
                                                ${et.nome}
                                                ${etiquetasAtuaisIds.includes(et.id) ? `
                                                    <span style="
                                                        background: rgba(255,255,255,0.3);
                                                        padding: 0.15rem 0.5rem;
                                                        border-radius: 10px;
                                                        font-size: 0.7rem;
                                                        margin-left: 0.3rem;
                                                    ">✓</span>
                                                ` : ''}
                                            </span>
                                            
                                            ${et.descricao ? `
                                                <div style="
                                                    margin-left: auto; 
                                                    color: #6c757d; 
                                                    font-size: 0.85rem;
                                                    font-style: italic;
                                                    max-width: 200px;
                                                    text-align: right;
                                                ">
                                                    <i class="fas fa-info-circle"></i> ${et.descricao}
                                                </div>
                                            ` : '<span style="margin-left: auto;"></span>'}
                                        </label>
                                    `).join('')}
                                </div>
                            </div>
                            
                            <!-- Footer futurista com botões 3D -->
                            <div class="modal-footer" style="
                                background: linear-gradient(135deg, rgba(255,255,255,0.98) 0%, rgba(248, 249, 250, 0.95) 100%);
                                padding: 1.5rem 2rem; 
                                border-top: 1px solid rgba(0,0,0,0.08); 
                                display: flex; 
                                justify-content: space-between; 
                                gap: 1rem;
                            ">
                                <button type="button" class="btn btn-lg btn-cancel" onclick="fecharModalEtiquetas()" style="
                                    background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%);
                                    color: #495057;
                                    border: none;
                                    padding: 0.85rem 2rem;
                                    border-radius: 12px;
                                    font-weight: 700;
                                    font-size: 0.95rem;
                                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                                    flex: 1;
                                    box-shadow: 0 3px 15px rgba(0,0,0,0.08);
                                " onmouseover="
                                    this.style.background='linear-gradient(135deg, #e0e0e0 0%, #d0d0d0 100%)';
                                    this.style.transform='translateY(-2px)';
                                    this.style.boxShadow='0 6px 20px rgba(0,0,0,0.12)';
                                " onmouseout="
                                    this.style.background='linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%)';
                                    this.style.transform='translateY(0)';
                                    this.style.boxShadow='0 3px 15px rgba(0,0,0,0.08)';
                                ">
                                    <i class="fas fa-times-circle me-2"></i>Cancelar
                                </button>
                                <button type="button" class="btn btn-lg btn-save" onclick="salvarEtiquetasColeta()" style="
                                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                                    color: white;
                                    border: none;
                                    padding: 0.85rem 2rem;
                                    border-radius: 12px;
                                    font-weight: 700;
                                    font-size: 0.95rem;
                                    flex: 1;
                                    box-shadow: 0 6px 25px rgba(102, 126, 234, 0.5);
                                    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                                    position: relative;
                                    overflow: hidden;
                                " onmouseover="
                                    this.style.transform='translateY(-3px) scale(1.02)';
                                    this.style.boxShadow='0 10px 35px rgba(102, 126, 234, 0.6)';
                                " onmouseout="
                                    this.style.transform='translateY(0) scale(1)';
                                    this.style.boxShadow='0 6px 25px rgba(102, 126, 234, 0.5)';
                                " onmousedown="this.style.transform='translateY(-1px) scale(0.98)';" onmouseup="this.style.transform='translateY(-3px) scale(1.02)';">
                                    <i class="fas fa-save me-2"></i>Salvar Etiquetas
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            const modalDiv = document.createElement('div');
            modalDiv.innerHTML = modalHTML;
            document.body.appendChild(modalDiv);

            // Filtro de busca: por nome ou descrição, contador, mensagem vazia, botão limpar, foco automático
            const filtroEl = document.getElementById('filtroEtiquetasModal');
            const listaEl = document.getElementById('lista-etiquetas-modal');
            const contadorEl = document.getElementById('filtroEtiquetasContador');
            const nenhumEl = document.getElementById('etiquetasNenhumResultado');
            const btnLimpar = document.getElementById('btnLimparFiltroEtiquetas');
            const totalEtiquetas = etiquetasDisponiveis.length;

            function atualizarFiltroEtiquetas() {
                const term = (filtroEl && filtroEl.value ? filtroEl.value : '').trim().toLowerCase();
                if (btnLimpar) btnLimpar.style.display = term ? 'flex' : 'none';
                if (!listaEl) return;
                let visiveis = 0;
                listaEl.querySelectorAll('label[data-etiqueta-nome]').forEach(function(label) {
                    const nome = (label.getAttribute('data-etiqueta-nome') || '').toLowerCase();
                    const desc = (label.getAttribute('data-etiqueta-descricao') || '').toLowerCase();
                    const match = term === '' || nome.indexOf(term) !== -1 || desc.indexOf(term) !== -1;
                    label.style.display = match ? '' : 'none';
                    if (match) visiveis++;
                });
                if (contadorEl) {
                    if (term === '') {
                        contadorEl.textContent = totalEtiquetas + ' etiqueta' + (totalEtiquetas !== 1 ? 's' : '');
                    } else {
                        contadorEl.textContent = visiveis + ' de ' + totalEtiquetas + ' etiqueta' + (totalEtiquetas !== 1 ? 's' : '');
                    }
                }
                if (nenhumEl) nenhumEl.style.display = (term && visiveis === 0) ? 'block' : 'none';
            }

            if (filtroEl && listaEl) {
                filtroEl.addEventListener('input', atualizarFiltroEtiquetas);
                filtroEl.addEventListener('focus', function() {
                    this.style.borderColor = '#667eea';
                    this.style.boxShadow = '0 0 0 3px rgba(102, 126, 234, 0.15)';
                });
                filtroEl.addEventListener('blur', function() {
                    this.style.borderColor = '#e2e8f0';
                    this.style.boxShadow = 'none';
                });
            }
            if (btnLimpar) {
                btnLimpar.addEventListener('click', function() {
                    if (filtroEl) {
                        filtroEl.value = '';
                        filtroEl.focus();
                        atualizarFiltroEtiquetas();
                    }
                });
            }
            setTimeout(function() {
                if (filtroEl) {
                    filtroEl.focus();
                }
            }, 150);

            // Adicionar overlay
            const overlay = document.createElement('div');
            overlay.className = 'modal-backdrop fade show';
            document.body.appendChild(overlay);
        }

        function fecharModalEtiquetas() {
            const modal = document.getElementById('modalEtiquetas');
            const overlay = document.querySelector('.modal-backdrop');
            if (modal) modal.remove();
            if (overlay) overlay.remove();
            coletaEtiquetasModal = null;
        }

        async function salvarEtiquetasColeta() {
            if (!coletaEtiquetasModal) return;

            try {
                // Obter etiquetas selecionadas
                const checkboxes = document.querySelectorAll('#modalEtiquetas input[type="checkbox"]:checked');
                const etiquetasSelecionadas = Array.from(checkboxes).map(cb => cb.value);

                // Buscar etiquetas antigas para comparar
                const { data: etiquetasAntigasData } = await supabaseClient
                    .from('coleta_etiquetas')
                    .select(`
                        etiqueta_id,
                        etiquetas_coletas:etiqueta_id (
                            id,
                            nome
                        )
                    `)
                    .eq('coleta_id', coletaEtiquetasModal);

                const etiquetasAntigas = etiquetasAntigasData?.map(e => e.etiquetas_coletas?.nome).filter(Boolean) || [];

                // Buscar nomes das novas etiquetas
                const { data: etiquetasData } = await supabaseClient
                    .from('etiquetas_coletas')
                    .select('id, nome')
                    .in('id', etiquetasSelecionadas);

                const etiquetasNovas = etiquetasData?.map(e => e.nome) || [];

                // Remover todas as etiquetas da coleta
                const { error: deleteError } = await supabaseClient
                    .from('coleta_etiquetas')
                    .delete()
                    .eq('coleta_id', coletaEtiquetasModal);

                if (deleteError) throw deleteError;

                // Adicionar novas etiquetas
                if (etiquetasSelecionadas.length > 0) {
                    const novasEtiquetas = etiquetasSelecionadas.map(etId => ({
                        coleta_id: coletaEtiquetasModal,
                        etiqueta_id: etId
                    }));

                    const { error: insertError } = await supabaseClient
                        .from('coleta_etiquetas')
                        .insert(novasEtiquetas);

                    if (insertError) throw insertError;
                }

                // Registrar no histórico
                let detalhesHistorico = '';
                if (etiquetasNovas.length > 0 && etiquetasAntigas.length > 0) {
                    // Houve mudança
                    detalhesHistorico = `Etiquetas alteradas: ${etiquetasAntigas.join(', ')} → ${etiquetasNovas.join(', ')}`;
                } else if (etiquetasNovas.length > 0) {
                    // Adicionadas novas etiquetas
                    detalhesHistorico = `Etiquetas adicionadas: ${etiquetasNovas.join(', ')}`;
                } else if (etiquetasAntigas.length > 0) {
                    // Todas as etiquetas foram removidas
                    detalhesHistorico = `Etiquetas removidas: ${etiquetasAntigas.join(', ')}`;
                } else {
                    detalhesHistorico = 'Nenhuma etiqueta vinculada';
                }

                await salvarNoHistorico(coletaEtiquetasModal, 'etiquetas_alteradas', detalhesHistorico);

                // Buscar etiquetas atualizadas com cores
                const { data: etiquetasAtualizadas } = await supabaseClient
                    .from('coleta_etiquetas')
                    .select(`
                        etiqueta_id,
                        etiquetas_coletas:etiqueta_id (
                            id,
                            nome,
                            cor
                        )
                    `)
                    .eq('coleta_id', coletaEtiquetasModal);

                // Atualizar etiquetas no objeto coleta em coletasData
                const coletaIndex = coletasData.findIndex(c => c.id === coletaEtiquetasModal);
                if (coletaIndex !== -1) {
                    coletasData[coletaIndex].etiquetas = etiquetasAtualizadas
                        ?.map(e => e.etiquetas_coletas)
                        .filter(Boolean) || [];
                }

                // Verificar se o drawer está aberto para esta coleta
                const drawer = document.getElementById('kanbanDrawer');
                const isDrawerOpen = drawer && drawer.classList.contains('active');
                
                if (isDrawerOpen) {
                    // Recarregar conteúdo do drawer para mostrar etiquetas atualizadas
                    await carregarConteudoDrawer(coletaEtiquetasModal);
                }

                // Atualizar o card do kanban se estiver visível
                renderColetasWrapper();

                showNotification('Etiquetas salvas com sucesso!', 'success');
                fecharModalEtiquetas();
                
            } catch (error) {
                console.error('❌ Erro ao salvar etiquetas:', error);
                showNotification('Erro ao salvar etiquetas: ' + error.message, 'error');
            }
        }

        // Função para buscar data de entrada na etapa atual a partir do histórico
        async function buscarDataEntradaEtapa(coletaId, etapaAtual) {
            try {
                // Buscar última mudança de etapa no histórico
                const { data: historicoEtapas } = await supabaseClient
                    .from('historico_coletas')
                    .select('created_at, detalhes')
                    .eq('coleta_id', coletaId)
                    .or(`acao.eq.etapa_avancada,acao.eq.etapa_alterada,acao.eq.etapa_movida,detalhes.ilike.%${etapaAtual}%`)
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (!historicoEtapas || historicoEtapas.length === 0) {
                    // Se não há histórico, usar created_at da coleta
                    const coleta = coletasData.find(c => c.id === coletaId);
                    return coleta?.created_at || null;
                }
                
                // Procurar a última vez que entrou na etapa atual
                for (const registro of historicoEtapas) {
                    if (registro.detalhes && registro.detalhes.includes(`"${etapaAtual}"`)) {
                        return registro.created_at;
                    }
                }
                
                // Se não encontrou, usar a data mais recente do histórico
                return historicoEtapas[0]?.created_at || null;
            } catch (error) {
                console.warn('⚠️ Erro ao buscar data de entrada na etapa:', error);
                // Fallback: usar created_at da coleta
                const coleta = coletasData.find(c => c.id === coletaId);
                return coleta?.created_at || null;
            }
        }
        
        /**
         * ✅ NOVA FUNÇÃO: Calcula o tempo acumulado que uma coleta passou em uma etapa específica
         * Considera múltiplas entradas/saídas da mesma etapa
         * @param {string} coletaId - ID da coleta
         * @param {string} etapaId - ID da etapa
         * @param {Array} historico - Histórico de movimentações da coleta (ordenado por data, mais antigo primeiro)
         * @param {string} etapaAtual - Etapa atual da coleta
         * @returns {number} - Tempo acumulado em minutos
         */
        function calcularTempoAcumuladoEtapa(coletaId, etapaId, historico, etapaAtual) {
            // ✅ MELHORIA: Se não há histórico, retornar null para usar fallback
            if (!historico || historico.length === 0) {
                return null; // Retornar null para indicar que deve usar fallback
            }
            
            // Ordenar histórico por data (mais antigo primeiro)
            const historicoOrdenado = [...historico].sort((a, b) => 
                new Date(a.created_at) - new Date(b.created_at)
            );
            
            let tempoAcumulado = 0; // em minutos
            let entradaEtapa = null;
            const agora = new Date();
            
            // Buscar informações da etapa
            const etapaInfo = ETAPAS.find(e => e.id === etapaId);
            const etapaNome = etapaInfo?.nome || etapaId;
            
            // ✅ MELHORIA: Padrões mais abrangentes para identificar mudanças de etapa
            // Múltiplos formatos possíveis:
            // - "Coleta movida de \"X\" para \"[ETAPA]\" via Kanban"
            // - "Etapa voltou de X para [ETAPA]"
            // - "Etapa alterada para [ETAPA]"
            // - "Etapa avançada para [ETAPA]"
            // - "→ [ETAPA]"
            // - Qualquer texto contendo o nome ou ID da etapa
            
            // Percorrer histórico cronologicamente
            for (let i = 0; i < historicoOrdenado.length; i++) {
                const registro = historicoOrdenado[i];
                if (!registro.detalhes) continue;
                
                const detalhes = registro.detalhes.toLowerCase();
                const etapaNomeLower = etapaNome.toLowerCase();
                const etapaIdLower = etapaId.toLowerCase();
                
                // ✅ MELHORIA: Padrões mais flexíveis para entrada na etapa
                const padraoEntrada1 = new RegExp(`para\\s*["']?${etapaNomeLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}["']?`, 'i');
                const padraoEntrada2 = new RegExp(`para\\s*["']?${etapaIdLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}["']?`, 'i');
                const padraoEntrada3 = new RegExp(`voltou.*?para\\s*["']?${etapaNomeLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}["']?`, 'i');
                const padraoEntrada4 = new RegExp(`→\\s*["']?${etapaNomeLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}["']?`, 'i');
                const padraoEntrada5 = new RegExp(`alterada.*?para\\s*["']?${etapaNomeLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}["']?`, 'i');
                const padraoEntrada6 = new RegExp(`avançada.*?para\\s*["']?${etapaNomeLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}["']?`, 'i');
                
                const entrouNaEtapa = padraoEntrada1.test(detalhes) || 
                                      padraoEntrada2.test(detalhes) || 
                                      padraoEntrada3.test(detalhes) ||
                                      padraoEntrada4.test(detalhes) ||
                                      padraoEntrada5.test(detalhes) ||
                                      padraoEntrada6.test(detalhes);
                
                // ✅ MELHORIA: Padrões mais flexíveis para saída da etapa
                const padraoSaida1 = new RegExp(`de\\s*["']?${etapaNomeLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}["']?`, 'i');
                const padraoSaida2 = new RegExp(`de\\s*["']?${etapaIdLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}["']?`, 'i');
                const padraoSaida3 = new RegExp(`saiu.*?de\\s*["']?${etapaNomeLower.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')}["']?`, 'i');
                
                const saiuDaEtapa = padraoSaida1.test(detalhes) || 
                                    padraoSaida2.test(detalhes) ||
                                    padraoSaida3.test(detalhes);
                
                // Se saiu da etapa e estava dentro dela
                if (saiuDaEtapa && entradaEtapa !== null) {
                    // Saiu da etapa - somar o tempo que ficou
                    const saidaEtapa = new Date(registro.created_at);
                    const tempoPeriodo = (saidaEtapa.getTime() - entradaEtapa.getTime()) / (1000 * 60);
                    if (tempoPeriodo > 0) { // Validar que o tempo é positivo
                        tempoAcumulado += tempoPeriodo;
                    }
                    entradaEtapa = null; // Resetar para próxima entrada
                }
                
                // Se entrou na etapa (e não estava saindo ao mesmo tempo)
                if (entrouNaEtapa && !saiuDaEtapa) {
                    // Registrar nova entrada na etapa
                    entradaEtapa = new Date(registro.created_at);
                }
            }
            
            // Se ainda está na etapa (entradaEtapa !== null), somar tempo até agora
            if (entradaEtapa !== null && etapaAtual === etapaId) {
                const tempoAtual = (agora.getTime() - entradaEtapa.getTime()) / (1000 * 60);
                if (tempoAtual > 0) { // Validar que o tempo é positivo
                    tempoAcumulado += tempoAtual;
                }
            }
            
            // ✅ MELHORIA: Se não encontrou nenhuma entrada na etapa, retornar null para usar fallback
            if (entradaEtapa === null && etapaAtual === etapaId) {
                // Pode ser que a coleta nunca tenha mudado de etapa (está na etapa inicial)
                // Nesse caso, retornar null para usar fallback (created_at)
                return null;
            }
            
            return tempoAcumulado > 0 ? tempoAcumulado : null;
        }
        
        // Função para enriquecer coletas com data de entrada na etapa e tempo acumulado
        async function enriquecerColetasComTempoParado() {
            if (coletasData.length === 0) return;
            
            try {
                // Buscar histórico de etapas para todas as coletas de uma vez
                const coletasIds = coletasData.map(c => c.id);
                const { data: historicoEtapas } = await supabaseClient
                    .from('historico_coletas')
                    .select('coleta_id, created_at, detalhes, acao')
                    .in('coleta_id', coletasIds)
                    .or('acao.eq.etapa_avancada,acao.eq.etapa_alterada,acao.eq.etapa_movida,acao.eq.etapa_retornada')
                    .order('created_at', { ascending: true }); // Ordenar do mais antigo para o mais recente
                
                // Agrupar histórico por coleta
                const historicoPorColeta = {};
                if (historicoEtapas) {
                    historicoEtapas.forEach(h => {
                        if (!historicoPorColeta[h.coleta_id]) {
                            historicoPorColeta[h.coleta_id] = [];
                        }
                        historicoPorColeta[h.coleta_id].push(h);
                    });
                }
                
                // Para cada coleta, calcular tempo acumulado na etapa atual
                coletasData.forEach(coleta => {
                    const historico = historicoPorColeta[coleta.id] || [];
                    
                    // ✅ NOVO: Calcular tempo acumulado na etapa atual
                    let tempoAcumuladoMinutos = calcularTempoAcumuladoEtapa(
                        coleta.id, 
                        coleta.etapa_atual, 
                        historico, 
                        coleta.etapa_atual
                    );
                    
                    // ✅ MELHORIA: Se não conseguiu calcular pelo histórico, usar fallback
                    if (tempoAcumuladoMinutos === null || tempoAcumuladoMinutos === undefined) {
                        // Calcular tempo desde created_at ou updated_at
                        const dataReferencia = coleta.updated_at || coleta.created_at;
                        if (dataReferencia) {
                            const agora = new Date();
                            const dataRef = new Date(dataReferencia);
                            tempoAcumuladoMinutos = (agora.getTime() - dataRef.getTime()) / (1000 * 60);
                            
                            // ✅ DEBUG: Log para identificar coletas usando fallback
                            if (historico.length === 0) {
                                console.log(`⚠️ Coleta ${coleta.id} (${coleta.cliente}) na etapa "${coleta.etapa_atual}": Sem histórico, usando fallback (${Math.floor(tempoAcumuladoMinutos)} min desde ${dataReferencia})`);
                            } else {
                                console.log(`⚠️ Coleta ${coleta.id} (${coleta.cliente}) na etapa "${coleta.etapa_atual}": Não encontrou entrada na etapa no histórico (${historico.length} registros), usando fallback (${Math.floor(tempoAcumuladoMinutos)} min)`);
                            }
                        } else {
                            tempoAcumuladoMinutos = 0;
                            console.warn(`❌ Coleta ${coleta.id} (${coleta.cliente}): Sem data de referência para calcular tempo`);
                        }
                    } else {
                        // ✅ DEBUG: Log para coletas que calcularam corretamente
                        if (tempoAcumuladoMinutos > 0) {
                            console.log(`✅ Coleta ${coleta.id} (${coleta.cliente}) na etapa "${coleta.etapa_atual}": ${Math.floor(tempoAcumuladoMinutos)} minutos acumulados`);
                        }
                    }
                    
                    // Armazenar tempo acumulado
                    coleta.tempo_acumulado_etapa = Math.max(0, tempoAcumuladoMinutos); // Garantir que não seja negativo
                    
                    // Para compatibilidade, manter data_entrada_etapa (última entrada)
                    // Mas vamos calcular uma data "virtual" baseada no tempo acumulado
                    let dataEntradaEtapa = null;
                    
                    // Procurar última entrada na etapa atual
                    for (let i = historico.length - 1; i >= 0; i--) {
                        const registro = historico[i];
                        if (registro.detalhes) {
                            const padrao1 = new RegExp(`para\\s*["']${coleta.etapa_atual}["']`, 'i');
                            const padrao2 = new RegExp(`→\\s*["']${coleta.etapa_atual}["']`, 'i');
                            const padrao3 = new RegExp(`["']${coleta.etapa_atual}["']`, 'i');
                            
                            if (padrao1.test(registro.detalhes) || padrao2.test(registro.detalhes) || padrao3.test(registro.detalhes)) {
                                dataEntradaEtapa = registro.created_at;
                                break;
                            }
                        }
                    }
                    
                    // Se não encontrou no histórico, usar created_at como fallback
                    if (!dataEntradaEtapa) {
                        dataEntradaEtapa = coleta.created_at || coleta.updated_at;
                    }
                    
                    // Calcular data "virtual" de entrada considerando tempo acumulado
                    // Se o tempo acumulado é maior que o tempo desde a última entrada,
                    // significa que houve múltiplas entradas - ajustar a data
                    const agora = new Date();
                    const dataUltimaEntrada = new Date(dataEntradaEtapa);
                    const tempoDesdeUltimaEntrada = (agora.getTime() - dataUltimaEntrada.getTime()) / (1000 * 60);
                    
                    if (tempoAcumuladoMinutos > tempoDesdeUltimaEntrada) {
                        // Tempo acumulado é maior - calcular data virtual retrocedendo o tempo extra
                        const tempoExtra = tempoAcumuladoMinutos - tempoDesdeUltimaEntrada;
                        const dataVirtual = new Date(agora.getTime() - (tempoAcumuladoMinutos * 60 * 1000));
                        coleta.data_entrada_etapa = dataVirtual.toISOString();
                    } else {
                    coleta.data_entrada_etapa = dataEntradaEtapa;
                    }
                });

                // Agregar tempo por etapa para o gráfico (usa ETAPAS e coletasData já enriquecidas)
                if (typeof ETAPAS !== 'undefined' && ETAPAS.length) {
                    tempoPorEtapaAgregado = ETAPAS.map(etapa => {
                        const naEtapa = coletasData.filter(c => c.etapa_atual === etapa.id);
                        const totalMinutos = naEtapa.reduce((s, c) => s + (c.tempo_acumulado_etapa || 0), 0);
                        const qtd = naEtapa.length;
                        return {
                            etapaId: etapa.id,
                            nome: etapa.nome,
                            ordem: etapa.ordem,
                            totalMinutos,
                            coletaCount: qtd,
                            mediaMinutos: qtd > 0 ? totalMinutos / qtd : 0
                        };
                    });
                }
            } catch (error) {
                console.warn('⚠️ Erro ao enriquecer coletas com tempo parado:', error);
                // Fallback: usar created_at para todas
                coletasData.forEach(coleta => {
                    coleta.data_entrada_etapa = coleta.created_at || coleta.updated_at;
                    coleta.tempo_acumulado_etapa = 0;
                });
                tempoPorEtapaAgregado = [];
            }
        }
        
        // Função para atualizar contadores de tempo parado em tempo real
        function iniciarAtualizacaoTempoParado() {
            // Limpar intervalo anterior se existir
            if (window.intervalTempoParado) {
                clearInterval(window.intervalTempoParado);
            }
            
            // Atualizar contadores a cada minuto
            window.intervalTempoParado = setInterval(() => {
                if (visualizacaoAtual === 'kanban') {
                    // Atualizar apenas os cards visíveis
                    const cards = document.querySelectorAll('.kanban-card[data-coleta-id]');
                    cards.forEach(card => {
                        const coletaId = card.getAttribute('data-coleta-id');
                        const coleta = coletasData.find(c => c.id === coletaId);
                        
                        if (coleta && coleta.data_entrada_etapa) {
                            const tempoParado = calcularTempoParado(coleta);
                            const isDiaria = coleta.diaria === true || coleta.diaria === 'true' || coleta.diaria === 1;
                            const isUrgente = coleta.prioridade === 'urgente';
                            const tempoParadoHTML = formatarTempoParado(tempoParado, isDiaria, isUrgente, coleta);
                            
                            if (tempoParadoHTML) {
                                // Atualizar badge de tempo parado no card
                                const tempoBadge = card.querySelector('.tempo-parado-badge');
                                if (tempoBadge) {
                                    // Criar novo elemento e substituir
                                    const tempDiv = document.createElement('div');
                                    tempDiv.innerHTML = tempoParadoHTML.trim();
                                    tempoBadge.replaceWith(tempDiv.firstElementChild);
                                } else {
                                    // Se não existe, adicionar
                                    const cardBody = card.querySelector('.kanban-card-body');
                                    if (cardBody) {
                                        const tempDiv = document.createElement('div');
                                        tempDiv.innerHTML = tempoParadoHTML.trim();
                                        cardBody.appendChild(tempDiv.firstElementChild);
                                    }
                                }
                            }
                        }
                    });
                }
            }, 60000); // Atualizar a cada 1 minuto
        }

        // Modificar carregarColetas para buscar etiquetas também
        const originalCarregarColetas = carregarColetas;
        carregarColetas = async function() {
            await originalCarregarColetas();
            
            // ✅ OTIMIZAÇÃO: Buscar todas as etiquetas de uma vez em vez de loop individual
            if (coletasData.length > 0) {
                try {
                    const coletasIds = coletasData.map(c => c.id);
                    
                    // Buscar todas as etiquetas relacionadas às coletas de uma vez
                    const { data: todasEtiquetas, error: etiquetasError } = await supabaseClient
                    .from('coleta_etiquetas')
                    .select(`
                            coleta_id,
                        etiqueta_id,
                        etiquetas_coletas:etiqueta_id (
                            id,
                            nome,
                            cor
                        )
                    `)
                        .in('coleta_id', coletasIds);
                    
                    if (etiquetasError) {
                        console.warn('⚠️ Erro ao buscar etiquetas:', etiquetasError);
                        // Continuar sem etiquetas em caso de erro
                        coletasData.forEach(coleta => {
                            coleta.etiquetas = [];
                        });
                } else {
                        // Agrupar etiquetas por coleta_id
                        const etiquetasPorColeta = {};
                        if (todasEtiquetas) {
                            todasEtiquetas.forEach(e => {
                                if (!etiquetasPorColeta[e.coleta_id]) {
                                    etiquetasPorColeta[e.coleta_id] = [];
                                }
                                if (e.etiquetas_coletas) {
                                    etiquetasPorColeta[e.coleta_id].push(e.etiquetas_coletas);
                                }
                            });
                        }
                        
                        // Atribuir etiquetas às coletas
                        coletasData.forEach(coleta => {
                            coleta.etiquetas = etiquetasPorColeta[coleta.id] || [];
                        });
                        
                        console.log('✅ Etiquetas carregadas para', Object.keys(etiquetasPorColeta).length, 'coletas');
                    }
                } catch (error) {
                    console.error('❌ Erro ao carregar etiquetas:', error);
                    // Continuar sem etiquetas em caso de erro
                    coletasData.forEach(coleta => {
                    coleta.etiquetas = [];
                    });
                }
                
                // Re-renderizar para exibir etiquetas nos cards do Kanban (o primeiro render ocorreu antes das etiquetas)
                if (typeof renderColetasWrapper === 'function') {
                    await renderColetasWrapper();
                }
            }
            
            updateStats();
        };

        // Expor funções globalmente para uso em inline handlers
        window.trocarMotorista = trocarMotorista;
        window.reprovarMotorista = reprovarMotorista;
        window.vincularMotorista = vincularMotorista;
        window.fecharModalMotorista = fecharModalMotorista;
        window.filtrarMotoristas = filtrarMotoristas;
        window.verDetalhesMotorista = verDetalhesMotorista;
        window.selecionarMotorista = selecionarMotorista;
        window.confirmarPagamento = confirmarPagamento;
        window.marcarTipoPagamentoEspecifico = marcarTipoPagamentoEspecifico;
        window.alternarVisualizacao = alternarVisualizacao;
    </script>
<!-- Chat IA -->
<link rel="stylesheet" href="../css/chat-ia.css">
<script src="../js/chat-ia.js"></script>
</body>
</html>


