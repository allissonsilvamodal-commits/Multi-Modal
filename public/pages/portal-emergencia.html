<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Central de Emerg√™ncia</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root {
      --bg-gradient: linear-gradient(135deg, #111827 0%, #1f2937 40%, #0f172a 100%);
      --card-bg: rgba(17, 24, 39, 0.78);
      --card-border: rgba(148, 163, 184, 0.25);
      --text-primary: #f9fafb;
      --text-secondary: rgba(209, 213, 219, 0.9);
      --accent: #f97316;
      --accent-strong: #ea580c;
      --accent-soft: rgba(251, 191, 36, 0.2);
      --success: #22c55e;
      --danger: #ef4444;
      --radius: 22px;
      --transition: all 0.25s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: var(--bg-gradient);
      color: var(--text-primary);
      min-height: 100vh;
      padding: 32px 18px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 20% 20%, rgba(255, 100, 0, 0.16), transparent 55%),
                  radial-gradient(circle at 80% 30%, rgba(249, 115, 22, 0.12), transparent 55%),
                  radial-gradient(circle at 50% 80%, rgba(234, 88, 12, 0.14), transparent 50%);
      z-index: -1;
    }

    .container {
      width: min(960px, 100%);
      display: flex;
      flex-direction: column;
      gap: 22px;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--card-border);
      border-radius: var(--radius);
      padding: 28px 30px;
      backdrop-filter: blur(18px);
      box-shadow: 0 28px 80px rgba(15, 23, 42, 0.55);
    }

    header.card {
      display: flex;
      flex-direction: column;
      gap: 12px;
      text-align: center;
    }

    header.card h1 {
      font-size: 2.1rem;
      font-weight: 700;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }

    header.card p {
      color: var(--text-secondary);
      font-size: 1rem;
    }

    .alert-banner {
      border-radius: var(--radius);
      border: 1px solid rgba(251, 191, 36, 0.45);
      background: linear-gradient(145deg, rgba(252, 211, 77, 0.18), rgba(234, 179, 8, 0.08));
      color: #fef9c3;
      padding: 18px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 0.96rem;
      font-weight: 500;
    }

    .emergency-button {
      display: flex;
      flex-direction: column;
      gap: 14px;
      text-align: center;
      margin: 8px 0 16px;
    }

    .emergency-button button {
      background: linear-gradient(135deg, var(--accent-strong), #facc15);
      color: #111827;
      font-size: 1.05rem;
      font-weight: 600;
      padding: 18px 24px;
      border-radius: var(--radius);
      border: none;
      cursor: pointer;
      box-shadow: 0 28px 68px rgba(234, 88, 12, 0.45);
      transition: var(--transition);
      letter-spacing: 0.04em;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 12px;
    }

    .emergency-button button:hover {
      transform: translateY(-4px);
      box-shadow: 0 36px 88px rgba(234, 88, 12, 0.6);
    }

    .warning-text {
      color: var(--text-secondary);
      font-size: 0.92rem;
      line-height: 1.5;
    }

    .warning-text strong {
      color: #fef3c7;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 18px;
    }

    .contact-card {
      border-radius: 18px;
      border: 1px solid rgba(248, 250, 252, 0.08);
      padding: 18px 20px;
      background: rgba(255, 255, 255, 0.04);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .contact-card strong {
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #fef3c7;
    }

    .contact-card span {
      color: var(--text-secondary);
      font-size: 0.92rem;
    }

    .contact-card .tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: rgba(251, 191, 36, 0.16);
      color: #fde68a;
      padding: 6px 10px;
      border-radius: 12px;
      font-size: 0.78rem;
      width: fit-content;
    }

    .procedures {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .procedure-block {
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.22);
      background: rgba(255, 255, 255, 0.04);
      padding: 20px 22px;
    }

    .procedure-block h3 {
      font-size: 1.1rem;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 10px;
      letter-spacing: 0.02em;
    }

    .procedure-block ul {
      display: grid;
      gap: 10px;
      list-style: none;
      color: var(--text-secondary);
      font-size: 0.92rem;
      padding-left: 0;
    }

    .procedure-block ul li {
      display: flex;
      gap: 10px;
      align-items: flex-start;
    }

    .procedure-block ul li::before {
      content: '\f101';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      color: var(--accent);
      line-height: 1.4;
    }

    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.82);
      backdrop-filter: blur(10px);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 18px;
    }

    .modal-overlay.active {
      display: flex;
    }

    .modal-card {
      width: min(420px, 100%);
      border-radius: 20px;
      border: 1px solid rgba(248, 250, 252, 0.1);
      background: rgba(15, 23, 42, 0.92);
      padding: 26px 28px;
      display: flex;
      flex-direction: column;
      gap: 14px;
      text-align: center;
    }

    .modal-card h4 {
      font-size: 1.2rem;
      font-weight: 600;
    }

    .modal-card p {
      font-size: 0.95rem;
      color: var(--text-secondary);
      line-height: 1.5;
    }

    .modal-actions {
      display: flex;
      margin-top: 6px;
      gap: 12px;
      flex-wrap: wrap;
    }

    .modal-actions button {
      flex: 1 1 160px;
      border-radius: 14px;
      border: none;
      padding: 12px 16px;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }

    .modal-actions .btn-outline {
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--text-secondary);
    }

    .modal-actions .btn-outline:hover {
      border-color: rgba(148, 163, 184, 0.8);
      color: var(--text-primary);
    }

    .modal-actions .btn-strong {
      background: linear-gradient(135deg, var(--danger), #f97316);
      color: #fffdfa;
      box-shadow: 0 24px 54px rgba(239, 68, 68, 0.35);
    }

    .modal-actions .btn-strong:hover {
      transform: translateY(-3px);
      box-shadow: 0 30px 68px rgba(239, 68, 68, 0.48);
    }

    footer {
      text-align: center;
      font-size: 0.8rem;
      color: rgba(148, 163, 184, 0.65);
    }

    .btn-back {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: 18px;
      border: 1px solid rgba(148, 163, 184, 0.35);
      background: rgba(15, 23, 42, 0.6);
      color: var(--text-primary);
      font-weight: 500;
      font-size: 0.95rem;
      transition: var(--transition);
      white-space: nowrap;
    }

    .btn-back:hover {
      background: rgba(96, 165, 250, 0.15);
      border-color: rgba(96, 165, 250, 0.45);
      color: var(--text-primary);
      transform: translateX(-3px);
    }

    @media (max-width: 640px) {
      body { padding: 24px 14px; }
      .card { padding: 22px 20px; }
      header.card h1 { font-size: 1.7rem; }
      .alert-banner { flex-direction: column; align-items: flex-start; }
      .emergency-button button { font-size: 0.98rem; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="card">
      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 16px;">
        <div style="flex: 1;">
          <h1><i class="fas fa-triangle-exclamation"></i> Emerg√™ncia</h1>
          <p>Central de gerenciamento de situa√ß√µes cr√≠ticas. Utilize esta p√°gina apenas em ocorr√™ncias reais.</p>
        </div>
        <a href="portal-motorista.html" class="btn-back" style="text-decoration: none;">
          <i class="fas fa-arrow-left"></i> Voltar ao Portal
        </a>
      </div>
    </header>

    <div class="card">
      <div class="alert-banner">
        <i class="fas fa-bell fa-lg"></i>
        <div>
          <strong>Notifica√ß√£o de Emerg√™ncia</strong>
          <p>Ao acionar o alerta, todos os administradores e respons√°veis pela seguran√ßa ser√£o notificados via SMS, e-mail e aplicativo corporativo.</p>
        </div>
      </div>

      <div class="emergency-button">
        <button id="btnAlerta"><i class="fas fa-siren-on"></i> ACIONAR ALERTA DE EMERG√äNCIA</button>
        <p class="warning-text"><strong>Aten√ß√£o:</strong> utilize este bot√£o apenas em situa√ß√µes <em>reais</em> de emerg√™ncia. Falsos alertas podem resultar em medidas disciplinares.</p>
      </div>
    </div>

    <section class="card">
      <h2 style="margin-bottom: 18px;"><i class="fas fa-phone-volume"></i> Contatos de Emerg√™ncia</h2>
      <div class="grid">
        <article class="contact-card">
          <strong>Seguran√ßa Corporativa</strong>
          <span>Telefone: (11) 4002-8922</span>
          <span>Ramal: 777</span>
          <span class="tag"><i class="fas fa-shield-halved"></i> Atendimento 24h</span>
        </article>
        <article class="contact-card">
          <strong>Pol√≠cia</strong>
          <span>Telefone: 190</span>
          <span class="tag"><i class="fas fa-badge-check"></i> Emerg√™ncia</span>
        </article>
        <article class="contact-card">
          <strong>Bombeiros</strong>
          <span>Telefone: 193</span>
          <span class="tag"><i class="fas fa-fire-extinguisher"></i> Inc√™ndios e resgate</span>
        </article>
        <article class="contact-card">
          <strong>Ambul√¢ncia</strong>
          <span>Telefone: 192</span>
          <span class="tag"><i class="fas fa-briefcase-medical"></i> SAMU</span>
        </article>
        <article class="contact-card">
          <strong>Defesa Civil</strong>
          <span>Telefone: 199</span>
          <span class="tag"><i class="fas fa-helmet-safety"></i> Suporte regional</span>
        </article>
      </div>
    </section>

    <section class="card procedures">
      <h2 style="margin-bottom: 8px;"><i class="fas fa-list-check"></i> Procedimentos de Emerg√™ncia</h2>

      <div class="procedure-block">
        <h3><i class="fas fa-car-burst"></i> Em caso de acidente com ve√≠culo da frota</h3>
        <ul>
          <li>Verifique se h√° feridos e chame socorro m√©dico imediatamente.</li>
          <li>Sinalize adequadamente o local para evitar novos acidentes.</li>
          <li>Entre em contato com a seguran√ßa corporativa.</li>
          <li>Documente a ocorr√™ncia com fotos quando poss√≠vel.</li>
          <li>Aguarde a chegada da autoridade policial para registro do boletim de ocorr√™ncia.</li>
        </ul>
      </div>

      <div class="procedure-block">
        <h3><i class="fas fa-box-open"></i> Em caso de roubo de carga</h3>
        <ul>
          <li>N√£o reaja. Sua seguran√ßa √© prioridade.</li>
          <li>Assim que estiver seguro, contate a central de emerg√™ncia.</li>
          <li>Acione a pol√≠cia atrav√©s do 190.</li>
          <li>Relate o ocorrido com o m√°ximo de detalhes para registro e investiga√ß√£o.</li>
        </ul>
      </div>

      <div class="procedure-block">
        <h3><i class="fas fa-fire"></i> Em caso de inc√™ndio</h3>
        <ul>
          <li>Evacue a √°rea imediatamente seguindo as rotas de fuga.</li>
          <li>Acione o alarme de inc√™ndio e comunique a brigada.</li>
          <li>Se treinado, utilize o extintor apropriado.</li>
          <li>Ligue para o Corpo de Bombeiros (193).</li>
          <li>Dirija-se ao ponto de encontro previsto no plano de evacua√ß√£o.</li>
        </ul>
      </div>
    </section>

    <footer>Multimodal Log√≠stica ¬∑ Central de Seguran√ßa ¬∑ Utilize com responsabilidade</footer>
  </div>

  <div class="modal-overlay" id="modalConfirmacao">
    <div class="modal-card">
      <i class="fas fa-triangle-exclamation" style="font-size:2.4rem;color:#facc15;"></i>
      <h4>Confirmar acionamento?</h4>
      <p>Voc√™ est√° prestes a notificar todas as equipes de seguran√ßa. Confirme apenas se estiver diante de uma emerg√™ncia real.</p>
      <div class="modal-actions">
        <button class="btn-outline" id="btnCancelarModal">Cancelar</button>
        <button class="btn-strong" id="btnConfirmarModal">Confirmar alerta</button>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Estado da aplica√ß√£o
    const state = {
      supabase: null,
      session: null
    };

    // Inicializar Supabase
    async function inicializarSupabase() {
      try {
        const response = await fetch('/api/supabase-config');
        if (!response.ok) {
          throw new Error('Erro ao buscar configura√ß√µes do Supabase');
        }
        const config = await response.json();
        if (!window.supabase) {
          throw new Error('Biblioteca Supabase n√£o carregada');
        }
        state.supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseAnonKey, {
          auth: {
            persistSession: true,
            detectSessionInUrl: true
          }
        });

        // Carregar sess√£o
        const { data } = await state.supabase.auth.getSession();
        if (!data?.session) {
          window.location.href = 'login-motorista.html';
          return false;
        }
        state.session = data.session;
        return true;
      } catch (error) {
        console.error('‚ùå Erro ao inicializar Supabase:', error);
        alert('Erro ao conectar com o sistema. Redirecionando para login...');
        window.location.href = 'login-motorista.html';
        return false;
      }
    }

    // Inicializar quando a p√°gina carregar
    inicializarSupabase();

    const modal = document.getElementById('modalConfirmacao');
    const btnAlerta = document.getElementById('btnAlerta');
    const btnCancelarModal = document.getElementById('btnCancelarModal');
    const btnConfirmarModal = document.getElementById('btnConfirmarModal');

    function toggleModal(open) {
      if (open) {
        modal.classList.add('active');
      } else {
        modal.classList.remove('active');
      }
    }

    btnAlerta.addEventListener('click', () => toggleModal(true));
    btnCancelarModal.addEventListener('click', () => toggleModal(false));
    modal.addEventListener('click', (event) => {
      if (event.target === modal) {
        toggleModal(false);
      }
    });

    btnConfirmarModal.addEventListener('click', async () => {
      toggleModal(false);
      
      // Desabilitar bot√£o durante o processamento
      btnConfirmarModal.disabled = true;
      btnConfirmarModal.textContent = 'Processando...';
      btnAlerta.disabled = true;
      
      try {
        // Verificar se temos sess√£o e token
        if (!state.session || !state.session.access_token) {
          // Tentar recarregar a sess√£o
          const { data } = await state.supabase.auth.getSession();
          if (!data?.session?.access_token) {
            alert('Sess√£o expirada. Redirecionando para login...');
            window.location.href = 'login-motorista.html';
            return;
          }
          state.session = data.session;
        }

        const response = await fetch('/api/emergencia/acionar', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${state.session.access_token}`
          },
          credentials: 'include'
        });

        const result = await response.json();

        if (result.success) {
          const mensagem = `üö® Alerta de emerg√™ncia acionado!\n\n` +
                         `${result.sucessos} notifica√ß√£o(√µes) enviada(s)\n` +
                         `${result.falhas > 0 ? result.falhas + ' falha(s)' : ''}\n\n` +
                         `Equipe de seguran√ßa notificada. Aguarde instru√ß√µes e mantenha a calma.`;
          alert(mensagem);
        } else {
          alert('‚ùå Erro ao acionar alerta:\n\n' + result.error);
        }
      } catch (error) {
        console.error('Erro:', error);
        alert('‚ùå Erro ao acionar alerta de emerg√™ncia. Tente novamente ou entre em contato com a central.');
      } finally {
        btnConfirmarModal.disabled = false;
        btnConfirmarModal.textContent = 'Confirmar alerta';
        btnAlerta.disabled = false;
      }
    });
  </script>
</body>
</html>

