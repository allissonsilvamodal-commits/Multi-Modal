<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NineBox - Avaliação de Potencial x Desempenho - Multimodal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/permissions.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #3b82f6;
            --dark: #1f2937;
            --light: #f8fafc;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
        }

        .header p {
            margin: 10px 0 0;
            opacity: 0.9;
        }

        .content {
            padding: 30px;
        }

        .section-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--dark);
            border-bottom: 3px solid var(--primary);
            padding-bottom: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .table-modern {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .table-modern thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .table-modern th {
            border: none;
            padding: 15px;
            font-weight: 600;
        }

        .table-modern td {
            padding: 15px;
            vertical-align: middle;
        }

        .table-modern tbody tr {
            transition: all 0.2s;
        }

        .table-modern tbody tr:hover {
            background: #f8f9fa;
            transform: scale(1.01);
        }

        /* Matriz 9-Box */
        .ninebox-grid {
            display: grid;
            grid-template-columns: 150px repeat(3, 1fr);
            grid-template-rows: 40px repeat(3, 1fr);
            gap: 2px;
            background: #ddd;
            border: 2px solid #333;
            margin: 30px 0;
            border-radius: 10px;
            overflow: hidden;
        }

        .ninebox-cell {
            background: white;
            padding: 15px;
            min-height: 150px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .ninebox-cell.header-cell {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .ninebox-cell.label-cell {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: 700;
            font-size: 0.85rem;
            justify-content: center;
            align-items: center;
            text-align: center;
            writing-mode: vertical-rl;
            text-orientation: mixed;
        }

        .ninebox-cell.empty {
            background: #f8f9fa;
        }

        /* Cores dos blocos */
        .box-a1 { background: #fff3cd; } /* Enigma - amarelo claro */
        .box-a2 { background: #d1ecf1; } /* Em crescimento - azul claro */
        .box-a3 { background: #d4edda; } /* Destaque - verde claro */
        .box-m1 { background: #f8d7da; } /* Questionável - vermelho claro */
        .box-m2 { background: #fff3cd; } /* Mantenedor - amarelo claro */
        .box-m3 { background: #d1ecf1; } /* Forte desempenho - azul claro */
        .box-b1 { background: #dc3545; color: white; } /* Insuficiente - vermelho */
        .box-b2 { background: #ffc107; } /* Eficaz - amarelo */
        .box-b3 { background: #ffc107; } /* Comprometido - amarelo */

        .box-title {
            font-weight: 700;
            font-size: 0.9rem;
            margin-bottom: 10px;
            padding-bottom: 5px;
            border-bottom: 2px solid rgba(0,0,0,0.1);
        }

        .box-names {
            flex: 1;
            overflow-y: auto;
            font-size: 0.85rem;
        }

        .box-name {
            padding: 5px 8px;
            margin: 3px 0;
            background: rgba(255,255,255,0.7);
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .box-name:hover {
            background: rgba(255,255,255,0.9);
            transform: translateX(5px);
        }

        .box-b1 .box-name,
        .box-b1 .box-title {
            color: white;
        }

        .box-b1 .box-name {
            background: rgba(255,255,255,0.2);
        }

        .filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
        }

        .form-control, .form-select {
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            padding: 10px 15px;
            transition: all 0.3s;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }

        .badge-category {
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .alert-floating {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            transition: all 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(0,0,0,0.2);
        }

        .card-title {
            font-size: 2rem;
            font-weight: 700;
            margin: 0;
        }

        .header .btn-light {
            background: rgba(255,255,255,0.2);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            backdrop-filter: blur(10px);
            transition: all 0.3s;
        }

        .header .btn-light:hover {
            background: rgba(255,255,255,0.3);
            border-color: rgba(255,255,255,0.5);
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <div class="header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-th me-2"></i>NineBox</h1>
                    <p>Avaliação de Potencial x Desempenho</p>
                </div>
                <div>
                    <a href="portal.html" class="btn btn-light btn-sm">
                        <i class="fas fa-arrow-left me-2"></i>Voltar ao Portal
                    </a>
                </div>
            </div>
        </div>

        <div class="content">
            <!-- Filtros -->
            <div class="filters">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Buscar Colaborador</label>
                        <input type="text" id="buscaColaborador" class="form-control" placeholder="Nome, cargo ou departamento...">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Departamento</label>
                        <select id="filtroDepartamento" class="form-select">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label fw-bold">Cargo</label>
                        <select id="filtroCargo" class="form-select">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="col-md-3 d-flex align-items-end gap-2">
                        <button class="btn btn-primary flex-grow-1" onclick="abrirModalAvaliacao()">
                            <i class="fas fa-plus me-2"></i>Nova Avaliação
                        </button>
                        <button class="btn btn-success" onclick="exportarDados()" title="Exportar dados">
                            <i class="fas fa-download"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Estatísticas Rápidas -->
            <div class="row mb-4" id="estatisticasContainer" style="display: none;">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-primary" id="totalAvaliacoes">0</h5>
                            <p class="card-text text-muted">Total de Avaliações</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-success" id="totalDestaques">0</h5>
                            <p class="card-text text-muted">Profissionais Destaque (A3)</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-warning" id="totalCrescimento">0</h5>
                            <p class="card-text text-muted">Em Crescimento (A2)</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <h5 class="card-title text-danger" id="totalInsuficientes">0</h5>
                            <p class="card-text text-muted">Insuficientes (B1)</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tabela de Avaliações -->
            <div class="section-title">
                <i class="fas fa-list me-2"></i>Avaliações Realizadas
            </div>
            <div id="tabelaContainer" class="table-modern">
                <div class="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-3 text-muted">Carregando avaliações...</p>
                </div>
            </div>

            <!-- Matriz 9-Box -->
            <div class="section-title mt-5">
                <i class="fas fa-th me-2"></i>Matriz Potencial x Desempenho
            </div>
            <div id="nineboxContainer">
                <div id="nineboxGrid" class="ninebox-grid">
                    <!-- Grid será gerado dinamicamente -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Avaliação -->
    <div class="modal fade" id="modalAvaliacao" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-user-check me-2"></i>Nova Avaliação NineBox
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formAvaliacao">
                        <div class="mb-3">
                            <label class="form-label fw-bold">Nome do Colaborador *</label>
                            <input type="text" id="nomeColaborador" class="form-control" required 
                                   placeholder="Digite o nome do colaborador" autocomplete="off">
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Cargo *</label>
                                <input type="text" id="cargoColaborador" class="form-control" required 
                                       placeholder="Ex: Supervisor de TI" autocomplete="off">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Departamento *</label>
                                <input type="text" id="departamentoColaborador" class="form-control" required 
                                       placeholder="Ex: Administrativo" autocomplete="off">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Potencial *</label>
                                <select id="potencialAvaliacao" class="form-select" required>
                                    <option value="">Selecione...</option>
                                    <option value="Abaixo da Expectativa">Abaixo da Expectativa</option>
                                    <option value="Dentro da Expectativa">Dentro da Expectativa</option>
                                    <option value="Acima da Expectativa">Acima da Expectativa</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label fw-bold">Desempenho *</label>
                                <select id="desempenhoAvaliacao" class="form-select" required>
                                    <option value="">Selecione...</option>
                                    <option value="Abaixo da Expectativa">Abaixo da Expectativa</option>
                                    <option value="Dentro da Expectativa">Dentro da Expectativa</option>
                                    <option value="Acima da Expectativa">Acima da Expectativa</option>
                                </select>
                            </div>
                        </div>
                        <div class="alert alert-info">
                            <strong>Classificação:</strong> <span id="previewClassificacao" class="fw-bold text-primary">-</span>
                            <br><small class="text-muted" id="previewDescricao"></small>
                        </div>
                        <div class="alert alert-warning" id="alertaDuplicata" style="display: none;">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Atenção:</strong> Já existe uma avaliação para este colaborador. Ao salvar, a avaliação existente será atualizada.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="salvarAvaliacao()">
                        <i class="fas fa-save me-2"></i>Salvar Avaliação
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Usar nome diferente para evitar conflito com possível variável global do Supabase
        // Verificar se já existe antes de declarar
        if (typeof supabaseClient === 'undefined') {
            var supabaseClient = null;
        }
        let todasAvaliacoes = [];
        let avaliacoesFiltradas = [];
        let currentAvaliacaoId = null;

        // Mapeamento de classificação
        const classificacaoMap = {
            'Abaixo da Expectativa-Abaixo da Expectativa': { box: 'B1', nome: 'Insuficiente', class: 'box-b1' },
            'Abaixo da Expectativa-Dentro da Expectativa': { box: 'B2', nome: 'Eficaz', class: 'box-b2' },
            'Abaixo da Expectativa-Acima da Expectativa': { box: 'B3', nome: 'Comprometido', class: 'box-b3' },
            'Dentro da Expectativa-Abaixo da Expectativa': { box: 'M1', nome: 'Questionável', class: 'box-m1' },
            'Dentro da Expectativa-Dentro da Expectativa': { box: 'M2', nome: 'Mantenedor', class: 'box-m2' },
            'Dentro da Expectativa-Acima da Expectativa': { box: 'M3', nome: 'Forte desempenho', class: 'box-m3' },
            'Acima da Expectativa-Abaixo da Expectativa': { box: 'A1', nome: 'Profissional enigma', class: 'box-a1' },
            'Acima da Expectativa-Dentro da Expectativa': { box: 'A2', nome: 'Profissional em crescimento', class: 'box-a2' },
            'Acima da Expectativa-Acima da Expectativa': { box: 'A3', nome: 'Profissional destaque', class: 'box-a3' }
        };

        // Inicialização
        document.addEventListener('DOMContentLoaded', async () => {
            await inicializarSupabase();
            await carregarAvaliacoes();
            configurarEventos();
        });

        async function inicializarSupabase() {
            try {
                const response = await fetch('/api/supabase-config');
                if (!response.ok) throw new Error('Erro ao buscar configuração');
                const config = await response.json();
                supabaseClient = window.supabase.createClient(config.supabaseUrl, config.supabaseAnonKey);
                window.supabase = supabaseClient; // Manter compatibilidade
                console.log('✅ Supabase inicializado com sucesso');
            } catch (error) {
                console.error('Erro ao inicializar Supabase:', error);
                mostrarErro('Erro ao conectar com o banco de dados');
            }
        }

        async function carregarAvaliacoes() {
            try {
                if (!supabaseClient) await inicializarSupabase();

                const { data, error } = await supabaseClient
                    .from('ninebox_avaliacoes')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                todasAvaliacoes = data || [];
                aplicarFiltros();
                atualizarMatriz();
                atualizarEstatisticas();
            } catch (error) {
                console.error('Erro ao carregar avaliações:', error);
                
                // Verificar se é erro de tabela não encontrada
                if (error.code === 'PGRST205' || error.message?.includes('Could not find the table')) {
                    document.getElementById('tabelaContainer').innerHTML = `
                        <div class="alert alert-warning m-3">
                            <h5><i class="fas fa-exclamation-triangle me-2"></i>Tabela não encontrada</h5>
                            <p>A tabela <strong>ninebox_avaliacoes</strong> ainda não foi criada no banco de dados.</p>
                            <hr>
                            <p><strong>Para criar a tabela:</strong></p>
                            <ol>
                                <li>Acesse o <a href="https://supabase.com/dashboard" target="_blank">Supabase Dashboard</a></li>
                                <li>Vá em <strong>SQL Editor</strong> → <strong>New Query</strong></li>
                                <li>Cole o SQL do arquivo <code>sql/criar-tabela-ninebox.sql</code></li>
                                <li>Execute o SQL (Run ou Ctrl+Enter)</li>
                                <li>Recarregue esta página</li>
                            </ol>
                            <p class="mb-0">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Consulte o arquivo <code>INSTRUCOES-CRIAR-TABELA-NINEBOX.md</code> para instruções detalhadas.
                                </small>
                            </p>
                        </div>
                    `;
                } else {
                    mostrarErro('Erro ao carregar avaliações: ' + (error.message || 'Erro desconhecido'));
                    document.getElementById('tabelaContainer').innerHTML = `
                        <div class="alert alert-danger m-3">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Erro ao carregar avaliações: ${error.message || 'Erro desconhecido'}
                        </div>
                    `;
                }
            }
        }

        function aplicarFiltros() {
            const busca = document.getElementById('buscaColaborador')?.value.toLowerCase() || '';
            const dept = document.getElementById('filtroDepartamento')?.value || '';
            const cargo = document.getElementById('filtroCargo')?.value || '';

            avaliacoesFiltradas = todasAvaliacoes.filter(av => {
                const matchBusca = !busca || 
                    av.nome_colaborador.toLowerCase().includes(busca) ||
                    av.cargo.toLowerCase().includes(busca) ||
                    av.departamento.toLowerCase().includes(busca);
                const matchDept = !dept || av.departamento === dept;
                const matchCargo = !cargo || av.cargo === cargo;
                return matchBusca && matchDept && matchCargo;
            });

            atualizarTabela();
            atualizarFiltros();
        }

        function atualizarTabela() {
            const container = document.getElementById('tabelaContainer');
            
            if (avaliacoesFiltradas.length === 0) {
                container.innerHTML = `
                    <div class="alert alert-info m-3">
                        <i class="fas fa-info-circle me-2"></i>
                        Nenhuma avaliação encontrada.
                    </div>
                `;
                return;
            }

            let html = `
                <table class="table table-hover mb-0">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>Nome do Colaborador</th>
                            <th>Cargo</th>
                            <th>Departamento</th>
                            <th>Potencial</th>
                            <th>Desempenho</th>
                            <th>Classificação</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            avaliacoesFiltradas.forEach((av, index) => {
                const key = `${av.potencial}-${av.desempenho}`;
                const classificacao = classificacaoMap[key] || { nome: 'N/A', box: '', class: '' };
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td><strong>${av.nome_colaborador}</strong></td>
                        <td>${av.cargo}</td>
                        <td>${av.departamento}</td>
                        <td><span class="badge bg-info">${av.potencial}</span></td>
                        <td><span class="badge bg-success">${av.desempenho}</span></td>
                        <td><span class="badge-category ${classificacao.class}">${classificacao.nome}</span></td>
                        <td>
                            <button class="btn btn-sm btn-warning" onclick="editarAvaliacao('${av.id}')" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="excluirAvaliacao('${av.id}')" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += `
                    </tbody>
                </table>
            `;

            container.innerHTML = html;
        }

        function atualizarFiltros() {
            // Atualizar opções de departamento
            const deptSelect = document.getElementById('filtroDepartamento');
            const depts = [...new Set(todasAvaliacoes.map(a => a.departamento))].sort();
            deptSelect.innerHTML = '<option value="">Todos</option>' + 
                depts.map(d => `<option value="${d}">${d}</option>`).join('');

            // Atualizar opções de cargo
            const cargoSelect = document.getElementById('filtroCargo');
            const cargos = [...new Set(todasAvaliacoes.map(a => a.cargo))].sort();
            cargoSelect.innerHTML = '<option value="">Todos</option>' + 
                cargos.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function atualizarMatriz() {
            const grid = document.getElementById('nineboxGrid');
            
            // Estrutura da matriz
            const estrutura = [
                ['', 'Abaixo das expectativas', 'Dentro das expectativas', 'Acima das expectativas'],
                ['Acima das expectativas', 'A1', 'A2', 'A3'],
                ['Dentro das expectativas', 'M1', 'M2', 'M3'],
                ['Abaixo das expectativas', 'B1', 'B2', 'B3']
            ];

            let html = '';

            // Cabeçalho superior
            estrutura[0].forEach((cell, colIndex) => {
                if (colIndex === 0) {
                    html += `<div class="ninebox-cell empty"></div>`;
                } else {
                    html += `<div class="ninebox-cell header-cell">${cell}</div>`;
                }
            });

            // Linhas da matriz
            for (let row = 1; row < estrutura.length; row++) {
                estrutura[row].forEach((cell, colIndex) => {
                    if (colIndex === 0) {
                        // Label lateral
                        html += `<div class="ninebox-cell label-cell">${cell}</div>`;
                    } else {
                        // Célula da matriz
                        const boxId = cell;
                        const boxInfo = Object.values(classificacaoMap).find(b => b.box === boxId);
                        const boxClass = boxInfo ? boxInfo.class : '';
                        const boxNome = boxInfo ? boxInfo.nome : '';
                        
                        // Buscar colaboradores nesta categoria
                        const colaboradores = todasAvaliacoes.filter(av => {
                            const key = `${av.potencial}-${av.desempenho}`;
                            const classif = classificacaoMap[key];
                            return classif && classif.box === boxId;
                        });

                        html += `
                            <div class="ninebox-cell ${boxClass}">
                                <div class="box-title">${boxId} - ${boxNome}</div>
                                <div class="box-names">
                                    ${colaboradores.length > 0 
                                        ? colaboradores.map(c => 
                                            `<div class="box-name" title="${c.cargo} - ${c.departamento}">${c.nome_colaborador}</div>`
                                          ).join('')
                                        : '<div class="text-muted small">Nenhum colaborador</div>'
                                    }
                                </div>
                            </div>
                        `;
                    }
                });
            }

            grid.innerHTML = html;
        }

        function abrirModalAvaliacao(id = null) {
            currentAvaliacaoId = id;
            const form = document.getElementById('formAvaliacao');
            form.reset();
            document.getElementById('previewClassificacao').textContent = '-';
            document.getElementById('previewDescricao').textContent = '';
            document.getElementById('alertaDuplicata').style.display = 'none';

            if (id) {
                const av = todasAvaliacoes.find(a => a.id === id);
                if (av) {
                    document.getElementById('nomeColaborador').value = av.nome_colaborador;
                    document.getElementById('cargoColaborador').value = av.cargo;
                    document.getElementById('departamentoColaborador').value = av.departamento;
                    document.getElementById('potencialAvaliacao').value = av.potencial;
                    document.getElementById('desempenhoAvaliacao').value = av.desempenho;
                    atualizarPreview();
                }
            }

            new bootstrap.Modal(document.getElementById('modalAvaliacao')).show();
        }

        function atualizarPreview() {
            const potencial = document.getElementById('potencialAvaliacao').value;
            const desempenho = document.getElementById('desempenhoAvaliacao').value;
            
            if (potencial && desempenho) {
                const key = `${potencial}-${desempenho}`;
                const classificacao = classificacaoMap[key];
                if (classificacao) {
                    document.getElementById('previewClassificacao').textContent = 
                        `${classificacao.box} - ${classificacao.nome}`;
                    
                    // Adicionar descrição baseada na classificação
                    const descricoes = {
                        'B1': 'Colaborador com potencial e desempenho abaixo do esperado. Requer atenção imediata e plano de desenvolvimento.',
                        'B2': 'Colaborador com potencial limitado, mas desempenho dentro do esperado. Pode ser mantido na função atual.',
                        'B3': 'Colaborador comprometido, com desempenho acima do esperado apesar do potencial limitado. Valorizar e reconhecer.',
                        'M1': 'Colaborador com potencial, mas desempenho abaixo do esperado. Investigar causas e desenvolver.',
                        'M2': 'Colaborador mantenedor, com potencial e desempenho dentro do esperado. Estável na função.',
                        'M3': 'Colaborador com forte desempenho, acima do esperado. Potencial dentro do esperado. Considerar promoção.',
                        'A1': 'Colaborador enigma: alto potencial, mas desempenho abaixo do esperado. Investigar barreiras e desenvolver.',
                        'A2': 'Colaborador em crescimento: alto potencial com desempenho dentro do esperado. Investir em desenvolvimento.',
                        'A3': 'Colaborador destaque: alto potencial e desempenho acima do esperado. Priorizar para desenvolvimento e promoção.'
                    };
                    
                    document.getElementById('previewDescricao').textContent = descricoes[classificacao.box] || '';
                }
            } else {
                document.getElementById('previewClassificacao').textContent = '-';
                document.getElementById('previewDescricao').textContent = '';
            }
        }

        async function salvarAvaliacao() {
            const form = document.getElementById('formAvaliacao');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const dados = {
                nome_colaborador: document.getElementById('nomeColaborador').value.trim(),
                cargo: document.getElementById('cargoColaborador').value.trim(),
                departamento: document.getElementById('departamentoColaborador').value.trim(),
                potencial: document.getElementById('potencialAvaliacao').value,
                desempenho: document.getElementById('desempenhoAvaliacao').value
            };

            try {
                if (!supabaseClient) await inicializarSupabase();

                // Verificar duplicatas (mesmo nome, cargo e departamento) - apenas para novos registros
                if (!currentAvaliacaoId) {
                    const { data: duplicatas } = await supabaseClient
                        .from('ninebox_avaliacoes')
                        .select('id, nome_colaborador, cargo, departamento')
                        .eq('nome_colaborador', dados.nome_colaborador)
                        .eq('cargo', dados.cargo)
                        .eq('departamento', dados.departamento);

                    if (duplicatas && duplicatas.length > 0) {
                        const confirmar = confirm(
                            `Já existe uma avaliação para "${dados.nome_colaborador}" ` +
                            `(${dados.cargo} - ${dados.departamento}).\n\n` +
                            `Deseja atualizar a avaliação existente ou criar uma nova?`
                        );
                        
                        if (confirmar) {
                            // Atualizar a existente
                            currentAvaliacaoId = duplicatas[0].id;
                        } else {
                            return; // Cancelar
                        }
                    }
                }

                let result;
                if (currentAvaliacaoId) {
                    // Atualizar
                    const { data, error } = await supabaseClient
                        .from('ninebox_avaliacoes')
                        .update(dados)
                        .eq('id', currentAvaliacaoId)
                        .select();
                    result = { data, error };
                } else {
                    // Criar
                    const { data, error } = await supabaseClient
                        .from('ninebox_avaliacoes')
                        .insert([dados])
                        .select();
                    result = { data, error };
                }

                if (result.error) throw result.error;

                mostrarSucesso(currentAvaliacaoId ? 'Avaliação atualizada com sucesso!' : 'Avaliação criada com sucesso!');
                bootstrap.Modal.getInstance(document.getElementById('modalAvaliacao')).hide();
                await carregarAvaliacoes();
            } catch (error) {
                console.error('Erro ao salvar avaliação:', error);
                mostrarErro('Erro ao salvar avaliação: ' + (error.message || 'Erro desconhecido'));
            }
        }

        function editarAvaliacao(id) {
            abrirModalAvaliacao(id);
        }

        async function excluirAvaliacao(id) {
            if (!confirm('Tem certeza que deseja excluir esta avaliação?')) return;

            try {
                if (!supabaseClient) await inicializarSupabase();

                const { error } = await supabaseClient
                    .from('ninebox_avaliacoes')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                mostrarSucesso('Avaliação excluída com sucesso!');
                await carregarAvaliacoes();
            } catch (error) {
                console.error('Erro ao excluir avaliação:', error);
                mostrarErro('Erro ao excluir avaliação: ' + (error.message || 'Erro desconhecido'));
            }
        }

        function configurarEventos() {
            document.getElementById('buscaColaborador')?.addEventListener('input', aplicarFiltros);
            document.getElementById('filtroDepartamento')?.addEventListener('change', aplicarFiltros);
            document.getElementById('filtroCargo')?.addEventListener('change', aplicarFiltros);
            
            document.getElementById('potencialAvaliacao')?.addEventListener('change', atualizarPreview);
            document.getElementById('desempenhoAvaliacao')?.addEventListener('change', atualizarPreview);
        }

        function mostrarSucesso(mensagem) {
            mostrarMensagem(mensagem, 'success');
        }

        function mostrarErro(mensagem) {
            mostrarMensagem(mensagem, 'danger');
        }

        function mostrarMensagem(mensagem, tipo) {
            const alert = document.createElement('div');
            alert.className = `alert alert-${tipo} alert-floating alert-dismissible fade show`;
            alert.innerHTML = `${mensagem}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
            document.body.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function atualizarEstatisticas() {
            if (todasAvaliacoes.length === 0) {
                document.getElementById('estatisticasContainer').style.display = 'none';
                return;
            }

            document.getElementById('estatisticasContainer').style.display = 'flex';
            
            const total = todasAvaliacoes.length;
            const destaques = todasAvaliacoes.filter(av => {
                const key = `${av.potencial}-${av.desempenho}`;
                return classificacaoMap[key]?.box === 'A3';
            }).length;
            
            const crescimento = todasAvaliacoes.filter(av => {
                const key = `${av.potencial}-${av.desempenho}`;
                return classificacaoMap[key]?.box === 'A2';
            }).length;
            
            const insuficientes = todasAvaliacoes.filter(av => {
                const key = `${av.potencial}-${av.desempenho}`;
                return classificacaoMap[key]?.box === 'B1';
            }).length;

            document.getElementById('totalAvaliacoes').textContent = total;
            document.getElementById('totalDestaques').textContent = destaques;
            document.getElementById('totalCrescimento').textContent = crescimento;
            document.getElementById('totalInsuficientes').textContent = insuficientes;
        }

        function exportarDados() {
            if (avaliacoesFiltradas.length === 0) {
                mostrarErro('Não há dados para exportar');
                return;
            }

            // Criar CSV
            let csv = 'Nome do Colaborador,Cargo,Departamento,Potencial,Desempenho,Classificação\n';
            
            avaliacoesFiltradas.forEach(av => {
                const key = `${av.potencial}-${av.desempenho}`;
                const classificacao = classificacaoMap[key] || { nome: 'N/A' };
                
                csv += `"${av.nome_colaborador}","${av.cargo}","${av.departamento}","${av.potencial}","${av.desempenho}","${classificacao.nome}"\n`;
            });

            // Criar blob e download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `ninebox_avaliacoes_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            mostrarSucesso('Dados exportados com sucesso!');
        }
    </script>
</body>
</html>

