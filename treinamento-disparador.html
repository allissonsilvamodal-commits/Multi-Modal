<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treinamento ‚Äì Disparador de Mensagens</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- QR Code Library -->
    <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
    <!-- HTML to PDF Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --primary:#6759ff;
            --secondary:#8b5cf6;
            --bg-page:#edf2ff;
            --bg-card:#ffffff;
            --text:#1f2937;
        }
        body{
            font-family:"Segoe UI",system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
            background:var(--bg-page);
            padding:2rem 0;
            color:var(--text);
        }
        .container-training{max-width:960px;margin:0 auto;}
        .hero{
            background:linear-gradient(135deg,var(--primary),var(--secondary));
            color:#fff;border-radius:20px;padding:2rem;
            box-shadow:0 18px 40px rgba(103,89,255,.25);
        }
        .hero h1{font-weight:800;margin-bottom:.4rem;}
        .hero p{opacity:.9;margin:0;}
        .hero .tag{display:inline-flex;align-items:center;gap:.4rem;background:rgba(0,0,0,.25);padding:.2rem .8rem;border-radius:999px;font-weight:600;}
        a.btn-back{
            display:inline-flex;align-items:center;gap:.5rem;
            padding:.55rem 1rem;border-radius:999px;
            background:#111827;color:#fff;text-decoration:none;
            margin-bottom:1.25rem;font-weight:600;
        }
        section.training-block{
            margin-top:1.5rem;
            background:var(--bg-card);
            border-radius:18px;
            padding:1.75rem;
            box-shadow:0 16px 35px rgba(31,41,55,.08);
        }
        section.training-block h2{
            font-size:1.2rem;
            font-weight:800;
            margin-bottom:1rem;
            display:flex;
            align-items:center;
            gap:.5rem;
        }
        .step-card{
            border-left:4px solid var(--primary);
            background:#f8fafc;
            padding:1rem 1.25rem;
            border-radius:12px;
            margin:.8rem 0;
            box-shadow:0 8px 18px rgba(0,0,0,.05);
        }
        .media-figure{
            margin:1.5rem 0;
            text-align:center;
        }
        .media-figure img{
            width:100%;
            border-radius:16px;
            border:3px solid #e5e7eb;
            box-shadow:0 20px 45px rgba(15,23,42,.18);
        }
        .media-figure figcaption{
            margin-top:.6rem;font-size:.9rem;color:#4b5563;
            background:#f3f4f6;border-radius:10px;padding:.75rem 1rem;
        }
        .info-box,.warning-box,.tip-box{
            padding:1rem 1.2rem;border-radius:12px;margin:1rem 0;
        }
        .info-box{background:#e0f2fe;border-left:5px solid #0284c7;}
        .warning-box{background:#fee2e2;border-left:5px solid #dc2626;}
        .tip-box{background:#fef3c7;border-left:5px solid #f59e0b;}
        .signature-card{
            border:2px dashed #cbd5f5;
            padding:1.25rem;
            border-radius:16px;
            background:#f8fafc;
        }
        .signature-card label{font-weight:600;color:#111827;margin-top:.75rem;}
        canvas.signature-canvas{
            width:100%;height:200px;
            border:2px solid #e2e8f0;
            border-radius:12px;
            background:#fff;
        }
        
        /* Estilos para impress√£o/PDF */
        @media print {
            body { background: white !important; color: #1f2937 !important; }
            .btn-back, button, .signature-card, canvas { display: none !important; }
        }
        
        /* Estilos espec√≠ficos para PDF - reduzir espa√ßamentos */
        .pdf-optimized .training-block {
            margin-top: 1rem !important;
            margin-bottom: 1rem !important;
            padding: 1.25rem !important;
            page-break-inside: avoid !important;
        }
        
        .pdf-optimized .step-card {
            margin-top: 0.5rem !important;
            margin-bottom: 0.5rem !important;
            page-break-inside: avoid !important;
        }
        
        .pdf-optimized .media-figure {
            margin-top: 0.75rem !important;
            margin-bottom: 0.75rem !important;
            page-break-inside: avoid !important;
        }
        
        .pdf-optimized .hero {
            margin-bottom: 1.5rem !important;
            padding: 1.5rem !important;
        }
        
        .pdf-optimized h1,
        .pdf-optimized h2,
        .pdf-optimized h3 {
            page-break-after: avoid !important;
            page-break-inside: avoid !important;
            margin-top: 0.75rem !important;
            margin-bottom: 0.5rem !important;
        }
        
        .pdf-optimized p {
            margin-top: 0.5rem !important;
            margin-bottom: 0.5rem !important;
        }
        
        .pdf-optimized ul,
        .pdf-optimized ol {
            margin-top: 0.5rem !important;
            margin-bottom: 0.5rem !important;
        }
        
        /* Estilos para o bot√£o de download PDF */
        #btnBaixarPDF {
            transition: all 0.3s ease;
        }
        #btnBaixarPDF:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4) !important;
        }
        #btnBaixarPDF:active {
            transform: translateY(0);
        }
    </style>
</head>
<body>
<main class="container-training">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <a class="btn-back" href="treinamentos.html"><i class="fas fa-chevron-left"></i>Voltar para Treinamentos</a>
        <button type="button" class="btn btn-success" onclick="baixarTreinamentoPDF()" id="btnBaixarPDF" style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.55rem 1rem; border-radius: 999px; background: #10b981; color: #fff; border: none; font-weight: 600; box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3); transition: all 0.3s ease;">
            <i class="fas fa-file-pdf"></i>
            Baixar PDF
        </button>
    </div>
    <header class="hero">
        <span class="tag"><i class="fas fa-user-graduate"></i> Treinamento obrigat√≥rio</span>
        <h1><i class="fas fa-paper-plane me-2"></i>Disparador de Mensagens WhatsApp</h1>
        <p>Este guia mostra, em detalhes, como sair do ‚Äúpainel vazio‚Äù at√© o preenchimento da declara√ß√£o final, evitando erros que podem bloquear a linha ou gerar disparos incorretos.</p>
        <ul style="margin-top:1rem;padding-left:1.25rem;list-style:disc;opacity:.9">
            <li><strong>Tempo estimado:</strong> 15 minutos para ler + 5 minutos para assinar.</li>
            <li><strong>P√∫blico:</strong> times Operacional, Comercial e Monitoramento que utilizam o disparador.</li>
            <li><strong>Objetivo:</strong> garantir envios rastre√°veis, seguros e relevantes para motoristas.</li>
        </ul>
    </header>

    <section class="training-block" id="preparacao">
        <h2><i class="fas fa-filter"></i>1. Prepara√ß√£o e leitura do painel</h2>
        <p>Antes de clicar em qualquer bot√£o, reserve 30 segundos para entender o cen√°rio do dia. As decis√µes tomadas na prepara√ß√£o evitam retrabalho, mensagens fora do contexto e disparos para motoristas errados.</p>
        <div class="step-card">
            <strong>1.1 Acesso inicial</strong>
            <ul>
                <li>Abra <strong>Dashboard ‚ñ∏ Disparador</strong> e confirme se voc√™ est√° logado com um usu√°rio autorizado.</li>
                <li>Leia os indicadores do topo (Total, Ativos, Categoria ativa) para entender o contexto antes de qualquer filtro.</li>
                <li>Escolha a categoria operacional do dia (leve, m√©dio ou pesado). Todo o restante do fluxo partir√° dessa escolha.</li>
            </ul>
            <p class="mb-0">Se algum indicador estiver com valor incoerente (ex.: ‚ÄúMotoristas ativos = 0‚Äù), acione o time de dados antes de continuar.</p>
    </div>
        <figure class="media-figure">
            <img src="treinamento-imagens/painel-inicial.png?v=20251124T03" alt="Tela inicial do painel">
            <figcaption>IMAGEM 1 ‚Äì Painel com cards de categoria e indicadores principais.</figcaption>
        </figure>
        <div class="step-card">
            <strong>1.2 Cards de categoria</strong>
            <p>Cada card dispara a atualiza√ß√£o da base e dos indicadores. Aguarde a anima√ß√£o de carregamento terminar antes de aplicar filtros adicionais para evitar consultas duplicadas.</p>
            <p class="mb-0">Use a legenda da linha superior (‚ÄúCategoria ativa‚Äù) para validar se voc√™ est√° disparando para o p√∫blico correto.</p>
                </div>
        <figure class="media-figure">
            <img src="treinamento-imagens/cards-categorias.png?v=20251124T03" alt="Cards de categorias">
            <figcaption>IMAGEM 2 ‚Äì Destaque visual de um card selecionado.</figcaption>
        </figure>
        <div class="step-card">
            <strong>1.3 Filtros combinados</strong>
            <p>Recomenda√ß√µes para cada filtro:</p>
            <ul>
                <li><strong>Tipo de ve√≠culo</strong>: restringe o porte (Truck, Carreta etc.). Combine com categoria para listas menores.</li>
                <li><strong>Carroceria</strong>: √∫til para opera√ß√µes espec√≠ficas (Sider, Ba√∫, Plataforma).</li>
                <li><strong>Estado + Status</strong>: identifique motoristas dispon√≠veis na regi√£o da coleta.</li>
                <li><strong>Busca livre</strong>: aceita nome, telefone ou parte do e-mail.</li>
                <li><strong>Apenas favoritos</strong>: reduz para motoristas previamente homologados.</li>
            </ul>
            <p>Preencha os filtros de cima para baixo; cada altera√ß√£o executa uma nova consulta. Se precisar trocar tudo, clique primeiro em ‚ÄúLimpar filtros‚Äù para n√£o herdar par√¢metros antigos.</p>
            <p class="mb-0"><strong>Boa pr√°tica:</strong> anote em um bloco quais filtros foram usados. Isso facilita replicar o disparo ou explicar a estrat√©gia posteriormente.</p>
            </div>
        <figure class="media-figure">
            <img src="treinamento-imagens/filtros.png?v=20251124T03" alt="Se√ß√£o de filtros">
            <figcaption>IMAGEM 3 ‚Äì √Årea completa de filtros com a√ß√µes r√°pidas.</figcaption>
        </figure>
        <figure class="media-figure">
            <img src="treinamento-imagens/favoritos-lista.png?v=20251124T03" alt="Bot√£o de favoritos na lista">
            <figcaption>IMAGEM 4 ‚Äì Estrelar motoristas cria uma curadoria pr√≥pria por usu√°rio.</figcaption>
        </figure>
        <figure class="media-figure">
            <img src="treinamento-imagens/filtro-favoritos.png?v=20251124T03" alt="Filtro apenas favoritos">
            <figcaption>IMAGEM 5 ‚Äì Ative ‚ÄúApenas favoritos‚Äù quando precisar disparar somente para motoristas validados.</figcaption>
        </figure>
        <div class="tip-box mb-0">Dica: combine ‚ÄúCategoria pesada + Carreta + Estado SP + Favoritos‚Äù para disparos cir√∫rgicos em opera√ß√µes urgentes.</div>
    </section>

    <section class="training-block" id="selecao">
        <h2><i class="fas fa-users"></i>2. Sele√ß√£o de motoristas</h2>
        <div class="step-card">
            <strong>2.1 Sele√ß√£o individual</strong>
            <p>Ao clicar em um motorista, o card fica azul e o contador ‚ÄúX selecionados‚Äù sobe. Essa confirma√ß√£o visual evita disparos para perfis indevidos.</p>
            <p class="mb-0">Passe o mouse sobre o card para ver telefone, classe e carroceria antes de confirmar a sele√ß√£o.</p>
            </div>
        <figure class="media-figure">
            <img src="treinamento-imagens/motoristas-selecionados.png?v=20251124T03" alt="Motoristas selecionados">
            <figcaption>IMAGEM 6 ‚Äì Destaque e contador ‚ÄúX selecionados‚Äù.</figcaption>
        </figure>
        <div class="step-card">
            <strong>2.2 Sele√ß√£o em massa</strong>
            <ul>
                <li><strong>Selecionar Todos:</strong> aplica-se a todos os resultados filtrados (use somente ap√≥s revisar o filtro).</li>
                <li><strong>Selecionar P√°gina:</strong> marca apenas os itens vis√≠veis. Ideal para lotes menores ou valida√ß√£o por p√°ginas.</li>
                <li><strong>Limpar Sele√ß√£o:</strong> remove tudo para reiniciar o processo com seguran√ßa.</li>
            </ul>
            <p class="mb-0">Regra de ouro: nunca clique em ‚ÄúSelecionar Todos‚Äù sem antes testar a mensagem em alguns contatos.</p>
        </div>
        <figure class="media-figure">
            <img src="treinamento-imagens/botoes-selecao.png?v=20251124T03" alt="Bot√µes de sele√ß√£o">
            <figcaption>IMAGEM 7 ‚Äì Bot√µes de sele√ß√£o em massa.</figcaption>
        </figure>
        <div class="info-box">
            <strong>Checklist r√°pido antes de seguir para a mensagem:</strong>
            <ul class="mb-0">
                <li>O contador ‚ÄúX selecionados‚Äù corresponde ao que voc√™ pretende disparar?</li>
                <li>H√° pelo menos um favorito na sele√ß√£o? (Evite listas totalmente frias).</li>
                <li>Os motoristas selecionados fazem sentido para o filtro/regi√£o? Revise se necess√°rio.</li>
            </ul>
        </div>
        <div class="warning-box mb-0">Aten√ß√£o: sempre valide se os n√∫meros possuem DDI + DDD antes de disparar.</div>
    </section>

    <section class="training-block" id="mensagem">
        <h2><i class="fas fa-comment-dots"></i>3. Composi√ß√£o da mensagem</h2>
        <div class="step-card">
            <strong>Vari√°veis suportadas</strong>
            <p>Use vari√°veis para personalizar o texto automaticamente:</p>
            <p class="mb-2"><code>{{name}}</code>, <code>{{telefone}}</code>, <code>{{estado}}</code>, <code>{{classe_veiculo}}</code>, <code>{{tipo_veiculo}}</code>, <code>{{tipo_carroceria}}</code></p>
            <p class="mb-0">Exemplo: <code>Ol√° {{name}}, temos vaga urgente para {{classe_veiculo}} em {{estado}}.</code></p>
                </div>
        <figure class="media-figure">
            <img src="treinamento-imagens/composicao-mensagem.png?v=20251124T03" alt="Composi√ß√£o de mensagem">
            <figcaption>IMAGEM 8 ‚Äì Campo de mensagem com vari√°veis e exemplo.</figcaption>
        </figure>
        <div class="step-card">
            <strong>Boas pr√°ticas</strong>
            <ul>
                <li>Seja direto e respeitoso; evite letras mai√∫sculas em excesso.</li>
                <li>Compartilhe links apenas de dom√≠nios confi√°veis (site institucional, formul√°rios oficiais).</li>
                <li>Evite prometer valores ou vantagens que n√£o estejam confirmados.</li>
                <li>Teste a mensagem ap√≥s cada ajuste para ver como as vari√°veis ser√£o renderizadas.</li>
            </ul>
            <p class="mb-0"><strong>Modelo sugerido:</strong> ‚Äú{{name}}, a Multimodal tem carga para {{classe_veiculo}} com carroceria {{tipo_carroceria}} saindo de {{estado}}. Interesse? Responda SIM.‚Äù</p>
            </div>
        <div class="tip-box mb-0">Use emoji com modera√ß√£o (at√© 2). Eles ajudam a humanizar, mas excesso pode aumentar taxa de bloqueio.</div>
    </section>

    <section class="training-block" id="evolution-api">
        <h2><i class="fas fa-plug"></i>4. Configura√ß√£o da Evolution API</h2>
        <p>Antes de iniciar os disparos, √© essencial garantir que sua inst√¢ncia Evolution API esteja conectada e funcionando corretamente. A Evolution API √© respons√°vel pelo envio das mensagens via WhatsApp.</p>
        <div class="step-card">
            <strong>4.1 Verificar Status da Inst√¢ncia</strong>
            <p>No painel do disparador, voc√™ encontrar√° um card "Status Evolution API" que mostra o estado atual da sua conex√£o:</p>
            <ul>
                <li><strong>Conectado:</strong> Inst√¢ncia ativa e pronta para envios</li>
                <li><strong>Desconectado:</strong> √â necess√°rio gerar um novo QR Code</li>
                <li><strong>Erro:</strong> Verifique as configura√ß√µes em Settings</li>
            </ul>
            <p class="mb-0">Sempre verifique o status antes de iniciar um disparo para evitar falhas.</p>
        </div>
        <div class="step-card">
            <strong>4.2 Gerar QR Code para Conectar</strong>
            <p>Se sua inst√¢ncia estiver desconectada, voc√™ precisar√° gerar um novo QR Code:</p>
            <ol>
                <li>Clique no bot√£o <strong>"Gerar QR Code"</strong> no card de Status Evolution API</li>
                <li>Um modal ser√° aberto com o QR Code e instru√ß√µes detalhadas</li>
                <li>Abra o WhatsApp no seu celular</li>
                <li>V√° em <strong>Menu (‚ãÆ)</strong> ‚Üí <strong>Aparelhos conectados</strong> ‚Üí <strong>Conectar um aparelho</strong></li>
                <li>Escaneie o QR Code exibido no modal</li>
                <li>Aguarde a confirma√ß√£o de conex√£o</li>
            </ol>
            <p class="mb-0"><strong>Importante:</strong> O QR Code expira em alguns minutos. Se expirar, gere um novo clicando em "Atualizar QR Code".</p>
        </div>
        <div class="step-card">
            <strong>4.3 Desconectar Inst√¢ncia</strong>
            <p>Se precisar desconectar sua inst√¢ncia (por exemplo, para conectar em outro dispositivo):</p>
            <ol>
                <li>Clique no bot√£o <strong>"Deslogar"</strong> no card de Status Evolution API</li>
                <li>Confirme a a√ß√£o no di√°logo</li>
                <li>A inst√¢ncia ser√° desconectada e voc√™ precisar√° gerar um novo QR Code para reconectar</li>
            </ol>
            <p class="mb-0"><strong>Aten√ß√£o:</strong> Ao desconectar, todos os envios ser√£o interrompidos at√© que voc√™ reconecte.</p>
        </div>
        <div class="info-box">
            <strong><i class="fas fa-lightbulb me-2"></i>Dicas importantes:</strong>
            <ul class="mb-0">
                <li>Mantenha o celular com WhatsApp conectado pr√≥ximo ao computador durante os disparos</li>
                <li>Se o QR Code n√£o aparecer, verifique se sua inst√¢ncia est√° configurada em <strong>Settings > Evolution API</strong></li>
                <li>Em caso de problemas persistentes, entre em contato com o administrador do sistema</li>
            </ul>
        </div>
        <div class="warning-box mb-3">
            <strong><i class="fas fa-exclamation-triangle me-2"></i>Aten√ß√£o:</strong> Nunca compartilhe seu QR Code ou credenciais da Evolution API. Cada usu√°rio deve ter sua pr√≥pria inst√¢ncia configurada.
        </div>
        
        <!-- Bot√µes de teste (MODO SIMULA√á√ÉO) -->
        <div class="step-card" style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border-left: 4px solid #667eea;">
            <div class="alert alert-warning border-0 mb-3" style="border-radius: 12px; background: #fff3cd;">
                <i class="fas fa-graduation-cap me-2"></i>
                <strong>Modo Treinamento:</strong> Os bot√µes abaixo s√£o apenas para demonstra√ß√£o. Nenhuma a√ß√£o real ser√° executada.
            </div>
            <strong><i class="fas fa-flask me-2"></i>Teste as funcionalidades (Simula√ß√£o):</strong>
            <p class="mb-3">Use os bot√µes abaixo para ver como funcionam as funcionalidades de QR Code e logout. Estas s√£o simula√ß√µes seguras que n√£o afetam sua inst√¢ncia real:</p>
            <div class="d-flex gap-2 flex-wrap">
                <button type="button" class="btn btn-primary" onclick="gerarQRCodeEvolution()">
                    <i class="fas fa-qrcode me-2"></i>Gerar QR Code (Simula√ß√£o)
                </button>
                <button type="button" class="btn btn-danger" onclick="deslogarInstanciaEvolution()">
                    <i class="fas fa-sign-out-alt me-2"></i>Deslogar Inst√¢ncia (Simula√ß√£o)
                </button>
            </div>
            <p class="mt-3 mb-0 text-muted" style="font-size: 0.9rem;">
                <i class="fas fa-shield-alt me-1"></i>
                <strong>Seguran√ßa:</strong> Estas s√£o simula√ß√µes que mostram como as funcionalidades funcionam, mas n√£o executam a√ß√µes reais. No painel principal, os bot√µes executam a√ß√µes reais.
            </p>
        </div>
    </section>

    <section class="training-block" id="seguranca">
        <h2><i class="fas fa-user-shield"></i>5. Par√¢metros de seguran√ßa</h2>
        <figure class="media-figure">
            <img src="treinamento-imagens/configuracoes-seguranca.png?v=20251124T03" alt="Modal de configura√ß√µes de seguran√ßa">
            <figcaption>IMAGEM 9 ‚Äì Limites, intervalos e simula√ß√£o de digita√ß√£o.</figcaption>
        </figure>
        <div class="step-card">
            <strong>Checklist obrigat√≥rio</strong>
            <ul>
                <li>Intervalo aleat√≥rio ‚â• 3 segundos para manter ritmo humano.</li>
                <li>Limite por janela: m√°ximo 50 mensagens a cada 5 minutos.</li>
                <li>Cooldown: respeite de 15 a 30 minutos quando atingir o limite.</li>
                <li>Simula√ß√£o de digita√ß√£o: mantenha ativa para reduzir bloqueios.</li>
            </ul>
            <p class="mb-0">Antes de salvar, verbalize os valores em voz alta. Parece exagero, mas ajuda a evitar n√∫meros errados.</p>
            <div class="warning-box mt-3 mb-0">Altera√ß√µes agressivas s√£o responsabilidade do operador e podem bloquear a linha definitivamente.</div>
            </div>
    </section>

    <section class="training-block" id="teste-disparo">
        <h2><i class="fas fa-clipboard-check"></i>6. Testes e disparo</h2>
        <figure class="media-figure">
            <img src="treinamento-imagens/area-testes.png?v=20251124T03" alt="√Årea de testes">
            <figcaption>IMAGEM 10 ‚Äì Telefone de teste e bot√µes ‚ÄúEnviar teste‚Äù / ‚ÄúTestar mensagem‚Äù.</figcaption>
        </figure>
        <figure class="media-figure">
            <img src="treinamento-imagens/disparo-progresso.png?v=20251124T03" alt="Progresso do disparo">
            <figcaption>IMAGEM 11 ‚Äì Bot√µes Iniciar/Parar e contadores.</figcaption>
        </figure>
        <div class="step-card">
            <strong>Fluxo recomendado para disparar</strong>
            <ol class="mb-0">
                <li>Preencha o campo ‚ÄúTelefone para teste‚Äù e clique em <strong>Enviar teste</strong>.</li>
                <li>Use o bot√£o <strong>Testar mensagem</strong> para revisar a formata√ß√£o e vari√°veis.</li>
                <li>Valide manualmente o retorno dos tr√™s primeiros contatos reais.</li>
                <li>S√≥ ent√£o clique em <strong>Iniciar disparo</strong>. Durante o envio, monitore ‚ÄúEnviados, Falhas, Total‚Äù.</li>
                <li>Caso precise pausar, use o bot√£o <strong>Parar disparo</strong>; retomar manualmente evita filas duplicadas.</li>
            </ol>
                </div>
        <div class="tip-box">Sempre que reiniciar o disparo, revise se os mesmos motoristas ainda est√£o selecionados para evitar mensagens repetidas.</div>
    </section>

    <section class="training-block" id="logs">
        <h2><i class="fas fa-database"></i>7. Logs e BI</h2>
        <p>Todos os envios s√£o registrados na tabela <strong>disparos_log</strong> com usu√°rio, hor√°rio, telefone e status. Isso permite auditoria completa em caso de d√∫vidas.</p>
        <div class="step-card">
            <strong>Como consultar os registros</strong>
            <ul class="mb-0">
                <li>Acesse o painel de BI ou solicite o export no menu ‚ÄúLogs‚Äù.</li>
                <li>Filtre por data, usu√°rio e departamento para encontrar disparos espec√≠ficos.</li>
                <li>Analise os campos ‚Äústatus‚Äù (sucesso/falha) e ‚Äúmensagem‚Äù para entender eventuais retornos do WhatsApp.</li>
            </ul>
            </div>
        <figure class="media-figure">
            <img src="treinamento-imagens/bi-disparos.png?v=20251124T03" alt="Painel BI Disparos">
            <figcaption>IMAGEM 12 ‚Äì KPIs e filtros do BI.</figcaption>
        </figure>
        <div class="info-box mb-0">Use o BI semanalmente para acompanhar tend√™ncia de falhas, hor√°rios de maior volume e necessidade de ajustar os par√¢metros de seguran√ßa.</div>
    </section>

    <section class="training-block" id="assinatura">
        <h2><i class="fas fa-signature"></i>8. Declara√ß√£o de conclus√£o</h2>
        <p>Finalize o treinamento registrando seu aceite. Esse registro comprova que voc√™ compreendeu as responsabilidades e boas pr√°ticas do disparador.</p>
        <div class="signature-card">
            <label for="sigNome">Nome completo</label>
            <input id="sigNome" class="form-control" placeholder="Digite seu nome">
            <label for="sigCPF" class="mt-3">CPF</label>
            <input id="sigCPF" class="form-control" placeholder="000.000.000-00">
            <label for="sigData" class="mt-3">Data</label>
            <input id="sigData" type="date" class="form-control">
            <label class="mt-3">Assinatura digital *</label>
            <canvas id="signatureCanvas" class="signature-canvas"></canvas>
            <div class="d-flex gap-2 mt-3 flex-wrap">
                <button class="btn btn-secondary btn-sm" type="button" onclick="limparAssinatura()">
                    <i class="fas fa-eraser me-2"></i>Limpar assinatura
                </button>
                <button id="btnAssinar" class="btn btn-primary btn-sm" type="button">
                    <i class="fas fa-file-signature me-2"></i>Salvar declara√ß√£o
            </button>
        </div>
            <p class="mt-3 mb-0 text-secondary" style="font-size:.9rem">Os registros ficam dispon√≠veis para auditoria. Sempre que houver atualiza√ß√£o do treinamento, um novo aceite ser√° solicitado.</p>
    </div>
    </section>
</main>

<!-- Modal QR Code Evolution -->
<div class="modal fade" id="modalQRCodeEvolution" tabindex="-1" aria-labelledby="modalQRCodeEvolutionLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content" style="border-radius: 16px; overflow: hidden; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
      <div class="modal-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 1.5rem;">
        <h5 class="modal-title" id="modalQRCodeEvolutionLabel" style="font-weight: 600;">
          <i class="fas fa-qrcode me-2"></i>Conectar Inst√¢ncia Evolution
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body" style="padding: 2rem; background: #f8f9fa;">
        <!-- Instru√ß√µes -->
        <div class="alert alert-info border-0 shadow-sm mb-4" style="border-radius: 12px; background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);">
          <div class="d-flex align-items-start">
            <i class="fas fa-info-circle fa-2x me-3 mt-1" style="color: #1976d2;"></i>
            <div>
              <h6 class="alert-heading mb-2" style="color: #1565c0; font-weight: 600;">
                <i class="fas fa-mobile-alt me-2"></i>Como conectar:
              </h6>
              <ol class="mb-0 ps-3" style="color: #424242; line-height: 1.8;">
                <li>Abra o <strong>WhatsApp</strong> no seu celular</li>
                <li>Toque em <strong>Menu (‚ãÆ)</strong> ou <strong>Configura√ß√µes</strong></li>
                <li>V√° em <strong>Aparelhos conectados</strong></li>
                <li>Toque em <strong>Conectar um aparelho</strong></li>
                <li>Escaneie o QR Code abaixo</li>
              </ol>
            </div>
          </div>
        </div>

        <!-- Container do QR Code -->
        <div class="text-center mb-4">
          <div id="qrcodeEvolutionContainer" class="d-flex justify-content-center align-items-center" 
               style="min-height: 320px; background: white; border-radius: 16px; padding: 2rem; box-shadow: 0 4px 20px rgba(0,0,0,0.1); position: relative;">
            <div class="text-muted w-100">
              <div class="loading-spinner mb-3" style="width: 50px; height: 50px; margin: 0 auto;"></div>
              <p class="mb-0" style="font-size: 1.1rem; font-weight: 500;">Gerando QR Code...</p>
            </div>
          </div>
          
          <!-- Informa√ß√µes adicionais -->
          <div class="mt-3">
            <p class="mb-2" id="qrcodeEvolutionInfo" style="color: #666; font-size: 0.95rem;">
              <i class="fas fa-sync-alt me-2"></i>Use o aplicativo WhatsApp para escanear o c√≥digo.
            </p>
            <small class="text-muted d-block" id="qrcodeEvolutionStatus" style="font-size: 0.85rem;"></small>
          </div>
        </div>

        <!-- Dica -->
        <div class="alert alert-warning border-0 shadow-sm mb-0" style="border-radius: 12px; background: #fff3cd;">
          <div class="d-flex align-items-center">
            <i class="fas fa-lightbulb me-2" style="color: #856404;"></i>
            <small class="mb-0" style="color: #856404;">
              <strong>Dica:</strong> Certifique-se de que a tela do celular est√° com brilho m√°ximo para facilitar a leitura do QR Code.
            </small>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="background: #f8f9fa; border-top: 1px solid #e0e0e0; padding: 1rem 1.5rem;">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          <i class="fas fa-times me-2"></i>Fechar
        </button>
        <button type="button" class="btn btn-primary" id="btnAtualizarQRCode" style="display: none;">
          <i class="fas fa-sync-alt me-2"></i>Atualizar QR Code
        </button>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(function preloadImages(){
    const VERSION = '20251124T03';
    document.querySelectorAll('.media-figure img').forEach(img => {
        const baseSrc = img.getAttribute('src').split('?')[0];
        img.src = `${baseSrc}?v=${VERSION}`;
    });
})();
</script>
<script>
(function signaturePad(){
  const canvas = document.getElementById('signatureCanvas');
  const ctx = canvas.getContext('2d');
  let drawing = false;
  let lastX = 0, lastY = 0;
  
  function resizeCanvas() {
    const rect = canvas.getBoundingClientRect();
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    canvas.width = rect.width;
    canvas.height = 200;
    ctx.putImageData(imageData, 0, 0);
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.strokeStyle = '#111827';
  }

  function startDraw(e){
    drawing = true;
    const rect = canvas.getBoundingClientRect();
    lastX = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    lastY = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
  }
  
  function draw(e){
    if(!drawing) return;
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
    ctx.beginPath();
    ctx.moveTo(lastX,lastY);
    ctx.lineTo(x,y);
    ctx.stroke();
    lastX = x; lastY = y;
  }

  function stopDraw(){ drawing = false; }

  canvas.addEventListener('mousedown', startDraw);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', stopDraw);
  canvas.addEventListener('mouseout', stopDraw);
  canvas.addEventListener('touchstart', startDraw, {passive:false});
  canvas.addEventListener('touchmove', draw, {passive:false});
  canvas.addEventListener('touchend', stopDraw);

  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  document.getElementById('sigData').value = new Date().toISOString().slice(0,10);

  document.getElementById('sigCPF').addEventListener('input', e => {
    let value = e.target.value.replace(/\D/g,'');
    if(value.length <= 11){
      value = value.replace(/(\d{3})(\d)/, '$1.$2');
      value = value.replace(/(\d{3})(\d)/, '$1.$2');
      value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
      e.target.value = value;
    }
  });

  window.limparAssinatura = () => ctx.clearRect(0,0,canvas.width,canvas.height);
})();
</script>
<script>
document.getElementById('btnAssinar').addEventListener('click', async () => {
  const nome = document.getElementById('sigNome').value.trim();
  const cpf = document.getElementById('sigCPF').value.trim();
  const data = document.getElementById('sigData').value;
  const canvas = document.getElementById('signatureCanvas');
    const assinatura = canvas.toDataURL();
    
  if(!nome || !cpf || !data){
    alert('Preencha nome, CPF e data.');
      return; 
    }
    
  const pixels = canvas.getContext('2d').getImageData(0,0,canvas.width,canvas.height).data;
  const hasTrace = pixels.some(channel => channel !== 0);
  if(!hasTrace){
    alert('Fa√ßa a assinatura digital antes de salvar.');
      return;
    }

  try{
      const cfg = await (await fetch('/api/supabase-config')).json();
    const supabase = window.supabase.createClient(cfg.supabaseUrl, cfg.supabaseAnonKey);
    const { data: session } = await supabase.auth.getSession();
    
    // Capturar user_id da sess√£o
    let userId = null;
    if (session?.session?.user) {
      userId = session.session.user.id;
      console.log('‚úÖ User ID capturado:', userId);
    } else {
      // Tentar obter via getUser se getSession n√£o retornar
      try {
        const { data: { user } } = await supabase.auth.getUser();
        if (user) {
          userId = user.id;
          console.log('‚úÖ User ID obtido via getUser:', userId);
        }
      } catch (e) {
        console.warn('‚ö†Ô∏è N√£o foi poss√≠vel obter user_id:', e);
      }
    }

    const headers = {
      'Content-Type': 'application/json',
      ...(session?.session?.access_token ? { Authorization: `Bearer ${session.session.access_token}` } : {})
    };
    
    // Incluir credentials para enviar cookies de sess√£o
    const resp = await fetch('/api/treinamentos/assinaturas', {
      method:'POST',
      headers: headers,
      credentials: 'include',
      body:JSON.stringify({
          treinamento_slug:'disparador_mensagens', 
          user_id: userId, // Enviar user_id explicitamente
          nome, 
          cpf, 
          assinatura_texto: assinatura,
          data_assinatura: new Date().toISOString(),
          user_agent: navigator.userAgent
        })
      });

    if(!resp.ok) {
      const errorText = await resp.text();
      console.error('‚ùå Erro na resposta:', errorText);
      throw new Error(errorText || 'Erro ao salvar assinatura');
    }
    
    const result = await resp.json();
    console.log('‚úÖ Assinatura salva:', result);
    
    if (result.user_id) {
      alert('‚úÖ Declara√ß√£o registrada com sucesso!');
    } else {
      console.warn('‚ö†Ô∏è Assinatura salva mas user_id n√£o foi preenchido');
      alert('‚ö†Ô∏è Declara√ß√£o registrada, mas houve um problema ao associar ao seu usu√°rio. Entre em contato com o administrador.');
    }
  }catch(err){
    console.error('‚ùå Erro ao salvar assinatura:', err);
    alert('Erro ao salvar assinatura: ' + err.message);
  }
});
    </script>
<section class="training-block" id="faq">
    <h2><i class="fas fa-question-circle"></i>FAQ r√°pido</h2>
    <div class="step-card">
        <strong>O que fazer se uma mensagem falhar?</strong>
        <p>Verifique o status no painel de progresso e nos logs. Se for erro 401, fa√ßa login novamente; se for bloqueio do WhatsApp, revise os par√¢metros de seguran√ßa antes de tentar de novo.</p>
    </div>
    <div class="step-card">
        <strong>Posso disparar para a mesma lista no mesmo dia?</strong>
        <p>Sim, mas alterne o texto e respeite o cooldown. Disparos repetidos com a mesma mensagem elevam a chance de bloqueio.</p>
    </div>
    <div class="step-card mb-0">
        <strong>Quem aprovou este treinamento?</strong>
        <p>Opera√ß√µes (GR), Comercial e Monitoramento. D√∫vidas podem ser abertas no canal interno #disparador.</p>
    </div>
</section>

<link rel="stylesheet" href="css/chat-ia.css">
<script src="js/chat-ia.js"></script>
<script>
// Fun√ß√µes Evolution API (MODO TREINAMENTO - Simula√ß√£o)
function getEvolutionModalInstance() {
    const modalElement = document.getElementById('modalQRCodeEvolution');
    if (!modalElement) return null;
    return bootstrap.Modal.getInstance(modalElement) || new bootstrap.Modal(modalElement);
}

function renderQRCodeEvolution(value) {
    const container = document.getElementById('qrcodeEvolutionContainer');
    if (!container) return;
    
    if (!value || value.trim() === '') {
        container.innerHTML = '<div class="text-muted w-100">QR Code n√£o dispon√≠vel. Tente novamente.</div>';
        return;
    }

    const sanitizedValue = value.trim();
    const isBase64 = sanitizedValue.startsWith('data:image') ||
        /^[A-Za-z0-9+/=]+$/.test(sanitizedValue.replace(/[\r\n]+/g, '')) && sanitizedValue.length > 200;

    // Limpar container
    container.innerHTML = '';
    
    // Criar wrapper com anima√ß√£o
    const wrapper = document.createElement('div');
    wrapper.style.cssText = 'position: relative; display: inline-block; padding: 20px; background: white; border-radius: 16px; box-shadow: 0 8px 32px rgba(0,0,0,0.1); animation: fadeInScale 0.5s ease-out;';
    
    if (sanitizedValue.startsWith('data:image') || isBase64) {
        const img = document.createElement('img');
        img.alt = 'QR Code Evolution';
        img.className = 'img-fluid';
        img.style.cssText = 'max-width: 300px; max-height: 300px; width: 100%; height: auto; border-radius: 12px;';
        img.src = sanitizedValue.startsWith('data:image') ? sanitizedValue : `data:image/png;base64,${sanitizedValue}`;
        wrapper.appendChild(img);
    } else {
        const qrElement = document.createElement('div');
        qrElement.style.cssText = 'padding: 10px; background: white; border-radius: 12px;';
        wrapper.appendChild(qrElement);
        new QRCode(qrElement, {
            text: sanitizedValue,
            width: 300,
            height: 300,
            colorDark: '#000000',
            colorLight: '#ffffff',
            correctLevel: QRCode.CorrectLevel.H,
            margin: 2
        });
    }
    
    container.appendChild(wrapper);
    
    // Adicionar anima√ß√£o CSS se n√£o existir
    if (!document.getElementById('qrcodeAnimationStyle')) {
        const style = document.createElement('style');
        style.id = 'qrcodeAnimationStyle';
        style.textContent = `
            @keyframes fadeInScale {
                from {
                    opacity: 0;
                    transform: scale(0.9);
                }
                to {
                    opacity: 1;
                    transform: scale(1);
                }
            }
        `;
        document.head.appendChild(style);
    }
}

async function gerarQRCodeEvolution() {
    // ‚ö†Ô∏è MODO TREINAMENTO: Fun√ß√£o simulada, n√£o executa a√ß√µes reais
    const modal = getEvolutionModalInstance();
    const container = document.getElementById('qrcodeEvolutionContainer');
    const info = document.getElementById('qrcodeEvolutionInfo');
    const status = document.getElementById('qrcodeEvolutionStatus');

    if (container) {
        container.innerHTML = '<div class="text-muted w-100"><div class="loading-spinner mb-3" style="width: 50px; height: 50px; margin: 0 auto;"></div><p class="mb-0" style="font-size: 1.1rem; font-weight: 500;">Gerando QR Code...</p></div>';
    }
    if (info) {
        info.textContent = 'Gerando QR Code...';
    }
    if (status) {
        status.textContent = '';
    }

    if (modal) {
        modal.show();
    }

    // Simular delay de gera√ß√£o
    setTimeout(() => {
        // QR Code de exemplo (n√£o funcional)
        const qrCodeExemplo = 'https://api.qrserver.com/v1/create-qr-code/?size=300x300&data=EXEMPLO_QR_CODE_TREINAMENTO';
        
        if (container) {
            const img = document.createElement('img');
            img.src = qrCodeExemplo;
            img.alt = 'QR Code de Exemplo (Treinamento)';
            img.className = 'img-fluid';
            img.style.cssText = 'max-width: 300px; max-height: 300px; width: 100%; height: auto; border-radius: 12px; border: 3px dashed #667eea; padding: 20px; background: white; box-shadow: 0 8px 32px rgba(0,0,0,0.1);';
            container.innerHTML = '';
            container.appendChild(img);
        }
        
        if (info) {
            info.innerHTML = `
                <div class="d-flex align-items-center justify-content-center flex-column">
                    <div class="alert alert-warning border-0 mb-2" style="border-radius: 12px; background: #fff3cd;">
                        <i class="fas fa-graduation-cap me-2"></i>
                        <strong>Modo Treinamento:</strong> Este √© um QR Code de exemplo.
                    </div>
                    <div class="d-flex align-items-center">
                        <i class="fas fa-server me-2" style="color: #667eea;"></i>
                        <strong style="color: #333;">Inst√¢ncia:</strong>
                        <span class="ms-2 badge bg-primary">exemplo_treinamento</span>
                    </div>
                </div>
            `;
        }
        
        if (status) {
            status.innerHTML = `
                <i class="fas fa-info-circle me-2" style="color: #0284c7;"></i>
                <strong>Em produ√ß√£o:</strong> Este QR Code expiraria em aproximadamente 60 segundos.
            `;
        }
    }, 1500);
}

async function deslogarInstanciaEvolution() {
    // ‚ö†Ô∏è MODO TREINAMENTO: Fun√ß√£o simulada, n√£o executa a√ß√µes reais
    const mensagem = 'Deseja desconectar sua inst√¢ncia da Evolution? Ser√° necess√°rio ler o QR Code novamente.\n\n‚ö†Ô∏è MODO TREINAMENTO: Esta √© uma simula√ß√£o. Nenhuma a√ß√£o real ser√° executada.';
    
    if (!confirm(mensagem)) {
        return;
    }

    // Simular delay de processamento
    setTimeout(() => {
        alert('‚úÖ Simula√ß√£o: Inst√¢ncia desconectada com sucesso!\n\n‚ö†Ô∏è MODO TREINAMENTO: Em produ√ß√£o, voc√™ precisaria gerar um novo QR Code para reconectar.\n\nEsta √© apenas uma demonstra√ß√£o. No painel real, esta a√ß√£o desconectaria sua inst√¢ncia.');
    }, 500);
}

// Disponibilizar fun√ß√µes globalmente para uso no treinamento
window.gerarQRCodeEvolution = gerarQRCodeEvolution;
window.deslogarInstanciaEvolution = deslogarInstanciaEvolution;

// ========== FUN√á√ÉO PARA BAIXAR TREINAMENTO EM PDF ==========
async function baixarTreinamentoPDF() {
    const btn = document.getElementById('btnBaixarPDF');
    const originalHtml = btn ? btn.innerHTML : '';
    
    if (btn) {
        btn.disabled = true;
        btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Gerando PDF...';
    }

    try {
        // Elemento principal do treinamento
        const elemento = document.querySelector('main.container-training');
        
        if (!elemento) {
            throw new Error('Conte√∫do do treinamento n√£o encontrado');
        }

        console.log('üìÑ Iniciando gera√ß√£o de PDF...');
        console.log('üì¶ Elemento encontrado:', elemento);

        // Criar uma c√≥pia profunda do elemento
        const elementoClone = elemento.cloneNode(true);
        
        // Remover elementos interativos e n√£o necess√°rios
        const elementosParaRemover = elementoClone.querySelectorAll('button, .btn-back, .signature-card, canvas, #btnBaixarPDF, .modal, .d-flex.justify-content-between');
        elementosParaRemover.forEach(el => {
            if (el && el.parentNode) {
                el.remove();
            }
        });
        
        console.log('üßπ Elementos removidos:', elementosParaRemover.length);
        
        // Garantir que o clone tenha conte√∫do vis√≠vel
        elementoClone.style.cssText = 'background: white !important; color: #1f2937 !important; padding: 2rem !important; max-width: 100% !important;';
        
        // Ajustar estilos de elementos filhos para garantir visibilidade
        elementoClone.querySelectorAll('.hero').forEach(el => {
            el.style.cssText = 'background: linear-gradient(135deg, #6759ff, #8b5cf6) !important; color: white !important; border-radius: 20px !important; padding: 2rem !important; margin-bottom: 2rem !important; display: block !important;';
        });
        
        elementoClone.querySelectorAll('.training-block').forEach(el => {
            el.style.cssText = 'background: white !important; border: 1px solid #e5e7eb !important; border-radius: 18px !important; padding: 1.75rem !important; margin-top: 1.5rem !important; display: block !important;';
        });
        
        elementoClone.querySelectorAll('.step-card').forEach(el => {
            el.style.cssText = 'border-left: 4px solid #6759ff !important; background: #f8fafc !important; padding: 1rem 1.25rem !important; border-radius: 12px !important; margin: 0.8rem 0 !important; display: block !important;';
        });
        
        // Garantir que todas as imagens sejam vis√≠veis e carregadas
        const imagens = elementoClone.querySelectorAll('img');
        console.log(`üì∏ Encontradas ${imagens.length} imagens para processar`);
        
        // Processar imagens
        const promessasImagens = Array.from(imagens).map((img, index) => {
            return new Promise((resolve) => {
                // Garantir que a imagem seja vis√≠vel
                img.style.cssText = 'max-width: 100% !important; height: auto !important; display: block !important;';
                
                if (img.complete && img.naturalWidth > 0) {
                    console.log(`‚úÖ Imagem ${index + 1}/${imagens.length} j√° carregada`);
                    resolve();
                    return;
                }
                
                const timeout = setTimeout(() => {
                    console.warn(`‚è±Ô∏è Timeout imagem ${index + 1}`);
                    resolve();
                }, 3000);
                
                img.onload = () => {
                    clearTimeout(timeout);
                    console.log(`‚úÖ Imagem ${index + 1} carregada`);
                    resolve();
                };
                
                img.onerror = () => {
                    clearTimeout(timeout);
                    console.warn(`‚ùå Erro ao carregar imagem ${index + 1}`);
                    resolve();
                };
            });
        });
        
        await Promise.all(promessasImagens);
        console.log('‚úÖ Todas as imagens processadas');
        
        // Verificar se h√° conte√∫do antes de continuar
        const texto = elementoClone.innerText || elementoClone.textContent || '';
        if (texto.trim().length === 0) {
            throw new Error('O conte√∫do est√° vazio ap√≥s clonagem. Verifique o elemento original.');
        }
        
        console.log('üìù Conte√∫do encontrado:', texto.substring(0, 200) + '...');
        
        // Criar container tempor√°rio VIS√çVEL na tela (ser√° removido depois)
        const containerTemp = document.createElement('div');
        containerTemp.id = 'pdf-temp-container';
        containerTemp.style.cssText = `
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            min-height: 100vh !important;
            background: white !important;
            padding: 2rem !important;
            z-index: 999999 !important;
            overflow: auto !important;
        `;
        
        // Adicionar o clone ao container
        containerTemp.appendChild(elementoClone);
        document.body.appendChild(containerTemp);
        
        console.log('üì¶ Container tempor√°rio criado e adicionado ao DOM');
        
        // For√ßar reflow e aguardar renderiza√ß√£o completa
        void containerTemp.offsetHeight; // For√ßa reflow
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // Verificar dimens√µes ap√≥s inser√ß√£o no DOM
        const rect = elementoClone.getBoundingClientRect();
        console.log('üìè Dimens√µes ap√≥s inser√ß√£o:', {
            offsetWidth: elementoClone.offsetWidth,
            offsetHeight: elementoClone.offsetHeight,
            scrollWidth: elementoClone.scrollWidth,
            scrollHeight: elementoClone.scrollHeight,
            boundingRect: rect
        });
        
        // Verificar se o elemento est√° vis√≠vel
        if (rect.width === 0 || rect.height === 0) {
            throw new Error('Elemento n√£o est√° vis√≠vel. Dimens√µes: ' + rect.width + 'x' + rect.height);
        }
        
        // Adicionar classe para otimiza√ß√£o de PDF
        elementoClone.classList.add('pdf-optimized');
        
        // Ajustar espa√ßamentos para reduzir espa√ßos em branco
        elementoClone.querySelectorAll('.training-block').forEach(el => {
            el.style.marginTop = '1rem !important';
            el.style.marginBottom = '1rem !important';
            el.style.padding = '1.25rem !important';
            el.style.pageBreakInside = 'avoid !important';
        });
        
        elementoClone.querySelectorAll('.step-card').forEach(el => {
            el.style.marginTop = '0.5rem !important';
            el.style.marginBottom = '0.5rem !important';
            el.style.pageBreakInside = 'avoid !important';
        });
        
        elementoClone.querySelectorAll('.media-figure').forEach(el => {
            el.style.marginTop = '0.75rem !important';
            el.style.marginBottom = '0.75rem !important';
            el.style.pageBreakInside = 'avoid !important';
        });
        
        elementoClone.querySelectorAll('.hero').forEach(el => {
            el.style.marginBottom = '1.5rem !important';
            el.style.padding = '1.5rem !important';
        });
        
        elementoClone.querySelectorAll('h1, h2, h3').forEach(el => {
            el.style.pageBreakAfter = 'avoid !important';
            el.style.pageBreakInside = 'avoid !important';
            el.style.marginTop = '0.75rem !important';
            el.style.marginBottom = '0.5rem !important';
        });
        
        elementoClone.querySelectorAll('p').forEach(el => {
            el.style.marginTop = '0.5rem !important';
            el.style.marginBottom = '0.5rem !important';
        });
        
        elementoClone.querySelectorAll('ul, ol').forEach(el => {
            el.style.marginTop = '0.5rem !important';
            el.style.marginBottom = '0.5rem !important';
        });
        
        // Configura√ß√µes do PDF com margens reduzidas
        const opcoes = {
            margin: [8, 8, 8, 8], // Margens reduzidas (antes: 15mm)
            filename: `Treinamento_Disparador_Mensagens_${new Date().toISOString().split('T')[0]}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { 
                scale: 2,
                useCORS: true,
                logging: false, // Desativar logs para melhor performance
                letterRendering: true,
                allowTaint: true,
                backgroundColor: '#ffffff',
                width: elementoClone.scrollWidth || rect.width,
                height: elementoClone.scrollHeight || rect.height,
                windowWidth: elementoClone.scrollWidth || rect.width,
                windowHeight: elementoClone.scrollHeight || rect.height,
                x: 0,
                y: 0,
                scrollX: 0,
                scrollY: 0
            },
            jsPDF: { 
                unit: 'mm', 
                format: 'a4', 
                orientation: 'portrait',
                compress: true
            },
            pagebreak: { 
                mode: ['avoid-all', 'css', 'legacy'],
                before: '.training-block',
                after: ['.training-block', '.media-figure'],
                avoid: ['.step-card', 'h1', 'h2', 'h3', '.info-box', '.warning-box', '.tip-box']
            }
        };

        console.log('üñ®Ô∏è Iniciando gera√ß√£o do PDF com op√ß√µes:', opcoes);
        
        // Gerar PDF diretamente do elemento clone
        await html2pdf().set(opcoes).from(elementoClone).save();
        
        console.log('‚úÖ PDF gerado com sucesso!');
        
        // Remover container tempor√°rio imediatamente ap√≥s gerar
        setTimeout(() => {
            const temp = document.getElementById('pdf-temp-container');
            if (temp && temp.parentNode) {
                console.log('üóëÔ∏è Removendo container tempor√°rio');
                temp.remove();
            }
        }, 500);
        
        // Feedback de sucesso
        if (btn) {
            btn.innerHTML = '<i class="fas fa-check me-2"></i>PDF Gerado!';
            btn.style.background = '#10b981';
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
                btn.style.background = '#10b981';
            }, 2000);
        }
    } catch (error) {
        console.error('‚ùå Erro ao gerar PDF:', error);
        console.error('Stack:', error.stack);
        alert('Erro ao gerar PDF: ' + error.message + '\n\nVerifique o console para mais detalhes.\n\nTente novamente ou use a fun√ß√£o de impress√£o do navegador (Ctrl+P).');
        
        // Remover container tempor√°rio em caso de erro
        const temp = document.getElementById('pdf-temp-container');
        if (temp && temp.parentNode) {
            temp.remove();
        }
        
        if (btn) {
            btn.disabled = false;
            btn.innerHTML = originalHtml;
        }
    }
}

// Disponibilizar fun√ß√£o globalmente
window.baixarTreinamentoPDF = baixarTreinamentoPDF;
</script>
</body>
</html>

