<!doctype html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Treinamento – Disparador de Mensagens</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary:#6759ff;
            --secondary:#8b5cf6;
            --bg-page:#edf2ff;
            --bg-card:#ffffff;
            --text:#1f2937;
        }
        body{
            font-family:"Segoe UI",system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
            background:var(--bg-page);
            padding:2rem 0;
            color:var(--text);
        }
        .container-training{max-width:960px;margin:0 auto;}
        .hero{
            background:linear-gradient(135deg,var(--primary),var(--secondary));
            color:#fff;border-radius:20px;padding:2rem;
            box-shadow:0 18px 40px rgba(103,89,255,.25);
        }
        .hero h1{font-weight:800;margin-bottom:.4rem;}
        .hero p{opacity:.9;margin:0;}
        .hero .tag{display:inline-flex;align-items:center;gap:.4rem;background:rgba(0,0,0,.25);padding:.2rem .8rem;border-radius:999px;font-weight:600;}
        a.btn-back{
            display:inline-flex;align-items:center;gap:.5rem;
            padding:.55rem 1rem;border-radius:999px;
            background:#111827;color:#fff;text-decoration:none;
            margin-bottom:1.25rem;font-weight:600;
        }
        section.training-block{
            margin-top:1.5rem;
            background:var(--bg-card);
            border-radius:18px;
            padding:1.75rem;
            box-shadow:0 16px 35px rgba(31,41,55,.08);
        }
        section.training-block h2{
            font-size:1.2rem;
            font-weight:800;
            margin-bottom:1rem;
            display:flex;
            align-items:center;
            gap:.5rem;
        }
        .step-card{
            border-left:4px solid var(--primary);
            background:#f8fafc;
            padding:1rem 1.25rem;
            border-radius:12px;
            margin:.8rem 0;
            box-shadow:0 8px 18px rgba(0,0,0,.05);
        }
        .media-figure{
            margin:1.5rem 0;
            text-align:center;
        }
        .media-figure img{
            width:100%;
            border-radius:16px;
            border:3px solid #e5e7eb;
            box-shadow:0 20px 45px rgba(15,23,42,.18);
        }
        .media-figure figcaption{
            margin-top:.6rem;font-size:.9rem;color:#4b5563;
            background:#f3f4f6;border-radius:10px;padding:.75rem 1rem;
        }
        .info-box,.warning-box,.tip-box{
            padding:1rem 1.2rem;border-radius:12px;margin:1rem 0;
        }
        .info-box{background:#e0f2fe;border-left:5px solid #0284c7;}
        .warning-box{background:#fee2e2;border-left:5px solid #dc2626;}
        .tip-box{background:#fef3c7;border-left:5px solid #f59e0b;}
        .signature-card{
            border:2px dashed #cbd5f5;
            padding:1.25rem;
            border-radius:16px;
            background:#f8fafc;
        }
        .signature-card label{font-weight:600;color:#111827;margin-top:.75rem;}
        canvas.signature-canvas{
            width:100%;height:200px;
            border:2px solid #e2e8f0;
            border-radius:12px;
            background:#fff;
        }
    </style>
</head>
<body>
<main class="container-training">
    <a class="btn-back" href="treinamentos.html"><i class="fas fa-chevron-left"></i>Voltar para Treinamentos</a>
    <header class="hero">
        <span class="tag"><i class="fas fa-user-graduate"></i> Treinamento obrigatório</span>
        <h1><i class="fas fa-paper-plane me-2"></i>Disparador de Mensagens WhatsApp</h1>
        <p>Este guia mostra, em detalhes, como sair do “painel vazio” até o preenchimento da declaração final, evitando erros que podem bloquear a linha ou gerar disparos incorretos.</p>
        <ul style="margin-top:1rem;padding-left:1.25rem;list-style:disc;opacity:.9">
            <li><strong>Tempo estimado:</strong> 15 minutos para ler + 5 minutos para assinar.</li>
            <li><strong>Público:</strong> times Operacional, Comercial e Monitoramento que utilizam o disparador.</li>
            <li><strong>Objetivo:</strong> garantir envios rastreáveis, seguros e relevantes para motoristas.</li>
        </ul>
    </header>

    <section class="training-block" id="preparacao">
        <h2><i class="fas fa-filter"></i>1. Preparação e leitura do painel</h2>
        <p>Antes de clicar em qualquer botão, reserve 30 segundos para entender o cenário do dia. As decisões tomadas na preparação evitam retrabalho, mensagens fora do contexto e disparos para motoristas errados.</p>
        <div class="step-card">
            <strong>1.1 Acesso inicial</strong>
            <ul>
                <li>Abra <strong>Dashboard ▸ Disparador</strong> e confirme se você está logado com um usuário autorizado.</li>
                <li>Leia os indicadores do topo (Total, Ativos, Categoria ativa) para entender o contexto antes de qualquer filtro.</li>
                <li>Escolha a categoria operacional do dia (leve, médio ou pesado). Todo o restante do fluxo partirá dessa escolha.</li>
            </ul>
            <p class="mb-0">Se algum indicador estiver com valor incoerente (ex.: “Motoristas ativos = 0”), acione o time de dados antes de continuar.</p>
    </div>
        <figure class="media-figure">
            <img src="treinamento-imagens/painel-inicial.png?v=20251124T03" alt="Tela inicial do painel">
            <figcaption>IMAGEM 1 – Painel com cards de categoria e indicadores principais.</figcaption>
        </figure>
        <div class="step-card">
            <strong>1.2 Cards de categoria</strong>
            <p>Cada card dispara a atualização da base e dos indicadores. Aguarde a animação de carregamento terminar antes de aplicar filtros adicionais para evitar consultas duplicadas.</p>
            <p class="mb-0">Use a legenda da linha superior (“Categoria ativa”) para validar se você está disparando para o público correto.</p>
                </div>
        <figure class="media-figure">
            <img src="treinamento-imagens/cards-categorias.png?v=20251124T03" alt="Cards de categorias">
            <figcaption>IMAGEM 2 – Destaque visual de um card selecionado.</figcaption>
        </figure>
        <div class="step-card">
            <strong>1.3 Filtros combinados</strong>
            <p>Recomendações para cada filtro:</p>
            <ul>
                <li><strong>Tipo de veículo</strong>: restringe o porte (Truck, Carreta etc.). Combine com categoria para listas menores.</li>
                <li><strong>Carroceria</strong>: útil para operações específicas (Sider, Baú, Plataforma).</li>
                <li><strong>Estado + Status</strong>: identifique motoristas disponíveis na região da coleta.</li>
                <li><strong>Busca livre</strong>: aceita nome, telefone ou parte do e-mail.</li>
                <li><strong>Apenas favoritos</strong>: reduz para motoristas previamente homologados.</li>
            </ul>
            <p>Preencha os filtros de cima para baixo; cada alteração executa uma nova consulta. Se precisar trocar tudo, clique primeiro em “Limpar filtros” para não herdar parâmetros antigos.</p>
            <p class="mb-0"><strong>Boa prática:</strong> anote em um bloco quais filtros foram usados. Isso facilita replicar o disparo ou explicar a estratégia posteriormente.</p>
            </div>
        <figure class="media-figure">
            <img src="treinamento-imagens/filtros.png?v=20251124T03" alt="Seção de filtros">
            <figcaption>IMAGEM 3 – Área completa de filtros com ações rápidas.</figcaption>
        </figure>
        <figure class="media-figure">
            <img src="treinamento-imagens/favoritos-lista.png?v=20251124T03" alt="Botão de favoritos na lista">
            <figcaption>IMAGEM 4 – Estrelar motoristas cria uma curadoria própria por usuário.</figcaption>
        </figure>
        <figure class="media-figure">
            <img src="treinamento-imagens/filtro-favoritos.png?v=20251124T03" alt="Filtro apenas favoritos">
            <figcaption>IMAGEM 5 – Ative “Apenas favoritos” quando precisar disparar somente para motoristas validados.</figcaption>
        </figure>
        <div class="tip-box mb-0">Dica: combine “Categoria pesada + Carreta + Estado SP + Favoritos” para disparos cirúrgicos em operações urgentes.</div>
    </section>

    <section class="training-block" id="selecao">
        <h2><i class="fas fa-users"></i>2. Seleção de motoristas</h2>
        <div class="step-card">
            <strong>2.1 Seleção individual</strong>
            <p>Ao clicar em um motorista, o card fica azul e o contador “X selecionados” sobe. Essa confirmação visual evita disparos para perfis indevidos.</p>
            <p class="mb-0">Passe o mouse sobre o card para ver telefone, classe e carroceria antes de confirmar a seleção.</p>
            </div>
        <figure class="media-figure">
            <img src="treinamento-imagens/motoristas-selecionados.png?v=20251124T03" alt="Motoristas selecionados">
            <figcaption>IMAGEM 6 – Destaque e contador “X selecionados”.</figcaption>
        </figure>
        <div class="step-card">
            <strong>2.2 Seleção em massa</strong>
            <ul>
                <li><strong>Selecionar Todos:</strong> aplica-se a todos os resultados filtrados (use somente após revisar o filtro).</li>
                <li><strong>Selecionar Página:</strong> marca apenas os itens visíveis. Ideal para lotes menores ou validação por páginas.</li>
                <li><strong>Limpar Seleção:</strong> remove tudo para reiniciar o processo com segurança.</li>
            </ul>
            <p class="mb-0">Regra de ouro: nunca clique em “Selecionar Todos” sem antes testar a mensagem em alguns contatos.</p>
        </div>
        <figure class="media-figure">
            <img src="treinamento-imagens/botoes-selecao.png?v=20251124T03" alt="Botões de seleção">
            <figcaption>IMAGEM 7 – Botões de seleção em massa.</figcaption>
        </figure>
        <div class="info-box">
            <strong>Checklist rápido antes de seguir para a mensagem:</strong>
            <ul class="mb-0">
                <li>O contador “X selecionados” corresponde ao que você pretende disparar?</li>
                <li>Há pelo menos um favorito na seleção? (Evite listas totalmente frias).</li>
                <li>Os motoristas selecionados fazem sentido para o filtro/região? Revise se necessário.</li>
            </ul>
        </div>
        <div class="warning-box mb-0">Atenção: sempre valide se os números possuem DDI + DDD antes de disparar.</div>
    </section>

    <section class="training-block" id="mensagem">
        <h2><i class="fas fa-comment-dots"></i>3. Composição da mensagem</h2>
        <div class="step-card">
            <strong>Variáveis suportadas</strong>
            <p>Use variáveis para personalizar o texto automaticamente:</p>
            <p class="mb-2"><code>{{name}}</code>, <code>{{telefone}}</code>, <code>{{estado}}</code>, <code>{{classe_veiculo}}</code>, <code>{{tipo_veiculo}}</code>, <code>{{tipo_carroceria}}</code></p>
            <p class="mb-0">Exemplo: <code>Olá {{name}}, temos vaga urgente para {{classe_veiculo}} em {{estado}}.</code></p>
                </div>
        <figure class="media-figure">
            <img src="treinamento-imagens/composicao-mensagem.png?v=20251124T03" alt="Composição de mensagem">
            <figcaption>IMAGEM 8 – Campo de mensagem com variáveis e exemplo.</figcaption>
        </figure>
        <div class="step-card">
            <strong>Boas práticas</strong>
            <ul>
                <li>Seja direto e respeitoso; evite letras maiúsculas em excesso.</li>
                <li>Compartilhe links apenas de domínios confiáveis (site institucional, formulários oficiais).</li>
                <li>Evite prometer valores ou vantagens que não estejam confirmados.</li>
                <li>Teste a mensagem após cada ajuste para ver como as variáveis serão renderizadas.</li>
            </ul>
            <p class="mb-0"><strong>Modelo sugerido:</strong> “{{name}}, a Multimodal tem carga para {{classe_veiculo}} com carroceria {{tipo_carroceria}} saindo de {{estado}}. Interesse? Responda SIM.”</p>
            </div>
        <div class="tip-box mb-0">Use emoji com moderação (até 2). Eles ajudam a humanizar, mas excesso pode aumentar taxa de bloqueio.</div>
    </section>

    <section class="training-block" id="seguranca">
        <h2><i class="fas fa-user-shield"></i>4. Parâmetros de segurança</h2>
        <figure class="media-figure">
            <img src="treinamento-imagens/configuracoes-seguranca.png?v=20251124T03" alt="Modal de configurações de segurança">
            <figcaption>IMAGEM 9 – Limites, intervalos e simulação de digitação.</figcaption>
        </figure>
        <div class="step-card">
            <strong>Checklist obrigatório</strong>
            <ul>
                <li>Intervalo aleatório ≥ 3 segundos para manter ritmo humano.</li>
                <li>Limite por janela: máximo 50 mensagens a cada 5 minutos.</li>
                <li>Cooldown: respeite de 15 a 30 minutos quando atingir o limite.</li>
                <li>Simulação de digitação: mantenha ativa para reduzir bloqueios.</li>
            </ul>
            <p class="mb-0">Antes de salvar, verbalize os valores em voz alta. Parece exagero, mas ajuda a evitar números errados.</p>
            <div class="warning-box mt-3 mb-0">Alterações agressivas são responsabilidade do operador e podem bloquear a linha definitivamente.</div>
            </div>
    </section>

    <section class="training-block" id="teste-disparo">
        <h2><i class="fas fa-clipboard-check"></i>5. Testes e disparo</h2>
        <figure class="media-figure">
            <img src="treinamento-imagens/area-testes.png?v=20251124T03" alt="Área de testes">
            <figcaption>IMAGEM 10 – Telefone de teste e botões “Enviar teste” / “Testar mensagem”.</figcaption>
        </figure>
        <figure class="media-figure">
            <img src="treinamento-imagens/disparo-progresso.png?v=20251124T03" alt="Progresso do disparo">
            <figcaption>IMAGEM 11 – Botões Iniciar/Parar e contadores.</figcaption>
        </figure>
        <div class="step-card">
            <strong>Fluxo recomendado para disparar</strong>
            <ol class="mb-0">
                <li>Preencha o campo “Telefone para teste” e clique em <strong>Enviar teste</strong>.</li>
                <li>Use o botão <strong>Testar mensagem</strong> para revisar a formatação e variáveis.</li>
                <li>Valide manualmente o retorno dos três primeiros contatos reais.</li>
                <li>Só então clique em <strong>Iniciar disparo</strong>. Durante o envio, monitore “Enviados, Falhas, Total”.</li>
                <li>Caso precise pausar, use o botão <strong>Parar disparo</strong>; retomar manualmente evita filas duplicadas.</li>
            </ol>
                </div>
        <div class="tip-box">Sempre que reiniciar o disparo, revise se os mesmos motoristas ainda estão selecionados para evitar mensagens repetidas.</div>
    </section>

    <section class="training-block" id="logs">
        <h2><i class="fas fa-database"></i>6. Logs e BI</h2>
        <p>Todos os envios são registrados na tabela <strong>disparos_log</strong> com usuário, horário, telefone e status. Isso permite auditoria completa em caso de dúvidas.</p>
        <div class="step-card">
            <strong>Como consultar os registros</strong>
            <ul class="mb-0">
                <li>Acesse o painel de BI ou solicite o export no menu “Logs”.</li>
                <li>Filtre por data, usuário e departamento para encontrar disparos específicos.</li>
                <li>Analise os campos “status” (sucesso/falha) e “mensagem” para entender eventuais retornos do WhatsApp.</li>
            </ul>
            </div>
        <figure class="media-figure">
            <img src="treinamento-imagens/bi-disparos.png?v=20251124T03" alt="Painel BI Disparos">
            <figcaption>IMAGEM 12 – KPIs e filtros do BI.</figcaption>
        </figure>
        <div class="info-box mb-0">Use o BI semanalmente para acompanhar tendência de falhas, horários de maior volume e necessidade de ajustar os parâmetros de segurança.</div>
    </section>

    <section class="training-block" id="assinatura">
        <h2><i class="fas fa-signature"></i>7. Declaração de conclusão</h2>
        <p>Finalize o treinamento registrando seu aceite. Esse registro comprova que você compreendeu as responsabilidades e boas práticas do disparador.</p>
        <div class="signature-card">
            <label for="sigNome">Nome completo</label>
            <input id="sigNome" class="form-control" placeholder="Digite seu nome">
            <label for="sigCPF" class="mt-3">CPF</label>
            <input id="sigCPF" class="form-control" placeholder="000.000.000-00">
            <label for="sigData" class="mt-3">Data</label>
            <input id="sigData" type="date" class="form-control">
            <label class="mt-3">Assinatura digital *</label>
            <canvas id="signatureCanvas" class="signature-canvas"></canvas>
            <div class="d-flex gap-2 mt-3 flex-wrap">
                <button class="btn btn-secondary btn-sm" type="button" onclick="limparAssinatura()">
                    <i class="fas fa-eraser me-2"></i>Limpar assinatura
                </button>
                <button id="btnAssinar" class="btn btn-primary btn-sm" type="button">
                    <i class="fas fa-file-signature me-2"></i>Salvar declaração
            </button>
        </div>
            <p class="mt-3 mb-0 text-secondary" style="font-size:.9rem">Os registros ficam disponíveis para auditoria. Sempre que houver atualização do treinamento, um novo aceite será solicitado.</p>
    </div>
    </section>
</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
(function preloadImages(){
    const VERSION = '20251124T03';
    document.querySelectorAll('.media-figure img').forEach(img => {
        const baseSrc = img.getAttribute('src').split('?')[0];
        img.src = `${baseSrc}?v=${VERSION}`;
    });
})();
</script>
<script>
(function signaturePad(){
  const canvas = document.getElementById('signatureCanvas');
  const ctx = canvas.getContext('2d');
  let drawing = false;
  let lastX = 0, lastY = 0;
  
  function resizeCanvas() {
    const rect = canvas.getBoundingClientRect();
    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    canvas.width = rect.width;
    canvas.height = 200;
    ctx.putImageData(imageData, 0, 0);
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.strokeStyle = '#111827';
  }

  function startDraw(e){
    drawing = true;
    const rect = canvas.getBoundingClientRect();
    lastX = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    lastY = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
  }
  
  function draw(e){
    if(!drawing) return;
    e.preventDefault();
    const rect = canvas.getBoundingClientRect();
    const x = (e.touches ? e.touches[0].clientX : e.clientX) - rect.left;
    const y = (e.touches ? e.touches[0].clientY : e.clientY) - rect.top;
    ctx.beginPath();
    ctx.moveTo(lastX,lastY);
    ctx.lineTo(x,y);
    ctx.stroke();
    lastX = x; lastY = y;
  }

  function stopDraw(){ drawing = false; }

  canvas.addEventListener('mousedown', startDraw);
  canvas.addEventListener('mousemove', draw);
  canvas.addEventListener('mouseup', stopDraw);
  canvas.addEventListener('mouseout', stopDraw);
  canvas.addEventListener('touchstart', startDraw, {passive:false});
  canvas.addEventListener('touchmove', draw, {passive:false});
  canvas.addEventListener('touchend', stopDraw);

  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  document.getElementById('sigData').value = new Date().toISOString().slice(0,10);

  document.getElementById('sigCPF').addEventListener('input', e => {
    let value = e.target.value.replace(/\D/g,'');
    if(value.length <= 11){
      value = value.replace(/(\d{3})(\d)/, '$1.$2');
      value = value.replace(/(\d{3})(\d)/, '$1.$2');
      value = value.replace(/(\d{3})(\d{1,2})$/, '$1-$2');
      e.target.value = value;
    }
  });

  window.limparAssinatura = () => ctx.clearRect(0,0,canvas.width,canvas.height);
})();
</script>
<script>
document.getElementById('btnAssinar').addEventListener('click', async () => {
  const nome = document.getElementById('sigNome').value.trim();
  const cpf = document.getElementById('sigCPF').value.trim();
  const data = document.getElementById('sigData').value;
  const canvas = document.getElementById('signatureCanvas');
    const assinatura = canvas.toDataURL();
    
  if(!nome || !cpf || !data){
    alert('Preencha nome, CPF e data.');
      return; 
    }
    
  const pixels = canvas.getContext('2d').getImageData(0,0,canvas.width,canvas.height).data;
  const hasTrace = pixels.some(channel => channel !== 0);
  if(!hasTrace){
    alert('Faça a assinatura digital antes de salvar.');
      return;
    }

  try{
      const cfg = await (await fetch('/api/supabase-config')).json();
    const supabase = window.supabase.createClient(cfg.supabaseUrl, cfg.supabaseAnonKey);
    const { data: session } = await supabase.auth.getSession();

    const resp = await fetch('/api/treinamentos/assinaturas', {
      method:'POST',
      headers:{'Content-Type':'application/json', ...(session?.session?.access_token ? {Authorization:`Bearer ${session.session.access_token}`} : {})},
      body:JSON.stringify({
          treinamento_slug:'disparador_mensagens', 
          nome, 
          cpf, 
          assinatura_texto: assinatura,
          data_assinatura: new Date().toISOString(),
          user_agent: navigator.userAgent
        })
      });

    if(!resp.ok) throw new Error(await resp.text());
    alert('Declaração registrada com sucesso!');
  }catch(err){
    console.error(err);
    alert('Erro ao salvar assinatura: ' + err.message);
  }
});
    </script>
<section class="training-block" id="faq">
    <h2><i class="fas fa-question-circle"></i>FAQ rápido</h2>
    <div class="step-card">
        <strong>O que fazer se uma mensagem falhar?</strong>
        <p>Verifique o status no painel de progresso e nos logs. Se for erro 401, faça login novamente; se for bloqueio do WhatsApp, revise os parâmetros de segurança antes de tentar de novo.</p>
    </div>
    <div class="step-card">
        <strong>Posso disparar para a mesma lista no mesmo dia?</strong>
        <p>Sim, mas alterne o texto e respeite o cooldown. Disparos repetidos com a mesma mensagem elevam a chance de bloqueio.</p>
    </div>
    <div class="step-card mb-0">
        <strong>Quem aprovou este treinamento?</strong>
        <p>Operações (GR), Comercial e Monitoramento. Dúvidas podem ser abertas no canal interno #disparador.</p>
    </div>
</section>

<link rel="stylesheet" href="css/chat-ia.css">
<script src="js/chat-ia.js"></script>
</body>
</html>

