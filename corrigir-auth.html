<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Correção de Autenticação - Multimodal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }
        .fix-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        .status-item {
            padding: 1rem;
            border-radius: 10px;
            margin: 0.5rem 0;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .success { background: rgba(40, 167, 69, 0.2); color: #28a745; }
        .error { background: rgba(220, 53, 69, 0.2); color: #dc3545; }
        .warning { background: rgba(255, 193, 7, 0.2); color: #ffc107; }
        .info { background: rgba(13, 202, 240, 0.2); color: #0dcaf0; }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="fix-card p-4">
                    <h1 class="text-center text-white mb-4">
                        <i class="fas fa-tools me-2"></i>Correção de Autenticação
                    </h1>
                    
                    <div id="fixResults"></div>
                    
                    <div class="text-center mt-4">
                        <button class="btn btn-primary btn-lg" onclick="verificarESalvar()">
                            <i class="fas fa-search me-2"></i>Verificar e Salvar
                        </button>
                        <button class="btn btn-success btn-lg ms-2" onclick="corrigirLocalStorage()">
                            <i class="fas fa-wrench me-2"></i>Corrigir localStorage
                        </button>
                        <button class="btn btn-warning btn-lg ms-2" onclick="testarAcesso()">
                            <i class="fas fa-play me-2"></i>Testar Acesso
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function verificarESalvar() {
            const resultsDiv = document.getElementById('fixResults');
            let html = '<h3 class="text-white"><i class="fas fa-clipboard-list me-2"></i>Status do localStorage</h3>';
            
            // Verificar localStorage atual
            const loggedInUser = localStorage.getItem('loggedInUser');
            const lastActivity = localStorage.getItem('lastActivity');
            
            html += `<div class="status-item info">
                <strong>loggedInUser:</strong> ${loggedInUser || 'VAZIO'}
            </div>`;
            
            html += `<div class="status-item info">
                <strong>lastActivity:</strong> ${lastActivity || 'VAZIO'}
            </div>`;
            
            if (loggedInUser) {
                try {
                    const userData = JSON.parse(loggedInUser);
                    html += `<div class="status-item success">
                        <strong>Dados válidos:</strong> ${JSON.stringify(userData, null, 2)}
                    </div>`;
                } catch (error) {
                    html += `<div class="status-item warning">
                        <strong>Dados inválidos:</strong> ${loggedInUser}
                    </div>`;
                }
            } else {
                html += `<div class="status-item error">
                    <strong>Problema:</strong> Nenhum usuário logado no localStorage
                </div>`;
            }
            
            resultsDiv.innerHTML = html;
        }
        
        function corrigirLocalStorage() {
            const email = prompt('Digite seu email para corrigir o localStorage:');
            if (!email) return;
            
            const userData = {
                username: email.split('@')[0],
                email: email,
                role: 'admin',
                isAdmin: true
            };
            
            // Salvar dados corrigidos
            localStorage.setItem('loggedInUser', JSON.stringify(userData));
            localStorage.setItem('lastActivity', Date.now().toString());
            
            alert('✅ localStorage corrigido com sucesso!\n\nDados salvos:\n' + JSON.stringify(userData, null, 2));
            
            // Verificar novamente
            verificarESalvar();
        }
        
        function testarAcesso() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            
            if (!loggedInUser) {
                alert('❌ Nenhum usuário logado. Use "Corrigir localStorage" primeiro.');
                return;
            }
            
            // Testar acesso às páginas
            const paginas = ['portal.html', 'painel.html', 'coletas.html'];
            const resultados = [];
            
            paginas.forEach(pagina => {
                try {
                    // Simular verificação de autenticação
                    const userData = JSON.parse(loggedInUser);
                    const lastActivity = localStorage.getItem('lastActivity');
                    const timeDiff = lastActivity ? Date.now() - parseInt(lastActivity) : 0;
                    const hoursDiff = timeDiff / (1000 * 60 * 60);
                    
                    if (!lastActivity || hoursDiff < 12) {
                        resultados.push(`✅ ${pagina}: Acessível`);
                    } else {
                        resultados.push(`⚠️ ${pagina}: Sessão expirada`);
                    }
                } catch (error) {
                    resultados.push(`❌ ${pagina}: Erro - ${error.message}`);
                }
            });
            
            alert('Resultado dos testes:\n\n' + resultados.join('\n'));
        }
        
        // Executar verificação automaticamente
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(verificarESalvar, 1000);
        });
    </script>
</body>
</html>
