<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de Sistema - Multimodal</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }
        .test-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }
        .test-result {
            padding: 1rem;
            border-radius: 8px;
            margin: 0.5rem 0;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
    </style>
</head>
<body>
    <div class="container">
        <div class="row justify-content-center">
            <div class="col-md-10">
                <div class="test-card p-4">
                    <h1 class="text-center mb-4">
                        <i class="fas fa-vial me-2"></i>Teste de Sistema Multimodal
                    </h1>
                    
                    <div id="testResults"></div>
                    
                    <div class="text-center mt-4">
                        <button class="btn btn-primary btn-lg" onclick="executarTestes()">
                            <i class="fas fa-play me-2"></i>Executar Testes
                        </button>
                        <button class="btn btn-success btn-lg ms-2" onclick="abrirSistemas()">
                            <i class="fas fa-external-link-alt me-2"></i>Abrir Sistemas
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function executarTestes() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Executando testes...</div>';
            
            const testes = [
                { nome: 'Verificar localStorage', funcao: testarLocalStorage },
                { nome: 'Verificar Supabase Config', funcao: testarSupabaseConfig },
                { nome: 'Verificar Autenticação', funcao: testarAutenticacao },
                { nome: 'Verificar Portal', funcao: testarPortal },
                { nome: 'Verificar Painel', funcao: testarPainel },
                { nome: 'Verificar Coletas', funcao: testarColetas }
            ];
            
            let resultados = [];
            
            for (const teste of testes) {
                try {
                    const resultado = await teste.funcao();
                    resultados.push({ ...teste, resultado, sucesso: true });
                } catch (error) {
                    resultados.push({ ...teste, resultado: error.message, sucesso: false });
                }
            }
            
            mostrarResultados(resultados);
        }
        
        function mostrarResultados(resultados) {
            const resultsDiv = document.getElementById('testResults');
            let html = '<h3><i class="fas fa-clipboard-list me-2"></i>Resultados dos Testes</h3>';
            
            resultados.forEach(teste => {
                const classe = teste.sucesso ? 'success' : 'error';
                const icone = teste.sucesso ? 'check-circle' : 'exclamation-circle';
                
                html += `
                    <div class="test-result ${classe}">
                        <i class="fas fa-${icone} me-2"></i>
                        <strong>${teste.nome}:</strong> ${teste.resultado}
                    </div>
                `;
            });
            
            resultsDiv.innerHTML = html;
        }
        
        function testarLocalStorage() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            const lastActivity = localStorage.getItem('lastActivity');
            
            if (loggedInUser && lastActivity) {
                const userData = JSON.parse(loggedInUser);
                const timeDiff = Date.now() - parseInt(lastActivity);
                const hoursDiff = timeDiff / (1000 * 60 * 60);
                
                if (hoursDiff < 12) {
                    return `✅ Usuário logado: ${userData.username || userData.email} (${hoursDiff.toFixed(1)}h atrás)`;
                } else {
                    return `⚠️ Sessão expirada há ${hoursDiff.toFixed(1)} horas`;
                }
            } else {
                return '❌ Nenhum usuário logado no localStorage';
            }
        }
        
        async function testarSupabaseConfig() {
            try {
                const response = await fetch('/api/supabase-config');
                const config = await response.json();
                
                if (config.supabaseUrl && config.supabaseAnonKey) {
                    return `✅ Supabase configurado: ${config.supabaseUrl}`;
                } else {
                    return '❌ Configuração do Supabase incompleta';
                }
            } catch (error) {
                return `❌ Erro ao acessar configuração: ${error.message}`;
            }
        }
        
        async function testarAutenticacao() {
            try {
                const response = await fetch('/api/check-auth');
                const data = await response.json();
                
                if (data.authenticated) {
                    return `✅ Usuário autenticado: ${data.user}`;
                } else {
                    return '❌ Usuário não autenticado no servidor';
                }
            } catch (error) {
                return `❌ Erro na autenticação: ${error.message}`;
            }
        }
        
        function testarPortal() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (loggedInUser) {
                return '✅ Portal acessível - usuário logado';
            } else {
                return '⚠️ Portal requer login';
            }
        }
        
        function testarPainel() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (loggedInUser) {
                return '✅ Painel de Disparos acessível - usuário logado';
            } else {
                return '⚠️ Painel requer login';
            }
        }
        
        function testarColetas() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            if (loggedInUser) {
                return '✅ Sistema de Coletas acessível - usuário logado';
            } else {
                return '⚠️ Coletas requer login';
            }
        }
        
        function abrirSistemas() {
            const loggedInUser = localStorage.getItem('loggedInUser');
            
            if (loggedInUser) {
                // Abrir em novas abas
                window.open('portal.html', '_blank');
                window.open('painel.html', '_blank');
                window.open('coletas.html', '_blank');
            } else {
                alert('⚠️ Faça login primeiro para acessar os sistemas');
                window.location.href = 'login.html';
            }
        }
        
        // Executar testes automaticamente ao carregar
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(executarTestes, 1000);
        });
    </script>
</body>
</html>
