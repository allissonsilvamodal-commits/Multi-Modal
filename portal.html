<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Portal Multimodal - Dashboard Tecnológico</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/particles.js@2.0.0/particles.min.js"></script>
    <style>
        :root {
            --primary: #667eea;
            --secondary: #764ba2;
            --accent: #f093fb;
            --success: #11998e;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --dark: #0f0f23;
            --light: #f8f9fa;
            --white: #ffffff;
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.8);
            --text-muted: rgba(255, 255, 255, 0.6);
            --border-radius: 20px;
            --box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            --transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%);
            min-height: 100vh;
            color: var(--text-primary);
            overflow-x: hidden;
            position: relative;
        }

        /* Partículas de fundo */
        #particles-js {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        /* Efeitos de luz */
        .light-effect {
            position: absolute;
            width: 300px;
            height: 300px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.3) 0%, transparent 70%);
            filter: blur(40px);
            animation: float 6s ease-in-out infinite;
        }

        .light-effect:nth-child(1) {
            top: 10%;
            left: 10%;
            animation-delay: 0s;
        }

        .light-effect:nth-child(2) {
            top: 60%;
            right: 10%;
            animation-delay: 2s;
        }

        .light-effect:nth-child(3) {
            bottom: 10%;
            left: 50%;
            animation-delay: 4s;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px) scale(1); }
            50% { transform: translateY(-20px) scale(1.1); }
        }

        /* Navbar futurística */
        .navbar {
            background: rgba(15, 15, 35, 0.9);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--glass-border);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.8rem;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            text-shadow: 0 0 30px rgba(102, 126, 234, 0.5);
        }

        .navbar-nav .nav-link {
            color: var(--text-secondary) !important;
            font-weight: 500;
            transition: var(--transition);
            position: relative;
        }
        
        .navbar-nav .nav-link,
        .navbar-nav .nav-link:link,
        .navbar-nav .nav-link:visited {
            color: rgba(255, 255, 255, 0.8) !important;
        }
        
        .navbar-nav .nav-link:hover,
        .navbar-nav .nav-link:focus {
            color: rgba(255, 255, 255, 1) !important;
        }
        
        .navbar-nav .nav-link .badge-notification {
            position: absolute;
            top: -5px;
            right: -5px;
            background: linear-gradient(135deg, #dc3545, #c0392b);
            color: white;
            padding: 0.15rem 0.5rem;
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
            animation: pulse 2s infinite;
            min-width: 18px;
            text-align: center;
        }

        .navbar-nav .nav-link:hover,
        .navbar-nav .nav-link:focus {
            color: rgba(255, 255, 255, 1) !important;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .navbar-nav .nav-link::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            width: 0;
            height: 2px;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            transition: var(--transition);
            transform: translateX(-50%);
        }

        .navbar-nav .nav-link:hover::after {
            width: 100%;
        }

        /* Botão de tema futurístico */
        .theme-toggle {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 50px;
            padding: 8px 16px;
            color: var(--text-primary);
            transition: var(--transition);
            backdrop-filter: blur(10px);
        }

        .theme-toggle:hover {
            background: rgba(102, 126, 234, 0.2);
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.3);
            transform: translateY(-2px);
        }

        /* Container principal */
        .main-container {
            padding: 2rem 0;
            min-height: calc(100vh - 76px);
            position: relative;
        }

        /* Cards futurísticos */
        .card-futuristic {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            backdrop-filter: blur(30px) saturate(180%);
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 24px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2), 
                        0 0 0 1px rgba(102, 126, 234, 0.1) inset,
                        0 2px 8px rgba(102, 126, 234, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .card-futuristic::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.15), transparent);
            transition: left 0.6s ease;
            z-index: 1;
        }

        .card-futuristic::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
        }

        .card-futuristic:hover::before {
            left: 100%;
        }

        .card-futuristic:hover::after {
            opacity: 1;
        }

        .card-futuristic:hover {
            transform: translateY(-12px) scale(1.03);
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.3),
                        0 0 0 1px rgba(102, 126, 234, 0.3) inset,
                        0 4px 16px rgba(102, 126, 234, 0.2),
                        0 0 40px rgba(102, 126, 234, 0.15);
            border-color: rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.08) 100%);
        }

        /* Header do card */
        .card-header-futuristic {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 24px 24px 0 0;
            padding: 2rem 2.5rem;
            border: none;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.2);
        }

        .card-header-futuristic::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.15) 50%, transparent 70%);
            animation: shimmer 4s infinite;
            z-index: 1;
        }

        .card-header-futuristic::after {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            animation: pulseGlow 3s ease-in-out infinite;
            z-index: 0;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-50%); }
            100% { transform: translateX(100%) translateY(-50%); }
        }

        @keyframes pulseGlow {
            0%, 100% { opacity: 0.3; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(1.1); }
        }

        .card-header-futuristic h3 {
            color: var(--text-primary);
            font-weight: 700;
            font-size: 1.6rem;
            margin: 0;
            text-shadow: 0 2px 12px rgba(0, 0, 0, 0.4), 0 0 20px rgba(255, 255, 255, 0.1);
            position: relative;
            z-index: 2;
            letter-spacing: -0.5px;
        }

        /* Card body melhorado */
        .card-futuristic .card-body {
            position: relative;
            z-index: 2;
            padding: 2.5rem;
            background: transparent;
        }

        /* Métricas animadas */
        .metric-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.12) 0%, rgba(255, 255, 255, 0.06) 100%);
            backdrop-filter: blur(30px) saturate(180%);
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 2.5rem 2rem;
            text-align: center;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15),
                        0 0 0 1px rgba(102, 126, 234, 0.1) inset;
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            opacity: 0;
            transition: opacity 0.4s ease;
            z-index: 0;
        }

        .metric-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.15) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
            z-index: 1;
        }

        .metric-card:hover::before {
            opacity: 0.12;
        }

        .metric-card:hover::after {
            opacity: 1;
        }

        .metric-card:hover {
            transform: translateY(-14px) scale(1.06);
            box-shadow: 0 24px 48px rgba(102, 126, 234, 0.35),
                        0 0 0 1px rgba(102, 126, 234, 0.3) inset,
                        0 4px 20px rgba(102, 126, 234, 0.25),
                        0 0 50px rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.18) 0%, rgba(255, 255, 255, 0.1) 100%);
        }

        .metric-value {
            font-size: 3.5rem;
            font-weight: 900;
            background: linear-gradient(135deg, var(--primary) 0%, var(--accent) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.75rem;
            text-shadow: 0 0 40px rgba(102, 126, 234, 0.6);
            position: relative;
            z-index: 2;
            letter-spacing: -2px;
            line-height: 1;
            filter: drop-shadow(0 4px 8px rgba(102, 126, 234, 0.3));
        }

        .metric-label {
            font-size: 1.05rem;
            color: var(--text-secondary);
            font-weight: 600;
            position: relative;
            z-index: 2;
            letter-spacing: 0.3px;
        }

        /* Departamentos futurísticos */
        .department-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.1) 0%, rgba(255, 255, 255, 0.05) 100%);
            backdrop-filter: blur(30px) saturate(180%);
            border: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 24px;
            margin-bottom: 2rem;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: visible;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2),
                        0 0 0 1px rgba(102, 126, 234, 0.1) inset;
        }

        .department-card.expanded {
            overflow: visible;
            box-shadow: 0 16px 48px rgba(0, 0, 0, 0.25),
                        0 0 0 1px rgba(102, 126, 234, 0.2) inset,
                        0 4px 16px rgba(102, 126, 234, 0.15);
        }

        .department-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            opacity: 0;
            transition: opacity 0.4s ease;
            border-radius: 24px;
            z-index: 0;
        }

        .department-card::after {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
            opacity: 0;
            transition: opacity 0.4s ease;
            pointer-events: none;
            z-index: 1;
        }

        .department-card:hover::before {
            opacity: 0.08;
        }

        .department-card:hover::after {
            opacity: 1;
        }

        .department-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 24px 48px rgba(0, 0, 0, 0.3),
                        0 0 0 1px rgba(102, 126, 234, 0.3) inset,
                        0 4px 20px rgba(102, 126, 234, 0.2),
                        0 0 40px rgba(102, 126, 234, 0.15);
            border-color: rgba(102, 126, 234, 0.4);
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.15) 0%, rgba(255, 255, 255, 0.08) 100%);
        }

        .department-header {
            padding: 2rem;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            z-index: 2;
        }

        .department-header:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .department-icon {
            width: 80px;
            height: 80px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--text-primary);
            margin-bottom: 1rem;
            position: relative;
            overflow: hidden;
        }

        .department-icon::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            opacity: 0.8;
            border-radius: 20px;
        }

        .department-icon i {
            position: relative;
            z-index: 2;
        }

        .department-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .department-description {
            color: var(--text-secondary);
            font-size: 1rem;
            line-height: 1.5;
        }

        .expand-icon {
            position: absolute;
            top: 2rem;
            right: 2rem;
            font-size: 1.5rem;
            color: var(--text-secondary);
            transition: var(--transition);
        }

        .department-card.expanded .expand-icon {
            transform: rotate(180deg);
        }

        /* Módulos */
        .department-content {
            padding: 0 2rem 0;
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease-out, padding 0.4s ease-out;
        }

        .department-card.expanded .department-content {
            max-height: 70vh;
            overflow-y: auto;
            overflow-x: hidden;
            padding: 0 2rem 2rem;
            -webkit-overflow-scrolling: touch;
            display: block;
            position: relative;
        }
        
        /* Garantir que o scroll funcione mesmo durante a transição */
        .department-card.expanded .department-content .module-grid {
            display: grid;
            position: relative;
        }
        
        /* Forçar scroll quando o conteúdo exceder a altura */
        .department-card.expanded .department-content::after {
            content: '';
            display: block;
            height: 1px;
            width: 100%;
        }

        /* Scrollbar customizada para os cards expandidos */
        .department-card.expanded .department-content::-webkit-scrollbar {
            width: 8px;
        }

        .department-card.expanded .department-content::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .department-card.expanded .department-content::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 10px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .department-card.expanded .department-content::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--secondary), var(--accent));
        }

        /* Firefox scrollbar */
        .department-card.expanded .department-content {
            scrollbar-width: thin;
            scrollbar-color: var(--primary) rgba(255, 255, 255, 0.05);
        }

        .module-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
            min-height: min-content;
        }

        .module-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 15px;
            padding: 1.5rem;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .module-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.1), transparent);
            transition: var(--transition);
        }

        .module-item:hover::before {
            left: 100%;
        }

        .module-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            border-color: rgba(102, 126, 234, 0.5);
        }

        .sub-module-item {
            position: relative;
        }

        .sub-module-item:hover {
            background: rgba(255, 255, 255, 0.08) !important;
            border-color: rgba(102, 126, 234, 0.3) !important;
            transform: translateY(-2px);
        }

        .module-icon {
            width: 60px;
            height: 60px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--text-primary);
            margin-bottom: 1rem;
            position: relative;
            overflow: hidden;
        }

        .module-icon::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            opacity: 0.8;
            border-radius: 15px;
        }

        .module-icon i {
            position: relative;
            z-index: 2;
        }

        .module-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .module-description {
            color: var(--text-secondary);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .notification-badge {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: linear-gradient(135deg, #dc3545, #c0392b);
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(220, 53, 69, 0.4);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Botões futurísticos */
        .btn-futuristic {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border: none;
            border-radius: 50px;
            padding: 0.75rem 2rem;
            font-weight: 600;
            color: var(--text-primary);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .btn-futuristic::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: var(--transition);
        }

        .btn-futuristic:hover::before {
            left: 100%;
        }

        .btn-futuristic:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(102, 126, 234, 0.4);
        }

        /* Loading futurístico */
        .loading-futuristic {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Alertas futurísticos */
        .alert-futuristic {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            font-weight: 500;
            position: relative;
            overflow: hidden;
        }

        .alert-futuristic::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
        }

        .alert-success::before {
            background: linear-gradient(135deg, var(--success), #11998e);
        }

        .alert-danger::before {
            background: linear-gradient(135deg, var(--danger), #c82333);
        }

        .alert-warning::before {
            background: linear-gradient(135deg, var(--warning), #ff8c00);
        }

        /* Responsividade */
        @media (max-width: 768px) {
            .metric-value {
                font-size: 2rem;
            }
            
            .department-title {
                font-size: 1.5rem;
            }
            
            .module-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Animações de entrada */
        .fade-in {
            animation: fadeIn 0.8s ease-out;
        }

        .slide-up {
            animation: slideUp 0.8s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { 
                opacity: 0;
                transform: translateY(30px);
            }
            to { 
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Scrollbar personalizada */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--secondary), var(--primary));
        }

        /* Versão e melhorias - rodapé destacado */
        .version-footer {
            position: fixed;
            bottom: 0;
            right: 0;
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.95), rgba(118, 75, 162, 0.95));
            backdrop-filter: blur(15px);
            border-top-left-radius: 20px;
            border: 2px solid rgba(240, 147, 251, 0.5);
            box-shadow: 0 -4px 20px rgba(102, 126, 234, 0.4), 0 0 30px rgba(240, 147, 251, 0.2);
            font-size: 0.85rem;
            color: var(--text-primary);
            z-index: 100;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
            animation: slideUpFooter 0.8s ease-out;
            cursor: pointer;
        }

        @keyframes slideUpFooter {
            from {
                transform: translateY(100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .version-footer:hover {
            background: linear-gradient(135deg, rgba(102, 126, 234, 1), rgba(118, 75, 162, 1));
            border-color: rgba(240, 147, 251, 0.8);
            box-shadow: 0 -6px 30px rgba(102, 126, 234, 0.6), 0 0 40px rgba(240, 147, 251, 0.4);
            transform: translateY(-3px);
        }

        .version-footer .version-badge {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            padding: 0.4rem 0.8rem;
            border-radius: 12px;
            font-weight: 700;
            color: var(--text-primary);
            font-size: 0.9rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            animation: pulseBadge 2s ease-in-out infinite;
            letter-spacing: 0.5px;
        }

        @keyframes pulseBadge {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 4px 15px rgba(240, 147, 251, 0.5);
            }
        }

        .version-footer .improvements-count {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
            text-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        .version-footer .improvements-count i {
            color: var(--accent);
            font-size: 1rem;
            animation: sparkle 2s ease-in-out infinite;
            filter: drop-shadow(0 0 5px rgba(240, 147, 251, 0.8));
        }

        @keyframes sparkle {
            0%, 100% {
                transform: scale(1) rotate(0deg);
                opacity: 1;
            }
            50% {
                transform: scale(1.2) rotate(180deg);
                opacity: 0.8;
            }
        }

        .version-footer .improvements-count span {
            font-weight: 700;
            font-size: 1rem;
            background: linear-gradient(135deg, #fff, var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .version-footer::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.1) 50%, transparent 70%);
            animation: shimmer 3s infinite;
            border-radius: 20px 0 0 0;
            pointer-events: none;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }
            100% {
                transform: translateX(100%);
            }
        }

        @media (max-width: 768px) {
            .version-footer {
                font-size: 0.75rem;
                padding: 0.6rem 1rem;
                gap: 0.75rem;
            }
            
            .version-footer .version-badge {
                font-size: 0.8rem;
                padding: 0.3rem 0.6rem;
            }
            
            .version-footer .improvements-count span {
                font-size: 0.9rem;
            }
        }

        /* Modal de Melhorias */
        .modal-melhorias {
            background: linear-gradient(135deg, rgba(15, 15, 35, 0.98) 0%, rgba(26, 26, 46, 0.98) 100%);
            backdrop-filter: blur(30px) saturate(180%);
            border: 2px solid rgba(102, 126, 234, 0.4);
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.6),
                        0 0 0 1px rgba(102, 126, 234, 0.2) inset,
                        0 0 80px rgba(102, 126, 234, 0.15);
            overflow: hidden;
        }

        .modal-header-melhorias {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-bottom: 2px solid rgba(255, 255, 255, 0.15);
            border-radius: 24px 24px 0 0;
            padding: 2rem 2.5rem;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
        }

        .modal-header-melhorias::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(255, 255, 255, 0.15) 50%, transparent 70%);
            animation: shimmer 4s infinite;
        }

        .modal-header-melhorias .modal-title {
            color: var(--text-primary);
            font-weight: 700;
            font-size: 1.6rem;
            text-shadow: 0 2px 12px rgba(0, 0, 0, 0.4);
            position: relative;
            z-index: 2;
            letter-spacing: -0.5px;
        }

        .modal-body-melhorias {
            padding: 2.5rem;
            color: rgba(255, 255, 255, 0.95) !important;
            max-height: 65vh;
            overflow-y: auto;
            background: linear-gradient(180deg, rgba(15, 15, 35, 0.5) 0%, rgba(26, 26, 46, 0.5) 100%);
        }

        .modal-body-melhorias .text-muted {
            color: rgba(255, 255, 255, 0.75) !important;
        }

        .modal-footer-melhorias {
            border-top: 2px solid rgba(255, 255, 255, 0.1);
            padding: 1.5rem 2.5rem;
            background: rgba(15, 15, 35, 0.5);
            backdrop-filter: blur(10px);
        }

        .version-info {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.15) 0%, rgba(118, 75, 162, 0.15) 100%);
            border: 2px solid rgba(102, 126, 234, 0.4);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 8px 24px rgba(102, 126, 234, 0.2),
                        0 0 0 1px rgba(102, 126, 234, 0.1) inset;
            backdrop-filter: blur(10px);
        }

        .version-badge-large {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 0.75rem 1.5rem;
            border-radius: 16px;
            font-weight: 800;
            font-size: 1.4rem;
            color: white;
            text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            box-shadow: 0 4px 16px rgba(102, 126, 234, 0.4),
                        0 0 0 1px rgba(255, 255, 255, 0.2) inset;
            letter-spacing: 0.5px;
            color: var(--text-primary);
            display: inline-block;
        }

        .improvements-total {
            font-size: 2.25rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--accent) 0%, #ff6b9d 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            text-shadow: 0 0 30px rgba(240, 147, 251, 0.5);
            filter: drop-shadow(0 4px 8px rgba(240, 147, 251, 0.3));
        }

        .improvements-total i {
            animation: sparkle 2s ease-in-out infinite;
            filter: drop-shadow(0 0 8px rgba(240, 147, 251, 0.8));
            font-size: 1.8rem;
        }

        .melhorias-categoria {
            margin-bottom: 2rem;
        }

        .categoria-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 0.75rem;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid rgba(102, 126, 234, 0.3);
        }

        .categoria-header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex: 1;
        }

        .categoria-count-badge {
            background: linear-gradient(135deg, var(--accent), var(--primary));
            color: var(--text-primary);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 700;
            box-shadow: 0 2px 8px rgba(240, 147, 251, 0.3);
            animation: pulseBadge 2s ease-in-out infinite;
            white-space: nowrap;
        }

        .categoria-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: var(--text-primary);
        }

        .categoria-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.95) !important;
            margin: 0;
        }

        .melhorias-lista {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .melhorias-lista li {
            padding: 0.75rem 1rem;
            margin-bottom: 0.5rem;
            background: rgba(255, 255, 255, 0.05);
            border-left: 3px solid var(--primary);
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
        }

        .melhorias-lista li:hover {
            background: rgba(102, 126, 234, 0.15);
            border-left-color: var(--accent);
            transform: translateX(5px);
        }

        .melhorias-lista li i {
            color: var(--accent);
            margin-top: 0.2rem;
            font-size: 0.9rem;
        }

        .melhorias-lista li span {
            flex: 1;
            color: rgba(255, 255, 255, 0.9) !important;
            line-height: 1.5;
        }

        /* Scrollbar personalizada para o modal */
        .modal-body-melhorias::-webkit-scrollbar {
            width: 8px;
        }

        .modal-body-melhorias::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }

        .modal-body-melhorias::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            border-radius: 4px;
        }

        .modal-body-melhorias::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--secondary), var(--primary));
        }
    </style>
</head>
<body>
    <!-- Efeitos de luz de fundo -->
    <div class="light-effect"></div>
    <div class="light-effect"></div>
    <div class="light-effect"></div>

    <!-- Partículas -->
    <div id="particles-js"></div>

    <!-- Navbar Futurística -->
    <nav class="navbar navbar-expand-lg">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-rocket me-2"></i>
                Multimodal Portal
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#dashboard">
                            <i class="fas fa-tachometer-alt me-1"></i>Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#departments">
                            <i class="fas fa-building me-1"></i>Departamentos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="minhas-acoes.html">
                            <i class="fas fa-tasks me-1"></i>Minhas Ações
                            <span class="badge-notification" id="badgeAcoesNavbar" style="display: none;">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#analytics">
                            <i class="fas fa-chart-line me-1"></i>Analytics
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="chat-interno.html">
                            <i class="fas fa-comments me-1"></i>Chat Interno
                            <span class="badge-notification" id="badgeChatInterno" style="display: none; background: #ef4444; color: white; border-radius: 10px; padding: 0.15rem 0.4rem; font-size: 0.7rem; font-weight: 700; margin-left: 0.5rem;">0</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="realizar-avaliacao.html">
                            <i class="fas fa-clipboard-check me-1"></i>Realizar Avaliação
                            <span class="badge-notification" id="badgeRealizarAvaliacao" style="display: none; background: #ef4444; color: white; border-radius: 10px; padding: 0.15rem 0.4rem; font-size: 0.7rem; font-weight: 700; margin-left: 0.5rem;">0</span>
                        </a>
                    </li>
                </ul>
                
                <div class="navbar-nav">
                    <div class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle me-1"></i>
                            <span id="currentUser">Carregando...</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="painel.html"><i class="fas fa-tachometer-alt me-2"></i>Painel</a></li>
                            <li><a class="dropdown-item" href="cadastro.html"><i class="fas fa-truck me-2"></i>Motoristas</a></li>
                            <li><a class="dropdown-item" href="motoristas-falhas.html"><i class="fas fa-exclamation-triangle me-2"></i>Motoristas com Falhas</a></li>
                            <li><a class="dropdown-item" href="coletas.html"><i class="fas fa-headset me-2"></i>Coletas</a></li>
                            <li><a class="dropdown-item" href="relatorios.html"><i class="fas fa-chart-bar me-2"></i>Relatórios</a></li>
                            <li><a class="dropdown-item" href="chamados.html"><i class="fas fa-ticket-alt me-2"></i>Chamados</a></li>
                            <li><a class="dropdown-item" href="crm.html"><i class="fas fa-users me-2"></i>CRM</a></li>
                            <li><a class="dropdown-item" href="vendas.html"><i class="fas fa-chart-line me-2"></i>Vendas</a></li>
                            <li><a class="dropdown-item" href="monitoramento.html"><i class="fas fa-monitor me-2"></i>Monitoramento</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="abrirModalTrocarSenha()"><i class="fas fa-key me-2"></i>Trocar Senha</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="logout()"><i class="fas fa-sign-out-alt me-2"></i>Sair</a></li>
                        </ul>
            </div>
                    <button class="btn theme-toggle ms-2" id="themeToggle" onclick="toggleTheme()">
                        <i class="fas fa-moon"></i>
                </button>
                </div>
            </div>
        </div>
    </nav>

    <!-- Modal Trocar Senha -->
    <div class="modal fade" id="modalTrocarSenha" tabindex="-1" aria-labelledby="modalTrocarSenhaLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content" style="background: rgba(15, 23, 42, 0.95); border: 1px solid rgba(148, 163, 184, 0.25); border-radius: 16px;">
                <div class="modal-header" style="border-bottom: 1px solid rgba(148, 163, 184, 0.15);">
                    <h5 class="modal-title" id="modalTrocarSenhaLabel" style="color: var(--text-primary);">
                        <i class="fas fa-key me-2"></i>Trocar Senha
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body">
                    <form id="formTrocarSenha">
                        <div class="mb-3">
                            <label for="senhaAtual" class="form-label" style="color: var(--text-secondary);">Senha Atual *</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="senhaAtual" required style="background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(148, 163, 184, 0.25); color: var(--text-primary);">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('senhaAtual')" style="border-color: rgba(148, 163, 184, 0.25); color: var(--text-secondary);">
                                    <i class="fas fa-eye" id="iconSenhaAtual"></i>
                                </button>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="novaSenha" class="form-label" style="color: var(--text-secondary);">Nova Senha *</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="novaSenha" required minlength="6" style="background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(148, 163, 184, 0.25); color: var(--text-primary);">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('novaSenha')" style="border-color: rgba(148, 163, 184, 0.25); color: var(--text-secondary);">
                                    <i class="fas fa-eye" id="iconNovaSenha"></i>
                                </button>
                            </div>
                            <small class="text-muted">Mínimo de 6 caracteres</small>
                        </div>
                        <div class="mb-3">
                            <label for="confirmarSenha" class="form-label" style="color: var(--text-secondary);">Confirmar Nova Senha *</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="confirmarSenha" required minlength="6" style="background: rgba(15, 23, 42, 0.6); border: 1px solid rgba(148, 163, 184, 0.25); color: var(--text-primary);">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('confirmarSenha')" style="border-color: rgba(148, 163, 184, 0.25); color: var(--text-secondary);">
                                    <i class="fas fa-eye" id="iconConfirmarSenha"></i>
                                </button>
                            </div>
                        </div>
                        <div id="mensagemErroSenha" class="alert alert-danger" style="display: none; background: rgba(220, 53, 69, 0.2); border-color: rgba(220, 53, 69, 0.5); color: #ff6b6b;"></div>
                    </form>
                </div>
                <div class="modal-footer" style="border-top: 1px solid rgba(148, 163, 184, 0.15);">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" style="background: rgba(148, 163, 184, 0.2); border: 1px solid rgba(148, 163, 184, 0.25); color: var(--text-primary);">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="trocarSenha()" style="background: linear-gradient(135deg, var(--primary), var(--secondary)); border: none;">
                        <i class="fas fa-save me-2"></i>Salvar Nova Senha
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Container Principal -->
    <div class="main-container">
        <div class="container">
            <!-- Alertas -->
            <div id="alertContainer"></div>

            <!-- Seção Dashboard -->
            <section id="dashboard" class="fade-in">
                <!-- Cabeçalho -->
                <div class="row mb-5">
                    <div class="col-12 text-center">
                        <h1 class="display-4 fw-bold mb-3">
                            <span class="text-gradient">Portal Multimodal</span>
                        </h1>
                        <p class="lead text-secondary">
                            Sistema de Gestão Tecnológica Avançada
                        </p>
                        <div class="mt-4">
                            <span class="badge bg-success me-2">
                                <i class="fas fa-circle me-1"></i>Sistema Online
                            </span>
                            <span class="badge bg-info me-2">
                                <i class="fas fa-shield-alt me-1"></i>Seguro
                            </span>
                            <span class="badge bg-warning">
                                <i class="fas fa-bolt me-1"></i>Alta Performance
                            </span>
                            <button class="btn btn-outline-light btn-sm ms-3" onclick="debugPermissoes()">
                                <i class="fas fa-bug me-1"></i>Debug Permissões
                        </button>
                    </div>
                    </div>
                </div>

                <!-- Métricas Principais -->
                <div class="row mb-5 slide-up">
                    <div class="col-md-3 mb-4">
                        <div class="metric-card">
                            <div class="metric-value" id="totalUsers">0</div>
                            <div class="metric-label">
                                <i class="fas fa-users me-2"></i>Usuários Ativos
                </div>
                    </div>
                </div>
                    <div class="col-md-3 mb-4">
                        <div class="metric-card">
                            <div class="metric-value" id="totalOperations">0</div>
                            <div class="metric-label">
                                <i class="fas fa-cogs me-2"></i>Operações Hoje
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="metric-card">
                            <div class="metric-value" id="systemHealth">0%</div>
                            <div class="metric-label">
                                <i class="fas fa-heartbeat me-2"></i>Saúde do Sistema
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3 mb-4">
                        <div class="metric-card">
                            <div class="metric-value" id="activeConnections">0</div>
                            <div class="metric-label">
                                <i class="fas fa-users me-2"></i>Usuários Logados
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Seção Departamentos -->
            <section id="departments" class="slide-up">
                <div class="row mb-4">
                    <div class="col-12">
                        <h2 class="h3 fw-bold mb-3">
                            <i class="fas fa-building me-2"></i>Departamentos Tecnológicos
                    </h2>
                        <p class="text-secondary">Acesse os módulos disponíveis baseados em suas permissões</p>
                            </div>
                </div>
                        
                <div class="row" id="departmentsContainer">
                    <!-- Departamentos serão carregados dinamicamente -->
                            </div>
            </section>

            <!-- Seção Analytics -->
            <section id="analytics" class="slide-up">
                <div class="row mb-4">
                    <div class="col-12">
                        <h2 class="h3 fw-bold mb-3">
                            <i class="fas fa-chart-line me-2"></i>Analytics em Tempo Real
                        </h2>
                        <p class="text-secondary">Monitoramento avançado do sistema</p>
                            </div>
                </div>

                <div class="row">
                    <div class="col-md-8 mb-4">
                        <div class="card-futuristic">
                            <div class="card-header-futuristic">
                                <h3><i class="fas fa-chart-area me-2"></i>Atividade do Sistema</h3>
                            </div>
                            <div class="card-body p-4">
                                <canvas id="systemChart" height="300"></canvas>
                    </div>
                </div>
            </div>
                    <div class="col-md-4 mb-4">
                        <div class="card-futuristic">
                            <div class="card-header-futuristic">
                                <h3><i class="fas fa-server me-2"></i>Status dos Serviços</h3>
                            </div>
                            <div class="card-body p-4">
                                <div class="service-status">
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <span>Supabase</span>
                                        <span class="badge bg-success">Online</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <span>Evolution API</span>
                                        <span class="badge bg-warning">Verificando</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mb-3">
                                        <span>Sistema de Coletas</span>
                                        <span class="badge bg-success">Online</span>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>Monitoramento</span>
                                        <span class="badge bg-success">Online</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <!-- Rodapé com versão e melhorias -->
    <div class="version-footer" onclick="abrirModalMelhorias()" title="Clique para ver todas as melhorias! 🚀">
        <span class="version-badge" id="versionBadge">v1.5.0</span>
        <span class="improvements-count">
            <i class="fas fa-sparkles"></i>
            <span id="improvementsCount">0</span> melhorias implementadas
        </span>
    </div>

    <!-- Modal de Melhorias -->
    <div class="modal fade" id="modalMelhorias" tabindex="-1" aria-labelledby="modalMelhoriasLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-lg modal-dialog-scrollable">
            <div class="modal-content modal-melhorias">
                <div class="modal-header modal-header-melhorias">
                    <h5 class="modal-title" id="modalMelhoriasLabel">
                        <i class="fas fa-rocket me-2"></i>
                        Sistema em Constante Evolução
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fechar"></button>
                </div>
                <div class="modal-body modal-body-melhorias">
                    <div class="version-info mb-4">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <span class="version-badge-large">v1.5.0</span>
                                <p class="mb-0 mt-2 text-muted">Versão atual do sistema</p>
                            </div>
                            <div class="text-end">
                                <div class="improvements-total">
                                    <i class="fas fa-sparkles"></i>
                                    <span id="totalMelhoriasModal">127</span>
                                </div>
                                <p class="mb-0 mt-2 text-muted">Melhorias implementadas</p>
                            </div>
                        </div>
                    </div>

                    <div id="melhoriasContainer">
                        <!-- Melhorias serão carregadas aqui -->
                    </div>
                </div>
                <div class="modal-footer modal-footer-melhorias">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>Fechar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal de Avisos -->
    <div class="modal fade" id="modalAvisos" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content" style="background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%); border: 2px solid rgba(255, 255, 255, 0.1);">
                <div class="modal-header border-0">
                    <h5 class="modal-title text-white" id="avisoModalTitulo">
                        <i class="fas fa-bullhorn me-2"></i>Aviso do Sistema
                    </h5>
                </div>
                <div class="modal-body" id="avisoModalBody" style="max-height: 70vh; overflow-y: auto;">
                    <!-- Conteúdo do aviso será inserido aqui -->
                </div>
                <div class="modal-footer border-0" id="avisoModalFooter">
                    <button type="button" class="btn btn-primary" id="btnConfirmarAviso" onclick="confirmarLeituraAviso()">
                        <i class="fas fa-check me-2"></i>Confirmar Leitura
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link rel="stylesheet" href="css/chat-ia.css">
    <script src="js/chat-ia.js"></script>
    <script>
        // ========== CONFIGURAÇÕES SUPABASE ==========
        let supabase = null;
        let currentUser = null;
        let systemChart = null;

        // ========== INFORMAÇÕES DO SISTEMA ==========
        const SYSTEM_VERSION = '1.5.0';

        // ========== INICIALIZAÇÃO ==========
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Portal Multimodal inicializando...');
            
            // Inicializar partículas
            initParticles();
            
            // Inicializar Supabase
            await inicializarSupabase();
            
            // Verificar autenticação
            await verificarAutenticacao();
            
            // Carregar dados
            await carregarDados();
            
            // Verificar e exibir avisos não lidos
            await verificarAvisosNaoLidos();
            
            // Carregar contador de ações pendentes
            await carregarContadorAcoes();
            
            // Inicializar gráficos (agora é async)
            await inicializarGraficos();
            
            // Configurar animações
            configurarAnimações();
            
            // Exibir versão e melhorias
            exibirVersaoEMelhorias();
            
            console.log('✅ Portal Multimodal carregado com sucesso!');
        });

        // ========== PARTÍCULAS ==========
        function initParticles() {
            particlesJS('particles-js', {
                particles: {
                    number: { value: 80, density: { enable: true, value_area: 800 } },
                    color: { value: '#667eea' },
                    shape: { type: 'circle' },
                    opacity: { value: 0.5, random: false },
                    size: { value: 3, random: true },
                    line_linked: { enable: true, distance: 150, color: '#667eea', opacity: 0.4, width: 1 },
                    move: { enable: true, speed: 2, direction: 'none', random: false, straight: false, out_mode: 'out', bounce: false }
                },
                interactivity: {
                    detect_on: 'canvas',
                    events: { onhover: { enable: true, mode: 'repulse' }, onclick: { enable: true, mode: 'push' }, resize: true },
                    modes: { grab: { distance: 400, line_linked: { opacity: 1 } }, bubble: { distance: 400, size: 40, duration: 2, opacity: 8, speed: 3 }, repulse: { distance: 200, duration: 0.4 }, push: { particles_nb: 4 }, remove: { particles_nb: 2 } }
                },
                retina_detect: true
            });
        }

        // ========== SUPABASE ==========
        async function inicializarSupabase() {
            try {
                const response = await fetch('/api/supabase-config');
                if (!response.ok) {
                    throw new Error('Erro ao buscar configurações');
                }
                
                const config = await response.json();
                supabase = window.supabase.createClient(config.supabaseUrl, config.supabaseAnonKey);
                window.supabase = supabase;
                
                // Inicializar chat IA após Supabase estar pronto
                if (window.inicializarChatIA) {
                    window.inicializarChatIA();
                }
                
                console.log('✅ Supabase inicializado no portal');
                
                // Inicializar contador de mensagens não lidas
                atualizarContadorMensagens();
                setInterval(atualizarContadorMensagens, 10000); // Atualizar a cada 10 segundos
                
                atualizarContadorAvaliacao360();
                setInterval(atualizarContadorAvaliacao360, 10000); // Atualizar a cada 10 segundos
                
                return true;
            } catch (error) {
                console.error('❌ Erro ao inicializar Supabase:', error);
                mostrarAlerta('Erro ao conectar com o banco de dados', 'danger');
                return false;
            }
        }

        // ========== CONTADOR DE MENSAGENS NÃO LIDAS ==========
        async function atualizarContadorMensagens() {
            try {
                if (!supabase || !currentUser || !currentUser.id) {
                    return;
                }

                const { data: unreadMessages, error } = await supabase
                    .from('chat_mensagens')
                    .select('id')
                    .eq('destinatario_id', currentUser.id)
                    .eq('lida', false);

                if (error) {
                    // Ignorar erros de coluna não existente
                    if (error.message && error.message.includes('does not exist')) {
                        return;
                    }
                    throw error;
                }

                const unreadCount = unreadMessages ? unreadMessages.length : 0;
                const badgeElement = document.getElementById('badgeChatInterno');
                
                if (badgeElement) {
                    if (unreadCount > 0) {
                        badgeElement.textContent = unreadCount > 99 ? '99+' : unreadCount;
                        badgeElement.style.display = 'inline-block';
                    } else {
                        badgeElement.style.display = 'none';
                    }
                }
            } catch (error) {
                // Silenciosamente ignorar erros (tabela pode não existir ainda)
                console.debug('Contador de mensagens:', error.message);
            }
        }

        // ========== CONTADOR DE NOTIFICAÇÕES AVALIAÇÃO 360º ==========
        async function atualizarContadorAvaliacao360() {
            try {
                if (!supabase || !currentUser || !currentUser.id) {
                    return;
                }

                const { data: notificacoes, error } = await supabase
                    .from('avaliacao_360_notificacoes')
                    .select('id')
                    .eq('usuario_id', currentUser.id)
                    .eq('lida', false);

                if (error) {
                    // Ignorar erros de coluna não existente
                    if (error.message && error.message.includes('does not exist')) {
                        return;
                    }
                    throw error;
                }

                // Contar avaliações pendentes onde o usuário é avaliador
                const { data: avaliadores, error: errAvaliadores } = await supabase
                    .from('avaliacao_360_avaliadores')
                    .select('id')
                    .eq('avaliador_id', currentUser.id)
                    .in('status', ['pendente', 'em_andamento']);

                const unreadCount = avaliadores ? avaliadores.length : 0;
                const badgeElement = document.getElementById('badgeRealizarAvaliacao');
                
                if (badgeElement) {
                    if (unreadCount > 0) {
                        badgeElement.textContent = unreadCount > 99 ? '99+' : unreadCount;
                        badgeElement.style.display = 'inline-block';
                    } else {
                        badgeElement.style.display = 'none';
                    }
                }
            } catch (error) {
                // Silenciosamente ignorar erros (tabela pode não existir ainda)
                console.debug('Contador de avaliação 360º:', error.message);
            }
        }

        // ========== AUTENTICAÇÃO ==========
        async function verificarAutenticacao() {
            try {
                console.log('🔐 Verificando autenticação...');
                
                const loggedInUserData = localStorage.getItem('loggedInUser');
                if (loggedInUserData) {
                    const userData = JSON.parse(loggedInUserData);
                    const now = Date.now();
                    const sessionAge = now - userData.loginTimestamp;
                    const SESSION_TIMEOUT = 12 * 60 * 60 * 1000;
                    
                    if (sessionAge < SESSION_TIMEOUT && userData.authenticated) {
                        // ✅ Buscar perfil do usuário no Supabase para verificar role
                        let isAdminFromDB = userData.isAdmin || userData.role === 'admin';
                        
                        // ✅ Buscar role diretamente do Supabase (sem depender da API que retorna 404)
                        try {
                            if (window.supabase) {
                                console.log('🔍 Buscando perfil no Supabase para ID:', userData.id);
                                const { data: profile, error } = await window.supabase
                                    .from('user_profiles')
                                    .select('role, nome')
                                    .eq('id', userData.id)
                                    .single();
                                
                                console.log('📋 Resposta do Supabase:', { profile, error: error?.message });
                                
                                if (!error && profile) {
                                    isAdminFromDB = profile.role === 'admin';
                                    console.log('✅ Role encontrado na tabela user_profiles:', profile.role);
                                    if (profile.nome) {
                                        userData.username = profile.nome;
                                    }
                                } else {
                                    console.log('⚠️ Erro ao buscar perfil:', error?.message, error?.details, error?.hint);
                                }
                            } else {
                                console.error('❌ window.supabase não está inicializado');
                            }
                        } catch (error) {
                            console.error('❌ Erro ao buscar perfil do Supabase:', error);
                            console.log('⚠️ Usando role do localStorage:', userData.role || 'user');
                        }
                        
                        currentUser = {
                            id: userData.id,
                            email: userData.email,
                            username: userData.username,
                            nome: userData.username,
                            isAdmin: isAdminFromDB,
                            role: userData.role || 'user'
                        };
                        
                        const currentUserElement = document.getElementById('currentUser');
                        if (currentUserElement) {
                            currentUserElement.textContent = currentUser.username;
                        }
                        
                        console.log('✅ Usuário autenticado:', currentUser.username);
                        console.log('👑 É admin:', currentUser.isAdmin);
                        return currentUser;
                    } else {
                        localStorage.removeItem('loggedInUser');
                    }
                }
                
                console.log('❌ Usuário não autenticado, redirecionando...');
                window.location.href = 'login.html';
                return null;
                
            } catch (error) {
                console.error('❌ Erro na verificação de autenticação:', error);
                window.location.href = 'login.html';
                return null;
            }
        }

        // Carregar contador de ações pendentes
        async function carregarContadorAcoes() {
            try {
                if (!currentUser || !currentUser.id) return;
                
                // Buscar headers de autenticação
                let headers = { 'Content-Type': 'application/json' };
                if (supabase) {
                    try {
                        const { data: { session } } = await supabase.auth.getSession();
                        if (session && session.access_token) {
                            headers['Authorization'] = `Bearer ${session.access_token}`;
                        }
                    } catch (error) {
                        console.warn('⚠️ Erro ao obter sessão:', error);
                    }
                }
                
                const loggedInUserData = localStorage.getItem('loggedInUser');
                if (loggedInUserData) {
                    const parsed = JSON.parse(loggedInUserData);
                    if (parsed.email) headers['X-User-Email'] = parsed.email;
                    if (parsed.id) headers['X-User-Id'] = parsed.id;
                }
                
                const response = await fetch('/api/ferramentas-qualidade/minhas-acoes?status=pendente', {
                    headers: headers,
                    credentials: 'include'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    const acoesPendentes = (data.acoes || []).length;
                    
                    // Atualizar badge no navbar
                    const badgeNavbar = document.getElementById('badgeAcoesNavbar');
                    if (badgeNavbar) {
                        if (acoesPendentes > 0) {
                            badgeNavbar.textContent = acoesPendentes;
                            badgeNavbar.style.display = 'inline-block';
                        } else {
                            badgeNavbar.style.display = 'none';
                        }
                    }
                    
                    // Atualizar badge no módulo "Minhas Ações" (se existir)
                    const moduloMinhasAcoes = document.querySelector('[href="minhas-acoes.html"]');
                    if (moduloMinhasAcoes && acoesPendentes > 0) {
                        const moduleItem = moduloMinhasAcoes.closest('.module-item');
                        if (moduleItem) {
                            // Remover badge existente se houver
                            const badgeExistente = moduleItem.querySelector('.notification-badge');
                            if (badgeExistente) {
                                badgeExistente.remove();
                            }
                            
                            // Adicionar novo badge
                            const badge = document.createElement('div');
                            badge.className = 'notification-badge';
                            badge.textContent = acoesPendentes;
                            badge.title = `${acoesPendentes} ação(ões) pendente(s)`;
                            moduleItem.appendChild(badge);
                        }
                    }
                }
            } catch (error) {
                console.warn('⚠️ Erro ao carregar contador de ações:', error);
            }
        }
        
        // Atualizar contador periodicamente
        setInterval(carregarContadorAcoes, 60000); // A cada 1 minuto
        
        // ========== CARREGAR DADOS ==========
        async function carregarDados() {
            try {
                await carregarMetricas();
                await renderizarDepartamentos();
                await verificarStatusServicos();
            } catch (error) {
                console.error('❌ Erro ao carregar dados:', error);
                mostrarAlerta('Erro ao carregar dados do portal', 'danger');
            }
        }

        async function carregarMetricas() {
            try {
                // Verificar se o Supabase está inicializado
                if (!supabase) {
                    console.warn('⚠️ Supabase não inicializado, usando valores padrão');
                    animarMetrica('totalUsers', 0);
                    animarMetrica('totalOperations', 0);
                    animarMetrica('systemHealth', 0, '%');
                    animarMetrica('activeConnections', 0);
                    return;
                }

                console.log('📊 Carregando métricas reais do Supabase...');

                // 1. Usuários Ativos - contar usuários ativos na tabela user_profiles
                let usuariosAtivos = 0;
                try {
                    const { count, error } = await supabase
                        .from('user_profiles')
                        .select('*', { count: 'exact', head: true })
                        .eq('active', true);
                    
                    if (error) throw error;
                    usuariosAtivos = count || 0;
                    console.log('✅ Usuários ativos:', usuariosAtivos);
                } catch (error) {
                    console.error('❌ Erro ao buscar usuários ativos:', error);
                    // Fallback: tentar tabela usuarios
                    try {
                        const { count } = await supabase
                            .from('usuarios')
                            .select('*', { count: 'exact', head: true });
                        usuariosAtivos = count || 0;
                    } catch (e) {
                        usuariosAtivos = 0;
                    }
                }

                // 2. Operações Hoje - coletas criadas hoje
                let operacoesHoje = 0;
                try {
                    const hoje = new Date();
                    hoje.setHours(0, 0, 0, 0);
                    const hojeISO = hoje.toISOString();
                    
                    const { count, error } = await supabase
                        .from('coletas')
                        .select('*', { count: 'exact', head: true })
                        .gte('created_at', hojeISO);
                    
                    if (error) throw error;
                    operacoesHoje = count || 0;
                    console.log('✅ Operações hoje:', operacoesHoje);
                } catch (error) {
                    console.error('❌ Erro ao buscar operações de hoje:', error);
                    operacoesHoje = 0;
                }

                // 3. Saúde do Sistema - sempre 100%
                const saudeSistema = 100;
                console.log('✅ Saúde do sistema: 100%');

                // 4. Conexões Ativas - Usuários logados (sessões ativas)
                let conexoesAtivas = 0;
                try {
                    const response = await fetch('/api/active-sessions');
                    if (response.ok) {
                        const data = await response.json();
                        conexoesAtivas = data.count || 0;
                        console.log('✅ Usuários logados (sessões ativas):', conexoesAtivas);
                    } else {
                        console.warn('⚠️ Erro ao buscar sessões ativas, usando fallback');
                        conexoesAtivas = 0;
                    }
                } catch (error) {
                    console.error('❌ Erro ao buscar sessões ativas:', error);
                    conexoesAtivas = 0;
                }

                // Animar métricas com dados reais
                console.log('📊 Métricas carregadas:', {
                    usuariosAtivos,
                    operacoesHoje,
                    saudeSistema: saudeSistema.toFixed(1) + '%',
                    conexoesAtivas
                });

                animarMetrica('totalUsers', usuariosAtivos);
                animarMetrica('totalOperations', operacoesHoje);
                animarMetrica('systemHealth', saudeSistema, '%');
                animarMetrica('activeConnections', conexoesAtivas);
                
                console.log('✅ Métricas carregadas com sucesso');
            } catch (error) {
                console.error('❌ Erro ao carregar métricas:', error);
                // Fallback para valores padrão em caso de erro
                animarMetrica('totalUsers', 0);
                animarMetrica('totalOperations', 0);
                animarMetrica('systemHealth', 0, '%');
                animarMetrica('activeConnections', 0);
            }
        }

        function animarMetrica(elementId, valorFinal, sufixo = '') {
            const element = document.getElementById(elementId);
            const valorInicial = 0;
            const duracao = 2000;
            const incremento = valorFinal / (duracao / 16);
            let valorAtual = valorInicial;
            
            const timer = setInterval(() => {
                valorAtual += incremento;
                if (valorAtual >= valorFinal) {
                    valorAtual = valorFinal;
                    clearInterval(timer);
                }
                
                if (sufixo === '%') {
                    element.textContent = valorAtual.toFixed(1) + sufixo;
                } else {
                    element.textContent = Math.floor(valorAtual) + sufixo;
                }
            }, 16);
        }

        // ========== SISTEMA DE PERMISSÕES ==========
        let userPermissionsCache = null;
        
        async function carregarPermissoesUsuarioBanco() {
            if (!currentUser || !currentUser.id) return [];
            
            // Se já está em cache, retornar
            if (userPermissionsCache !== null) return userPermissionsCache;
            
            try {
                console.log('🔍 Buscando permissões do usuário no banco:', currentUser.id);
                
                // Buscar permissões do portal
                const { data: portalPerms, error: portalError } = await window.supabase
                    .from('permissoes_portal')
                    .select('permissao_id')
                    .eq('usuario_id', currentUser.id);
                
                if (portalError) throw portalError;
                
                const permissoes = (portalPerms || []).map(p => p.permissao_id);
                userPermissionsCache = permissoes;
                
                console.log('✅ Permissões carregadas:', permissoes);
                return permissoes;
                
            } catch (error) {
                console.error('❌ Erro ao carregar permissões:', error);
                return [];
            }
        }
        
        async function usuarioTemPermissao(permission) {
            console.log(`🔐 Verificando permissão: ${permission}`);
            
            // Se o usuário é admin, tem todas as permissões
            if (currentUser && currentUser.isAdmin) {
                console.log(`✅ Usuário é admin, permissão ${permission} concedida`);
                return true;
            }
            
            // Carregar permissões do banco
            const permissoes = await carregarPermissoesUsuarioBanco();
            console.log(`📋 Permissões do usuário:`, permissoes);
            
            // Se não há permissões específicas, permitir acesso básico
            if (!permissoes || permissoes.length === 0) {
                // Permitir acesso aos módulos básicos para todos os usuários
                const permissoesBasicas = ['operacoes', 'coletas', 'crm', 'vendas', 'cadastro', 'relatorios'];
                const temPermissao = permissoesBasicas.includes(permission);
                console.log(`🔓 Permissão básica ${permission}:`, temPermissao);
                return temPermissao;
            }
            
            const temPermissao = permissoes.includes(permission);
            console.log(`🔑 Permissão específica ${permission}:`, temPermissao);
            return temPermissao;
        }

        function carregarPermissoesUsuario() {
            // Esta função está obsoleta, mantida para compatibilidade
            try {
                const permissoesData = localStorage.getItem('permissoesData');
                if (!permissoesData) {
                    return [];
                }
                
                const permissoes = JSON.parse(permissoesData);
                return permissoes[currentUser.id] || [];
            } catch (error) {
                console.error('❌ Erro ao carregar permissões:', error);
                return [];
            }
        }

        // ========== DEPARTAMENTOS ==========
        const DEPARTMENTS_CONFIG = {
            'operations': {
                name: 'Operações',
                description: 'Gestão de operações logísticas e processos',
                icon: 'fas fa-cogs',
                color: 'operations',
                adminOnly: false,
                modules: [
                    { 
                        name: 'Sistema de Disparos', 
                        description: 'Disparador de mensagens WhatsApp',
                        icon: 'fas fa-rocket',
                        url: 'painel.html',
                        permission: 'operacoes',
                        adminOnly: false
                    },
                    { 
                        name: 'Sistema de Coletas', 
                        description: 'Gestão completa de coletas',
                        icon: 'fas fa-truck-loading',
                        url: 'coletas.html',
                        permission: 'coletas',
                        adminOnly: false
                    },
                    { 
                        name: 'Histórico de Coletas', 
                        description: 'Visualizar coletas finalizadas (ganhas/perdidas)',
                        icon: 'fas fa-history',
                        url: 'historico_coletas.html',
                        permission: 'coletas',
                        adminOnly: false
                    },
                    { 
                        name: 'Rastreamento GPS', 
                        description: 'Monitoramento em tempo real de motoristas',
                        icon: 'fas fa-map-marked-alt',
                        url: 'monitoramento-rastreamento.html',
                        permission: 'operacoes',
                        adminOnly: false
                    },
                    { 
                        name: 'Cadastro de Motoristas', 
                        description: 'Sistema completo de cadastro',
                        icon: 'fas fa-user-plus',
                        url: 'cadastro.html',
                        permission: 'cadastro',
                        adminOnly: false
                    }
                ]
            },
            'commercial': {
                name: 'Comercial',
                description: 'Vendas, CRM e gestão de clientes',
                icon: 'fas fa-shopping-cart',
                color: 'commercial',
                adminOnly: false,
                modules: [
                    { 
                        name: 'CRM', 
                        description: 'Gestão de relacionamento com clientes',
                        icon: 'fas fa-users',
                        url: 'crm.html',
                        permission: 'crm',
                        adminOnly: false
                    },
                    { 
                        name: 'Vendas', 
                        description: 'Controle de vendas e propostas',
                        icon: 'fas fa-chart-line',
                        url: 'vendas.html',
                        permission: 'vendas',
                        adminOnly: false
                    }
                ]
            },
            'management': {
                name: 'Gestão',
                description: 'Gestão de dados e relatórios',
                icon: 'fas fa-chart-bar',
                color: 'management',
                adminOnly: false,
                modules: [
                    { 
                        name: 'Relatórios', 
                        description: 'Relatórios e Business Intelligence',
                        icon: 'fas fa-chart-bar',
                        url: 'relatorios.html',
                        permission: 'relatorios',
                        adminOnly: false
                    },
                    { 
                        name: 'Painel de Lançamento de Dados', 
                        description: 'Lançamento de dados de gestão',
                        icon: 'fas fa-database',
                        url: 'gestao-dados.html',
                        permission: 'gestao-dados',
                        adminOnly: false
                    }
                ]
            },
            'finance': {
                name: 'Financeiro',
                description: 'Controle financeiro e orçamentário',
                icon: 'fas fa-chart-pie',
                color: 'finance',
                adminOnly: true,
                modules: [
                    { 
                        name: 'Contas a Pagar', 
                        description: 'Gestão de despesas e pagamentos',
                        icon: 'fas fa-money-bill-wave',
                        url: 'contas-pagar.html',
                        permission: 'contas-pagar',
                        adminOnly: true
                    },
                    { 
                        name: 'Contas a Receber', 
                        description: 'Controle de receitas e cobranças',
                        icon: 'fas fa-hand-holding-usd',
                        url: 'contas-receber.html',
                        permission: 'contas-receber',
                        adminOnly: true
                    }
                ]
            },
            'rh': {
                name: 'Recursos Humanos',
                description: 'Gestão de pessoas e folha de pagamento',
                icon: 'fas fa-users-cog',
                color: 'rh',
                adminOnly: true,
                modules: [
                    { 
                        name: 'Folha de Pagamento', 
                        description: 'Gestão de remunerações',
                        icon: 'fas fa-file-invoice-dollar',
                        url: 'folha.html',
                        permission: 'folha',
                        adminOnly: true
                    },
                    { 
                        name: 'Recrutamento', 
                        description: 'Processos seletivos e contratações',
                        icon: 'fas fa-user-plus',
                        url: 'recrutamento.html',
                        permission: 'recrutamento',
                        adminOnly: true
                    },
                    { 
                        name: 'Avaliação 360º', 
                        description: 'Sistema completo de avaliação de desempenho',
                        icon: 'fas fa-chart-pie',
                        url: 'avaliacao-360.html',
                        permission: 'avaliacao-360',
                        adminOnly: false
                    }
                ]
            },
            'config': {
                name: 'Configurações',
                description: 'Configurações do sistema e administração',
                icon: 'fas fa-cog',
                color: 'config',
                adminOnly: true,
                modules: [
                    { 
                        name: 'Configurações do Sistema', 
                        description: 'Gestão de usuários e permissões',
                        icon: 'fas fa-sliders-h',
                        url: 'settings.html',
                        permission: 'configuracoes',
                        adminOnly: true
                    },
                    { 
                        name: 'Monitoramento', 
                        description: 'Acompanhamento em tempo real',
                        icon: 'fas fa-monitor',
                        url: 'monitoramento.html',
                        permission: 'monitoramento',
                        adminOnly: true
                    }
                ]
            },
            'qualidade': {
                name: 'Qualidade',
                description: 'Procedimentos e treinamentos',
                icon: 'fas fa-award',
                color: 'operations',
                adminOnly: false,
                modules: [
                    {
                        name: 'Treinamentos',
                        description: 'Instruções de trabalho, declarações e ferramentas de qualidade',
                        icon: 'fas fa-book-open',
                        url: null, // Não tem URL própria, apenas sub-módulos
                        permission: 'qualidade',
                        adminOnly: false,
                        subModules: [
                            {
                                name: 'Instruções de Trabalho e Declarações',
                                description: 'Treinamentos, instruções e declarações de conformidade',
                                icon: 'fas fa-file-contract',
                                url: 'treinamentos.html',
                                permission: 'qualidade',
                                adminOnly: false
                            },
                            {
                                name: 'Ferramentas de Qualidade',
                                description: 'Aprenda a usar todas as ferramentas de qualidade',
                                icon: 'fas fa-graduation-cap',
                                url: 'treinamento-ferramentas-qualidade.html',
                                permission: 'qualidade',
                                adminOnly: false
                            }
                        ]
                    },
                    {
                        name: 'Ferramentas de Qualidade',
                        description: '5 Porquês, 5W2H, Ishikawa, PDCA e mais',
                        icon: 'fas fa-tools',
                        url: 'ferramentas-qualidade.html',
                        permission: 'qualidade',
                        adminOnly: false
                    },
                    {
                        name: 'Painel de Qualidade',
                        description: 'Visualizar e gerenciar todas as ferramentas criadas',
                        icon: 'fas fa-chart-line',
                        url: 'painel-qualidade.html',
                        permission: 'qualidade',
                        adminOnly: false
                    },
                    {
                        name: 'Minhas Ações',
                        description: 'Visualizar e atualizar status das ações vinculadas a você',
                        icon: 'fas fa-tasks',
                        url: 'minhas-acoes.html',
                        permission: null, // Todos podem acessar
                        adminOnly: false
                    },
                    {
                        name: 'Documentos',
                        description: 'Gerenciar atas e documentos de treinamentos',
                        icon: 'fas fa-file-alt',
                        url: 'treinamentos-documentos.html',
                        permission: 'qualidade',
                        adminOnly: false
                    }
                ]
            }
        };

        async function renderizarDepartamentos() {
            const container = document.getElementById('departmentsContainer');
            container.innerHTML = '';

            console.log('🔍 Renderizando departamentos para usuário:', currentUser);
            console.log('👑 É admin:', currentUser.isAdmin);
            
            // Carregar permissões uma vez antes de renderizar
            const permissoes = await carregarPermissoesUsuarioBanco();
            console.log('📋 Permissões disponíveis:', permissoes);

            for (const deptKey of Object.keys(DEPARTMENTS_CONFIG)) {
                const dept = DEPARTMENTS_CONFIG[deptKey];
                
                console.log(`📁 Processando departamento: ${dept.name}`);
                
                // ✅ Card "Configurações" sempre visível (controle de acesso interno)
                if (deptKey === 'config' && dept.adminOnly && !currentUser.isAdmin) {
                    console.log(`⚠️ Departamento ${dept.name} visível mas acesso controlado por settings.html`);
                    // Não pular, permitir que o card apareça
                }
                
                // Verificar se o usuário tem acesso ao departamento (exceto Configurações)
                if (dept.adminOnly && !currentUser.isAdmin && deptKey !== 'config') {
                    console.log(`❌ Departamento ${dept.name} é apenas para admin`);
                    continue; // Pular departamentos apenas para admin
                }
                
                // Filtrar módulos baseado nas permissões do usuário
                const modulosDisponiveis = dept.modules.filter(modulo => {
                    console.log(`🔍 Verificando módulo: ${modulo.name} (permissão: ${modulo.permission})`);
                    
                    // ✅ Módulo "Configurações" sempre visível (controle de acesso interno)
                    if (deptKey === 'config') {
                        console.log(`✅ Módulo ${modulo.name} sempre visível (controle interno)`);
                return true;
            }
            
                    // Se é apenas para admin, verificar se o usuário é admin
                    if (modulo.adminOnly && !currentUser.isAdmin) {
                        console.log(`❌ Módulo ${modulo.name} é apenas para admin`);
                        return false;
                    }
                    
                    // ✅ Se o usuário é admin, permitir acesso sem verificar permissão específica
                    if (currentUser.isAdmin) {
                        console.log(`✅ Usuário é admin, aprovado automaticamente: ${modulo.name}`);
                        return true;
                    }
                    
                    // Verificar se o usuário tem permissão específica usando array de permissões já carregado
                    if (modulo.permission) {
                        const permissoesBasicas = ['operacoes', 'coletas', 'crm', 'vendas', 'cadastro', 'relatorios'];
                        const temPermissao = permissoesBasicas.includes(modulo.permission) || permissoes.includes(modulo.permission);
                        
                        if (!temPermissao) {
                            console.log(`❌ Usuário não tem permissão para ${modulo.name}`);
                            return false;
                        }
                    }
                    
                    console.log(`✅ Módulo ${modulo.name} aprovado`);
                    return true;
                });

                console.log(`📊 Módulos disponíveis para ${dept.name}:`, modulosDisponiveis.length);

                // Se não há módulos disponíveis para o usuário, não mostrar o departamento
                if (modulosDisponiveis.length === 0) {
                    console.log(`❌ Nenhum módulo disponível para ${dept.name}`);
                    return;
                }

                const card = document.createElement('div');
                card.className = 'col-md-6 col-lg-4 mb-4';
                card.innerHTML = `
                    <div class="department-card">
                        <div class="department-header" onclick="toggleDepartment('${deptKey}')">
                            <div class="department-icon">
                            <i class="${dept.icon}"></i>
                        </div>
                            <div class="department-title">${dept.name}</div>
                            <div class="department-description">${dept.description}</div>
                        <div class="expand-icon">
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                    <div class="department-content">
                            <div class="module-grid">
                            ${modulosDisponiveis.map(modulo => {
                                // Se o módulo tem sub-módulos, renderizar de forma diferente
                                if (modulo.subModules && Array.isArray(modulo.subModules)) {
                                    // Filtrar sub-módulos baseado em permissões
                                    const subModulosDisponiveis = modulo.subModules.filter(subMod => {
                                        if (subMod.adminOnly && !currentUser.isAdmin) return false;
                                        if (currentUser.isAdmin) return true;
                                        if (subMod.permission) {
                                            const permissoesBasicas = ['operacoes', 'coletas', 'crm', 'vendas', 'cadastro', 'relatorios'];
                                            return permissoesBasicas.includes(subMod.permission) || permissoes.includes(subMod.permission);
                                        }
                                        return true;
                                    });
                                    
                                    return `
                                        <div class="module-item" style="grid-column: 1 / -1;">
                                            <div class="module-icon">
                                                <i class="${modulo.icon}"></i>
                                            </div>
                                            <div class="module-name">${modulo.name}</div>
                                            <div class="module-description">${modulo.description}</div>
                                            <div class="sub-modules-grid mt-3" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem; margin-top: 1rem;">
                                                ${subModulosDisponiveis.map(subMod => `
                                                    <div class="sub-module-item" style="background: rgba(255, 255, 255, 0.03); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 10px; padding: 1rem; transition: all 0.3s;">
                                                        <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 0.5rem;">
                                                            <i class="${subMod.icon}" style="font-size: 1.2rem; color: var(--primary);"></i>
                                                            <div class="module-name" style="font-size: 1rem; margin: 0;">${subMod.name}</div>
                                                        </div>
                                                        <div class="module-description" style="font-size: 0.85rem; margin-bottom: 0.5rem;">${subMod.description}</div>
                                                        <a href="${subMod.url}" class="stretched-link"></a>
                                                    </div>
                                                `).join('')}
                                            </div>
                                        </div>
                                    `;
                                } else {
                                    // Módulo normal sem sub-módulos
                                    return `
                                        <div class="module-item">
                                            <div class="module-icon">
                                                <i class="${modulo.icon}"></i>
                                            </div>
                                            <div class="module-name">${modulo.name}</div>
                                            <div class="module-description">${modulo.description}</div>
                                            ${modulo.adminOnly ? '<div class="access-badge">Admin</div>' : ''}
                                            ${modulo.url ? `<a href="${modulo.url}" class="stretched-link"></a>` : ''}
                                        </div>
                                    `;
                                }
                            }).join('')}
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            }

            // Se não há departamentos disponíveis, mostrar mensagem
            if (container.children.length === 0) {
                container.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="fas fa-lock fa-3x text-muted mb-3"></i>
                        <h4 class="text-muted">Nenhum departamento disponível</h4>
                        <p class="text-muted">Você não tem permissão para acessar nenhum departamento.</p>
                    </div>
                `;
            }
        }

        function toggleDepartment(departmentKey) {
            const card = document.querySelector(`[onclick="toggleDepartment('${departmentKey}')"]`).closest('.department-card');
            const content = card.querySelector('.department-content');
            const isExpanding = !card.classList.contains('expanded');
            
            card.classList.toggle('expanded');
            
            if (isExpanding) {
                // Quando expandindo, calcular altura real do conteúdo
                setTimeout(() => {
                    if (content) {
                        // Remover max-height temporariamente para medir
                        const originalMaxHeight = content.style.maxHeight;
                        content.style.maxHeight = 'none';
                        const scrollHeight = content.scrollHeight;
                        content.style.maxHeight = originalMaxHeight;
                        
                        // Definir altura máxima baseada no conteúdo ou 70vh, o que for menor
                        const maxViewportHeight = window.innerHeight * 0.7;
                        const finalHeight = Math.min(scrollHeight + 40, maxViewportHeight); // +40 para padding
                        
                        content.style.maxHeight = finalHeight + 'px';
                        content.style.overflowY = scrollHeight > maxViewportHeight ? 'auto' : 'visible';
                    }
                }, 450); // Após a transição de 0.4s
            } else {
                // Quando colapsando, resetar
                if (content) {
                    content.style.maxHeight = '';
                    content.style.overflowY = 'hidden';
                }
            }
        }

        // ========== GRÁFICOS ==========
        async function inicializarGraficos() {
            const ctx = document.getElementById('systemChart').getContext('2d');
            
            // Buscar dados reais do backend
            let atividadeData = [0, 0, 0, 0, 0, 0];
            const labels = ['00h-04h', '04h-08h', '08h-12h', '12h-16h', '16h-20h', '20h-24h'];
            
            try {
                console.log('📊 Carregando dados de atividade do sistema...');
                
                const response = await fetch('/api/system-activity');
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        atividadeData = result.data;
                        console.log('✅ Dados de atividade carregados:', atividadeData);
                    } else {
                        console.warn('⚠️ Resposta sem dados válidos, usando valores padrão');
                    }
                } else {
                    console.warn('⚠️ Erro ao buscar dados de atividade, usando valores padrão');
                }
            } catch (error) {
                console.error('❌ Erro ao buscar dados de atividade:', error);
                // Em caso de erro, usar dados padrão mínimos
            }
            
            systemChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Atividade do Sistema',
                        data: atividadeData,
                        borderColor: '#667eea',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#667eea',
                        pointBorderColor: '#ffffff',
                        pointBorderWidth: 2,
                        pointRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(15, 15, 35, 0.9)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: '#667eea',
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `Atividades: ${context.parsed.y}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.8)',
                                stepSize: 1
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            },
                            ticks: {
                                color: 'rgba(255, 255, 255, 0.8)'
                            }
                        }
                    },
                    animation: {
                        duration: 1500,
                        easing: 'easeInOutQuart'
                    }
                }
            });
            
            console.log('✅ Gráfico de atividade inicializado com dados reais');
        }

        // ========== STATUS DOS SERVIÇOS ==========
        async function verificarStatusServicos() {
            try {
                // Verificar Evolution API
                const response = await fetch('/webhook/status-evolution');
                const statusElement = document.querySelector('.service-status .badge:nth-child(2)');
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.success) {
                        statusElement.className = 'badge bg-success';
                        statusElement.textContent = 'Online';
                    } else {
                        statusElement.className = 'badge bg-warning';
                        statusElement.textContent = 'Instável';
                    }
                } else {
                    statusElement.className = 'badge bg-danger';
                    statusElement.textContent = 'Offline';
                }
                
                console.log('✅ Status dos serviços verificado');
            } catch (error) {
                console.error('❌ Erro ao verificar status:', error);
            }
        }

        // ========== ANIMAÇÕES ==========
        function configurarAnimações() {
            // Animação de scroll
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('fade-in');
                    }
                });
            });

            document.querySelectorAll('section').forEach(section => {
                observer.observe(section);
            });
        }

        // ========== DEBUG ==========
        function debugPermissoes() {
            console.log('🐛 === DEBUG DE PERMISSÕES ===');
            console.log('👤 Usuário atual:', currentUser);
            console.log('👑 É admin:', currentUser?.isAdmin);
            console.log('📧 Email:', currentUser?.email);
            
            const permissoesData = localStorage.getItem('permissoesData');
            console.log('📋 Dados de permissões no localStorage:', permissoesData);
            
            const permissoes = carregarPermissoesUsuario();
            console.log('🔑 Permissões carregadas:', permissoes);
            
            // Testar permissões específicas
            const permissoesTeste = ['operacoes', 'coletas', 'crm', 'vendas'];
            permissoesTeste.forEach(permissao => {
                const temPermissao = usuarioTemPermissao(permissao);
                console.log(`🔍 ${permissao}: ${temPermissao ? '✅' : '❌'}`);
            });
            
            // Mostrar alerta com informações
            const info = `
                Usuário: ${currentUser?.username || 'N/A'}
                Admin: ${currentUser?.isAdmin ? 'Sim' : 'Não'}
                Email: ${currentUser?.email || 'N/A'}
                Permissões: ${permissoes.length > 0 ? permissoes.join(', ') : 'Nenhuma específica'}
            `;
            
            mostrarAlerta(`<pre>${info}</pre>`, 'info');
        }

        // ========== UTILITÁRIOS ==========
        function mostrarAlerta(mensagem, tipo = 'info') {
            const alertContainer = document.getElementById('alertContainer');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-futuristic alert-${tipo} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                <i class="fas fa-${tipo === 'success' ? 'check-circle' : tipo === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                ${mensagem}
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="alert"></button>
            `;
            alertContainer.appendChild(alertDiv);
            
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.parentNode.removeChild(alertDiv);
                }
            }, 5000);
        }

        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.querySelector('#themeToggle i');
            
            if (body.classList.contains('light-mode')) {
                body.classList.remove('light-mode');
                themeIcon.className = 'fas fa-moon';
                localStorage.setItem('theme', 'dark');
            } else {
                body.classList.add('light-mode');
                themeIcon.className = 'fas fa-sun';
                localStorage.setItem('theme', 'light');
            }
        }

        function abrirModalTrocarSenha() {
            const modal = new bootstrap.Modal(document.getElementById('modalTrocarSenha'));
            document.getElementById('formTrocarSenha').reset();
            document.getElementById('mensagemErroSenha').style.display = 'none';
            modal.show();
        }

        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            let iconId = 'iconSenhaAtual';
            if (inputId === 'novaSenha') iconId = 'iconNovaSenha';
            if (inputId === 'confirmarSenha') iconId = 'iconConfirmarSenha';
            
            const icon = document.getElementById(iconId);
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.classList.remove('fa-eye');
                icon.classList.add('fa-eye-slash');
            } else {
                input.type = 'password';
                icon.classList.remove('fa-eye-slash');
                icon.classList.add('fa-eye');
            }
        }

        async function trocarSenha() {
            const senhaAtual = document.getElementById('senhaAtual').value;
            const novaSenha = document.getElementById('novaSenha').value;
            const confirmarSenha = document.getElementById('confirmarSenha').value;
            const mensagemErro = document.getElementById('mensagemErroSenha');

            // Validações
            mensagemErro.style.display = 'none';
            mensagemErro.textContent = '';

            if (!senhaAtual || !novaSenha || !confirmarSenha) {
                mensagemErro.textContent = 'Por favor, preencha todos os campos.';
                mensagemErro.style.display = 'block';
                return;
            }

            if (novaSenha.length < 6) {
                mensagemErro.textContent = 'A nova senha deve ter no mínimo 6 caracteres.';
                mensagemErro.style.display = 'block';
                return;
            }

            if (novaSenha !== confirmarSenha) {
                mensagemErro.textContent = 'As senhas não coincidem.';
                mensagemErro.style.display = 'block';
                return;
            }

            if (senhaAtual === novaSenha) {
                mensagemErro.textContent = 'A nova senha deve ser diferente da senha atual.';
                mensagemErro.style.display = 'block';
                return;
            }

            try {
                const btnSalvar = event.target;
                const textoOriginal = btnSalvar.innerHTML;
                btnSalvar.disabled = true;
                btnSalvar.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Alterando...';

                // Obter ID do usuário atual
                let usuarioId = null;
                const loggedInUserData = localStorage.getItem('loggedInUser');
                if (loggedInUserData) {
                    const userData = JSON.parse(loggedInUserData);
                    usuarioId = userData.id || userData.username;
                }

                // Se não encontrou no localStorage, tentar buscar do currentUser
                if (!usuarioId && currentUser) {
                    usuarioId = currentUser.id || currentUser.username;
                }

                if (!usuarioId) {
                    mensagemErro.textContent = 'Não foi possível identificar o usuário. Faça login novamente.';
                    mensagemErro.style.display = 'block';
                    btnSalvar.disabled = false;
                    btnSalvar.innerHTML = textoOriginal;
                    return;
                }

                const response = await fetch('/api/auth/trocar-senha', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        senhaAtual,
                        novaSenha,
                        usuarioId: usuarioId // Enviar o ID do usuário explicitamente
                    })
                });

                const data = await response.json();

                if (response.ok && data.success) {
                    mostrarAlerta('Senha alterada com sucesso!', 'success');
                    const modal = bootstrap.Modal.getInstance(document.getElementById('modalTrocarSenha'));
                    modal.hide();
                    document.getElementById('formTrocarSenha').reset();
                } else {
                    mensagemErro.textContent = data.error || 'Erro ao alterar senha. Verifique a senha atual e tente novamente.';
                    mensagemErro.style.display = 'block';
                }
            } catch (error) {
                console.error('Erro ao trocar senha:', error);
                mensagemErro.textContent = 'Erro ao comunicar com o servidor. Tente novamente.';
                mensagemErro.style.display = 'block';
            } finally {
                const btnSalvar = document.querySelector('#modalTrocarSenha .btn-primary');
                if (btnSalvar) {
                    btnSalvar.disabled = false;
                    btnSalvar.innerHTML = '<i class="fas fa-save me-2"></i>Salvar Nova Senha';
                }
            }
        }

        async function logout() {
            try {
                console.log('🚪 Fazendo logout...');
                
                if (window.supabase) {
                    await window.supabase.auth.signOut();
                }
                
                localStorage.removeItem('loggedInUser');
                localStorage.removeItem('lastActivity');
                localStorage.removeItem('permissoesData');
                
                console.log('✅ Logout realizado com sucesso');
                window.location.href = 'login.html';
            } catch (error) {
                console.error('❌ Erro no logout:', error);
                localStorage.removeItem('loggedInUser');
                localStorage.removeItem('lastActivity');
                window.location.href = 'login.html';
            }
        }

        // ========== VERSÃO E MELHORIAS ==========
        const MELHORIAS_POR_CATEGORIA = {
            'Sistema de Disparos': {
                icon: 'fas fa-rocket',
                melhorias: [
                    'Sistema completo de disparo de mensagens WhatsApp',
                    'Filtros avançados por categoria, tipo de veículo e carroceria',
                    'Sistema de favoritos para motoristas',
                    'Envio de imagens e áudios',
                    'Gravação de áudio diretamente no navegador',
                    'Conversão automática de áudio para MP3',
                    'Teste de mensagem antes do disparo em massa',
                    'Sistema de cooldown para evitar spam',
                    'Logs detalhados de todos os disparos',
                    'Seleção em massa com checkboxes',
                    'Contador de mensagens em tempo real',
                    'Sistema de segurança contra bloqueios do WhatsApp',
                    'Randomização de tempo de envio entre mensagens',
                    'Randomização de texto via IA para evitar detecção',
                    'Simulação de digitação (typing indicator) antes do envio',
                    'Sistema anti-spam com intervalos inteligentes'
                ]
            },
            'Gestão de Motoristas': {
                icon: 'fas fa-truck',
                melhorias: [
                    'Cadastro completo de motoristas',
                    'Validação de telefones (11 ou 13 dígitos)',
                    'Validação de CNH e placas',
                    'Verificação de telefones duplicados',
                    'Importação em lote via CSV (apenas admin)',
                    'Exportação de dados em CSV e Excel',
                    'Sistema de favoritos por usuário',
                    'Filtros avançados de busca',
                    'Edição inline de dados',
                    'Relatório de motoristas com falhas',
                    'Análise de motivos de falha nos disparos'
                ]
            },
            'Sistema de Coletas': {
                icon: 'fas fa-truck-loading',
                melhorias: [
                    'Gestão completa de coletas',
                    'Sistema de etapas e status',
                    'Histórico de coletas finalizadas',
                    'Filtros por status, prioridade e período',
                    'Integração com sistema de disparos',
                    'Sistema de pagamentos (adiantamento, saldo, pagamento total)',
                    'Notificações automáticas de pagamento',
                    'Validação de duplicatas por filial e número',
                    'Multi-seleção de tipos de veículo e carroceria',
                    'Identificação amigável (Filial + Nº) ao invés de UUID',
                    'Sistema de prioridades (Baixa, Normal, Alta, Urgente)',
                    'Alertas visuais para coletas urgentes',
                    'Histórico detalhado com registro de todas as alterações',
                    'Separação clara entre Data de Coleta e Data de Entrega',
                    'Criação em lote de múltiplas coletas simultaneamente',
                    'Interface renovada com cards elegantes e modernos',
                    'Filtros otimizados por etapa totalmente funcionais',
                    'Visualização aprimorada de dados expandidos'
                ]
            },
            'Relatórios e BI': {
                icon: 'fas fa-chart-bar',
                melhorias: [
                    'Dashboard com métricas em tempo real',
                    'Gráficos interativos de atividade',
                    'Relatório de disparos por período',
                    'Estatísticas de sucesso e falhas',
                    'Análise de performance por usuário',
                    'Exportação de relatórios',
                    'BI de Coletas completamente renovado',
                    'Gráficos interativos e elegantes com opção de expandir',
                    'Gráficos de pizza melhorados com cores vibrantes e animações',
                    'Filtros avançados por Filial, Cliente, Tipo de Veículo e Carroceria',
                    'Dashboard completo com KPIs em tempo real',
                    'Visualização moderna, elegante e profissional',
                    'Relatório detalhado otimizado para modo claro e escuro',
                    'Clique nos gráficos para ver detalhes expandidos'
                ]
            },
            'Sistema de Chamados': {
                icon: 'fas fa-ticket-alt',
                melhorias: [
                    'Sistema completo de tickets',
                    'Categorias: Bug, Melhoria, Dúvida, Sugestão',
                    'Upload obrigatório de imagem para bugs',
                    'Sistema de prioridades e status',
                    'Atribuição de responsáveis',
                    'Histórico completo de chamados'
                ]
            },
            'Qualidade e Treinamentos': {
                icon: 'fas fa-award',
                melhorias: [
                    'Ferramentas de qualidade (5 Porquês, 5W2H, Ishikawa, PDCA)',
                    'Sistema de treinamentos',
                    'Gestão de documentos',
                    'Painel de qualidade',
                    'Sistema de ações corretivas',
                    'Treinamento interativo do disparador',
                    'Simulação de funcionalidades Evolution API no treinamento',
                    'Treinamento com botões demonstrativos (modo seguro)'
                ]
            },
            'Segurança e Autenticação': {
                icon: 'fas fa-shield-alt',
                melhorias: [
                    'Sistema de autenticação seguro',
                    'Controle de permissões por usuário',
                    'Sistema de roles (admin/user)',
                    'Troca de senha segura',
                    'Rate limiting para prevenir ataques',
                    'Validação de dados no frontend e backend',
                    'CSP (Content Security Policy) configurado',
                    'Cadastro de Motoristas reorganizado na seção de Operações',
                    'Gestão de permissões aprimorada e otimizada'
                ]
            },
            'Sistema de Comunicação e Avisos': {
                icon: 'fas fa-bullhorn',
                melhorias: [
                    'Novo Sistema de Avisos e Comunicação Interna',
                    'Avisos exibidos automaticamente ao fazer login',
                    'Confirmação de leitura obrigatória para avisos importantes',
                    'Avisos programados com data de início e término',
                    'Diferentes tipos de avisos: Informações, Atualizações, Feriados, Treinamentos',
                    'Sistema de prioridades para avisos (Baixa, Normal, Alta, Urgente)',
                    'Interface de gerenciamento completa para administradores',
                    'Suporte a conteúdo HTML para formatação avançada',
                    'Rastreamento de quais usuários já leram cada aviso',
                    'Visualização moderna e elegante dos avisos em modal',
                    'Comunicação centralizada de todas as informações importantes'
                ]
            },
            'Interface e UX': {
                icon: 'fas fa-paint-brush',
                melhorias: [
                    'Design moderno e responsivo',
                    'Modo escuro/claro',
                    'Animações suaves e transições',
                    'Feedback visual em todas as ações',
                    'Mensagens de erro e sucesso claras',
                    'Loading states em operações assíncronas',
                    'Tooltips e ajuda contextual',
                    'Interface intuitiva e fácil de usar'
                ]
            },
            'Performance e Otimização': {
                icon: 'fas fa-tachometer-alt',
                melhorias: [
                    'Paginação de dados para melhor performance',
                    'Cache de permissões',
                    'Lazy loading de componentes',
                    'Otimização de queries no banco',
                    'Compressão de imagens e áudios',
                    'Conversão eficiente de formatos de mídia'
                ]
            },
            'Integrações': {
                icon: 'fas fa-plug',
                melhorias: [
                    'Integração completa com Supabase',
                    'Evolution API para WhatsApp',
                    'Geração de QR Code para conexão Evolution API',
                    'Sistema de logout/desconexão de instâncias Evolution',
                    'Gestão de instâncias Evolution por usuário',
                    'Interface moderna para conexão via QR Code',
                    'Sistema de webhooks',
                    'API RESTful completa',
                    'Integração com OpenAI (Chat IA)',
                    'Sistema de storage para arquivos'
                ]
            },
            'Chat Interno': {
                icon: 'fas fa-comments',
                melhorias: [
                    'Sistema completo de chat interno entre usuários',
                    'Interface moderna estilo WhatsApp',
                    'Filtro de busca de usuários em tempo real',
                    'Ordenação inteligente: não lidas primeiro, depois por data',
                    'Contador de mensagens não lidas no menu e na lista',
                    'Envio de emojis com seletor visual',
                    'Sistema de resposta a mensagens',
                    'Envio de arquivos (imagens, PDFs, documentos)',
                    'Visualização de imagens em modal fullscreen',
                    'Preview de PDFs inline',
                    'Gravação e envio de áudios',
                    'Player de áudio com suporte a URLs assinadas',
                    'Busca de mensagens com destaque de termos',
                    'Navegação direta para mensagens encontradas',
                    'Separadores de data (Hoje, Ontem, Data completa)',
                    'Destaque animado de mensagens ao navegar',
                    'Filtro automático de motoristas (apenas usuários administrativos)',
                    'Design moderno com gradientes e animações suaves',
                    'Scrollbar personalizada',
                    'Sistema de cache de mensagens para respostas rápidas',
                    'Polling inteligente de novas mensagens',
                    'Marcação automática de mensagens como lidas',
                    'Preview de arquivos antes do envio',
                    'Suporte a múltiplos tipos de arquivo',
                    'Upload seguro para Supabase Storage',
                    'Tratamento de Content Security Policy (CSP)',
                    'Animações de entrada e hover',
                    'Layout responsivo e otimizado',
                    'Sistema de grupos de chat',
                    'Criação de grupos com nome e descrição',
                    'Adição de múltiplos participantes aos grupos',
                    'Gerenciamento de participantes do grupo',
                    'Sistema de administradores de grupo',
                    'Promoção de usuários a administradores',
                    'Permissões diferenciadas: criador e administradores',
                    'Administradores podem adicionar/remover participantes',
                    'Remoção de participantes pelos administradores',
                    'Exclusão de grupos pelo criador',
                    'Interface visual para gerenciamento de grupos',
                    'Badges visuais para criador e administradores',
                    'Controle de permissões granular por grupo'
                ]
            },
            'Avaliação 360° (Em Desenvolvimento)': {
                icon: 'fas fa-chart-pie',
                melhorias: [
                    'Sistema completo de avaliação de desempenho 360 graus',
                    'Avaliações multidirecionais (superiores, pares, subordinados)',
                    'Competências organizacionais e individuais',
                    'Métricas de desempenho e desenvolvimento',
                    'Templates pré-configurados para diferentes tipos de avaliação',
                    'Sistema de ciclos de avaliação',
                    'Relatórios e análises de desempenho',
                    '⚠️ Em processo final de desenvolvimento - Em breve!'
                ]
            }
        };

        // Calcular total de melhorias automaticamente
        const TOTAL_IMPROVEMENTS = (() => {
            let total = 0;
            Object.values(MELHORIAS_POR_CATEGORIA).forEach(categoria => {
                total += categoria.melhorias.length;
            });
            return total;
        })();

        function exibirVersaoEMelhorias() {
            const versionBadge = document.getElementById('versionBadge');
            const improvementsCount = document.getElementById('improvementsCount');
            
            if (versionBadge) {
                versionBadge.textContent = `v${SYSTEM_VERSION}`;
            }
            
            if (improvementsCount) {
                // Calcular total de melhorias automaticamente
                let total = 0;
                Object.values(MELHORIAS_POR_CATEGORIA).forEach(categoria => {
                    total += categoria.melhorias.length;
                });
                
                // Animar contagem de melhorias
                animarContagem(improvementsCount, 0, total, 2000);
            }
        }

        function animarContagem(element, inicio, fim, duracao) {
            const incremento = (fim - inicio) / (duracao / 16);
            let valorAtual = inicio;
            
            const timer = setInterval(() => {
                valorAtual += incremento;
                if (valorAtual >= fim) {
                    valorAtual = fim;
                    clearInterval(timer);
                }
                element.textContent = Math.floor(valorAtual);
            }, 16);
        }

        function abrirModalMelhorias() {
            const modal = new bootstrap.Modal(document.getElementById('modalMelhorias'));
            carregarMelhorias();
            modal.show();
        }

        function carregarMelhorias() {
            const container = document.getElementById('melhoriasContainer');
            const totalMelhoriasModal = document.getElementById('totalMelhoriasModal');
            
            // Calcular total de melhorias
            let total = 0;
            Object.values(MELHORIAS_POR_CATEGORIA).forEach(categoria => {
                total += categoria.melhorias.length;
            });
            
            if (totalMelhoriasModal) {
                totalMelhoriasModal.textContent = total;
            }
            
            // Atualizar também o contador no rodapé
            const improvementsCount = document.getElementById('improvementsCount');
            if (improvementsCount) {
                improvementsCount.textContent = total;
            }
            
            // Renderizar categorias
            container.innerHTML = '';
            
            Object.entries(MELHORIAS_POR_CATEGORIA).forEach(([categoria, dados]) => {
                const categoriaDiv = document.createElement('div');
                categoriaDiv.className = 'melhorias-categoria';
                
                const totalCategoria = dados.melhorias.length;
                categoriaDiv.innerHTML = `
                    <div class="categoria-header">
                        <div class="categoria-header-left">
                            <div class="categoria-icon">
                                <i class="${dados.icon}"></i>
                            </div>
                            <h6 class="categoria-title">${categoria}</h6>
                        </div>
                        <span class="categoria-count-badge">
                            <i class="fas fa-check-circle me-1"></i>${totalCategoria}
                        </span>
                    </div>
                    <ul class="melhorias-lista">
                        ${dados.melhorias.map(melhoria => `
                            <li>
                                <i class="fas fa-check-circle"></i>
                                <span>${melhoria}</span>
                            </li>
                        `).join('')}
                    </ul>
                `;
                
                container.appendChild(categoriaDiv);
            });
        }

        // ========== CARREGAR TEMA SALVO ==========
        document.addEventListener('DOMContentLoaded', function() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', savedTheme);
            
            if (savedTheme === 'light') {
                document.body.classList.add('light-mode');
                const themeIcon = document.querySelector('#themeToggle i');
                if (themeIcon) {
                    themeIcon.className = 'fas fa-sun';
                }
            }
        });

        // ========== SCROLL SUAVE ==========
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const href = this.getAttribute('href');
                if (!href || href.trim() === '#' || href.trim().length <= 1) {
                    return;
                }

                const target = document.querySelector(href);
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // ========== SISTEMA DE AVISOS ==========
        let avisosPendentes = [];
        let avisoAtualIndex = 0;

        async function verificarAvisosNaoLidos() {
            try {
                if (!currentUser || !currentUser.id || !supabase) {
                    console.warn('⚠️ Não é possível verificar avisos: usuário ou supabase não inicializado');
                    return;
                }

                // Verificar se os avisos já foram exibidos nesta sessão de login
                const sessionKey = `avisos_exibidos_${currentUser.id}`;
                const avisosExibidosSessao = sessionStorage.getItem(sessionKey);
                
                if (avisosExibidosSessao) {
                    console.log('✅ Avisos já foram exibidos nesta sessão');
                    return;
                }

                // Buscar avisos ativos não lidos pelo usuário
                const { data: avisos, error } = await supabase
                    .from('avisos_sistema')
                    .select('*')
                    .eq('ativo', true)
                    .or(`data_fim.is.null,data_fim.gte.${new Date().toISOString()}`)
                    .order('prioridade', { ascending: false })
                    .order('created_at', { ascending: false });

                if (error) {
                    console.error('❌ Erro ao buscar avisos:', error);
                    return;
                }

                if (!avisos || avisos.length === 0) {
                    console.log('✅ Nenhum aviso ativo encontrado');
                    // Marcar como exibido mesmo sem avisos para não verificar novamente
                    sessionStorage.setItem(sessionKey, 'true');
                    return;
                }

                // Buscar quais avisos já foram lidos pelo usuário
                const { data: avisosLidos, error: errorLidos } = await supabase
                    .from('avisos_lidos')
                    .select('aviso_id')
                    .eq('user_id', currentUser.id);

                if (errorLidos) {
                    console.error('❌ Erro ao buscar avisos lidos:', errorLidos);
                    return;
                }

                const idsLidos = new Set((avisosLidos || []).map(al => al.aviso_id));
                
                // Filtrar avisos para exibir
                const avisosNaoLidos = avisos.filter(aviso => {
                    // Se for obrigatório, SEMPRE mostrar (independente de já ter sido lido)
                    if (aviso.obrigatorio) {
                        return true;
                    }
                    // Se não for obrigatório, só mostrar se não foi lido
                    return !idsLidos.has(aviso.id);
                });

                if (avisosNaoLidos.length === 0) {
                    console.log('✅ Todos os avisos já foram lidos');
                    // Marcar como exibido para não verificar novamente nesta sessão
                    sessionStorage.setItem(sessionKey, 'true');
                    return;
                }

                // Ordenar: obrigatórios primeiro, depois por prioridade
                avisosNaoLidos.sort((a, b) => {
                    if (a.obrigatorio !== b.obrigatorio) {
                        return b.obrigatorio - a.obrigatorio;
                    }
                    const prioridades = { 'urgente': 4, 'alta': 3, 'normal': 2, 'baixa': 1 };
                    return (prioridades[b.prioridade] || 0) - (prioridades[a.prioridade] || 0);
                });

                avisosPendentes = avisosNaoLidos;
                avisoAtualIndex = 0;

                // Marcar que os avisos foram exibidos nesta sessão (antes de exibir para evitar múltiplas exibições)
                sessionStorage.setItem(sessionKey, 'true');

                // Exibir primeiro aviso
                exibirProximoAviso();
            } catch (error) {
                console.error('❌ Erro ao verificar avisos:', error);
            }
        }

        function exibirProximoAviso() {
            if (avisoAtualIndex >= avisosPendentes.length) {
                console.log('✅ Todos os avisos foram exibidos');
                return;
            }

            const aviso = avisosPendentes[avisoAtualIndex];
            const tipoClasses = {
                'info': 'text-info',
                'warning': 'text-warning',
                'success': 'text-success',
                'danger': 'text-danger',
                'feriado': 'text-secondary',
                'atualizacao': 'text-primary',
                'treinamento': 'text-info'
            };
            const tipoIcones = {
                'info': 'fa-info-circle',
                'warning': 'fa-exclamation-triangle',
                'success': 'fa-check-circle',
                'danger': 'fa-exclamation-circle',
                'feriado': 'fa-calendar-alt',
                'atualizacao': 'fa-sync-alt',
                'treinamento': 'fa-graduation-cap'
            };
            const tipoNomes = {
                'info': 'Informação',
                'warning': 'Atenção',
                'success': 'Sucesso',
                'danger': 'Urgente',
                'feriado': 'Feriado',
                'atualizacao': 'Atualização',
                'treinamento': 'Treinamento'
            };

            const tipoClass = tipoClasses[aviso.tipo] || 'text-info';
            const tipoIcone = tipoIcones[aviso.tipo] || 'fa-bullhorn';
            const tipoNome = tipoNomes[aviso.tipo] || 'Informação';

            // Processar conteúdo: converter quebras de linha em <br> se for texto simples
            let conteudoProcessado = aviso.conteudo || '';
            const temHTML = /<[a-z][\s\S]*>/i.test(conteudoProcessado);
            
            if (!temHTML) {
                // Se não tem HTML, converter quebras de linha em <br>
                // Primeiro escapar caracteres especiais
                conteudoProcessado = conteudoProcessado
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;');
                
                // Converter múltiplas quebras de linha em parágrafos
                const linhas = conteudoProcessado.split('\n');
                let htmlFormatado = '';
                let paragrafoAtual = '';
                
                linhas.forEach((linha, index) => {
                    linha = linha.trim();
                    
                    // Se linha vazia, fechar parágrafo atual e abrir novo
                    if (linha === '') {
                        if (paragrafoAtual) {
                            htmlFormatado += `<p class="mb-3">${paragrafoAtual}</p>`;
                            paragrafoAtual = '';
                        }
                    } else {
                        // Se já tem conteúdo no parágrafo, adicionar <br>
                        if (paragrafoAtual) {
                            paragrafoAtual += '<br>';
                        }
                        paragrafoAtual += linha;
                    }
                });
                
                // Fechar último parágrafo se houver
                if (paragrafoAtual) {
                    htmlFormatado += `<p class="mb-3">${paragrafoAtual}</p>`;
                }
                
                conteudoProcessado = htmlFormatado || `<p class="mb-3">${conteudoProcessado}</p>`;
            }

            const html = `
                <div class="text-center mb-4">
                    <i class="fas ${tipoIcone} ${tipoClass}" style="font-size: 3rem;"></i>
                    <h4 class="mt-3 text-white">${aviso.titulo}</h4>
                    <span class="badge ${tipoClass.replace('text-', 'bg-')} mb-3">${tipoNome}</span>
                </div>
                <div class="text-white" style="line-height: 1.8;">
                    ${conteudoProcessado}
                </div>
                ${aviso.prioridade === 'urgente' ? `
                    <div class="alert alert-danger mt-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Aviso Urgente</strong>
                    </div>
                ` : ''}
            `;

            document.getElementById('avisoModalBody').innerHTML = html;
            
            // Se for obrigatório, esconder botão de fechar e tornar backdrop static
            if (aviso.obrigatorio) {
                const btnFechar = document.querySelector('#modalAvisos .btn-close');
                if (btnFechar) btnFechar.style.display = 'none';
                document.getElementById('btnConfirmarAviso').style.display = 'block';
            } else {
                const btnFechar = document.querySelector('#modalAvisos .btn-close');
                if (btnFechar) btnFechar.style.display = 'block';
                // Adicionar botão "Fechar" para avisos não obrigatórios
                if (!document.getElementById('btnFecharAviso')) {
                    const footer = document.getElementById('avisoModalFooter');
                    const btnFechar = document.createElement('button');
                    btnFechar.type = 'button';
                    btnFechar.className = 'btn btn-secondary';
                    btnFechar.id = 'btnFecharAviso';
                    btnFechar.innerHTML = '<i class="fas fa-times me-2"></i>Fechar';
                    btnFechar.onclick = () => {
                        confirmarLeituraAviso();
                    };
                    footer.appendChild(btnFechar);
                }
                document.getElementById('btnConfirmarAviso').textContent = 'Li e Entendi';
            }

            // Mostrar modal
            const modal = new bootstrap.Modal(document.getElementById('modalAvisos'), {
                backdrop: aviso.obrigatorio ? 'static' : true,
                keyboard: !aviso.obrigatorio
            });
            modal.show();
        }

        async function confirmarLeituraAviso() {
            if (avisoAtualIndex >= avisosPendentes.length) {
                return;
            }

            const aviso = avisosPendentes[avisoAtualIndex];
            
            try {
                // Marcar aviso como lido
                const { error } = await supabase
                    .from('avisos_lidos')
                    .insert([{
                        aviso_id: aviso.id,
                        user_id: currentUser.id
                    }]);

                if (error && !error.message.includes('duplicate')) {
                    console.error('❌ Erro ao marcar aviso como lido:', error);
                }

                // Fechar modal atual
                const modalInstance = bootstrap.Modal.getInstance(document.getElementById('modalAvisos'));
                if (modalInstance) {
                    modalInstance.hide();
                }

                // Avançar para próximo aviso
                avisoAtualIndex++;
                
                // Aguardar um pouco antes de exibir próximo aviso
                setTimeout(() => {
                    exibirProximoAviso();
                }, 300);
            } catch (error) {
                console.error('❌ Erro ao confirmar leitura:', error);
                // Mesmo com erro, avançar para próximo aviso
                const modalInstance = bootstrap.Modal.getInstance(document.getElementById('modalAvisos'));
                if (modalInstance) {
                    modalInstance.hide();
                }
                avisoAtualIndex++;
                setTimeout(() => {
                    exibirProximoAviso();
                }, 300);
            }
        }
    </script>
</body>
</html>